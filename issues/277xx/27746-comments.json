[
   {
      "author_association" : "MEMBER",
      "body" : "Great! Thanks for this. I'm active in these neighborhoods today as well, since adding some `-stopatheight`/restart logic to the functional tests in #27596 has turned up some issues with `CheckBlockIndex()`, which are maybe related to some of the changes here. So I'll be looking at this shortly.",
      "created_at" : "2023-05-24T20:05:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1561858383",
      "id" : 1561858383,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585dGBFP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561858383/reactions"
      },
      "updated_at" : "2023-05-24T20:05:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561858383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [achow101](https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1652419820), [jamesob](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1552660659), [Sjors](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1553302075), [ryanofsky](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1555524219) |\n| Concept ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1485874548) |\n| Stale ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1512960883), [mzumsande](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1544102750) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28052](https://github.com/bitcoin/bitcoin/pull/28052) (blockstorage: XOR blocksdir *.dat files by MarcoFalke)\n* [#27866](https://github.com/bitcoin/bitcoin/pull/27866) (blockstorage: Return on fatal flush errors by TheCharlatan)\n* [#27460](https://github.com/bitcoin/bitcoin/pull/27460) (rpc: Add importmempool RPC by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-25T06:05:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1562326140",
      "id" : 1562326140,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585dHzR8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1562326140/reactions"
      },
      "updated_at" : "2023-07-31T20:07:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1562326140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The first two commits up to f50fa248f1d904be5f33a29c837f74a2cca8abc0 look good to me.\r\n\r\nHow do you see the division of labor between `ChainstateManager` and `BlockManager`? The `ChainState` doc currently says:\r\n\r\n> Anything that is contingent on the current tip of the chain is stored here, whereas block information and metadata independent of the current tip is kept in `BlockManager`.\r\n\r\nIn any case moving `AcceptBlock` from `Chainstate` to `ChainstateManager` seems an improvement.",
      "created_at" : "2023-05-31T16:41:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1570566067",
      "id" : 1570566067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585dnO-z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570566067/reactions"
      },
      "updated_at" : "2023-05-31T16:41:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570566067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212154654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d: this function seems to come out of nowhere and is only used in a test. ",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:43:09Z",
      "diff_hunk" : "@@ -975,6 +932,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212154654",
      "id" : 1212154654,
      "line" : 959,
      "node_id" : "PRRC_kwDOABII585IQAMe",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 959,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 115,
      "pull_request_review_id" : 1453921658,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T18:44:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212161483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d: maybe use this refactor as an opportunity to add a comment explaining the somewhat obtuse line above",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:48:56Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212161483",
      "id" : 1212161483,
      "line" : 3416,
      "node_id" : "PRRC_kwDOABII585IQB3L",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3416,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 46,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212164200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d if it's broken in master, can we fix it _before_ refactoring? Alternatively there could be a `This will be fixed in the next commit` comment.\r\n\r\nI'm also confused by the comment. `TryAddBlockIndexCandidate` is only called from `ReceivedBlockTransactions` after it sets `BLOCK_VALID_TRANSACTIONS`. So are you saying we're currently too strict? Was there a regression somewhere? \r\n",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:50:12Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212164200",
      "id" : 1212164200,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IQCho",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3449,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212173301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d: `\"active\" :\"background\"`?",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:54:47Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        LogPrintf(\"TryAddBlockIndexCandidate: %s is now a candidate (%s)\\n\", pindex->GetBlockHash().ToString(), (this == &m_chainman.ActiveChainstate() ? \"active\" : \"inactive\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212173301",
      "id" : 1212173301,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IQEv1",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3452,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212186629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d Previously `LoadExternalBlockFile` was only called on the `ActiveChainstate()`, now you're looping over both. This is ok? If possible, it would be good to move the change to `LoadExternalBlockFile` into a separate commit.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T19:06:19Z",
      "diff_hunk" : "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212186629",
      "id" : 1212186629,
      "line" : 4602,
      "node_id" : "PRRC_kwDOABII585IQIAF",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 4602,
      "original_position" : 206,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 308,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> How do you see the division of labor between `ChainstateManager` and `BlockManager`? The `ChainState` doc currently says:\r\n> \r\n> > Anything that is contingent on the current tip of the chain is stored here, whereas block information and metadata independent of the current tip is kept in `BlockManager`.\r\n\r\nI think of `BlockManager` as being a generic backend database of block (and undo) data, while any validation-related logic should live in `Chainstate` (if it relies on chainstate-specific information) or somewhere else (either a static function in validation or in `ChainstateManager` as I propose here) if not.\r\n\r\nI think `AcceptBlock` could also be a static function in `validation.cpp`; I mostly just wanted to get it out of `Chainstate` because I think that having block storage be coupled to a particular chainstate is a confusing idea, but I can go either way on whether it belongs in ChainstateManager or not.",
      "created_at" : "2023-06-05T17:23:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1577187405",
      "id" : 1577187405,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585eAfhN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1577187405/reactions"
      },
      "updated_at" : "2023-06-05T17:23:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1577187405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nIs this test case expected to fail with the changes in this commit or is it just expected to be incorrect? I tried re-enabling it and it passes.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-12T21:27:34Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262047",
      "id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJohf",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1475849986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T21:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nIs this check expected to fail? I tried uncommenting it and the test passes.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-12T21:28:41Z",
      "diff_hunk" : "@@ -349,7 +351,7 @@ struct SnapshotTestSetup : TestChain100Setup {\n         }\n \n         // Snapshot should refuse to load after one has already loaded.\n-        BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));\n+        //BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262861",
      "id" : 1227262861,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJouN",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 354,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1475849986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T21:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227265509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nThis diff makes the test work, assuming that `TryAddBlockIndexCandidate` is working as it is supposed to be.\r\n\r\n```diff\r\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\r\nindex 8fab53c5c5..b9fe054a64 100644\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -413,7 +411,6 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\r\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\r\n //!   even those assumed-valid.\r\n //!\r\n-#if 0\r\n BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n {\r\n     ChainstateManager& chainman = *Assert(m_node.chainman);\r\n@@ -427,6 +424,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n     const int assumed_valid_start_idx = last_assumed_valid_idx - expected_assumed_valid;\r\n \r\n     CBlockIndex* validated_tip{nullptr};\r\n+    CBlockIndex* assumed_base{nullptr};\r\n     CBlockIndex* assumed_tip{WITH_LOCK(chainman.GetMutex(), return chainman.ActiveChain().Tip())};\r\n \r\n     auto reload_all_block_indexes = [&]() {\r\n@@ -440,10 +438,10 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n         WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\r\n     };\r\n \r\n-    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\r\n-    // tip candidates.\r\n+    // Ensure that without any assumed-valid BlockIndex entries, only the current tip is\r\n+    // considered as a candidate.\r\n     reload_all_block_indexes();\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\r\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 1);\r\n \r\n     // Mark some region of the chain assumed-valid.\r\n     for (int i = 0; i <= cs1.m_chain.Height(); ++i) {\r\n@@ -462,27 +460,33 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n             validated_tip = index;\r\n             BOOST_CHECK(!index->IsAssumedValid());\r\n         }\r\n+        // Note the block after the last assumed valid block as the snapshot base\r\n+        if (i == last_assumed_valid_idx) {\r\n+            assumed_base = index;\r\n+            BOOST_CHECK(!index->IsAssumedValid());\r\n+        }\r\n     }\r\n \r\n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\r\n \r\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\r\n-        return chainman.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n+        return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\r\n+\r\n+    // Set tip of the fully validated chain to be the validated tip\r\n+    cs1.m_chain.SetTip(*validated_tip);\r\n \r\n     reload_all_block_indexes();\r\n \r\n-    // The fully validated chain only has candidates up to the start of the assumed-valid\r\n-    // blocks.\r\n+    // The fully validated chain should have the current validated tip, the assumed valid\r\n+    // blocks, and the assumed valid base as candidates.\r\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\r\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), expected_assumed_valid + 2);\r\n \r\n     // The assumed-valid tolerant chain has all blocks as candidates.\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes);\r\n }\r\n-#endif\r\n \r\n //! Ensure that snapshot chainstates initialize properly when found on disk.\r\n BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\r\n```",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-12T21:31:38Z",
      "diff_hunk" : "@@ -411,6 +413,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n //!   even those assumed-valid.\n //!\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227265509",
      "id" : 1227265509,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJpXl",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 416,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1475849986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T21:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228448590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Split this out into its own commit.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:06:01Z",
      "diff_hunk" : "@@ -975,6 +932,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228448590",
      "id" : 1228448590,
      "in_reply_to_id" : 1212154654,
      "line" : 959,
      "node_id" : "PRRC_kwDOABII585JOKNO",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 959,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 115,
      "pull_request_review_id" : 1477683984,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:06:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228449099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this should be a bit better now?",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:06:32Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228449099",
      "id" : 1228449099,
      "in_reply_to_id" : 1212161483,
      "line" : 3416,
      "node_id" : "PRRC_kwDOABII585JOKVL",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3416,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 46,
      "pull_request_review_id" : 1477684761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry that comment was confusing.  I dropped it, and instead change the behavior around managing `setBlockIndexCandidates` in the last two commits. \r\n\r\nI think master has a couple bugs. When we start up, in `LoadBlockIndex()` we weren't adding blocks that have been downloaded and have more work than the background chainstate's tip to `setBlockIndexCandidates`, which prevents those blocks from being validated and connected on startup.  Also, because `AcceptBlock()` is a member of `Chainstate`, it's at best confusing to reason about whether a block that would advance the tip of a chainstate would always be added to a chainstate's `setBlockIndexCandidates` (it depends on yet-more logic around where a block came from and guessing about which chainstate might need it).\r\n\r\nThe new code tries to simplify things by establishing that the background chainstate is only trying to connect blocks towards the snapshot block, and that all blocks for which we HAVE_DATA and have more work than the background chainstate's tip (and which are ancestors of the snapshot block) will be added to the background chainstate's `setBlockIndexCandidates`. Also, the logic bug in `LoadBlockIndex` should be fixed in the last commit here.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:27:27Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071",
      "id" : 1228470071,
      "in_reply_to_id" : 1212164200,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOPc3",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3449,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1477717138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:27:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228471308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This LogPrintf() disappeared during my edits, so this is gone now.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:28:46Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        LogPrintf(\"TryAddBlockIndexCandidate: %s is now a candidate (%s)\\n\", pindex->GetBlockHash().ToString(), (this == &m_chainman.ActiveChainstate() ? \"active\" : \"inactive\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228471308",
      "id" : 1228471308,
      "in_reply_to_id" : 1212173301,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOPwM",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3452,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1477719362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:28:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228475690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you're asking if it's ok to call `ActivateBestChain()` on both chainstates, the answer to that is essentially always \"yes\".  ABC() doesn't do anything if no new candidates for most-work chain have been added to our block index; but if any block that has more work than our tip is now available we want to try to connect it.\r\n\r\nWhen calling `LoadExternalBlockFile()`, we're adding blocks that theoretically could be of interest to either chainstate; so I think it makes sense to separate the block storage and import from any particular chainstate.\r\n\r\nI'm not sure how easy this would be to separate out into its own commit, because this invokes `AcceptBlock()` as well...  Hopefully the commit is more manageable now that I've split a bunch of other stuff out?  Let me know if you see a good way to shrink this commit more and I can take a stab at it.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:33:03Z",
      "diff_hunk" : "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228475690",
      "id" : 1228475690,
      "in_reply_to_id" : 1212186629,
      "line" : 4602,
      "node_id" : "PRRC_kwDOABII585JOQ0q",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 4602,
      "original_position" : 206,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 308,
      "pull_request_review_id" : 1477726472,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:33:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228476418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, thanks for noticing this. I believe I had an earlier version of this branch with `assert()`'s added in to ensure that the snapshot base was never `nullptr`, and so this test had been failing.  I guess I removed those asserts before pushing...  I've re-enabled the test for now, but really this test should be re-written so that snapshots are always at blocks in the block index.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:33:50Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228476418",
      "id" : 1228476418,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JORAC",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1477727655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:33:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228477327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I have no idea why I commented this out -- I've re-added as well.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:34:46Z",
      "diff_hunk" : "@@ -349,7 +351,7 @@ struct SnapshotTestSetup : TestChain100Setup {\n         }\n \n         // Snapshot should refuse to load after one has already loaded.\n-        BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));\n+        //BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228477327",
      "id" : 1228477327,
      "in_reply_to_id" : 1227262861,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOROP",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 354,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1477729042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:34:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228498661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, I took these changes and re-enabled the test.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:51:47Z",
      "diff_hunk" : "@@ -411,6 +413,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n //!   even those assumed-valid.\n //!\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228498661",
      "id" : 1228498661,
      "in_reply_to_id" : 1227265509,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOWbl",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 416,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1477759637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sjors @achow101 Thanks for the review! I split up the big commit as @sjors suggested, and with the test fixes I think this is ready to be moved out of Draft status.\r\n",
      "created_at" : "2023-06-13T17:54:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1589777766",
      "id" : 1589777766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585ewhVm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1589777766/reactions"
      },
      "updated_at" : "2023-06-13T17:54:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1589777766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228709228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228709228"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "typo: is -> if\r\nAlso, another way for `AcceptBlock()` to return false is if the block/header are valid, but `SaveBlockToDisk()` failed for some reason (e.g. missing disk space).",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-13T21:21:13Z",
      "diff_hunk" : "@@ -1128,6 +1125,29 @@ class ChainstateManager\n      */\n     bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& block, bool min_pow_checked, BlockValidationState& state, const CBlockIndex** ppindex = nullptr) LOCKS_EXCLUDED(cs_main);\n \n+    /**\n+     * Sufficiently validate a block for disk storage (and store on disk).\n+     *\n+     * @param[in]   pblock          The block we want to process.\n+     * @param[in]   fRequested      Whether we requested this block from a\n+     *                              peer.\n+     * @param[in]   dbp             The location on disk, if we are importing\n+     *                              this block from prior storage.\n+     * @param[in]   min_pow_checked True if proof-of-work anti-DoS checks have\n+     *                              been done by caller for headers chain\n+     *\n+     * @param[out]  state       The state of the block validation.\n+     * @param[out]  ppindex     Optional return parameter to get the\n+     *                          CBlockIndex pointer for this block.\n+     * @param[out]  fNewBlock   Optional return parameter to indicate if the\n+     *                          block is new to our storage.\n+     *\n+     * @returns   False is the block or header is invalid; true otherwise.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228709228",
      "id" : 1228709228,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JPJ1s",
      "original_commit_id" : "ac3220a63ad1c4e73a8191f57ad921db04729af8",
      "original_line" : 1158,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1478071545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228709228/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T21:59:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228709228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229850689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> this test should be re-written so that snapshots are always at blocks in the block index.\r\n\r\nDoes it? AFAICT, it doesn't test anything within the block index at all, and the only part that does is `LoadGenesisBlock`.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-14T15:57:05Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229850689",
      "id" : 1229850689,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JTghB",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1479818774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T15:57:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229858664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See https://github.com/bitcoin/bitcoin/pull/27746/files#diff-dbada1fe3a3d0af884304dd28be8c9df74b592401dec2c6400f6b491aefe6c9bL141\r\n\r\n```c++\r\nChainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n```\r\n\r\nTrying to activate a snapshot for a block that is not in the block index ought to be an illegal operation.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-14T16:03:01Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229858664",
      "id" : 1229858664,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JTido",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1479831868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229903387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah I see. Seems like this could be easily resolved by using `TestChain100Setup`\r\n\r\n```diff\r\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\r\nindex 2d0e1705fd..3d90bdcc26 100644\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -105,7 +105,7 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\r\n }\r\n \r\n //! Test rebalancing the caches associated with each chainstate.\r\n-BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_rebalance_caches, TestChain100Setup)\r\n {\r\n     ChainstateManager& manager = *m_node.chainman;\r\n     CTxMemPool& mempool = *m_node.mempool;\r\n@@ -118,7 +118,7 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n \r\n     // Create a legacy (IBD) chainstate.\r\n     //\r\n-    Chainstate& c1 = WITH_LOCK(::cs_main, return manager.InitializeChainstate(&mempool));\r\n+    Chainstate& c1 = manager.ActiveChainstate();\r\n     chainstates.push_back(&c1);\r\n     c1.InitCoinsDB(\r\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\r\n@@ -126,8 +126,6 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n     {\r\n         LOCK(::cs_main);\r\n         c1.InitCoinsCache(1 << 23);\r\n-        BOOST_REQUIRE(c1.LoadGenesisBlock());\r\n-        c1.CoinsTip().SetBestBlock(InsecureRand256());\r\n         manager.MaybeRebalanceCaches();\r\n     }\r\n \r\n@@ -136,7 +134,8 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n \r\n     // Create a snapshot-based chainstate.\r\n     //\r\n-    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n+    CBlockIndex* snapshot_base{WITH_LOCK(manager.GetMutex(), return manager.ActiveChain()[manager.ActiveChain().Height() / 2])};\r\n+    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, *snapshot_base->phashBlock));\r\n     chainstates.push_back(&c2);\r\n     c2.InitCoinsDB(\r\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\r\n@@ -144,8 +143,6 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n     {\r\n         LOCK(::cs_main);\r\n         c2.InitCoinsCache(1 << 23);\r\n-        BOOST_REQUIRE(c2.LoadGenesisBlock());\r\n-        c2.CoinsTip().SetBestBlock(InsecureRand256());\r\n         manager.MaybeRebalanceCaches();\r\n     }\r\n \r\n```",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-14T16:42:20Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229903387",
      "id" : 1229903387,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JTtYb",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1479901411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:42:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1230085759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085759"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "how about inserting and returning here in the `!is_bg_chainstate` case, so that we can skip the `GetAncestor()` call when dealing with the snapshot chainstate?",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-14T19:42:25Z",
      "diff_hunk" : "@@ -3414,7 +3414,17 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        // The active chainstate should always add entries that have more work than the tip.\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base.\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1230085759",
      "id" : 1230085759,
      "line" : 3417,
      "node_id" : "PRRC_kwDOABII585JUZ5_",
      "original_commit_id" : "e08dc8c14fc9dbd97db46482052ecb8d4163cfc2",
      "original_line" : 3417,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 47,
      "pull_request_review_id" : 1478071545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085759/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T21:59:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1230212278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230212278"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think this line does anything. It's called during init from `LoadChainstate() -> DetectSnapshotChainstate()`, at which point `m_snapshot_chainstate->m_snapshot_entry` isn't set yet. That only happens right after, in `CompleteChainstateInitialization() -> LoadBlockIndex()`.\r\n\r\nThe ctor of `Chainstate` also wouldn't have set `m_snapshot_entry` for the same reason (the block index is loaded after the chainstate).",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-14T21:58:00Z",
      "diff_hunk" : "@@ -5644,6 +5659,7 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n         std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\n     m_active_chainstate = m_snapshot_chainstate.get();\n+    m_ibd_chainstate->m_snapshot_entry = m_snapshot_chainstate->m_snapshot_entry;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1230212278",
      "id" : 1230212278,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JU4y2",
      "original_commit_id" : "1880b5412e6ac457dd3462b768a03d7b81ad0c96",
      "original_line" : 5662,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1478071545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230212278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T22:25:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230212278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392094"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thank you! I took this and updated the commit where this test was changed.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-15T18:22:15Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392094",
      "id" : 1231392094,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JZY1e",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1482164683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392094/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-15T18:22:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392237"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-15T18:22:24Z",
      "diff_hunk" : "@@ -1128,6 +1125,29 @@ class ChainstateManager\n      */\n     bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& block, bool min_pow_checked, BlockValidationState& state, const CBlockIndex** ppindex = nullptr) LOCKS_EXCLUDED(cs_main);\n \n+    /**\n+     * Sufficiently validate a block for disk storage (and store on disk).\n+     *\n+     * @param[in]   pblock          The block we want to process.\n+     * @param[in]   fRequested      Whether we requested this block from a\n+     *                              peer.\n+     * @param[in]   dbp             The location on disk, if we are importing\n+     *                              this block from prior storage.\n+     * @param[in]   min_pow_checked True if proof-of-work anti-DoS checks have\n+     *                              been done by caller for headers chain\n+     *\n+     * @param[out]  state       The state of the block validation.\n+     * @param[out]  ppindex     Optional return parameter to get the\n+     *                          CBlockIndex pointer for this block.\n+     * @param[out]  fNewBlock   Optional return parameter to indicate if the\n+     *                          block is new to our storage.\n+     *\n+     * @returns   False is the block or header is invalid; true otherwise.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392237",
      "id" : 1231392237,
      "in_reply_to_id" : 1228709228,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JZY3t",
      "original_commit_id" : "ac3220a63ad1c4e73a8191f57ad921db04729af8",
      "original_line" : 1158,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1482165009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392237/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-15T18:22:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed, good idea.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-15T18:22:53Z",
      "diff_hunk" : "@@ -3414,7 +3414,17 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        // The active chainstate should always add entries that have more work than the tip.\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base.\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392858",
      "id" : 1231392858,
      "in_reply_to_id" : 1230085759,
      "line" : 3417,
      "node_id" : "PRRC_kwDOABII585JZZBa",
      "original_commit_id" : "e08dc8c14fc9dbd97db46482052ecb8d4163cfc2",
      "original_line" : 3417,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 47,
      "pull_request_review_id" : 1482165706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392858/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-15T18:22:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231393061"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231393061"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, removed this and left a comment there instead.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-15T18:23:02Z",
      "diff_hunk" : "@@ -5644,6 +5659,7 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n         std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\n     m_active_chainstate = m_snapshot_chainstate.get();\n+    m_ibd_chainstate->m_snapshot_entry = m_snapshot_chainstate->m_snapshot_entry;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231393061",
      "id" : 1231393061,
      "in_reply_to_id" : 1230212278,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JZZEl",
      "original_commit_id" : "1880b5412e6ac457dd3462b768a03d7b81ad0c96",
      "original_line" : 5662,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1482165883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231393061/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-15T18:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231393061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232107866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232107866"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Explicitly track maximum block height stored in undo files\" (6cc09f4759444218d1b493a1bcf44bb63f3160d2)\r\n\r\nWhen I first read this comment, I misinterpreted \"whose undo data is in m_last_blockfile\" to mean \"whose undo data belongs in m_last_blockfile\" as opposed to \"whose undo data has already been written to m_last_blockfile\". So I was confused about how it was working. Would suggest changing this sentence to something like \"Track the height of the highest block in m_last_blockfile whose undo data has been written.\"\r\n\r\nI also don't think if would hurt if there could be more explanation after this like: \"Block data is written to block files in download order, but is written to undo files in validation order, which is usually in order by height. To avoid wasting disk space, undo files will be will trimmed whenever the corresponding block file is finalized and the height of the highest block written to the block file equals the height of the highest block written to the undo file. This is a heuristic and can sometimes preemptively trim undo files that will write more data later, and sometimes fail to trim undo files that can't have more data written later.\"",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T11:07:14Z",
      "diff_hunk" : "@@ -126,6 +126,12 @@ class BlockManager\n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n     int m_last_blockfile = 0;\n+    // Track the largest height block whose undo data is in m_last_blockfile.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232107866",
      "id" : 1232107866,
      "line" : 128,
      "node_id" : "PRRC_kwDOABII585JcHla",
      "original_commit_id" : "6cc09f4759444218d1b493a1bcf44bb63f3160d2",
      "original_line" : 129,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 21,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232107866/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232107866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232240800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232240800"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (2ebdfa8529b222de0db6d7114e9e5a1622fecfd0)\r\n\r\nJust IMO, but I think it would good to delete the `m_chainman.nBlockSequenceId = 1` line in this commit instead of next commit \"Add wrapper for adding entries to a chainstates block index candidates\" (df6576d48e4daff2b9787fe7d2d254ffce2eb998). I also think it would also be good to rename `UnloadBlockIndex` to `ClearBlockIndexCandidates` here. Doing these things would leave the code in a less confusing state after this commit, even if it makes this diff a little bigger.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T13:17:30Z",
      "diff_hunk" : "@@ -4370,7 +4370,7 @@ bool Chainstate::NeedsRedownload() const\n void Chainstate::UnloadBlockIndex()\n {\n     AssertLockHeld(::cs_main);\n-    nBlockSequenceId = 1;\n+    m_chainman.nBlockSequenceId = 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232240800",
      "id" : 1232240800,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JcoCg",
      "original_commit_id" : "2ebdfa8529b222de0db6d7114e9e5a1622fecfd0",
      "original_line" : 4373,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232240800/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232240800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232489431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232489431"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (b0b48b3e986319fe8cd5a80052099070279ce5c0)\r\n\r\nNote for reviewers: A real hash is being passed instead of GetRandHash() now, because of discussion https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262047, because `ActivateExistingSnapshot` should not be expected to work when called with an invalid blockhash even if it does work now.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T16:39:26Z",
      "diff_hunk" : "@@ -138,16 +134,15 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n \n     // Create a snapshot-based chainstate.\n     //\n-    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232489431",
      "id" : 1232489431,
      "line" : 141,
      "node_id" : "PRRC_kwDOABII585JdkvX",
      "original_commit_id" : "b0b48b3e986319fe8cd5a80052099070279ce5c0",
      "original_line" : 141,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 78,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232489431/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232489431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232578002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232578002"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499):\r\n\r\nI think this also needs to add `if (pindex == pindexFirstAssumeValid) pindexFirstAssumeValid = nullptr;` at line 4881 to reset `pindexFirstAssumeValid` when moving to a sibling.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T18:08:43Z",
      "diff_hunk" : "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232578002",
      "id" : 1232578002,
      "line" : 4726,
      "node_id" : "PRRC_kwDOABII585Jd6XS",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4717,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 354,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232578002/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232578002",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232705541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232705541"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499)\r\n\r\nNote: This change is partially reverting [`8f5710f`](https://github.com/bitcoin/bitcoin/pull/21526/commits/8f5710fd0ac5173b577e5d00708485170b321bcc) from #21526",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T20:03:10Z",
      "diff_hunk" : "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n         // Assumed-valid index entries will not have data since we haven't downloaded the\n         // full block yet.\n-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA) && !pindex->IsAssumedValid()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232705541",
      "id" : 1232705541,
      "line" : 4713,
      "node_id" : "PRRC_kwDOABII585JeZgF",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4719,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 358,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232705541/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232705541",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232733285"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232733285"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499)\r\n\r\nShould also delete this \"Assumed-valid index entries will not have data\" comment, I think, since it doesn't really explain anything and no longer seems relevant here",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T20:14:07Z",
      "diff_hunk" : "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n         // Assumed-valid index entries will not have data since we haven't downloaded the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232733285",
      "id" : 1232733285,
      "line" : 4728,
      "node_id" : "PRRC_kwDOABII585JegRl",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4719,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 356,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232733285/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232733285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232743393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232743393"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499)\r\n\r\nThis is very pedantic but the phrase \"snapshotted chain\" here and in the commit description doesn't really parse for me. It sounds like a chain a snapshot was created from, not a chain created from a snapshot. Could maybe replace \"snapshotted chain\" with \"chain based on assumeutxo snapshot\"",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T20:25:25Z",
      "diff_hunk" : "@@ -4837,7 +4845,12 @@ void Chainstate::CheckBlockIndex()\n             // So if this block is itself better than m_chain.Tip() and it wasn't in\n             // setBlockIndexCandidates, then it must be in m_blocks_unlinked.\n             if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) && setBlockIndexCandidates.count(pindex) == 0) {\n-                if (pindexFirstInvalid == nullptr) {\n+                if (pindexFirstInvalid == nullptr && pindexFirstAssumeValid == nullptr) {\n+                    // If this is a snapshotted chain, then this block could",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232743393",
      "id" : 1232743393,
      "line" : 4858,
      "node_id" : "PRRC_kwDOABII585Jeivh",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4849,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 393,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232743393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232743393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232771857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232771857"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f02125f1c7ba1c77c6d4ddb028999090fe5298eb)\r\n\r\nI think it would be good to drop this whole for-loop. The loop was originally added in [`0fd599a`](https://github.com/bitcoin/bitcoin/pull/23174/commits/0fd599a51a700c028d6f7ed8067d2d9f6e6a04a5) from #23174 to compute `first_assumed_valid_height`. Adding the asserts there was really an afterthought, so keeping this loop just to make assertions about ChainStateManager doesn't seem worth it. Dropping the loop and asserts would also allow dropping the reliesOnAssumedValid method, which would be nice to get rid of.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T20:54:46Z",
      "diff_hunk" : "@@ -4446,9 +4443,6 @@ bool ChainstateManager::LoadBlockIndex()\n                 assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n                 assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n \n-                first_assumed_valid_height = block->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232771857",
      "id" : 1232771857,
      "line" : 4407,
      "node_id" : "PRRC_kwDOABII585JepsR",
      "original_commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "original_line" : 4449,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 228,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232771857/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232771857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232772481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232772481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In b0b48b3e986319fe8cd5a80052099070279ce5c0 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nnit: can inline\r\n\r\n```suggestion\r\n            if (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex) {\r\n```",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T20:55:51Z",
      "diff_hunk" : "@@ -3414,7 +3414,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;\n+        if (!is_bg_chainstate) {\n+            // The active chainstate should always add entries that have more\n+            // work than the tip.\n+            setBlockIndexCandidates.insert(pindex);\n+        } else {\n+            // For the background chainstate, we only consider connecting blocks\n+            // towards the snapshot base (which can't be nullptr or else we'll\n+            // never make progress).\n+            assert(m_snapshot_entry != nullptr);\n+            bool ancestor_of_snapshot_base = (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex);\n+            if (ancestor_of_snapshot_base) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232772481",
      "id" : 1232772481,
      "line" : 3428,
      "node_id" : "PRRC_kwDOABII585Jep2B",
      "original_commit_id" : "b0b48b3e986319fe8cd5a80052099070279ce5c0",
      "original_line" : 3428,
      "original_position" : 16,
      "original_start_line" : 3427,
      "path" : "src/validation.cpp",
      "position" : 58,
      "pull_request_review_id" : 1484375498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232772481/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 3427,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-16T21:16:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232772481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232795224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232795224"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Explicitly track snapshot block header when using multiple chainstates\" (d2ccbd3541622147ab0d4b808a1b9388ddcd7948)\r\n\r\nI don't think adding this `Chainstate::m_snapshot_entry` variable is a good idea. I don't like how it has different meanings for different chainstates (starting point of validation for the snapshot chainstate, and ending point for the background chainstate), and the lack of documentation, and the complicated initialization which happens in the Chainstate constructor for the snapshot chainstate, but also in `ActivateSnapshot` for both chainstates, and then again in `LoadBlockIndex` for both chainstates, and pointedly _not_ in `ActivateExistingSnapshot` according to a new comment there saying it will be initialized later... It just seems like a lot of complexity for new variable which is redundant with the existing `m_from_snapshot_blockhash` variable and is only used one place, in `Chainstate::TryAddBlockIndexCandidate`.\r\n\r\nI think it would be better if `Chainstate::TryAddBlockIndexCandidate` just used snapshot chainstate's `m_from_snapshot_blockhash` value directly. Or if that is too inefficient, we could add a `m_from_snapshot_blockindex` member that mirrors `m_from_snapshot_blockhash` and is const and could be initialized straightforwardly in the `ChainState` constructor.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T21:25:58Z",
      "diff_hunk" : "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232795224",
      "id" : 1232795224,
      "line" : 497,
      "node_id" : "PRRC_kwDOABII585JevZY",
      "original_commit_id" : "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "original_line" : 497,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 25,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232795224/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232795224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232807245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232807245"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071e\r\n\r\n> I think master has a couple bugs.\r\n\r\nI'm curious if there is actually more than one bug. The one bug I know about is the bug introduced \r\n[`0fd599a`](https://github.com/bitcoin/bitcoin/pull/23174/commits/0fd599a51a700c028d6f7ed8067d2d9f6e6a04a5) from #23174 where `LoadBlockIndex` is misinterpreting the `BLOCK_ASSUMED_VALID` flag, and setting `first_assumed_valid_height` to the height of the first assumed valid block, instead of the height of the first block after the last assumed valid block (i.e. the snapshot height). I think it's pretty bad that we didn't catch this bug in review, or push for a more realistic test that would have caught it, or followed up on the suggestion from Marco https://github.com/bitcoin/bitcoin/pull/23174#discussion_r768600512 to just add blocks to `setBlockIndexCandidates` linearly, which is what this PR does, and is much more straightforward.\r\n\r\nAre there other known bugs? Are the changes to `AcceptBlock` meant to fix a bug or more to prevent a potential bug? Does the change to `ChainstateManager::ReceivedBlockTransactions` fix a bug? It seems like maybe it could prevent inappropriate blocks being added as candidates to the background chainstate, but it's not clear.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T21:37:44Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232807245",
      "id" : 1232807245,
      "in_reply_to_id" : 1212164200,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JeyVN",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3449,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232807245/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232807245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232868270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232868270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think I concur with @ryanofsky here. I'll have to double check, but in actual usage in #27596, I think I found that the one usage of this had another (existing) way of getting at this data. I'm afk for a few days, but will verify when I get back.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T23:06:31Z",
      "diff_hunk" : "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232868270",
      "id" : 1232868270,
      "in_reply_to_id" : 1232795224,
      "line" : 497,
      "node_id" : "PRRC_kwDOABII585JfBOu",
      "original_commit_id" : "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "original_line" : 497,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 25,
      "pull_request_review_id" : 1484538346,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232868270/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:06:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232868270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with your criticisms that the way this is written is pretty confusing (it took me a while to get it right in the first place, and I found this hard to reason about).  \r\n\r\nI wanted to capture the idea that the hash `m_from_snapshot_blockhash` must always be in our block index, so that we never have to worry when we look it up in the block index that it might be missing, and we have to deal with a nullptr case.\r\n\r\nHowever, I couldn't see how to make it a const that is straightforwardly initialized in `Chainstate`, because there are two different cases to consider (activating a snapshot for the first time, versus detecting that we have a snapshot on restart).\r\n\r\nAlso, while this PR introduces one place where this CBlockIndex is used, I expect that we'll use it again in the `net_processing` code which will download blocks toward the snapshot base.\r\n\r\nHere are a few options I can think of to improve this:\r\n* just look the hash up every time we need to use it (both in `TryAddBlockIndexCandidate` and wherever it is needed in `net_processing`, likely one additional place), avoiding the storage of redundant information\r\n* lazily fill it in so that we only look it up once, and then use the looked-up value for future requests\r\n* move the knowledge of the snapshot base to `ChainstateManager`, so that we don't store redundant information in both chainstates (this could be done along with either of the first two ideas, I think?)\r\n\r\nEDIT: Gah, I just noticed `ChainstateManager::GetSnapshotBaseBlock()`, didn't realize we already had that.  I think I know what to do now to fix this!",
      "commit_id" : "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "created_at" : "2023-06-17T01:19:05Z",
      "diff_hunk" : "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921513",
      "id" : 1232921513,
      "in_reply_to_id" : 1232795224,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfOOp",
      "original_commit_id" : "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "original_line" : 497,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1484629167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921513/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T14:50:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921766"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in 0274b79285f781c3374678208dc3e00607907c7f",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:21:07Z",
      "diff_hunk" : "@@ -3414,7 +3414,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;\n+        if (!is_bg_chainstate) {\n+            // The active chainstate should always add entries that have more\n+            // work than the tip.\n+            setBlockIndexCandidates.insert(pindex);\n+        } else {\n+            // For the background chainstate, we only consider connecting blocks\n+            // towards the snapshot base (which can't be nullptr or else we'll\n+            // never make progress).\n+            assert(m_snapshot_entry != nullptr);\n+            bool ancestor_of_snapshot_base = (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex);\n+            if (ancestor_of_snapshot_base) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921766",
      "id" : 1232921766,
      "in_reply_to_id" : 1232772481,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfOSm",
      "original_commit_id" : "b0b48b3e986319fe8cd5a80052099070279ce5c0",
      "original_line" : 3428,
      "original_position" : 16,
      "original_start_line" : 3427,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1484629417,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921766/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:21:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks -- this is much better, took your language in daeba143a718c95b11432aed909781affe33efea.",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:22:04Z",
      "diff_hunk" : "@@ -126,6 +126,12 @@ class BlockManager\n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n     int m_last_blockfile = 0;\n+    // Track the largest height block whose undo data is in m_last_blockfile.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921860",
      "id" : 1232921860,
      "in_reply_to_id" : 1232107866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfOUE",
      "original_commit_id" : "6cc09f4759444218d1b493a1bcf44bb63f3160d2",
      "original_line" : 129,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1484629548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921860/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:22:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed in 95680a6e90bbf27183dcf09b5c450494d356ebe5.\r\nGood catch, thanks.  It seems unfortunate that this wasn't caught by any unit tests; perhaps we should come up with a test case that will more fully exercise all of the `CheckBlockIndex()` logic?",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:22:51Z",
      "diff_hunk" : "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922177",
      "id" : 1232922177,
      "in_reply_to_id" : 1232578002,
      "line" : 4709,
      "node_id" : "PRRC_kwDOABII585JfOZB",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4717,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 361,
      "pull_request_review_id" : 1484629997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922177/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:22:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922226"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922226"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, that comment was incorrect (blocks retain their assumevalid status until they are validated, which can be some time after they are downloaded).  Removed this comment in 95680a6e90bbf27183dcf09b5c450494d356ebe5.",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:23:14Z",
      "diff_hunk" : "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n         // Assumed-valid index entries will not have data since we haven't downloaded the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922226",
      "id" : 1232922226,
      "in_reply_to_id" : 1232733285,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfOZy",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4719,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1484630070,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922226/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:23:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922290"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, fixed in this place in the code in 95680a6e90bbf27183dcf09b5c450494d356ebe5.  Will try to fix up the commit descriptions when I squash/rebase. \r\n\r\nEdit: this is now fixed in the commit messages as well.",
      "commit_id" : "1ce79c5672989c20ba7c927fac2cb8d525ba7525",
      "created_at" : "2023-06-17T01:23:50Z",
      "diff_hunk" : "@@ -4837,7 +4845,12 @@ void Chainstate::CheckBlockIndex()\n             // So if this block is itself better than m_chain.Tip() and it wasn't in\n             // setBlockIndexCandidates, then it must be in m_blocks_unlinked.\n             if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) && setBlockIndexCandidates.count(pindex) == 0) {\n-                if (pindexFirstInvalid == nullptr) {\n+                if (pindexFirstInvalid == nullptr && pindexFirstAssumeValid == nullptr) {\n+                    // If this is a snapshotted chain, then this block could",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922290",
      "id" : 1232922290,
      "in_reply_to_id" : 1232743393,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfOay",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4849,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1484630205,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922290/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T13:20:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232923062"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232923062"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, ok -- I've removed this in 1aebb99a10f9977e1d1bf4b923e2a2e984c76160.\r\n\r\nSo, one thing I haven't fixed yet is the reference to `pindex->IsAssumedValid()` just below this for loop:\r\n\r\n```c++\r\n\r\n        for (CBlockIndex* pindex : vSortedByHeight) {\r\n            if (ShutdownRequested()) return false;\r\n            if (pindex->IsAssumedValid() ||\r\n                    (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\r\n                     (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\r\n\r\n                for (Chainstate* chainstate : GetAll()) {\r\n                    chainstate->TryAddBlockIndexCandidate(pindex);\r\n                }\r\n            }\r\n```\r\n\r\nReally, the assumed-valid status bit has nothing to do with whether a block index should be a most-work-chain candidate, except that right when a snapshot is activated, we need the base block to be added to `setBlockIndexCandidates` for the chain that is based on that snapshot.  Probably I should fix this in this PR as well?",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:27:09Z",
      "diff_hunk" : "@@ -4446,9 +4443,6 @@ bool ChainstateManager::LoadBlockIndex()\n                 assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n                 assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n \n-                first_assumed_valid_height = block->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232923062",
      "id" : 1232923062,
      "in_reply_to_id" : 1232771857,
      "line" : 4407,
      "node_id" : "PRRC_kwDOABII585JfOm2",
      "original_commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "original_line" : 4449,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 232,
      "pull_request_review_id" : 1484631732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232923062/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:27:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232923062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232925887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232925887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess the fairest thing to say is that the changes to `AcceptBlock()` are to prevent a future bug -- it's possible that we could write code that somehow gets it right, but the design of selectively adding blocks to one chainstate's block index, and not the other, is one that I found very confusing. \r\n\r\nAs an example, if you took #24008 (which proposed logic for determining which chainstate to invoke AcceptBlock() on) and combined that with changing the logic in `AcceptBlock()` so that the background chainstate wouldn't bother processing blocks that are past the snapshot base, then that would be problematic if we were to allow pruning the snapshot-based-chain while the background sync is running (because according to the logic in #24008, if the block is already on the active chain, then we give it to the background chainstate to process).  That's 2 hypotheticals so certainly this is speculative, but I think that those changes would all make sense on their own, so the fact that they fail to compose with the code in master is a sign to me that we should take a different design.",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:46:17Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232925887",
      "id" : 1232925887,
      "in_reply_to_id" : 1212164200,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfPS_",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3449,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1484635600,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232925887/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:46:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232925887",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @ryanofsky for the detailed review.  I've addressed many of the comments in fixup commits, which are tagged here for easier review:  [27746.1](https://github.com/sdaftuar/bitcoin/tree/27746.1).  I've now squashed those fixups into place and pushed.  Still outstanding for me to look at:\r\n\r\n- [x] Move AcceptBlock to not be a member of ChainstateManager. I think you're right that this is better if we pull it out of the class. EDIT: took a stab at this in [14e56b9](https://github.com/bitcoin/bitcoin/pull/27746/commits/14e56b957a81495e69bb906cd2ea52b6febd2baa), if this looks good I can integrate this earlier in the commit history.\r\n- [x] Clean up the commits mentioned here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232240800\r\n- [x] Resolve the issue mentioned here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232795224\r\n- [x] Fix the usage of `pindex->IsAssumedValid()` that I mentioned here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232923062 (done in 78fcc8fbdc510c03dd021e6c34a10e6b35fc2c83)\r\n- [ ] See if I can add some kind of test that would have caught the bug you mentioned in CheckBlockIndex here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922177",
      "created_at" : "2023-06-17T13:19:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1595757923",
      "id" : 1595757923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585fHVVj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1595757923/reactions"
      },
      "updated_at" : "2023-06-17T18:03:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1595757923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233062742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233062742"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in latest push.",
      "commit_id" : "1ce79c5672989c20ba7c927fac2cb8d525ba7525",
      "created_at" : "2023-06-17T13:29:42Z",
      "diff_hunk" : "@@ -4370,7 +4370,7 @@ bool Chainstate::NeedsRedownload() const\n void Chainstate::UnloadBlockIndex()\n {\n     AssertLockHeld(::cs_main);\n-    nBlockSequenceId = 1;\n+    m_chainman.nBlockSequenceId = 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233062742",
      "id" : 1233062742,
      "in_reply_to_id" : 1232240800,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfwtW",
      "original_commit_id" : "2ebdfa8529b222de0db6d7114e9e5a1622fecfd0",
      "original_line" : 4373,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1484825023,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233062742/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T13:29:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233062742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233077487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233077487"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921513\r\n\r\n> EDIT: Gah, I just noticed ChainstateManager::GetSnapshotBaseBlock(), didn't realize we already had that. I think I know what to do now to fix this!\r\n\r\nThanks, I didn't realize how clunky ChainstateManager initialization was when I made that suggestion. Particularly how it allowed construction with that snapshot block that wasn't actually in the index. I think initialization can definitely be simplified later. But even without doing that I experimented a little and came up with a change that adds `CS::SnapshotBase()` and `CSM::ActiveSnapshotBase()` methods that I think should provide a good interface for external code to use, while allowing us to clean up the internal representation and init process later:\r\n\r\n```diff\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -528,12 +528,8 @@ protected:\r\n     //! is set to true on the snapshot chainstate.\r\n     bool m_disabled GUARDED_BY(::cs_main) {false};\r\n \r\n-    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n-        { m_snapshot_entry = entry; }\r\n-\r\n-    //! Track the snapshot entry\r\n-    const CBlockIndex* m_snapshot_entry GUARDED_BY(::cs_main) {nullptr};\r\n-\r\n+    //! Cached result of LookupBlockIndex(*m_from_snapshot_blockhash)\r\n+    const CBlockIndex* m_cached_snapshot_base GUARDED_BY(::cs_main) {nullptr};\r\n \r\n public:\r\n     //! Reference to a BlockManager instance which itself is shared across all\r\n@@ -586,6 +582,13 @@ public:\r\n      */\r\n     const std::optional<uint256> m_from_snapshot_blockhash;\r\n \r\n+    /**\r\n+     * The base of the snapshot this chainstate was created from.\r\n+     *\r\n+     * nullptr if this chainstate was not created from a snapshot.\r\n+     */\r\n+    const CBlockIndex* SnapshotBase() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+\r\n     //! Return true if this chainstate relies on blocks that are assumed-valid. In\r\n     //! practice this means it was created based on a UTXO snapshot.\r\n     bool reliesOnAssumedValid() { return m_from_snapshot_blockhash.has_value(); }\r\n@@ -1093,6 +1096,11 @@ public:\r\n         return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;\r\n     }\r\n \r\n+    const CBlockIndex* ActiveSnapshotBase() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n+    {\r\n+        return m_active_chainstate ? m_active_chainstate->SnapshotBase() : nullptr;\r\n+    }\r\n+\r\n     /**\r\n      * Import blocks from an external file\r\n      *\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -1579,9 +1579,13 @@ Chainstate::Chainstate(\r\n       m_chainman(chainman),\r\n       m_from_snapshot_blockhash(from_snapshot_blockhash)\r\n {\r\n-    if (m_from_snapshot_blockhash) {\r\n-        m_snapshot_entry = WITH_LOCK(::cs_main, return m_chainman.m_blockman.LookupBlockIndex(*m_from_snapshot_blockhash));\r\n-    }\r\n+}\r\n+\r\n+const CBlockIndex* Chainstate::SnapshotBase()\r\n+{\r\n+    if (!m_from_snapshot_blockhash) return nullptr;\r\n+    if (!m_cached_snapshot_base) m_cached_snapshot_base = Assert(m_chainman.m_blockman.LookupBlockIndex(*m_from_snapshot_blockhash));\r\n+    return m_cached_snapshot_base;\r\n }\r\n \r\n void Chainstate::InitCoinsDB(\r\n@@ -3423,8 +3427,9 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\r\n             // For the background chainstate, we only consider connecting blocks\r\n             // towards the snapshot base (which can't be nullptr or else we'll\r\n             // never make progress).\r\n-            assert(m_snapshot_entry != nullptr);\r\n-            if (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex) {\r\n+            const CBlockIndex* snapshot_base{m_chainman.ActiveSnapshotBase()};\r\n+            assert(snapshot_base != nullptr);\r\n+            if (snapshot_base->GetAncestor(pindex->nHeight) == pindex) {\r\n                 setBlockIndexCandidates.insert(pindex);\r\n             }\r\n         }\r\n@@ -4416,14 +4421,6 @@ bool ChainstateManager::LoadBlockIndex()\r\n         bool ret{m_blockman.LoadBlockIndexDB()};\r\n         if (!ret) return false;\r\n \r\n-        // If we already have 2 chainstates, then we need to update the\r\n-        // snapshot base to point to the correct block entry.\r\n-        if (IsSnapshotActive()) {\r\n-            CBlockIndex *entry = m_blockman.LookupBlockIndex(*SnapshotBlockhash());\r\n-            m_ibd_chainstate->UpdateSnapshotBaseEntry(entry);\r\n-            m_snapshot_chainstate->UpdateSnapshotBaseEntry(entry);\r\n-        }\r\n-\r\n         m_blockman.ScanAndUnlinkAlreadyPrunedFiles();\r\n \r\n         std::vector<CBlockIndex*> vSortedByHeight{m_blockman.GetAllBlockIndices()};\r\n@@ -5142,8 +5139,6 @@ bool ChainstateManager::ActivateSnapshot(\r\n             m_snapshot_chainstate->CoinsTip().DynamicMemoryUsage() / (1000 * 1000));\r\n \r\n         this->MaybeRebalanceCaches();\r\n-\r\n-        m_ibd_chainstate->m_snapshot_entry = m_snapshot_chainstate->m_snapshot_entry;\r\n     }\r\n     return true;\r\n }\r\n@@ -5623,8 +5618,6 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\r\n         std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\r\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\r\n     m_active_chainstate = m_snapshot_chainstate.get();\r\n-    // Note: m_snapshot_entry will be populated after the block index is\r\n-    // loaded; see ChainstateManager::LoadBlockIndex.\r\n     return *m_snapshot_chainstate;\r\n }\r\n \r\n```\r\n\r\n",
      "commit_id" : "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "created_at" : "2023-06-17T15:16:18Z",
      "diff_hunk" : "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233077487",
      "id" : 1233077487,
      "in_reply_to_id" : 1232795224,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Jf0Tv",
      "original_commit_id" : "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "original_line" : 497,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1484840490,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233077487/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T15:16:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233077487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233278470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233278470"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `CChain chain {};` above is now unused.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-18T13:05:32Z",
      "diff_hunk" : "@@ -28,20 +28,20 @@ BOOST_AUTO_TEST_CASE(blockmanager_find_block_pos)\n     BlockManager blockman{blockman_opts};\n     CChain chain {};\n     // simulate adding a genesis block normally\n-    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, chain, nullptr).nPos, BLOCK_SERIALIZATION_HEADER_SIZE);\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, nullptr).nPos, BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233278470",
      "id" : 1233278470,
      "line" : 30,
      "node_id" : "PRRC_kwDOABII585JglYG",
      "original_commit_id" : "59b085f4d8bb5120c14b055ce394c06fe129dc60",
      "original_line" : 31,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/blockmanager_tests.cpp",
      "position" : 7,
      "pull_request_review_id" : 1485089804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233278470/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-18T14:26:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233278470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233337055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233337055"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed in 4a699011048e88099545a612075b5483ff55f533.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-18T16:41:45Z",
      "diff_hunk" : "@@ -28,20 +28,20 @@ BOOST_AUTO_TEST_CASE(blockmanager_find_block_pos)\n     BlockManager blockman{blockman_opts};\n     CChain chain {};\n     // simulate adding a genesis block normally\n-    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, chain, nullptr).nPos, BLOCK_SERIALIZATION_HEADER_SIZE);\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, nullptr).nPos, BLOCK_SERIALIZATION_HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233337055",
      "id" : 1233337055,
      "in_reply_to_id" : 1233278470,
      "line" : 30,
      "node_id" : "PRRC_kwDOABII585Jgzrf",
      "original_commit_id" : "59b085f4d8bb5120c14b055ce394c06fe129dc60",
      "original_line" : 31,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/blockmanager_tests.cpp",
      "position" : 7,
      "pull_request_review_id" : 1485148184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233337055/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-18T16:42:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233337055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I added a commit that moves `CheckBlockIndex()` from `Chainstate` to `ChainstateManager` and tightens up the sanity checks around `setBlockIndexCandidates` and `mapBlocksUnlinked`, to better match what is implemented in this PR, and reduce the places in `CheckBlockIndex` where we skip tests in the presence of assumed-valid blocks. \r\n\r\nThere's probably still room for improvement on the tests to better exercise all this logic (https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922177), and I haven't yet picked up the suggestion from @ryanofsky in https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233077487, which would give us a performance optimization by caching lookups into the block index when adding blocks to the background chainstate's `setBlockIndexCandidates`.  I could use explicit feedback on: (a) whether the performance optimization is important enough that we should do it; (b) whether the movement of `AcceptBlock` out of `ChainstateManager` is an improvement; (c) whether additional tests should be added prior to merge (if so, I can work on it, but would also welcome help to write more tests!); and (d) whether moving `CheckBlockIndex()` into `ChainstateManager` should be done in this PR.  With feedback on those items, I'll go back and squash the fixup commits into place to clean up the branch.",
      "created_at" : "2023-06-18T16:48:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1596205284",
      "id" : 1596205284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585fJCjk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1596205284/reactions"
      },
      "updated_at" : "2023-06-18T16:48:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1596205284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233368008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233368008"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for adding the comment. I would much prefer it if this line was a guard clause. Currently, it wraps the entire function body. I find guard clauses improve readability significantly in that case.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-18T19:49:01Z",
      "diff_hunk" : "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233368008",
      "id" : 1233368008,
      "line" : 3412,
      "node_id" : "PRRC_kwDOABII585Jg7PI",
      "original_commit_id" : "55e27ee995944d188d7453c6e78a6538f6739d64",
      "original_line" : 3411,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 51,
      "pull_request_review_id" : 1485181856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233368008/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:01:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233368008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233829135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233829135"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`nBlockSequenceId` should only ever increase, so I would suggest wrapping this in a `ChainstateManger::GetNewBlockSequenceId` (or similar) and making `nBlockSequenceId` private.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-19T10:06:27Z",
      "diff_hunk" : "@@ -3453,21 +3453,21 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n             CBlockIndex *pindex = queue.front();\n             queue.pop_front();\n             pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n-            pindex->nSequenceId = nBlockSequenceId++;\n-            for (Chainstate *c : GetAll()) {\n+            pindex->nSequenceId = chainman.nBlockSequenceId++;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233829135",
      "id" : 1233829135,
      "line" : 3457,
      "node_id" : "PRRC_kwDOABII585Jir0P",
      "original_commit_id" : "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "original_line" : 3456,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 97,
      "pull_request_review_id" : 1485874548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233829135/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T11:02:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233829135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233857394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233857394"
         }
      },
      "author_association" : "MEMBER",
      "body" : "turbo nit: All params except chainman are related to the block you are passing in, so having the chainman in the middle feels a bit out of order. Would suggest placing it first or last.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-19T10:24:48Z",
      "diff_hunk" : "@@ -337,9 +337,46 @@ class CScriptCheck\n /** Context-independent validity checks */\n bool CheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n \n+/**\n+ * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\n+ * that it doesn't descend from an invalid block, and then add it to m_block_index.\n+ * Caller must set min_pow_checked=true in order to add a new header to the\n+ * block index (permanent memory storage), indicating that the header is\n+ * known to be part of a sufficiently high-work chain (anti-dos check).\n+ */\n+bool AcceptBlockHeader(\n+    const CBlockHeader& block,\n+    ChainstateManager& chaiman,\n+    BlockValidationState& state,\n+    CBlockIndex** ppindex,\n+    bool min_pow_checked) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+/**\n+ * Sufficiently validate a block for disk storage (and store on disk).\n+ *\n+ * @param[in]   pblock          The block we want to process.\n+ * @param[in]   fRequested      Whether we requested this block from a\n+ *                              peer.\n+ * @param[in]   dbp             The location on disk, if we are importing\n+ *                              this block from prior storage.\n+ * @param[in]   min_pow_checked True if proof-of-work anti-DoS checks have\n+ *                              been done by caller for headers chain\n+ *\n+ * @param[out]  state       The state of the block validation.\n+ * @param[out]  ppindex     Optional return parameter to get the\n+ *                          CBlockIndex pointer for this block.\n+ * @param[out]  fNewBlock   Optional return parameter to indicate if the\n+ *                          block is new to our storage.\n+ *\n+ * @returns   False if the block or header is invalid, or if saving to disk fails (likely a fatal error); true otherwise.\n+ */\n+bool AcceptBlock(const std::shared_ptr<const CBlock>& pblock, ChainstateManager& chainman, BlockValidationState& state, CBlockIndex** ppindex, bool fRequested, const FlatFilePos* dbp, bool* fNewBlock, bool min_pow_checked) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+void ReceivedBlockTransactions(const CBlock& block, ChainstateManager& chainman, CBlockIndex* pindexNew, const FlatFilePos& pos) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233857394",
      "id" : 1233857394,
      "line" : 375,
      "node_id" : "PRRC_kwDOABII585Jiyty",
      "original_commit_id" : "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "original_line" : 375,
      "original_position" : 39,
      "original_start_line" : 373,
      "path" : "src/validation.h",
      "position" : 39,
      "pull_request_review_id" : 1485874548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233857394/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 373,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-19T11:02:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233857394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233860685"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233860685"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Accessing `m_failed_blocks` directly doesn't seem like a clean interface. I think it would be nicer if this entire for loop would be wrapped in a method on chainman.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-19T10:28:00Z",
      "diff_hunk" : "@@ -3816,13 +3816,13 @@ bool ChainstateManager::AcceptBlockHeader(const CBlockHeader& block, BlockValida\n             // hasn't been validated up to BLOCK_VALID_SCRIPTS. This is a performance\n             // optimization, in the common case of adding a new block to the tip,\n             // we don't need to iterate over the failed blocks list.\n-            for (const CBlockIndex* failedit : m_failed_blocks) {\n+            for (const CBlockIndex* failedit : chainman.m_failed_blocks) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233860685",
      "id" : 1233860685,
      "line" : 3820,
      "node_id" : "PRRC_kwDOABII585JizhN",
      "original_commit_id" : "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "original_line" : 3819,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 171,
      "pull_request_review_id" : 1485874548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233860685/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T11:02:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233860685",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237396224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237396224"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(General note on https://github.com/bitcoin/bitcoin/pull/27746/commits/59b085f4d8bb5120c14b055ce394c06fe129dc60)\r\n\r\nReviewers may be interested to take a look at a related future commit in #27596, https://github.com/bitcoin/bitcoin/pull/27596/commits/906ae54c11d873cfc1803078b9ce7822fc00bfd4, where I propose adding `chainstate_role` as a simple enum parameter to `FindBlockPos()` so that we may segment block storage by chainstate type.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-21T18:10:43Z",
      "diff_hunk" : "@@ -604,7 +604,7 @@ fs::path BlockManager::GetBlockPosFilename(const FlatFilePos& pos) const\n     return BlockFileSeq().FileName(pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237396224",
      "id" : 1237396224,
      "line" : 610,
      "node_id" : "PRRC_kwDOABII585JwSsA",
      "original_commit_id" : "59b085f4d8bb5120c14b055ce394c06fe129dc60",
      "original_line" : 604,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 14,
      "pull_request_review_id" : 1491402431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237396224/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237396224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237406346"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237406346"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to call `ResetBlockSequenceCounters()` here to preserve existing behavior?",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-21T18:18:34Z",
      "diff_hunk" : "@@ -221,7 +221,7 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n \n         // A reload of the block index is required to recompute setBlockIndexCandidates\n         // for the fully validated chainstate.\n-        chainman.ActiveChainstate().UnloadBlockIndex();\n+        chainman.ActiveChainstate().ClearBlockIndexCandidates();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237406346",
      "id" : 1237406346,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII585JwVKK",
      "original_commit_id" : "96cd3b06357c08a894d43e45acc456e4f0350e09",
      "original_line" : 224,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 5,
      "pull_request_review_id" : 1491402431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237406346/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237406346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237491817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237491817"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/27746/commits/943bd665e2523e5cd483aa2a77a511b967dee509\r\n\r\nIf you happen to retouch, could `ActiveChain().Tip()` -> `ActiveTip()`.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-21T19:04:25Z",
      "diff_hunk" : "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveChain().Tip() ? pindex->nChainWork >= ActiveChain().Tip()->nChainWork : true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237491817",
      "id" : 1237491817,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JwqBp",
      "original_commit_id" : "943bd665e2523e5cd483aa2a77a511b967dee509",
      "original_line" : 3925,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1491402431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237491817/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237491817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237494340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237494340"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/27746/commits/943bd665e2523e5cd483aa2a77a511b967dee509\r\n\r\nIf you happen to retouch, `ActiveHeight()`.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-21T19:04:50Z",
      "diff_hunk" : "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveChain().Tip() ? pindex->nChainWork >= ActiveChain().Tip()->nChainWork : true);\n     // Blocks that are too out-of-order needlessly limit the effectiveness of\n     // pruning, because pruning will not delete block files that contain any\n     // blocks which are too close in height to the tip.  Apply this test\n     // regardless of whether pruning is enabled; it should generally be safe to\n     // not process unrequested blocks.\n-    bool fTooFarAhead{pindex->nHeight > m_chain.Height() + int(MIN_BLOCKS_TO_KEEP)};\n+    bool fTooFarAhead{pindex->nHeight > ActiveChain().Height() + int(MIN_BLOCKS_TO_KEEP)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237494340",
      "id" : 1237494340,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JwqpE",
      "original_commit_id" : "943bd665e2523e5cd483aa2a77a511b967dee509",
      "original_line" : 3931,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1491402431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237494340/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237494340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237511461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237511461"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/27746/commits/943bd665e2523e5cd483aa2a77a511b967dee509\r\n\r\nProbably no need to use `ActiveChainstate()` for these (vs. `this->`) given the TODO above, but seems fine.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-21T19:07:24Z",
      "diff_hunk" : "@@ -3978,9 +3980,16 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n         return AbortNode(state, std::string(\"System error: \") + e.what());\n     }\n \n-    FlushStateToDisk(state, FlushStateMode::NONE);\n+    // TODO: FlushStateToDisk() handles flushing of both block and chainstate\n+    // data, so we should move this to ChainstateManager so that we can be more\n+    // intelligent about how we flush.\n+    // For now, since FlushStateMode::NONE is used, all that can happen is that\n+    // the block files may be pruned, so we can just call this on one\n+    // chainstate (particularly if we haven't implemented pruning with\n+    // background validation yet).\n+    ActiveChainstate().FlushStateToDisk(state, FlushStateMode::NONE);\n \n-    CheckBlockIndex();\n+    ActiveChainstate().CheckBlockIndex();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237511461",
      "id" : 1237511461,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Jwu0l",
      "original_commit_id" : "943bd665e2523e5cd483aa2a77a511b967dee509",
      "original_line" : 3992,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1491402431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237511461/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237511461",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237552792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237552792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note: it seems like we can default to the active chainstate here because the underlying notification that this sends (`KernelNotifications::headerTip()`) isn't really particular to any chainstate.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-21T19:15:33Z",
      "diff_hunk" : "@@ -4614,13 +4628,13 @@ void Chainstate::LoadExternalBlockFile(\n                     // called by concurrent network message processing. but, that is not\n                     // reliable for the purpose of pruning while importing.\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, pblock)) {\n+                    if (!ActiveChainstate().ActivateBestChain(state, pblock)) {\n                         LogPrint(BCLog::REINDEX, \"failed to activate chain (%s)\\n\", state.ToString());\n                         break;\n                     }\n                 }\n \n-                NotifyHeaderTip(*this);\n+                NotifyHeaderTip(ActiveChainstate());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237552792",
      "id" : 1237552792,
      "line" : 4604,
      "node_id" : "PRRC_kwDOABII585Jw46Y",
      "original_commit_id" : "943bd665e2523e5cd483aa2a77a511b967dee509",
      "original_line" : 4637,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 464,
      "pull_request_review_id" : 1491402431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237552792/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237552792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237579876"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237579876"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/27746/commits/55e27ee995944d188d7453c6e78a6538f6739d64\r\n\r\nIf you retouch, I think you can simply say `bool is_bg_chainstate = this != &ActiveChainstate();`",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-21T19:24:39Z",
      "diff_hunk" : "@@ -3414,7 +3414,17 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        // The active chainstate should always add entries that have more work than the tip.\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base.\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237579876",
      "id" : 1237579876,
      "in_reply_to_id" : 1230085759,
      "line" : 3413,
      "node_id" : "PRRC_kwDOABII585Jw_hk",
      "original_commit_id" : "e08dc8c14fc9dbd97db46482052ecb8d4163cfc2",
      "original_line" : 3412,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 52,
      "pull_request_review_id" : 1491402431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237579876/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T19:53:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237579876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237583806"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237583806"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/27746/commits/55e27ee995944d188d7453c6e78a6538f6739d64\r\n\r\nIf you retrouch, I think you could remove this line and just do `... snapshot_entry = Assert(m_chainman.GetSnapshotBaseBlock());`\r\n\r\nAlso could move the `snapshot_entry` initialization out of the loop if this gets slow for some reason.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-21T19:26:53Z",
      "diff_hunk" : "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;\n+        if (!is_bg_chainstate) {\n+            // The active chainstate should always add entries that have more\n+            // work than the tip.\n+            setBlockIndexCandidates.insert(pindex);\n+        } else {\n+            // For the background chainstate, we only consider connecting blocks\n+            // towards the snapshot base (which can't be nullptr or else we'll\n+            // never make progress).\n+            const CBlockIndex* snapshot_entry = m_chainman.GetSnapshotBaseBlock();\n+            assert(snapshot_entry != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237583806",
      "id" : 1237583806,
      "line" : 3423,
      "node_id" : "PRRC_kwDOABII585JxAe-",
      "original_commit_id" : "55e27ee995944d188d7453c6e78a6538f6739d64",
      "original_line" : 3422,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 62,
      "pull_request_review_id" : 1491402431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237583806/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237583806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237586189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237586189"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/27746/commits/55e27ee995944d188d7453c6e78a6538f6739d64\r\n\r\nMaybe not necessary in lieu of `this != &ActiveChainstate()`? Not hurting anything though.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-21T19:29:03Z",
      "diff_hunk" : "@@ -1047,6 +1047,12 @@ class ChainstateManager\n     //!          that a background validation chainstate is also in use.\n     bool IsSnapshotActive() const;\n \n+    //! @returns true if the chainstate is the background chainstate\n+    bool IsBackgroundChainstate(const Chainstate *chainstate) const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return chainstate == m_ibd_chainstate.get();\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237586189",
      "id" : 1237586189,
      "line" : 1079,
      "node_id" : "PRRC_kwDOABII585JxBEN",
      "original_commit_id" : "55e27ee995944d188d7453c6e78a6538f6739d64",
      "original_line" : 1054,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 215,
      "pull_request_review_id" : 1491402431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237586189/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237586189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237593280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237593280"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/27746/commits/2d20f75b0bad0b680cd45fc057c54704ac2a9d66\r\n\r\nNot entirely true since we have a small usage (by way of `IsAssumedValid()`) in LoadBlockIndex().\r\n\r\nEdit: oops nevermind, not as of the fixup commit: https://github.com/bitcoin/bitcoin/pull/27746/commits/78fcc8fbdc510c03dd021e6c34a10e6b35fc2c83",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-21T19:34:59Z",
      "diff_hunk" : "@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\n \n     /**\n-     * If set, this indicates that the block index entry is assumed-valid.\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n-     * It almost certainly means that the block's full validation is pending\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\n+     * and has validity status less than VALID_SCRIPTS. Also that it has\n+     * descendant blocks with VALID_SCRIPTS set, because they were validated\n+     * based on an assumeutxo snapshot.\n+     *\n+     * When an assumeutxo snapshot is loaded, the ASSUMED_VALID flag is added to\n+     * unvalidated blocks below the snapshot height. Then, as the background\n+     * validation progresses, and these blocks are validated, the ASSUMED_VALID\n+     * flags are removed. See `doc/design/assumeutxo.md` for details.\n+     *\n+     * This flag is only used to implement checks in CheckBlockIndex() and\n+     * should not be used elsewhere.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237593280",
      "id" : 1237593280,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII585JxCzA",
      "original_commit_id" : "2d20f75b0bad0b680cd45fc057c54704ac2a9d66",
      "original_line" : 148,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 32,
      "pull_request_review_id" : 1491402431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237593280/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T19:53:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237593280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1238721079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238721079"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `be will` => `be`",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-22T15:46:26Z",
      "diff_hunk" : "@@ -126,6 +126,19 @@ class BlockManager\n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n     int m_last_blockfile = 0;\n+\n+    // Track the height of the highest block in m_last_blockfile whose undo\n+    // data has been written. Block data is written to block files in download\n+    // order, but is written to undo files in validation order, which is\n+    // usually in order by height. To avoid wasting disk space, undo files will\n+    // be will trimmed whenever the corresponding block file is finalized and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1238721079",
      "id" : 1238721079,
      "line" : 133,
      "node_id" : "PRRC_kwDOABII585J1WI3",
      "original_commit_id" : "3fe223c36f9320f89af0eb31dabf55609bf2a0c7",
      "original_line" : 134,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 26,
      "pull_request_review_id" : 1485181856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238721079/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:01:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238721079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1239034939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239034939"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think \"back\" isn't technically correct here, it wasn't in there before",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-22T21:11:17Z",
      "diff_hunk" : "@@ -77,6 +77,13 @@ BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n     // After adding some blocks to the tip, best block should have changed.\n     BOOST_CHECK(::g_best_block != curr_tip);\n \n+    // Grab block 1 from disk; we'll add it back to the background chain later.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1239034939",
      "id" : 1239034939,
      "line" : 80,
      "node_id" : "PRRC_kwDOABII585J2iw7",
      "original_commit_id" : "55e27ee995944d188d7453c6e78a6538f6739d64",
      "original_line" : 80,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1485181856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239034939/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:01:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239034939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1239044564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239044564"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`chainman`",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-22T21:24:13Z",
      "diff_hunk" : "@@ -337,9 +337,46 @@ class CScriptCheck\n /** Context-independent validity checks */\n bool CheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n \n+/**\n+ * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\n+ * that it doesn't descend from an invalid block, and then add it to m_block_index.\n+ * Caller must set min_pow_checked=true in order to add a new header to the\n+ * block index (permanent memory storage), indicating that the header is\n+ * known to be part of a sufficiently high-work chain (anti-dos check).\n+ */\n+bool AcceptBlockHeader(\n+    const CBlockHeader& block,\n+    ChainstateManager& chaiman,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1239044564",
      "id" : 1239044564,
      "line" : 349,
      "node_id" : "PRRC_kwDOABII585J2lHU",
      "original_commit_id" : "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "original_line" : 349,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 13,
      "pull_request_review_id" : 1485181856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239044564/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:01:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239044564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1239045554"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239045554"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "chainman is missing from the list of params",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-22T21:25:37Z",
      "diff_hunk" : "@@ -337,9 +337,46 @@ class CScriptCheck\n /** Context-independent validity checks */\n bool CheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n \n+/**\n+ * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\n+ * that it doesn't descend from an invalid block, and then add it to m_block_index.\n+ * Caller must set min_pow_checked=true in order to add a new header to the\n+ * block index (permanent memory storage), indicating that the header is\n+ * known to be part of a sufficiently high-work chain (anti-dos check).\n+ */\n+bool AcceptBlockHeader(\n+    const CBlockHeader& block,\n+    ChainstateManager& chaiman,\n+    BlockValidationState& state,\n+    CBlockIndex** ppindex,\n+    bool min_pow_checked) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+/**\n+ * Sufficiently validate a block for disk storage (and store on disk).\n+ *\n+ * @param[in]   pblock          The block we want to process.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1239045554",
      "id" : 1239045554,
      "line" : 357,
      "node_id" : "PRRC_kwDOABII585J2lWy",
      "original_commit_id" : "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "original_line" : 357,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 21,
      "pull_request_review_id" : 1485181856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239045554/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T22:01:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239045554",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Would prefer to keep refactoring and bugfixes in separate PRs, if there's no reason they have to be together here?",
      "created_at" : "2023-06-24T01:14:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1605210547",
      "id" : 1605210547,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585frZGz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1605210547/reactions"
      },
      "updated_at" : "2023-06-24T01:14:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1605210547",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Would prefer to keep refactoring and bugfixes in separate PRs, if there's no reason they have to be together here?\r\n\r\nIt's an internal bug and the only way to trigger it is to use #27596 and restart the node during background snapshot validation. The bug was introduced by code in 0fd599a51a700c028d6f7ed8067d2d9f6e6a04a5 which was basically untested and broken, and the bug is fixed by c21624c14b83e30f32d5f8c653b3e64235625780 which depends on the earlier refactoring. Some more details about it are in https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071e\r\n\r\nThere's no good way to fix the bug without doing refactoring first, and probably no benefit to moving the bugfix to separate PR based on a refactoring PR, especially since the bug is internal and can't actually be triggered without modifying current code.\r\n",
      "created_at" : "2023-06-24T03:09:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1605245391",
      "id" : 1605245391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585frhnP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1605245391/reactions"
      },
      "updated_at" : "2023-06-24T03:09:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1605245391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243705025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243705025"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It doesn't seem necessary to me, because the block arrival information is something that seems unrelated to setting up a chainstate (and I don't see why it would need to be reset in the event of a chainstate activation).\r\n\r\nI think if we need to reset the counters it would be for tests, which is the only place outside of `init.cpp` where we use this...  I thought I addressed adding `ResetBlockSequenceCounters()` where it was necessary, but I should look at that again to see if I missed a case.",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-27T13:06:52Z",
      "diff_hunk" : "@@ -221,7 +221,7 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n \n         // A reload of the block index is required to recompute setBlockIndexCandidates\n         // for the fully validated chainstate.\n-        chainman.ActiveChainstate().UnloadBlockIndex();\n+        chainman.ActiveChainstate().ClearBlockIndexCandidates();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243705025",
      "id" : 1243705025,
      "in_reply_to_id" : 1237406346,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII585KIW7B",
      "original_commit_id" : "96cd3b06357c08a894d43e45acc456e4f0350e09",
      "original_line" : 224,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 5,
      "pull_request_review_id" : 1500819150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243705025/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T13:06:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243705025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243732248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243732248"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea -- and it looks like my code here is wrong anyway, because if we're a disabled background chainstate, then we'll be adding blocks to setBlockIndexCandidates as long as they have more work than the tip!",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-27T13:22:12Z",
      "diff_hunk" : "@@ -3414,7 +3414,17 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        // The active chainstate should always add entries that have more work than the tip.\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base.\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243732248",
      "id" : 1243732248,
      "in_reply_to_id" : 1230085759,
      "line" : 3413,
      "node_id" : "PRRC_kwDOABII585KIdkY",
      "original_commit_id" : "e08dc8c14fc9dbd97db46482052ecb8d4163cfc2",
      "original_line" : 3412,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 52,
      "pull_request_review_id" : 1500862619,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243732248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T13:22:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243732248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243773140"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243773140"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah my thought was that this notification wasn't something that made sense for the background chain -- the existing UI notifications for should be oblivious to background validation (and if we want to change that then we likely need new functionality/a new interface for whatever notifications we want to set up).",
      "commit_id" : "4a699011048e88099545a612075b5483ff55f533",
      "created_at" : "2023-06-27T13:46:08Z",
      "diff_hunk" : "@@ -4614,13 +4628,13 @@ void Chainstate::LoadExternalBlockFile(\n                     // called by concurrent network message processing. but, that is not\n                     // reliable for the purpose of pruning while importing.\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, pblock)) {\n+                    if (!ActiveChainstate().ActivateBestChain(state, pblock)) {\n                         LogPrint(BCLog::REINDEX, \"failed to activate chain (%s)\\n\", state.ToString());\n                         break;\n                     }\n                 }\n \n-                NotifyHeaderTip(*this);\n+                NotifyHeaderTip(ActiveChainstate());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243773140",
      "id" : 1243773140,
      "in_reply_to_id" : 1237552792,
      "line" : 4604,
      "node_id" : "PRRC_kwDOABII585KInjU",
      "original_commit_id" : "943bd665e2523e5cd483aa2a77a511b967dee509",
      "original_line" : 4637,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 464,
      "pull_request_review_id" : 1500920535,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243773140/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T13:46:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243773140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244021660"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244021660"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed, done.",
      "commit_id" : "d4d5dc4ff05e8890649e7145d58a9487d4a36b1a",
      "created_at" : "2023-06-27T16:21:08Z",
      "diff_hunk" : "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveChain().Tip() ? pindex->nChainWork >= ActiveChain().Tip()->nChainWork : true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244021660",
      "id" : 1244021660,
      "in_reply_to_id" : 1237491817,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KJkOc",
      "original_commit_id" : "943bd665e2523e5cd483aa2a77a511b967dee509",
      "original_line" : 3925,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1501387488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244021660/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T16:21:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244021660",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244022042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244022042"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "d4d5dc4ff05e8890649e7145d58a9487d4a36b1a",
      "created_at" : "2023-06-27T16:21:28Z",
      "diff_hunk" : "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveChain().Tip() ? pindex->nChainWork >= ActiveChain().Tip()->nChainWork : true);\n     // Blocks that are too out-of-order needlessly limit the effectiveness of\n     // pruning, because pruning will not delete block files that contain any\n     // blocks which are too close in height to the tip.  Apply this test\n     // regardless of whether pruning is enabled; it should generally be safe to\n     // not process unrequested blocks.\n-    bool fTooFarAhead{pindex->nHeight > m_chain.Height() + int(MIN_BLOCKS_TO_KEEP)};\n+    bool fTooFarAhead{pindex->nHeight > ActiveChain().Height() + int(MIN_BLOCKS_TO_KEEP)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244022042",
      "id" : 1244022042,
      "in_reply_to_id" : 1237494340,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KJkUa",
      "original_commit_id" : "943bd665e2523e5cd483aa2a77a511b967dee509",
      "original_line" : 3931,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1501388043,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244022042/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T16:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244022042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244023980"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244023980"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done (combined with taking @ryanofsky's approach for caching this value).",
      "commit_id" : "d4d5dc4ff05e8890649e7145d58a9487d4a36b1a",
      "created_at" : "2023-06-27T16:23:01Z",
      "diff_hunk" : "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;\n+        if (!is_bg_chainstate) {\n+            // The active chainstate should always add entries that have more\n+            // work than the tip.\n+            setBlockIndexCandidates.insert(pindex);\n+        } else {\n+            // For the background chainstate, we only consider connecting blocks\n+            // towards the snapshot base (which can't be nullptr or else we'll\n+            // never make progress).\n+            const CBlockIndex* snapshot_entry = m_chainman.GetSnapshotBaseBlock();\n+            assert(snapshot_entry != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244023980",
      "id" : 1244023980,
      "in_reply_to_id" : 1237583806,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KJkys",
      "original_commit_id" : "55e27ee995944d188d7453c6e78a6538f6739d64",
      "original_line" : 3422,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1501390684,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244023980/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T16:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244023980",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244024243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244024243"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed, gone now.",
      "commit_id" : "d4d5dc4ff05e8890649e7145d58a9487d4a36b1a",
      "created_at" : "2023-06-27T16:23:13Z",
      "diff_hunk" : "@@ -1047,6 +1047,12 @@ class ChainstateManager\n     //!          that a background validation chainstate is also in use.\n     bool IsSnapshotActive() const;\n \n+    //! @returns true if the chainstate is the background chainstate\n+    bool IsBackgroundChainstate(const Chainstate *chainstate) const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return chainstate == m_ibd_chainstate.get();\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244024243",
      "id" : 1244024243,
      "in_reply_to_id" : 1237586189,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KJk2z",
      "original_commit_id" : "55e27ee995944d188d7453c6e78a6538f6739d64",
      "original_line" : 1054,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1501391048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244024243/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T16:23:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244024243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244025126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244025126"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you explain a bit more what you have in mind for rewriting this function?  Not sure I follow but happy to try to make this more readable/less error-prone.",
      "commit_id" : "d4d5dc4ff05e8890649e7145d58a9487d4a36b1a",
      "created_at" : "2023-06-27T16:23:55Z",
      "diff_hunk" : "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244025126",
      "id" : 1244025126,
      "in_reply_to_id" : 1233368008,
      "line" : 3419,
      "node_id" : "PRRC_kwDOABII585KJlEm",
      "original_commit_id" : "55e27ee995944d188d7453c6e78a6538f6739d64",
      "original_line" : 3419,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 65,
      "pull_request_review_id" : 1501392246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244025126/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T16:23:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244025126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244025319"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244025319"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "d4d5dc4ff05e8890649e7145d58a9487d4a36b1a",
      "created_at" : "2023-06-27T16:24:02Z",
      "diff_hunk" : "@@ -126,6 +126,19 @@ class BlockManager\n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n     int m_last_blockfile = 0;\n+\n+    // Track the height of the highest block in m_last_blockfile whose undo\n+    // data has been written. Block data is written to block files in download\n+    // order, but is written to undo files in validation order, which is\n+    // usually in order by height. To avoid wasting disk space, undo files will\n+    // be will trimmed whenever the corresponding block file is finalized and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244025319",
      "id" : 1244025319,
      "in_reply_to_id" : 1238721079,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KJlHn",
      "original_commit_id" : "3fe223c36f9320f89af0eb31dabf55609bf2a0c7",
      "original_line" : 134,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1501392459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244025319/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T16:24:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244025319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244026109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244026109"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "d4d5dc4ff05e8890649e7145d58a9487d4a36b1a",
      "created_at" : "2023-06-27T16:24:41Z",
      "diff_hunk" : "@@ -77,6 +77,13 @@ BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n     // After adding some blocks to the tip, best block should have changed.\n     BOOST_CHECK(::g_best_block != curr_tip);\n \n+    // Grab block 1 from disk; we'll add it back to the background chain later.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244026109",
      "id" : 1244026109,
      "in_reply_to_id" : 1239034939,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KJlT9",
      "original_commit_id" : "55e27ee995944d188d7453c6e78a6538f6739d64",
      "original_line" : 80,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1501393654,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244026109/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T16:24:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244026109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks all for the additional review.  I've updated based on feedback and cleaned up the commit history.\r\n\r\n> would make sense but if we are gonna pass ChainstateManager to static functions, then I think we should avoid reaching into its internals and use the available interfaces or define new ones. I left a couple comments about this inline.\r\n\r\n> It might also be better to do this in a separate PR and stick to the assumeutxo related improvements in this one. There are likely a lot more interface related cleanups/improvements to be made around Chainstate and ChainstateManager that would benefit from isolated review.\r\n\r\n@dergoegge I think I agree that this code movement would make sense in its own PR, so I decided to drop the movement of AcceptBlock out of ChainstateManager (and so therefore also ended up not taking the other changes you suggested about cleaning up the CSM interface, though I agree with you that those changes would make sense as well once AcceptBlock is moved out). \r\n\r\n@jamesob I think your comment here (https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237579876) highlighted a bug in the code; if the background chainstate was disabled then we'd add entries to setBlockIndexCandidates that we shouldn't.  I think this is fixed now!\r\n\r\n@fjahr Thanks for the review, I took a couple of the fixes, and just had a question about one of the suggestions.\r\n\r\n",
      "created_at" : "2023-06-27T16:25:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1609852620",
      "id" : 1609852620,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585f9GbM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1609852620/reactions"
      },
      "updated_at" : "2023-06-27T16:25:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1609852620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244027946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244027946"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No longer relevant now that AcceptBlock is staying in CSM.",
      "commit_id" : "d4d5dc4ff05e8890649e7145d58a9487d4a36b1a",
      "created_at" : "2023-06-27T16:26:00Z",
      "diff_hunk" : "@@ -337,9 +337,46 @@ class CScriptCheck\n /** Context-independent validity checks */\n bool CheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n \n+/**\n+ * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\n+ * that it doesn't descend from an invalid block, and then add it to m_block_index.\n+ * Caller must set min_pow_checked=true in order to add a new header to the\n+ * block index (permanent memory storage), indicating that the header is\n+ * known to be part of a sufficiently high-work chain (anti-dos check).\n+ */\n+bool AcceptBlockHeader(\n+    const CBlockHeader& block,\n+    ChainstateManager& chaiman,\n+    BlockValidationState& state,\n+    CBlockIndex** ppindex,\n+    bool min_pow_checked) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+/**\n+ * Sufficiently validate a block for disk storage (and store on disk).\n+ *\n+ * @param[in]   pblock          The block we want to process.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244027946",
      "id" : 1244027946,
      "in_reply_to_id" : 1239045554,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KJlwq",
      "original_commit_id" : "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "original_line" : 357,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1501396073,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244027946/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T16:26:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244027946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244028312"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244028312"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No longer relevant now that AcceptBlock/AcceptBlockHeader are staying in CSM.",
      "commit_id" : "d4d5dc4ff05e8890649e7145d58a9487d4a36b1a",
      "created_at" : "2023-06-27T16:26:18Z",
      "diff_hunk" : "@@ -337,9 +337,46 @@ class CScriptCheck\n /** Context-independent validity checks */\n bool CheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n \n+/**\n+ * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\n+ * that it doesn't descend from an invalid block, and then add it to m_block_index.\n+ * Caller must set min_pow_checked=true in order to add a new header to the\n+ * block index (permanent memory storage), indicating that the header is\n+ * known to be part of a sufficiently high-work chain (anti-dos check).\n+ */\n+bool AcceptBlockHeader(\n+    const CBlockHeader& block,\n+    ChainstateManager& chaiman,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244028312",
      "id" : 1244028312,
      "in_reply_to_id" : 1239044564,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KJl2Y",
      "original_commit_id" : "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "original_line" : 349,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1501396527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244028312/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T16:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244028312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244328552"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244328552"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is what I had in mind: https://github.com/fjahr/bitcoin/commit/e26c89251b9fc2ae24c2c7ff90b8fd5490335ee5",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-06-27T20:42:59Z",
      "diff_hunk" : "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244328552",
      "id" : 1244328552,
      "in_reply_to_id" : 1233368008,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KKvJo",
      "original_commit_id" : "55e27ee995944d188d7453c6e78a6538f6739d64",
      "original_line" : 3419,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1501811866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244328552/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-27T20:43:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244328552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246740699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246740699"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (0dbc5805ca4371b7621bee0b7a553dac1a481614)\r\n\r\nIt would be nice to have a documentation comment for this function saying what it is for, especially since it is only called in a test. If the counter values are basically arbitrary and only used for ordering, I'm not sure why if they actually ever need to be reset, or if that's just a nice thing to do?",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-06-29T14:56:55Z",
      "diff_hunk" : "@@ -981,6 +970,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246740699",
      "id" : 1246740699,
      "line" : 962,
      "node_id" : "PRRC_kwDOABII585KT8Db",
      "original_commit_id" : "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "original_line" : 984,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 153,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246740699/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246740699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246753697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246753697"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (0dbc5805ca4371b7621bee0b7a553dac1a481614)\r\n\r\nIIUC removing this line is not a change in behavior because the `nBlockSequenceId` variable was never used again after the `UnloadBlockIndex` call, outside of tests. Now there is new `ResetBlockSequenceCounters` function that tests can use to reset it separately. EDIT: Another review comment https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243705025 also seems to say resetting nBlockSequenceId is unnecessary outside of tests\r\n\r\nIt might be good to say explicitly in commit message that this commit is supposed to be a refactoring which does not change behavior.",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-06-29T15:06:21Z",
      "diff_hunk" : "@@ -4367,10 +4367,9 @@ bool Chainstate::NeedsRedownload() const\n     return false;\n }\n \n-void Chainstate::UnloadBlockIndex()\n+void Chainstate::ClearBlockIndexCandidates()\n {\n     AssertLockHeld(::cs_main);\n-    nBlockSequenceId = 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246753697",
      "id" : 1246753697,
      "line" : 4373,
      "node_id" : "PRRC_kwDOABII585KT_Oh",
      "original_commit_id" : "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "original_line" : 4373,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 220,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246753697/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246753697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246815739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246815739"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: Clear block index flags when testing snapshots\" (e8168cd56c490609f59e1dc89add58b1be18b516)\r\n\r\nThis seems like a good change that makes test setup more realistic, but the could the commit message be updated to say what is motivating this change? Is it just for realism, or will a future change, or a certain kind of test depend on it?",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-06-29T15:40:53Z",
      "diff_hunk" : "@@ -83,6 +84,18 @@ CreateAndActivateUTXOSnapshot(\n             chain.setBlockIndexCandidates.insert(node.chainman->m_blockman.LookupBlockIndex(gen_hash));\n             chain.LoadChainTip();\n             node.chainman->MaybeRebalanceCaches();\n+\n+            // Reset the HAVE_DATA flags below the snapshot height, simulating",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246815739",
      "id" : 1246815739,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII585KUOX7",
      "original_commit_id" : "e8168cd56c490609f59e1dc89add58b1be18b516",
      "original_line" : 88,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 13,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246815739/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246815739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246822305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246822305"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: Clear block index flags when testing snapshots\" (e8168cd56c490609f59e1dc89add58b1be18b516)\r\n\r\nAdding `BLOCK_ASSUMED_VALID` here seems surprising since I would expect `ActivateSnapshot` below to be setting `BLOCK_ASSUMED_VALID`, and comment above doesn't mention this flag. I think it would be good to drop this line or add a comment explaining why it is necessary.",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-06-29T15:46:07Z",
      "diff_hunk" : "@@ -83,6 +84,18 @@ CreateAndActivateUTXOSnapshot(\n             chain.setBlockIndexCandidates.insert(node.chainman->m_blockman.LookupBlockIndex(gen_hash));\n             chain.LoadChainTip();\n             node.chainman->MaybeRebalanceCaches();\n+\n+            // Reset the HAVE_DATA flags below the snapshot height, simulating\n+            // never-having-downloaded them in the first place.\n+            // TODO: perhaps we could improve this by using pruning to delete\n+            // these blocks instead\n+            CBlockIndex *pindex = orig_tip;\n+            while (pindex && pindex != chain.m_chain.Tip()) {\n+                pindex->nStatus &= ~BLOCK_HAVE_DATA;\n+                pindex->nStatus &= ~BLOCK_HAVE_UNDO;\n+                pindex->nStatus |= BLOCK_ASSUMED_VALID;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246822305",
      "id" : 1246822305,
      "line" : 96,
      "node_id" : "PRRC_kwDOABII585KUP-h",
      "original_commit_id" : "e8168cd56c490609f59e1dc89add58b1be18b516",
      "original_line" : 96,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 21,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246822305/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246822305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246833752"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246833752"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (0dbc5805ca4371b7621bee0b7a553dac1a481614)\r\n\r\nThe test seems to pass without this line, at least in this commit.\r\n\r\nIf this is needed for a future change, would be good to say that in commit message. Or if this is just done for completeness would be good to say that in a code comment.",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-06-29T15:54:07Z",
      "diff_hunk" : "@@ -431,9 +431,10 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n     CBlockIndex* assumed_tip{WITH_LOCK(chainman.GetMutex(), return chainman.ActiveChain().Tip())};\n \n     auto reload_all_block_indexes = [&]() {\n+        WITH_LOCK(::cs_main, return chainman.ResetBlockSequenceCounters());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246833752",
      "id" : 1246833752,
      "line" : 430,
      "node_id" : "PRRC_kwDOABII585KUSxY",
      "original_commit_id" : "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "original_line" : 434,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 101,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246833752/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246833752",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246842096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246842096"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nNotes: It seems logical to call `GetAll` here for all chainstates and let the `TryAddBlockIndexCandidate` and `FindMostWorkChain` functions figure out how to use the block and which chain to attach it to.\r\n\r\nThere is a change in behavior here if there are multiple chainstates, because previously this would only add blocks to `setBlockIndexCandidates` for the active chain, and now it will add all blocks with enough work to `setBlockIndexCandidates` for active and background chains.\r\n\r\nI think this means it will now add blocks above the snapshot height to the background chainstate, which [`ChainstateManager::LoadBlockIndex`](https://github.com/bitcoin/bitcoin/blob/600c595b8d2f4bf049b9182d4a0aa88e4b34458d/src/validation.cpp#L4421-L4446) was trying to avoid. This is inefficient, but not really a problem because [`Chainstate::FindMostWorkChain`](https://github.com/bitcoin/bitcoin/blob/600c595b8d2f4bf049b9182d4a0aa88e4b34458d/src/validation.cpp#L2880) will ignore and remove the blocks when it finds their ancestors have missing data. \r\n\r\nFollowup commit f18ab9ee7deb92c25bdc68a5c4bef973f5e995f0 \"Tighten requirements for adding elements to setBlockIndexCandidates\" will make this more efficient by not adding these blocks to `setBlockIndexCandidates`\r\n",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-06-29T16:00:03Z",
      "diff_hunk" : "@@ -3439,8 +3439,10 @@ void Chainstate::ReceivedBlockTransactions(const CBlock& block, CBlockIndex* pin\n             CBlockIndex *pindex = queue.front();\n             queue.pop_front();\n             pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n-            pindex->nSequenceId = m_chainman.nBlockSequenceId++;\n-            TryAddBlockIndexCandidate(pindex);\n+            pindex->nSequenceId = nBlockSequenceId++;\n+            for (Chainstate *c : GetAll()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246842096",
      "id" : 1246842096,
      "line" : 3466,
      "node_id" : "PRRC_kwDOABII585KUUzw",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 3443,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 106,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246842096/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:53:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246842096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246844224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246844224"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nNote: This change to the `CheckBlockIndex()` call is temporary and will revert back in later commit fb9c405506d6cfb6896e21b79789d7b6e638f6f2 \"Move CheckBlockIndex() from Chainstate to ChainstateManager\" when it becomes a `ChainstateManager` method.\r\n\r\nThere is not a change in behavior here in this commit, because in both places where\r\n`Chainstate::AcceptBlock` was called previously (in `ProcessNewBlock` and `LoadExternalBlockFile`), it was only called on the active chainstate.",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-06-29T16:02:03Z",
      "diff_hunk" : "@@ -3910,8 +3912,8 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     CBlockIndex *pindexDummy = nullptr;\n     CBlockIndex *&pindex = ppindex ? *ppindex : pindexDummy;\n \n-    bool accepted_header{m_chainman.AcceptBlockHeader(block, state, &pindex, min_pow_checked)};\n-    CheckBlockIndex();\n+    bool accepted_header{AcceptBlockHeader(block, state, &pindex, min_pow_checked)};\n+    ActiveChainstate().CheckBlockIndex();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246844224",
      "id" : 1246844224,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KUVVA",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 3916,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246844224/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:52:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246844224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246868905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246868905"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nDo you think it would be good if the `IsInitialBlockDownload` method were moved to `ChainstateManager`. Is there any place it should be actually called on the background chainstate rather than the active chainstate? Could add a TODO comment if IsInitialBlockDownload method should move like other methods are moving.",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-06-29T16:25:50Z",
      "diff_hunk" : "@@ -3962,7 +3964,7 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n     // (but if it does not build on our best tip, let the SendMessages loop relay it)\n-    if (!IsInitialBlockDownload() && m_chain.Tip() == pindex->pprev)\n+    if (!ActiveChainstate().IsInitialBlockDownload() && ActiveTip() == pindex->pprev)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246868905",
      "id" : 1246868905,
      "line" : 3990,
      "node_id" : "PRRC_kwDOABII585KUbWp",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 3967,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 176,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246868905/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:52:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246868905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246903052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246903052"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (c2bc5cfd9977838af334844675d77090fe9c3c74)\r\n\r\nCan add a comment here explaining the logic? I guess the `pindex == GetSnapshotBaseBlock()` case needs to be a special case because the snapshot block may not have transactions?\r\n\r\nMaybe also would be more efficient to call `ActiveSnapshotBase` instead of `GetSnapshotBaseBlock` here. I think I would move the commit introducing the `ActiveSnapshotBase` method earlier, so it's also not necessary to replace `GetSnapshotBaseBlock` with `ActiveSnapshotBase` in later commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (ddb77d838c4cd7a4776c5ec70d96331fc8137900)\r\n",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-06-29T16:57:26Z",
      "diff_hunk" : "@@ -4417,62 +4417,14 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (ShutdownRequested()) return false;\n-            if (pindex->IsAssumedValid() ||\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246903052",
      "id" : 1246903052,
      "line" : 4432,
      "node_id" : "PRRC_kwDOABII585KUjsM",
      "original_commit_id" : "c2bc5cfd9977838af334844675d77090fe9c3c74",
      "original_line" : 4432,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 253,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246903052/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:52:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246903052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1248935619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1248935619"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks!  I've incorporated that here.",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-07-01T19:21:39Z",
      "diff_hunk" : "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1248935619",
      "id" : 1248935619,
      "in_reply_to_id" : 1233368008,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KcT7D",
      "original_commit_id" : "55e27ee995944d188d7453c6e78a6538f6739d64",
      "original_line" : 3419,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1508881991,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1248935619/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-01T19:21:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1248935619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251222347"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251222347"
         }
      },
      "author_association" : "MEMBER",
      "body" : "4a9f0dae7ff64ba2c2f1eb1b44d0ca563726b776\r\n\r\nNit: feel like it may have been okay to leave in the previous assertion too (although this is sorted of indirectly tested by the `expected_assumed_valid` comparison). No need to change.\r\n\r\n```diff\r\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\r\nindex a936a96577..f0ed54a521 100644\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -464,6 +464,8 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n         if (i == last_assumed_valid_idx - 1) {\r\n             assumed_base = index;\r\n             BOOST_CHECK(index->IsAssumedValid());\r\n+        } else if (i == last_assumed_valid_idx) {\r\n+            BOOST_CHECK(!index->IsAssumedValid());\r\n         }\r\n     }\r\n```",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-07-03T19:33:59Z",
      "diff_hunk" : "@@ -459,15 +460,16 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n-            BOOST_CHECK(!index->IsAssumedValid());\n+            BOOST_CHECK(index->IsAssumedValid());\n         }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251222347",
      "id" : 1251222347,
      "line" : 467,
      "node_id" : "PRRC_kwDOABII585KlCNL",
      "original_commit_id" : "4a9f0dae7ff64ba2c2f1eb1b44d0ca563726b776",
      "original_line" : 467,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 138,
      "pull_request_review_id" : 1511690655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251222347/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T20:34:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251222347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251271660"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251271660"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Now `ChainstateManager` has `ActiveSnapshotBase()` and `GetSnapshotBaseBlock()` which, as far as I understand it, do the same thing except for the caching.\r\nWould it have been possible to add the caching to the existing `GetSnapshotBaseBlock()` instead?",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-07-03T20:47:02Z",
      "diff_hunk" : "@@ -1055,6 +1065,11 @@ class ChainstateManager\n         return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;\n     }\n \n+    const CBlockIndex* ActiveSnapshotBase() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251271660",
      "id" : 1251271660,
      "line" : 1068,
      "node_id" : "PRRC_kwDOABII585KlOPs",
      "original_commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "original_line" : 1068,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 168,
      "pull_request_review_id" : 1511762976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251271660/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:23:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251271660",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251271941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251271941"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nIt seems like `fHasMoreOrSameWork` will always be false for blocks that were downloaded to be added to the background chain, because they will have less work than the active snapshot chain.\r\n\r\nIs that intentional? It would helpful to have a comment here either that either explains why this ok, or adds a TODO indicating that there will be some change later.\r\n\r\nI do understand there is not a change in behavior here in this commit because in both places where\r\n`Chainstate::AcceptBlock` was called previously (in `ProcessNewBlock` and `LoadExternalBlockFile`), it was only called on the active chainstate, so it is still only looking at the active chainstate now.",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-07-03T20:47:30Z",
      "diff_hunk" : "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveTip() ? pindex->nChainWork >= ActiveTip()->nChainWork : true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251271941",
      "id" : 1251271941,
      "line" : 3948,
      "node_id" : "PRRC_kwDOABII585KlOUF",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 3925,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 143,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251271941/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:52:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251271941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251282221"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251282221"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nNote: It seems fine to drop this assert, because the only code that is using this mutex is the `ActivateBestChain` function called below, and `ActivateBestChain` already has this same assert at the top of the function.",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-07-03T21:08:52Z",
      "diff_hunk" : "@@ -4495,26 +4504,24 @@ bool Chainstate::LoadGenesisBlock()\n             return error(\"%s: writing genesis block to disk failed\", __func__);\n         }\n         CBlockIndex* pindex = m_blockman.AddToBlockIndex(block, m_chainman.m_best_header);\n-        ReceivedBlockTransactions(block, pindex, blockPos);\n+        m_chainman.ReceivedBlockTransactions(block, pindex, blockPos);\n     } catch (const std::runtime_error& e) {\n         return error(\"%s: failed to write genesis block: %s\", __func__, e.what());\n     }\n \n     return true;\n }\n \n-void Chainstate::LoadExternalBlockFile(\n+void ChainstateManager::LoadExternalBlockFile(\n     FILE* fileIn,\n     FlatFilePos* dbp,\n     std::multimap<uint256, FlatFilePos>* blocks_with_unknown_parent)\n {\n-    AssertLockNotHeld(m_chainstate_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251282221",
      "id" : 1251282221,
      "line" : 4505,
      "node_id" : "PRRC_kwDOABII585KlQ0t",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 4511,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 314,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251282221/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:52:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251282221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251283534"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251283534"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nI think it would be a little clearer to move the `BlockValidationState state;` variable declaration down into the `for` loop so it is obvious the variable is ignored and not used to share state between `ActivateBestChain` calls",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-07-03T21:11:47Z",
      "diff_hunk" : "@@ -4600,7 +4607,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {\n+                        if (!c->ActivateBestChain(state, nullptr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251283534",
      "id" : 1251283534,
      "line" : 4587,
      "node_id" : "PRRC_kwDOABII585KlRJO",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 4612,
      "original_position" : 158,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 332,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251283534/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:52:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251283534",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251289117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251289117"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896) in `LoadExternalBlockFile`:\r\n\r\nIt seems inconsistent to call `ActivateBestChain` on _all_ chainstates here for the genesis block, but only call `ActivateBestChain` on the _active_ chainstate a few lines below (line 4631).\r\n\r\nI think I can understand the reasons from the discussion above (\"we're adding blocks that theoretically could be of interest to either chainstate; so I think it makes sense to separate the block storage and import from any particular chainstate\") and from pruning context below. But in both cases I think the code would be clearer if there were explicit comments saying why `ActiveChainstate()` is used and why `GetAll()` is used in each place.\r\n\r\n",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-07-03T21:23:35Z",
      "diff_hunk" : "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251289117",
      "id" : 1251289117,
      "in_reply_to_id" : 1212186629,
      "line" : 4586,
      "node_id" : "PRRC_kwDOABII585KlSgd",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 4586,
      "original_position" : 206,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 331,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251289117/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:52:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251289117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251292140"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251292140"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nIt seems like `NotifyHeaderTip` is a \"block-storage-related\" function just like other functions that are moving from `Chainstate` to `ChainstateManager` so it would be cleaner if  `NotifyHeaderTip` took a `ChainstateManager` argument instead of a `Chainstate` one, and if it called `ActiveChainstate()` internally so `NotifyHeaderTip` callers don't have to consider how the UI reflects background validation.\r\n",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-07-03T21:30:58Z",
      "diff_hunk" : "@@ -4614,13 +4628,13 @@ void Chainstate::LoadExternalBlockFile(\n                     // called by concurrent network message processing. but, that is not\n                     // reliable for the purpose of pruning while importing.\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, pblock)) {\n+                    if (!ActiveChainstate().ActivateBestChain(state, pblock)) {\n                         LogPrint(BCLog::REINDEX, \"failed to activate chain (%s)\\n\", state.ToString());\n                         break;\n                     }\n                 }\n \n-                NotifyHeaderTip(*this);\n+                NotifyHeaderTip(ActiveChainstate());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251292140",
      "id" : 1251292140,
      "in_reply_to_id" : 1237552792,
      "line" : 4612,
      "node_id" : "PRRC_kwDOABII585KlTPs",
      "original_commit_id" : "943bd665e2523e5cd483aa2a77a511b967dee509",
      "original_line" : 4612,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 353,
      "pull_request_review_id" : 1505486978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251292140/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-03T21:52:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251292140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1252074194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252074194"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I must either be missing something about this line or it might be unnecessary. If I understand correctly this is updating `m_undo_height_in_last_blockfile` when the next block is connected after the flush happened. However, why not update it right away when the flush happens? I tried that by removing this line it seems like all tests are still passing without it.",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-07-04T14:05:35Z",
      "diff_hunk" : "@@ -734,8 +735,9 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // the FindBlockPos function\n         if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n             FlushUndoFile(_pos.nFile, true);\n+        } else if (_pos.nFile == m_last_blockfile && static_cast<uint32_t>(block.nHeight) > m_undo_height_in_last_blockfile) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1252074194",
      "id" : 1252074194,
      "line" : 738,
      "node_id" : "PRRC_kwDOABII585KoSLS",
      "original_commit_id" : "ad8b21dfe3176691211d7979c3b374447d3a561d",
      "original_line" : 738,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 30,
      "pull_request_review_id" : 1512960883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252074194/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-04T16:19:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252074194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1252331248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252331248"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I must either be missing something about this line or it might be unnecessary. If I understand correctly this is updating `m_undo_height_in_last_blockfile` when the next block is connected after the flush happened. However, why not update it right away when the flush happens? I tried that by removing this line it seems like all tests are still passing without it.\r\n\r\nIt's not surprising that there's no test coverage for this. But to explain: the goal of the code is to flush the undo file when the height of the highest block in the undo file equals the height of the highest block in the corresponding block file. There are two cases where this can happen. The first case is on line 633 above, where the undo file and block file are flushed together because the undo data is not far behind the block data. The second case is on line 737 above when undo data is delayed and undo file gets flushed after the block file. The `m_undo_height_in_last_blockfile` needs to be set here so the `m_blockfile_info[nFile].nHeightLast == m_undo_height_in_last_blockfile` check in the first case line 633 can work.",
      "commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "created_at" : "2023-07-04T20:17:00Z",
      "diff_hunk" : "@@ -734,8 +735,9 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // the FindBlockPos function\n         if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n             FlushUndoFile(_pos.nFile, true);\n+        } else if (_pos.nFile == m_last_blockfile && static_cast<uint32_t>(block.nHeight) > m_undo_height_in_last_blockfile) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1252331248",
      "id" : 1252331248,
      "in_reply_to_id" : 1252074194,
      "line" : 738,
      "node_id" : "PRRC_kwDOABII585KpQ7w",
      "original_commit_id" : "ad8b21dfe3176691211d7979c3b374447d3a561d",
      "original_line" : 738,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 30,
      "pull_request_review_id" : 1513367979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252331248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-04T20:17:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252331248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1254538118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254538118"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@mzumsande Yep, I don't see any reason that couldn't be done.",
      "commit_id" : "d29ff1e38baf54e4f8eaa8e86eec54b52268e85f",
      "created_at" : "2023-07-06T14:37:47Z",
      "diff_hunk" : "@@ -1055,6 +1065,11 @@ class ChainstateManager\n         return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;\n     }\n \n+    const CBlockIndex* ActiveSnapshotBase() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1254538118",
      "id" : 1254538118,
      "in_reply_to_id" : 1251271660,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KxruG",
      "original_commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "original_line" : 1074,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1516705680,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254538118/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-06T14:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254538118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-07-06T22:06:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1624370680",
      "id" : 1624370680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585g0e34",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1624370680/reactions"
      },
      "updated_at" : "2023-07-06T22:06:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1624370680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264177843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264177843"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "d29ff1e38baf54e4f8eaa8e86eec54b52268e85f",
      "created_at" : "2023-07-14T21:09:31Z",
      "diff_hunk" : "@@ -459,15 +460,16 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n-            BOOST_CHECK(!index->IsAssumedValid());\n+            BOOST_CHECK(index->IsAssumedValid());\n         }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264177843",
      "id" : 1264177843,
      "in_reply_to_id" : 1251222347,
      "line" : 474,
      "node_id" : "PRRC_kwDOABII585LWdKz",
      "original_commit_id" : "4a9f0dae7ff64ba2c2f1eb1b44d0ca563726b776",
      "original_line" : 474,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 143,
      "pull_request_review_id" : 1531050604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264177843/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-14T21:09:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264177843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264177911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264177911"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks!",
      "commit_id" : "d29ff1e38baf54e4f8eaa8e86eec54b52268e85f",
      "created_at" : "2023-07-14T21:09:39Z",
      "diff_hunk" : "@@ -1055,6 +1065,11 @@ class ChainstateManager\n         return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;\n     }\n \n+    const CBlockIndex* ActiveSnapshotBase() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264177911",
      "id" : 1264177911,
      "in_reply_to_id" : 1251271660,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LWdL3",
      "original_commit_id" : "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "original_line" : 1074,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1531050704,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264177911/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-14T21:09:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264177911",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264178108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178108"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's just a nice thing to do to ensure that all state is reset when the block index is cleared out and re-initialized; it might be surprising if state were leftover?  But I agree that it doesn't seem strictly necessary.  Added a comment to clarify.",
      "commit_id" : "d29ff1e38baf54e4f8eaa8e86eec54b52268e85f",
      "created_at" : "2023-07-14T21:09:59Z",
      "diff_hunk" : "@@ -981,6 +970,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264178108",
      "id" : 1264178108,
      "in_reply_to_id" : 1246740699,
      "line" : 973,
      "node_id" : "PRRC_kwDOABII585LWdO8",
      "original_commit_id" : "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "original_line" : 973,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 155,
      "pull_request_review_id" : 1531050946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178108/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-14T21:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264178256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178256"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Updated the commit message.",
      "commit_id" : "d29ff1e38baf54e4f8eaa8e86eec54b52268e85f",
      "created_at" : "2023-07-14T21:10:16Z",
      "diff_hunk" : "@@ -4367,10 +4367,9 @@ bool Chainstate::NeedsRedownload() const\n     return false;\n }\n \n-void Chainstate::UnloadBlockIndex()\n+void Chainstate::ClearBlockIndexCandidates()\n {\n     AssertLockHeld(::cs_main);\n-    nBlockSequenceId = 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264178256",
      "id" : 1264178256,
      "in_reply_to_id" : 1246753697,
      "line" : 4385,
      "node_id" : "PRRC_kwDOABII585LWdRQ",
      "original_commit_id" : "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "original_line" : 4385,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 223,
      "pull_request_review_id" : 1531051166,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178256/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-14T21:10:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178256",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264178307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd say mostly for realism.  My intuition for how this is designed is that if you don't reset the HAVE_DATA flags, then you'd immediately expect the background chain to process and validate all the blocks for which we HAVE_DATA and thus arrive at the original tip, as soon as you call ActivateBestChain().\r\n\r\nUpdated commit message.",
      "commit_id" : "d29ff1e38baf54e4f8eaa8e86eec54b52268e85f",
      "created_at" : "2023-07-14T21:10:23Z",
      "diff_hunk" : "@@ -83,6 +84,18 @@ CreateAndActivateUTXOSnapshot(\n             chain.setBlockIndexCandidates.insert(node.chainman->m_blockman.LookupBlockIndex(gen_hash));\n             chain.LoadChainTip();\n             node.chainman->MaybeRebalanceCaches();\n+\n+            // Reset the HAVE_DATA flags below the snapshot height, simulating",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264178307",
      "id" : 1264178307,
      "in_reply_to_id" : 1246815739,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII585LWdSD",
      "original_commit_id" : "e8168cd56c490609f59e1dc89add58b1be18b516",
      "original_line" : 88,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 13,
      "pull_request_review_id" : 1531051260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178307/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-14T21:11:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264179053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264179053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We need this due to the CheckBlockIndex() invariant that you can't have a block index entry with nTx > 0 and without HAVE_DATA unless you've either pruned or used ASSUMED_VALID.  Added a comment to clarify.",
      "commit_id" : "d29ff1e38baf54e4f8eaa8e86eec54b52268e85f",
      "created_at" : "2023-07-14T21:11:42Z",
      "diff_hunk" : "@@ -83,6 +84,18 @@ CreateAndActivateUTXOSnapshot(\n             chain.setBlockIndexCandidates.insert(node.chainman->m_blockman.LookupBlockIndex(gen_hash));\n             chain.LoadChainTip();\n             node.chainman->MaybeRebalanceCaches();\n+\n+            // Reset the HAVE_DATA flags below the snapshot height, simulating\n+            // never-having-downloaded them in the first place.\n+            // TODO: perhaps we could improve this by using pruning to delete\n+            // these blocks instead\n+            CBlockIndex *pindex = orig_tip;\n+            while (pindex && pindex != chain.m_chain.Tip()) {\n+                pindex->nStatus &= ~BLOCK_HAVE_DATA;\n+                pindex->nStatus &= ~BLOCK_HAVE_UNDO;\n+                pindex->nStatus |= BLOCK_ASSUMED_VALID;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264179053",
      "id" : 1264179053,
      "in_reply_to_id" : 1246822305,
      "line" : 100,
      "node_id" : "PRRC_kwDOABII585LWddt",
      "original_commit_id" : "e8168cd56c490609f59e1dc89add58b1be18b516",
      "original_line" : 100,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 25,
      "pull_request_review_id" : 1531052550,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264179053/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-14T21:11:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264179053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264179160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264179160"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment.",
      "commit_id" : "d29ff1e38baf54e4f8eaa8e86eec54b52268e85f",
      "created_at" : "2023-07-14T21:11:54Z",
      "diff_hunk" : "@@ -431,9 +431,10 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n     CBlockIndex* assumed_tip{WITH_LOCK(chainman.GetMutex(), return chainman.ActiveChain().Tip())};\n \n     auto reload_all_block_indexes = [&]() {\n+        WITH_LOCK(::cs_main, return chainman.ResetBlockSequenceCounters());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264179160",
      "id" : 1264179160,
      "in_reply_to_id" : 1246833752,
      "line" : 435,
      "node_id" : "PRRC_kwDOABII585LWdfY",
      "original_commit_id" : "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "original_line" : 435,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 104,
      "pull_request_review_id" : 1531052884,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264179160/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-14T21:11:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264179160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Initial commit-by-commit build/review looks good, will do a full review.",
      "created_at" : "2023-07-15T01:07:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1636603720",
      "id" : 1636603720,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585hjJdI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1636603720/reactions"
      },
      "updated_at" : "2023-07-15T01:07:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1636603720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265452083"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265452083"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I haven't done a careful review of all the places we use `IsInitialBlockDownload()` to confirm this, but my intuition would be that if we're using an assumeutxo snapshot, what we care about is whether our snapshot-based chainstate is caught up or not -- basically by definition, the background chainstate will always be \"in initial block download\" until it finishes and is no longer in use, so it wouldn't make sense to condition anything on whether it's behind or not.\r\n\r\nSo yeah I think moving this to ChainstateManager would probably make sense...",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-17T14:27:40Z",
      "diff_hunk" : "@@ -3962,7 +3964,7 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n     // (but if it does not build on our best tip, let the SendMessages loop relay it)\n-    if (!IsInitialBlockDownload() && m_chain.Tip() == pindex->pprev)\n+    if (!ActiveChainstate().IsInitialBlockDownload() && ActiveTip() == pindex->pprev)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265452083",
      "id" : 1265452083,
      "in_reply_to_id" : 1246868905,
      "line" : 4002,
      "node_id" : "PRRC_kwDOABII585LbUQz",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 4002,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 176,
      "pull_request_review_id" : 1532940105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265452083/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T14:27:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265452083",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265477633"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265477633"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We may not have received the snapshot base block, and it's only when we call `ReceivedBlockTransactions` on a block that we set VALID_TRANSACTIONS on the block index entry.  So the snapshot base block may not otherwise be considered a block index candidate, but the snapshot base block could be the tip of the snapshot chain so we need to be able to call `TryAddBlockIndexCandidate()`.  \r\n\r\nI'll push an update that adds a comment explaining this.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-17T14:44:35Z",
      "diff_hunk" : "@@ -4417,62 +4417,14 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (ShutdownRequested()) return false;\n-            if (pindex->IsAssumedValid() ||\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265477633",
      "id" : 1265477633,
      "in_reply_to_id" : 1246903052,
      "line" : 4449,
      "node_id" : "PRRC_kwDOABII585LbagB",
      "original_commit_id" : "c2bc5cfd9977838af334844675d77090fe9c3c74",
      "original_line" : 4449,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 261,
      "pull_request_review_id" : 1532979663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265477633/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T14:44:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265477633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265513530"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265513530"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The idea here is that this check is part of a heuristic that we use when we receive a block that was not requested.  For anti-DoS reasons, back in #5875 we introduced logic to generally not process unrequested blocks, but we left in an optimization that was intended to not throw away blocks that would immediately advance our tip, in case we had some peer (like Matt's old fast-relay-network, if I remember right) that was sending such blocks (see eg comment here https://github.com/bitcoin/bitcoin/pull/5875#issuecomment-86743016).\r\n\r\nMy view is that we don't need to process unrequested blocks in general, and that if we do so it's just an optimization to make block relay at the tip work better.  We could probably add special-case logic to allow processing of unrequested blocks that we haven't yet validated that are ancestors of the ancestor block, but this doesn't strike me as something that is at all necessary (and perhaps not desirable?).",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-17T15:08:06Z",
      "diff_hunk" : "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveTip() ? pindex->nChainWork >= ActiveTip()->nChainWork : true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265513530",
      "id" : 1265513530,
      "in_reply_to_id" : 1251271941,
      "line" : 3960,
      "node_id" : "PRRC_kwDOABII585LbjQ6",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 3960,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 143,
      "pull_request_review_id" : 1533034955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265513530/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T15:08:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265513530",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Just pushed a new branch incorporating feedback from all of @ryanofsky's prior review.  Regarding https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251289117, I decided that it made the most sense to invoke `ActivateBestChain()` on both chainstates in `LoadExternalBlockFile` if pruning was enabled, even though I think it'll take some more work to figure out how pruning should function in the event that we're in the middle of assumeutxo-initiated background validation.\r\n\r\nRegarding the comment about `NotifyHeaderTip()` (https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251292140), I wasn't sure if that was something to do in this PR or a future one?",
      "created_at" : "2023-07-17T15:25:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1638374417",
      "id" : 1638374417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585hp5wR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1638374417/reactions"
      },
      "updated_at" : "2023-07-17T15:25:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1638374417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265542867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265542867"
         }
      },
      "author_association" : "MEMBER",
      "body" : "For context, the issue was originally reported in #17890 and was fixed in #17994.  It took me a while to understand exactly what this logic was for and how it worked, so a test to ensure we don't introduce a regression would be helpful!",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-17T15:28:20Z",
      "diff_hunk" : "@@ -734,8 +735,9 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // the FindBlockPos function\n         if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n             FlushUndoFile(_pos.nFile, true);\n+        } else if (_pos.nFile == m_last_blockfile && static_cast<uint32_t>(block.nHeight) > m_undo_height_in_last_blockfile) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265542867",
      "id" : 1265542867,
      "in_reply_to_id" : 1252074194,
      "line" : 753,
      "node_id" : "PRRC_kwDOABII585LbqbT",
      "original_commit_id" : "ad8b21dfe3176691211d7979c3b374447d3a561d",
      "original_line" : 753,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 30,
      "pull_request_review_id" : 1533080104,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265542867/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T15:28:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265542867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265932265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265932265"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246868905\r\n\r\nThanks, it makes sense that the background chainstate only has one state because it is deleted as soon as it finishes syncing.\r\n\r\nWould be great if a followup PR moved `IsInitialBlockDownload` from `Chainstate` class to `ChainstateManager`  so the `IsInitialBlockDownload` implementation could refer directly to the active chainstate, and `IsInitialBlockDownload` callers wouldn't need to figure out which chainstate to call it on.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-17T21:41:36Z",
      "diff_hunk" : "@@ -3962,7 +3964,7 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n     // (but if it does not build on our best tip, let the SendMessages loop relay it)\n-    if (!IsInitialBlockDownload() && m_chain.Tip() == pindex->pprev)\n+    if (!ActiveChainstate().IsInitialBlockDownload() && ActiveTip() == pindex->pprev)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265932265",
      "id" : 1265932265,
      "in_reply_to_id" : 1246868905,
      "line" : 4002,
      "node_id" : "PRRC_kwDOABII585LdJfp",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 4002,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 176,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265932265/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265932265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265971359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265971359"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746/commits/c8f4a8702851c3097ebd038a814d974dce4dcc78#r1251271941\r\n\r\nThanks, that makes sense, and thanks for linking to #5875.\r\n\r\nTo make this less confusing, I think \"Try to process all requested blocks\" code comment above could be updated to mention the active chain and better match the code.\r\n\r\nWould suggest: \"// Check all requested blocks that we do not already have for validity and save them to disk. Skip processing of unrequested blocks as an anti-Dos measure, unless the blocks have more work than the active chain tip, and aren't too far ahead of it, so are likely to be attached soon.\"\r\n\r\n",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-17T22:43:48Z",
      "diff_hunk" : "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveTip() ? pindex->nChainWork >= ActiveTip()->nChainWork : true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265971359",
      "id" : 1265971359,
      "in_reply_to_id" : 1251271941,
      "line" : 3960,
      "node_id" : "PRRC_kwDOABII585LdTCf",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 3960,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 143,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265971359/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265971359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265976213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265976213"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-storage-related logic to ChainstateManager\" (c8f4a8702851c3097ebd038a814d974dce4dcc78)\r\n\r\n> It seems inconsistent to call `ActivateBestChain` on _all_ chainstates here for the genesis block, but only call `ActivateBestChain` on the _active_ chainstate a few lines below (line 4631).\r\n\r\nThis inconsistency is resolved now in commit \"Move block-storage-related logic to ChainstateManager\" (c8f4a8702851c3097ebd038a814d974dce4dcc78) by calling `ActivateBestChain` on all chains in both cases.\r\n\r\nSince the case below is a pruning case, and pruning already has problems when snapshot activated and a background chainstate is being loaded, skipping the `ActivateBestChain` for the background chainstate probably did not cause any issues. But if pruning is going to be supported in the future, probably better if the code starts off treating chainstates the same and doesn't have unexplained inconsistencies.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-17T22:52:31Z",
      "diff_hunk" : "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265976213",
      "id" : 1265976213,
      "in_reply_to_id" : 1212186629,
      "line" : 4602,
      "node_id" : "PRRC_kwDOABII585LdUOV",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 4602,
      "original_position" : 206,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 349,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265976213/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265976213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265982685"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265982685"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1638374417, https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237552792\r\n\r\n> I wasn't sure if that was something to do in this PR or a future one?\r\n\r\nI think it would be a good as a followup. Doing it wouldn't simplify this PR so it's probably good not to add it here.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-17T23:06:21Z",
      "diff_hunk" : "@@ -4614,13 +4628,13 @@ void Chainstate::LoadExternalBlockFile(\n                     // called by concurrent network message processing. but, that is not\n                     // reliable for the purpose of pruning while importing.\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, pblock)) {\n+                    if (!ActiveChainstate().ActivateBestChain(state, pblock)) {\n                         LogPrint(BCLog::REINDEX, \"failed to activate chain (%s)\\n\", state.ToString());\n                         break;\n                     }\n                 }\n \n-                NotifyHeaderTip(*this);\n+                NotifyHeaderTip(ActiveChainstate());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265982685",
      "id" : 1265982685,
      "in_reply_to_id" : 1237552792,
      "line" : 4636,
      "node_id" : "PRRC_kwDOABII585LdVzd",
      "original_commit_id" : "943bd665e2523e5cd483aa2a77a511b967dee509",
      "original_line" : 4636,
      "original_position" : 179,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 382,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265982685/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265982685",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266007380"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266007380"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (471da5f6e74bac71aeffe2ebc5faff145a6cbcea)\r\n\r\nThe \"reload of the block index\" comment now seems out of date. And actually I don't see why this `ClearBlockIndexCandidates` call is necessary here. After the InitializeChainstate call above, the active chainstate should be newly created and `setBlockIndexCandidates` should already be empty. So I think it would be good to drop this `ClearBlockIndexCandidates` call, or add a new comment to explain what it's doing.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-17T23:36:08Z",
      "diff_hunk" : "@@ -221,7 +221,7 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n \n         // A reload of the block index is required to recompute setBlockIndexCandidates\n         // for the fully validated chainstate.\n-        chainman.ActiveChainstate().UnloadBlockIndex();\n+        chainman.ActiveChainstate().ClearBlockIndexCandidates();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266007380",
      "id" : 1266007380,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII585Ldb1U",
      "original_commit_id" : "471da5f6e74bac71aeffe2ebc5faff145a6cbcea",
      "original_line" : 224,
      "original_position" : 5,
      "original_start_line" : 222,
      "path" : "src/node/chainstate.cpp",
      "position" : 5,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266007380/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 222,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266007380",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266117889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266117889"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237511461\r\n \r\n> Probably no need to use `ActiveChainstate()` for these (vs. `this->`) given the TODO above, but seems fine.\r\n\r\nMarking resolved since later commit \"Move CheckBlockIndex() from Chainstate to ChainstateManager\" (f921887c1afdcd333cf71ca25e5efbf4991f806e) drops this.\r\n",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T02:34:54Z",
      "diff_hunk" : "@@ -3978,9 +3980,16 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n         return AbortNode(state, std::string(\"System error: \") + e.what());\n     }\n \n-    FlushStateToDisk(state, FlushStateMode::NONE);\n+    // TODO: FlushStateToDisk() handles flushing of both block and chainstate\n+    // data, so we should move this to ChainstateManager so that we can be more\n+    // intelligent about how we flush.\n+    // For now, since FlushStateMode::NONE is used, all that can happen is that\n+    // the block files may be pruned, so we can just call this on one\n+    // chainstate (particularly if we haven't implemented pruning with\n+    // background validation yet).\n+    ActiveChainstate().FlushStateToDisk(state, FlushStateMode::NONE);\n \n-    CheckBlockIndex();\n+    ActiveChainstate().CheckBlockIndex();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266117889",
      "id" : 1266117889,
      "in_reply_to_id" : 1237511461,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ld20B",
      "original_commit_id" : "943bd665e2523e5cd483aa2a77a511b967dee509",
      "original_line" : 3992,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266117889/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266117889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266147442"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266147442"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (eb8ce95a2551fe521d00a5901ea773514395255b)\r\n\r\nNote: test here is changed to add the real block 1, instead of a random block, so the block will not be ignored by the new `snapshot_base->GetAncestor(pindex->nHeight) == pindex` check in TryAddBlockIndexCandidate",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T03:18:35Z",
      "diff_hunk" : "@@ -118,18 +121,18 @@ BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n     // once it is changed to support multiple chainstates.\n     {\n         LOCK(::cs_main);\n-        bool checked = CheckBlock(*pblock, state, chainparams.GetConsensus());\n+        bool checked = CheckBlock(*pblockone, state, chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266147442",
      "id" : 1266147442,
      "line" : 124,
      "node_id" : "PRRC_kwDOABII585Ld-By",
      "original_commit_id" : "eb8ce95a2551fe521d00a5901ea773514395255b",
      "original_line" : 124,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 32,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266147442/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266147442",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266149966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266149966"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (eb8ce95a2551fe521d00a5901ea773514395255b)\r\n\r\nIs this comment in the commit message still accurate?\r\n\r\n> Note that this introduces the new invariant that we can only have an assumeutxo\r\n> snapshot where the snapshotted blockhash is in our block index. As a followup,\r\n> unit tests that mock creating a snapshot ought to be updated to reflect this.\r\n\r\nThe only way I can see that it relates to code changes in this commit is the new Assert on this line, and it's confusing because I would have not have thought loading a snapshot with an unknown block hash worked before this code change, either. Also I'm not sure what unit tests \"ought to be updated\" means if tests are already updated this commit.\r\n\r\nI think it would be good to drop this comment, or add more specifics about what's actually changing here and what followup needs to be done later.\r\n\r\nEDIT: Rereading this, I guess the commit message is just referring to an internal change that affects unit tests, not a bigger change that affects what snapshots are able to be loaded. Maybe a a clearer commit message would be: \"After this change, `ActivateExistingSnapshot` needs to be passed a valid block hash to avoid assert errors when accepting new blocks.\" Maybe it would be good to add an assert to ActivateExistingSnapshot to catch potential problems with this earlier, too.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T03:24:55Z",
      "diff_hunk" : "@@ -3419,9 +3419,24 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n {\n     AssertLockHeld(cs_main);\n-    // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n-    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+    // The block only is a candidate for the most-work-chain if it has more work than our current tip.\n+    if (m_chain.Tip() != nullptr && setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        return;\n+    }\n+\n+    bool is_active_chainstate = this == &m_chainman.ActiveChainstate();\n+    if (is_active_chainstate) {\n+        // The active chainstate should always add entries that have more\n+        // work than the tip.\n         setBlockIndexCandidates.insert(pindex);\n+    } else if (!m_disabled) {\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base (which can't be nullptr or else we'll\n+        // never make progress).\n+        const CBlockIndex* snapshot_base = Assert(m_chainman.GetSnapshotBaseBlock());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266149966",
      "id" : 1266149966,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ld-pO",
      "original_commit_id" : "eb8ce95a2551fe521d00a5901ea773514395255b",
      "original_line" : 3436,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266149966/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266149966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266153816"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266153816"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (eb8ce95a2551fe521d00a5901ea773514395255b)\r\n\r\nNote: IIUC, it's necessary to load the genesis block here so the ActivateExistingSnapshot call below can be passed a known block hash of a block in `m_block_index`, not a random block.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T03:30:56Z",
      "diff_hunk" : "@@ -49,6 +49,9 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     c1.InitCoinsDB(\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\n     WITH_LOCK(::cs_main, c1.InitCoinsCache(1 << 23));\n+    c1.LoadGenesisBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266153816",
      "id" : 1266153816,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII585Ld_lY",
      "original_commit_id" : "eb8ce95a2551fe521d00a5901ea773514395255b",
      "original_line" : 52,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266153816/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266153816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266156727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266156727"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (eb8ce95a2551fe521d00a5901ea773514395255b)\r\n\r\nSeems like it might be useful to check `BOOST_CHECK_EQUAL(exp_tip, exp_tip2);` now to verify `ActivateBestChain` actually did arrive at the expected CBlockIndex*, not just the right block block hash.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T03:34:38Z",
      "diff_hunk" : "@@ -99,16 +101,12 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266156727",
      "id" : 1266156727,
      "line" : 104,
      "node_id" : "PRRC_kwDOABII585LeAS3",
      "original_commit_id" : "eb8ce95a2551fe521d00a5901ea773514395255b",
      "original_line" : 104,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 44,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266156727/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266156727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266161430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266161430"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (b0b48b3e986319fe8cd5a80052099070279ce5c0)\r\n\r\nNote: It seems like this LoadGenesis/SetBestBlock step was never necessary, so good to drop now. Dropping it maybe makes the test a little less realistic, but simplifies things and keeps the test more focused on verifying cache sizes.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T03:40:49Z",
      "diff_hunk" : "@@ -139,16 +135,15 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n \n     // Create a snapshot-based chainstate.\n     //\n-    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));\n+    CBlockIndex* snapshot_base{WITH_LOCK(manager.GetMutex(), return manager.ActiveChain()[manager.ActiveChain().Height() / 2])};\n+    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, *snapshot_base->phashBlock));\n     chainstates.push_back(&c2);\n     c2.InitCoinsDB(\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\n \n     {\n         LOCK(::cs_main);\n         c2.InitCoinsCache(1 << 23);\n-        BOOST_REQUIRE(c2.LoadGenesisBlock());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266161430",
      "id" : 1266161430,
      "line" : 150,
      "node_id" : "PRRC_kwDOABII585LeBcW",
      "original_commit_id" : "eb8ce95a2551fe521d00a5901ea773514395255b",
      "original_line" : 150,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 88,
      "pull_request_review_id" : 1533749512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266161430/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T04:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266161430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267180167"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267180167"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nIt would be good to remove the reliesOnAssumedValid() function since it is no longer used after this.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T18:50:41Z",
      "diff_hunk" : "@@ -4431,62 +4431,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||\n                     (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                      (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n \n-                // Fill each chainstate's block candidate set. Only add assumed-valid\n-                // blocks to the tip candidate set if the chainstate is allowed to rely on\n-                // assumed-valid blocks.\n-                //\n-                // If all setBlockIndexCandidates contained the assumed-valid blocks, the\n-                // background chainstate's ActivateBestChain() call would add assumed-valid\n-                // blocks to the chain (based on how FindMostWorkChain() works). Obviously\n-                // we don't want this since the purpose of the background validation chain\n-                // is to validate assued-valid blocks.\n-                //\n-                // Note: This is considering all blocks whose height is greater or equal to\n-                // the first assumed-valid block to be assumed-valid blocks, and excluding\n-                // them from the background chainstate's setBlockIndexCandidates set. This\n-                // does mean that some blocks which are not technically assumed-valid\n-                // (later blocks on a fork beginning before the first assumed-valid block)\n-                // might not get added to the background chainstate, but this is ok,\n-                // because they will still be attached to the active chainstate if they\n-                // actually contain more work.\n-                //\n-                // Instead of this height-based approach, an earlier attempt was made at\n-                // detecting \"holistically\" whether the block index under consideration\n-                // relied on an assumed-valid ancestor, but this proved to be too slow to\n-                // be practical.\n                 for (Chainstate* chainstate : GetAll()) {\n-                    if (chainstate->reliesOnAssumedValid() ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267180167",
      "id" : 1267180167,
      "line" : 4456,
      "node_id" : "PRRC_kwDOABII585Lh6KH",
      "original_commit_id" : "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "original_line" : 4486,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 289,
      "pull_request_review_id" : 1535703245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267180167/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T19:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267180167",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267184143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267184143"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nNote: the reason why all entries were added previously was because `pindex->nHeight < first_assumed_valid_height` check was always true, because `first_assumed_valid_height` was `std::numeric_limits<int>::max()`",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T18:55:12Z",
      "diff_hunk" : "@@ -442,16 +442,17 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\n     };\n \n-    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\n-    // tip candidates.\n+    // Ensure that without any assumed-valid BlockIndex entries, only the current tip is\n+    // considered as a candidate.\n     reload_all_block_indexes();\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267184143",
      "id" : 1267184143,
      "line" : 448,
      "node_id" : "PRRC_kwDOABII585Lh7IP",
      "original_commit_id" : "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "original_line" : 448,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 120,
      "pull_request_review_id" : 1535703245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267184143/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T19:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267184143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267187714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267187714"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nHAVE_DATA flag doesn't actualy seem to be removed here. Should it be? And since the test is already passing withtout this would the reason just removing HAVE_DATA flag be to satisfy CheckBlockIndex checks?",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T18:59:18Z",
      "diff_hunk" : "@@ -442,16 +442,17 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\n     };\n \n-    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\n-    // tip candidates.\n+    // Ensure that without any assumed-valid BlockIndex entries, only the current tip is\n+    // considered as a candidate.\n     reload_all_block_indexes();\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 1);\n \n-    // Mark some region of the chain assumed-valid.\n+    // Mark some region of the chain assumed-valid, and remove the HAVE_DATA flag.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267187714",
      "id" : 1267187714,
      "line" : 450,
      "node_id" : "PRRC_kwDOABII585Lh8AC",
      "original_commit_id" : "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "original_line" : 450,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 124,
      "pull_request_review_id" : 1535703245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267187714/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T19:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267187714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267204896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267204896"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nThis is true, but it seems like it might make the test less confusing and more realistic if we just added a ` cs2.m_chain.SetTip(* assumed_base)` call below the `cs1.m_chain.SetTip(*validated_tip);` call. I think if this was done the cs2.setBlockIndexCandidates would just contain blocks after the snapshot.\r\n\r\n",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T19:17:48Z",
      "diff_hunk" : "@@ -464,15 +465,18 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n+            BOOST_CHECK(index->IsAssumedValid());\n+        } else if (i == last_assumed_valid_idx) {\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n     }\n \n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\n \n+    // Note: cs2's tip is not set when ActivateExistingSnapshot is called.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267204896",
      "id" : 1267204896,
      "line" : 479,
      "node_id" : "PRRC_kwDOABII585LiAMg",
      "original_commit_id" : "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "original_line" : 479,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 148,
      "pull_request_review_id" : 1535703245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267204896/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T19:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267204896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267209493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267209493"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nCommand at the top of the test saying it checks cs2 \"contains all blocks, even those assumed-valid\" is out of date. Should be \"contains all blocks except those assumed-valid, because they don't have data\"",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T19:20:07Z",
      "diff_hunk" : "@@ -481,16 +485,18 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n \n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);\n-    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes);\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes - num_assumed_valid + 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267209493",
      "id" : 1267209493,
      "line" : 499,
      "node_id" : "PRRC_kwDOABII585LiBUV",
      "original_commit_id" : "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "original_line" : 499,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 175,
      "pull_request_review_id" : 1535703245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267209493/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T19:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267209493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267213310"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267213310"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nI'm actually confused about how this is working because the HAVE_DATA flag doesn't seem to be removed above.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T19:22:00Z",
      "diff_hunk" : "@@ -481,16 +485,18 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n \n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267213310",
      "id" : 1267213310,
      "line" : 496,
      "node_id" : "PRRC_kwDOABII585LiCP-",
      "original_commit_id" : "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "original_line" : 496,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 171,
      "pull_request_review_id" : 1535703245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267213310/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T19:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267213310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267226100"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267226100"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Documentation improvements for assumeutxo\" (bef5acee93e128857d20137ea0c83f281a780211)\r\n\r\n\"it has\" should be \"it may have\"",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T19:28:21Z",
      "diff_hunk" : "@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\n \n     /**\n-     * If set, this indicates that the block index entry is assumed-valid.\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n-     * It almost certainly means that the block's full validation is pending\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\n+     * and has validity status less than VALID_SCRIPTS. Also that it has\n+     * descendant blocks with VALID_SCRIPTS set, because they were validated",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267226100",
      "id" : 1267226100,
      "line" : 139,
      "node_id" : "PRRC_kwDOABII585LiFX0",
      "original_commit_id" : "bef5acee93e128857d20137ea0c83f281a780211",
      "original_line" : 139,
      "original_position" : 23,
      "original_start_line" : 138,
      "path" : "src/chain.h",
      "position" : 23,
      "pull_request_review_id" : 1535703245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267226100/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 138,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-07-18T19:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267226100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267227843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267227843"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Documentation improvements for assumeutxo\" (bef5acee93e128857d20137ea0c83f281a780211)\r\n\r\n\"below the snapshot height\" should be \"at the snapshot height and below\"",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T19:30:22Z",
      "diff_hunk" : "@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\n \n     /**\n-     * If set, this indicates that the block index entry is assumed-valid.\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n-     * It almost certainly means that the block's full validation is pending\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\n+     * and has validity status less than VALID_SCRIPTS. Also that it has\n+     * descendant blocks with VALID_SCRIPTS set, because they were validated\n+     * based on an assumeutxo snapshot.\n+     *\n+     * When an assumeutxo snapshot is loaded, the ASSUMED_VALID flag is added to\n+     * unvalidated blocks below the snapshot height. Then, as the background",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267227843",
      "id" : 1267227843,
      "line" : 143,
      "node_id" : "PRRC_kwDOABII585LiFzD",
      "original_commit_id" : "bef5acee93e128857d20137ea0c83f281a780211",
      "original_line" : 143,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 27,
      "pull_request_review_id" : 1535703245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267227843/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T19:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267227843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267230477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267230477"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move CheckBlockIndex() from Chainstate to ChainstateManager\" (f921887c1afdcd333cf71ca25e5efbf4991f806e)\r\n\r\nI think it would be a little better to use `GetAll` instead of `ActiveChain()` here. All the chains should have the same genesis block.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-18T19:33:56Z",
      "diff_hunk" : "@@ -4750,8 +4751,8 @@ void Chainstate::CheckBlockIndex()\n         // Begin: actual consistency checks.\n         if (pindex->pprev == nullptr) {\n             // Genesis block checks.\n-            assert(pindex->GetBlockHash() == m_chainman.GetConsensus().hashGenesisBlock); // Genesis block's hash must match.\n-            assert(pindex == m_chain.Genesis()); // The current active chain's genesis block must be this block.\n+            assert(pindex->GetBlockHash() == GetConsensus().hashGenesisBlock); // Genesis block's hash must match.\n+            assert(pindex == ActiveChain().Genesis()); // The current active chain's genesis block must be this block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267230477",
      "id" : 1267230477,
      "line" : 4762,
      "node_id" : "PRRC_kwDOABII585LiGcN",
      "original_commit_id" : "f921887c1afdcd333cf71ca25e5efbf4991f806e",
      "original_line" : 4755,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 445,
      "pull_request_review_id" : 1535703245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267230477/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T19:54:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267230477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1270716655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270716655"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that this seems redundant; the original call to `UnloadBlockIndex()` was added in #25740, and if I'm reading correctly I don't think it should have been necessary then either. @jamesob Wondering if you agree, or if we're overlooking something?",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-21T14:04:49Z",
      "diff_hunk" : "@@ -221,7 +221,7 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n \n         // A reload of the block index is required to recompute setBlockIndexCandidates\n         // for the fully validated chainstate.\n-        chainman.ActiveChainstate().UnloadBlockIndex();\n+        chainman.ActiveChainstate().ClearBlockIndexCandidates();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1270716655",
      "id" : 1270716655,
      "in_reply_to_id" : 1266007380,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII585LvZjv",
      "original_commit_id" : "471da5f6e74bac71aeffe2ebc5faff145a6cbcea",
      "original_line" : 224,
      "original_position" : 5,
      "original_start_line" : 222,
      "path" : "src/node/chainstate.cpp",
      "position" : 5,
      "pull_request_review_id" : 1541223509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270716655/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 222,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-07-21T14:04:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270716655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1270720379"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270720379"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that it would be good to add an assert to catch this earlier, but we discussed before that due to the different ways that chainstates can be constructed and the order in which snapshot block hashes can be passed in (relative to when the block index is populated on startup), that there wasn't a clear  way to do this at an earlier point in the code.\r\n\r\nI'll update the code comment though to make it more clear what will break if an invalid hash is passed in.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-21T14:08:17Z",
      "diff_hunk" : "@@ -3419,9 +3419,24 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n {\n     AssertLockHeld(cs_main);\n-    // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n-    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+    // The block only is a candidate for the most-work-chain if it has more work than our current tip.\n+    if (m_chain.Tip() != nullptr && setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        return;\n+    }\n+\n+    bool is_active_chainstate = this == &m_chainman.ActiveChainstate();\n+    if (is_active_chainstate) {\n+        // The active chainstate should always add entries that have more\n+        // work than the tip.\n         setBlockIndexCandidates.insert(pindex);\n+    } else if (!m_disabled) {\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base (which can't be nullptr or else we'll\n+        // never make progress).\n+        const CBlockIndex* snapshot_base = Assert(m_chainman.GetSnapshotBaseBlock());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1270720379",
      "id" : 1270720379,
      "in_reply_to_id" : 1266149966,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Lvad7",
      "original_commit_id" : "eb8ce95a2551fe521d00a5901ea773514395255b",
      "original_line" : 3436,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1541229429,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270720379/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-21T14:08:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270720379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1272483470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272483470"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The blocks being marked `ASSUMED_VALID` have their `nStatus` completely reset to the expected values for assumed valid, which includes the omission of `HAVE_DATA`.",
      "commit_id" : "137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-24T16:18:19Z",
      "diff_hunk" : "@@ -442,16 +442,17 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\n     };\n \n-    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\n-    // tip candidates.\n+    // Ensure that without any assumed-valid BlockIndex entries, only the current tip is\n+    // considered as a candidate.\n     reload_all_block_indexes();\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 1);\n \n-    // Mark some region of the chain assumed-valid.\n+    // Mark some region of the chain assumed-valid, and remove the HAVE_DATA flag.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1272483470",
      "id" : 1272483470,
      "in_reply_to_id" : 1267187714,
      "line" : 450,
      "node_id" : "PRRC_kwDOABII585L2I6O",
      "original_commit_id" : "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "original_line" : 450,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 124,
      "pull_request_review_id" : 1543838205,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272483470/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-24T16:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272483470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 137762f34a845e491b80f9cea07efc4427cb38bf",
      "created_at" : "2023-07-24T16:21:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1648224098",
      "id" : 1648224098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585iPedi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1648224098/reactions"
      },
      "updated_at" : "2023-07-24T16:21:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1648224098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1272692040"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272692040"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See @achow's explanation: https://github.com/bitcoin/bitcoin/pull/27746/files#r1272483470",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-24T19:58:06Z",
      "diff_hunk" : "@@ -481,16 +485,18 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n \n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1272692040",
      "id" : 1272692040,
      "in_reply_to_id" : 1267213310,
      "line" : 501,
      "node_id" : "PRRC_kwDOABII585L271I",
      "original_commit_id" : "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "original_line" : 501,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 185,
      "pull_request_review_id" : 1544165673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272692040/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-24T19:58:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272692040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks all for the additional review. I pushed a branch that I think addresses all of @ryanofsky's latest feedback (previous branch is tagged [here](https://github.com/sdaftuar/bitcoin/commits/27746.3) for reference).\r\n\r\nOh one open question is here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1270716655",
      "created_at" : "2023-07-24T20:26:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1648555652",
      "id" : 1648555652,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585iQvaE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1648555652/reactions"
      },
      "updated_at" : "2023-07-24T20:29:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1648555652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1272722353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272722353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-24T20:29:24Z",
      "diff_hunk" : "@@ -99,16 +101,12 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1272722353",
      "id" : 1272722353,
      "in_reply_to_id" : 1266156727,
      "line" : 104,
      "node_id" : "PRRC_kwDOABII585L3DOx",
      "original_commit_id" : "eb8ce95a2551fe521d00a5901ea773514395255b",
      "original_line" : 104,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 44,
      "pull_request_review_id" : 1544223967,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272722353/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-24T20:29:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272722353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK a733dd79e29068ad1e0532ac42a45188a040a7b9\r\n\r\nChanges since last are mainly responding to review comments.",
      "created_at" : "2023-07-26T20:05:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1652419820",
      "id" : 1652419820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585ifezs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1652419820/reactions"
      },
      "updated_at" : "2023-07-26T20:05:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1652419820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277540196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277540196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0ce805b632dcb98944a931f758f76f530f5ce5f2: why not `less than BLOCK_VALID_TRANSACTIONS`? Since the minimum requirement to download an assumed-valid block is that we have its headers, i.e. we're at `BLOCK_VALID_TREE` or above.\r\n\r\nSame question for `RaiseValidity`, which this PR doesn't touch. Contrast that to `CheckBlockIndex()` which skips checks for `BLOCK_VALID_TRANSACTIONS`, `BLOCK_VALID_CHAIN` and `BLOCK_VALID_SCRIPTS` when assume valid is set.\r\n\r\nI tried changing `BLOCK_VALID_SCRIPTS` to `BLOCK_VALID_TRANSACTIONS ` in `PopulateAndValidateSnapshot`:\r\n\r\n```\r\n        // Mark unvalidated block index entries beneath the snapshot base block as assumed-valid.\r\n        if (!index->IsValid(BLOCK_VALID_SCRIPTS)) {\r\n```\r\n\r\nThat didn't break a test and makes more intuitive sense to me. It also seems more consistent with `setBlockIndexCandidates`.",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-28T13:21:15Z",
      "diff_hunk" : "@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\n \n     /**\n-     * If set, this indicates that the block index entry is assumed-valid.\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n-     * It almost certainly means that the block's full validation is pending\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\n+     * and has validity status less than VALID_SCRIPTS. Also that it may have",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277540196",
      "id" : 1277540196,
      "line" : 138,
      "node_id" : "PRRC_kwDOABII585MJbdk",
      "original_commit_id" : "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "original_line" : 138,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 22,
      "pull_request_review_id" : 1552110152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277540196/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-28T14:25:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277540196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277557586"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277557586"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0ce805b632dcb98944a931f758f76f530f5ce5f2: why isn't `BLOCK_VALID_TRANSACTIONS` also alternatively `ASSUMED_VALID`?",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-28T13:38:19Z",
      "diff_hunk" : "@@ -113,10 +113,10 @@ enum BlockStatus : uint32_t {\n     BLOCK_VALID_TRANSACTIONS =    3,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277557586",
      "id" : 1277557586,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII585MJftS",
      "original_commit_id" : "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "original_line" : 113,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 1,
      "pull_request_review_id" : 1552110152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277557586/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-28T14:25:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277557586",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277559238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277559238"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0ce805b632dcb98944a931f758f76f530f5ce5f2: maybe make this:\r\n\r\n```cpp\r\n//! All (non-assumed) validity bits.\r\n```\r\n\r\nWhich makes functions that use this more readable:\r\n\r\n<img width=\"659\" alt=\"SchermÂ­afbeelding 2023-07-28 om 15 44 16\" src=\"https://github.com/bitcoin/bitcoin/assets/10217/2b309b0c-ac4a-42ff-9257-03cb75c057ee\">\r\n",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-28T13:39:55Z",
      "diff_hunk" : "@@ -113,10 +113,10 @@ enum BlockStatus : uint32_t {\n     BLOCK_VALID_TRANSACTIONS =    3,\n \n     //! Outputs do not overspend inputs, no double spends, coinbase output ok, no immature coinbase spends, BIP30.\n-    //! Implies all parents are also at least CHAIN.\n+    //! Implies all parents are either at least VALID_CHAIN, or are ASSUMED_VALID\n     BLOCK_VALID_CHAIN        =    4,\n \n-    //! Scripts & signatures ok. Implies all parents are also at least SCRIPTS.\n+    //! Scripts & signatures ok. Implies all parents are either at least VALID_SCRIPTS, or are ASSUMED_VALID.\n     BLOCK_VALID_SCRIPTS      =    5,\n \n     //! All validity bits.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277559238",
      "id" : 1277559238,
      "line" : 122,
      "node_id" : "PRRC_kwDOABII585MJgHG",
      "original_commit_id" : "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "original_line" : 122,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 12,
      "pull_request_review_id" : 1552110152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277559238/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-28T14:25:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277559238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277639934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277639934"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> why not `less than BLOCK_VALID_TRANSACTIONS`?\r\n\r\nI asked myself the same question recently and came to the conclusion that it's because when we finally end up downloading the assumed-valid blocks, there will be a period in time where we've saved the block (and therefore raised its validity to `BLOCK_VALID_TRANSACTIONS`) but haven't connected it yet to the background chainstate (so it's still `ASSUMED_VALID`).",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-28T14:42:06Z",
      "diff_hunk" : "@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\n \n     /**\n-     * If set, this indicates that the block index entry is assumed-valid.\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n-     * It almost certainly means that the block's full validation is pending\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\n+     * and has validity status less than VALID_SCRIPTS. Also that it may have",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277639934",
      "id" : 1277639934,
      "in_reply_to_id" : 1277540196,
      "line" : 138,
      "node_id" : "PRRC_kwDOABII585MJzz-",
      "original_commit_id" : "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "original_line" : 138,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 22,
      "pull_request_review_id" : 1552271924,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277639934/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-28T14:42:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277639934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278023724"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278023724"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3556b850221bc0e597d7dd749d4d47ab58dc8083: if you have to retouch, can you add a comment that `!CBlockIndexWorkComparator()(pindex, c->m_chain.Tip())` means \"pindex has more work than the tip or was received earlier\"",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-28T19:49:02Z",
      "diff_hunk" : "@@ -4798,27 +4803,32 @@ void Chainstate::CheckBlockIndex()\n             // Checks for not-invalid blocks.\n             assert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\n         }\n-        if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) && pindexFirstNeverProcessed == nullptr) {\n-            if (pindexFirstInvalid == nullptr) {\n-                const bool is_active = this == &m_chainman.ActiveChainstate();\n-\n-                // If this block sorts at least as good as the current tip and\n-                // is valid and we have all data for its parents, it must be in\n-                // setBlockIndexCandidates.  m_chain.Tip() must also be there\n-                // even if some data has been pruned.\n-                //\n-                // Don't perform this check for the background chainstate since\n-                // its setBlockIndexCandidates shouldn't have some entries (i.e. those past the\n-                // snapshot block) which do exist in the block index for the active chainstate.\n-                if (is_active && (pindexFirstMissing == nullptr || pindex == m_chain.Tip())) {\n-                    assert(setBlockIndexCandidates.count(pindex));\n+        // Chainstate-specific checks on setBlockIndexCandidates\n+        for (auto c : GetAll()) {\n+            if (c->m_chain.Tip() == nullptr) continue;\n+            if (!CBlockIndexWorkComparator()(pindex, c->m_chain.Tip()) && pindexFirstNeverProcessed == nullptr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278023724",
      "id" : 1278023724,
      "line" : 4816,
      "node_id" : "PRRC_kwDOABII585MLRgs",
      "original_commit_id" : "3556b850221bc0e597d7dd749d4d47ab58dc8083",
      "original_line" : 4809,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 495,
      "pull_request_review_id" : 1552855193,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278023724/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-28T20:15:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278023724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278035016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278035016"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3556b850221bc0e597d7dd749d4d47ab58dc8083: there's a tie breaker in the comparator for if two blocks with equal work were loaded from disk. Presumably that only matters if you restart right during a reorg in some weird way.",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-28T20:00:16Z",
      "diff_hunk" : "@@ -4798,27 +4803,32 @@ void Chainstate::CheckBlockIndex()\n             // Checks for not-invalid blocks.\n             assert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\n         }\n-        if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) && pindexFirstNeverProcessed == nullptr) {\n-            if (pindexFirstInvalid == nullptr) {\n-                const bool is_active = this == &m_chainman.ActiveChainstate();\n-\n-                // If this block sorts at least as good as the current tip and\n-                // is valid and we have all data for its parents, it must be in\n-                // setBlockIndexCandidates.  m_chain.Tip() must also be there\n-                // even if some data has been pruned.\n-                //\n-                // Don't perform this check for the background chainstate since\n-                // its setBlockIndexCandidates shouldn't have some entries (i.e. those past the\n-                // snapshot block) which do exist in the block index for the active chainstate.\n-                if (is_active && (pindexFirstMissing == nullptr || pindex == m_chain.Tip())) {\n-                    assert(setBlockIndexCandidates.count(pindex));\n+        // Chainstate-specific checks on setBlockIndexCandidates\n+        for (auto c : GetAll()) {\n+            if (c->m_chain.Tip() == nullptr) continue;\n+            if (!CBlockIndexWorkComparator()(pindex, c->m_chain.Tip()) && pindexFirstNeverProcessed == nullptr) {\n+                if (pindexFirstInvalid == nullptr) {\n+                    const bool is_active = c == &ActiveChainstate();\n+                    // If this block sorts at least as good as the current tip and\n+                    // is valid and we have all data for its parents, it must be in\n+                    // setBlockIndexCandidates.  m_chain.Tip() must also be there\n+                    // even if some data has been pruned.\n+                    //\n+                    if ((pindexFirstMissing == nullptr || pindex == c->m_chain.Tip())) {\n+                        // The active chainstate should always have this block\n+                        // as a candidate, but a background chainstate should\n+                        // only have it if it is an ancestor of the snapshot base.\n+                        if (is_active || GetSnapshotBaseBlock()->GetAncestor(pindex->nHeight) == pindex) {\n+                            assert(c->setBlockIndexCandidates.count(pindex));\n+                        }\n+                    }\n+                    // If some parent is missing, then it could be that this block was in\n+                    // setBlockIndexCandidates but had to be removed because of the missing data.\n+                    // In this case it must be in m_blocks_unlinked -- see test below.\n                 }\n-                // If some parent is missing, then it could be that this block was in\n-                // setBlockIndexCandidates but had to be removed because of the missing data.\n-                // In this case it must be in m_blocks_unlinked -- see test below.\n+            } else { // If this block sorts worse than the current tip or some ancestor's block has never been seen, it cannot be in setBlockIndexCandidates.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278035016",
      "id" : 1278035016,
      "line" : 4836,
      "node_id" : "PRRC_kwDOABII585MLURI",
      "original_commit_id" : "3556b850221bc0e597d7dd749d4d47ab58dc8083",
      "original_line" : 4829,
      "original_position" : 126,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 518,
      "pull_request_review_id" : 1552855193,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278035016/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-28T20:15:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278035016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278308074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278308074"
         }
      },
      "author_association" : "MEMBER",
      "body" : "768690b7ce551cd403f8e2a099372915f6022ad4: Maybe clarify that initially this only applies to the snapshot chainstate, which uses the base block as its starting point. For the background chainstate, as well an active chainstate not created from a snapshot, `GetSnapshotBaseBlock()` is `nullptr` so the special-case won't apply. But the background state will consider it a candidate once it's been downloaded.",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-29T14:48:39Z",
      "diff_hunk" : "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278308074",
      "id" : 1278308074,
      "line" : 4448,
      "node_id" : "PRRC_kwDOABII585MMW7q",
      "original_commit_id" : "768690b7ce551cd403f8e2a099372915f6022ad4",
      "original_line" : 4440,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 265,
      "pull_request_review_id" : 1553292155,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278308074/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-29T15:12:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278308074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278308558"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278308558"
         }
      },
      "author_association" : "MEMBER",
      "body" : "768690b7ce551cd403f8e2a099372915f6022ad4\r\n\r\n```cpp\r\n//!\r\n//! - Run LoadBlockIndex() and ensure that setBlockIndexCandidates of the first ...\r\n```",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-29T14:54:01Z",
      "diff_hunk" : "@@ -412,7 +412,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n //!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278308558",
      "id" : 1278308558,
      "line" : 413,
      "node_id" : "PRRC_kwDOABII585MMXDO",
      "original_commit_id" : "768690b7ce551cd403f8e2a099372915f6022ad4",
      "original_line" : 413,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 96,
      "pull_request_review_id" : 1553292155,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278308558/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-29T15:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278308558",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278312526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278312526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "768690b7ce551cd403f8e2a099372915f6022ad4: this had me confused, but it's because the test considers a scenario where the snapshot base block has been downloaded. It could be nice to include the moment _before_ it's downloaded where this should be `0`.",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-29T15:10:33Z",
      "diff_hunk" : "@@ -466,33 +467,41 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n+            BOOST_CHECK(index->IsAssumedValid());\n+        } else if (i == last_assumed_valid_idx) {\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n     }\n \n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\n \n+    // Note: cs2's tip is not set when ActivateExistingSnapshot is called.\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\n         return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\n \n     // Set tip of the fully validated chain to be the validated tip\n     cs1.m_chain.SetTip(*validated_tip);\n \n+    // Set tip of the assume-valid-based chain to the assume-valid block\n+    cs2.m_chain.SetTip(*assumed_base);\n+\n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n-    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 0);\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278312526",
      "id" : 1278312526,
      "line" : 503,
      "node_id" : "PRRC_kwDOABII585MMYBO",
      "original_commit_id" : "768690b7ce551cd403f8e2a099372915f6022ad4",
      "original_line" : 503,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 187,
      "pull_request_review_id" : 1553292155,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278312526/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-29T15:11:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278312526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278315696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278315696"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6 Maybe add: `Background validation always ignores unrequested blocks.`",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-29T15:49:20Z",
      "diff_hunk" : "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveTip() ? pindex->nChainWork >= ActiveTip()->nChainWork : true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278315696",
      "id" : 1278315696,
      "in_reply_to_id" : 1251271941,
      "line" : 3961,
      "node_id" : "PRRC_kwDOABII585MMYyw",
      "original_commit_id" : "034f920d1755cff752d46b089ad37bdd703bf896",
      "original_line" : 3961,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 149,
      "pull_request_review_id" : 1553302075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278315696/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-29T16:54:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278315696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278316042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278316042"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6: `// We don't relay background validation blocks.` ",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-29T15:53:44Z",
      "diff_hunk" : "@@ -3974,7 +3977,7 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n     // (but if it does not build on our best tip, let the SendMessages loop relay it)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278316042",
      "id" : 1278316042,
      "line" : 4002,
      "node_id" : "PRRC_kwDOABII585MMY4K",
      "original_commit_id" : "d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6",
      "original_line" : 3979,
      "original_position" : 92,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 180,
      "pull_request_review_id" : 1553302075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278316042/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-29T16:54:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278316042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1553292155\r\n\r\n> (The above still doesn't satisfyingly explain _why_ we hold them in `m_blocks_unlinked` rather than treat them as any other block index entry. I assume it's because we use the list to proactively aks for these blocks?)\r\n\r\nI also found this pretty confusing when I was reviewing it and found a helpful explanation here: https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_6):_The_Blockchain. The description of `m_blocks_unlinked` (which used to be `mapBlocksUnlinked`) is:\r\n\r\n> Multimap containing \"all pairs A->B, where A (or one if its ancestors) misses transactions, but B has transactions.\" (comment at main.cpp:125).\r\n>\r\n>The purpose of mapBlocksUnlinked is to quickly attach blocks we've already received to the blockchain when we receive a missing, intermediate block.\r\n>\r\n>The alternative would be to search the entire mapBlockIndex; however, it is more efficient to keep track of unlinked blocks in a separate data structure. \r\n\r\nSo I think the map just exists for efficiency, not to proactively do anything. It would be great to improve documentation in the actual code, though.",
      "created_at" : "2023-07-31T13:14:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1658351829",
      "id" : 1658351829,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585i2HDV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1658351829/reactions"
      },
      "updated_at" : "2023-07-31T13:14:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1658351829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279727266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279727266"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278308074\r\n\r\n> `GetSnapshotBaseBlock()` is `nullptr` so the special-case won't apply\r\n\r\nI may be misunderstanding, but I don't think it's true that `GetSnapshotBaseBlock` is null for the background chainstate. This is a ChainstateManager method, so `GetSnapshotBaseBlock` is going to be non-null if any snapshot is loaded, and this code will try to add the snapshot block to both chainstates, even though it's not needed for the background chainstate. It might be clearer if the code narrowed the special case, and only added the snapshot block to the snapshot chainstate where it was actually needed, not to both chainstates. But that might make the code more complicated.\r\n\r\nI do think it might be better if the comment said \"assumeutxo snapshot chainstate\" instead of \"assumeutxo-based chainstate\" to be more specific about when this special case is needed, but I don't think it need to go into detail about other cases where the check is harmless and not needed.",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-31T18:36:28Z",
      "diff_hunk" : "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279727266",
      "id" : 1279727266,
      "in_reply_to_id" : 1278308074,
      "line" : 4448,
      "node_id" : "PRRC_kwDOABII585MRxai",
      "original_commit_id" : "768690b7ce551cd403f8e2a099372915f6022ad4",
      "original_line" : 4440,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 265,
      "pull_request_review_id" : 1555524219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279727266/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-31T20:07:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279727266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279760417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279760417"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (768690b7ce551cd403f8e2a099372915f6022ad4)\r\n\r\nWould be good to directly verify the snapshot block is included:\r\n\r\n```c++\r\n// block before the snapshot is excluded (as well as earlier blocks)\r\nBOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_base->pprev), 0); \r\n// snapshot block is included (as well as later blocks)\r\nBOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_base), 1);\r\n```",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-31T19:12:44Z",
      "diff_hunk" : "@@ -466,33 +467,41 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n+            BOOST_CHECK(index->IsAssumedValid());\n+        } else if (i == last_assumed_valid_idx) {\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n     }\n \n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\n \n+    // Note: cs2's tip is not set when ActivateExistingSnapshot is called.\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\n         return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\n \n     // Set tip of the fully validated chain to be the validated tip\n     cs1.m_chain.SetTip(*validated_tip);\n \n+    // Set tip of the assume-valid-based chain to the assume-valid block\n+    cs2.m_chain.SetTip(*assumed_base);\n+\n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n-    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279760417",
      "id" : 1279760417,
      "line" : 502,
      "node_id" : "PRRC_kwDOABII585MR5gh",
      "original_commit_id" : "768690b7ce551cd403f8e2a099372915f6022ad4",
      "original_line" : 502,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 186,
      "pull_request_review_id" : 1555524219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279760417/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-31T20:07:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279760417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279767675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279767675"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278312526\r\n\r\n> [768690b](https://github.com/bitcoin/bitcoin/commit/768690b7ce551cd403f8e2a099372915f6022ad4): this had me confused, but it's because the test considers a scenario where the snapshot base block has been downloaded. It could be nice to include the moment _before_ it's downloaded where this should be `0`.\r\n\r\nThis review comment does not match my understanding. The snapshot block is `assumed_base` at height 39 and it does not have data. This line is checking `assumed_tip` block at height 100 which does have data.\r\n\r\nI think all the variable names in this test are pretty confusing, and it would probably be clearer if blocks were referred to directly by height, but that's the was the test style, so it's not changing.",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-31T19:20:46Z",
      "diff_hunk" : "@@ -466,33 +467,41 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n+            BOOST_CHECK(index->IsAssumedValid());\n+        } else if (i == last_assumed_valid_idx) {\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n     }\n \n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\n \n+    // Note: cs2's tip is not set when ActivateExistingSnapshot is called.\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\n         return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\n \n     // Set tip of the fully validated chain to be the validated tip\n     cs1.m_chain.SetTip(*validated_tip);\n \n+    // Set tip of the assume-valid-based chain to the assume-valid block\n+    cs2.m_chain.SetTip(*assumed_base);\n+\n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n-    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 0);\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279767675",
      "id" : 1279767675,
      "in_reply_to_id" : 1278312526,
      "line" : 503,
      "node_id" : "PRRC_kwDOABII585MR7R7",
      "original_commit_id" : "768690b7ce551cd403f8e2a099372915f6022ad4",
      "original_line" : 503,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 187,
      "pull_request_review_id" : 1555524219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279767675/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-31T20:07:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279767675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279781965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279781965"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (768690b7ce551cd403f8e2a099372915f6022ad4)\r\n\r\nI think it's a little misleading to say the other chainstate contains all block except those marked assume-valid because:\r\n\r\n- It actually does contain one block marked assumed-valid, which is the snapshot base (block 39)\r\n- It also excludes other blocks which are not assumed-valid because they don't have more work than the tip (blocks 1-19)\r\n\r\nI think this comment could incorporate sjors suggestion above and just say \"Run LoadBlockIndex() and ensure that setBlockIndexCandidates of the first chainstate only contains blocks leading to the snapshot base, and that setBlockIndexCandidates of the second chainstate only contains blocks following the snapshot base.\"\r\n\r\nOr could leave out the details and say \"Run LoadBlockIndex() and check setBlockIndexCandidates of both chainstates.\"",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-31T19:35:55Z",
      "diff_hunk" : "@@ -412,7 +412,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n //!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n-//!   even those assumed-valid.\n+//!   except those marked assume-valid, because those entries don't HAVE_DATA.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279781965",
      "id" : 1279781965,
      "line" : 415,
      "node_id" : "PRRC_kwDOABII585MR-xN",
      "original_commit_id" : "768690b7ce551cd403f8e2a099372915f6022ad4",
      "original_line" : 415,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 99,
      "pull_request_review_id" : 1555524219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279781965/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-31T20:07:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279781965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279811734"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279811734"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277557586\r\n\r\n> [0ce805b](https://github.com/bitcoin/bitcoin/commit/0ce805b632dcb98944a931f758f76f530f5ce5f2): why isn't `BLOCK_VALID_TRANSACTIONS` also alternatively `ASSUMED_VALID`?\r\n\r\nI'm not sure what this review comment is asking. The code comment above still seems accurate to me, but it maybe it could be improved.",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-07-31T19:49:36Z",
      "diff_hunk" : "@@ -113,10 +113,10 @@ enum BlockStatus : uint32_t {\n     BLOCK_VALID_TRANSACTIONS =    3,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279811734",
      "id" : 1279811734,
      "in_reply_to_id" : 1277557586,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII585MSGCW",
      "original_commit_id" : "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "original_line" : 113,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 1,
      "pull_request_review_id" : 1555524219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279811734/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-31T20:07:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279811734",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1280251267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1280251267"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's related to https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277639934\r\n\r\n(it suggests a further refactor, not changing the comment)",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-08-01T08:02:26Z",
      "diff_hunk" : "@@ -113,10 +113,10 @@ enum BlockStatus : uint32_t {\n     BLOCK_VALID_TRANSACTIONS =    3,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1280251267",
      "id" : 1280251267,
      "in_reply_to_id" : 1277557586,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII585MTxWD",
      "original_commit_id" : "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "original_line" : 113,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/chain.h",
      "position" : 1,
      "pull_request_review_id" : 1556389934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1280251267/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-01T08:02:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1280251267",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Post-merge ACK a733dd79e29068ad1e0532ac42a45188a040a7b9\r\n\r\nVery happy with the separation of concerns between blockstorage and validation.",
      "created_at" : "2023-08-01T08:22:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1659814327",
      "id" : 1659814327,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585i7sG3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1659814327/reactions"
      },
      "updated_at" : "2023-08-01T08:22:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1659814327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1320915269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1320915269"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (768690b7ce551cd403f8e2a099372915f6022ad4)\r\n\r\nIt looks like there may be a  bug in this code because this `pindex == GetSnapshotBaseBlock()` special case will add the snapshot block to `setBlockIndexCandidates` whether or not it has data, but there is also an assert in `FindMostWorkChain` which asserts that blocks in `setBlockIndexCandidates` do have data:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c5a63ea56f8347139bd84e1669b378ecfb234c3c/src/validation.cpp#L2914 \r\n\r\nI think it's not possible to hit this assert for the snapshot chainstate, but it may be possible to hit this assert for the background chainstate.\r\n\r\nFor the snapshot chainstate, I think the assert won't be reached because after the snapshot is loaded the `Chainstate::LoadChainTip` function should immediately set the chain tip to the snapshot block index:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c5a63ea56f8347139bd84e1669b378ecfb234c3c/src/validation.cpp#L4153\r\n\r\nso the `m_chain.Contains(pindexTest)` check before the assert will be false and the assert will not run:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c5a63ea56f8347139bd84e1669b378ecfb234c3c/src/validation.cpp#L2913-L2914\r\n\r\nBut for the background chainstate, it seems possible assert could be hit if `FindMostWorkChain` is called before the snapshot block is downloaded.\r\n\r\nIn any case, this special `pindex == GetSnapshotBaseBlock()` case seems overbroad. It seems like it should only apply to the snapshot chainstate, not the background chainstate, and I'm not actually sure why it is necessary to have at all if `Chainstate::LoadChainTip` is already going to set the snapshot block as the snapshot chainstate tip.\r\n\r\nI think the interaction between these checks and the checks inside the `TryAddBlockIndexCandidate` are also unnecessarily confusing, and it would be nice whether there is a bug or not to move all the move all the checks inside `TryAddBlockIndexCandidate` and call it unconditionally. This should make it easeir to avoid adding the snapshot block the background chainstate candidate set before it is downloaded. It would also be great to drop the snapshot block special case entirely if it is not needed.\r\n\r\n\r\n",
      "commit_id" : "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "created_at" : "2023-09-11T01:40:32Z",
      "diff_hunk" : "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1320915269",
      "id" : 1320915269,
      "line" : 4450,
      "node_id" : "PRRC_kwDOABII585Ou5FF",
      "original_commit_id" : "768690b7ce551cd403f8e2a099372915f6022ad4",
      "original_line" : 4442,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 267,
      "pull_request_review_id" : 1618995679,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1320915269/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-11T01:40:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1320915269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
