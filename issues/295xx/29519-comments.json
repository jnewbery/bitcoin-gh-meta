[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29519).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [Sjors](https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1991970602), [fjahr](https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-2141013222) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2024-02-29T21:44:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1972013849",
      "id" : 1972013849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5851iosZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1972013849/reactions"
      },
      "updated_at" : "2024-05-30T23:48:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1972013849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Note that given that 27 will not ship with mainnet assumeutxo, this isn't a blocker, and a fix can still be backported to 27.x if deemed necessary.",
      "created_at" : "2024-03-05T16:18:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1979145599",
      "id" : 1979145599,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5851911_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1979145599/reactions"
      },
      "updated_at" : "2024-03-05T16:18:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1979145599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nac547ea43beb1d66d2c11e7e8abb76dd1bfc2883 looks reasonable, but it would be nice to somehow add a test for it.\r\n\r\nWhat happens once we've reached the tip and need more peers for background sync? And once background sync is done, is it updated to the tip again?\r\n\r\nWould it make sense to introduce `pindexLastCommonBackgroundSyncBlock` so we have more control over what peers to dedicate to the tip vs background (which might take weeks on some devices)?",
      "created_at" : "2024-03-11T15:21:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1988700471",
      "id" : 1988700471,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5852iSk3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988700471/reactions"
      },
      "updated_at" : "2024-03-11T15:25:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988700471",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> [ac547ea](https://github.com/bitcoin/bitcoin/commit/ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883) looks reasonable, but it would be nice to somehow add a test for it.\r\n\r\nI tested this syncing on signet, but I'll think about a functional test; I imagine that it would be hard to prevent race conditions in a functional test because we'd:\r\n* need to first connect to a peer that has the entire chain and start syncing the background chain\r\n* then load the snapshot (at the same time the peer would continue syncing the background chain)\r\n* then check that we switch to requesting from the snapshot chain (while the bg chain hopefully hasn't finished downloading yet)\r\n\r\nIt might be possible though if that peer was a `P2PConnection()` (that could stall / withhold certain blocks) instead of a real node.\r\n\r\n> What happens once we've reached the tip and need more peers for background sync? And once background sync is done, is it updated to the tip again?\r\n> \r\n> Would it make sense to introduce `pindexLastCommonBackgroundSyncBlock` so we have more control over what peers to dedicate to the tip vs background (which might take weeks on some devices)?\r\n\r\nWe have [this logic](https://github.com/bitcoin/bitcoin/blob/a945f09fa6e0f94cc424da9e06516f9cfa192545/src/net_processing.cpp#L5991-L6000) in `SendMessages`: It first tries `FindNextBlocksToDownload` meant for the active chainstate, and, if it doesn't fill up the `vToDownload` buffer (e.g. because we are at / near the tip), then calls `TryDownloadingHistoricalBlocks` specifically for the background chainstate. I think that this existing separation should work well, the problem that this PR fixes is that `FindNextBlocksToDownload` would pick historical blocks from the background chain when it shouldn't because higher-prio blocks are available.",
      "created_at" : "2024-03-11T20:30:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1989387189",
      "id" : 1989387189,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5852k6O1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1989387189/reactions"
      },
      "updated_at" : "2024-03-11T20:31:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1989387189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I can see how it would be difficult to test, indeed.\r\n\r\nI encountered this scenario while testing #29370 on signet. All my peers were only downloading the background state. I only got headers for the tip chain, but it didn't progress. The workaround there was to turn the network off and on, which is consistent with your observation that only existing peers are affected.\r\n\r\nutACK ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "created_at" : "2024-03-12T15:45:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-1991970602",
      "id" : 1991970602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5852uw8q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991970602/reactions"
      },
      "updated_at" : "2024-03-12T15:45:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991970602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The code and reasoning look good to me and I have been trying to write a test but I am currently unable to reproduce the behavior described before the change, i.e. to make the test fail on master.\r\n\r\nHere is the test so far: https://github.com/fjahr/bitcoin/commit/478fb28dac4e22175da150cee97991a66b4f5695\r\n\r\nThis now does fail on master but only because it also checks for the debug log `HERE` I have added. This log confirms that the test does trigger the behavior change, i.e. on master the last common block is set once, after the change here it is set twice within `FindNextBlockToDownload`. But, of course, we would rather like to have the test fail at the asserts at the end but that is not the case so far.\r\n\r\n@mzumsande do you have an idea why this doesn't reproduce the behavior you have seen on master?",
      "created_at" : "2024-03-25T17:58:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-2018586575",
      "id" : 2018586575,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5854US_P",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2018586575/reactions"
      },
      "updated_at" : "2024-03-25T17:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2018586575",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @mzumsande do you have an idea why this doesn't reproduce the behavior you have seen on master?\r\n\r\nI tested your branch, and I see the same - this is really interesting, and it works differently than I thought when I opened the PR!\r\n\r\nI think the following happens in `PeerManagerImpl::FindNextBlocks` (after being called from `FindNextBlocksToDownload()`):\r\nWe process up to 1024 blocks ahead of the current `pindexWalk`:\r\nhttps://github.com/bitcoin/bitcoin/blob/2102c978b5f2d0bfaa0290c00ed693555f3403d4/src/net_processing.cpp#L1430\r\nBut due to the lines \r\nhttps://github.com/bitcoin/bitcoin/blob/2102c978b5f2d0bfaa0290c00ed693555f3403d4/src/net_processing.cpp#L1497-L1502\r\nwe never ask for the blocks below the snapshot block here: Even though we don't have their data, they are now in the active chain, so they are skipped instead.\r\nIn the test, we immediately ask for the blocks after the snapshot instead, which is exactly the desired behavior.\r\n\r\nSo why did I observe a different behavior on signet?\r\nI think it only works like this in the test because there, the snapshot is just a 100 blocks away from `pindexLastCommonBlock`.\r\n\r\nIf this wasn't the case, we'd request nothing in `FindNextBlocksToDownload()`, only move our `pindexLastCommonBlock` ahead by a maximum of 1024. Then we have capacity for this peer left and would actually ask for the historical blocks via `TryDownloadingHistoricalBlocks()`.\r\n\r\nSo I think what would actually happen on mainnet and signet is that each time we can process a block request with an existing peer, we'd move `pindexLastCommonBlock` 1024 blocks ahead, and then request historical blocks - until `pindexLastCommonBlock` has reached the snapshot. So we'd continuing downloading the background chain for a while (a few minutes?) with existing peers until we switch over to the snapshot chain (instead of never switching over as I originally thought when opening this PR).\r\n\r\nStill, I think that this behavior is not great, and the fix is an improvement - not only because we start downloading the snapshot chain immediately, we also do much less iterating in `FindNextBlocksToDownload` , moving `pindexLastCommonBlock` ahead without actually downloading anything.\r\n",
      "created_at" : "2024-03-25T22:24:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-2019025217",
      "id" : 2019025217,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII5854V-FB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2019025217/reactions"
      },
      "updated_at" : "2024-03-25T22:24:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2019025217",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tACK ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883\r\n\r\nI reproduced the issue on current master with signet and confirmed that it is fixed with the change here (three times actually with slightly different logs). Based on reading the code and some custom logging I agree with @mzumsande that his description above is what is indeed happening. Based on this I am fine to add this without a test.",
      "created_at" : "2024-05-30T23:48:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-2141013222",
      "id" : 2141013222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII585_nUTm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2141013222/reactions"
      },
      "updated_at" : "2024-05-30T23:48:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2141013222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ryanofsky would be really great to get your review here when you get the chance :)",
      "created_at" : "2024-05-30T23:51:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#issuecomment-2141014859",
      "id" : 2141014859,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29519",
      "node_id" : "IC_kwDOABII585_nUtL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2141014859/reactions"
      },
      "updated_at" : "2024-05-30T23:51:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2141014859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1628436308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628436308"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"p2p: For assumeutxo, download snapshot chain before background chain\" (ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883)\r\n\r\nIt seems like the `pindexLastCommonBlock->nHeight < snapshot_height` check is not strict enough because the snapshot block might not necessarily be an ancestor the peer's best known block.\r\n\r\nIn this case, the `pindexLastCommonBlock` assignments on line 1406 and 1411 will reset it back to the fork point between the two nodes each time `FindNextBlocksToDownload` is called. And if the peer's best block is more than `BLOCK_DOWNLOAD_WINDOW` blocks away from the current chain, the node will never be able to download enough blocks to reach it and validate it. This means if the snapshot is not on the best chain, the node may be unable to sync to a better chain.\r\n\r\nSuggestion to fix would be:\r\n\r\n```diff\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -1487,12 +1487,14 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\r\n         return;\r\n     }\r\n \r\n-    std::optional<int> snapshot_height{m_chainman.GetSnapshotBaseHeight()};\r\n+    // If pindexLastCommonBlock has not been set yet, set it now. Also reset it\r\n+    // if an assumetxo snapshot has been loaded and it is an ancestor of the\r\n+    // snapshot, so only blocks after the snapshot will be downloaded.\r\n+    const CBlockIndex* snap_base{m_chainman.GetSnapshotBaseBlock()};\r\n     if (state->pindexLastCommonBlock == nullptr ||\r\n-        (snapshot_height.has_value() && state->pindexLastCommonBlock->nHeight < snapshot_height.value())) {\r\n+        (snap_base && snap_base->GetAncestor(state->pindexLastCommonBlock->nHeight) == state->pindexLastCommonBlock)) {\r\n         // Bootstrap quickly by guessing a parent of our best tip is the forking point.\r\n         // Guessing wrong in either direction is not a problem.\r\n-        // Also applies after loading a snapshot, when we want to prioritise loading the snapshot chain and therefore need to skip ahead.\r\n         state->pindexLastCommonBlock = m_chainman.ActiveChain()[std::min(state->pindexBestKnownBlock->nHeight, m_chainman.ActiveChain().Height())];\r\n     }\r\n \r\n```",
      "commit_id" : "ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "created_at" : "2024-06-05T21:05:15Z",
      "diff_hunk" : "@@ -1397,9 +1397,12 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n         return;\n     }\n \n-    if (state->pindexLastCommonBlock == nullptr) {\n+    std::optional<int> snapshot_height{m_chainman.GetSnapshotBaseHeight()};\n+    if (state->pindexLastCommonBlock == nullptr ||\n+        (snapshot_height.has_value() && state->pindexLastCommonBlock->nHeight < snapshot_height.value())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1628436308",
      "id" : 1628436308,
      "line" : 1402,
      "node_id" : "PRRC_kwDOABII585hD_dU",
      "original_commit_id" : "ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "original_line" : 1402,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2100288867,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628436308/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T21:37:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628436308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1635456871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635456871"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> This means if the snapshot is not on the best chain, the node may be unable to sync to a better chain.\r\n\r\nI've thought about this for a while, and I'm not sure if that problem is really being fixed by your suggestion for the following (slightly philosophical) reasons:\r\n- Accepting a snapshot means that we've created a new chainstate with its Active Tip being set to that block.\r\n- That is a commitment, we can't just reorg away from it to another chain that doesn't contain the snapshot block, even if such a chain existed - at least not until the background sync has finished (we'd need the full blocks below the snapshot), and once that has happened, the snapshot chainstate gets deleted.\r\n- If all of our peers are on a better chain not containing the Snapshot, it seems to me that we are in a hopeless situation anyway: With the current patch we might download no blocks from those peers, with your suggestion we'd download useless blocks that can't be connected - I'm not sure why one is better than the other.\r\n\r\nSo I think that the premise that we could get into this situation should be rejected:\r\nIf a valid snapshot was provided and put into a release, it should only be possible if there was a massive reorg of multiple thousands of blocks (and we'd also need to have accepted header chains ending in both chaintips from different peers). I'd say that in this hypothetical situation, AssumeUtxo is not at the top of the list of our concerns - bitcoin would have far bigger problems.\r\n\r\nWithout a massive reorg, there is the alternative that the snapshot provided was bad somehow. But then (apart from the fact that it shouldn't have been hardcoded into chainparams), it also shouldn't have been loaded in the first place because its header should not have been accepted to our block index with our header DoS protections.\r\n\r\nSo all in all I think that once we've accepted a snapshot, we've made a commitment and have to treat it as part of the best chain, at least until background sync has finished.",
      "commit_id" : "ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "created_at" : "2024-06-11T20:39:18Z",
      "diff_hunk" : "@@ -1397,9 +1397,12 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n         return;\n     }\n \n-    if (state->pindexLastCommonBlock == nullptr) {\n+    std::optional<int> snapshot_height{m_chainman.GetSnapshotBaseHeight()};\n+    if (state->pindexLastCommonBlock == nullptr ||\n+        (snapshot_height.has_value() && state->pindexLastCommonBlock->nHeight < snapshot_height.value())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1635456871",
      "id" : 1635456871,
      "in_reply_to_id" : 1628436308,
      "line" : 1402,
      "node_id" : "PRRC_kwDOABII585hexdn",
      "original_commit_id" : "ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "original_line" : 1402,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2111417286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635456871/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-11T20:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635456871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1636522532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1636522532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1635456871\r\n\r\nGood points. My suggested change was premised on the false assumption that the node would be able to seamlessly reorg to the most-work chain. But that's not true because of missing undo data.\r\n\r\nYour philosophical point is interesting. I believe that:\r\n\r\n- Loading snapshots should not affect how nodes come to consensus, it should only affect what order they download blocks, and help them compute the latest UTXO sets sooner.\r\n\r\nAnd you seem to be suggesting:\r\n\r\n- Loading a snapshot should force a node to only consider chains that include the snapshot block and ignore other chains, even if they have more work.\r\n\r\n---\r\n\r\nOn this PR more specifically:\r\n\r\nWhen I made my suggested change, I was forgetting that we don't have any undo data for the snapshot block and blocks before it, so unfortunately it is not possible for a node to follow the most-work chain when a snapshot is loaded until all the preceding blocks are downloaded.\r\n\r\nGiven this fact, I think the best thing FindNextBlocksToDownload can do when an unvalidated snapshot is loaded is to ignore peers on other chains not containing the snapshot block, until it actually has the blocks and undo data that would be needed to validate other chains. I think the current PR is not exactly doing this though. It looks like it will still download up to BLOCK_DOWNLOAD_WINDOW useless blocks on the peer's chain, starting at the fork point between the two chains, which is not great. It will also _not_  download later blocks after snapshot is validated, when undo data needed to enable a re-org becomes available.\r\n\r\n---\r\n\r\nOn the broader approach to downloading blocks when a snapshot is loaded:\r\n\r\nI'd agree now that the only sensible block downloading behavior for an unvalidated snapshot chainstate is to only download blocks after the snapshot (due to lack of undo data before then) and ignore any peers whose best blocks don't descend from the snapshot block.\r\n\r\nBut it is less clear which blocks should be downloaded and attached to the older chainstate, and whether it should target the most-work block or the snapshot block. Since d43a1f1a2fa35d377c7a9ad7ab92d1ae325bde3d from #27746 it targets the snapshot block, but was not doing that originally. Comparing the two alternatives:\r\n\r\n- Targeting the most-work block seems like a purer approach that would probably simplify the code and remove special cases, and would also have the benefit of the node syncing to the most-work chain faster, with less wasted work if it the chain turns out to be valid.\r\n  \r\n- Targeting the snapshot block is also very reasonable, and is what the code is doing currently, and guarantees the snapshot will be validated even if it is not used, and could be a practical defense against eclipse attacks, or fork chains that appear to have more work but turn out to be invalid.\r\n\r\n---\r\n\r\nOn whether we should care about any of this:\r\n\r\nI don't think we need to care about these design choices too much, since everything above is referring to a case we don't expect to encounter, where there is a possibly-valid chain of blocks, not including the snapshot block, that has more work than any known chain including the snapshot block. The only time when we should see this is when there is a major fork with a lot of work behind it.\r\n\r\nHowever, I don't think \"the premise that we could get into this situation should be rejected.\" That seems like it is going too far. We should put some thought into how code will behavior in presence for forks for practical reasons, and also to inform design of the code and to write it in a clean way that isn't full of assumptions and special cases.\r\n\r\nI do think, as long as we are hardcoding snapshot hashes in the source code, we can reject premise that snapshot chainstate turns out to be invalid, and just refuse to run in that case. But the case where the snapshot is valid, but the snapshot block is not on the most-work chain seems different and worth thinking about.",
      "commit_id" : "ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "created_at" : "2024-06-12T14:00:40Z",
      "diff_hunk" : "@@ -1397,9 +1397,12 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n         return;\n     }\n \n-    if (state->pindexLastCommonBlock == nullptr) {\n+    std::optional<int> snapshot_height{m_chainman.GetSnapshotBaseHeight()};\n+    if (state->pindexLastCommonBlock == nullptr ||\n+        (snapshot_height.has_value() && state->pindexLastCommonBlock->nHeight < snapshot_height.value())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1636522532",
      "id" : 1636522532,
      "in_reply_to_id" : 1628436308,
      "line" : 1402,
      "node_id" : "PRRC_kwDOABII585hi1ok",
      "original_commit_id" : "ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "original_line" : 1402,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2113123309,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1636522532/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-12T14:10:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1636522532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1636684790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1636684790"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> And you seem to be suggesting:\r\nLoading a snapshot should force a node to only consider chains that include the snapshot block and ignore other chains, even if they have more work.\r\n\r\nThis was meant more as a description of the status quo than a description of the ideal world. I think that with today's logic we don't really have another choice but to do so - temporarily until the background sync has finished.\r\n\r\n> but the snapshot block is not on the most-work chain seems different and worth thinking about\r\n\r\nI agree with that.Some possible ways to deal with that:\r\n\r\n1.) Tighten the criteria for snapshot acceptance: We could reject loading the snapshot if the snapshot block is not a predecessor of `m_best_header`. Currently, we only check that it has more work than the ActiveTip. This is easy to implement, though it doesn't cover the case where we only learn about the better chain after the snapshot has been loaded.\r\n\r\n2.) After a snapshot is accepted and we detect that the snapshot is no longer on the most-work chain we know of, we could abort syncing the snapshot, delete the chainstate and go back to normal sync mode. This sounds more complicated to implement, and I'm not convinced it's worth it.\r\n\r\n> It looks like it will still download up to BLOCK_DOWNLOAD_WINDOW useless blocks on the peer's chain, starting at the fork point between the two chains, which is not great. \r\n\r\nThat's true. I will try to adjust the PR to deal with that. Since I find the logic in `FindNextBlocksToDownload` / `TryDownloadingHistoricalBlocks` / `FindNextBlocks` rather hard to understand, I would like to reproduce the situation in a test (at least locally, sounds like timing issues could make this hard to include in a PR) to be more confident that this is really how it works, which could take a few days.",
      "commit_id" : "ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "created_at" : "2024-06-12T15:27:07Z",
      "diff_hunk" : "@@ -1397,9 +1397,12 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n         return;\n     }\n \n-    if (state->pindexLastCommonBlock == nullptr) {\n+    std::optional<int> snapshot_height{m_chainman.GetSnapshotBaseHeight()};\n+    if (state->pindexLastCommonBlock == nullptr ||\n+        (snapshot_height.has_value() && state->pindexLastCommonBlock->nHeight < snapshot_height.value())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1636684790",
      "id" : 1636684790,
      "in_reply_to_id" : 1628436308,
      "line" : 1402,
      "node_id" : "PRRC_kwDOABII585hjdP2",
      "original_commit_id" : "ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "original_line" : 1402,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2113389969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1636684790/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-12T15:27:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1636684790",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1640012446"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1640012446"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I have now added a first commit that avoids downloading blocks not on the snapshot chain completely.\r\nLocal testing revealed that not only are we unable to reorg to a more-work chain, we also won't fail gracefully: On master, we would still download the blocks and attempt to reorg, but then the node would just crash.",
      "commit_id" : "e977c698f97ac9bba30e4e3837f41721841c28c4",
      "created_at" : "2024-06-14T15:42:54Z",
      "diff_hunk" : "@@ -1397,9 +1397,12 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n         return;\n     }\n \n-    if (state->pindexLastCommonBlock == nullptr) {\n+    std::optional<int> snapshot_height{m_chainman.GetSnapshotBaseHeight()};\n+    if (state->pindexLastCommonBlock == nullptr ||\n+        (snapshot_height.has_value() && state->pindexLastCommonBlock->nHeight < snapshot_height.value())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1640012446",
      "id" : 1640012446,
      "in_reply_to_id" : 1628436308,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585hwJqe",
      "original_commit_id" : "ac547ea43beb1d66d2c11e7e8abb76dd1bfc2883",
      "original_line" : 1402,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 2118689259,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1640012446/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-14T15:42:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1640012446",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1644544564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644544564"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: A bit easier to parse IMO, only if you have to retouch. \r\n\r\n```suggestion\r\n    // When we sync with AssumeUtxo and discover the snapshot is not in the peer's best chain, abort:\r\n```",
      "commit_id" : "e977c698f97ac9bba30e4e3837f41721841c28c4",
      "created_at" : "2024-06-18T14:14:12Z",
      "diff_hunk" : "@@ -1397,6 +1397,14 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n         return;\n     }\n \n+    // When syncing with AssumeUtxo, if the snapshot is not in the peer's best chain, abort:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29519#discussion_r1644544564",
      "id" : 1644544564,
      "line" : 1400,
      "node_id" : "PRRC_kwDOABII585iBcI0",
      "original_commit_id" : "019fba99b0aed519ff3dc5f94cf85e26781c11f3",
      "original_line" : 1400,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2125652115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29519",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644544564/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-18T14:25:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644544564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
