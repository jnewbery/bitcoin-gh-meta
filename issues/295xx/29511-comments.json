[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29511).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2024-02-29T05:42:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29511#issuecomment-1970449304",
      "id" : 1970449304,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29511",
      "node_id" : "IC_kwDOABII5851cquY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1970449304/reactions"
      },
      "updated_at" : "2024-02-29T05:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1970449304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "One way to test this patch would be using this diff. The intermittent failure happens when v2 handshake is complete on the python side but not on bitcoind side. That is - bitcoind is in `SendState::READY` (meaning bitcoind has sent garbage terminator + version packet to our python `P2PInterface` and `wait_for_v2_handshake=True`) and `RecvState` paused in something like `RecvState::GARB_GARBTERM`.\r\n\r\n\r\nthis diff  delays the garbage terminator being sent from the python side using sleep so that bitcoind can be in `SendState::READY`  before `RecvState::GARB_GARBTERM`.\r\n\r\n\r\n```diff\r\ndiff --git a/test/functional/test_framework/p2p.py b/test/functional/test_framework/p2p.py\r\nindex dc04696114..b546bad4cf 100755\r\n--- a/test/functional/test_framework/p2p.py\r\n+++ b/test/functional/test_framework/p2p.py\r\n@@ -270,10 +270,10 @@ class P2PConnection(asyncio.Protocol):\r\n             # and sends response after deriving shared ECDH secret using received ellswift bytes\r\n             length, response = self.v2_state.complete_handshake(BytesIO(self.recvbuf))\r\n             self.recvbuf = self.recvbuf[length:]\r\n-            if response:\r\n-                self.send_raw_message(response)\r\n-            else:\r\n-                return  # only after response is sent can `authenticate_handshake()` be done\r\n \r\n         # `self.v2_state.peer` is instantiated only after shared ECDH secret/BIP324 derived keys and ciphers\r\n         # is derived in `complete_handshake()`.\r\n@@ -283,6 +283,9 @@ class P2PConnection(asyncio.Protocol):\r\n         if not is_mac_auth:\r\n             raise ValueError(\"invalid v2 mac tag in handshake authentication\")\r\n         self.recvbuf = self.recvbuf[length:]\r\n+        if response:\r\n+            import time; time.sleep(5)\r\n+            self.send_raw_message(response)\r\n         if self.v2_state.tried_v2_handshake:\r\n             # for v2 outbound connections, send version message immediately after v2 handshake\r\n             if self.p2p_connected_to_node:\r\n```",
      "created_at" : "2024-02-29T05:52:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29511#issuecomment-1970457608",
      "id" : 1970457608,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29511",
      "node_id" : "IC_kwDOABII5851cswI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1970457608/reactions"
      },
      "updated_at" : "2024-02-29T05:52:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1970457608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/44024636?v=4",
         "events_url" : "https://api.github.com/users/stratospher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stratospher/followers",
         "following_url" : "https://api.github.com/users/stratospher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stratospher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stratospher",
         "id" : 44024636,
         "login" : "stratospher",
         "node_id" : "MDQ6VXNlcjQ0MDI0NjM2",
         "organizations_url" : "https://api.github.com/users/stratospher/orgs",
         "received_events_url" : "https://api.github.com/users/stratospher/received_events",
         "repos_url" : "https://api.github.com/users/stratospher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stratospher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stratospher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stratospher"
      }
   }
]
