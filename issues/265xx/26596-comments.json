[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/26596).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29124](https://github.com/bitcoin/bitcoin/pull/29124) (wallet: Automatically repair corrupted metadata with doubled derivation path by achow101)\n* [#28574](https://github.com/bitcoin/bitcoin/pull/28574) (wallet: optimize migration process, batch db transactions by furszy)\n* [#28333](https://github.com/bitcoin/bitcoin/pull/28333) (wallet: Construct ScriptPubKeyMans with all data rather than loaded progressively by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-11-28T23:46:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1329892984",
      "id" : 1329892984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585PRI54",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329892984/reactions"
      },
      "updated_at" : "2024-06-05T21:17:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1329892984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think it would be easier to review if you made a separate PR for `BerkeleyRODatabase` and have it work as a regular, albeit read-only, wallet database backend.\r\n\r\nI'm pleasantly surprised at how small the implementation is.",
      "created_at" : "2022-11-29T14:41:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1330751869",
      "id" : 1330751869,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585PUal9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1330751869/reactions"
      },
      "updated_at" : "2022-11-29T14:41:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1330751869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't see how reimplementing BDB is better than just continuing to use BDB.",
      "created_at" : "2022-11-29T21:20:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1331324928",
      "id" : 1331324928,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585PWmgA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331324928/reactions"
      },
      "updated_at" : "2022-11-29T21:20:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331324928",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I don't see how reimplementing BDB is better than just continuing to use BDB.\r\n\r\nThe reimplementation is quite compact because it is for only reading BDB files, only the features that we use, and none of the actual DB system stuff. BDB itself contains a ton of code, a lot of which we don't use. Maintaining it as a dependency will eventually be more burdensome - we already need to patch it in order to compile in the depends system. This reimplementation does not carry those issues - it implements a format that isn't going to change, and it only depends on things that are already being used elsewhere in the codebase.",
      "created_at" : "2022-11-29T21:27:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1331335069",
      "id" : 1331335069,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585PWo-d",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331335069/reactions"
      },
      "updated_at" : "2022-11-29T21:27:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331335069",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think it would be easier to review if you made a separate PR for `BerkeleyRODatabase` and have it work as a regular, albeit read-only, wallet database backend.\r\n\r\nI've opeend #26606 for just `BerkeleyRODatabase` and its use in wallettool's `dump`.",
      "created_at" : "2022-11-29T21:51:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1331368146",
      "id" : 1331368146,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585PWxDS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331368146/reactions"
      },
      "updated_at" : "2022-11-29T21:51:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1331368146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-12-01T11:03:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1333588093",
      "id" : 1333588093,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585PfPB9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1333588093/reactions"
      },
      "updated_at" : "2022-12-01T11:03:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1333588093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-02-01T16:01:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1412303408",
      "id" : 1412303408,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585ULgow",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412303408/reactions"
      },
      "updated_at" : "2023-02-01T16:01:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1412303408",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-02-17T19:14:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1435121273",
      "id" : 1435121273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585VijZ5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435121273/reactions"
      },
      "updated_at" : "2023-02-17T19:14:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435121273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-06-28T01:13:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1610437195",
      "id" : 1610437195,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585f_VJL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1610437195/reactions"
      },
      "updated_at" : "2023-06-28T01:13:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1610437195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-09-19T18:18:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1726259633",
      "id" : 1726259633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585m5KGx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1726259633/reactions"
      },
      "updated_at" : "2023-09-19T18:18:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1726259633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-10-23T23:35:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1776215815",
      "id" : 1776215815,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585p3ucH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776215815/reactions"
      },
      "updated_at" : "2023-10-23T23:35:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1776215815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-12-14T21:55:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1856721246",
      "id" : 1856721246,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585uq1Fe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1856721246/reactions"
      },
      "updated_at" : "2023-12-14T21:55:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1856721246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-01-05T18:33:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1879100436",
      "id" : 1879100436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585wAMwU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1879100436/reactions"
      },
      "updated_at" : "2024-01-05T18:33:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1879100436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-01-31T22:27:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1920090244",
      "id" : 1920090244,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585yckCE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1920090244/reactions"
      },
      "updated_at" : "2024-01-31T22:27:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1920090244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-02-03T04:54:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1925096912",
      "id" : 1925096912,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585yvqXQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1925096912/reactions"
      },
      "updated_at" : "2024-02-03T04:54:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1925096912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-02-06T18:07:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1930492695",
      "id" : 1930492695,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585zEPsX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1930492695/reactions"
      },
      "updated_at" : "2024-02-06T18:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1930492695",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/21780750809</sub>",
      "created_at" : "2024-02-28T06:51:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-1968341832",
      "id" : 1968341832,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII5851UoNI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1968341832/reactions"
      },
      "updated_at" : "2024-02-28T06:51:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1968341832",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-05-21T13:13:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-2122610387",
      "id" : 2122610387,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585-hHbT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2122610387/reactions"
      },
      "updated_at" : "2024-05-21T13:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2122610387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased following #26606. Now ready for review.",
      "created_at" : "2024-05-21T16:47:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-2123038131",
      "id" : 2123038131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII585-iv2z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2123038131/reactions"
      },
      "updated_at" : "2024-05-21T16:47:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2123038131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1621331017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621331017"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why reset `require_format` here? Seems `options` is not going to be read by anything after this line and none of the database types is holding a reference to it.\r\n\r\nAvoiding that would mean that you could introduce more immutability around line 4386:\r\n```\r\n    const DatabaseOptions options{\r\n        .require_existing = true,\r\n        .require_format = DatabaseFormat::BERKELEY_RO,\r\n    };\r\n```",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-05-30T19:22:30Z",
      "diff_hunk" : "@@ -4438,6 +4465,7 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     // both before and after reloading. This ensures the set is complete even if one of the wallets\n     // fails to reload.\n     std::set<fs::path> wallet_dirs;\n+    options.require_format = std::nullopt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1621331017",
      "id" : 1621331017,
      "line" : 4487,
      "node_id" : "PRRC_kwDOABII585go4xJ",
      "original_commit_id" : "37df50fffab9de7862e56df84d72756e5308aed2",
      "original_line" : 4487,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 137,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621331017/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621331017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1621407661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621407661"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    // Only create base LegacyDataSPKM if using BERKELEY_RO\r\n    std::unique_ptr<ScriptPubKeyMan> spk_manager = m_database->Format() == \"bdb_ro\" ?\r\n        std::make_unique<LegacyDataSPKM>(*this) :\r\n        std::make_unique<LegacyScriptPubKeyMan>(*this, m_keypool_size);\r\n```",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-05-30T20:42:50Z",
      "diff_hunk" : "@@ -3618,13 +3628,26 @@ void CWallet::AddScriptPubKeyMan(const uint256& id, std::unique_ptr<ScriptPubKey\n     MaybeUpdateBirthTime(spkm->GetTimeFirstKey());\n }\n \n+LegacyDataSPKM* CWallet::GetOrCreateLegacyDataSPKM()\n+{\n+    SetupLegacyScriptPubKeyMan();\n+    return GetLegacyDataSPKM();\n+}\n+\n void CWallet::SetupLegacyScriptPubKeyMan()\n {\n     if (!m_internal_spk_managers.empty() || !m_external_spk_managers.empty() || !m_spk_managers.empty() || IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n         return;\n     }\n \n-    auto spk_manager = std::unique_ptr<ScriptPubKeyMan>(new LegacyScriptPubKeyMan(*this, m_keypool_size));\n+    std::unique_ptr<ScriptPubKeyMan> spk_manager;\n+\n+    // Only create base LegacyDataSPKM if using BERKELEY_RO\n+    if (m_database->Format() == \"bdb_ro\") {\n+        spk_manager = std::unique_ptr<ScriptPubKeyMan>(new LegacyDataSPKM(*this));\n+    } else {\n+        spk_manager = std::unique_ptr<ScriptPubKeyMan>(new LegacyScriptPubKeyMan(*this, m_keypool_size));\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1621407661",
      "id" : 1621407661,
      "line" : 3659,
      "node_id" : "PRRC_kwDOABII585gpLet",
      "original_commit_id" : "20c8fd5dfc2dec2b46ad70bd1dcad5ba289cb889",
      "original_line" : 3659,
      "original_position" : 41,
      "original_start_line" : 3643,
      "path" : "src/wallet/wallet.cpp",
      "position" : 78,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621407661/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 3652,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621407661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1624612271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624612271"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Loading the entire wallet just to obtain the descriptors flag shouldn't be needed. Could just check the file type instead. We want a bdb file here. So, something like https://github.com/furszy/bitcoin-core/commit/7a03a039ae99e69504fe9df95b04f5e326c45a70 would work well. Yet, the code isn't the best but it includes a test that verifies the behavior.",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-03T14:59:38Z",
      "diff_hunk" : "@@ -4346,11 +4346,37 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     // If the wallet is still loaded, unload it so that nothing else tries to use it while we're changing it\n     bool was_loaded = false;\n     if (auto wallet = GetWallet(context, wallet_name)) {\n+        if (wallet->IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+            return util::Error{_(\"Error: This wallet is already a descriptor wallet\")};\n+        }\n+\n         if (!RemoveWallet(context, wallet, /*load_on_start=*/std::nullopt, warnings)) {\n             return util::Error{_(\"Unable to unload the wallet before migrating\")};\n         }\n         UnloadWallet(std::move(wallet));\n         was_loaded = true;\n+    } else {\n+        // We need to load this wallet to check if there's something to migrate.\n+        // But this cannot be reused later since we want to use BERKELEY_RO for the actual migration\n+        WalletContext empty_context;\n+        empty_context.args = context.args;\n+        DatabaseOptions options;\n+        options.require_existing = true;\n+        DatabaseStatus status;\n+        std::unique_ptr<WalletDatabase> database = MakeWalletDatabase(wallet_name, options, status, error);\n+        if (!database) {\n+            return util::Error{Untranslated(\"Wallet file verification failed.\") + Untranslated(\" \") + error};\n+        }\n+        wallet = CWallet::Create(empty_context, wallet_name, std::move(database), options.create_flags, error, warnings);\n+        if (!wallet) {\n+            return util::Error{Untranslated(\"Wallet loading failed.\") + Untranslated(\" \") + error};\n+        }\n+\n+        if (wallet->IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+            return util::Error{_(\"Error: This wallet is already a descriptor wallet\")};\n+        }\n+        // Unload\n+        wallet.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1624612271",
      "id" : 1624612271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585g1Z2v",
      "original_commit_id" : "37df50fffab9de7862e56df84d72756e5308aed2",
      "original_line" : 4379,
      "original_position" : 34,
      "original_start_line" : 4359,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 2094130903,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624612271/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-03T14:59:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624612271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1626748082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1626748082"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, I think the original intention was to be able to handle the legacy-sqlite case, but that's moot since we require BDB_RO later. I've changed this to check for just look for BDB files, and also added your test.",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-04T23:34:51Z",
      "diff_hunk" : "@@ -4346,11 +4346,37 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     // If the wallet is still loaded, unload it so that nothing else tries to use it while we're changing it\n     bool was_loaded = false;\n     if (auto wallet = GetWallet(context, wallet_name)) {\n+        if (wallet->IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+            return util::Error{_(\"Error: This wallet is already a descriptor wallet\")};\n+        }\n+\n         if (!RemoveWallet(context, wallet, /*load_on_start=*/std::nullopt, warnings)) {\n             return util::Error{_(\"Unable to unload the wallet before migrating\")};\n         }\n         UnloadWallet(std::move(wallet));\n         was_loaded = true;\n+    } else {\n+        // We need to load this wallet to check if there's something to migrate.\n+        // But this cannot be reused later since we want to use BERKELEY_RO for the actual migration\n+        WalletContext empty_context;\n+        empty_context.args = context.args;\n+        DatabaseOptions options;\n+        options.require_existing = true;\n+        DatabaseStatus status;\n+        std::unique_ptr<WalletDatabase> database = MakeWalletDatabase(wallet_name, options, status, error);\n+        if (!database) {\n+            return util::Error{Untranslated(\"Wallet file verification failed.\") + Untranslated(\" \") + error};\n+        }\n+        wallet = CWallet::Create(empty_context, wallet_name, std::move(database), options.create_flags, error, warnings);\n+        if (!wallet) {\n+            return util::Error{Untranslated(\"Wallet loading failed.\") + Untranslated(\" \") + error};\n+        }\n+\n+        if (wallet->IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n+            return util::Error{_(\"Error: This wallet is already a descriptor wallet\")};\n+        }\n+        // Unload\n+        wallet.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1626748082",
      "id" : 1626748082,
      "in_reply_to_id" : 1624612271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585g9jSy",
      "original_commit_id" : "37df50fffab9de7862e56df84d72756e5308aed2",
      "original_line" : 4379,
      "original_position" : 34,
      "original_start_line" : 4359,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 2097582404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1626748082/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-04T23:34:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1626748082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628300902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628300902"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This class and possibly `LegacyScriptPubKeyMan` below could do with comments summarizing their responsibilities since breaking them apart and naming one `LegacyDataSPKM` makes things less clear.",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-05T19:04:29Z",
      "diff_hunk" : "@@ -276,31 +276,106 @@ static const std::unordered_set<OutputType> LEGACY_OUTPUT_TYPES {\n \n class DescriptorScriptPubKeyMan;\n \n-class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProvider\n+class LegacyDataSPKM : public ScriptPubKeyMan, public FillableSigningProvider",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628300902",
      "id" : 1628300902,
      "line" : 279,
      "node_id" : "PRRC_kwDOABII585hDeZm",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 279,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 5,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628300902/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628300902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628371045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628371045"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This comment goes on to say `AddWatchOnly(const CScript&)` is an inherited virtual method which appears untrue. Maybe add an extra commit ahead of the others that tidies up that comment?",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-05T20:04:11Z",
      "diff_hunk" : "@@ -276,31 +276,106 @@ static const std::unordered_set<OutputType> LEGACY_OUTPUT_TYPES {\n \n class DescriptorScriptPubKeyMan;\n \n-class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProvider\n+class LegacyDataSPKM : public ScriptPubKeyMan, public FillableSigningProvider\n {\n-private:\n-    //! keeps track of whether Unlock has run a thorough check before\n-    bool fDecryptionThoroughlyChecked = true;\n-\n+protected:\n     using WatchOnlySet = std::set<CScript>;\n     using WatchKeyMap = std::map<CKeyID, CPubKey>;\n-\n-    WalletBatch *encrypted_batch GUARDED_BY(cs_KeyStore) = nullptr;\n-\n     using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n \n     CryptedKeyMap mapCryptedKeys GUARDED_BY(cs_KeyStore);\n     WatchOnlySet setWatchOnly GUARDED_BY(cs_KeyStore);\n     WatchKeyMap mapWatchKeys GUARDED_BY(cs_KeyStore);\n \n+    /* the HD chain data model (external chain counters) */\n+    CHDChain m_hd_chain;\n+    std::unordered_map<CKeyID, CHDChain, SaltedSipHasher> m_inactive_hd_chains;\n+\n+    //! keeps track of whether Unlock has run a thorough check before\n+    bool fDecryptionThoroughlyChecked = true;\n+\n+    bool AddWatchOnlyInMem(const CScript &dest);\n+    virtual bool AddKeyPubKeyInner(const CKey& key, const CPubKey &pubkey);\n+    bool AddCryptedKeyInner(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret);\n+\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;\n+\n+    // Map from Key ID to key metadata.\n+    std::map<CKeyID, CKeyMetadata> mapKeyMetadata GUARDED_BY(cs_KeyStore);\n+\n+    // Map from Script ID to key metadata (for watch-only keys).\n+    std::map<CScriptID, CKeyMetadata> m_script_metadata GUARDED_BY(cs_KeyStore);\n+\n+    // ScriptPubKeyMan overrides\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key) override;\n+    std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\n+    std::unique_ptr<SigningProvider> GetSolvingProvider(const CScript& script) const override;\n+    uint256 GetID() const override { return uint256::ONE; }\n+\n+    // FillableSigningProvider overrides\n+    bool HaveKey(const CKeyID &address) const override;\n+    bool GetKey(const CKeyID &address, CKey& keyOut) const override;\n+    bool GetPubKey(const CKeyID &address, CPubKey& vchPubKeyOut) const override;\n+    bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    std::set<int64_t> setInternalKeyPool GUARDED_BY(cs_KeyStore);\n+    std::set<int64_t> setExternalKeyPool GUARDED_BY(cs_KeyStore);\n+    std::set<int64_t> set_pre_split_keypool GUARDED_BY(cs_KeyStore);\n+    int64_t m_max_keypool_index GUARDED_BY(cs_KeyStore) = 0;\n+    std::map<CKeyID, int64_t> m_pool_key_to_index;\n+\n+    //! Load metadata (used by LoadWallet)\n+    virtual void LoadKeyMetadata(const CKeyID& keyID, const CKeyMetadata &metadata);\n+    virtual void LoadScriptMetadata(const CScriptID& script_id, const CKeyMetadata &metadata);\n+\n+    //! Adds a watch-only address to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadWatchOnly(const CScript &dest);\n+    //! Returns whether the watch-only script is in the wallet\n+    bool HaveWatchOnly(const CScript &dest) const;\n+    //! Returns whether there are any watch-only things in the wallet\n+    bool HaveWatchOnly() const;\n+    //! Adds a key to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadKey(const CKey& key, const CPubKey &pubkey);\n+    //! Adds an encrypted key to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret, bool checksum_valid);\n+    //! Adds a CScript to the store\n+    bool LoadCScript(const CScript& redeemScript);\n+    //! Load a HD chain model (used by LoadWallet)\n+    void LoadHDChain(const CHDChain& chain);\n+    void AddInactiveHDChain(const CHDChain& chain);\n+    const CHDChain& GetHDChain() const { return m_hd_chain; }\n+    //! Load a keypool entry\n+    void LoadKeyPool(int64_t nIndex, const CKeyPool &keypool);\n+\n+    //! Fetches a pubkey from mapWatchKeys if it exists there\n+    bool GetWatchPubKey(const CKeyID &address, CPubKey &pubkey_out) const;\n+\n+    /**\n+     * Retrieves scripts that were imported by bugs into the legacy spkm and are\n+     * simply invalid, such as a sh(sh(pkh())) script, or not watched.\n+     */\n+    std::unordered_set<CScript, SaltedSipHasher> GetNotMineScriptPubKeys() const;\n+\n+    /** Get the DescriptorScriptPubKeyMans (with private keys) that have the same scriptPubKeys as this LegacyScriptPubKeyMan.\n+     * Does not modify this ScriptPubKeyMan. */\n+    std::optional<MigrationData> MigrateToDescriptor();\n+    /** Delete all the records ofthis LegacyScriptPubKeyMan from disk*/\n+    bool DeleteRecords();\n+};\n+\n+class LegacyScriptPubKeyMan : public LegacyDataSPKM\n+{\n+private:\n+    WalletBatch *encrypted_batch GUARDED_BY(cs_KeyStore) = nullptr;\n+\n     // By default, do not scan any block until keys/scripts are generated/imported\n     int64_t nTimeFirstKey GUARDED_BY(cs_KeyStore) = UNKNOWN_TIME;\n \n     //! Number of pre-generated keys/scripts (part of the look-ahead process, used to detect payments)\n     int64_t m_keypool_size GUARDED_BY(cs_KeyStore){DEFAULT_KEYPOOL_SIZE};\n \n-    bool AddKeyPubKeyInner(const CKey& key, const CPubKey &pubkey);\n-    bool AddCryptedKeyInner(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret);\n+    bool AddKeyPubKeyInner(const CKey& key, const CPubKey &pubkey) override;\n \n     /**\n      * Private version of AddWatchOnly method which does not accept a",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628371045",
      "id" : 1628371045,
      "line" : 381,
      "node_id" : "PRRC_kwDOABII585hDvhl",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 381,
      "original_position" : 116,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 116,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628371045/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628371045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628376667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628376667"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "*`\"Error reading wallet database: LegacyDataSPKM::LoadKey failed\"`, same for `LoadCryptedKey` and `LoadCScript` below.",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-05T20:10:06Z",
      "diff_hunk" : "@@ -354,7 +354,7 @@ bool LoadKey(CWallet* pwallet, DataStream& ssKey, DataStream& ssValue, std::stri\n             strErr = \"Error reading wallet database: CPrivKey corrupt\";\n             return false;\n         }\n-        if (!pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKey(key, vchPubKey))\n+        if (!pwallet->GetOrCreateLegacyDataSPKM()->LoadKey(key, vchPubKey))\n         {\n             strErr = \"Error reading wallet database: LegacyScriptPubKeyMan::LoadKey failed\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628376667",
      "id" : 1628376667,
      "line" : 359,
      "node_id" : "PRRC_kwDOABII585hDw5b",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 359,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 7,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628376667/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628376667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628391489"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628391489"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(`\"Make a *LegacyDataSPKM and set it...\"`. Similar need for update in wallet.cpp around line 3019 before call to `SetupLegacyScriptPubKeyMan()`.)",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-05T20:25:16Z",
      "diff_hunk" : "@@ -961,6 +961,8 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     //! Get the LegacyScriptPubKeyMan which is used for all types, internal, and external.\n     LegacyScriptPubKeyMan* GetLegacyScriptPubKeyMan() const;\n     LegacyScriptPubKeyMan* GetOrCreateLegacyScriptPubKeyMan();\n+    LegacyDataSPKM* GetLegacyDataSPKM() const;\n+    LegacyDataSPKM* GetOrCreateLegacyDataSPKM();\n \n     //! Make a LegacyScriptPubKeyMan and set it for all types, internal, and external.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628391489",
      "id" : 1628391489,
      "line" : 967,
      "node_id" : "PRRC_kwDOABII585hD0hB",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 967,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 7,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628391489/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628391489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628408816"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628408816"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could be marked `static`?",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-05T20:42:31Z",
      "diff_hunk" : "@@ -2923,7 +2923,7 @@ bool CWallet::EraseAddressReceiveRequest(WalletBatch& batch, const CTxDestinatio\n     return true;\n }\n \n-std::unique_ptr<WalletDatabase> MakeWalletDatabase(const std::string& name, const DatabaseOptions& options, DatabaseStatus& status, bilingual_str& error_string)\n+util::Result<fs::path> GetWalletPath(const std::string& name)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628408816",
      "id" : 1628408816,
      "line" : 2926,
      "node_id" : "PRRC_kwDOABII585hD4vw",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 2926,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628408816/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628408816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628438776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628438776"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit 46520aacc43dd42a7968587ab9ece488bbe9503d: Should this line have been removed in the following commit (31e918afc3920a2f8aa367ad323f590b4856aa26)?",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-05T21:07:05Z",
      "diff_hunk" : "@@ -1887,7 +1886,6 @@ std::optional<MigrationData> LegacyScriptPubKeyMan::MigrateToDescriptor()\n             for (const CScript& spk : desc_spks) {\n                 size_t erased = spks.erase(spk);\n                 assert(erased == 1);\n-                assert(IsMine(spk) == ISMINE_SPENDABLE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628438776",
      "id" : 1628438776,
      "line" : 1869,
      "node_id" : "PRRC_kwDOABII585hEAD4",
      "original_commit_id" : "46520aacc43dd42a7968587ab9ece488bbe9503d",
      "original_line" : 1890,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 437,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628438776/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628438776",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628463550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628463550"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This was removed in e11fa4524723aebc0d879ee083c2d6d46849d89a but probably shouldn't have been included in 84a5fb96382960300ebbd2cf2fe8756142bea572 (verified through compiling on that commit + with it removed).",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-05T21:28:25Z",
      "diff_hunk" : "@@ -500,7 +500,6 @@ class LegacyScriptPubKeyMan : public LegacyDataSPKM\n \n     /* Set the HD chain model (chain child index counters) and writes it to the database */\n     void AddHDChain(const CHDChain& chain);\n-    const CHDChain& GetHDChain() const { return m_hd_chain; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628463550",
      "id" : 1628463550,
      "line" : 455,
      "node_id" : "PRRC_kwDOABII585hEGG-",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 503,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 4,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628463550/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628463550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628492436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628492436"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Worth adding a comment about the consequences of setting `keypool_size=0`? I'm guessing there are still cases where we generate some pubkeys despite having a zero pool size, otherwise you would have removed some of the code and the for-loop below?",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-05T22:04:32Z",
      "diff_hunk" : "@@ -1812,7 +1953,7 @@ std::optional<MigrationData> LegacyScriptPubKeyMan::MigrateToDescriptor()\n         WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n \n         // Make the DescriptorScriptPubKeyMan and get the scriptPubKeys\n-        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, m_keypool_size));\n+        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, /*keypool_size=*/0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628492436",
      "id" : 1628492436,
      "line" : 1956,
      "node_id" : "PRRC_kwDOABII585hENKU",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 1956,
      "original_position" : 412,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 412,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628492436/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628492436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628499316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628499316"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Might as well use `make_unique` on the lines you modify:\r\n```suggestion\r\n        auto desc_spk_man = std::make_unique<DescriptorScriptPubKeyMan>(m_storage, w_desc, /*keypool_size=*/0);\r\n```",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-05T22:13:48Z",
      "diff_hunk" : "@@ -1812,7 +1953,7 @@ std::optional<MigrationData> LegacyScriptPubKeyMan::MigrateToDescriptor()\n         WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n \n         // Make the DescriptorScriptPubKeyMan and get the scriptPubKeys\n-        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, m_keypool_size));\n+        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, /*keypool_size=*/0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628499316",
      "id" : 1628499316,
      "line" : 1956,
      "node_id" : "PRRC_kwDOABII585hEO10",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 1956,
      "original_position" : 412,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 412,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628499316/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628499316",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628506276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628506276"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why not `OrCreate` here any longer?",
      "commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "created_at" : "2024-06-05T22:25:00Z",
      "diff_hunk" : "@@ -763,7 +763,7 @@ static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch,\n \n         // nTimeFirstKey is only reliable if all keys have metadata\n         if (pwallet->IsLegacy() && (key_res.m_records + ckey_res.m_records + watch_script_res.m_records) != (keymeta_res.m_records + watch_meta_res.m_records)) {\n-            auto spk_man = pwallet->GetOrCreateLegacyScriptPubKeyMan();\n+            auto spk_man = pwallet->GetLegacyScriptPubKeyMan();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628506276",
      "id" : 1628506276,
      "line" : 766,
      "node_id" : "PRRC_kwDOABII585hEQik",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 766,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 86,
      "pull_request_review_id" : 2089208116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628506276/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-05T22:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628506276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Is the goal to delete `LegacyScriptPubKeyMan` in the future when ripping out BDB and only keep `LegacyDataSPKM`?\r\n\r\nYes.\r\n\r\nWe are trying to remove the legacy wallet in its entirety, leaving only behind the absolute minimum necessary to perform migration.\r\n\r\n> Why perform the inlining of `IsMine()` in [31e918a](https://github.com/bitcoin/bitcoin/commit/31e918afc3920a2f8aa367ad323f590b4856aa26) before the function is removed? Seems risky in case of other PRs modifying it prior to removal etc.\r\n\r\n`IsMine()` is unlikely to change. Besides the fact that any changes to the legacy wallet are likely to be closed instead of seriously considered, `IsMine()` has not had any material changes in the last several years. It could be included in #28710 but that PR is big enough as it is.\r\n\r\n> `LegacyScriptPubKeyMan::NewKeyPool()` only touches data from `LegacyDataSPKM`, should it be moved to that class as public (or protected and then exposed in the subclass?)\r\n\r\nNo. The separation exists now to indicate which things can be removed at the end. `LegacyDataSPKM` is the bare minimum that must stick around for migration, everything else remains in `LegacyScriptPubKeyMan` and will be removed at the same time.",
      "created_at" : "2024-06-06T00:36:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#issuecomment-2151172675",
      "id" : 2151172675,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26596",
      "node_id" : "IC_kwDOABII586AOEpD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2151172675/reactions"
      },
      "updated_at" : "2024-06-06T00:36:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2151172675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628597865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628597865"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's used by the `reload_wallet` calls which capture it.",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T00:51:53Z",
      "diff_hunk" : "@@ -4438,6 +4465,7 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     // both before and after reloading. This ensures the set is complete even if one of the wallets\n     // fails to reload.\n     std::set<fs::path> wallet_dirs;\n+    options.require_format = std::nullopt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628597865",
      "id" : 1628597865,
      "in_reply_to_id" : 1621331017,
      "line" : 4483,
      "node_id" : "PRRC_kwDOABII585hEm5p",
      "original_commit_id" : "37df50fffab9de7862e56df84d72756e5308aed2",
      "original_line" : 4483,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 133,
      "pull_request_review_id" : 2100541202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628597865/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T00:51:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628597865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628598230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628598230"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it's necessary to add changes that correct this documentation when it's all going to be deleted soon anyways.",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T00:52:34Z",
      "diff_hunk" : "@@ -276,31 +276,106 @@ static const std::unordered_set<OutputType> LEGACY_OUTPUT_TYPES {\n \n class DescriptorScriptPubKeyMan;\n \n-class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProvider\n+class LegacyDataSPKM : public ScriptPubKeyMan, public FillableSigningProvider\n {\n-private:\n-    //! keeps track of whether Unlock has run a thorough check before\n-    bool fDecryptionThoroughlyChecked = true;\n-\n+protected:\n     using WatchOnlySet = std::set<CScript>;\n     using WatchKeyMap = std::map<CKeyID, CPubKey>;\n-\n-    WalletBatch *encrypted_batch GUARDED_BY(cs_KeyStore) = nullptr;\n-\n     using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n \n     CryptedKeyMap mapCryptedKeys GUARDED_BY(cs_KeyStore);\n     WatchOnlySet setWatchOnly GUARDED_BY(cs_KeyStore);\n     WatchKeyMap mapWatchKeys GUARDED_BY(cs_KeyStore);\n \n+    /* the HD chain data model (external chain counters) */\n+    CHDChain m_hd_chain;\n+    std::unordered_map<CKeyID, CHDChain, SaltedSipHasher> m_inactive_hd_chains;\n+\n+    //! keeps track of whether Unlock has run a thorough check before\n+    bool fDecryptionThoroughlyChecked = true;\n+\n+    bool AddWatchOnlyInMem(const CScript &dest);\n+    virtual bool AddKeyPubKeyInner(const CKey& key, const CPubKey &pubkey);\n+    bool AddCryptedKeyInner(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret);\n+\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;\n+\n+    // Map from Key ID to key metadata.\n+    std::map<CKeyID, CKeyMetadata> mapKeyMetadata GUARDED_BY(cs_KeyStore);\n+\n+    // Map from Script ID to key metadata (for watch-only keys).\n+    std::map<CScriptID, CKeyMetadata> m_script_metadata GUARDED_BY(cs_KeyStore);\n+\n+    // ScriptPubKeyMan overrides\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key) override;\n+    std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\n+    std::unique_ptr<SigningProvider> GetSolvingProvider(const CScript& script) const override;\n+    uint256 GetID() const override { return uint256::ONE; }\n+\n+    // FillableSigningProvider overrides\n+    bool HaveKey(const CKeyID &address) const override;\n+    bool GetKey(const CKeyID &address, CKey& keyOut) const override;\n+    bool GetPubKey(const CKeyID &address, CPubKey& vchPubKeyOut) const override;\n+    bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    std::set<int64_t> setInternalKeyPool GUARDED_BY(cs_KeyStore);\n+    std::set<int64_t> setExternalKeyPool GUARDED_BY(cs_KeyStore);\n+    std::set<int64_t> set_pre_split_keypool GUARDED_BY(cs_KeyStore);\n+    int64_t m_max_keypool_index GUARDED_BY(cs_KeyStore) = 0;\n+    std::map<CKeyID, int64_t> m_pool_key_to_index;\n+\n+    //! Load metadata (used by LoadWallet)\n+    virtual void LoadKeyMetadata(const CKeyID& keyID, const CKeyMetadata &metadata);\n+    virtual void LoadScriptMetadata(const CScriptID& script_id, const CKeyMetadata &metadata);\n+\n+    //! Adds a watch-only address to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadWatchOnly(const CScript &dest);\n+    //! Returns whether the watch-only script is in the wallet\n+    bool HaveWatchOnly(const CScript &dest) const;\n+    //! Returns whether there are any watch-only things in the wallet\n+    bool HaveWatchOnly() const;\n+    //! Adds a key to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadKey(const CKey& key, const CPubKey &pubkey);\n+    //! Adds an encrypted key to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret, bool checksum_valid);\n+    //! Adds a CScript to the store\n+    bool LoadCScript(const CScript& redeemScript);\n+    //! Load a HD chain model (used by LoadWallet)\n+    void LoadHDChain(const CHDChain& chain);\n+    void AddInactiveHDChain(const CHDChain& chain);\n+    const CHDChain& GetHDChain() const { return m_hd_chain; }\n+    //! Load a keypool entry\n+    void LoadKeyPool(int64_t nIndex, const CKeyPool &keypool);\n+\n+    //! Fetches a pubkey from mapWatchKeys if it exists there\n+    bool GetWatchPubKey(const CKeyID &address, CPubKey &pubkey_out) const;\n+\n+    /**\n+     * Retrieves scripts that were imported by bugs into the legacy spkm and are\n+     * simply invalid, such as a sh(sh(pkh())) script, or not watched.\n+     */\n+    std::unordered_set<CScript, SaltedSipHasher> GetNotMineScriptPubKeys() const;\n+\n+    /** Get the DescriptorScriptPubKeyMans (with private keys) that have the same scriptPubKeys as this LegacyScriptPubKeyMan.\n+     * Does not modify this ScriptPubKeyMan. */\n+    std::optional<MigrationData> MigrateToDescriptor();\n+    /** Delete all the records ofthis LegacyScriptPubKeyMan from disk*/\n+    bool DeleteRecords();\n+};\n+\n+class LegacyScriptPubKeyMan : public LegacyDataSPKM\n+{\n+private:\n+    WalletBatch *encrypted_batch GUARDED_BY(cs_KeyStore) = nullptr;\n+\n     // By default, do not scan any block until keys/scripts are generated/imported\n     int64_t nTimeFirstKey GUARDED_BY(cs_KeyStore) = UNKNOWN_TIME;\n \n     //! Number of pre-generated keys/scripts (part of the look-ahead process, used to detect payments)\n     int64_t m_keypool_size GUARDED_BY(cs_KeyStore){DEFAULT_KEYPOOL_SIZE};\n \n-    bool AddKeyPubKeyInner(const CKey& key, const CPubKey &pubkey);\n-    bool AddCryptedKeyInner(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret);\n+    bool AddKeyPubKeyInner(const CKey& key, const CPubKey &pubkey) override;\n \n     /**\n      * Private version of AddWatchOnly method which does not accept a",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628598230",
      "id" : 1628598230,
      "in_reply_to_id" : 1628371045,
      "line" : 384,
      "node_id" : "PRRC_kwDOABII585hEm_W",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 384,
      "original_position" : 116,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 119,
      "pull_request_review_id" : 2100543305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628598230/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T00:52:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628598230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628598636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628598636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The function still creates a `LegacyScriptPubKeyMan` in normal operation.",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T00:53:14Z",
      "diff_hunk" : "@@ -961,6 +961,8 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     //! Get the LegacyScriptPubKeyMan which is used for all types, internal, and external.\n     LegacyScriptPubKeyMan* GetLegacyScriptPubKeyMan() const;\n     LegacyScriptPubKeyMan* GetOrCreateLegacyScriptPubKeyMan();\n+    LegacyDataSPKM* GetLegacyDataSPKM() const;\n+    LegacyDataSPKM* GetOrCreateLegacyDataSPKM();\n \n     //! Make a LegacyScriptPubKeyMan and set it for all types, internal, and external.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628598636",
      "id" : 1628598636,
      "in_reply_to_id" : 1628391489,
      "line" : 967,
      "node_id" : "PRRC_kwDOABII585hEnFs",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 967,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 7,
      "pull_request_review_id" : 2100545260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628598636/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T00:53:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628598636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628600303"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628600303"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No. `LegacyDataSPKM` does not have an `IsMine()` function, so this call needs to be removed otherwise it will not compile.",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T00:55:35Z",
      "diff_hunk" : "@@ -1887,7 +1886,6 @@ std::optional<MigrationData> LegacyScriptPubKeyMan::MigrateToDescriptor()\n             for (const CScript& spk : desc_spks) {\n                 size_t erased = spks.erase(spk);\n                 assert(erased == 1);\n-                assert(IsMine(spk) == ISMINE_SPENDABLE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628600303",
      "id" : 1628600303,
      "in_reply_to_id" : 1628438776,
      "line" : 1869,
      "node_id" : "PRRC_kwDOABII585hEnfv",
      "original_commit_id" : "46520aacc43dd42a7968587ab9ece488bbe9503d",
      "original_line" : 1869,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 437,
      "pull_request_review_id" : 2100552437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628600303/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T00:55:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628600303",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628603057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628603057"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this needs to have any additional explanation. `keypool_size` only matters for ranged descriptors. Non-HD keys do not make ranged descriptors, so the value here is ignored. The loop below is for an entirely different set of descriptors and is unrelated to this.",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T00:58:50Z",
      "diff_hunk" : "@@ -1812,7 +1953,7 @@ std::optional<MigrationData> LegacyScriptPubKeyMan::MigrateToDescriptor()\n         WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n \n         // Make the DescriptorScriptPubKeyMan and get the scriptPubKeys\n-        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, m_keypool_size));\n+        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, /*keypool_size=*/0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628603057",
      "id" : 1628603057,
      "in_reply_to_id" : 1628492436,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585hEoKx",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 1956,
      "original_position" : 412,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 2100558263,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628603057/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T00:58:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628603057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628610626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628610626"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's redundant since `IsLegacy()` ensures the existence of a `LegacyScriptPubKeyMan`, so there's no need to try to create one.",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T01:07:26Z",
      "diff_hunk" : "@@ -763,7 +763,7 @@ static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch,\n \n         // nTimeFirstKey is only reliable if all keys have metadata\n         if (pwallet->IsLegacy() && (key_res.m_records + ckey_res.m_records + watch_script_res.m_records) != (keymeta_res.m_records + watch_meta_res.m_records)) {\n-            auto spk_man = pwallet->GetOrCreateLegacyScriptPubKeyMan();\n+            auto spk_man = pwallet->GetLegacyScriptPubKeyMan();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628610626",
      "id" : 1628610626,
      "in_reply_to_id" : 1628506276,
      "line" : 766,
      "node_id" : "PRRC_kwDOABII585hEqBC",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 766,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 95,
      "pull_request_review_id" : 2100571255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628610626/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T01:07:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628610626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612108"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T01:09:03Z",
      "diff_hunk" : "@@ -3618,13 +3628,26 @@ void CWallet::AddScriptPubKeyMan(const uint256& id, std::unique_ptr<ScriptPubKey\n     MaybeUpdateBirthTime(spkm->GetTimeFirstKey());\n }\n \n+LegacyDataSPKM* CWallet::GetOrCreateLegacyDataSPKM()\n+{\n+    SetupLegacyScriptPubKeyMan();\n+    return GetLegacyDataSPKM();\n+}\n+\n void CWallet::SetupLegacyScriptPubKeyMan()\n {\n     if (!m_internal_spk_managers.empty() || !m_external_spk_managers.empty() || !m_spk_managers.empty() || IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS)) {\n         return;\n     }\n \n-    auto spk_manager = std::unique_ptr<ScriptPubKeyMan>(new LegacyScriptPubKeyMan(*this, m_keypool_size));\n+    std::unique_ptr<ScriptPubKeyMan> spk_manager;\n+\n+    // Only create base LegacyDataSPKM if using BERKELEY_RO\n+    if (m_database->Format() == \"bdb_ro\") {\n+        spk_manager = std::unique_ptr<ScriptPubKeyMan>(new LegacyDataSPKM(*this));\n+    } else {\n+        spk_manager = std::unique_ptr<ScriptPubKeyMan>(new LegacyScriptPubKeyMan(*this, m_keypool_size));\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612108",
      "id" : 1628612108,
      "in_reply_to_id" : 1621407661,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585hEqYM",
      "original_commit_id" : "20c8fd5dfc2dec2b46ad70bd1dcad5ba289cb889",
      "original_line" : 3659,
      "original_position" : 41,
      "original_start_line" : 3643,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 2100574081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612108/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-06T01:09:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612254"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Add a comment to each",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T01:09:11Z",
      "diff_hunk" : "@@ -276,31 +276,106 @@ static const std::unordered_set<OutputType> LEGACY_OUTPUT_TYPES {\n \n class DescriptorScriptPubKeyMan;\n \n-class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProvider\n+class LegacyDataSPKM : public ScriptPubKeyMan, public FillableSigningProvider",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612254",
      "id" : 1628612254,
      "in_reply_to_id" : 1628300902,
      "line" : 281,
      "node_id" : "PRRC_kwDOABII585hEqae",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 281,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 7,
      "pull_request_review_id" : 2100574368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612254/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T01:09:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612380"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612380"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T01:09:19Z",
      "diff_hunk" : "@@ -354,7 +354,7 @@ bool LoadKey(CWallet* pwallet, DataStream& ssKey, DataStream& ssValue, std::stri\n             strErr = \"Error reading wallet database: CPrivKey corrupt\";\n             return false;\n         }\n-        if (!pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadKey(key, vchPubKey))\n+        if (!pwallet->GetOrCreateLegacyDataSPKM()->LoadKey(key, vchPubKey))\n         {\n             strErr = \"Error reading wallet database: LegacyScriptPubKeyMan::LoadKey failed\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612380",
      "id" : 1628612380,
      "in_reply_to_id" : 1628376667,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585hEqcc",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 359,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 2100574577,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612380/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T01:09:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612380",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612502"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612502"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T01:09:25Z",
      "diff_hunk" : "@@ -2923,7 +2923,7 @@ bool CWallet::EraseAddressReceiveRequest(WalletBatch& batch, const CTxDestinatio\n     return true;\n }\n \n-std::unique_ptr<WalletDatabase> MakeWalletDatabase(const std::string& name, const DatabaseOptions& options, DatabaseStatus& status, bilingual_str& error_string)\n+util::Result<fs::path> GetWalletPath(const std::string& name)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612502",
      "id" : 1628612502,
      "in_reply_to_id" : 1628408816,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585hEqeW",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 2926,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 2100574748,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612502/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T01:09:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612502",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612617"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T01:09:32Z",
      "diff_hunk" : "@@ -500,7 +500,6 @@ class LegacyScriptPubKeyMan : public LegacyDataSPKM\n \n     /* Set the HD chain model (chain child index counters) and writes it to the database */\n     void AddHDChain(const CHDChain& chain);\n-    const CHDChain& GetHDChain() const { return m_hd_chain; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612617",
      "id" : 1628612617,
      "in_reply_to_id" : 1628463550,
      "line" : 455,
      "node_id" : "PRRC_kwDOABII585hEqgJ",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 455,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 203,
      "pull_request_review_id" : 2100574901,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612617/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T01:09:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612697"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T01:09:38Z",
      "diff_hunk" : "@@ -1812,7 +1953,7 @@ std::optional<MigrationData> LegacyScriptPubKeyMan::MigrateToDescriptor()\n         WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n \n         // Make the DescriptorScriptPubKeyMan and get the scriptPubKeys\n-        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, m_keypool_size));\n+        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, /*keypool_size=*/0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1628612697",
      "id" : 1628612697,
      "in_reply_to_id" : 1628499316,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585hEqhZ",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 1956,
      "original_position" : 412,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 2100575063,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612697/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T01:09:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1628612697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629131375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629131375"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, sorry for missing that. Worth an explaining comment like `\"Reset require_format since reload_wallet will only be called on non-Berkeley DB sub-wallets from here on.\"` or something more correct?",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T09:32:50Z",
      "diff_hunk" : "@@ -4438,6 +4465,7 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     // both before and after reloading. This ensures the set is complete even if one of the wallets\n     // fails to reload.\n     std::set<fs::path> wallet_dirs;\n+    options.require_format = std::nullopt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629131375",
      "id" : 1629131375,
      "in_reply_to_id" : 1621331017,
      "line" : 4483,
      "node_id" : "PRRC_kwDOABII585hGpJv",
      "original_commit_id" : "37df50fffab9de7862e56df84d72756e5308aed2",
      "original_line" : 4483,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 133,
      "pull_request_review_id" : 2101437428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629131375/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T09:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629131375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629143813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629143813"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`LegacyScriptPubKeyMan` is a `LegacyDataSPKM`, so the comment would be more correct, but it could be corrected later when removing `LegacyScriptPubKeyMan` - unless you plan to rename `LegacyDataSPKM` back into `LegacyScriptPubKeyMan` once the deletion of the latter is complete.",
      "commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "created_at" : "2024-06-06T09:40:13Z",
      "diff_hunk" : "@@ -961,6 +961,8 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     //! Get the LegacyScriptPubKeyMan which is used for all types, internal, and external.\n     LegacyScriptPubKeyMan* GetLegacyScriptPubKeyMan() const;\n     LegacyScriptPubKeyMan* GetOrCreateLegacyScriptPubKeyMan();\n+    LegacyDataSPKM* GetLegacyDataSPKM() const;\n+    LegacyDataSPKM* GetOrCreateLegacyDataSPKM();\n \n     //! Make a LegacyScriptPubKeyMan and set it for all types, internal, and external.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629143813",
      "id" : 1629143813,
      "in_reply_to_id" : 1628391489,
      "line" : 967,
      "node_id" : "PRRC_kwDOABII585hGsMF",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 967,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 7,
      "pull_request_review_id" : 2101465697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629143813/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T09:40:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629143813",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629164462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629164462"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n// Implements the full legacy wallet behavior\r\n// Slated for deletion once Berkeley DB library dependency is removed.\r\nclass LegacyScriptPubKeyMan : public LegacyDataSPKM\r\n```",
      "commit_id" : "a8f8a2d5d0e2328cbe2e569c7e12f653d18f456d",
      "created_at" : "2024-06-06T09:48:54Z",
      "diff_hunk" : "@@ -276,31 +276,109 @@ static const std::unordered_set<OutputType> LEGACY_OUTPUT_TYPES {\n \n class DescriptorScriptPubKeyMan;\n \n-class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProvider\n+// Manages the data for a LegacyScriptPubKeyMan.\n+// This is the minimum necessary to load a legacy wallet so that it can be migrated.\n+class LegacyDataSPKM : public ScriptPubKeyMan, public FillableSigningProvider\n {\n-private:\n-    //! keeps track of whether Unlock has run a thorough check before\n-    bool fDecryptionThoroughlyChecked = true;\n-\n+protected:\n     using WatchOnlySet = std::set<CScript>;\n     using WatchKeyMap = std::map<CKeyID, CPubKey>;\n-\n-    WalletBatch *encrypted_batch GUARDED_BY(cs_KeyStore) = nullptr;\n-\n     using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n \n     CryptedKeyMap mapCryptedKeys GUARDED_BY(cs_KeyStore);\n     WatchOnlySet setWatchOnly GUARDED_BY(cs_KeyStore);\n     WatchKeyMap mapWatchKeys GUARDED_BY(cs_KeyStore);\n \n+    /* the HD chain data model (external chain counters) */\n+    CHDChain m_hd_chain;\n+    std::unordered_map<CKeyID, CHDChain, SaltedSipHasher> m_inactive_hd_chains;\n+\n+    //! keeps track of whether Unlock has run a thorough check before\n+    bool fDecryptionThoroughlyChecked = true;\n+\n+    bool AddWatchOnlyInMem(const CScript &dest);\n+    virtual bool AddKeyPubKeyInner(const CKey& key, const CPubKey &pubkey);\n+    bool AddCryptedKeyInner(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret);\n+\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;\n+\n+    // Map from Key ID to key metadata.\n+    std::map<CKeyID, CKeyMetadata> mapKeyMetadata GUARDED_BY(cs_KeyStore);\n+\n+    // Map from Script ID to key metadata (for watch-only keys).\n+    std::map<CScriptID, CKeyMetadata> m_script_metadata GUARDED_BY(cs_KeyStore);\n+\n+    // ScriptPubKeyMan overrides\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key) override;\n+    std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\n+    std::unique_ptr<SigningProvider> GetSolvingProvider(const CScript& script) const override;\n+    uint256 GetID() const override { return uint256::ONE; }\n+\n+    // FillableSigningProvider overrides\n+    bool HaveKey(const CKeyID &address) const override;\n+    bool GetKey(const CKeyID &address, CKey& keyOut) const override;\n+    bool GetPubKey(const CKeyID &address, CPubKey& vchPubKeyOut) const override;\n+    bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    std::set<int64_t> setInternalKeyPool GUARDED_BY(cs_KeyStore);\n+    std::set<int64_t> setExternalKeyPool GUARDED_BY(cs_KeyStore);\n+    std::set<int64_t> set_pre_split_keypool GUARDED_BY(cs_KeyStore);\n+    int64_t m_max_keypool_index GUARDED_BY(cs_KeyStore) = 0;\n+    std::map<CKeyID, int64_t> m_pool_key_to_index;\n+\n+    //! Load metadata (used by LoadWallet)\n+    virtual void LoadKeyMetadata(const CKeyID& keyID, const CKeyMetadata &metadata);\n+    virtual void LoadScriptMetadata(const CScriptID& script_id, const CKeyMetadata &metadata);\n+\n+    //! Adds a watch-only address to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadWatchOnly(const CScript &dest);\n+    //! Returns whether the watch-only script is in the wallet\n+    bool HaveWatchOnly(const CScript &dest) const;\n+    //! Returns whether there are any watch-only things in the wallet\n+    bool HaveWatchOnly() const;\n+    //! Adds a key to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadKey(const CKey& key, const CPubKey &pubkey);\n+    //! Adds an encrypted key to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret, bool checksum_valid);\n+    //! Adds a CScript to the store\n+    bool LoadCScript(const CScript& redeemScript);\n+    //! Load a HD chain model (used by LoadWallet)\n+    void LoadHDChain(const CHDChain& chain);\n+    void AddInactiveHDChain(const CHDChain& chain);\n+    const CHDChain& GetHDChain() const { return m_hd_chain; }\n+    //! Load a keypool entry\n+    void LoadKeyPool(int64_t nIndex, const CKeyPool &keypool);\n+\n+    //! Fetches a pubkey from mapWatchKeys if it exists there\n+    bool GetWatchPubKey(const CKeyID &address, CPubKey &pubkey_out) const;\n+\n+    /**\n+     * Retrieves scripts that were imported by bugs into the legacy spkm and are\n+     * simply invalid, such as a sh(sh(pkh())) script, or not watched.\n+     */\n+    std::unordered_set<CScript, SaltedSipHasher> GetNotMineScriptPubKeys() const;\n+\n+    /** Get the DescriptorScriptPubKeyMans (with private keys) that have the same scriptPubKeys as this LegacyScriptPubKeyMan.\n+     * Does not modify this ScriptPubKeyMan. */\n+    std::optional<MigrationData> MigrateToDescriptor();\n+    /** Delete all the records ofthis LegacyScriptPubKeyMan from disk*/\n+    bool DeleteRecords();\n+};\n+\n+// Implements the full legacy wallet behavior\n+class LegacyScriptPubKeyMan : public LegacyDataSPKM",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629164462",
      "id" : 1629164462,
      "line" : 370,
      "node_id" : "PRRC_kwDOABII585hGxOu",
      "original_commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "original_line" : 370,
      "original_position" : 103,
      "original_start_line" : 369,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 103,
      "pull_request_review_id" : 2101490760,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629164462/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 369,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-06T10:59:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629164462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629293058"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629293058"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Haven't fully grokked the code yet, so I understand if you'd rather not answer my questions, but if you want:\r\n\r\n> I don't think this needs to have any additional explanation. keypool_size only matters for ranged descriptors. Non-HD keys do not make ranged descriptors, so the value here is ignored. \r\n\r\nWe're in an HD chain `for`-loop, how is this not involving HD keys?\r\nSurely legacy wallets could be HD wallets.\r\n\r\n> The loop below is for an entirely different set of descriptors and is unrelated to this.\r\n\r\nI'm referring to the loop over `desc_spks` which is using the pubkeys from the `DescriptorScriptPubKeyMan` that's just been created and comes from `DescriptorScriptPubKeyMan::m_map_script_pub_keys` which is filled out in `DescriptorScriptPubKeyMan::TopUpWithDB()` which is affected by `m_keypool_size`.\r\n\r\nWould `m_keypool_size` already always be `0` before this change?",
      "commit_id" : "a8f8a2d5d0e2328cbe2e569c7e12f653d18f456d",
      "created_at" : "2024-06-06T10:59:44Z",
      "diff_hunk" : "@@ -1812,7 +1953,7 @@ std::optional<MigrationData> LegacyScriptPubKeyMan::MigrateToDescriptor()\n         WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n \n         // Make the DescriptorScriptPubKeyMan and get the scriptPubKeys\n-        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, m_keypool_size));\n+        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, /*keypool_size=*/0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629293058",
      "id" : 1629293058,
      "in_reply_to_id" : 1628492436,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585hHQoC",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 1956,
      "original_position" : 412,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 2101490760,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629293058/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T10:59:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629293058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629801393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629801393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the meaning is well understood, both before and after `LegacyScriptPubKeyMan` is deleted. `SPKM` is an abbreviation for `ScriptPubKeyMan` anyways.\r\n\r\nChanged it to `Legacy(Data)SPKM`.",
      "commit_id" : "a8f8a2d5d0e2328cbe2e569c7e12f653d18f456d",
      "created_at" : "2024-06-06T15:57:32Z",
      "diff_hunk" : "@@ -961,6 +961,8 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     //! Get the LegacyScriptPubKeyMan which is used for all types, internal, and external.\n     LegacyScriptPubKeyMan* GetLegacyScriptPubKeyMan() const;\n     LegacyScriptPubKeyMan* GetOrCreateLegacyScriptPubKeyMan();\n+    LegacyDataSPKM* GetLegacyDataSPKM() const;\n+    LegacyDataSPKM* GetOrCreateLegacyDataSPKM();\n \n     //! Make a LegacyScriptPubKeyMan and set it for all types, internal, and external.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629801393",
      "id" : 1629801393,
      "in_reply_to_id" : 1628391489,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585hJMux",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 967,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 2102387625,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629801393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T16:12:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629801393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629814874"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629814874"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The line this comment is on is in the one that goes over the non-HD keys. However, I see that you're confused about the similar line in the loop below that iterates the hd chains.\r\n\r\nThe `keypool_size` here is a runtime value that depends on the startup options. It's is set when the `DescriptorScriptPubKeyman` is instantiated on loading, and the value is never directly persisted to disk. It ends up written as part of `range_end` when `range_end` is updated during `TopUp()`, but `range_end` can also be set directly.\r\n\r\nThe value that does matter is the `range_end` stored in `WalletDescriptor`. When we are going over the hd chains, we set  `range_end` to match the chain counter stored in the `CHDChain` that is being migrated. This results in a descriptor that will produce exactly the same scriptPubKeys as the original hd chain, including it's keypool. We are enforcing that the migrated descriptors produce exactly the same scriptPubKeys (no more, no less). Setting `keypool_size` could mean that `TopUp()` would generate *more* scriptPubKeys than we need/expect, which would cause migration to assert and crash.",
      "commit_id" : "a8f8a2d5d0e2328cbe2e569c7e12f653d18f456d",
      "created_at" : "2024-06-06T16:07:35Z",
      "diff_hunk" : "@@ -1812,7 +1953,7 @@ std::optional<MigrationData> LegacyScriptPubKeyMan::MigrateToDescriptor()\n         WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n \n         // Make the DescriptorScriptPubKeyMan and get the scriptPubKeys\n-        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, m_keypool_size));\n+        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, /*keypool_size=*/0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629814874",
      "id" : 1629814874,
      "in_reply_to_id" : 1628492436,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585hJQBa",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 1956,
      "original_position" : 412,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 2102409360,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629814874/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T16:11:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629814874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629821488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629821488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment.",
      "commit_id" : "a8f8a2d5d0e2328cbe2e569c7e12f653d18f456d",
      "created_at" : "2024-06-06T16:12:27Z",
      "diff_hunk" : "@@ -4438,6 +4465,7 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     // both before and after reloading. This ensures the set is complete even if one of the wallets\n     // fails to reload.\n     std::set<fs::path> wallet_dirs;\n+    options.require_format = std::nullopt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629821488",
      "id" : 1629821488,
      "in_reply_to_id" : 1621331017,
      "line" : 4484,
      "node_id" : "PRRC_kwDOABII585hJRow",
      "original_commit_id" : "37df50fffab9de7862e56df84d72756e5308aed2",
      "original_line" : 4484,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 134,
      "pull_request_review_id" : 2102419939,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629821488/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T16:12:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629821488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629823159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629823159"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it's necessary to have a comment saying such.",
      "commit_id" : "a8f8a2d5d0e2328cbe2e569c7e12f653d18f456d",
      "created_at" : "2024-06-06T16:13:49Z",
      "diff_hunk" : "@@ -276,31 +276,109 @@ static const std::unordered_set<OutputType> LEGACY_OUTPUT_TYPES {\n \n class DescriptorScriptPubKeyMan;\n \n-class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProvider\n+// Manages the data for a LegacyScriptPubKeyMan.\n+// This is the minimum necessary to load a legacy wallet so that it can be migrated.\n+class LegacyDataSPKM : public ScriptPubKeyMan, public FillableSigningProvider\n {\n-private:\n-    //! keeps track of whether Unlock has run a thorough check before\n-    bool fDecryptionThoroughlyChecked = true;\n-\n+protected:\n     using WatchOnlySet = std::set<CScript>;\n     using WatchKeyMap = std::map<CKeyID, CPubKey>;\n-\n-    WalletBatch *encrypted_batch GUARDED_BY(cs_KeyStore) = nullptr;\n-\n     using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n \n     CryptedKeyMap mapCryptedKeys GUARDED_BY(cs_KeyStore);\n     WatchOnlySet setWatchOnly GUARDED_BY(cs_KeyStore);\n     WatchKeyMap mapWatchKeys GUARDED_BY(cs_KeyStore);\n \n+    /* the HD chain data model (external chain counters) */\n+    CHDChain m_hd_chain;\n+    std::unordered_map<CKeyID, CHDChain, SaltedSipHasher> m_inactive_hd_chains;\n+\n+    //! keeps track of whether Unlock has run a thorough check before\n+    bool fDecryptionThoroughlyChecked = true;\n+\n+    bool AddWatchOnlyInMem(const CScript &dest);\n+    virtual bool AddKeyPubKeyInner(const CKey& key, const CPubKey &pubkey);\n+    bool AddCryptedKeyInner(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret);\n+\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;\n+\n+    // Map from Key ID to key metadata.\n+    std::map<CKeyID, CKeyMetadata> mapKeyMetadata GUARDED_BY(cs_KeyStore);\n+\n+    // Map from Script ID to key metadata (for watch-only keys).\n+    std::map<CScriptID, CKeyMetadata> m_script_metadata GUARDED_BY(cs_KeyStore);\n+\n+    // ScriptPubKeyMan overrides\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key) override;\n+    std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\n+    std::unique_ptr<SigningProvider> GetSolvingProvider(const CScript& script) const override;\n+    uint256 GetID() const override { return uint256::ONE; }\n+\n+    // FillableSigningProvider overrides\n+    bool HaveKey(const CKeyID &address) const override;\n+    bool GetKey(const CKeyID &address, CKey& keyOut) const override;\n+    bool GetPubKey(const CKeyID &address, CPubKey& vchPubKeyOut) const override;\n+    bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    std::set<int64_t> setInternalKeyPool GUARDED_BY(cs_KeyStore);\n+    std::set<int64_t> setExternalKeyPool GUARDED_BY(cs_KeyStore);\n+    std::set<int64_t> set_pre_split_keypool GUARDED_BY(cs_KeyStore);\n+    int64_t m_max_keypool_index GUARDED_BY(cs_KeyStore) = 0;\n+    std::map<CKeyID, int64_t> m_pool_key_to_index;\n+\n+    //! Load metadata (used by LoadWallet)\n+    virtual void LoadKeyMetadata(const CKeyID& keyID, const CKeyMetadata &metadata);\n+    virtual void LoadScriptMetadata(const CScriptID& script_id, const CKeyMetadata &metadata);\n+\n+    //! Adds a watch-only address to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadWatchOnly(const CScript &dest);\n+    //! Returns whether the watch-only script is in the wallet\n+    bool HaveWatchOnly(const CScript &dest) const;\n+    //! Returns whether there are any watch-only things in the wallet\n+    bool HaveWatchOnly() const;\n+    //! Adds a key to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadKey(const CKey& key, const CPubKey &pubkey);\n+    //! Adds an encrypted key to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret, bool checksum_valid);\n+    //! Adds a CScript to the store\n+    bool LoadCScript(const CScript& redeemScript);\n+    //! Load a HD chain model (used by LoadWallet)\n+    void LoadHDChain(const CHDChain& chain);\n+    void AddInactiveHDChain(const CHDChain& chain);\n+    const CHDChain& GetHDChain() const { return m_hd_chain; }\n+    //! Load a keypool entry\n+    void LoadKeyPool(int64_t nIndex, const CKeyPool &keypool);\n+\n+    //! Fetches a pubkey from mapWatchKeys if it exists there\n+    bool GetWatchPubKey(const CKeyID &address, CPubKey &pubkey_out) const;\n+\n+    /**\n+     * Retrieves scripts that were imported by bugs into the legacy spkm and are\n+     * simply invalid, such as a sh(sh(pkh())) script, or not watched.\n+     */\n+    std::unordered_set<CScript, SaltedSipHasher> GetNotMineScriptPubKeys() const;\n+\n+    /** Get the DescriptorScriptPubKeyMans (with private keys) that have the same scriptPubKeys as this LegacyScriptPubKeyMan.\n+     * Does not modify this ScriptPubKeyMan. */\n+    std::optional<MigrationData> MigrateToDescriptor();\n+    /** Delete all the records ofthis LegacyScriptPubKeyMan from disk*/\n+    bool DeleteRecords();\n+};\n+\n+// Implements the full legacy wallet behavior\n+class LegacyScriptPubKeyMan : public LegacyDataSPKM",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1629823159",
      "id" : 1629823159,
      "in_reply_to_id" : 1629164462,
      "line" : 370,
      "node_id" : "PRRC_kwDOABII585hJSC3",
      "original_commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "original_line" : 370,
      "original_position" : 103,
      "original_start_line" : 369,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 103,
      "pull_request_review_id" : 2102422707,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629823159/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 369,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-06T16:13:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629823159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1630046789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1630046789"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If the code is unable to communicate why it is like it is, it's good to explain the otherwise surprising state of it. It would hopefully limit the amount of questions like my prior one from https://github.com/bitcoin/bitcoin/pull/26596#pullrequestreview-2089208116:\r\n> `LegacyScriptPubKeyMan::NewKeyPool()` only touches data from `LegacyDataSPKM`, should it be moved to that class as public (or protected and then exposed in the subclass?). \r\n\r\n But I guess you're fairly confident it will be deleted in time for the next release anyway.",
      "commit_id" : "a8f8a2d5d0e2328cbe2e569c7e12f653d18f456d",
      "created_at" : "2024-06-06T18:48:05Z",
      "diff_hunk" : "@@ -276,31 +276,109 @@ static const std::unordered_set<OutputType> LEGACY_OUTPUT_TYPES {\n \n class DescriptorScriptPubKeyMan;\n \n-class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProvider\n+// Manages the data for a LegacyScriptPubKeyMan.\n+// This is the minimum necessary to load a legacy wallet so that it can be migrated.\n+class LegacyDataSPKM : public ScriptPubKeyMan, public FillableSigningProvider\n {\n-private:\n-    //! keeps track of whether Unlock has run a thorough check before\n-    bool fDecryptionThoroughlyChecked = true;\n-\n+protected:\n     using WatchOnlySet = std::set<CScript>;\n     using WatchKeyMap = std::map<CKeyID, CPubKey>;\n-\n-    WalletBatch *encrypted_batch GUARDED_BY(cs_KeyStore) = nullptr;\n-\n     using CryptedKeyMap = std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>>;\n \n     CryptedKeyMap mapCryptedKeys GUARDED_BY(cs_KeyStore);\n     WatchOnlySet setWatchOnly GUARDED_BY(cs_KeyStore);\n     WatchKeyMap mapWatchKeys GUARDED_BY(cs_KeyStore);\n \n+    /* the HD chain data model (external chain counters) */\n+    CHDChain m_hd_chain;\n+    std::unordered_map<CKeyID, CHDChain, SaltedSipHasher> m_inactive_hd_chains;\n+\n+    //! keeps track of whether Unlock has run a thorough check before\n+    bool fDecryptionThoroughlyChecked = true;\n+\n+    bool AddWatchOnlyInMem(const CScript &dest);\n+    virtual bool AddKeyPubKeyInner(const CKey& key, const CPubKey &pubkey);\n+    bool AddCryptedKeyInner(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret);\n+\n+public:\n+    using ScriptPubKeyMan::ScriptPubKeyMan;\n+\n+    // Map from Key ID to key metadata.\n+    std::map<CKeyID, CKeyMetadata> mapKeyMetadata GUARDED_BY(cs_KeyStore);\n+\n+    // Map from Script ID to key metadata (for watch-only keys).\n+    std::map<CScriptID, CKeyMetadata> m_script_metadata GUARDED_BY(cs_KeyStore);\n+\n+    // ScriptPubKeyMan overrides\n+    bool CheckDecryptionKey(const CKeyingMaterial& master_key) override;\n+    std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\n+    std::unique_ptr<SigningProvider> GetSolvingProvider(const CScript& script) const override;\n+    uint256 GetID() const override { return uint256::ONE; }\n+\n+    // FillableSigningProvider overrides\n+    bool HaveKey(const CKeyID &address) const override;\n+    bool GetKey(const CKeyID &address, CKey& keyOut) const override;\n+    bool GetPubKey(const CKeyID &address, CPubKey& vchPubKeyOut) const override;\n+    bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    std::set<int64_t> setInternalKeyPool GUARDED_BY(cs_KeyStore);\n+    std::set<int64_t> setExternalKeyPool GUARDED_BY(cs_KeyStore);\n+    std::set<int64_t> set_pre_split_keypool GUARDED_BY(cs_KeyStore);\n+    int64_t m_max_keypool_index GUARDED_BY(cs_KeyStore) = 0;\n+    std::map<CKeyID, int64_t> m_pool_key_to_index;\n+\n+    //! Load metadata (used by LoadWallet)\n+    virtual void LoadKeyMetadata(const CKeyID& keyID, const CKeyMetadata &metadata);\n+    virtual void LoadScriptMetadata(const CScriptID& script_id, const CKeyMetadata &metadata);\n+\n+    //! Adds a watch-only address to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadWatchOnly(const CScript &dest);\n+    //! Returns whether the watch-only script is in the wallet\n+    bool HaveWatchOnly(const CScript &dest) const;\n+    //! Returns whether there are any watch-only things in the wallet\n+    bool HaveWatchOnly() const;\n+    //! Adds a key to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadKey(const CKey& key, const CPubKey &pubkey);\n+    //! Adds an encrypted key to the store, without saving it to disk (used by LoadWallet)\n+    bool LoadCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret, bool checksum_valid);\n+    //! Adds a CScript to the store\n+    bool LoadCScript(const CScript& redeemScript);\n+    //! Load a HD chain model (used by LoadWallet)\n+    void LoadHDChain(const CHDChain& chain);\n+    void AddInactiveHDChain(const CHDChain& chain);\n+    const CHDChain& GetHDChain() const { return m_hd_chain; }\n+    //! Load a keypool entry\n+    void LoadKeyPool(int64_t nIndex, const CKeyPool &keypool);\n+\n+    //! Fetches a pubkey from mapWatchKeys if it exists there\n+    bool GetWatchPubKey(const CKeyID &address, CPubKey &pubkey_out) const;\n+\n+    /**\n+     * Retrieves scripts that were imported by bugs into the legacy spkm and are\n+     * simply invalid, such as a sh(sh(pkh())) script, or not watched.\n+     */\n+    std::unordered_set<CScript, SaltedSipHasher> GetNotMineScriptPubKeys() const;\n+\n+    /** Get the DescriptorScriptPubKeyMans (with private keys) that have the same scriptPubKeys as this LegacyScriptPubKeyMan.\n+     * Does not modify this ScriptPubKeyMan. */\n+    std::optional<MigrationData> MigrateToDescriptor();\n+    /** Delete all the records ofthis LegacyScriptPubKeyMan from disk*/\n+    bool DeleteRecords();\n+};\n+\n+// Implements the full legacy wallet behavior\n+class LegacyScriptPubKeyMan : public LegacyDataSPKM",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1630046789",
      "id" : 1630046789,
      "in_reply_to_id" : 1629164462,
      "line" : 370,
      "node_id" : "PRRC_kwDOABII585hKIpF",
      "original_commit_id" : "31632d18ea122def82820770f14d9aa009726114",
      "original_line" : 370,
      "original_position" : 103,
      "original_start_line" : 369,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 103,
      "pull_request_review_id" : 2102949629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1630046789/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 369,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-06T18:48:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1630046789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1630064452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1630064452"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for taking the time to clarify this matter!",
      "commit_id" : "a8f8a2d5d0e2328cbe2e569c7e12f653d18f456d",
      "created_at" : "2024-06-06T18:57:24Z",
      "diff_hunk" : "@@ -1812,7 +1953,7 @@ std::optional<MigrationData> LegacyScriptPubKeyMan::MigrateToDescriptor()\n         WalletDescriptor w_desc(std::move(desc), creation_time, 0, 0, 0);\n \n         // Make the DescriptorScriptPubKeyMan and get the scriptPubKeys\n-        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, m_keypool_size));\n+        auto desc_spk_man = std::unique_ptr<DescriptorScriptPubKeyMan>(new DescriptorScriptPubKeyMan(m_storage, w_desc, /*keypool_size=*/0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26596#discussion_r1630064452",
      "id" : 1630064452,
      "in_reply_to_id" : 1628492436,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585hKM9E",
      "original_commit_id" : "e11fa4524723aebc0d879ee083c2d6d46849d89a",
      "original_line" : 1956,
      "original_position" : 412,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 2102980515,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1630064452/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T18:57:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1630064452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
         "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cbergqvist/followers",
         "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cbergqvist",
         "id" : 581308,
         "login" : "cbergqvist",
         "node_id" : "MDQ6VXNlcjU4MTMwOA==",
         "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
         "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
         "repos_url" : "https://api.github.com/users/cbergqvist/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cbergqvist"
      }
   }
]
