[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hi @reivanen, thanks for your report.\r\n\r\nIt is documented in https://github.com/bitcoin/bitcoin/blob/master/doc/reduce-memory.md#in-memory-caches that higher dbcache settings give better IBD performance, and I think it stands to reason that this effect would be more pronounced on slower hardware.\r\n\r\nI do agree though that it could be stated more clearly (other than in a doc titled \"reduce memory\") that this known effect occurs.\r\n\r\nThere is also a somewhat-related [PR open ](https://github.com/bitcoin/bitcoin/pull/28358)to increase the maximum dbcache value, to further speed up IBD.\r\n\r\nIn my opinion the current program model of having a constrained memory footprint is preferable to making it unconstrained. If you want to speed up IDB then you can temporarily increase your cache size (to another known maximum size), and after IDB is complete and you are in sync, the (known) memory constraints make Bitcoin Core a more stable program to run and use overall.\r\n\r\nAdditionally, having the program notified that \"memory is running out\" is often more simply said-than-done, usually requiring workarounds which also in turn can make other internals harder to reason about than fixed sizes.\r\n\r\nI have a spinning HDD so may get around to try your cache size cutoff and see if I can also notice the performance differences you mention.",
      "created_at" : "2024-03-08T17:01:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986067957",
      "id" : 1986067957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
      "node_id" : "IC_kwDOABII5852YP31",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986067957/reactions"
      },
      "updated_at" : "2024-03-08T17:01:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986067957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "This is not just an issue of \"better performance with larger dbcache\" but a completely different way of working (depending on how much dbcache is used of total allocated?).\r\n\r\nI tested by increasing the network speed to 2MB/s. It worked as good as with 1, HDD was more than able to keep up. Until RAM usage had gone to around 8000 used from 8500 total, then the 100% IO READ started and download happening only a fraction of the time. Restart bitcoin, and it continues to download at 2MB/s continuously, presumably until 8 gigs of ram has filled.\r\n\r\nSo after these data points i don't see any other easy \"fix\" than making the default dbcache size large enough to properly process segwit blocks, and then purge the cache every time it is starting to fill up, before the \"phase change\" happens in cache behavior.\r\n\r\nI should not need to periodically restart bitcoin to make it work properly. (also it seems like the source i read is outdated, because currently the whole chainstate does not seem to fit into 8 gigs and it starts throttling DL speed due to the random reads. I will test with dbcache 10000 if it will finally sync to the end properly.",
      "created_at" : "2024-03-09T10:56:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986824229",
      "id" : 1986824229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
      "node_id" : "IC_kwDOABII5852bIgl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986824229/reactions"
      },
      "updated_at" : "2024-03-09T12:26:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986824229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6353462?v=4",
         "events_url" : "https://api.github.com/users/reivanen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/reivanen/followers",
         "following_url" : "https://api.github.com/users/reivanen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/reivanen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/reivanen",
         "id" : 6353462,
         "login" : "reivanen",
         "node_id" : "MDQ6VXNlcjYzNTM0NjI=",
         "organizations_url" : "https://api.github.com/users/reivanen/orgs",
         "received_events_url" : "https://api.github.com/users/reivanen/received_events",
         "repos_url" : "https://api.github.com/users/reivanen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/reivanen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/reivanen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/reivanen"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "One more data point came to mind: this seems to be related to segwit?\r\n\r\nBecause i was able to properly process the blockchain until around segwit activation using 450MB dbcache. But after that even 8500 dbcache was not enough, but started throttling as it (or RAM) came close to filling up.",
      "created_at" : "2024-03-09T11:16:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986828626",
      "id" : 1986828626,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
      "node_id" : "IC_kwDOABII5852bJlS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986828626/reactions"
      },
      "updated_at" : "2024-03-09T12:28:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986828626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6353462?v=4",
         "events_url" : "https://api.github.com/users/reivanen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/reivanen/followers",
         "following_url" : "https://api.github.com/users/reivanen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/reivanen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/reivanen",
         "id" : 6353462,
         "login" : "reivanen",
         "node_id" : "MDQ6VXNlcjYzNTM0NjI=",
         "organizations_url" : "https://api.github.com/users/reivanen/orgs",
         "received_events_url" : "https://api.github.com/users/reivanen/received_events",
         "repos_url" : "https://api.github.com/users/reivanen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/reivanen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/reivanen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/reivanen"
      }
   }
]
