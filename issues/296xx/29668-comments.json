[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29668).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [stickies-v](https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-1958325955) |\n| Stale ACK | [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-1949117498) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29770](https://github.com/bitcoin/bitcoin/pull/29770) (index: Check all necessary block data is available before starting to sync by fjahr)\n* [#29700](https://github.com/bitcoin/bitcoin/pull/29700) (kernel, refactor: return error status on all fatal errors by ryanofsky)\n* [#19463](https://github.com/bitcoin/bitcoin/pull/19463) (Prune locks by luke-jr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-03-17T16:42:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2002534384",
      "id" : 2002534384,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29668",
      "node_id" : "IC_kwDOABII5853XD_w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2002534384/reactions"
      },
      "updated_at" : "2024-06-18T07:27:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2002534384",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537942918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537942918"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I find `has_undo` more to the point\r\n```suggestion\r\nconst CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool has_undo)\r\n```",
      "commit_id" : "bc36604a0b02cd71979028e3f43de48da88f97de",
      "created_at" : "2024-03-25T17:14:30Z",
      "diff_hunk" : "@@ -595,12 +595,16 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\n }\n \n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block)\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537942918",
      "id" : 1537942918,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585bqyWG",
      "original_commit_id" : "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "original_line" : 598,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1958325955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537942918/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-25T20:12:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537942918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537955721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537955721"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I think highlighting that this is a mask improves readability\r\n```suggestion\r\n    uint32_t status_mask{BLOCK_HAVE_DATA};\r\n```",
      "commit_id" : "bc36604a0b02cd71979028e3f43de48da88f97de",
      "created_at" : "2024-03-25T17:24:51Z",
      "diff_hunk" : "@@ -595,12 +595,16 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\n }\n \n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block)\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)\n {\n     AssertLockHeld(::cs_main);\n+    uint32_t check_status{BLOCK_HAVE_DATA};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537955721",
      "id" : 1537955721,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585bq1eJ",
      "original_commit_id" : "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "original_line" : 601,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1958325955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537955721/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-26T10:39:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537955721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537962499"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537962499"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: also, perhaps good to add a type `static_assert` here to ensure this doesn't silently introduce bugs when `nStatus` changes type?\r\n\r\n```\r\nstatic_assert(std::is_same<decltype(check_status), decltype(last_block->nStatus)>::value);\r\n\r\n```",
      "commit_id" : "bc36604a0b02cd71979028e3f43de48da88f97de",
      "created_at" : "2024-03-25T17:29:45Z",
      "diff_hunk" : "@@ -595,12 +595,16 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\n }\n \n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block)\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)\n {\n     AssertLockHeld(::cs_main);\n+    uint32_t check_status{BLOCK_HAVE_DATA};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537962499",
      "id" : 1537962499,
      "in_reply_to_id" : 1537955721,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585bq3ID",
      "original_commit_id" : "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "original_line" : 601,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1958325955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537962499/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-25T20:12:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537962499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537973016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537973016"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: unnecessary `const`\r\n```suggestion\r\n    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, bool check_undo=false) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n```",
      "commit_id" : "bc36604a0b02cd71979028e3f43de48da88f97de",
      "created_at" : "2024-03-25T17:35:03Z",
      "diff_hunk" : "@@ -337,8 +337,8 @@ class BlockManager\n \n     //! Find the first stored ancestor of start_block immediately after the last\n     //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    //! for ensuring that start_block has data.\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, const bool check_undo=false) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537973016",
      "id" : 1537973016,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585bq5sY",
      "original_commit_id" : "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "original_line" : 341,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1958325955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537973016/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-25T20:12:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537973016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537985109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537985109"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: also, would be nice to update the docs for the `check_undo` param, and include the exception made for genesis block so new callers are made aware to look out for that?",
      "commit_id" : "bc36604a0b02cd71979028e3f43de48da88f97de",
      "created_at" : "2024-03-25T17:42:49Z",
      "diff_hunk" : "@@ -337,8 +337,8 @@ class BlockManager\n \n     //! Find the first stored ancestor of start_block immediately after the last\n     //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    //! for ensuring that start_block has data.\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, const bool check_undo=false) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537985109",
      "id" : 1537985109,
      "in_reply_to_id" : 1537973016,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585bq8pV",
      "original_commit_id" : "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "original_line" : 341,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1958325955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537985109/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-25T20:12:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537985109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537989270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537989270"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit (+ a few lines down)\r\n```suggestion\r\n    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, /*last_block=*/nullptr, /*check_undo=*/true)->nHeight - 1 : block.nHeight;\r\n```",
      "commit_id" : "bc36604a0b02cd71979028e3f43de48da88f97de",
      "created_at" : "2024-03-25T17:45:26Z",
      "diff_hunk" : "@@ -835,7 +836,7 @@ static RPCHelpMan pruneblockchain()\n \n     PruneBlockFilesManual(active_chainstate, height);\n     const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, nullptr, true)->nHeight - 1 : block.nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537989270",
      "id" : 1537989270,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585bq9qW",
      "original_commit_id" : "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "original_line" : 839,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1958325955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537989270/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-25T20:12:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537989270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@stickies-v thanks for the feedback! I don't have strong feelings between the approaches but I agree yours is more flexible and maybe a bit more expressive, so I applied that. I also addressed the rest of the feedback and added some more detail to the docs.",
      "created_at" : "2024-03-27T17:03:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2023324076",
      "id" : 2023324076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29668",
      "node_id" : "IC_kwDOABII5854mXms",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2023324076/reactions"
      },
      "updated_at" : "2024-03-27T17:03:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2023324076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "bc36604a0b02cd71979028e3f43de48da88f97de",
      "created_at" : "2024-03-27T17:03:31Z",
      "diff_hunk" : "@@ -835,7 +836,7 @@ static RPCHelpMan pruneblockchain()\n \n     PruneBlockFilesManual(active_chainstate, height);\n     const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, nullptr, true)->nHeight - 1 : block.nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505540",
      "id" : 1541505540,
      "in_reply_to_id" : 1537989270,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585b4YIE",
      "original_commit_id" : "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "original_line" : 839,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1963955472,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505540/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-27T17:03:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505629"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "bc36604a0b02cd71979028e3f43de48da88f97de",
      "created_at" : "2024-03-27T17:03:34Z",
      "diff_hunk" : "@@ -337,8 +337,8 @@ class BlockManager\n \n     //! Find the first stored ancestor of start_block immediately after the last\n     //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    //! for ensuring that start_block has data.\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, const bool check_undo=false) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505629",
      "id" : 1541505629,
      "in_reply_to_id" : 1537973016,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585b4YJd",
      "original_commit_id" : "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "original_line" : 341,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1963955617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-27T17:03:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505765"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not needed due to approach change",
      "commit_id" : "bc36604a0b02cd71979028e3f43de48da88f97de",
      "created_at" : "2024-03-27T17:03:40Z",
      "diff_hunk" : "@@ -595,12 +595,16 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\n }\n \n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block)\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)\n {\n     AssertLockHeld(::cs_main);\n+    uint32_t check_status{BLOCK_HAVE_DATA};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505765",
      "id" : 1541505765,
      "in_reply_to_id" : 1537955721,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585b4YLl",
      "original_commit_id" : "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "original_line" : 601,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1963955807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505765/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-27T17:03:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505876"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505876"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not needed due to approach change",
      "commit_id" : "bc36604a0b02cd71979028e3f43de48da88f97de",
      "created_at" : "2024-03-27T17:03:44Z",
      "diff_hunk" : "@@ -595,12 +595,16 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\n }\n \n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block)\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505876",
      "id" : 1541505876,
      "in_reply_to_id" : 1537942918,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585b4YNU",
      "original_commit_id" : "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "original_line" : 598,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1963955981,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505876/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-27T17:03:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/23163769501</sub>",
      "created_at" : "2024-03-28T01:49:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2024255644",
      "id" : 2024255644,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29668",
      "node_id" : "IC_kwDOABII5854p7Cc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2024255644/reactions"
      },
      "updated_at" : "2024-03-28T01:49:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2024255644",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> q: doesn't this mean that if we generate a chain, prune half of it, then fetch the pruned blocks through `getblockfrompeer`, any fresh indexes sync will throw a different init error after this changes? (`StartIndexBackgroundSync()` should fail at `CheckBlockDataAvailability()` now).\r\n> \r\n> If this is correct, it would be nice to introduce a test presenting the behavior change.\r\n\r\nGood question but no, `CheckBlockDataAvailability()` does not change the default mask (`HAVE_DATA`), so it shouldn't change behavior there for now. But your question made me realize that we should check for undo data for some indices because they need it. I have implemented that in a follow-up here: #29770 and I also implemented the test there that shows the behavior change you had in mind I think.",
      "created_at" : "2024-03-30T22:57:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2028489071",
      "id" : 2028489071,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29668",
      "node_id" : "IC_kwDOABII58546Elv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2028489071/reactions"
      },
      "updated_at" : "2024-03-30T22:57:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2028489071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545671827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545671827"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    return block.nStatus & has_undo ? active_chainstate.m_blockman.GetFirstStoredBlock(block, /*lower_block=*/nullptr, /*status_mask=*/has_undo)->nHeight - 1 : block.nHeight;\r\n```",
      "commit_id" : "c77e84744a7bcd1609ab86969d2705f1dd116fa3",
      "created_at" : "2024-03-31T13:35:54Z",
      "diff_hunk" : "@@ -835,7 +836,8 @@ static RPCHelpMan pruneblockchain()\n \n     PruneBlockFilesManual(active_chainstate, height);\n     const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    const uint32_t has_undo{BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO};\n+    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, /*lower_block=*/nullptr, /*status_mask=*/has_undo)->nHeight - 1 : block.nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545671827",
      "id" : 1545671827,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585cIRST",
      "original_commit_id" : "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "original_line" : 840,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1970253804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545671827/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-31T22:14:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545671827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545672055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545672055"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This should check for `has_undo` too",
      "commit_id" : "c77e84744a7bcd1609ab86969d2705f1dd116fa3",
      "created_at" : "2024-03-31T13:36:34Z",
      "diff_hunk" : "@@ -1289,7 +1291,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n         bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545672055",
      "id" : 1545672055,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585cIRV3",
      "original_commit_id" : "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "original_line" : 1293,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1970253804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545672055/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-31T22:14:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545672055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545690307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545690307"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Also, it seems like we can just use `BLOCK_HAVE_MASK          =   BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO,`",
      "commit_id" : "c77e84744a7bcd1609ab86969d2705f1dd116fa3",
      "created_at" : "2024-03-31T14:13:13Z",
      "diff_hunk" : "@@ -1289,7 +1291,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n         bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545690307",
      "id" : 1545690307,
      "in_reply_to_id" : 1545672055,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585cIVzD",
      "original_commit_id" : "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "original_line" : 1293,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1970253804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545690307/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-31T22:14:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545690307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545720878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545720878"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: it's called `upper_block` in the implementation, which I think is a better name too (cfr `lower_block`)\r\n```suggestion\r\n    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, uint32_t status_mask=BLOCK_HAVE_DATA) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n```",
      "commit_id" : "c77e84744a7bcd1609ab86969d2705f1dd116fa3",
      "created_at" : "2024-03-31T15:35:19Z",
      "diff_hunk" : "@@ -336,9 +336,12 @@ class BlockManager\n     bool CheckBlockDataAvailability(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex& lower_block LIFETIMEBOUND) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Find the first stored ancestor of start_block immediately after the last\n-    //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    //! ancestor that does not match the status mask. Return value will never be\n+    //! null. Caller is responsible for ensuring that start_block has the status\n+    //! mask data. If the whole chain matched the status mask the genesis block\n+    //! will be returned regardless of it's status match because, for example,\n+    //! it can not have undo data by nature.\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, uint32_t status_mask=BLOCK_HAVE_DATA) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545720878",
      "id" : 1545720878,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585cIdQu",
      "original_commit_id" : "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "original_line" : 344,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1970253804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545720878/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-31T22:14:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545720878",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582311337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311337"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "c77e84744a7bcd1609ab86969d2705f1dd116fa3",
      "created_at" : "2024-04-28T19:28:29Z",
      "diff_hunk" : "@@ -336,9 +336,12 @@ class BlockManager\n     bool CheckBlockDataAvailability(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex& lower_block LIFETIMEBOUND) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Find the first stored ancestor of start_block immediately after the last\n-    //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    //! ancestor that does not match the status mask. Return value will never be\n+    //! null. Caller is responsible for ensuring that start_block has the status\n+    //! mask data. If the whole chain matched the status mask the genesis block\n+    //! will be returned regardless of it's status match because, for example,\n+    //! it can not have undo data by nature.\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, uint32_t status_mask=BLOCK_HAVE_DATA) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582311337",
      "id" : 1582311337,
      "in_reply_to_id" : 1545720878,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585eUCep",
      "original_commit_id" : "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "original_line" : 344,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 2027256874,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311337/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-28T19:28:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582311605"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311605"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done, I liked that `BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO` is more expressive because we don't use `BLOCK_HAVE_MASK` much I feel like people would need to look it up more, but I have just added a comment instead now.",
      "commit_id" : "c77e84744a7bcd1609ab86969d2705f1dd116fa3",
      "created_at" : "2024-04-28T19:28:35Z",
      "diff_hunk" : "@@ -1289,7 +1291,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n         bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582311605",
      "id" : 1582311605,
      "in_reply_to_id" : 1545672055,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585eUCi1",
      "original_commit_id" : "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "original_line" : 1293,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2027257309,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311605/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-28T19:28:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311605",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582311745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311745"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "c77e84744a7bcd1609ab86969d2705f1dd116fa3",
      "created_at" : "2024-04-28T19:28:40Z",
      "diff_hunk" : "@@ -835,7 +836,8 @@ static RPCHelpMan pruneblockchain()\n \n     PruneBlockFilesManual(active_chainstate, height);\n     const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    const uint32_t has_undo{BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO};\n+    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, /*lower_block=*/nullptr, /*status_mask=*/has_undo)->nHeight - 1 : block.nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582311745",
      "id" : 1582311745,
      "in_reply_to_id" : 1545671827,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585eUClB",
      "original_commit_id" : "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "original_line" : 840,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2027257574,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311745/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-28T19:28:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@stickies-v Thank you, I mostly took your suggestions with some minor tweaks and made you co-author of the refactoring commit. I was a bit torn about letting the caller handle the Genesis block issue but since this was actually the previous behavior I guess it's better to not change it if you like it the way it is. I have adapted `GetPruneHeight` to return `std::optional` which I found a good fit and avoids the `-1` return value. And I think the change in `init.cpp` isn't needed here (yet). But I think we will need it in #29770 later.\r\n\r\nEDIT: I had forgotten that `pruneblockchain` returns `-1` when nothing is pruned, but I still think handling it internally with `std::optional` is nicer.",
      "created_at" : "2024-04-28T19:34:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2081618206",
      "id" : 2081618206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29668",
      "node_id" : "IC_kwDOABII5858Evke",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081618206/reactions"
      },
      "updated_at" : "2024-04-28T23:13:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081618206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582961257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582961257"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could add a `CHECK_NONFATAL(first_block->nHeight > 0);` here to put that assumption in code, that would've helped with the segfault in current HEAD",
      "commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "created_at" : "2024-04-29T11:51:40Z",
      "diff_hunk" : "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582961257",
      "id" : 1582961257,
      "line" : 797,
      "node_id" : "PRRC_kwDOABII585eWhJp",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 797,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 23,
      "pull_request_review_id" : 2028288474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582961257/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T12:19:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582961257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582963779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582963779"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This block needs to be in the next commit - we're not passing `BLOCK_HAVE_MASK` yet in dd7696b97f20d756df1afa523a8f9e7bf3924c7d. This should fix the [failing CI](https://github.com/bitcoin/bitcoin/actions/runs/8870919761/job/24353246496?pr=29668)",
      "commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "created_at" : "2024-04-29T11:52:18Z",
      "diff_hunk" : "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582963779",
      "id" : 1582963779,
      "line" : 795,
      "node_id" : "PRRC_kwDOABII585eWhxD",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 795,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 21,
      "pull_request_review_id" : 2028288474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582963779/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582963779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582976807"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582976807"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`GetFirstBlock()` does not provide any guarantees that `pprev` is not `nullptr` (nor should it), so I think we need to assert that here",
      "commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "created_at" : "2024-04-29T11:59:58Z",
      "diff_hunk" : "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return first_block->pprev->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582976807",
      "id" : 1582976807,
      "line" : 801,
      "node_id" : "PRRC_kwDOABII585eWk8n",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 801,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 27,
      "pull_request_review_id" : 2028288474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582976807/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582976807",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582979911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582979911"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\r\n```",
      "commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "created_at" : "2024-04-29T12:02:52Z",
      "diff_hunk" : "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582979911",
      "id" : 1582979911,
      "line" : 786,
      "node_id" : "PRRC_kwDOABII585eWltH",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 786,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 12,
      "pull_request_review_id" : 2028288474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582979911/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582979911",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582984829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582984829"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit\r\n```suggestion\r\n    return GetPruneHeight(active_chainstate).value_or(-1);\r\n```",
      "commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "created_at" : "2024-04-29T12:07:22Z",
      "diff_hunk" : "@@ -834,8 +853,8 @@ static RPCHelpMan pruneblockchain()\n     }\n \n     PruneBlockFilesManual(active_chainstate, height);\n-    const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    const auto prune_height{GetPruneHeight(active_chainstate)};\n+    return prune_height ? prune_height.value() : -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582984829",
      "id" : 1582984829,
      "line" : 857,
      "node_id" : "PRRC_kwDOABII585eWm59",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 857,
      "original_position" : 40,
      "original_start_line" : 856,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 40,
      "pull_request_review_id" : 2028288474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582984829/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 856,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-04-29T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582984829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582992037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582992037"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: more consistent with the (suggested) approach in `pruneblockchain`, but then \"plus one (only present if pruning is enabled)\" as per the docs in this RPC\r\n\r\n```suggestion\r\n        const auto prune_height{GetPruneHeight(active_chainstate).value_or(-1)};\r\n        obj.pushKV(\"pruneheight\", prune_height + 1);\r\n```",
      "commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "created_at" : "2024-04-29T12:14:03Z",
      "diff_hunk" : "@@ -1288,8 +1307,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"size_on_disk\", chainman.m_blockman.CalculateCurrentUsage());\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n-        bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;\n-        obj.pushKV(\"pruneheight\", has_tip_data ? chainman.m_blockman.GetFirstStoredBlock(tip)->nHeight : tip.nHeight + 1);\n+        const auto prune_height{GetPruneHeight(active_chainstate)};\n+        obj.pushKV(\"pruneheight\", prune_height ? prune_height.value() + 1 : 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582992037",
      "id" : 1582992037,
      "line" : 1311,
      "node_id" : "PRRC_kwDOABII585eWoql",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 1311,
      "original_position" : 51,
      "original_start_line" : 1310,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 51,
      "pull_request_review_id" : 2028288474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582992037/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1310,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-04-29T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582992037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583335298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583335298"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor, blockstorage: Generalize GetFirstStoredBlock\" (dd7696b97f20d756df1afa523a8f9e7bf3924c7d)\r\n\r\nI think there are a few issues with this comment:\r\n\r\n- The @<!-- -->brief and @<!-- -->return sections make it sound like it is returning the earliest block matching the flags, when actually it is returning the earliest block matching the flags after the latest block _not_ matching them. This is different because it means not only does the returned block have the flags, but all blocks between the returned block and upper block have them.\r\n- One precondition is specified but one is missing (this also asserts false if the lower block is not an ancestor of the upper block).\r\n- I don't like how some pretty important details are written in parentheses. Better to use parentheses for more optional explanatory information.\r\n\r\nSuggestion to fix these things:\r\n\r\n```c++\r\n    /**\r\n     * @brief Returns the earliest block with specified `status_mask` flags set after\r\n     * the latest block _not_ having those flags.\r\n     *\r\n     * This function starts from `upper_block`, which must have all\r\n     * `status_mask` flags set, and iterates backwards through its ancestors. It\r\n     * continues as long as each block has all `status_mask` flags set, until\r\n     * reaching the oldest ancestor or `lower_block`.\r\n     * \r\n     * @pre `upper_block` must have all `status_mask` flags set.\r\n     * @pre `lower_block` must be null or an ancestor of `upper_block`\r\n     *\r\n     * @param upper_block The starting block for the search, which must have all\r\n     *                    `status_mask` flags set.\r\n     * @param status_mask Bitmask specifying required status flags.\r\n     * @param lower_block The earliest possible block to return. If null, the\r\n     *                    search can extend to the genesis block.\r\n     *\r\n     * @return A non-null pointer to the earliest block between `upper_block`\r\n     *         and `lower_block`, inclusive, such that every block between the\r\n     *         returned block and `upper_block` has `status_mask` flags set.\r\n     */\r\n```",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T16:00:09Z",
      "diff_hunk" : "@@ -335,10 +335,28 @@ class BlockManager\n     //! (part of the same chain).\n     bool CheckBlockDataAvailability(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex& lower_block LIFETIMEBOUND) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n-    //! Find the first stored ancestor of start_block immediately after the last\n-    //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    /**\n+     * @brief Finds the furthest away ancestor of `upper_block` of which the nStatus matches the `status_mask`\n+     *\n+     * Starts from `upper_block` and iterates backwards through its ancestors for as long as the block's\n+     * nStatus keeps matching the `status_mask` mask, or until it encounters `lower_block`.\n+     *\n+     * @pre `upper_block` must match the `status_mask`.\n+     *\n+     * @param upper_block The block from which to start the search, must meet the `status_mask` criteria.\n+     * @param status_mask A bitmask representing the conditions to check against each block's nStatus.\n+     * @param lower_block An optional pointer to the `CBlockIndex` that serves as the lower boundary of\n+     *                    the search (inclusive). If `nullptr`, the search includes up to the genesis\n+     *                    block.\n+     * @return A (non-null) pointer to the `CBlockIndex` of the furthest away ancestor (including\n+     *         `upper_block` itself) that matches the `status_mask`, up to and including\n+     *         `lower_block` if it is part of the ancestry.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583335298",
      "id" : 1583335298,
      "line" : 354,
      "node_id" : "PRRC_kwDOABII585eX8eC",
      "original_commit_id" : "dd7696b97f20d756df1afa523a8f9e7bf3924c7d",
      "original_line" : 354,
      "original_position" : 24,
      "original_start_line" : 338,
      "path" : "src/node/blockstorage.h",
      "position" : 24,
      "pull_request_review_id" : 2028926937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583335298/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 338,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-04-29T18:21:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583335298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375437"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T16:25:38Z",
      "diff_hunk" : "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375437",
      "id" : 1583375437,
      "in_reply_to_id" : 1582961257,
      "line" : 798,
      "node_id" : "PRRC_kwDOABII585eYGRN",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 798,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 24,
      "pull_request_review_id" : 2028993343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T16:25:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375522"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T16:25:42Z",
      "diff_hunk" : "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375522",
      "id" : 1583375522,
      "in_reply_to_id" : 1582963779,
      "line" : 795,
      "node_id" : "PRRC_kwDOABII585eYGSi",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 795,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 21,
      "pull_request_review_id" : 2028993500,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375522/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T16:25:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375709"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T16:25:49Z",
      "diff_hunk" : "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return first_block->pprev->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375709",
      "id" : 1583375709,
      "in_reply_to_id" : 1582976807,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585eYGVd",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 801,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2028993751,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375709/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T16:25:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375852"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "added",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T16:25:55Z",
      "diff_hunk" : "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375852",
      "id" : 1583375852,
      "in_reply_to_id" : 1582979911,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585eYGXs",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 786,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2028993958,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375852/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T16:25:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583376000"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583376000"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "taken",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T16:26:00Z",
      "diff_hunk" : "@@ -834,8 +853,8 @@ static RPCHelpMan pruneblockchain()\n     }\n \n     PruneBlockFilesManual(active_chainstate, height);\n-    const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    const auto prune_height{GetPruneHeight(active_chainstate)};\n+    return prune_height ? prune_height.value() : -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583376000",
      "id" : 1583376000,
      "in_reply_to_id" : 1582984829,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585eYGaA",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 857,
      "original_position" : 40,
      "original_start_line" : 856,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2028994150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583376000/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-04-29T16:26:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583376000",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583376085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583376085"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I prefer to keep this one as is because I find it more intuitive.",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T16:26:04Z",
      "diff_hunk" : "@@ -1288,8 +1307,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"size_on_disk\", chainman.m_blockman.CalculateCurrentUsage());\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n-        bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;\n-        obj.pushKV(\"pruneheight\", has_tip_data ? chainman.m_blockman.GetFirstStoredBlock(tip)->nHeight : tip.nHeight + 1);\n+        const auto prune_height{GetPruneHeight(active_chainstate)};\n+        obj.pushKV(\"pruneheight\", prune_height ? prune_height.value() + 1 : 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583376085",
      "id" : 1583376085,
      "in_reply_to_id" : 1582992037,
      "line" : 1311,
      "node_id" : "PRRC_kwDOABII585eYGbV",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 1311,
      "original_position" : 51,
      "original_start_line" : 1310,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 51,
      "pull_request_review_id" : 2028994276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583376085/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1310,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-04-29T16:26:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583376085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Adressed feedback from @stickies-v , thanks again!\r\n\r\n> nit: I think the last 3 commits should be squashed\r\n\r\nThe doc change is only tangentially related so I will keep it separate. But I squashed the 2nd and 3rd.",
      "created_at" : "2024-04-29T16:27:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2083168939",
      "id" : 2083168939,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29668",
      "node_id" : "IC_kwDOABII5858KqKr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083168939/reactions"
      },
      "updated_at" : "2024-04-29T16:27:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083168939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583398465"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583398465"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor, blockstorage: Generalize GetFirstStoredBlock\" (4e62129d8aed839c83fa4a595aab06ed5ca7eeb6)\r\n\r\nIMO, this logic is a little confusing because it using both `nHeight` and `pprev` instead of just using `pprev` consistently. Also I think the cases here could have more explanation.\r\n\r\n```c++\r\n// Get first block with data, after the last block without data.\r\n// This is the start of the unpruned range of blocks.\r\nconst auto first_unpruned{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\r\nif (!first_unpruned->prev) {\r\n   // No block before the first unpruned block means nothing is pruned.\r\n   return nullopt;\r\n}\r\n// Block before the first unpruned block is the last pruned block.\r\nreturn first_unpruned->prev->nHeight;\r\n```",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T16:44:22Z",
      "diff_hunk" : "@@ -782,6 +782,21 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n+\n+    if (first_block->nHeight == 0) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return Assert(first_block->pprev)->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583398465",
      "id" : 1583398465,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585eYL5B",
      "original_commit_id" : "4e62129d8aed839c83fa4a595aab06ed5ca7eeb6",
      "original_line" : 797,
      "original_position" : 16,
      "original_start_line" : 793,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2028926937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583398465/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-04-29T18:21:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583398465",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583454227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583454227"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: Make pruneheight also reflect undo data presence\" (61f352d6bcf485862815fdd68064cc07ea8ab6ce)\r\n\r\nThis doesn't seem right. If chain consists of just genesis block, and genesis block doesn't have undo data this will return height 0 as if genesis block were pruned.",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T17:30:47Z",
      "diff_hunk" : "@@ -787,10 +787,14 @@ static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EX\n     AssertLockHeld(::cs_main);\n \n     const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n-    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n-    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n-\n-    if (first_block->nHeight == 0) {\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583454227",
      "id" : 1583454227,
      "line" : 792,
      "node_id" : "PRRC_kwDOABII585eYZgT",
      "original_commit_id" : "61f352d6bcf485862815fdd68064cc07ea8ab6ce",
      "original_line" : 791,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 18,
      "pull_request_review_id" : 2028926937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583454227/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T18:21:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583454227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583472496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583472496"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor, blockstorage: Generalize GetFirstStoredBlock\" (4e62129d8aed839c83fa4a595aab06ed5ca7eeb6)\r\n\r\nI don't think it makes sense to call this parameter `active_chainstate`. It is true the active chainstate is always passed, but this function should care whether the chainstate is active or not. Probably also it would be better for this function not to access the Chainstate class at all and instead be passed separate BlockMan and CChain parameters.",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T17:41:09Z",
      "diff_hunk" : "@@ -782,6 +782,21 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583472496",
      "id" : 1583472496,
      "line" : 787,
      "node_id" : "PRRC_kwDOABII585eYd9w",
      "original_commit_id" : "4e62129d8aed839c83fa4a595aab06ed5ca7eeb6",
      "original_line" : 786,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 13,
      "pull_request_review_id" : 2028926937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583472496/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T18:21:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583472496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583515582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583515582"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rpc: Make pruneheight also reflect undo data presence\" (61f352d6bcf485862815fdd68064cc07ea8ab6ce)\r\n\r\nThis comment \"Result can never be 0 because genesis block is never pruned\" is misleading and basically describes the opposite of what is happening. If the genesis block was not pruned you would expect GetFirstBlock to return the genesis block, because it has data, and for the result to still be 0 here like it was in the previous commit. The reason `GetFirstBlock` is no longer returning the genesis block is because the genesis block does not have undo data, so it is now being considered pruned.\r\n\r\nSo code works for a different reason than is being described. I think it would probably clearer to ignore genesis block flags rather than making this code depend on that that genesis undo flag won't be set.\r\n\r\nWould suggest something more like the following (untested):\r\n\r\n```c++\r\n//! Return height of highest block on the chain that has been pruned, or std::nullopt if no blocks have been pruned\r\nstatic std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n    AssertLockHeld(::cs_main);\r\n\r\n    // Search for the last block missing block data or undo data. Don't let the\r\n    // search consider the genesis block, because the genesis block does not\r\n    // have undo data, but should not be considered pruned.\r\n    const CBlockIndex* first_block{chain[1]};\r\n    const CBlockIndex* chain_tip{chain.Tip()};\r\n\r\n    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\r\n    if (!first_block || !chain_tip) return std::nullopt;\r\n\r\n    // If the chain tip is pruned, everything is pruned.\r\n    if (!(chain_tip->nStatus & BLOCK_HAVE_MASK)) return chain_tip->nHeight;\r\n\r\n    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_MASK, first_block))};\r\n    if (&first_unpruned == first_block) {\r\n        // All blocks between first_block and chain_tip have data, so nothing is pruned.\r\n        return std::nullopt;\r\n    }\r\n\r\n    // Block before the first unpruned block is the last pruned block.\r\n    return Assert(first_unpruned.pprev)->nHeight;\r\n}\r\n```\r\n\r\n",
      "commit_id" : "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "created_at" : "2024-04-29T18:15:18Z",
      "diff_hunk" : "@@ -787,10 +787,14 @@ static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EX\n     AssertLockHeld(::cs_main);\n \n     const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n-    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n-    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n-\n-    if (first_block->nHeight == 0) {\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583515582",
      "id" : 1583515582,
      "line" : 795,
      "node_id" : "PRRC_kwDOABII585eYoe-",
      "original_commit_id" : "61f352d6bcf485862815fdd68064cc07ea8ab6ce",
      "original_line" : 794,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 21,
      "pull_request_review_id" : 2028926937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583515582/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T18:21:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583515582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621295595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295595"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Taken, thanks!",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-05-30T18:57:17Z",
      "diff_hunk" : "@@ -335,10 +335,28 @@ class BlockManager\n     //! (part of the same chain).\n     bool CheckBlockDataAvailability(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex& lower_block LIFETIMEBOUND) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n-    //! Find the first stored ancestor of start_block immediately after the last\n-    //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    /**\n+     * @brief Finds the furthest away ancestor of `upper_block` of which the nStatus matches the `status_mask`\n+     *\n+     * Starts from `upper_block` and iterates backwards through its ancestors for as long as the block's\n+     * nStatus keeps matching the `status_mask` mask, or until it encounters `lower_block`.\n+     *\n+     * @pre `upper_block` must match the `status_mask`.\n+     *\n+     * @param upper_block The block from which to start the search, must meet the `status_mask` criteria.\n+     * @param status_mask A bitmask representing the conditions to check against each block's nStatus.\n+     * @param lower_block An optional pointer to the `CBlockIndex` that serves as the lower boundary of\n+     *                    the search (inclusive). If `nullptr`, the search includes up to the genesis\n+     *                    block.\n+     * @return A (non-null) pointer to the `CBlockIndex` of the furthest away ancestor (including\n+     *         `upper_block` itself) that matches the `status_mask`, up to and including\n+     *         `lower_block` if it is part of the ancestry.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621295595",
      "id" : 1621295595,
      "in_reply_to_id" : 1583335298,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585gowHr",
      "original_commit_id" : "dd7696b97f20d756df1afa523a8f9e7bf3924c7d",
      "original_line" : 359,
      "original_position" : 24,
      "original_start_line" : 338,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 2089159494,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295595/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-30T18:57:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621295778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295778"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, passing CChain and BlockMan as parameters now.",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-05-30T18:57:23Z",
      "diff_hunk" : "@@ -782,6 +782,21 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621295778",
      "id" : 1621295778,
      "in_reply_to_id" : 1583472496,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585gowKi",
      "original_commit_id" : "4e62129d8aed839c83fa4a595aab06ed5ca7eeb6",
      "original_line" : 786,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2089159738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295778/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-30T18:57:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621295907"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295907"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Taken, thanks!",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-05-30T18:57:28Z",
      "diff_hunk" : "@@ -782,6 +782,21 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n+\n+    if (first_block->nHeight == 0) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return Assert(first_block->pprev)->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621295907",
      "id" : 1621295907,
      "in_reply_to_id" : 1583398465,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585gowMj",
      "original_commit_id" : "4e62129d8aed839c83fa4a595aab06ed5ca7eeb6",
      "original_line" : 797,
      "original_position" : 16,
      "original_start_line" : 793,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2089159896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295907/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-30T18:57:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621298451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621298451"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I have adopted these changes with minor edits and that addresses your previous comment about the genesis behavior as well.",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-05-30T18:59:07Z",
      "diff_hunk" : "@@ -787,10 +787,14 @@ static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EX\n     AssertLockHeld(::cs_main);\n \n     const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n-    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n-    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n-\n-    if (first_block->nHeight == 0) {\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621298451",
      "id" : 1621298451,
      "in_reply_to_id" : 1583515582,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585gow0T",
      "original_commit_id" : "61f352d6bcf485862815fdd68064cc07ea8ab6ce",
      "original_line" : 794,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2089163324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621298451/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-30T18:59:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621298451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621299243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621299243"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed in the other comment on this commit",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-05-30T18:59:46Z",
      "diff_hunk" : "@@ -787,10 +787,14 @@ static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EX\n     AssertLockHeld(::cs_main);\n \n     const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n-    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n-    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n-\n-    if (first_block->nHeight == 0) {\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621299243",
      "id" : 1621299243,
      "in_reply_to_id" : 1583454227,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585goxAr",
      "original_commit_id" : "61f352d6bcf485862815fdd68064cc07ea8ab6ce",
      "original_line" : 791,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2089164503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621299243/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-30T18:59:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621299243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed comments from @ryanofsky , thank you for the thoughtful review!",
      "created_at" : "2024-05-30T19:07:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2140704680",
      "id" : 2140704680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29668",
      "node_id" : "IC_kwDOABII585_mI-o",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2140704680/reactions"
      },
      "updated_at" : "2024-05-30T19:07:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2140704680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624501620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624501620"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In dca1ca1f56d8e63929eb7aea64f8fb3e01752357: I think `BlockManager::GetFirstBlock()` can be made `const`, which allows us to pass a `const BlockManager& blockman` here:\r\n\r\n<details>\r\n<summary>git diff on dca1ca1f56</summary>\r\n\r\n```diff\r\ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\r\nindex 18eb2dc1aa..6dbc111eb6 100644\r\n--- a/src/node/blockstorage.cpp\r\n+++ b/src/node/blockstorage.cpp\r\n@@ -595,7 +595,7 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\r\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\r\n }\r\n \r\n-const CBlockIndex* BlockManager::GetFirstBlock(const CBlockIndex& upper_block, uint32_t status_mask, const CBlockIndex* lower_block)\r\n+const CBlockIndex* BlockManager::GetFirstBlock(const CBlockIndex& upper_block, uint32_t status_mask, const CBlockIndex* lower_block) const\r\n {\r\n     AssertLockHeld(::cs_main);\r\n     const CBlockIndex* last_block = &upper_block;\r\ndiff --git a/src/node/blockstorage.h b/src/node/blockstorage.h\r\nindex 917d75232d..d1e46fde2b 100644\r\n--- a/src/node/blockstorage.h\r\n+++ b/src/node/blockstorage.h\r\n@@ -361,7 +361,7 @@ public:\r\n         const CBlockIndex& upper_block LIFETIMEBOUND,\r\n         uint32_t status_mask,\r\n         const CBlockIndex* lower_block = nullptr\r\n-    ) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+    ) const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n     /** True if any block files have ever been pruned. */\r\n     bool m_have_pruned = false;\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex 90cee9901d..b99abe545d 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -783,7 +783,7 @@ static RPCHelpMan getblock()\r\n }\r\n \r\n //! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\r\n-static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n+static std::optional<int> GetPruneHeight(const BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n     AssertLockHeld(::cs_main);\r\n \r\n     const CBlockIndex* chain_tip{chain.Tip()};\r\n\r\n```\r\n</details>\r\n",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-06-03T13:52:31Z",
      "diff_hunk" : "@@ -782,6 +782,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624501620",
      "id" : 1624501620,
      "line" : 787,
      "node_id" : "PRRC_kwDOABII585g0-10",
      "original_commit_id" : "dca1ca1f56d8e63929eb7aea64f8fb3e01752357",
      "original_line" : 786,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 13,
      "pull_request_review_id" : 2093944753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624501620/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-03T16:24:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624501620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624683314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624683314"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this is buggy, chain tip should be considered pruned if any of the `BLOCK_HAVE_MASK` flags are missing:\r\n\r\n```suggestion\r\n    if (!((chain_tip->nStatus & BLOCK_HAVE_MASK) == BLOCK_HAVE_MASK)) return chain_tip->nHeight;\r\n```\r\n\r\nCan be verified by adding unit test to the first commit, which passes on dca1ca1f56 and fails on current HEAD for `CheckGetPruneHeight(blockman, chain, 100)`:\r\n\r\n```\r\n$ ./src/test/test_bitcoin --run_test=blockchain_tests/get_prune_height\r\n...\r\nRunning 1 test case...\r\nAssertion failed: ((last_block->nStatus & status_mask) == status_mask), function GetFirstBlock, file blockstorage.cpp, line 602.\r\nunknown location:0: fatal error: in \"blockchain_tests/get_prune_height\": signal: SIGABRT (application abort requested)\r\ntest/blockchain_tests.cpp:93: last checkpoint\r\n```\r\n\r\n<details>\r\n<summary>git diff on dca1ca1f56</summary>\r\n\r\n```diff\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex 90cee9901d..b7c1bc9673 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -783,7 +783,7 @@ static RPCHelpMan getblock()\r\n }\r\n \r\n //! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\r\n-static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n+std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) {\r\n     AssertLockHeld(::cs_main);\r\n \r\n     const CBlockIndex* chain_tip{chain.Tip()};\r\ndiff --git a/src/rpc/blockchain.h b/src/rpc/blockchain.h\r\nindex c2021c3608..d9bf627df5 100644\r\n--- a/src/rpc/blockchain.h\r\n+++ b/src/rpc/blockchain.h\r\n@@ -21,6 +21,7 @@ class CBlockIndex;\r\n class Chainstate;\r\n class UniValue;\r\n namespace node {\r\n+class BlockManager;\r\n struct NodeContext;\r\n } // namespace node\r\n \r\n@@ -57,4 +58,7 @@ UniValue CreateUTXOSnapshot(\r\n     const fs::path& path,\r\n     const fs::path& tmppath);\r\n \r\n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\r\n+std::optional<int> GetPruneHeight(node::BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+\r\n #endif // BITCOIN_RPC_BLOCKCHAIN_H\r\ndiff --git a/src/test/blockchain_tests.cpp b/src/test/blockchain_tests.cpp\r\nindex be515a9eac..2a63d09795 100644\r\n--- a/src/test/blockchain_tests.cpp\r\n+++ b/src/test/blockchain_tests.cpp\r\n@@ -5,7 +5,9 @@\r\n #include <boost/test/unit_test.hpp>\r\n \r\n #include <chain.h>\r\n+#include <node/blockstorage.h>\r\n #include <rpc/blockchain.h>\r\n+#include <sync.h>\r\n #include <test/util/setup_common.h>\r\n #include <util/string.h>\r\n \r\n@@ -74,4 +76,36 @@ BOOST_AUTO_TEST_CASE(get_difficulty_for_very_high_target)\r\n     TestDifficulty(0x12345678, 5913134931067755359633408.0);\r\n }\r\n \r\n+//! Prune chain from height down to genesis block and check that\r\n+//! GetPruneHeight returns the correct value\r\n+static void CheckGetPruneHeight(node::BlockManager& blockman, CChain& chain, int height) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n+{\r\n+    AssertLockHeld(::cs_main);\r\n+\r\n+    // Emulate pruning all blocks from `height` down to the genesis block\r\n+    // by unsetting the `BLOCK_HAVE_DATA` flag from `nStatus`\r\n+    for (CBlockIndex* it{chain[height]}; it != nullptr && it->nHeight > 0; it = it->pprev) {\r\n+        it->nStatus &= ~BLOCK_HAVE_DATA;\r\n+    }\r\n+\r\n+    const auto prune_height{GetPruneHeight(blockman, chain)};\r\n+    BOOST_REQUIRE(prune_height.has_value());\r\n+    BOOST_CHECK_EQUAL(*prune_height, height);\r\n+}\r\n+\r\n+BOOST_FIXTURE_TEST_CASE(get_prune_height, TestChain100Setup)\r\n+{\r\n+    LOCK(::cs_main);\r\n+    auto& chain = m_node.chainman->ActiveChain();\r\n+    auto& blockman = m_node.chainman->m_blockman;\r\n+\r\n+    // Fresh chain of 100 blocks without any pruned blocks, so std::nullopt should be returned\r\n+    BOOST_CHECK(!GetPruneHeight(blockman, chain).has_value());\r\n+\r\n+    // Start pruning\r\n+    CheckGetPruneHeight(blockman, chain, 1);\r\n+    CheckGetPruneHeight(blockman, chain, 99);\r\n+    CheckGetPruneHeight(blockman, chain, 100);\r\n+}\r\n+\r\n BOOST_AUTO_TEST_SUITE_END()\r\n\r\n```\r\n</details>\r\n",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-06-03T15:42:53Z",
      "diff_hunk" : "@@ -782,6 +783,32 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n+    const CBlockIndex* chain_tip{chain.Tip()};\n+\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!(chain_tip->nStatus & BLOCK_HAVE_MASK)) return chain_tip->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624683314",
      "id" : 1624683314,
      "line" : 800,
      "node_id" : "PRRC_kwDOABII585g1rMy",
      "original_commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "original_line" : 800,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 26,
      "pull_request_review_id" : 2093944753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624683314/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-03T16:24:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624683314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624721555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624721555"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think this is fully addressed in 0501ec102f3740049bd2e891cd83527c31b29222 - would update to `return Assert(first_unpruned.pprev)->nHeight;`?",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-06-03T16:10:29Z",
      "diff_hunk" : "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return first_block->pprev->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624721555",
      "id" : 1624721555,
      "in_reply_to_id" : 1582976807,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585g10iT",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 801,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2093944753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624721555/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-03T16:24:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624721555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624736686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624736686"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `peer_id` makes things less readable imo\r\n```suggestion\r\n        node.getblockfrompeer(fetch_block, peers[0][\"id\"])\r\n```",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-06-03T16:20:55Z",
      "diff_hunk" : "@@ -494,5 +499,19 @@ def test_scanblocks_pruned(self):\n         assert_raises_rpc_error(-1, \"Block not available (pruned data)\", node.scanblocks,\n             \"start\", [{\"desc\": f\"raw({false_positive_spk.hex()})\"}], 0, 0, \"basic\", {\"filter_false_positives\": True})\n \n+    def test_pruneheight_undo_presence(self):\n+        node = self.nodes[2]\n+        pruneheight = node.getblockchaininfo()[\"pruneheight\"]\n+        fetch_block = node.getblockhash(pruneheight - 1)\n+\n+        self.connect_nodes(1, 2)\n+        peers = node.getpeerinfo()\n+        peer_id = peers[0][\"id\"]\n+        node.getblockfrompeer(fetch_block, peer_id)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624736686",
      "id" : 1624736686,
      "line" : 510,
      "node_id" : "PRRC_kwDOABII585g14Ou",
      "original_commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "original_line" : 510,
      "original_position" : 33,
      "original_start_line" : 509,
      "path" : "test/functional/feature_pruning.py",
      "position" : 33,
      "pull_request_review_id" : 2093944753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624736686/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 509,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-03T16:24:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624736686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624762665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624762665"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor, blockstorage: Generalize GetFirstStoredBlock\" (dca1ca1f56d8e63929eb7aea64f8fb3e01752357)\r\n\r\nI think the code would be simpler (and have fewer cases to think about) if this function just returned -1 when no blocks were pruned, instead of nullopt:\r\n\r\n```diff\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -782,8 +782,8 @@ static RPCHelpMan getblock()\r\n     };\r\n }\r\n \r\n-//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\r\n-static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n+//! Return height of highest block that has been pruned, or -1 if no blocks have been pruned\r\n+int GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n     AssertLockHeld(::cs_main);\r\n \r\n     const CBlockIndex* chain_tip{chain.Tip()};\r\n@@ -794,7 +794,7 @@ static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& c\r\n     const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_DATA))};\r\n     if (!first_unpruned.pprev) {\r\n        // No block before the first unpruned block means nothing is pruned.\r\n-       return std::nullopt;\r\n+       return -1;\r\n     }\r\n     // Block before the first unpruned block is the last pruned block.\r\n     return first_unpruned.pprev->nHeight;\r\n@@ -852,7 +852,7 @@ static RPCHelpMan pruneblockchain()\r\n     }\r\n \r\n     PruneBlockFilesManual(active_chainstate, height);\r\n-    return GetPruneHeight(chainman.m_blockman, active_chain).value_or(-1);\r\n+    return GetPruneHeight(chainman.m_blockman, active_chain);\r\n },\r\n     };\r\n }\r\n@@ -1305,8 +1305,7 @@ RPCHelpMan getblockchaininfo()\r\n     obj.pushKV(\"size_on_disk\", chainman.m_blockman.CalculateCurrentUsage());\r\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\r\n     if (chainman.m_blockman.IsPruneMode()) {\r\n-        const auto prune_height{GetPruneHeight(chainman.m_blockman, active_chainstate.m_chain)};\r\n-        obj.pushKV(\"pruneheight\", prune_height ? prune_height.value() + 1 : 0);\r\n+        obj.pushKV(\"pruneheight\", GetPruneHeight(chainman.m_blockman, active_chainstate.m_chain) + 1);\r\n \r\n         const bool automatic_pruning{chainman.m_blockman.GetPruneTarget() != BlockManager::PRUNE_TARGET_MANUAL};\r\n         obj.pushKV(\"automatic_pruning\",  automatic_pruning);\r\n```\r\n\r\n\r\n\r\n\r\n",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-06-03T16:42:19Z",
      "diff_hunk" : "@@ -782,6 +782,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624762665",
      "id" : 1624762665,
      "line" : 786,
      "node_id" : "PRRC_kwDOABII585g1-kp",
      "original_commit_id" : "dca1ca1f56d8e63929eb7aea64f8fb3e01752357",
      "original_line" : 785,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 12,
      "pull_request_review_id" : 2094387578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624762665/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-03T16:55:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624762665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624770978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624770978"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624683314\r\n\r\n> I think this is buggy, chain tip should be considered pruned if any of the `BLOCK_HAVE_MASK` flags are missing:\r\n\r\nNice catch! Would be great to add the test to the first commit.",
      "commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "created_at" : "2024-06-03T16:48:58Z",
      "diff_hunk" : "@@ -782,6 +783,32 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n+    const CBlockIndex* chain_tip{chain.Tip()};\n+\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!(chain_tip->nStatus & BLOCK_HAVE_MASK)) return chain_tip->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624770978",
      "id" : 1624770978,
      "in_reply_to_id" : 1624683314,
      "line" : 800,
      "node_id" : "PRRC_kwDOABII585g2Ami",
      "original_commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "original_line" : 800,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 26,
      "pull_request_review_id" : 2094387578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624770978/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-03T16:54:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624770978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739144"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739144"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "7e77b597ca262004064e75d8e3a4c42d78043f1d",
      "created_at" : "2024-06-22T16:19:50Z",
      "diff_hunk" : "@@ -494,5 +499,19 @@ def test_scanblocks_pruned(self):\n         assert_raises_rpc_error(-1, \"Block not available (pruned data)\", node.scanblocks,\n             \"start\", [{\"desc\": f\"raw({false_positive_spk.hex()})\"}], 0, 0, \"basic\", {\"filter_false_positives\": True})\n \n+    def test_pruneheight_undo_presence(self):\n+        node = self.nodes[2]\n+        pruneheight = node.getblockchaininfo()[\"pruneheight\"]\n+        fetch_block = node.getblockhash(pruneheight - 1)\n+\n+        self.connect_nodes(1, 2)\n+        peers = node.getpeerinfo()\n+        peer_id = peers[0][\"id\"]\n+        node.getblockfrompeer(fetch_block, peer_id)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739144",
      "id" : 1649739144,
      "in_reply_to_id" : 1624736686,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iVQWI",
      "original_commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "original_line" : 510,
      "original_position" : 33,
      "original_start_line" : 509,
      "path" : "test/functional/feature_pruning.py",
      "position" : null,
      "pull_request_review_id" : 2133850334,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739144/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-22T16:19:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739144",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739149"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739149"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure why this is still needed when we return above if `!first_unpruned.pprev` but I've added it since it won't hurt.",
      "commit_id" : "7e77b597ca262004064e75d8e3a4c42d78043f1d",
      "created_at" : "2024-06-22T16:19:53Z",
      "diff_hunk" : "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return first_block->pprev->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739149",
      "id" : 1649739149,
      "in_reply_to_id" : 1582976807,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iVQWN",
      "original_commit_id" : "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "original_line" : 801,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2133850341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739149/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-22T16:19:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739149",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Cool, thanks! Added the fix and the test.",
      "commit_id" : "7e77b597ca262004064e75d8e3a4c42d78043f1d",
      "created_at" : "2024-06-22T16:20:00Z",
      "diff_hunk" : "@@ -782,6 +783,32 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n+    const CBlockIndex* chain_tip{chain.Tip()};\n+\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!(chain_tip->nStatus & BLOCK_HAVE_MASK)) return chain_tip->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739156",
      "id" : 1649739156,
      "in_reply_to_id" : 1624683314,
      "line" : 800,
      "node_id" : "PRRC_kwDOABII585iVQWU",
      "original_commit_id" : "0501ec102f3740049bd2e891cd83527c31b29222",
      "original_line" : 800,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 26,
      "pull_request_review_id" : 2133850352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739156/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-22T16:20:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I disagree here. I think this is the correct use of an optional when we may or may not have a value to return. And I think it's easier to understand because the code is more expressive. Handing a magical `-1` around is just not intuitive IMO.",
      "commit_id" : "7e77b597ca262004064e75d8e3a4c42d78043f1d",
      "created_at" : "2024-06-22T16:20:56Z",
      "diff_hunk" : "@@ -782,6 +782,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739250",
      "id" : 1649739250,
      "in_reply_to_id" : 1624762665,
      "line" : 786,
      "node_id" : "PRRC_kwDOABII585iVQXy",
      "original_commit_id" : "dca1ca1f56d8e63929eb7aea64f8fb3e01752357",
      "original_line" : 786,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 12,
      "pull_request_review_id" : 2133850453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739250/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-22T16:20:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739281"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "7e77b597ca262004064e75d8e3a4c42d78043f1d",
      "created_at" : "2024-06-22T16:21:11Z",
      "diff_hunk" : "@@ -782,6 +782,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739281",
      "id" : 1649739281,
      "in_reply_to_id" : 1624501620,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iVQYR",
      "original_commit_id" : "dca1ca1f56d8e63929eb7aea64f8fb3e01752357",
      "original_line" : 786,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2133850475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739281/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-22T16:21:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed feedback from @stickies-v and @ryanofsky, thank you!",
      "created_at" : "2024-06-22T16:23:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2184088934",
      "id" : 2184088934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29668",
      "node_id" : "IC_kwDOABII586CLo1m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2184088934/reactions"
      },
      "updated_at" : "2024-06-22T16:23:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2184088934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/26553131801</sub>",
      "created_at" : "2024-06-22T17:37:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2184124132",
      "id" : 2184124132,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29668",
      "node_id" : "IC_kwDOABII586CLxbk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2184124132/reactions"
      },
      "updated_at" : "2024-06-22T17:37:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2184124132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1650127334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1650127334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "q: is the \"undo data\" term well known outside of core? It seems to be an implementation detail to me. Maybe, could write this differently: \"The block data will be stored alone; there will be no available information associated with the outputs this block spent. This limits the usage.. etc\".",
      "commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "created_at" : "2024-06-23T16:48:29Z",
      "diff_hunk" : "@@ -429,6 +429,7 @@ static RPCHelpMan getblockfrompeer()\n         \"getblockfrompeer\",\n         \"Attempt to fetch block from a given peer.\\n\\n\"\n         \"We must have the header for this block, e.g. using submitheader.\\n\"\n+        \"The block will not have any undo data which can limit the usage of the block data in a context where the undo data is needed.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1650127334",
      "id" : 1650127334,
      "line" : 432,
      "node_id" : "PRRC_kwDOABII585iWvHm",
      "original_commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_line" : 432,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 4,
      "pull_request_review_id" : 2134340911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1650127334/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-23T16:48:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1650127334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1650196258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1650196258"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, not sure how much it is known but it is referenced in other places already, like the `getblock` RPC help. And I'm not sure if a more generic text helps more people because it's a quite technical reason and I don't know how to explain it in a way that works for everyone and is still concise. With the term undo data people at least have something they can search on Bitcoin SE etc.",
      "commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "created_at" : "2024-06-23T22:19:31Z",
      "diff_hunk" : "@@ -429,6 +429,7 @@ static RPCHelpMan getblockfrompeer()\n         \"getblockfrompeer\",\n         \"Attempt to fetch block from a given peer.\\n\\n\"\n         \"We must have the header for this block, e.g. using submitheader.\\n\"\n+        \"The block will not have any undo data which can limit the usage of the block data in a context where the undo data is needed.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1650196258",
      "id" : 1650196258,
      "in_reply_to_id" : 1650127334,
      "line" : 432,
      "node_id" : "PRRC_kwDOABII585iW_8i",
      "original_commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_line" : 432,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 4,
      "pull_request_review_id" : 2134420970,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1650196258/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-23T22:19:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1650196258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651043128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651043128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I don't know how to explain it in a way that works for everyone and is still concise\r\n\r\nNo problem on leaving it as is if there is other RPC command using this term.\r\nWhat I wrote seems generally useful to me; it means that the node might not be able to access the spent outputs script and value. Maybe adding few scenarios where the undo data is needed could clarify it usage.",
      "commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "created_at" : "2024-06-24T13:31:18Z",
      "diff_hunk" : "@@ -429,6 +429,7 @@ static RPCHelpMan getblockfrompeer()\n         \"getblockfrompeer\",\n         \"Attempt to fetch block from a given peer.\\n\\n\"\n         \"We must have the header for this block, e.g. using submitheader.\\n\"\n+        \"The block will not have any undo data which can limit the usage of the block data in a context where the undo data is needed.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651043128",
      "id" : 1651043128,
      "in_reply_to_id" : 1650127334,
      "line" : 432,
      "node_id" : "PRRC_kwDOABII585iaOs4",
      "original_commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_line" : 432,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 4,
      "pull_request_review_id" : 2135821455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651043128/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-24T14:43:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651043128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651079954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651079954"
         }
      },
      "author_association" : "MEMBER",
      "body" : "little topic: \r\nmaybe changing the RPC docs to say that \"pruneheight\" returns \"the first block unpruned, all previous blocks were pruned\" is more useful than saying \"height of the last block pruned, plus one\" as is now.",
      "commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "created_at" : "2024-06-24T13:55:03Z",
      "diff_hunk" : "@@ -1288,8 +1314,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"size_on_disk\", chainman.m_blockman.CalculateCurrentUsage());\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n-        bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;\n-        obj.pushKV(\"pruneheight\", has_tip_data ? chainman.m_blockman.GetFirstStoredBlock(tip)->nHeight : tip.nHeight + 1);\n+        const auto prune_height{GetPruneHeight(chainman.m_blockman, active_chainstate.m_chain)};\n+        obj.pushKV(\"pruneheight\", prune_height ? prune_height.value() + 1 : 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651079954",
      "id" : 1651079954,
      "line" : 1318,
      "node_id" : "PRRC_kwDOABII585iaXsS",
      "original_commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_line" : 1318,
      "original_position" : 58,
      "original_start_line" : 1317,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 58,
      "pull_request_review_id" : 2135821455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651079954/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1317,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-24T14:43:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651079954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651138486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651138486"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: missing some includes / fwd decls for the newly added line:\r\n\r\n<details>\r\n<summary>git diff on 8789dc8f31</summary>\r\n\r\n```diff\r\ndiff --git a/src/rpc/blockchain.h b/src/rpc/blockchain.h\r\nindex f6a7fe236c..23909c334e 100644\r\n--- a/src/rpc/blockchain.h\r\n+++ b/src/rpc/blockchain.h\r\n@@ -9,15 +9,18 @@\r\n #include <core_io.h>\r\n #include <streams.h>\r\n #include <sync.h>\r\n+#include <threadsafety.h>\r\n #include <util/fs.h>\r\n #include <validation.h>\r\n \r\n #include <any>\r\n+#include <optional>\r\n #include <stdint.h>\r\n #include <vector>\r\n \r\n class CBlock;\r\n class CBlockIndex;\r\n+class CChain;\r\n class Chainstate;\r\n class UniValue;\r\n namespace node {\r\n\r\n```\r\n</details>\r\n",
      "commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "created_at" : "2024-06-24T14:27:59Z",
      "diff_hunk" : "@@ -57,4 +58,7 @@ UniValue CreateUTXOSnapshot(\n     const fs::path& path,\n     const fs::path& tmppath);\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+std::optional<int> GetPruneHeight(const node::BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651138486",
      "id" : 1651138486,
      "line" : 62,
      "node_id" : "PRRC_kwDOABII585ial-2",
      "original_commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_line" : 62,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.h",
      "position" : 13,
      "pull_request_review_id" : 2135982014,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651138486/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-24T14:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651138486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651153859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651153859"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit\r\n```suggestion\r\nstatic void CheckGetPruneHeight(const node::BlockManager& blockman, const CChain& chain, int height) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n```\r\n\r\nand related:\r\n\r\n<details>\r\n<summary>git diff on 8789dc8f31</summary>\r\n\r\n```diff\r\ndiff --git a/src/test/blockchain_tests.cpp b/src/test/blockchain_tests.cpp\r\nindex 2a63d09795..7a5d175c8c 100644\r\n--- a/src/test/blockchain_tests.cpp\r\n+++ b/src/test/blockchain_tests.cpp\r\n@@ -96,8 +96,8 @@ static void CheckGetPruneHeight(node::BlockManager& blockman, CChain& chain, int\r\n BOOST_FIXTURE_TEST_CASE(get_prune_height, TestChain100Setup)\r\n {\r\n     LOCK(::cs_main);\r\n-    auto& chain = m_node.chainman->ActiveChain();\r\n-    auto& blockman = m_node.chainman->m_blockman;\r\n+    const auto& chain = m_node.chainman->ActiveChain();\r\n+    const auto& blockman = m_node.chainman->m_blockman;\r\n \r\n     // Fresh chain of 100 blocks without any pruned blocks, so std::nullopt should be returned\r\n     BOOST_CHECK(!GetPruneHeight(blockman, chain).has_value());\r\n\r\n```\r\n</details>\r\n",
      "commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "created_at" : "2024-06-24T14:37:17Z",
      "diff_hunk" : "@@ -74,4 +76,36 @@ BOOST_AUTO_TEST_CASE(get_difficulty_for_very_high_target)\n     TestDifficulty(0x12345678, 5913134931067755359633408.0);\n }\n \n+//! Prune chain from height down to genesis block and check that\n+//! GetPruneHeight returns the correct value\n+static void CheckGetPruneHeight(node::BlockManager& blockman, CChain& chain, int height) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651153859",
      "id" : 1651153859,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585iapvD",
      "original_commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_line" : 81,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/test/blockchain_tests.cpp",
      "position" : 16,
      "pull_request_review_id" : 2135982014,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651153859/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-24T14:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651153859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651156361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651156361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can remove the back and forth.\r\n```suggestion\r\n    const CBlockIndex* first_unpruned{Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_MASK, first_block))};\r\n    if (first_unpruned == first_block) {\r\n```",
      "commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "created_at" : "2024-06-24T14:38:50Z",
      "diff_hunk" : "@@ -786,16 +786,24 @@ static RPCHelpMan getblock()\n std::optional<int> GetPruneHeight(const BlockManager& blockman, const CChain& chain) {\n     AssertLockHeld(::cs_main);\n \n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n     const CBlockIndex* chain_tip{chain.Tip()};\n-    if (!(chain_tip->nStatus & BLOCK_HAVE_DATA)) return chain_tip->nHeight;\n \n-    // Get first block with data, after the last block without data.\n-    // This is the start of the unpruned range of blocks.\n-    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_DATA))};\n-    if (!first_unpruned.pprev) {\n-       // No block before the first unpruned block means nothing is pruned.\n-       return std::nullopt;\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!((chain_tip->nStatus & BLOCK_HAVE_MASK) == BLOCK_HAVE_MASK)) return chain_tip->nHeight;\n+\n+    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_MASK, first_block))};\n+    if (&first_unpruned == first_block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651156361",
      "id" : 1651156361,
      "line" : 803,
      "node_id" : "PRRC_kwDOABII585iaqWJ",
      "original_commit_id" : "4a1975008b602aeacdad9a74d1837a7455148074",
      "original_line" : 802,
      "original_position" : 24,
      "original_start_line" : 801,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 29,
      "pull_request_review_id" : 2135821455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651156361/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 802,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-24T14:44:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651156361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651160369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651160369"
         }
      },
      "author_association" : "MEMBER",
      "body" : "could be simpler:\r\n```suggestion\r\n    if ((chain_tip->nStatus & BLOCK_HAVE_MASK) != BLOCK_HAVE_MASK) return chain_tip->nHeight;\r\n```",
      "commit_id" : "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "created_at" : "2024-06-24T14:41:29Z",
      "diff_hunk" : "@@ -786,16 +786,24 @@ static RPCHelpMan getblock()\n std::optional<int> GetPruneHeight(const BlockManager& blockman, const CChain& chain) {\n     AssertLockHeld(::cs_main);\n \n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n     const CBlockIndex* chain_tip{chain.Tip()};\n-    if (!(chain_tip->nStatus & BLOCK_HAVE_DATA)) return chain_tip->nHeight;\n \n-    // Get first block with data, after the last block without data.\n-    // This is the start of the unpruned range of blocks.\n-    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_DATA))};\n-    if (!first_unpruned.pprev) {\n-       // No block before the first unpruned block means nothing is pruned.\n-       return std::nullopt;\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!((chain_tip->nStatus & BLOCK_HAVE_MASK) == BLOCK_HAVE_MASK)) return chain_tip->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651160369",
      "id" : 1651160369,
      "line" : 800,
      "node_id" : "PRRC_kwDOABII585iarUx",
      "original_commit_id" : "4a1975008b602aeacdad9a74d1837a7455148074",
      "original_line" : 799,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 26,
      "pull_request_review_id" : 2135821455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651160369/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-24T14:43:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651160369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
