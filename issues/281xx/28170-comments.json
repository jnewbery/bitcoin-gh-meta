[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1285990092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285990092"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This interface is not the right place for a callback like this because it is not a \"net event\".\r\n\r\nWould be better to have a method on connman, e.g. `CConnman::SetDesirableServiceFlags` that is then called by peerman.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-07T14:50:21Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1285990092",
      "id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585MpqbM",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1565523628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285990092/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-07T14:54:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285990092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1286427458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427458"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This interface is not the right place for a callback like this because it is not a \"net event\".\r\n\r\nHmm ok, that would avoid locking `cs_main` in the open connections thread. Which is nice.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-07T22:20:19Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1286427458",
      "id" : 1286427458,
      "in_reply_to_id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585MrVNC",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1566217778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427458/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-07T22:20:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1287286613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1287286613"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Have thought more about this and I'm not so convinced anymore.\r\n\r\nThe connection manager class lives on a lower level, and manages only a fraction of the node's information. And this field is strictly linked to the node's overall status. Right now, `HasDesirableServiceFlags()` requires to know the chain sync status.\r\nSo, by placing it inside `CConMan`, we add another level of indirection. Because, most of the time, the peer manager class will call to the `CConMan` setter and subsequently call the getter to utilize it. Using the `CConMan` class mostly as a field container.\r\n\r\nAlso, it would complicate any expansion of the peer services selectivity logic because different processes would require to update the flag stored in `CConMan`. For instance, the node could be seeking to exclusively connect to peers that provide block filters (up to a certain point, then pick other preferences on a case basis), or could want to minimize the number of limited connections based on the chain download state, or if a chain stale state was detected, or could be needing to disallow certain peer types for a certain time etc.\r\n\r\nConsidering this, the responsibility for managing this field seems to fit better inside the peer manager class.\r\n\r\nHappy to hear your thoughts about this. Will keep thinking about it, I think that we can still improve this to not require `cs_main` lock even if it's placed inside the peers manager class.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-08T15:23:38Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1287286613",
      "id" : 1287286613,
      "in_reply_to_id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585Mum9V",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1567568353,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1287286613/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-08T15:40:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1287286613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
