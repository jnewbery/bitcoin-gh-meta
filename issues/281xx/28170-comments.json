[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1285990092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285990092"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This interface is not the right place for a callback like this because it is not a \"net event\".\r\n\r\nWould be better to have a method on connman, e.g. `CConnman::SetDesirableServiceFlags` that is then called by peerman.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-07T14:50:21Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1285990092",
      "id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585MpqbM",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1565523628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285990092/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-07T14:54:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285990092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1286427458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427458"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This interface is not the right place for a callback like this because it is not a \"net event\".\r\n\r\nHmm ok, that would avoid locking `cs_main` in the open connections thread. Which is nice.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-07T22:20:19Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1286427458",
      "id" : 1286427458,
      "in_reply_to_id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585MrVNC",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1566217778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427458/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-07T22:20:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286427458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1287286613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1287286613"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Have thought more about this and I'm not so convinced about it anymore.\r\n\r\nThe connection manager class lives on a lower level, and manages only a fraction of the node's information. And this field is strictly linked to the node's overall status. Right now, `HasDesirableServiceFlags()` requires to know the chain sync status.\r\nSo, by placing it inside `CConMan`, we add another level of indirection. Because, most of the time, the peer manager class will call to the `CConMan` setter and subsequently call the getter to utilize it. Using the `CConMan` class mostly as a field container.\r\n\r\nAlso, it would complicate any expansion of the peer services selectivity logic because different processes would require to update the flag stored in `CConMan`. For instance, the node could be seeking to exclusively connect to peers that provide block filters (up to a certain point, then pick other preferences on a case basis), or could want to minimize the number of limited connections based on the chain download state, or if a chain stale state was detected, or could be needing to disallow certain peer types for a certain time etc.\r\n\r\nConsidering this, the responsibility for managing this field seems to fit better inside the peer manager class.\r\n\r\nHappy to hear your thoughts about this. Will keep thinking about it, we can still improve this to not require `cs_main` lock even when it's placed inside the peers manager class.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-08T15:23:38Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1287286613",
      "id" : 1287286613,
      "in_reply_to_id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585Mum9V",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1567568353,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1287286613/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-14T15:09:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1287286613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1293556312"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1293556312"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Because, most of the time, the peer manager class will call to the CConMan setter and subsequently call the getter to utilize it. \r\n\r\nI wasn't saying to make connman the container for this data, I only meant to add a setter to inform connman of the things it needs to perform its job (making connections to desirable nodes). The main container for the flags would still be peerman.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-14T14:37:45Z",
      "diff_hunk" : "@@ -666,6 +666,12 @@ class NetEventsInterface\n     /** Handle removal of a peer (clear state) */\n     virtual void FinalizeNode(const CNode& node) = 0;\n \n+    /**\n+     * Callback to determine whether the given set of service flags are sufficient\n+     * for a peer to be \"relevant\".\n+     */\n+    virtual bool HasDesirableServiceFlags(ServiceFlags services) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1293556312",
      "id" : 1293556312,
      "in_reply_to_id" : 1285990092,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII585NGhpY",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 673,
      "original_position" : 8,
      "original_start_line" : 669,
      "path" : "src/net.h",
      "position" : 8,
      "pull_request_review_id" : 1576991490,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1293556312/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 669,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-14T14:37:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1293556312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296335745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296335745"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The comment (\"shortcut for...\") was helpful for me, any reason to drop it?",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-16T19:23:07Z",
      "diff_hunk" : "@@ -1577,6 +1579,20 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n+bool PeerManagerImpl::HasDesirableServiceFlags(ServiceFlags services)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296335745",
      "id" : 1296335745,
      "line" : 1590,
      "node_id" : "PRRC_kwDOABII585NRIOB",
      "original_commit_id" : "1428b7f4e8c648fdc68ba5744d640d120d5d78eb",
      "original_line" : 1582,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1581277414,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296335745/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T20:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296335745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296355296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296355296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why stop doing extra block-relay peers in this situation? These aren't attempted during original IBD because we are  expected to be behind the tip. However, in this super-stale situation which should really not happen normally, it seems that they could only help?",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-16T19:44:37Z",
      "diff_hunk" : "@@ -5235,6 +5244,11 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (super_stale) {\n+        // Disable extra block relay peers and disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_connman.StopExtraBlockRelayPeers();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296355296",
      "id" : 1296355296,
      "line" : 5250,
      "node_id" : "PRRC_kwDOABII585NRM_g",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 5250,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1581277414,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296355296/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T20:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296355296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296375222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296375222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`m_initial_sync_finished` is set using AdjustedTime (see `CanDirectFetch()`) while it's unset using local time. In spite of plans to get rid of AdjustedTime, I  think it would be better to use it here as well, otherwise there could be constant switching back and forth in some situations where the two times differ.\r\n\r\nAlso, why introduce a new magic number of 290, can't we just use `NODE_NETWORK_LIMITED_MIN_BLOCKS` (maybe + 2, if there is a reason for it)?",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-16T20:07:35Z",
      "diff_hunk" : "@@ -1265,14 +1266,21 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n     });\n }\n \n-bool PeerManagerImpl::TipMayBeStale()\n+bool PeerManagerImpl::TipMayBeStale(bool& super_stale)\n {\n     AssertLockHeld(cs_main);\n     const Consensus::Params& consensusParams = m_chainparams.GetConsensus();\n     if (m_last_tip_update.load() == 0s) {\n         m_last_tip_update = GetTime<std::chrono::seconds>();\n     }\n-    return m_last_tip_update.load() < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty();\n+\n+    auto last_update_time = m_last_tip_update.load();\n+    if (last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 3} && mapBlocksInFlight.empty()) {\n+        // If tip is further than NODE_NETWORK_LIMITED_MIN_BLOCKS, we are really behind and shouldn't connect to limited peers anymore.\n+        super_stale = last_update_time < GetTime<std::chrono::seconds>() - std::chrono::seconds{consensusParams.nPowTargetSpacing * 290};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1296375222",
      "id" : 1296375222,
      "line" : 1280,
      "node_id" : "PRRC_kwDOABII585NRR22",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 1280,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 36,
      "pull_request_review_id" : 1581277414,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296375222/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T20:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296375222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297115636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297115636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Was it just outdated already? I'm confused by what NODE_NONE meant here before this change.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-17T11:57:16Z",
      "diff_hunk" : "@@ -327,12 +327,16 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags);\n  * guaranteed to not change dependent on state - ie they are suitable for\n  * use when describing peers which we know to be desirable, but for which\n  * we do not have a confirmed set of service flags.\n- *\n- * If the NODE_NONE return value is changed, contrib/seeds/makeseeds.py",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297115636",
      "id" : 1297115636,
      "line" : 331,
      "node_id" : "PRRC_kwDOABII585NUGn0",
      "original_commit_id" : "1dbc6cc6b177497c18664bcc08f4d55da21941a6",
      "original_line" : 331,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 24,
      "pull_request_review_id" : 1582453390,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297115636/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T11:57:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297115636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297117898"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297117898"
         }
      },
      "author_association" : "MEMBER",
      "body" : "does `peerServices` refer to the outdated code? Pehraps we should change it here?",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-17T11:59:36Z",
      "diff_hunk" : "@@ -90,6 +90,29 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n \n     /** This function is used for testing the stale tip eviction logic, see denialofservice_tests.cpp */\n     virtual void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds) = 0;\n+\n+    /**\n+     * Gets the set of service flags which are \"desirable\" for a given peer.\n+     *\n+     * These are the flags which are required for a peer to support for them\n+     * to be \"interesting\" to us, ie for us to wish to use one of our few\n+     * outbound connection slots for or for us to wish to prioritize keeping\n+     * their connection around.\n+     *\n+     * Relevant service flags may be peer- and state-specific in that the\n+     * version of the peer may determine which flags are required (eg in the\n+     * case of NODE_NETWORK_LIMITED where we seek out NODE_NETWORK peers\n+     * unless they set NODE_NETWORK_LIMITED and we are out of IBD, in which\n+     * case NODE_NETWORK_LIMITED suffices).\n+     *\n+     * Thus, generally, avoid calling with peerServices == NODE_NONE, unless",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297117898",
      "id" : 1297117898,
      "line" : 108,
      "node_id" : "PRRC_kwDOABII585NUHLK",
      "original_commit_id" : "1428b7f4e8c648fdc68ba5744d640d120d5d78eb",
      "original_line" : 108,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 19,
      "pull_request_review_id" : 1582457092,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297117898/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T11:59:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297117898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297132683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297132683"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think they would help with?",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-17T12:13:37Z",
      "diff_hunk" : "@@ -5235,6 +5244,11 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (super_stale) {\n+        // Disable extra block relay peers and disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_connman.StopExtraBlockRelayPeers();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297132683",
      "id" : 1297132683,
      "in_reply_to_id" : 1296355296,
      "line" : 5250,
      "node_id" : "PRRC_kwDOABII585NUKyL",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 5250,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1582480170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297132683/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T12:13:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297132683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297205559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297205559"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If for whatever reason our current peers aren't able to send us the blocks to get us out of this situation, maybe trying an additional one will.",
      "commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "created_at" : "2023-08-17T13:14:41Z",
      "diff_hunk" : "@@ -5235,6 +5244,11 @@ void PeerManagerImpl::CheckForStaleTipAndEvictPeers()\n     if (!m_initial_sync_finished && CanDirectFetch()) {\n         m_connman.StartExtraBlockRelayPeers();\n         m_initial_sync_finished = true;\n+    } else if (super_stale) {\n+        // Disable extra block relay peers and disallow connection to limited peers.\n+        // We need to find a full node that can help us recover.\n+        m_connman.StopExtraBlockRelayPeers();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28170#discussion_r1297205559",
      "id" : 1297205559,
      "in_reply_to_id" : 1296355296,
      "line" : 5250,
      "node_id" : "PRRC_kwDOABII585NUck3",
      "original_commit_id" : "2325ff03f42606793d3c8f2a97fc73015b9c48dd",
      "original_line" : 5250,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 1582597289,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28170",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297205559/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T13:14:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297205559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
