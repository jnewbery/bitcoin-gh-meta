[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/28165#issuecomment-1658115391) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27981](https://github.com/bitcoin/bitcoin/pull/27981) (Fix potential network stalling bug by sipa)\n* [#27407](https://github.com/bitcoin/bitcoin/pull/27407) (net, refactor: Privatise CNode send queue by dergoegge)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-07-26T20:04:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#issuecomment-1652418427",
      "id" : 1652418427,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28165",
      "node_id" : "IC_kwDOABII585ifed7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1652418427/reactions"
      },
      "updated_at" : "2023-07-31T10:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1652418427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\n> Merging the two means a future V2Transport can handle all this interaction without callers needing to be aware.\r\n\r\nð",
      "created_at" : "2023-07-31T10:41:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#issuecomment-1658115391",
      "id" : 1658115391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28165",
      "node_id" : "IC_kwDOABII585i1NU_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1658115391/reactions"
      },
      "updated_at" : "2023-07-31T10:41:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1658115391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283037011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283037011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c7720844a4357aa497362fd5b481bc1a9c27687d: I assume this separation of `CompleteInternal()` is because `EXCLUSIVE_LOCKS_REQUIRED` is only set for `V1Transport` rather than on `Transport`?",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T11:03:06Z",
      "diff_hunk" : "@@ -306,29 +307,38 @@ class V1Transport final : public Transport\n         hasher.Reset();\n     }\n \n+    bool CompleteInternal() const noexcept EXCLUSIVE_LOCKS_REQUIRED(m_cs_recv)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283037011",
      "id" : 1283037011,
      "line" : 331,
      "node_id" : "PRRC_kwDOABII585MeZdT",
      "original_commit_id" : "c7720844a4357aa497362fd5b481bc1a9c27687d",
      "original_line" : 310,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 114,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283037011/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283037011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283084032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283084032"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463 this `LOCK` should have been moved in the previous commit. Otherwise it gives a thread safety warning.",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T11:48:42Z",
      "diff_hunk" : "@@ -783,6 +783,8 @@ CNetMessage V1Transport::GetMessage(const std::chrono::microseconds time, bool&\n {\n     // Initialize out parameter\n     reject_message = false;\n+\n+    LOCK(m_cs_recv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283084032",
      "id" : 1283084032,
      "line" : 804,
      "node_id" : "PRRC_kwDOABII585Mek8A",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 787,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 99,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283084032/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283084032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283202700"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283202700"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463: `NoPendingSend()` ? That makes it more clear this method doesn't mark something done. Also it applies before the first message too.",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T13:25:31Z",
      "diff_hunk" : "@@ -271,10 +271,26 @@ class Transport {\n     // decomposes a message from the context\n     virtual CNetMessage GetMessage(std::chrono::microseconds time, bool& reject_message) = 0;\n \n-    // 2. Sending side functions:\n-\n-    // prepare message for transport (header construction, error-correction computation, payload encryption, etc.)\n-    virtual void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) const = 0;\n+    // 2. Sending side functions, for serializing messages into bytes to be sent over the wire.\n+    // Callers must guarantee that none of these functions are called concurrently w.r.t. one\n+    // another.\n+\n+    /** Whether the last provided message has been sent, and a new one can be provided. */\n+    virtual bool DoneSendingMessage() const noexcept = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283202700",
      "id" : 1283202700,
      "line" : 282,
      "node_id" : "PRRC_kwDOABII585MfB6M",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 279,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 46,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283202700/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283202700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283265993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283265993"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463: this new `assert` and the one below had me a bit worried, but they disappear in 68e48a0185751d24eecb194b8efd7028c8b590f3.\r\n\r\nI think they're ok here though:\r\n\r\n1. The very first message it's trivially clear this won't be a problem: `m_sending_header` starts out `false`, `m_bytes_sent` at `0` and `m_message_to_send.data` is initialised empty.\r\n2. `MarkBytesSent` sets these things back when (exactly) all bytes have been put in the send buffer (`vSendMsg`). In v1 this is always the case after the second (header only) or third call to `GetBytesToSend()`, after which we leave the while loop.",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T14:11:11Z",
      "diff_hunk" : "@@ -2866,23 +2911,25 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         msg.data.data()\n     );\n \n-    // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_transport->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n-\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n         bool optimisticSend(pnode->vSendMsg.empty());\n \n-        //log total amount of bytes per message type\n-        pnode->AccountForSentBytes(msg.m_type, nTotalSize);\n-        pnode->nSendSize += nTotalSize;\n+        assert(pnode->m_transport->DoneSendingMessage());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283265993",
      "id" : 1283265993,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MfRXJ",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 2919,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283265993/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:09:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283265993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283288152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283288152"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463: could add a comment here:\r\n\r\n```cpp\r\n// In v1 transport GetBytesToSend first returns a header and next the data (if any).\r\n```",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T14:26:56Z",
      "diff_hunk" : "@@ -2866,23 +2911,25 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         msg.data.data()\n     );\n \n-    // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_transport->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n-\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n         bool optimisticSend(pnode->vSendMsg.empty());\n \n-        //log total amount of bytes per message type\n-        pnode->AccountForSentBytes(msg.m_type, nTotalSize);\n-        pnode->nSendSize += nTotalSize;\n+        assert(pnode->m_transport->DoneSendingMessage());\n+        pnode->m_transport->SetMessageToSend(std::move(msg));\n+\n+        while (true) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283288152",
      "id" : 1283288152,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MfWxY",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 2922,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283288152/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283288152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283297036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283297036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463: Since we're notifying two different things about these sent bytes - and also setting `nSendSize` - I suggested some extra comments...\r\n\r\n```cpp\r\n// Update statistics per message type\r\n```",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T14:32:34Z",
      "diff_hunk" : "@@ -2866,23 +2911,25 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         msg.data.data()\n     );\n \n-    // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_transport->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n-\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n         bool optimisticSend(pnode->vSendMsg.empty());\n \n-        //log total amount of bytes per message type\n-        pnode->AccountForSentBytes(msg.m_type, nTotalSize);\n-        pnode->nSendSize += nTotalSize;\n+        assert(pnode->m_transport->DoneSendingMessage());\n+        pnode->m_transport->SetMessageToSend(std::move(msg));\n+\n+        while (true) {\n+            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n+            if (bytes.empty()) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283297036",
      "id" : 1283297036,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MfY8M",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 2924,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283297036/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283297036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283298309"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283298309"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463\r\n\r\n```cpp\r\n// Notify Transport that bytes have been processed\r\n```\r\n",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T14:33:28Z",
      "diff_hunk" : "@@ -2866,23 +2911,25 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         msg.data.data()\n     );\n \n-    // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_transport->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n-\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n         bool optimisticSend(pnode->vSendMsg.empty());\n \n-        //log total amount of bytes per message type\n-        pnode->AccountForSentBytes(msg.m_type, nTotalSize);\n-        pnode->nSendSize += nTotalSize;\n+        assert(pnode->m_transport->DoneSendingMessage());\n+        pnode->m_transport->SetMessageToSend(std::move(msg));\n+\n+        while (true) {\n+            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n+            if (bytes.empty()) break;\n+            pnode->AccountForSentBytes(msg_type, bytes.size());\n+            pnode->nSendSize += bytes.size();\n+            if (pnode->nSendSize > nSendBufferMaxSize) pnode->fPauseSend = true;\n+            pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283298309",
      "id" : 1283298309,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MfZQF",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 2928,
      "original_position" : 107,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283298309/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283298309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283301879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283301879"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463\r\n\r\n```cpp\r\n// Update bytes in send buffer\r\n```\r\n\r\n(becomes \"Update memory use of send buffer\" in the next commit)",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T14:36:03Z",
      "diff_hunk" : "@@ -2866,23 +2911,25 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         msg.data.data()\n     );\n \n-    // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_transport->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n-\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n         bool optimisticSend(pnode->vSendMsg.empty());\n \n-        //log total amount of bytes per message type\n-        pnode->AccountForSentBytes(msg.m_type, nTotalSize);\n-        pnode->nSendSize += nTotalSize;\n+        assert(pnode->m_transport->DoneSendingMessage());\n+        pnode->m_transport->SetMessageToSend(std::move(msg));\n+\n+        while (true) {\n+            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n+            if (bytes.empty()) break;\n+            pnode->AccountForSentBytes(msg_type, bytes.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283301879",
      "id" : 1283301879,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MfaH3",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 2925,
      "original_position" : 104,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283301879/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283301879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283305145"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283305145"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463: could we just assume bytes will get sent this if `GetBytesToSend()` has been called? Afaik there's no way to handle a failure anyway. But I guess it's safer to track it explicitly.\r\n\r\nUpdate: in 68e48a0185751d24eecb194b8efd7028c8b590f3 this function becomes more important, and is used to track when not all bytes are sent.",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T14:38:24Z",
      "diff_hunk" : "@@ -271,10 +271,26 @@ class Transport {\n     // decomposes a message from the context\n     virtual CNetMessage GetMessage(std::chrono::microseconds time, bool& reject_message) = 0;\n \n-    // 2. Sending side functions:\n-\n-    // prepare message for transport (header construction, error-correction computation, payload encryption, etc.)\n-    virtual void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) const = 0;\n+    // 2. Sending side functions, for serializing messages into bytes to be sent over the wire.\n+    // Callers must guarantee that none of these functions are called concurrently w.r.t. one\n+    // another.\n+\n+    /** Whether the last provided message has been sent, and a new one can be provided. */\n+    virtual bool DoneSendingMessage() const noexcept = 0;\n+    /** Set a message to send (only allowed if DoneSendingMessage()). */\n+    virtual void SetMessageToSend(CSerializedNetMsg&& msg) noexcept = 0;\n+    /** Whether there are bytes to send on the wire. */\n+    virtual bool HaveBytesToSend() const noexcept = 0;\n+    /** Return type for GetBytesToSend, consisting of:\n+     *  - Span<const uint8_t>: span of bytes to be sent over the wire (empty if !HaveBytesToSend())\n+     *  - bool: whether more bytes to be sent follow after the ones in the span have been sent\n+     *  - const std::string&: message type on behalf of which this is being sent (or \"\" if n/a)\n+     */\n+    using BytesToSend = std::tuple<Span<const uint8_t>, bool, const std::string&>;\n+    /** Get bytes to send on the wire. */\n+    virtual BytesToSend GetBytesToSend() const noexcept = 0;\n+    /** Report how many bytes returned by GetBytesToSend() have been sent. No effect if 0. */\n+    virtual void MarkBytesSent(size_t bytes_sent) noexcept = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283305145",
      "id" : 1283305145,
      "line" : 296,
      "node_id" : "PRRC_kwDOABII585Mfa65",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 293,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 60,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283305145/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:12:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283305145",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283320253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283320253"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463 this `reserve` wasn't useful?",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T14:49:03Z",
      "diff_hunk" : "@@ -827,8 +834,46 @@ void V1Transport::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsign\n     memcpy(hdr.pchChecksum, hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n     // serialize header\n-    header.reserve(CMessageHeader::HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283320253",
      "id" : 1283320253,
      "line" : 829,
      "node_id" : "PRRC_kwDOABII585Mfem9",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 830,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 125,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283320253/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283320253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283352376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283352376"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1937a5fcf795149c44b7f4f016c05000ac3adaf9  Isn't `>m_transport->GetSendMemoryUsage()` 0 since we just sent the message and cleared it?\r\n\r\n(but that changes in the next commit 68e48a0185751d24eecb194b8efd7028c8b590f3)",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T15:13:16Z",
      "diff_hunk" : "@@ -2923,11 +2940,11 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n             const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n             if (bytes.empty()) break;\n             pnode->AccountForSentBytes(msg_type, bytes.size());\n-            pnode->nSendSize += bytes.size();\n-            if (pnode->nSendSize > nSendBufferMaxSize) pnode->fPauseSend = true;\n             pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});\n+            pnode->m_send_memusage += sizeof(pnode->vSendMsg.back()) + memusage::DynamicUsage(pnode->vSendMsg.back());\n             pnode->m_transport->MarkBytesSent(bytes.size());\n         }\n+        if (pnode->m_send_memusage + pnode->m_transport->GetSendMemoryUsage() > nSendBufferMaxSize) pnode->fPauseSend = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283352376",
      "id" : 1283352376,
      "line" : 2951,
      "node_id" : "PRRC_kwDOABII585Mfmc4",
      "original_commit_id" : "1937a5fcf795149c44b7f4f016c05000ac3adaf9",
      "original_line" : 2947,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 300,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283352376/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283352376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283416754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283416754"
         }
      },
      "author_association" : "MEMBER",
      "body" : "68e48a0185751d24eecb194b8efd7028c8b590f3: this is much readable than the intermediate calculation introduced in 1937a5fcf795149c44b7f4f016c05000ac3adaf9. It might be worth moving that commit after here.",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T16:03:02Z",
      "diff_hunk" : "@@ -2931,23 +2936,12 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n-        bool optimisticSend(pnode->vSendMsg.empty());\n-\n-        assert(pnode->m_transport->DoneSendingMessage());\n-        pnode->m_transport->SetMessageToSend(std::move(msg));\n+        bool optimisticSend{pnode->vSendMsg.empty() && pnode->m_transport->DoneSendingMessage()};\n \n-        while (true) {\n-            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n-            if (bytes.empty()) break;\n-            pnode->AccountForSentBytes(msg_type, bytes.size());\n-            pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});\n-            pnode->m_send_memusage += sizeof(pnode->vSendMsg.back()) + memusage::DynamicUsage(pnode->vSendMsg.back());\n-            pnode->m_transport->MarkBytesSent(bytes.size());\n-        }\n+        pnode->m_send_memusage += msg.GetMemoryUsage();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283416754",
      "id" : 1283416754,
      "line" : 2949,
      "node_id" : "PRRC_kwDOABII585Mf2Ky",
      "original_commit_id" : "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "original_line" : 2941,
      "original_position" : 104,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 298,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283416754/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283416754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283427444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283427444"
         }
      },
      "author_association" : "MEMBER",
      "body" : "68e48a0185751d24eecb194b8efd7028c8b590f3: This could be a good time to document what optimistic send actually is. From 1817398b397afebcc857c40a16d201c84878cb89:\r\n\r\n```cpp\r\n// Because the poll/select loop may pause for 100msec before actually doing a\r\n// send, and we have no way to force the loop awake, try sending from the calling\r\n// thread if the queue is empty.\r\n```\r\n\r\nOr shorter: `// which avoids a delay of up to SELECT_TIMEOUT_MILLISECONDS.`\r\n",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T16:12:01Z",
      "diff_hunk" : "@@ -2931,23 +2936,12 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n-        bool optimisticSend(pnode->vSendMsg.empty());\n-\n-        assert(pnode->m_transport->DoneSendingMessage());\n-        pnode->m_transport->SetMessageToSend(std::move(msg));\n+        bool optimisticSend{pnode->vSendMsg.empty() && pnode->m_transport->DoneSendingMessage()};\n \n-        while (true) {\n-            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n-            if (bytes.empty()) break;\n-            pnode->AccountForSentBytes(msg_type, bytes.size());\n-            pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});\n-            pnode->m_send_memusage += sizeof(pnode->vSendMsg.back()) + memusage::DynamicUsage(pnode->vSendMsg.back());\n-            pnode->m_transport->MarkBytesSent(bytes.size());\n-        }\n+        pnode->m_send_memusage += msg.GetMemoryUsage();\n+        pnode->vSendMsg.push_back(std::move(msg));\n         if (pnode->m_send_memusage + pnode->m_transport->GetSendMemoryUsage() > nSendBufferMaxSize) pnode->fPauseSend = true;\n \n-        assert(pnode->m_transport->DoneSendingMessage());\n-\n         // If write queue empty, attempt \"optimistic write\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283427444",
      "id" : 1283427444,
      "line" : 2953,
      "node_id" : "PRRC_kwDOABII585Mf4x0",
      "original_commit_id" : "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "original_line" : 2945,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 302,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283427444/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283427444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283440338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283440338"
         }
      },
      "author_association" : "MEMBER",
      "body" : "68e48a0185751d24eecb194b8efd7028c8b590f3 Is the above comment still correct? \"As this only happens when optimistic write failed\"",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T16:23:16Z",
      "diff_hunk" : "@@ -1298,7 +1301,9 @@ Sock::EventsPerSock CConnman::GenerateWaitSockets(Span<CNode* const> nodes)\n         bool select_send;\n         {\n             LOCK(pnode->cs_vSend);\n-            select_send = !pnode->vSendMsg.empty();\n+            // This relies on optimistic send to make sure the transport always has a message to\n+            // send if there are any.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283440338",
      "id" : 1283440338,
      "line" : 1313,
      "node_id" : "PRRC_kwDOABII585Mf77S",
      "original_commit_id" : "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "original_line" : 1305,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 261,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283440338/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283440338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283461349"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283461349"
         }
      },
      "author_association" : "MEMBER",
      "body" : "68e48a0185751d24eecb194b8efd7028c8b590f3\r\n\r\n```cpp\r\n// Leave message in the transport for when the socket is available.\r\n// v2 transport would also require waiting for the handshake to complete\r\n```\r\n\r\nWith v2 I assume we can't even call `GetBytesToSend` before the handshake?",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T16:41:56Z",
      "diff_hunk" : "@@ -897,37 +897,39 @@ size_t CConnman::SocketSendData(CNode& node) const\n     auto it = node.vSendMsg.begin();\n     size_t nSentSize = 0;\n \n-    while (it != node.vSendMsg.end()) {\n-        const auto& data = *it;\n-        assert(data.size() > node.nSendOffset);\n+    while (true) {\n+        bool progress = false;\n+        if (it != node.vSendMsg.end() && node.m_transport->DoneSendingMessage()) {\n+            // If possible, move one message from the send queue to the transport.\n+            node.m_send_memusage -= it->GetMemoryUsage();\n+            node.m_transport->SetMessageToSend(std::move(*it));\n+            ++it;\n+            progress = true;\n+        }\n+        const auto& [data, more, msg_type] = node.m_transport->GetBytesToSend();\n         int nBytes = 0;\n-        {\n+        if (!data.empty()) {\n             LOCK(node.m_sock_mutex);\n             if (!node.m_sock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283461349",
      "id" : 1283461349,
      "line" : 921,
      "node_id" : "PRRC_kwDOABII585MgBDl",
      "original_commit_id" : "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "original_line" : 913,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 198,
      "pull_request_review_id" : 1560842698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283461349/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T17:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283461349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283605312"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283605312"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We can - In fact the handshake itself is sent this way (that's the nice part about this abstraction, the caller doesn't know or care whether bytes being sent are on behalf of a message we're trying to send or something else).",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T19:02:32Z",
      "diff_hunk" : "@@ -897,37 +897,39 @@ size_t CConnman::SocketSendData(CNode& node) const\n     auto it = node.vSendMsg.begin();\n     size_t nSentSize = 0;\n \n-    while (it != node.vSendMsg.end()) {\n-        const auto& data = *it;\n-        assert(data.size() > node.nSendOffset);\n+    while (true) {\n+        bool progress = false;\n+        if (it != node.vSendMsg.end() && node.m_transport->DoneSendingMessage()) {\n+            // If possible, move one message from the send queue to the transport.\n+            node.m_send_memusage -= it->GetMemoryUsage();\n+            node.m_transport->SetMessageToSend(std::move(*it));\n+            ++it;\n+            progress = true;\n+        }\n+        const auto& [data, more, msg_type] = node.m_transport->GetBytesToSend();\n         int nBytes = 0;\n-        {\n+        if (!data.empty()) {\n             LOCK(node.m_sock_mutex);\n             if (!node.m_sock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283605312",
      "id" : 1283605312,
      "in_reply_to_id" : 1283461349,
      "line" : 921,
      "node_id" : "PRRC_kwDOABII585MgkNA",
      "original_commit_id" : "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "original_line" : 913,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 198,
      "pull_request_review_id" : 1561694994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283605312/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T19:02:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283605312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283606280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283606280"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, it should be 0 at this point, but that won't remain with the next commit. A temporary explanation message could be added to explain that here.",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T19:03:41Z",
      "diff_hunk" : "@@ -2923,11 +2940,11 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n             const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n             if (bytes.empty()) break;\n             pnode->AccountForSentBytes(msg_type, bytes.size());\n-            pnode->nSendSize += bytes.size();\n-            if (pnode->nSendSize > nSendBufferMaxSize) pnode->fPauseSend = true;\n             pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});\n+            pnode->m_send_memusage += sizeof(pnode->vSendMsg.back()) + memusage::DynamicUsage(pnode->vSendMsg.back());\n             pnode->m_transport->MarkBytesSent(bytes.size());\n         }\n+        if (pnode->m_send_memusage + pnode->m_transport->GetSendMemoryUsage() > nSendBufferMaxSize) pnode->fPauseSend = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283606280",
      "id" : 1283606280,
      "in_reply_to_id" : 1283352376,
      "line" : 2951,
      "node_id" : "PRRC_kwDOABII585MgkcI",
      "original_commit_id" : "1937a5fcf795149c44b7f4f016c05000ac3adaf9",
      "original_line" : 2947,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 300,
      "pull_request_review_id" : 1561696448,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283606280/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T19:03:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283606280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283610490"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283610490"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's because I don't want a recursive lock, and I'm introducing a caller of `CompleteInternal()` that already holds `m_cs_recv`.",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T19:08:23Z",
      "diff_hunk" : "@@ -306,29 +307,38 @@ class V1Transport final : public Transport\n         hasher.Reset();\n     }\n \n+    bool CompleteInternal() const noexcept EXCLUSIVE_LOCKS_REQUIRED(m_cs_recv)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283610490",
      "id" : 1283610490,
      "in_reply_to_id" : 1283037011,
      "line" : 331,
      "node_id" : "PRRC_kwDOABII585Mgld6",
      "original_commit_id" : "c7720844a4357aa497362fd5b481bc1a9c27687d",
      "original_line" : 310,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 114,
      "pull_request_review_id" : 1561702502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283610490/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T19:08:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283610490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283633525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283633525"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In general, it's true that the new sending interface is overly complicated for how it is used initially, and then it only becomes apparent in the next commit. \r\n\r\nHere specifically, indeed, everything returned by `GetBytesToSend` is initially always marked sent, but in the next commit that changes, as the buffering responsibility is moved from `vSendMsg` to `m_transport`. I'm happy to add (possibly temporary) comments to explain what's happening.",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T19:29:45Z",
      "diff_hunk" : "@@ -271,10 +271,26 @@ class Transport {\n     // decomposes a message from the context\n     virtual CNetMessage GetMessage(std::chrono::microseconds time, bool& reject_message) = 0;\n \n-    // 2. Sending side functions:\n-\n-    // prepare message for transport (header construction, error-correction computation, payload encryption, etc.)\n-    virtual void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) const = 0;\n+    // 2. Sending side functions, for serializing messages into bytes to be sent over the wire.\n+    // Callers must guarantee that none of these functions are called concurrently w.r.t. one\n+    // another.\n+\n+    /** Whether the last provided message has been sent, and a new one can be provided. */\n+    virtual bool DoneSendingMessage() const noexcept = 0;\n+    /** Set a message to send (only allowed if DoneSendingMessage()). */\n+    virtual void SetMessageToSend(CSerializedNetMsg&& msg) noexcept = 0;\n+    /** Whether there are bytes to send on the wire. */\n+    virtual bool HaveBytesToSend() const noexcept = 0;\n+    /** Return type for GetBytesToSend, consisting of:\n+     *  - Span<const uint8_t>: span of bytes to be sent over the wire (empty if !HaveBytesToSend())\n+     *  - bool: whether more bytes to be sent follow after the ones in the span have been sent\n+     *  - const std::string&: message type on behalf of which this is being sent (or \"\" if n/a)\n+     */\n+    using BytesToSend = std::tuple<Span<const uint8_t>, bool, const std::string&>;\n+    /** Get bytes to send on the wire. */\n+    virtual BytesToSend GetBytesToSend() const noexcept = 0;\n+    /** Report how many bytes returned by GetBytesToSend() have been sent. No effect if 0. */\n+    virtual void MarkBytesSent(size_t bytes_sent) noexcept = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283633525",
      "id" : 1283633525,
      "in_reply_to_id" : 1283305145,
      "line" : 296,
      "node_id" : "PRRC_kwDOABII585MgrF1",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 293,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 60,
      "pull_request_review_id" : 1561737078,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283633525/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T19:29:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283633525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283660977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283660977"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't reordering works without (even) more intermediary complexity. The issue is \"net: move message serialization from PushMessage to SocketSendData\" changes the data type of `vSendMsg` from bytes-to-be-sent to messages-to-be-sent, and the latter just don't have a known size-on-the-wire (unless an additional API to transports is added for that, or hardcoding the V1 message encoding size rules). That's why this PR first changes the notion of send buffer size: the old notion just doesn't really make sense anymore after the buffer changes introduced here.",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T20:00:47Z",
      "diff_hunk" : "@@ -2931,23 +2936,12 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n-        bool optimisticSend(pnode->vSendMsg.empty());\n-\n-        assert(pnode->m_transport->DoneSendingMessage());\n-        pnode->m_transport->SetMessageToSend(std::move(msg));\n+        bool optimisticSend{pnode->vSendMsg.empty() && pnode->m_transport->DoneSendingMessage()};\n \n-        while (true) {\n-            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n-            if (bytes.empty()) break;\n-            pnode->AccountForSentBytes(msg_type, bytes.size());\n-            pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});\n-            pnode->m_send_memusage += sizeof(pnode->vSendMsg.back()) + memusage::DynamicUsage(pnode->vSendMsg.back());\n-            pnode->m_transport->MarkBytesSent(bytes.size());\n-        }\n+        pnode->m_send_memusage += msg.GetMemoryUsage();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283660977",
      "id" : 1283660977,
      "in_reply_to_id" : 1283416754,
      "line" : 2949,
      "node_id" : "PRRC_kwDOABII585Mgxyx",
      "original_commit_id" : "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "original_line" : 2941,
      "original_position" : 104,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 298,
      "pull_request_review_id" : 1561776670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283660977/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T20:00:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283660977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283674053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283674053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually, that name would be confusing for V2, where it's possible that there is no pending message, but also no message can be provided (yet) because the handshake has not completed.\r\n\r\nPerhaps `CanSetNewMessageToSend()` is better? (let the bikesheddening begin!)",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-03T20:15:35Z",
      "diff_hunk" : "@@ -271,10 +271,26 @@ class Transport {\n     // decomposes a message from the context\n     virtual CNetMessage GetMessage(std::chrono::microseconds time, bool& reject_message) = 0;\n \n-    // 2. Sending side functions:\n-\n-    // prepare message for transport (header construction, error-correction computation, payload encryption, etc.)\n-    virtual void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) const = 0;\n+    // 2. Sending side functions, for serializing messages into bytes to be sent over the wire.\n+    // Callers must guarantee that none of these functions are called concurrently w.r.t. one\n+    // another.\n+\n+    /** Whether the last provided message has been sent, and a new one can be provided. */\n+    virtual bool DoneSendingMessage() const noexcept = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283674053",
      "id" : 1283674053,
      "in_reply_to_id" : 1283202700,
      "line" : 282,
      "node_id" : "PRRC_kwDOABII585Mg0_F",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 279,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 46,
      "pull_request_review_id" : 1561795385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283674053/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-03T20:15:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283674053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1284194811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284194811"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess it's not entirely clear to me whose responsibility it is to ensure the handshake has been done: https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283674053 (I assume it will be in the main PR)",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-04T09:22:28Z",
      "diff_hunk" : "@@ -897,37 +897,39 @@ size_t CConnman::SocketSendData(CNode& node) const\n     auto it = node.vSendMsg.begin();\n     size_t nSentSize = 0;\n \n-    while (it != node.vSendMsg.end()) {\n-        const auto& data = *it;\n-        assert(data.size() > node.nSendOffset);\n+    while (true) {\n+        bool progress = false;\n+        if (it != node.vSendMsg.end() && node.m_transport->DoneSendingMessage()) {\n+            // If possible, move one message from the send queue to the transport.\n+            node.m_send_memusage -= it->GetMemoryUsage();\n+            node.m_transport->SetMessageToSend(std::move(*it));\n+            ++it;\n+            progress = true;\n+        }\n+        const auto& [data, more, msg_type] = node.m_transport->GetBytesToSend();\n         int nBytes = 0;\n-        {\n+        if (!data.empty()) {\n             LOCK(node.m_sock_mutex);\n             if (!node.m_sock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1284194811",
      "id" : 1284194811,
      "in_reply_to_id" : 1283461349,
      "line" : 921,
      "node_id" : "PRRC_kwDOABII585Mi0H7",
      "original_commit_id" : "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "original_line" : 913,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 198,
      "pull_request_review_id" : 1562506904,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284194811/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-04T09:22:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284194811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1284382381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284382381"
         }
      },
      "author_association" : "MEMBER",
      "body" : "My view is that anything that is different between v1 and v2 connections ought to be handled by the respective transport class.\n\nIn V2 there are multiple stages a connection goes through (pubkey, garbage+terminator, garbage authentication packet, version negotiation packet, and finally application data during which bitcoin P2P messages can be sent); this will be implemented using a finite state machine on sender and receiver side to control what state we are in. Only during the last phase (application data) can `SetMessageToSend` be called.\n\n`GetBytesToSend` can always be called. If there is nothing to send, it'll return empty. If there is, (at least) some part of it will be returned.\n* For V1, `GetBytesToSend()` is non-empty whenever there is a header or a payload to be sent.\n* For V2, `GetBytesToSend()` is non-empty whenever there are handshake bytes (pubkey, garbage, garbage auth, version packet) or an application packet (encoding a message) to be sent.",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-04T12:50:49Z",
      "diff_hunk" : "@@ -897,37 +897,39 @@ size_t CConnman::SocketSendData(CNode& node) const\n     auto it = node.vSendMsg.begin();\n     size_t nSentSize = 0;\n \n-    while (it != node.vSendMsg.end()) {\n-        const auto& data = *it;\n-        assert(data.size() > node.nSendOffset);\n+    while (true) {\n+        bool progress = false;\n+        if (it != node.vSendMsg.end() && node.m_transport->DoneSendingMessage()) {\n+            // If possible, move one message from the send queue to the transport.\n+            node.m_send_memusage -= it->GetMemoryUsage();\n+            node.m_transport->SetMessageToSend(std::move(*it));\n+            ++it;\n+            progress = true;\n+        }\n+        const auto& [data, more, msg_type] = node.m_transport->GetBytesToSend();\n         int nBytes = 0;\n-        {\n+        if (!data.empty()) {\n             LOCK(node.m_sock_mutex);\n             if (!node.m_sock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1284382381",
      "id" : 1284382381,
      "in_reply_to_id" : 1283461349,
      "line" : 921,
      "node_id" : "PRRC_kwDOABII585Mjh6t",
      "original_commit_id" : "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "original_line" : 913,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 198,
      "pull_request_review_id" : 1562808679,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284382381/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-04T14:14:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284382381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1286479195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286479195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "FWIW, I agree that the `Done` prefix of the method name is quite confusing, for both the reasons Sjors lined out. `CanSetNewMessageToSend()` sounds much better to me (maybe even just `CanSetMessageToSend`, to have the full name of the method included which can be called if `true` is returned?).",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-08T00:08:50Z",
      "diff_hunk" : "@@ -271,10 +271,26 @@ class Transport {\n     // decomposes a message from the context\n     virtual CNetMessage GetMessage(std::chrono::microseconds time, bool& reject_message) = 0;\n \n-    // 2. Sending side functions:\n-\n-    // prepare message for transport (header construction, error-correction computation, payload encryption, etc.)\n-    virtual void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) const = 0;\n+    // 2. Sending side functions, for serializing messages into bytes to be sent over the wire.\n+    // Callers must guarantee that none of these functions are called concurrently w.r.t. one\n+    // another.\n+\n+    /** Whether the last provided message has been sent, and a new one can be provided. */\n+    virtual bool DoneSendingMessage() const noexcept = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1286479195",
      "id" : 1286479195,
      "in_reply_to_id" : 1283202700,
      "line" : 282,
      "node_id" : "PRRC_kwDOABII585Mrh1b",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 279,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 46,
      "pull_request_review_id" : 1566293059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286479195/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-08T00:08:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286479195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1292498404"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1292498404"
         }
      },
      "author_association" : "NONE",
      "body" : "Mh looks like that `header` is no longer used?",
      "commit_id" : "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "created_at" : "2023-08-12T21:20:11Z",
      "diff_hunk" : "@@ -827,8 +834,46 @@ void V1Transport::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsign\n     memcpy(hdr.pchChecksum, hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n     // serialize header\n-    header.reserve(CMessageHeader::HEADER_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1292498404",
      "id" : 1292498404,
      "in_reply_to_id" : 1283320253,
      "line" : 829,
      "node_id" : "PRRC_kwDOABII585NCfXk",
      "original_commit_id" : "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "original_line" : 830,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 125,
      "pull_request_review_id" : 1575430346,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1292498404/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-12T21:20:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1292498404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17150045?v=4",
         "events_url" : "https://api.github.com/users/vincenzopalazzo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vincenzopalazzo/followers",
         "following_url" : "https://api.github.com/users/vincenzopalazzo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vincenzopalazzo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vincenzopalazzo",
         "id" : 17150045,
         "login" : "vincenzopalazzo",
         "node_id" : "MDQ6VXNlcjE3MTUwMDQ1",
         "organizations_url" : "https://api.github.com/users/vincenzopalazzo/orgs",
         "received_events_url" : "https://api.github.com/users/vincenzopalazzo/received_events",
         "repos_url" : "https://api.github.com/users/vincenzopalazzo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vincenzopalazzo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vincenzopalazzo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vincenzopalazzo"
      }
   }
]
