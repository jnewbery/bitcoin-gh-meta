[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28609).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2023-10-06T22:37:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#issuecomment-1751471816",
      "id" : 1751471816,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28609",
      "node_id" : "IC_kwDOABII585oZVbI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751471816/reactions"
      },
      "updated_at" : "2023-10-06T22:37:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1751471816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350342749"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350342749"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d73ecbd2d8:\r\n\r\nWhat is we use `LoadToWallet()` instead?. It will also set `m_it_wtxOrdered`, which is not set atm. And also update the state if needed.\r\nSomething like:\r\n```c++\r\n// Add to watchonly wallet\r\nconst uint256& hash = wtx->GetHash();\r\nconst CWalletTx& to_copy_wtx = *wtx;\r\nif (!data.watchonly_wallet->LoadToWallet(hash, [&](CWalletTx& ins_wtx, bool new_tx) EXCLUSIVE_LOCKS_REQUIRED(data.watchonly_wallet->cs_wallet) {\r\n    if (!new_tx) return false;\r\n    ins_wtx.SetTx(to_copy_wtx.tx);\r\n    ins_wtx.CloneFrom(to_copy_wtx);\r\n    ins_wtx.nOrderPos = data.watchonly_wallet->IncOrderPosNext(watchonly_batch.get());\r\n    return true;\r\n})) {\r\n    error = strprintf(_(\"Error: Could not add watchonly tx %s to watchonly wallet\"), wtx->GetHash().GetHex());\r\n    return false;\r\n}\r\nwatchonly_batch->WriteTx(data.watchonly_wallet->mapWallet.at(hash));\r\n// Mark as to remove from this wallet\r\ntxids_to_delete.push_back(hash);\r\ncontinue;\r\n```",
      "commit_id" : "1fe21d2bde12db18376eb31617b603a9f9043c46",
      "created_at" : "2023-10-09T13:54:05Z",
      "diff_hunk" : "@@ -3916,10 +3920,17 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n+                    // Bypass the AddToWallet checks by inserting into mapWallet and then writing it to the database directly\n+                    auto ret = data.watchonly_wallet->mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(wtx->GetHash()), std::forward_as_tuple(wtx->tx, wtx->m_state));\n+                    if (!ret.second) {\n                         error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n                         return false;\n                     }\n+                    CWalletTx& ins_wtx = (*ret.first).second;\n+                    ins_wtx.CloneFrom(*wtx);\n+                    ins_wtx.nOrderPos = IncOrderPosNext(watchonly_batch.get());\n+                    data.watchonly_wallet->AddToSpends(ins_wtx);\n+                    watchonly_batch->WriteTx(ins_wtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350342749",
      "id" : 1350342749,
      "line" : 3933,
      "node_id" : "PRRC_kwDOABII585QfJhd",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 3933,
      "original_position" : 26,
      "original_start_line" : 3923,
      "path" : "src/wallet/wallet.cpp",
      "position" : 26,
      "pull_request_review_id" : 1664508703,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350342749/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 3923,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-09T15:05:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350342749",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350400835"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350400835"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d73ecbd2:\r\n\r\nBug here, `IncOrderPosNext()` is a wallet method. So, the main wallet order pos is being increased, instead of the watch-only wallet one. Need to be:\r\n```\r\ndata.watchonly_wallet->IncOrderPosNext(watchonly_batch.get())\r\n``` ",
      "commit_id" : "1fe21d2bde12db18376eb31617b603a9f9043c46",
      "created_at" : "2023-10-09T14:41:10Z",
      "diff_hunk" : "@@ -3916,10 +3920,17 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n+                    // Bypass the AddToWallet checks by inserting into mapWallet and then writing it to the database directly\n+                    auto ret = data.watchonly_wallet->mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(wtx->GetHash()), std::forward_as_tuple(wtx->tx, wtx->m_state));\n+                    if (!ret.second) {\n                         error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n                         return false;\n                     }\n+                    CWalletTx& ins_wtx = (*ret.first).second;\n+                    ins_wtx.CloneFrom(*wtx);\n+                    ins_wtx.nOrderPos = IncOrderPosNext(watchonly_batch.get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350400835",
      "id" : 1350400835,
      "line" : 3931,
      "node_id" : "PRRC_kwDOABII585QfXtD",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 3931,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 24,
      "pull_request_review_id" : 1664629851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350400835/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-09T14:41:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350400835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350415419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350415419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d73ecbd2d:\r\n\r\nnit: the 'tx' naming shadows the `CWalletTx::tx` member. Maybe call it `_tx`.",
      "commit_id" : "1fe21d2bde12db18376eb31617b603a9f9043c46",
      "created_at" : "2023-10-09T14:53:18Z",
      "diff_hunk" : "@@ -24,4 +24,16 @@ int64_t CWalletTx::GetTxTime() const\n     int64_t n = nTimeSmart;\n     return n ? n : nTimeReceived;\n }\n+\n+void CWalletTx::CloneFrom(const CWalletTx& tx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350415419",
      "id" : 1350415419,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII585QfbQ7",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 28,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/transaction.cpp",
      "position" : 5,
      "pull_request_review_id" : 1664667766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350415419/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-09T15:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350415419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350447031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350447031"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d550863e5:\r\n\r\nAs `LoadWallet()` can return a nullptr if loading fails. Would be good to cover this possibility too.",
      "commit_id" : "af91cfacdd6f43eeb73321c5df90ea3c65b18e56",
      "created_at" : "2023-10-09T15:18:51Z",
      "diff_hunk" : "@@ -4228,11 +4244,23 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     }\n \n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n+        // Migration successful, unload all wallets locally, then reload them.\n         assert(local_wallet.use_count() == 1);\n         local_wallet.reset();\n         res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n         res.wallet_name = wallet_name;\n+        if (res.watchonly_wallet) {\n+            assert(res.watchonly_wallet.use_count() == 1);\n+            std::string watchonly_wallet_name = res.watchonly_wallet->GetName();\n+            res.watchonly_wallet.reset();\n+            res.watchonly_wallet = LoadWallet(context, watchonly_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        }\n+        if (res.solvables_wallet) {\n+            assert(res.solvables_wallet.use_count() == 1);\n+            std::string solvables_wallet_name = res.solvables_wallet->GetName();\n+            res.solvables_wallet.reset();\n+            res.solvables_wallet = LoadWallet(context, solvables_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1350447031",
      "id" : 1350447031,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qfi-3",
      "original_commit_id" : "d550863e5bbe097534d8cefb0f5afd63ad19a253",
      "original_line" : 4263,
      "original_position" : 66,
      "original_start_line" : 4252,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1664667766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350447031/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-09T22:50:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1350447031",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353164664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353164664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested.",
      "commit_id" : "af91cfacdd6f43eeb73321c5df90ea3c65b18e56",
      "created_at" : "2023-10-10T18:52:48Z",
      "diff_hunk" : "@@ -3916,10 +3920,17 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n+                    // Bypass the AddToWallet checks by inserting into mapWallet and then writing it to the database directly\n+                    auto ret = data.watchonly_wallet->mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(wtx->GetHash()), std::forward_as_tuple(wtx->tx, wtx->m_state));\n+                    if (!ret.second) {\n                         error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n                         return false;\n                     }\n+                    CWalletTx& ins_wtx = (*ret.first).second;\n+                    ins_wtx.CloneFrom(*wtx);\n+                    ins_wtx.nOrderPos = IncOrderPosNext(watchonly_batch.get());\n+                    data.watchonly_wallet->AddToSpends(ins_wtx);\n+                    watchonly_batch->WriteTx(ins_wtx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353164664",
      "id" : 1353164664,
      "in_reply_to_id" : 1350342749,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qp6d4",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 3933,
      "original_position" : 26,
      "original_start_line" : 3923,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1668642881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353164664/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-10T18:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353164664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353165036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested.",
      "commit_id" : "af91cfacdd6f43eeb73321c5df90ea3c65b18e56",
      "created_at" : "2023-10-10T18:52:53Z",
      "diff_hunk" : "@@ -3916,10 +3920,17 @@ bool CWallet::ApplyMigrationData(MigrationData& data, bilingual_str& error)\n                 LOCK(data.watchonly_wallet->cs_wallet);\n                 if (data.watchonly_wallet->IsMine(*wtx->tx) || data.watchonly_wallet->IsFromMe(*wtx->tx)) {\n                     // Add to watchonly wallet\n-                    if (!data.watchonly_wallet->AddToWallet(wtx->tx, wtx->m_state)) {\n+                    // Bypass the AddToWallet checks by inserting into mapWallet and then writing it to the database directly\n+                    auto ret = data.watchonly_wallet->mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(wtx->GetHash()), std::forward_as_tuple(wtx->tx, wtx->m_state));\n+                    if (!ret.second) {\n                         error = _(\"Error: Could not add watchonly tx to watchonly wallet\");\n                         return false;\n                     }\n+                    CWalletTx& ins_wtx = (*ret.first).second;\n+                    ins_wtx.CloneFrom(*wtx);\n+                    ins_wtx.nOrderPos = IncOrderPosNext(watchonly_batch.get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353165036",
      "id" : 1353165036,
      "in_reply_to_id" : 1350400835,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qp6js",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 3931,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1668643329,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165036/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T18:52:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353165362"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165362"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested.",
      "commit_id" : "af91cfacdd6f43eeb73321c5df90ea3c65b18e56",
      "created_at" : "2023-10-10T18:52:57Z",
      "diff_hunk" : "@@ -24,4 +24,16 @@ int64_t CWalletTx::GetTxTime() const\n     int64_t n = nTimeSmart;\n     return n ? n : nTimeReceived;\n }\n+\n+void CWalletTx::CloneFrom(const CWalletTx& tx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353165362",
      "id" : 1353165362,
      "in_reply_to_id" : 1350415419,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qp6oy",
      "original_commit_id" : "d73ecbd2d85e3eb4e778b85bccecfabbd171207a",
      "original_line" : 28,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/transaction.cpp",
      "position" : null,
      "pull_request_review_id" : 1668643805,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165362/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-10-10T18:52:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353165362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353166779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353166779"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've added handling to cleanup when reloading fails.",
      "commit_id" : "af91cfacdd6f43eeb73321c5df90ea3c65b18e56",
      "created_at" : "2023-10-10T18:53:16Z",
      "diff_hunk" : "@@ -4228,11 +4244,23 @@ util::Result<MigrationResult> MigrateLegacyToDescriptor(const std::string& walle\n     }\n \n     if (success) {\n-        // Migration successful, unload the wallet locally, then reload it.\n+        // Migration successful, unload all wallets locally, then reload them.\n         assert(local_wallet.use_count() == 1);\n         local_wallet.reset();\n         res.wallet = LoadWallet(context, wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n         res.wallet_name = wallet_name;\n+        if (res.watchonly_wallet) {\n+            assert(res.watchonly_wallet.use_count() == 1);\n+            std::string watchonly_wallet_name = res.watchonly_wallet->GetName();\n+            res.watchonly_wallet.reset();\n+            res.watchonly_wallet = LoadWallet(context, watchonly_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        }\n+        if (res.solvables_wallet) {\n+            assert(res.solvables_wallet.use_count() == 1);\n+            std::string solvables_wallet_name = res.solvables_wallet->GetName();\n+            res.solvables_wallet.reset();\n+            res.solvables_wallet = LoadWallet(context, solvables_wallet_name, /*load_on_start=*/std::nullopt, options, status, error, warnings);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28609#discussion_r1353166779",
      "id" : 1353166779,
      "in_reply_to_id" : 1350447031,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Qp6-7",
      "original_commit_id" : "d550863e5bbe097534d8cefb0f5afd63ad19a253",
      "original_line" : 4263,
      "original_position" : 66,
      "original_start_line" : 4252,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1668645595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28609",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353166779/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-10-10T18:53:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1353166779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
