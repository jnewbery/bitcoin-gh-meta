{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "Currently we store unencrypted private keys in a `key` record, and encrypted private keys in a `ckey` record. During encryption, all `key` records are deleted and the keys encrypted and written into new `ckey` records. However database systems and filesystems do not always remove data when it is deleted, many simply mark the data as deleted for it to be overwritten later. In databases like BDB, some deleted records are kept around to help keep the structure of the b-tree. This fact has resulted in a notable issue in the original wallet encryption implementation where the unencrypted private keys were kept in the wallet.dat file and in the database transaction logs after the encryption was done. If/when we move to a new storage method, this same issue will likely crop up again and another workaround developed for that specific storage method. However modifying records is usually done in place and overwrites existing records.\r\n\r\nI would like to suggest a different way that this could be handled that is independent of the storage method. Instead of storing private keys unencrypted, we can always encrypt the private keys using either a default passphrase or a passphrase that is stored in plaintext in the wallet file. So all private keys would be stored in `ckey` records. \"Unencrypted\" then means that the passphrase is either publicly known (a default passphrase) or easily found within the wallet.dat file itself. Encrypting the wallet would then be our typical passphrase changing mechanism.\r\n\r\nSpecifically, each `ckey` is encrypted with a randomly generated `CMasterKey`. The `CMasterKey` itself is encrypted with a passphrase. An \"unencrypted\" wallet encrypts the `CMasterKey` with some default passphrase. During encryption, as we do now for passphrase changing, the `CMasterKey` is decrypted in memory and encrypted with the new passphrase. The original `CMasterKey` record is overwritten. Of course we would still regenerate the keypool and set a new HD seed during this process.\r\n\r\nAlternatively, instead of using a default passphrase, a randomly generated passphrase can be used to encrypt the `CMasterKey`. This randomly generated passphrase can be stored on disk in a new record. When the wallet is actually encrypted by the user, a new `CMasterKey` can be generated and each key re-encrypted with the new `CMasterKey` along with the `CMasterKey` itself being encrypted with the new passphrase. Then the passphrase record can be deleted. Since all of these modifications are updates to existing records, there shouldn't be anything that could remain in slack space that reveals the private keys. By rotating the `CMasterKey`, the old plaintext passphrase and its `CMasterKey` are not useful even if they are left behind due to deletion not always deleting. This approach could also be used with a default passphrase too.\r\n\r\nThere are a few benefits from doing this: we avoid having to ensure that unencrypted private keys never get left behind when encrypting, and `ckey` records are way smaller than `key` records so we get the space savings too. Some downsides are that it is possible that this could make wallet recovery much more difficult. If a wallet becomes corrupted and the `CMasterKey` encrypting the keys is lost, the keys would be lost too. But perhaps that could be resolved by using a default `CMasterKey` instead of a default passphrase.\r\n\r\nThoughts?",
   "closed_at" : "2023-09-21T16:24:16Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
      "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
      "followers_url" : "https://api.github.com/users/willcl-ark/followers",
      "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
      "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/willcl-ark",
      "id" : 6606587,
      "login" : "willcl-ark",
      "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
      "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
      "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
      "repos_url" : "https://api.github.com/users/willcl-ark/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/willcl-ark"
   },
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18889/comments",
   "created_at" : "2020-05-05T16:54:42Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18889/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/18889",
   "id" : 612751111,
   "labels" : [
      {
         "color" : "7cf575",
         "default" : false,
         "description" : null,
         "id" : 64583,
         "name" : "Feature",
         "node_id" : "MDU6TGFiZWw2NDU4Mw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Feature"
      },
      {
         "color" : "ebd775",
         "default" : false,
         "description" : null,
         "id" : 64584,
         "name" : "Brainstorming",
         "node_id" : "MDU6TGFiZWw2NDU4NA==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming"
      },
      {
         "color" : "08a781",
         "default" : false,
         "description" : null,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18889/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU2MTI3NTExMTE=",
   "number" : 18889,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18889/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : "completed",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18889/timeline",
   "title" : "[RFC] Wallet: Store unencrypted keys as encrypted with a default or plaintext passphrase",
   "updated_at" : "2023-09-21T16:24:16Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18889",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
      "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
      "followers_url" : "https://api.github.com/users/achow101/followers",
      "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/achow101",
      "id" : 3782274,
      "login" : "achow101",
      "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
      "organizations_url" : "https://api.github.com/users/achow101/orgs",
      "received_events_url" : "https://api.github.com/users/achow101/received_events",
      "repos_url" : "https://api.github.com/users/achow101/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/achow101"
   }
}
