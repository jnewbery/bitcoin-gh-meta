[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30202#discussion_r1623665893"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623665893"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm assuming changing `GetSAFamily()`'s return type was avoided to keep the PR scoped (and since the change doesn't seem necessary).\r\n\r\nSince `GetSAFamily()` returns `sa_family_t`, looks like this is a simple promotion from an `unsigned short` (`sa_family_t`) to `int`.  This seems fine (it aligns with the typical way `socket()` args are typically used).  ",
      "commit_id" : "77e34ded543e19ba27cab8d0cfc464af27f04bbf",
      "created_at" : "2024-06-02T22:49:14Z",
      "diff_hunk" : "@@ -3029,7 +3029,7 @@ bool CConnman::BindListenPort(const CService& addrBind, bilingual_str& strError,\n         return false;\n     }\n \n-    std::unique_ptr<Sock> sock = CreateSock(addrBind.GetSAFamily());\n+    std::unique_ptr<Sock> sock = CreateSock(addrBind.GetSAFamily(), SOCK_STREAM, IPPROTO_TCP);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30202#discussion_r1623665893",
      "id" : 1623665893,
      "line" : 3032,
      "node_id" : "PRRC_kwDOABII585gxyzl",
      "original_commit_id" : "77e34ded543e19ba27cab8d0cfc464af27f04bbf",
      "original_line" : 3032,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 5,
      "pull_request_review_id" : 2092618199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30202",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623665893/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-02T23:22:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623665893",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30202#discussion_r1623667512"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623667512"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems ok to remove, since `protocol` is now an argument.",
      "commit_id" : "77e34ded543e19ba27cab8d0cfc464af27f04bbf",
      "created_at" : "2024-06-02T23:02:40Z",
      "diff_hunk" : "@@ -485,24 +485,23 @@ bool Socks5(const std::string& strDest, uint16_t port, const ProxyCredentials* a\n     }\n }\n \n-std::unique_ptr<Sock> CreateSockOS(sa_family_t address_family)\n+std::unique_ptr<Sock> CreateSockOS(int domain, int type, int protocol)\n {\n     // Not IPv4, IPv6 or UNIX\n-    if (address_family == AF_UNSPEC) return nullptr;\n-\n-    int protocol{IPPROTO_TCP};\n-#if HAVE_SOCKADDR_UN\n-    if (address_family == AF_UNIX) protocol = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30202#discussion_r1623667512",
      "id" : 1623667512,
      "line" : 495,
      "node_id" : "PRRC_kwDOABII585gxzM4",
      "original_commit_id" : "77e34ded543e19ba27cab8d0cfc464af27f04bbf",
      "original_line" : 495,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/netbase.cpp",
      "position" : 12,
      "pull_request_review_id" : 2092618199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30202",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623667512/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-02T23:23:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623667512",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30202#discussion_r1623667994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623667994"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems good to add this sanity check to prevent setting non-pertinent sockopts.\r\n\r\nnit: Might be worthwhile to mention in the PR description that in addition to extending arguments, some extra safety checks were put in place.",
      "commit_id" : "77e34ded543e19ba27cab8d0cfc464af27f04bbf",
      "created_at" : "2024-06-02T23:06:49Z",
      "diff_hunk" : "@@ -485,24 +485,23 @@ bool Socks5(const std::string& strDest, uint16_t port, const ProxyCredentials* a\n     }\n }\n \n-std::unique_ptr<Sock> CreateSockOS(sa_family_t address_family)\n+std::unique_ptr<Sock> CreateSockOS(int domain, int type, int protocol)\n {\n     // Not IPv4, IPv6 or UNIX\n-    if (address_family == AF_UNSPEC) return nullptr;\n-\n-    int protocol{IPPROTO_TCP};\n-#if HAVE_SOCKADDR_UN\n-    if (address_family == AF_UNIX) protocol = 0;\n-#endif\n+    if (domain == AF_UNSPEC) return nullptr;\n \n     // Create a socket in the specified address family.\n-    SOCKET hSocket = socket(address_family, SOCK_STREAM, protocol);\n+    SOCKET hSocket = socket(domain, type, protocol);\n     if (hSocket == INVALID_SOCKET) {\n         return nullptr;\n     }\n \n     auto sock = std::make_unique<Sock>(hSocket);\n \n+    if (domain != AF_INET && domain != AF_INET6 && domain != AF_UNIX) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30202#discussion_r1623667994",
      "id" : 1623667994,
      "line" : 501,
      "node_id" : "PRRC_kwDOABII585gxzUa",
      "original_commit_id" : "77e34ded543e19ba27cab8d0cfc464af27f04bbf",
      "original_line" : 501,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/netbase.cpp",
      "position" : 25,
      "pull_request_review_id" : 2092618199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30202",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623667994/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-02T23:23:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623667994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30202#discussion_r1623668596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623668596"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since these are simple `int`s passed by value, seems ok to change from the previous const reference approach.",
      "commit_id" : "77e34ded543e19ba27cab8d0cfc464af27f04bbf",
      "created_at" : "2024-06-02T23:10:53Z",
      "diff_hunk" : "@@ -527,18 +526,21 @@ std::unique_ptr<Sock> CreateSockOS(sa_family_t address_family)\n     }\n \n #if HAVE_SOCKADDR_UN\n-    if (address_family == AF_UNIX) return sock;\n+    if (domain == AF_UNIX) return sock;\n #endif\n \n-    // Set the no-delay option (disable Nagle's algorithm) on the TCP socket.\n-    const int on{1};\n-    if (sock->SetSockOpt(IPPROTO_TCP, TCP_NODELAY, &on, sizeof(on)) == SOCKET_ERROR) {\n-        LogPrint(BCLog::NET, \"Unable to set TCP_NODELAY on a newly created socket, continuing anyway\\n\");\n+    if (protocol == IPPROTO_TCP) {\n+        // Set the no-delay option (disable Nagle's algorithm) on the TCP socket.\n+        const int on{1};\n+        if (sock->SetSockOpt(IPPROTO_TCP, TCP_NODELAY, &on, sizeof(on)) == SOCKET_ERROR) {\n+            LogPrint(BCLog::NET, \"Unable to set TCP_NODELAY on a newly created socket, continuing anyway\\n\");\n+        }\n     }\n+\n     return sock;\n }\n \n-std::function<std::unique_ptr<Sock>(const sa_family_t&)> CreateSock = CreateSockOS;\n+std::function<std::unique_ptr<Sock>(int, int, int)> CreateSock = CreateSockOS;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30202#discussion_r1623668596",
      "id" : 1623668596,
      "line" : 543,
      "node_id" : "PRRC_kwDOABII585gxzd0",
      "original_commit_id" : "77e34ded543e19ba27cab8d0cfc464af27f04bbf",
      "original_line" : 543,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/netbase.cpp",
      "position" : 56,
      "pull_request_review_id" : 2092618199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30202",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623668596/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-02T23:22:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623668596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   }
]
