[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30237).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/30237#pullrequestreview-2102290054) |\n| Concept ACK | [instagibbs](https://github.com/bitcoin/bitcoin/pull/30237#pullrequestreview-2102010028), [glozow](https://github.com/bitcoin/bitcoin/pull/30237#issuecomment-2154575591) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2024-06-06T11:17:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30237#issuecomment-2152083948",
      "id" : 2152083948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30237",
      "node_id" : "IC_kwDOABII586ARjHs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2152083948/reactions"
      },
      "updated_at" : "2024-06-07T10:42:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2152083948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/25888431395</sub>",
      "created_at" : "2024-06-06T12:08:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30237#issuecomment-2152248477",
      "id" : 2152248477,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30237",
      "node_id" : "IC_kwDOABII586ASLSd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2152248477/reactions"
      },
      "updated_at" : "2024-06-06T12:08:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2152248477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30237#discussion_r1629573202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30237"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629573202"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think another useful case is a transaction that's *also* in your mempool",
      "commit_id" : "4c99301220ab44e98d0d0e1cc8d774d96a25b7aa",
      "created_at" : "2024-06-06T13:40:49Z",
      "diff_hunk" : "@@ -302,6 +303,51 @@ BOOST_AUTO_TEST_CASE(EmptyBlockRoundTripTest)\n     }\n }\n \n+BOOST_AUTO_TEST_CASE(ReceiveWithExtraTransactions) {\n+    CTxMemPool& pool = *Assert(m_node.mempool);\n+    TestMemPoolEntryHelper entry;\n+    const CBlock block(BuildBlockTestCase());\n+    std::vector<CTransactionRef> extra_txn;\n+    extra_txn.resize(10);\n+\n+    CMutableTransaction mtx = BuildTransactionTestCase();\n+    mtx.vin[0].prevout.hash = Txid::FromUint256(InsecureRand256());\n+    mtx.vin[0].prevout.n = 0;\n+    const CTransactionRef non_block_tx = MakeTransactionRef(std::move(mtx));\n+\n+    LOCK2(cs_main, pool.cs);\n+    pool.addUnchecked(entry.FromTx(block.vtx[2]));\n+    BOOST_CHECK_EQUAL(pool.get(block.vtx[2]->GetHash()).use_count(), SHARED_TX_OFFSET + 0);\n+    // Ensure the non_block_tx is actually not in the block\n+    for (const auto &block_tx : block.vtx) {\n+        BOOST_CHECK_NE(block_tx->GetHash(), non_block_tx->GetHash());\n+    }\n+    // Ensure block.vtx[1] is not in pool\n+    BOOST_CHECK_EQUAL(pool.get(block.vtx[1]->GetHash()), nullptr);\n+\n+    {\n+        const CBlockHeaderAndShortTxIDs cmpctblock{block};\n+        PartiallyDownloadedBlock partial_block(&pool);\n+        PartiallyDownloadedBlock partial_block_with_extra(&pool);\n+\n+        BOOST_CHECK(partial_block.InitData(cmpctblock, extra_txn) == READ_STATUS_OK);\n+        BOOST_CHECK( partial_block.IsTxAvailable(0));\n+        BOOST_CHECK(!partial_block.IsTxAvailable(1));\n+        BOOST_CHECK( partial_block.IsTxAvailable(2));\n+\n+        // Add an unrelated tx to extra_txn:\n+        extra_txn[0] = non_block_tx;\n+        // and a tx from the block that's not in the mempool:\n+        extra_txn[1] = block.vtx[1];",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30237#discussion_r1629573202",
      "id" : 1629573202,
      "line" : 341,
      "node_id" : "PRRC_kwDOABII585hIVBS",
      "original_commit_id" : "4c99301220ab44e98d0d0e1cc8d774d96a25b7aa",
      "original_line" : 341,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/test/blockencodings_tests.cpp",
      "position" : 73,
      "pull_request_review_id" : 2102010028,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30237",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629573202/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T13:40:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629573202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : " > Not sure if that is worth addressing since it's so rare but perhaps simply adding a comment that the test might fail every 2^48 runs is good?\r\n\r\nI think it's worth avoiding, I don't really like the notion of flaky tests maybe failing for a random reason, even if it is very improbable. I'd guess short-ID collisions would also affect some of the other existing tests in here so there's additional benefit in them not being flaky too.",
      "created_at" : "2024-06-07T07:51:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30237#issuecomment-2154290717",
      "id" : 2154290717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30237",
      "node_id" : "IC_kwDOABII586AZ94d",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2154290717/reactions"
      },
      "updated_at" : "2024-06-07T07:51:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2154290717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1328814?v=4",
         "events_url" : "https://api.github.com/users/AngusP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AngusP/followers",
         "following_url" : "https://api.github.com/users/AngusP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AngusP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AngusP",
         "id" : 1328814,
         "login" : "AngusP",
         "node_id" : "MDQ6VXNlcjEzMjg4MTQ=",
         "organizations_url" : "https://api.github.com/users/AngusP/orgs",
         "received_events_url" : "https://api.github.com/users/AngusP/received_events",
         "repos_url" : "https://api.github.com/users/AngusP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AngusP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AngusP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AngusP"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\n> > Not sure if that is worth addressing since it's so rare but perhaps simply adding a comment that the test might fail every 2^48 runs is good?\r\n> \r\n> I think it's worth avoiding, I don't really like the notion of flaky tests maybe failing for a random reason, even if it is very improbable. I'd guess short-ID collisions would also affect some of the other existing tests in here so there's additional benefit in them not being flaky too.\r\n\r\nNot sure exactly how flaky it is and don't want to blow this out of proportion. Comment sounds good to save a future debugger from headache. If we might hit it, you can knock it down closer to 0 by running it e.g. 5 times and asserting that it doesn't fail every time, like in coinselector_tests:\r\nhttps://github.com/bitcoin/bitcoin/blob/4a020ca443ba370bf41583962d16aa8551876f53/src/wallet/test/coinselector_tests.cpp#L752-L777",
      "created_at" : "2024-06-07T10:42:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30237#issuecomment-2154575591",
      "id" : 2154575591,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30237",
      "node_id" : "IC_kwDOABII586AbDbn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2154575591/reactions"
      },
      "updated_at" : "2024-06-07T10:42:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2154575591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Would it be difficult to make the test deterministic?",
      "created_at" : "2024-06-07T13:24:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30237#issuecomment-2154833376",
      "id" : 2154833376,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30237",
      "node_id" : "IC_kwDOABII586AcCXg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2154833376/reactions"
      },
      "updated_at" : "2024-06-07T13:24:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2154833376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Would it be difficult to make the test deterministic?\r\n\r\nYes, the straightforward way would be to replace the `InsecureRand256()` with fixed hashes that don't result in transaction short IDs that collide. Less-straightforward but maybe better would be to keep using random hashes but check for a short ID collision and try again with a different random hash until the collision is gone -- or start with one random hash and change it in a way that guarantees the short ID (siphash) will be different, but I'm not sure if siphash is easily 'attackable' in that sense.",
      "created_at" : "2024-06-12T08:54:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30237#issuecomment-2162468751",
      "id" : 2162468751,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30237",
      "node_id" : "IC_kwDOABII586A5KeP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2162468751/reactions"
      },
      "updated_at" : "2024-06-12T08:54:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2162468751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1328814?v=4",
         "events_url" : "https://api.github.com/users/AngusP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AngusP/followers",
         "following_url" : "https://api.github.com/users/AngusP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AngusP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AngusP",
         "id" : 1328814,
         "login" : "AngusP",
         "node_id" : "MDQ6VXNlcjEzMjg4MTQ=",
         "organizations_url" : "https://api.github.com/users/AngusP/orgs",
         "received_events_url" : "https://api.github.com/users/AngusP/received_events",
         "repos_url" : "https://api.github.com/users/AngusP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AngusP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AngusP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AngusP"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> `InsecureRand256`\r\n\r\nI'd say longer them those global non-deterministic functions should go away anyway. Not something you need to do here, but if you want you can create a commit to accept a FastRandomContext reference as param to `BuildBlockTestCase`, then in each unit test, create a local FastRandomContext and bind it to a lambda named `BuildBlockTestCase`. ",
      "created_at" : "2024-06-12T09:01:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30237#issuecomment-2162486216",
      "id" : 2162486216,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30237",
      "node_id" : "IC_kwDOABII586A5OvI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2162486216/reactions"
      },
      "updated_at" : "2024-06-12T09:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2162486216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   }
]
