[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30267).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [mzumsande](https://github.com/bitcoin/bitcoin/pull/30267#issuecomment-2182927906) |\n| Stale ACK | [tdb3](https://github.com/bitcoin/bitcoin/pull/30267#pullrequestreview-2110894428), [alfonsoromanz](https://github.com/bitcoin/bitcoin/pull/30267#pullrequestreview-2112255189), [BrandonOdiwuor](https://github.com/bitcoin/bitcoin/pull/30267#pullrequestreview-2113239131) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30214](https://github.com/bitcoin/bitcoin/pull/30214) (refactor: Improve assumeutxo state representation by ryanofsky)\n* [#29700](https://github.com/bitcoin/bitcoin/pull/29700) (kernel, refactor: return error status on all fatal errors by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-06-11T08:49:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#issuecomment-2160152241",
      "id" : 2160152241,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30267",
      "node_id" : "IC_kwDOABII586AwU6x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2160152241/reactions"
      },
      "updated_at" : "2024-06-21T15:04:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2160152241",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1635144969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635144969"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> If the base block of the snapshot is marked invalid or part of an invalid chain\r\n\r\nThis existing test seems to focus on the base block being part of an invalid chain.  Is it also worth adding an explicit test for an invalid base block itself (or would it be overkill)?",
      "commit_id" : "cbc604f6a7739bf22a5d811b6366453860d59f4c",
      "created_at" : "2024-06-11T16:05:35Z",
      "diff_hunk" : "@@ -202,7 +202,15 @@ def test_snapshot_with_less_work(self, dump_output_path):\n         assert_equal(node.getblockcount(), FINAL_HEIGHT)\n         with node.assert_debug_log(expected_msgs=[\"[snapshot] activation failed - work does not exceed active chainstate\"]):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n-        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+    def test_snapshot_block_invalidated(self, dump_output_path):\n+        self.log.info(\"Test snapshot is not loaded when base block is invalid.\")\n+        node = self.nodes[0]\n+        block_hash = node.getblockhash(SNAPSHOT_BASE_HEIGHT - 1)\n+        node.invalidateblock(block_hash)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1635144969",
      "id" : 1635144969,
      "line" : 210,
      "node_id" : "PRRC_kwDOABII585hdlUJ",
      "original_commit_id" : "cbc604f6a7739bf22a5d811b6366453860d59f4c",
      "original_line" : 210,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 10,
      "pull_request_review_id" : 2110894428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635144969/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-11T16:05:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635144969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1636599996"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1636599996"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: Would it be better to include the base block hash on the error message to help in debugging \r\n\r\n```cpp\r\nthrow JSONRPCError(\r\n            RPC_INTERNAL_ERROR,\r\n            \"The base block header (%s) is part of an invalid chain.\", base_blockhash.ToString());\r\n```",
      "commit_id" : "cbc604f6a7739bf22a5d811b6366453860d59f4c",
      "created_at" : "2024-06-12T14:39:42Z",
      "diff_hunk" : "@@ -2836,6 +2836,15 @@ static RPCHelpMan loadtxoutset()\n             strprintf(\"The base block header (%s) must appear in the headers chain. Make sure all headers are syncing, and call this RPC again.\",\n                       base_blockhash.ToString()));\n     }\n+\n+    bool start_block_invalid = WITH_LOCK(::cs_main,\n+            return snapshot_start_block->nStatus & BLOCK_FAILED_MASK);\n+    if (start_block_invalid) {\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"The base block header is part of an invalid chain.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1636599996",
      "id" : 1636599996,
      "line" : 2845,
      "node_id" : "PRRC_kwDOABII585hjIi8",
      "original_commit_id" : "cbc604f6a7739bf22a5d811b6366453860d59f4c",
      "original_line" : 2845,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 10,
      "pull_request_review_id" : 2113246508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1636599996/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-12T14:39:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1636599996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15610188?v=4",
         "events_url" : "https://api.github.com/users/BrandonOdiwuor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BrandonOdiwuor/followers",
         "following_url" : "https://api.github.com/users/BrandonOdiwuor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BrandonOdiwuor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BrandonOdiwuor",
         "id" : 15610188,
         "login" : "BrandonOdiwuor",
         "node_id" : "MDQ6VXNlcjE1NjEwMTg4",
         "organizations_url" : "https://api.github.com/users/BrandonOdiwuor/orgs",
         "received_events_url" : "https://api.github.com/users/BrandonOdiwuor/received_events",
         "repos_url" : "https://api.github.com/users/BrandonOdiwuor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BrandonOdiwuor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BrandonOdiwuor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BrandonOdiwuor"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1638706909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1638706909"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Some checks are within `ActivateSnapshot()`, others, like the added one, are in the rpc code (which means that they can't be covered in  unit tests for that function). Do you know if there is a reason for that?",
      "commit_id" : "cbc604f6a7739bf22a5d811b6366453860d59f4c",
      "created_at" : "2024-06-13T18:25:33Z",
      "diff_hunk" : "@@ -2836,6 +2836,15 @@ static RPCHelpMan loadtxoutset()\n             strprintf(\"The base block header (%s) must appear in the headers chain. Make sure all headers are syncing, and call this RPC again.\",\n                       base_blockhash.ToString()));\n     }\n+\n+    bool start_block_invalid = WITH_LOCK(::cs_main,\n+            return snapshot_start_block->nStatus & BLOCK_FAILED_MASK);\n+    if (start_block_invalid) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1638706909",
      "id" : 1638706909,
      "line" : 2842,
      "node_id" : "PRRC_kwDOABII585hrK7d",
      "original_commit_id" : "f3029560620453d7848e57bc2cbf5b042cb0a2a6",
      "original_line" : 2842,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 7,
      "pull_request_review_id" : 2116621895,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1638706909/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-13T18:26:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1638706909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1642951609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1642951609"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1638706909\r\n\r\n> Some checks are within `ActivateSnapshot()`, others, like the added one, are in the rpc code (which means that they can't be covered in unit tests for that function). Do you know if there is a reason for that?\r\n\r\nI think this is just a mistake, and it makes the checks less reliable because they are done without keeping cs_main locked. I suggested fixing this before in https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1325193433.\r\n\r\n\r\n",
      "commit_id" : "cbc604f6a7739bf22a5d811b6366453860d59f4c",
      "created_at" : "2024-06-17T14:55:41Z",
      "diff_hunk" : "@@ -2836,6 +2836,15 @@ static RPCHelpMan loadtxoutset()\n             strprintf(\"The base block header (%s) must appear in the headers chain. Make sure all headers are syncing, and call this RPC again.\",\n                       base_blockhash.ToString()));\n     }\n+\n+    bool start_block_invalid = WITH_LOCK(::cs_main,\n+            return snapshot_start_block->nStatus & BLOCK_FAILED_MASK);\n+    if (start_block_invalid) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1642951609",
      "id" : 1642951609,
      "in_reply_to_id" : 1638706909,
      "line" : 2842,
      "node_id" : "PRRC_kwDOABII585h7XO5",
      "original_commit_id" : "f3029560620453d7848e57bc2cbf5b042cb0a2a6",
      "original_line" : 2842,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 7,
      "pull_request_review_id" : 2123141969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1642951609/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-17T14:56:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1642951609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1644425136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644425136"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think these were always separated like that. But sounds good to me to move them. I have added a refactoring commit which moves the other two early checks into `ActivateSnapshot()` and then I am adding the new check there as well.",
      "commit_id" : "1a6f1ff290208c04c2e661e415fd6c3a11c30330",
      "created_at" : "2024-06-18T12:59:26Z",
      "diff_hunk" : "@@ -2836,6 +2836,15 @@ static RPCHelpMan loadtxoutset()\n             strprintf(\"The base block header (%s) must appear in the headers chain. Make sure all headers are syncing, and call this RPC again.\",\n                       base_blockhash.ToString()));\n     }\n+\n+    bool start_block_invalid = WITH_LOCK(::cs_main,\n+            return snapshot_start_block->nStatus & BLOCK_FAILED_MASK);\n+    if (start_block_invalid) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1644425136",
      "id" : 1644425136,
      "in_reply_to_id" : 1638706909,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iA--w",
      "original_commit_id" : "f3029560620453d7848e57bc2cbf5b042cb0a2a6",
      "original_line" : 2842,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2125454807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644425136/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-18T12:59:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644425136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1644425662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644425662"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "taken with minor edits",
      "commit_id" : "1a6f1ff290208c04c2e661e415fd6c3a11c30330",
      "created_at" : "2024-06-18T12:59:47Z",
      "diff_hunk" : "@@ -2836,6 +2836,15 @@ static RPCHelpMan loadtxoutset()\n             strprintf(\"The base block header (%s) must appear in the headers chain. Make sure all headers are syncing, and call this RPC again.\",\n                       base_blockhash.ToString()));\n     }\n+\n+    bool start_block_invalid = WITH_LOCK(::cs_main,\n+            return snapshot_start_block->nStatus & BLOCK_FAILED_MASK);\n+    if (start_block_invalid) {\n+        throw JSONRPCError(\n+            RPC_INTERNAL_ERROR,\n+            \"The base block header is part of an invalid chain.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1644425662",
      "id" : 1644425662,
      "in_reply_to_id" : 1636599996,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iA_G-",
      "original_commit_id" : "cbc604f6a7739bf22a5d811b6366453860d59f4c",
      "original_line" : 2845,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2125455693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644425662/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-18T12:59:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644425662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1644425900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644425900"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it's a bit overkill but it was easy to add and also shouldn't make the test considerably slower, so I added coverage for this as well.",
      "commit_id" : "1a6f1ff290208c04c2e661e415fd6c3a11c30330",
      "created_at" : "2024-06-18T12:59:59Z",
      "diff_hunk" : "@@ -202,7 +202,15 @@ def test_snapshot_with_less_work(self, dump_output_path):\n         assert_equal(node.getblockcount(), FINAL_HEIGHT)\n         with node.assert_debug_log(expected_msgs=[\"[snapshot] activation failed - work does not exceed active chainstate\"]):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n-        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+    def test_snapshot_block_invalidated(self, dump_output_path):\n+        self.log.info(\"Test snapshot is not loaded when base block is invalid.\")\n+        node = self.nodes[0]\n+        block_hash = node.getblockhash(SNAPSHOT_BASE_HEIGHT - 1)\n+        node.invalidateblock(block_hash)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1644425900",
      "id" : 1644425900,
      "in_reply_to_id" : 1635144969,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iA_Ks",
      "original_commit_id" : "cbc604f6a7739bf22a5d811b6366453860d59f4c",
      "original_line" : 210,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 2125456132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644425900/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-18T12:59:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644425900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/26368413924</sub>",
      "created_at" : "2024-06-18T16:02:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#issuecomment-2176462392",
      "id" : 2176462392,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30267",
      "node_id" : "IC_kwDOABII586Bui44",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2176462392/reactions"
      },
      "updated_at" : "2024-06-18T16:02:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2176462392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1644893828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644893828"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Looks good (except for the compiler issue with `Join()`) - I think it would be helpful to not only log the reason, but also return them with the RPC - for that, `ActivateSnapshot()` would need to return it, possibly as `util::Result` as suggested by ryanofsky, but that could be a follow-up.\r\nThough for now, it might be helpful to expand the error (\"Unable to load UTXO snapshot\") to point the user to the debug log for the reason.",
      "commit_id" : "fe25b9b017300384fe0ca30c878c7f74cae1729d",
      "created_at" : "2024-06-18T18:35:06Z",
      "diff_hunk" : "@@ -2836,6 +2836,15 @@ static RPCHelpMan loadtxoutset()\n             strprintf(\"The base block header (%s) must appear in the headers chain. Make sure all headers are syncing, and call this RPC again.\",\n                       base_blockhash.ToString()));\n     }\n+\n+    bool start_block_invalid = WITH_LOCK(::cs_main,\n+            return snapshot_start_block->nStatus & BLOCK_FAILED_MASK);\n+    if (start_block_invalid) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1644893828",
      "id" : 1644893828,
      "in_reply_to_id" : 1638706909,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iCxaE",
      "original_commit_id" : "f3029560620453d7848e57bc2cbf5b042cb0a2a6",
      "original_line" : 2842,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2126225985,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644893828/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-18T18:35:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644893828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1646607479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646607479"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, yeah, I gave it a shot and it pretty simple so I am changing the return type as well in the refactoring commit now.",
      "commit_id" : "fe25b9b017300384fe0ca30c878c7f74cae1729d",
      "created_at" : "2024-06-19T19:02:20Z",
      "diff_hunk" : "@@ -2836,6 +2836,15 @@ static RPCHelpMan loadtxoutset()\n             strprintf(\"The base block header (%s) must appear in the headers chain. Make sure all headers are syncing, and call this RPC again.\",\n                       base_blockhash.ToString()));\n     }\n+\n+    bool start_block_invalid = WITH_LOCK(::cs_main,\n+            return snapshot_start_block->nStatus & BLOCK_FAILED_MASK);\n+    if (start_block_invalid) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1646607479",
      "id" : 1646607479,
      "in_reply_to_id" : 1638706909,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iJTx3",
      "original_commit_id" : "f3029560620453d7848e57bc2cbf5b042cb0a2a6",
      "original_line" : 2842,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 2128911453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646607479/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-19T19:02:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646607479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Needed to rebase because of a silent merge conflict.",
      "created_at" : "2024-06-19T19:42:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#issuecomment-2179369598",
      "id" : 2179369598,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30267",
      "node_id" : "IC_kwDOABII586B5op-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2179369598/reactions"
      },
      "updated_at" : "2024-06-19T19:42:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2179369598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1647940464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647940464"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "typo: parents",
      "commit_id" : "2f9bde69f45c7a9fdcf0c65f9e1305391a6f1f28",
      "created_at" : "2024-06-20T17:50:29Z",
      "diff_hunk" : "@@ -205,6 +205,19 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_block_invalidated(self, dump_output_path):\n+        self.log.info(\"Test snapshot is not loaded when base block is invalid.\")\n+        node = self.nodes[0]\n+        # We are testing the case where the base block is invalidated itself\n+        # and also the case where one of its partents is invalidated.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1647940464",
      "id" : 1647940464,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iOZNw",
      "original_commit_id" : "b99304a6fc9d61ec48e429a649c331d47bbeff45",
      "original_line" : 212,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 2131034995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647940464/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-20T18:51:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647940464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1648003009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1648003009"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This changes it such that the path is no longer included in the RPC error. I think that it wasn't really helpful anyway (the user already provided the path when calling the RPC, so why the need to report it back to the user?), but just wanted to mention it in case someone would miss that.",
      "commit_id" : "2f9bde69f45c7a9fdcf0c65f9e1305391a6f1f28",
      "created_at" : "2024-06-20T18:50:38Z",
      "diff_hunk" : "@@ -2821,34 +2819,15 @@ static RPCHelpMan loadtxoutset()\n         throw JSONRPCError(RPC_DESERIALIZATION_ERROR, strprintf(\"Unable to parse metadata: %s\", e.what()));\n     }\n \n-    uint256 base_blockhash = metadata.m_base_blockhash;\n-    int base_blockheight = metadata.m_base_blockheight;\n-    if (!chainman.GetParams().AssumeutxoForBlockhash(base_blockhash).has_value()) {\n-        auto available_heights = chainman.GetParams().GetAvailableSnapshotHeights();\n-        std::string heights_formatted = Join(available_heights, \", \", [&](const auto& i) { return ToString(i); });\n-        throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to load UTXO snapshot, \"\n-            \"assumeutxo block hash in snapshot metadata not recognized (hash: %s, height: %s). The following snapshot heights are available: %s.\",\n-            base_blockhash.ToString(),\n-            base_blockheight,\n-            heights_formatted));\n-    }\n-    CBlockIndex* snapshot_start_block = WITH_LOCK(::cs_main,\n-            return chainman.m_blockman.LookupBlockIndex(base_blockhash));\n-\n-    if (!snapshot_start_block) {\n-        throw JSONRPCError(\n-            RPC_INTERNAL_ERROR,\n-            strprintf(\"The base block header (%s) must appear in the headers chain. Make sure all headers are syncing, and call this RPC again.\",\n-                      base_blockhash.ToString()));\n-    }\n-    if (!chainman.ActivateSnapshot(afile, metadata, false)) {\n-        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to load UTXO snapshot \" + fs::PathToString(path));\n+    auto activation_result{chainman.ActivateSnapshot(afile, metadata, false)};\n+    if (!activation_result) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(_(\"Unable to load UTXO snapshot: %s\\n\"), util::ErrorString(activation_result)).original);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1648003009",
      "id" : 1648003009,
      "line" : 2824,
      "node_id" : "PRRC_kwDOABII585iOofB",
      "original_commit_id" : "80315c011863d69e7785673283e4c9033fbcd5ac",
      "original_line" : 2824,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 38,
      "pull_request_review_id" : 2131034995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1648003009/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-20T18:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1648003009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1648625983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1648625983"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "fixed",
      "commit_id" : "2f9bde69f45c7a9fdcf0c65f9e1305391a6f1f28",
      "created_at" : "2024-06-21T08:39:53Z",
      "diff_hunk" : "@@ -205,6 +205,19 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_block_invalidated(self, dump_output_path):\n+        self.log.info(\"Test snapshot is not loaded when base block is invalid.\")\n+        node = self.nodes[0]\n+        # We are testing the case where the base block is invalidated itself\n+        # and also the case where one of its partents is invalidated.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#discussion_r1648625983",
      "id" : 1648625983,
      "in_reply_to_id" : 1647940464,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iRAk_",
      "original_commit_id" : "b99304a6fc9d61ec48e429a649c331d47bbeff45",
      "original_line" : 212,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 2132123374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30267",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1648625983/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-21T08:39:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1648625983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Just fixed typo noticed by @mzumsande : https://github.com/bitcoin/bitcoin/compare/750f8b50a749e577fc11f2f9f79e06cdd29e66f5..2f9bde69f45c7a9fdcf0c65f9e1305391a6f1f28",
      "created_at" : "2024-06-21T08:40:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#issuecomment-2182290089",
      "id" : 2182290089,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30267",
      "node_id" : "IC_kwDOABII586CExqp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2182290089/reactions"
      },
      "updated_at" : "2024-06-21T08:40:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2182290089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re-ACK 2f9bde6",
      "created_at" : "2024-06-21T15:04:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30267#issuecomment-2182927906",
      "id" : 2182927906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30267",
      "node_id" : "IC_kwDOABII586CHNYi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2182927906/reactions"
      },
      "updated_at" : "2024-06-21T15:04:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2182927906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
