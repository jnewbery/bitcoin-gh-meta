{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "Currently `class Transport` uses `CNetMessage` in one place:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/62f7f59ff495fbcbfc10c25e97bb0dc032647abf/src/net.h#L278-L285\r\n\r\nAnd `CSerializedNetMsg` here:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/62f7f59ff495fbcbfc10c25e97bb0dc032647abf/src/net.h#L287-L295\r\n\r\nThis creates a problem in my Stratum v2 Template Provider implementation in #29432 which introduces `class Sv2Transport : Transport`. Because the sv2 noise protocol (#29346) is very similar to BIP324 I simply copied `V2Transport` and modified the state machine a little bit. The test and fuzz code was also very reusable.\r\n\r\nBut the above two methods don't fit because of their use of `CNetMessage` and `CSerializedNetMsg`. Stratum v2 messages (`Sv2NetMsg` in #29432) don't inherit from `CNetMessage` and I don't think they should.\r\n\r\nSo I'd like to refactor `Transport` to just return (decrypted) bytes and have the caller interpret them (as `CNetMessage` or `Sv2NetMsg`).\r\n\r\nAdditionally I'm not sure what to do with the `std::chrono::microseconds time, bool& reject_message` arguments. So far I don't use them in `Sv2Transport`.\r\n\r\n* `reject_message`: in v1 the transport sets this if the checksum fails. In v2 it's used for the v1 fallback, but also for unrecognized msg types. This can be done by the caller after my proposed refactor, so the argument can go away.\r\n* `time`: this is passed into `GetReceivedMessage` by the caller and used to set `msg.m_time = time;`, so can also go away.\r\n\r\nFrom IRC I understand @sipa had some ideas on how to tackle this. I can take a stab at it myself, but if someone else does it I'm happy to review.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209/comments",
   "created_at" : "2024-05-31T08:26:26Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/30209",
   "id" : 2327251231,
   "labels" : [
      {
         "color" : "006b75",
         "default" : false,
         "description" : null,
         "id" : 98298007,
         "name" : "P2P",
         "node_id" : "MDU6TGFiZWw5ODI5ODAwNw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII586Ktwkf",
   "number" : 30209,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209/timeline",
   "title" : "Make Transport independent of CNetMessage and CSerializedNetMsg",
   "updated_at" : "2024-05-31T08:50:30Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
      "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
      "followers_url" : "https://api.github.com/users/Sjors/followers",
      "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/Sjors",
      "id" : 10217,
      "login" : "Sjors",
      "node_id" : "MDQ6VXNlcjEwMjE3",
      "organizations_url" : "https://api.github.com/users/Sjors/orgs",
      "received_events_url" : "https://api.github.com/users/Sjors/received_events",
      "repos_url" : "https://api.github.com/users/Sjors/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/Sjors"
   }
}
