[
   {
      "author_association" : "MEMBER",
      "body" : "Easier said than done... very rough draft in #30213",
      "created_at" : "2024-05-31T14:39:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/30209#issuecomment-2142404400",
      "id" : 2142404400,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209",
      "node_id" : "IC_kwDOABII585_sn8w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142404400/reactions"
      },
      "updated_at" : "2024-05-31T14:39:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142404400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Two ideas to address this.\r\n\r\n### Make the command type implicitly part of the message being sent.\r\n\r\nSo instead of taking a `CSerializedNetMsg` in `SetMessageToSend`, the interface would simply take an `std::vector<std::byte>` for example, which in some way stores the message type. For example, by convention in V1Transaction and V2Transport, the command type could be the first 12 bytes. So from the perspective of net_processing, sending e.g. a `ping` message would look like sending 20-byte message of which the first 12 are \"ping\\x00\\x00...\" and the last 8 are the nonce. Sending a message shorter than 12 bytes, or whose first 12 bytes do not look like a command string, would cause failure at send time.\r\n\r\nSimilarly, `GetReceivedMessage` would return an `std::vector<std::byte>`, whose first 12 bytes are the command string, as again, for all intents and purposes, the higher-level user of `V1Transport` and `V2Transport` would think of that as what is being sent/received.\r\n\r\nThe `Sv2Transport` class would simply not have any such expectations, and send the provided message without any special treatment of the first 12 bytes of the message.\r\n\r\nI think this is the simplest way of accomplishing some reusability across V2Transport and Sv2Transport, but it's somewhat ugly as the convention of \"first 12 bytes\" is sort of implicitly defined, and some non-trivial part of V2Transport just wouldn't have an equivalent in Sv2Transport.\r\n\r\n### Split command handling into another layer\r\n\r\nHere I'm imagining two layers:\r\n* A `RawTransport` interface with implementations `V2RawTransport` and `Sv2Transport`, with a fully byte-like interface like the `Transport` in the previous idea, but also no notion of 12-byte prefixes, neither in interface nor implementation. For `V2RawTransport`, the message would just be the 1-to-13 byte encoding of the command + payload, exactly matching BIP324 excluding the application layer specification. There would not be a `V1RawTransport`, as there just isn't an equivalent of this layer for V1.\r\n* A `P2PMessageTransport` interface with implementations `V1Transport` and `V2Transport`, with an interface like today's `Transport`, using `CNetMessage` and command strings and all.. `V2Transport` would contain a `V2RawTransport` for doing the heavy lifting, and only adding the command message encoding on top of it. The sv2 protocol stack would not have an equivalent here, as it's not a p2p message transport.\r\n\r\nI think this would be a cleaner separation, and `V2RawTransport` and `Sv2Transport` would be very similar. A downside is that it may be nontrivial to do this with clean interfaces without introducing additional copying/allocations. In addition, the separation means the two layers need to be tested separately (probably duplicating some test code for the V2 case) - this could be seen as an advantage too, but it means extra work.\r\n",
      "created_at" : "2024-05-31T15:49:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/30209#issuecomment-2142537783",
      "id" : 2142537783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209",
      "node_id" : "IC_kwDOABII585_tIg3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142537783/reactions"
      },
      "updated_at" : "2024-05-31T15:49:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142537783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm happy to try taking a stab at both. The second idea would take more time, I expect.",
      "created_at" : "2024-05-31T15:52:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/30209#issuecomment-2142542534",
      "id" : 2142542534,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209",
      "node_id" : "IC_kwDOABII585_tJrG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142542534/reactions"
      },
      "updated_at" : "2024-05-31T15:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142542534",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Perhaps a third approach is to shoehorn `Sv2...Msg` into `CNetMessage`. I haven't tried that yet. They're currently all separate structs. In terms of elegance it's probably no worse than option (1) above.",
      "created_at" : "2024-05-31T16:45:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/30209#issuecomment-2142631320",
      "id" : 2142631320,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209",
      "node_id" : "IC_kwDOABII585_tfWY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142631320/reactions"
      },
      "updated_at" : "2024-05-31T16:46:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142631320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors I guess that works! It could just ignore the command name, and always decode that to \"\"?",
      "created_at" : "2024-05-31T16:58:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/30209#issuecomment-2142648687",
      "id" : 2142648687,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30209",
      "node_id" : "IC_kwDOABII585_tjlv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142648687/reactions"
      },
      "updated_at" : "2024-05-31T16:58:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142648687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
