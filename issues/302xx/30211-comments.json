[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30211).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [brunoerg](https://github.com/bitcoin/bitcoin/pull/30211#issuecomment-2143444520) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2024-05-31T13:50:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#issuecomment-2142210022",
      "id" : 2142210022,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30211",
      "node_id" : "IC_kwDOABII585_r4fm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142210022/reactions"
      },
      "updated_at" : "2024-06-01T13:10:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142210022",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "These issues were discovered by Marco (@marcofleon) and me while he was working on #28803. He will have a PR for that up soon and this PR is a prerequisite (although it also helps with other harnesses that use `FuzzedSock`).\r\n\r\ncc @vasild perhaps you are interested in reviewing this.",
      "created_at" : "2024-05-31T13:53:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#issuecomment-2142220760",
      "id" : 2142220760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30211",
      "node_id" : "IC_kwDOABII585_r7HY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142220760/reactions"
      },
      "updated_at" : "2024-05-31T13:53:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142220760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2024-06-01T13:10:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#issuecomment-2143444520",
      "id" : 2143444520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30211",
      "node_id" : "IC_kwDOABII585_wl4o",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2143444520/reactions"
      },
      "updated_at" : "2024-06-01T13:10:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2143444520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1623328097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623328097"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I guess using `ConsumeRandomLengthByteVector()` is slower than `ConsumeBytes()` because it uses an intermediate `std::string`, but is probably insignificant.\r\n\r\nThe comment says:\r\n\r\n```cpp\r\n// Returns a std::string of length from 0 to |max_length|. When it runs out of\r\n// input data, returns what remains of the input. Designed to be more stable\r\n// with respect to a fuzzer inserting characters than just picking a random\r\n// length and then consuming that many bytes with |ConsumeBytes|.\r\ninline std::string  \r\nFuzzedDataProvider::ConsumeRandomLengthString(size_t max_length) {\r\n```\r\n\r\nI am just curious, did you encounter a case where the current/previous implementation that uses `ConsumeBytes()` is \"unstable\" or had problems in some other way?",
      "commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "created_at" : "2024-06-02T05:15:51Z",
      "diff_hunk" : "@@ -193,21 +193,20 @@ ssize_t FuzzedSock::Recv(void* buf, size_t len, int flags) const\n     bool pad_to_len_bytes{m_fuzzed_data_provider.ConsumeBool()};\n     if (m_peek_data.has_value()) {\n         // `MSG_PEEK` was used in the preceding `Recv()` call, return `m_peek_data`.\n-        random_bytes.assign({m_peek_data.value()});\n+        random_bytes = m_peek_data.value();\n         if ((flags & MSG_PEEK) == 0) {\n             m_peek_data.reset();\n         }\n         pad_to_len_bytes = false;\n     } else if ((flags & MSG_PEEK) != 0) {\n         // New call with `MSG_PEEK`.\n-        random_bytes = m_fuzzed_data_provider.ConsumeBytes<uint8_t>(1);\n+        random_bytes = ConsumeRandomLengthByteVector(m_fuzzed_data_provider, len);\n         if (!random_bytes.empty()) {\n-            m_peek_data = random_bytes[0];\n+            m_peek_data = random_bytes;\n             pad_to_len_bytes = false;\n         }\n     } else {\n-        random_bytes = m_fuzzed_data_provider.ConsumeBytes<uint8_t>(\n-            m_fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, len));\n+        random_bytes = ConsumeRandomLengthByteVector(m_fuzzed_data_provider, len);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1623328097",
      "id" : 1623328097,
      "line" : 209,
      "node_id" : "PRRC_kwDOABII585gwgVh",
      "original_commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "original_line" : 209,
      "original_position" : 22,
      "original_start_line" : 209,
      "path" : "src/test/fuzz/util/net.cpp",
      "position" : 22,
      "pull_request_review_id" : 2092217352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623328097/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 209,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2024-06-02T05:44:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623328097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1623329527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623329527"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This will overflow the buffer in `buf` in the memcopy below if peek read is called with N bytes and then non-peek read is called with M bytes and M < N.",
      "commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "created_at" : "2024-06-02T05:28:19Z",
      "diff_hunk" : "@@ -193,21 +193,20 @@ ssize_t FuzzedSock::Recv(void* buf, size_t len, int flags) const\n     bool pad_to_len_bytes{m_fuzzed_data_provider.ConsumeBool()};\n     if (m_peek_data.has_value()) {\n         // `MSG_PEEK` was used in the preceding `Recv()` call, return `m_peek_data`.\n-        random_bytes.assign({m_peek_data.value()});\n+        random_bytes = m_peek_data.value();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1623329527",
      "id" : 1623329527,
      "line" : 196,
      "node_id" : "PRRC_kwDOABII585gwgr3",
      "original_commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "original_line" : 196,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/fuzz/util/net.cpp",
      "position" : 5,
      "pull_request_review_id" : 2092217352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623329527/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-02T05:44:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623329527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1623330207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623330207"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "from the commit message:\r\n\r\n> FuzzedSock only supports peeking at one byte at a time, which is not\r\n> fuzzer friendly when trying to receive long data.\r\n\r\nI am not sure how likely is this to happen, but at least it is not ruled out by the `recv(2)` documentation: a peek read of 10 bytes returns just 1 byte and repeating the peek read of 10 bytes returns the same 1 byte over and over again. The app can never peek past the 1 byte without actually consuming/reading that byte. I guess it must be ready for this behavior from the OS or from a mocked fuzzed socket.",
      "commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "created_at" : "2024-06-02T05:34:44Z",
      "diff_hunk" : "@@ -43,7 +43,7 @@ class FuzzedSock : public Sock\n      * If `MSG_PEEK` is used, then our `Recv()` returns some random data as usual, but on the next\n      * `Recv()` call we must return the same data, thus we remember it here.\n      */\n-    mutable std::optional<uint8_t> m_peek_data;\n+    mutable std::optional<std::vector<uint8_t>> m_peek_data;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1623330207",
      "id" : 1623330207,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII585gwg2f",
      "original_commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "original_line" : 46,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/fuzz/util/net.h",
      "position" : 5,
      "pull_request_review_id" : 2092217352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623330207/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-02T05:44:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623330207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1623330824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623330824"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Wow! Good catch! Maybe this deserves a comment because there is deeper reason for the way it is written than one may see at a first glance. (aka to prevent somebody restoring it back to `? requested : 0` in a future refactor, code reorganization).",
      "commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "created_at" : "2024-06-02T05:40:26Z",
      "diff_hunk" : "@@ -380,7 +379,7 @@ bool FuzzedSock::Wait(std::chrono::milliseconds timeout, Event requested, Event*\n         return false;\n     }\n     if (occurred != nullptr) {\n-        *occurred = m_fuzzed_data_provider.ConsumeBool() ? requested : 0;\n+        *occurred = m_fuzzed_data_provider.ConsumeBool() ? 0 : requested;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1623330824",
      "id" : 1623330824,
      "line" : 382,
      "node_id" : "PRRC_kwDOABII585gwhAI",
      "original_commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "original_line" : 382,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/test/fuzz/util/net.cpp",
      "position" : 31,
      "pull_request_review_id" : 2092217352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623330824/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-02T05:44:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1623330824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1624125082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624125082"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> did you encounter a case where the current/previous implementation that uses ConsumeBytes() is \"unstable\" or had problems in some other way?\r\n\r\nNo I just found this while investigating the peek issue (which was the main blocker).",
      "commit_id" : "22d0f1a27ef7733b51b3c2138a8d01713df8f248",
      "created_at" : "2024-06-03T09:39:05Z",
      "diff_hunk" : "@@ -193,21 +193,20 @@ ssize_t FuzzedSock::Recv(void* buf, size_t len, int flags) const\n     bool pad_to_len_bytes{m_fuzzed_data_provider.ConsumeBool()};\n     if (m_peek_data.has_value()) {\n         // `MSG_PEEK` was used in the preceding `Recv()` call, return `m_peek_data`.\n-        random_bytes.assign({m_peek_data.value()});\n+        random_bytes = m_peek_data.value();\n         if ((flags & MSG_PEEK) == 0) {\n             m_peek_data.reset();\n         }\n         pad_to_len_bytes = false;\n     } else if ((flags & MSG_PEEK) != 0) {\n         // New call with `MSG_PEEK`.\n-        random_bytes = m_fuzzed_data_provider.ConsumeBytes<uint8_t>(1);\n+        random_bytes = ConsumeRandomLengthByteVector(m_fuzzed_data_provider, len);\n         if (!random_bytes.empty()) {\n-            m_peek_data = random_bytes[0];\n+            m_peek_data = random_bytes;\n             pad_to_len_bytes = false;\n         }\n     } else {\n-        random_bytes = m_fuzzed_data_provider.ConsumeBytes<uint8_t>(\n-            m_fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, len));\n+        random_bytes = ConsumeRandomLengthByteVector(m_fuzzed_data_provider, len);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1624125082",
      "id" : 1624125082,
      "in_reply_to_id" : 1623328097,
      "line" : 209,
      "node_id" : "PRRC_kwDOABII585gzi6a",
      "original_commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "original_line" : 209,
      "original_position" : 22,
      "original_start_line" : 209,
      "path" : "src/test/fuzz/util/net.cpp",
      "position" : 22,
      "pull_request_review_id" : 2093328656,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624125082/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 209,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2024-06-03T09:39:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624125082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1624126459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624126459"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "22d0f1a27ef7733b51b3c2138a8d01713df8f248",
      "created_at" : "2024-06-03T09:40:00Z",
      "diff_hunk" : "@@ -193,21 +193,20 @@ ssize_t FuzzedSock::Recv(void* buf, size_t len, int flags) const\n     bool pad_to_len_bytes{m_fuzzed_data_provider.ConsumeBool()};\n     if (m_peek_data.has_value()) {\n         // `MSG_PEEK` was used in the preceding `Recv()` call, return `m_peek_data`.\n-        random_bytes.assign({m_peek_data.value()});\n+        random_bytes = m_peek_data.value();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1624126459",
      "id" : 1624126459,
      "in_reply_to_id" : 1623329527,
      "line" : 196,
      "node_id" : "PRRC_kwDOABII585gzjP7",
      "original_commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "original_line" : 196,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/fuzz/util/net.cpp",
      "position" : 5,
      "pull_request_review_id" : 2093330686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624126459/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-03T09:40:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624126459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1624128417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624128417"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added some comments",
      "commit_id" : "22d0f1a27ef7733b51b3c2138a8d01713df8f248",
      "created_at" : "2024-06-03T09:41:24Z",
      "diff_hunk" : "@@ -380,7 +379,7 @@ bool FuzzedSock::Wait(std::chrono::milliseconds timeout, Event requested, Event*\n         return false;\n     }\n     if (occurred != nullptr) {\n-        *occurred = m_fuzzed_data_provider.ConsumeBool() ? requested : 0;\n+        *occurred = m_fuzzed_data_provider.ConsumeBool() ? 0 : requested;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1624128417",
      "id" : 1624128417,
      "in_reply_to_id" : 1623330824,
      "line" : 389,
      "node_id" : "PRRC_kwDOABII585gzjuh",
      "original_commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "original_line" : 389,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/test/fuzz/util/net.cpp",
      "position" : 56,
      "pull_request_review_id" : 2093333804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624128417/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-03T09:41:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624128417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1624133280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624133280"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I could only find the following in the docs and based the changes here on that.\r\n\r\n```\r\nThis flag causes the receive operation to return data from\r\nthe beginning of the receive queue without removing that\r\ndata from the queue.  Thus, a subsequent receive call will\r\nreturn the same data.\r\n```\r\n\r\nWe could make it so that a peek read only returns one byte and a subsequent normal read return N bytes where the first byte corresponds to the peek byte. But I'm not sure if that would change much for our use case.",
      "commit_id" : "22d0f1a27ef7733b51b3c2138a8d01713df8f248",
      "created_at" : "2024-06-03T09:45:10Z",
      "diff_hunk" : "@@ -43,7 +43,7 @@ class FuzzedSock : public Sock\n      * If `MSG_PEEK` is used, then our `Recv()` returns some random data as usual, but on the next\n      * `Recv()` call we must return the same data, thus we remember it here.\n      */\n-    mutable std::optional<uint8_t> m_peek_data;\n+    mutable std::optional<std::vector<uint8_t>> m_peek_data;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30211#discussion_r1624133280",
      "id" : 1624133280,
      "in_reply_to_id" : 1623330207,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII585gzk6g",
      "original_commit_id" : "617d43e656816a532ca275707dffeb6e2a2e1fc7",
      "original_line" : 46,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/fuzz/util/net.h",
      "position" : 5,
      "pull_request_review_id" : 2093342139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30211",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624133280/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-03T09:45:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624133280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   }
]
