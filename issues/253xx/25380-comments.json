[
   {
      "author_association" : "MEMBER",
      "body" : "cc @glozow @instagibbs @naumenkogs since you Concept ACK'd #23074. This is implementing https://github.com/bitcoin/bitcoin/pull/23074#issuecomment-1152399594.",
      "created_at" : "2022-06-15T15:08:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1156595076",
      "id" : 1156595076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585E8D2E",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156595076/reactions"
      },
      "updated_at" : "2022-06-15T15:08:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156595076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "seems reasonable to not take signals that are obviously bogus, will give more thinking",
      "created_at" : "2022-06-15T15:12:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1156599898",
      "id" : 1156599898,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585E8FBa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156599898/reactions"
      },
      "updated_at" : "2022-06-15T15:12:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1156599898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r901020949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901020949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Prefer just passing `None` as `utxo` explicitly, as appropriate.",
      "commit_id" : "e928f4ce736bb2457533c235b9a1c2d5e7eb1dd6",
      "created_at" : "2022-06-18T22:07:56Z",
      "diff_hunk" : "@@ -115,13 +115,13 @@ def check_estimates(node, fees_seen):\n     check_smart_estimates(node, fees_seen)\n \n \n-def send_tx(wallet, node, utxo, feerate):\n+def send_tx(wallet, node, feerate, utxo=None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r901020949",
      "id" : 901020949,
      "line" : 118,
      "node_id" : "PRRC_kwDOABII5841tH0V",
      "original_commit_id" : "e928f4ce736bb2457533c235b9a1c2d5e7eb1dd6",
      "original_line" : 118,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/feature_fee_estimation.py",
      "position" : 5,
      "pull_request_review_id" : 1011454943,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901020949/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-18T22:08:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901020949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [naumenkogs](https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1226964404), [murchandamus](https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1435138448), [josibake](https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1497114881) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.\n",
      "created_at" : "2022-06-21T00:27:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1160986236",
      "id" : 1160986236,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585FMz58",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1160986236/reactions"
      },
      "updated_at" : "2023-09-04T17:44:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1160986236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r903587999"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903587999"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hm, I don't think `ancestor_score > individual_feerate` is really an indication that it was CPFP'd. We'd want to see if it had descendants in the block. It could just mean that this transaction had high-feerate ancestors.\r\n\r\nSuggested alternative: I think `ancestor_score < individual_feerate` would be a good indication that this tx was the sponsor of a CPFP in the block. Maybe we use that condition, and drop all of the transaction's ancestors from the fee estimator?  Or, to reduce over-pruning, we drop the ancestors whose feerates are lower than this transaction's?",
      "commit_id" : "e928f4ce736bb2457533c235b9a1c2d5e7eb1dd6",
      "created_at" : "2022-06-22T10:51:37Z",
      "diff_hunk" : "@@ -604,6 +604,16 @@ bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTxM\n         return false;\n     }\n \n+    // Do not consider this transaction's feerate if it might have been mined due to one of\n+    // its children (CPFP).\n+    // Note this check is only best-effort, as the child might not be part of the block. Or\n+    // another child might be part of the block that we didn't have in our mempool.\n+    CFeeRate feerate_entry{entry->GetFee(), (uint32_t)entry->GetTxSize()};\n+    for (const CTxMemPoolEntry& child : entry->GetMemPoolChildren()) {\n+        CFeeRate ancestor_score{child.GetModFeesWithAncestors(), (uint32_t)child.GetSizeWithAncestors()};\n+        if (ancestor_score > feerate_entry) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r903587999",
      "id" : 903587999,
      "line" : 614,
      "node_id" : "PRRC_kwDOABII584126if",
      "original_commit_id" : "e928f4ce736bb2457533c235b9a1c2d5e7eb1dd6",
      "original_line" : 614,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 11,
      "pull_request_review_id" : 1014954992,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903587999/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-22T10:56:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903587999",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Do we have a preference for underestimation vs overestimation of feerates?\r\n\r\nI think it's always better to be slightly overestimate than to slightly under-estimate, as the latter can result in frustration for the regular onchain user or degraded service quality for professionals (for instance stuck transactions can create a \"shortage\" of confirmed UTxOs or too long mempool chains). As far as i can tell from discussions and the algorithm it's always been the opinion to err on the conservative side.\r\n\r\n> It's probably bad to include both sponsors and sponsees in CPFP situations?\r\n\r\nSponsees aren't included since transactions with mempool dependencies don't get considered for fee estimation. And i don't think we can do that until we find a proper way of considering packages in the fee estimator.",
      "created_at" : "2022-06-22T11:12:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1162966539",
      "id" : 1162966539,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585FUXYL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1162966539/reactions"
      },
      "updated_at" : "2022-06-22T11:12:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1162966539",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r903657968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903657968"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(TL;DR your suggestion is best but i'm leaving the response to the first section for context)\r\n\r\nYeah it's a best effort. I could make sure that the descendant was also part of the block. Is it worth it though? If an ancestor-less transaction with mempool child that pay a higher feerate than itself got mined, the child probably got included as well (not necessarily, but i assumed very probably).\r\nDo you think that assumption isn't reasonable? My doubt is more with more convoluted packages. For instance:\r\n```\r\nA ------ D\r\n      __/ /\r\nB /      /\r\n      _ /\r\nC /\r\n```\r\nWith `A` 1sat/vb, `B` 10sat/vb, `C` 10sat/vb and `D` 1sat/vb. It would be a false positive for `A`. To prevent this we could simply condition the check on the descendants feerate of `A`:\r\n```patch\r\ndiff --git a/src/policy/fees.cpp b/src/policy/fees.cpp\r\nindex 029dd108c3..5d5dfb2efe 100644\r\n--- a/src/policy/fees.cpp\r\n+++ b/src/policy/fees.cpp\r\n@@ -609,9 +609,12 @@ bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTxM\r\n     // Note this check is only best-effort, as the child might not be part of the block. Or\r\n     // another child might be part of the block that we didn't have in our mempool.\r\n     CFeeRate feerate_entry{entry->GetFee(), (uint32_t)entry->GetTxSize()};\r\n-    for (const CTxMemPoolEntry& child : entry->GetMemPoolChildren()) {\r\n-        CFeeRate ancestor_score{child.GetModFeesWithAncestors(), (uint32_t)child.GetSizeWithAncestors()};\r\n-        if (ancestor_score > feerate_entry) return false;\r\n+    CFeeRate feerate_desc{entry->GetModFeesWithDescendants(), (uint32_t)entry->GetSizeWithDescendants()};\r\n+    if (feerate_desc > feerate_entry) {\r\n+        for (const CTxMemPoolEntry& child : entry->GetMemPoolChildren()) {\r\n+            CFeeRate ancestor_score{child.GetModFeesWithAncestors(), (uint32_t)child.GetSizeWithAncestors()};\r\n+            if (ancestor_score > feerate_entry) return false;\r\n+        }\r\n     }\r\n \r\n     // How many blocks did it take for miners to include this transaction?\r\n```\r\n\r\n----\r\n\r\nRegarding your suggestion. do you mean we should iterate over all the mempool entries that were part of the block to detect CPFPs beforehand? I agree it's much better. It makes sure that the child was part of the same block. And your suggestion to only drop the ancestors whose feerates are lower than this transaction's covers the case i detailed above. Nice! Is that roughly what you were thinking about:\r\n```patch\r\ndiff --git a/src/policy/fees.cpp b/src/policy/fees.cpp\r\nindex 029dd108c3..8c0e71ea18 100644\r\n--- a/src/policy/fees.cpp\r\n+++ b/src/policy/fees.cpp\r\n@@ -604,16 +604,6 @@ bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTxM\r\n         return false;\r\n     }\r\n \r\n-    // Do not consider this transaction's feerate if it might have been mined due to one of\r\n-    // its children (CPFP).\r\n-    // Note this check is only best-effort, as the child might not be part of the block. Or\r\n-    // another child might be part of the block that we didn't have in our mempool.\r\n-    CFeeRate feerate_entry{entry->GetFee(), (uint32_t)entry->GetTxSize()};\r\n-    for (const CTxMemPoolEntry& child : entry->GetMemPoolChildren()) {\r\n-        CFeeRate ancestor_score{child.GetModFeesWithAncestors(), (uint32_t)child.GetSizeWithAncestors()};\r\n-        if (ancestor_score > feerate_entry) return false;\r\n-    }\r\n-\r\n     // How many blocks did it take for miners to include this transaction?\r\n     // blocksToConfirm is 1-based, so a transaction included in the earliest\r\n     // possible block has confirmation count of 1\r\n@@ -625,6 +615,7 @@ bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTxM\r\n         return false;\r\n     }\r\n \r\n+    CFeeRate feerate_entry{entry->GetFee(), (uint32_t)entry->GetTxSize()};\r\n     feeStats->Record(blocksToConfirm, (double)feerate_entry.GetFeePerK());\r\n     shortStats->Record(blocksToConfirm, (double)feerate_entry.GetFeePerK());\r\n     longStats->Record(blocksToConfirm, (double)feerate_entry.GetFeePerK());\r\n@@ -659,6 +650,18 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\r\n     shortStats->UpdateMovingAverages();\r\n     longStats->UpdateMovingAverages();\r\n \r\n+    for (const auto& entry : entries) {\r\n+        CFeeRate individual_feerate{entry->GetFee(), (uint32_t)entry->GetTxSize()};\r\n+        CFeeRate ancestor_score{entry->GetModFeesWithAncestors(), (uint32_t)entry->GetSizeWithAncestors()};\r\n+\r\n+        if (individual_feerate > ancestor_score) {\r\n+            for (const CTxMemPoolEntry& parent : entry->GetMemPoolParents()) {\r\n+                CFeeRate parent_feerate{parent.GetFee(), (uint32_t)parent.GetTxSize()};\r\n+                if (parent_feerate < individual_feerate) _removeTx(parent.GetTx().GetHash(), true);\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n     unsigned int countedTxs = 0;\r\n     // Update averages with data points from current block\r\n     for (const auto& entry : entries) {\r\n```",
      "commit_id" : "e928f4ce736bb2457533c235b9a1c2d5e7eb1dd6",
      "created_at" : "2022-06-22T12:04:24Z",
      "diff_hunk" : "@@ -604,6 +604,16 @@ bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTxM\n         return false;\n     }\n \n+    // Do not consider this transaction's feerate if it might have been mined due to one of\n+    // its children (CPFP).\n+    // Note this check is only best-effort, as the child might not be part of the block. Or\n+    // another child might be part of the block that we didn't have in our mempool.\n+    CFeeRate feerate_entry{entry->GetFee(), (uint32_t)entry->GetTxSize()};\n+    for (const CTxMemPoolEntry& child : entry->GetMemPoolChildren()) {\n+        CFeeRate ancestor_score{child.GetModFeesWithAncestors(), (uint32_t)child.GetSizeWithAncestors()};\n+        if (ancestor_score > feerate_entry) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r903657968",
      "id" : 903657968,
      "in_reply_to_id" : 903587999,
      "line" : 614,
      "node_id" : "PRRC_kwDOABII58413Lnw",
      "original_commit_id" : "e928f4ce736bb2457533c235b9a1c2d5e7eb1dd6",
      "original_line" : 614,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 11,
      "pull_request_review_id" : 1015053888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903657968/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-22T12:04:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903657968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r904047470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/904047470"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done. What do you think of this PR conceptually?",
      "commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "created_at" : "2022-06-22T17:20:13Z",
      "diff_hunk" : "@@ -115,13 +115,13 @@ def check_estimates(node, fees_seen):\n     check_smart_estimates(node, fees_seen)\n \n \n-def send_tx(wallet, node, utxo, feerate):\n+def send_tx(wallet, node, feerate, utxo=None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r904047470",
      "id" : 904047470,
      "in_reply_to_id" : 901020949,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58414qtu",
      "original_commit_id" : "e928f4ce736bb2457533c235b9a1c2d5e7eb1dd6",
      "original_line" : 118,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/feature_fee_estimation.py",
      "position" : null,
      "pull_request_review_id" : 1015615493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/904047470/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-22T17:20:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/904047470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Force-pushed to address @luke-jr's nit and include @glozow's great suggestion to identify CPFP from child, not parents.",
      "created_at" : "2022-06-22T17:21:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1163406979",
      "id" : 1163406979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585FWC6D",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1163406979/reactions"
      },
      "updated_at" : "2022-06-22T17:21:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1163406979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r905066732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905066732"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, it's more sensible to just look at the sponsor's ancestors since you're guaranteed that they were all in the block too.\r\n\r\nI like the second approach in your above comment, i.e. 5485acfe88051234a09862819ddc2953f9d42058. I was going to suggest possibly removing *all* ancestors, and not just direct parents, but I see that we can't really query all ancestors since we only have the single entry.",
      "commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "created_at" : "2022-06-23T14:06:16Z",
      "diff_hunk" : "@@ -604,6 +604,16 @@ bool CBlockPolicyEstimator::processBlockTx(unsigned int nBlockHeight, const CTxM\n         return false;\n     }\n \n+    // Do not consider this transaction's feerate if it might have been mined due to one of\n+    // its children (CPFP).\n+    // Note this check is only best-effort, as the child might not be part of the block. Or\n+    // another child might be part of the block that we didn't have in our mempool.\n+    CFeeRate feerate_entry{entry->GetFee(), (uint32_t)entry->GetTxSize()};\n+    for (const CTxMemPoolEntry& child : entry->GetMemPoolChildren()) {\n+        CFeeRate ancestor_score{child.GetModFeesWithAncestors(), (uint32_t)child.GetSizeWithAncestors()};\n+        if (ancestor_score > feerate_entry) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r905066732",
      "id" : 905066732,
      "in_reply_to_id" : 903587999,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58418jjs",
      "original_commit_id" : "e928f4ce736bb2457533c235b9a1c2d5e7eb1dd6",
      "original_line" : 614,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : null,
      "pull_request_review_id" : 1017074251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905066732/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-23T14:06:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905066732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> transactions with mempool dependencies don't get considered for fee estimation.\r\n\r\nAh, my bad! Seems like we're definitely underestimating in CPFP situations right now, then, since we include the parents but not the child.\r\n\r\n> I think it's always better to be slightly overestimate than to slightly under-estimate\r\n\r\nI agree, it seems safer to sometimes pay a little extra than to miss your confirmation target.",
      "created_at" : "2022-06-23T14:12:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1164459119",
      "id" : 1164459119,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585FaDxv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1164459119/reactions"
      },
      "updated_at" : "2022-06-23T14:12:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1164459119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r906847481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906847481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Feels like a hack that would be better off identifying CPFP from the block contents itself. Possibly even using it for the estimates, if practical. But at least this should be better than nothing.",
      "commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "created_at" : "2022-06-26T17:10:03Z",
      "diff_hunk" : "@@ -115,13 +115,13 @@ def check_estimates(node, fees_seen):\n     check_smart_estimates(node, fees_seen)\n \n \n-def send_tx(wallet, node, utxo, feerate):\n+def send_tx(wallet, node, feerate, utxo=None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r906847481",
      "id" : 906847481,
      "in_reply_to_id" : 901020949,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842DWT5",
      "original_commit_id" : "e928f4ce736bb2457533c235b9a1c2d5e7eb1dd6",
      "original_line" : 118,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/feature_fee_estimation.py",
      "position" : null,
      "pull_request_review_id" : 1019458653,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906847481/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-26T17:10:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906847481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r920292164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/920292164"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure why we have this criterium `individual_feerate > ancestor_score`.\r\nIn a CPFP situation with a child C, a low-fee parent P1 which it pays for, and another high-fee parent P2 of C, it could prevent us from removing P1 from the fee estimation, because C's ancestor score (which is influenced by P2) might be larger than its individual feerate.\r\n\r\nI understand that the check is a heuristic and can't cover everything, but would there be any downside if we just dropped this check and only applied the second criterion, `parent_feerate < individual_feerate`?",
      "commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "created_at" : "2022-07-13T16:39:42Z",
      "diff_hunk" : "@@ -652,6 +652,23 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\n     shortStats->UpdateMovingAverages();\n     longStats->UpdateMovingAverages();\n \n+    // Do not consider transactions that were CPFP'd.\n+    // For each mempool transaction that was included in a block, if its individual feerate is higher\n+    // than its ancestor score it incentivized the inclusion of some of its parents in the block.\n+    // Remove all such parents whose feerate is lower than the child's of the tracking before updating\n+    // the data points.\n+    for (const auto& entry : entries) {\n+        CFeeRate individual_feerate{entry->GetFee(), (uint32_t)entry->GetTxSize()};\n+        CFeeRate ancestor_score{entry->GetModFeesWithAncestors(), (uint32_t)entry->GetSizeWithAncestors()};\n+\n+        if (individual_feerate > ancestor_score) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r920292164",
      "id" : 920292164,
      "line" : 664,
      "node_id" : "PRRC_kwDOABII58422otE",
      "original_commit_id" : "5485acfe88051234a09862819ddc2953f9d42058",
      "original_line" : 664,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 13,
      "pull_request_review_id" : 1037668428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/920292164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T18:11:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/920292164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r920958301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/920958301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Only having `parent_feerate < individual_feerate` does not account for the size of the dependencies. For instance, a transaction `C` (2000 sat, 100 vb) spending a transaction `B` (200 sat, 1000 vb) which in turn spends a transaction `A` (1000sat, 100 vb):\r\n```\r\nA --- B --- C\r\n```\r\n`C` clearly does not CPFP `A`, while it has a higher feerate. We want to check `parent_feerate < ancestor_score`. We do it indirectly since `individual_feerate > ancestor_score`.\r\n\r\n`individual_feerate > ancestor_score` is to make sure the child is paying, to prevent a pay-for-sibling scenario:\r\n```\r\nA\r\n  \\\r\n     C\r\n  /\r\nB\r\n```\r\n`B` is 2sat/vb, `A` is 1sat/vb, `C` is 1sat/vb. The ancestor score of `C` is larger than the feerate of `A`, but it's not a CPFP.\r\n\r\nSo this may be too conservative in some scenario, such as the one you describe. But i can't think of a reasonable way to take it into account. Also i think we better be overly conservative if that gives us confidence we won't let some false positives through.",
      "commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "created_at" : "2022-07-14T09:36:35Z",
      "diff_hunk" : "@@ -652,6 +652,23 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\n     shortStats->UpdateMovingAverages();\n     longStats->UpdateMovingAverages();\n \n+    // Do not consider transactions that were CPFP'd.\n+    // For each mempool transaction that was included in a block, if its individual feerate is higher\n+    // than its ancestor score it incentivized the inclusion of some of its parents in the block.\n+    // Remove all such parents whose feerate is lower than the child's of the tracking before updating\n+    // the data points.\n+    for (const auto& entry : entries) {\n+        CFeeRate individual_feerate{entry->GetFee(), (uint32_t)entry->GetTxSize()};\n+        CFeeRate ancestor_score{entry->GetModFeesWithAncestors(), (uint32_t)entry->GetSizeWithAncestors()};\n+\n+        if (individual_feerate > ancestor_score) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r920958301",
      "id" : 920958301,
      "in_reply_to_id" : 920292164,
      "line" : 664,
      "node_id" : "PRRC_kwDOABII58425LVd",
      "original_commit_id" : "5485acfe88051234a09862819ddc2953f9d42058",
      "original_line" : 664,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 13,
      "pull_request_review_id" : 1038584706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/920958301/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-14T10:23:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/920958301",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r921107765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921107765"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't understand how `individual_feerate > ancestor_score` helps in your first example: \r\nBoth B and C have been excluded from the fee estimation already in validation, because they had mempool ancestors. The algorithm added in this PR can only ever remove (direct) parents from the fee estimation, it doesn't loop through ancestors of a higher level - so C and its ancestor score seem irrelevant, because the processing of C could only ever remove B (which is already removed) but can't remove  A because it's not a parent of C?\r\nAnd while processing B (which could remove A in theory) the second criterion `parent_feerate < individual_feerate` would work out, so we don't remove A there either.",
      "commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "created_at" : "2022-07-14T12:39:05Z",
      "diff_hunk" : "@@ -652,6 +652,23 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\n     shortStats->UpdateMovingAverages();\n     longStats->UpdateMovingAverages();\n \n+    // Do not consider transactions that were CPFP'd.\n+    // For each mempool transaction that was included in a block, if its individual feerate is higher\n+    // than its ancestor score it incentivized the inclusion of some of its parents in the block.\n+    // Remove all such parents whose feerate is lower than the child's of the tracking before updating\n+    // the data points.\n+    for (const auto& entry : entries) {\n+        CFeeRate individual_feerate{entry->GetFee(), (uint32_t)entry->GetTxSize()};\n+        CFeeRate ancestor_score{entry->GetModFeesWithAncestors(), (uint32_t)entry->GetSizeWithAncestors()};\n+\n+        if (individual_feerate > ancestor_score) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r921107765",
      "id" : 921107765,
      "in_reply_to_id" : 920292164,
      "line" : 664,
      "node_id" : "PRRC_kwDOABII58425v01",
      "original_commit_id" : "5485acfe88051234a09862819ddc2953f9d42058",
      "original_line" : 664,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 13,
      "pull_request_review_id" : 1038797796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921107765/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-14T12:39:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921107765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r921153998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921153998"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You are right, i wrote this example assuming we were going through all ancestors of a transaction. :facepalm:\r\n\r\nNonetheless the first example works also if `A` and `B` are siblings.\r\n",
      "commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "created_at" : "2022-07-14T13:27:02Z",
      "diff_hunk" : "@@ -652,6 +652,23 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\n     shortStats->UpdateMovingAverages();\n     longStats->UpdateMovingAverages();\n \n+    // Do not consider transactions that were CPFP'd.\n+    // For each mempool transaction that was included in a block, if its individual feerate is higher\n+    // than its ancestor score it incentivized the inclusion of some of its parents in the block.\n+    // Remove all such parents whose feerate is lower than the child's of the tracking before updating\n+    // the data points.\n+    for (const auto& entry : entries) {\n+        CFeeRate individual_feerate{entry->GetFee(), (uint32_t)entry->GetTxSize()};\n+        CFeeRate ancestor_score{entry->GetModFeesWithAncestors(), (uint32_t)entry->GetSizeWithAncestors()};\n+\n+        if (individual_feerate > ancestor_score) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r921153998",
      "id" : 921153998,
      "in_reply_to_id" : 920292164,
      "line" : 664,
      "node_id" : "PRRC_kwDOABII584257HO",
      "original_commit_id" : "5485acfe88051234a09862819ddc2953f9d42058",
      "original_line" : 664,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 13,
      "pull_request_review_id" : 1038867489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921153998/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-14T13:27:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/921153998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r926188854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926188854"
         }
      },
      "author_association" : "MEMBER",
      "body" : "While I agree than a child with an individual feerate than its ancestor score incentivized the inclusion of some of its parents in the block, I don't think it means the parent wouldn't have make it alone on its own feerate in the block. I wonder if a most sophisticated heuristic wouldn't be to qualify the sponsoring if the parent feerate is lower than your top mempool feerate group at block reception. Of course, considering block reception would make things free of block propagation allowing your mempool content to fluctuate though assuming perfect information propagation might be okay. \r\n\r\nI believe such situations could arise when there is no entity with the full-view of the package, in the sense that the CPFP can be attached by a different transaction issuer than the parent one. Therefore this second party might have different views of the mempool or more conservative fee-bumping strategy.\r\n\r\nHowever, I think that type of situations is for now scarce enough than the current proposed heuristic `individual_feerate` > `ancestor_score` is good enough ?\r\n\r\nIn any case, I think it would be good to document the heuristic rational and the bounds here, in case of future changes in the ecosystem of Bitcoin applications invalidating this heuristic. ",
      "commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "created_at" : "2022-07-21T02:05:37Z",
      "diff_hunk" : "@@ -652,6 +652,23 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\n     shortStats->UpdateMovingAverages();\n     longStats->UpdateMovingAverages();\n \n+    // Do not consider transactions that were CPFP'd.\n+    // For each mempool transaction that was included in a block, if its individual feerate is higher\n+    // than its ancestor score it incentivized the inclusion of some of its parents in the block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r926188854",
      "id" : 926188854,
      "line" : 657,
      "node_id" : "PRRC_kwDOABII5843NIU2",
      "original_commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "original_line" : 657,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 6,
      "pull_request_review_id" : 1045851950,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926188854/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-21T02:08:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/926188854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r929854844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929854844"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it's reasonable to assume the content of the mempool of the mining pool node was the same at the time it created a block template (which can be relatively long before a grinder found a valid pow) than our mempool at the time we received the block (which can be relatively long after they found it).\r\nEven then, i don't think it'd be worth creating a block template just for a slightly more accurate filtering. Instead, i think any more complexity than a simple conservative heuristic should go into making the estimator packages-aware.\r\n\r\nRegarding the documentation of the heuristic, what are you suggesting? You are commenting on a code comment documenting this heuristic.",
      "commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "created_at" : "2022-07-26T11:34:54Z",
      "diff_hunk" : "@@ -652,6 +652,23 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\n     shortStats->UpdateMovingAverages();\n     longStats->UpdateMovingAverages();\n \n+    // Do not consider transactions that were CPFP'd.\n+    // For each mempool transaction that was included in a block, if its individual feerate is higher\n+    // than its ancestor score it incentivized the inclusion of some of its parents in the block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r929854844",
      "id" : 929854844,
      "in_reply_to_id" : 926188854,
      "line" : 657,
      "node_id" : "PRRC_kwDOABII5843bHV8",
      "original_commit_id" : "200a49f7e7197cfa5ba8b8123d3597e84eab0aa1",
      "original_line" : 657,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 6,
      "pull_request_review_id" : 1050826175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929854844/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-26T11:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/929854844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nThe inaccuracy seems real. Since we're targeting a simple heuristic, there will be downsides. The risk is overestimating and paying extra I guess.\r\nIf we really want to check, we can measure how would fees differ by applying this change to historic blocks (?)\r\n\r\nOtherwise, it would help if @darosior summarized the alternatives suggested in couple sentences (or helping in navigating the design scope e.g. \"what could be possibly done\").\r\n\r\nAs for the current code, I think it's an improvement, but I think we indeed need more eyes/opinions.",
      "created_at" : "2022-08-25T08:44:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1226964404",
      "id" : 1226964404,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585JIf20",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1226964404/reactions"
      },
      "updated_at" : "2022-08-25T08:44:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1226964404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-12-19T09:33:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1357357823",
      "id" : 1357357823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585Q56L_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1357357823/reactions"
      },
      "updated_at" : "2022-12-19T09:33:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1357357823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nDid some light review, looks reasonable, would review again when rebased",
      "created_at" : "2023-02-17T19:30:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1435138448",
      "id" : 1435138448,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585VinmQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435138448/reactions"
      },
      "updated_at" : "2023-02-17T19:31:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1435138448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks everyone for the interest, finally reviving this. Rebased and modernized the code (use static casts and named parameters, make use of batched RPC calls after #26656).\r\n\r\n@naumenkogs\r\n>  If we really want to check, we can measure how would fees differ by applying this change to historic blocks (?)\r\n\r\nWe'd also need historical snapshots of a mempool to do that. If someone has got some and is willing to test, i'd be very interested in seeing the results.\r\n\r\n> Otherwise, it would help if @darosior summarized the alternatives suggested in couple sentences (or helping in navigating the design scope e.g. \"what could be possibly done\").\r\n\r\nThe design space is actually quite narrow. Short of tracking packages, we can only get rid of invalid data points. I aim for the detection logic to be straightforward and conservative: better let a few invalid data points still go through rather than drop some valid ones.\r\nTo achieve this we go through the mempool entries that were included in a block when connecting it. We then apply two heuristics to determine whether it is a child paying for a parent we may be tracking for fee estimation:\r\n1. The individual feerate of this transaction is higher than its ancestor feerate. (Will be equal if it has no ancestor.)\r\n2. The individual feerate of the parent is lower than the individual feerate of this transaction. (Note it is not necessary to check if the parent itself has ancestors since if it does we wouldn't be tracking it for fee estimation.)\r\n\r\nIt was suggested by @mzumsande in https://github.com/bitcoin/bitcoin/pull/25380#discussion_r920292164 we may be able to get rid of the first heuristic, effectively only checking if a transaction we are tracking was mined along with a child transaction that has a higher feerate. I don't think it is correct, as the child transaction's effective feerate may be lower than the parent's. For instance:\r\n```\r\nA (1000sats; 100vb)\r\n                    \\\r\n                      C (1200sats; 100vb)\r\n                    /\r\nB (100sats; 100vb)\r\n```\r\nIn this diagram, `C` would be incorrectly accounted as a CPFP of `A` if we were to only use the second heuristic. However by using both heuristics `C` would still be detected as a CPFP of `B` (and only of `B`).\r\n\r\nAnother thing that could be done here is to take into account \"second-order\" CPFP. That is, if the child of the child of a transaction we are tracking for fee estimation is bumping. For instance (same as above + `D`):\r\n```\r\nA (1000sats; 100vb)\r\n                    \\\r\n                      C (1200sats; 100vb) -- D (10000sats; 100vb)\r\n                    /\r\nB (100sats; 100vb)\r\n```\r\nIn this diagram we would not be detecting neither `A` nor `B` as being CPFP'd. But solving this requires looking at the descendant feerate of an entry, which AFAICT brings a lot of complexity (and computation) to make sure we don't count a descendant multiple times in more complicated packages. In addition i suspect most CPFPs used on the network currently are \"first-order\" CPFPs (e.g. an \"accelerate\" button on a deposit on an onchain wallet, or anchor outputs for commitment transactions in Lightning).\r\nTherefore, even if it was reasonable to try to account for longer chains of CPFPs (which i'm not convinced it is), i'd be more inclined to not attempts to do so here. If we want to do this let's merge this simple and straightforward fix for most of the CPFP usage and try to tackle edge cases in a follow-up.\r\n\r\nFinally, i'm considering being more strict on the first heuristic. We could for instance require that the child is at least a 10% increase in feerate to be considered a CPFP. Because currently a parent would be considered to have been CPFP'd if it has a child with an individual feerate `0.001sat/vb` higher than its ancestor feerate. In this case i think the parent's feerate is still a good datapoint and we shouldn't get rid of it. What do you all think?",
      "created_at" : "2023-04-03T14:41:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1494455306",
      "id" : 1494455306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585ZE5QK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1494455306/reactions"
      },
      "updated_at" : "2023-04-03T14:41:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1494455306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r1156064559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156064559"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Resolving this, i don't think we can get rid of this heuristic. https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1494455306 gives a counter example where it would lead to a false positive. Please let me know if you disagree.",
      "commit_id" : "5ae45ad9cf96d91c09f242fd7292986f815937c6",
      "created_at" : "2023-04-03T14:43:34Z",
      "diff_hunk" : "@@ -652,6 +652,23 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\n     shortStats->UpdateMovingAverages();\n     longStats->UpdateMovingAverages();\n \n+    // Do not consider transactions that were CPFP'd.\n+    // For each mempool transaction that was included in a block, if its individual feerate is higher\n+    // than its ancestor score it incentivized the inclusion of some of its parents in the block.\n+    // Remove all such parents whose feerate is lower than the child's of the tracking before updating\n+    // the data points.\n+    for (const auto& entry : entries) {\n+        CFeeRate individual_feerate{entry->GetFee(), (uint32_t)entry->GetTxSize()};\n+        CFeeRate ancestor_score{entry->GetModFeesWithAncestors(), (uint32_t)entry->GetSizeWithAncestors()};\n+\n+        if (individual_feerate > ancestor_score) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r1156064559",
      "id" : 1156064559,
      "in_reply_to_id" : 920292164,
      "line" : 661,
      "node_id" : "PRRC_kwDOABII585E6CUv",
      "original_commit_id" : "5485acfe88051234a09862819ddc2953f9d42058",
      "original_line" : 661,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 13,
      "pull_request_review_id" : 1369194660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156064559/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-03T14:43:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1156064559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\n> We'd also need historical snapshots of a mempool to do that. If someone has got some and is willing to test, i'd be very interested in seeing the results.\r\n\r\nI have historical snapshots and would be happy to help run the test. Although, since running the test is not trivial, I wouldn't make a blocker for the PR. ",
      "created_at" : "2023-04-05T08:29:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1497114881",
      "id" : 1497114881,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585ZPCkB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1497114881/reactions"
      },
      "updated_at" : "2023-04-05T08:29:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1497114881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-06-20T17:22:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1599211265",
      "id" : 1599211265,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585fUgcB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599211265/reactions"
      },
      "updated_at" : "2023-06-20T17:22:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599211265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r1252358645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252358645"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```c++\r\n if (parent_feerate < individual_feerate) _removeTx(parent.GetTx().GetHash(), /* inBlock = */true);\r\n```\r\nThis means parents that are confirmed from previous blocks are going to be removed as well right?  not just parents from this block we are processing?\r\n",
      "commit_id" : "5ae45ad9cf96d91c09f242fd7292986f815937c6",
      "created_at" : "2023-07-04T21:04:49Z",
      "diff_hunk" : "@@ -649,6 +649,23 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\n     shortStats->UpdateMovingAverages();\n     longStats->UpdateMovingAverages();\n \n+    // Do not consider transactions that were CPFP'd.\n+    // For each mempool transaction that was included in a block, if its individual feerate is higher\n+    // than its ancestor score it incentivized the inclusion of some of its parents in the block.\n+    // Remove all such parents whose feerate is lower than the child's of the tracking before updating\n+    // the data points.\n+    for (const auto& entry : entries) {\n+        CFeeRate individual_feerate{entry->GetFee(), static_cast<uint32_t>(entry->GetTxSize())};\n+        CFeeRate ancestor_score{entry->GetModFeesWithAncestors(), static_cast<uint32_t>(entry->GetSizeWithAncestors())};\n+\n+        if (individual_feerate > ancestor_score) {\n+            for (const CTxMemPoolEntry& parent : entry->GetMemPoolParents()) {\n+                CFeeRate parent_feerate{parent.GetFee(), static_cast<uint32_t>(parent.GetTxSize())};\n+                if (parent_feerate < individual_feerate) _removeTx(parent.GetTx().GetHash(), /* inBlock = */true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r1252358645",
      "id" : 1252358645,
      "line" : 664,
      "node_id" : "PRRC_kwDOABII585KpXn1",
      "original_commit_id" : "5ae45ad9cf96d91c09f242fd7292986f815937c6",
      "original_line" : 664,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 16,
      "pull_request_review_id" : 1513416599,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252358645/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-04T21:24:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252358645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r1252831228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252831228"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, any parents from previous blocks would not exist in the mempool anymore. They would have been removed when that block was processed.",
      "commit_id" : "5ae45ad9cf96d91c09f242fd7292986f815937c6",
      "created_at" : "2023-07-05T09:32:29Z",
      "diff_hunk" : "@@ -649,6 +649,23 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\n     shortStats->UpdateMovingAverages();\n     longStats->UpdateMovingAverages();\n \n+    // Do not consider transactions that were CPFP'd.\n+    // For each mempool transaction that was included in a block, if its individual feerate is higher\n+    // than its ancestor score it incentivized the inclusion of some of its parents in the block.\n+    // Remove all such parents whose feerate is lower than the child's of the tracking before updating\n+    // the data points.\n+    for (const auto& entry : entries) {\n+        CFeeRate individual_feerate{entry->GetFee(), static_cast<uint32_t>(entry->GetTxSize())};\n+        CFeeRate ancestor_score{entry->GetModFeesWithAncestors(), static_cast<uint32_t>(entry->GetSizeWithAncestors())};\n+\n+        if (individual_feerate > ancestor_score) {\n+            for (const CTxMemPoolEntry& parent : entry->GetMemPoolParents()) {\n+                CFeeRate parent_feerate{parent.GetFee(), static_cast<uint32_t>(parent.GetTxSize())};\n+                if (parent_feerate < individual_feerate) _removeTx(parent.GetTx().GetHash(), /* inBlock = */true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r1252831228",
      "id" : 1252831228,
      "in_reply_to_id" : 1252358645,
      "line" : 664,
      "node_id" : "PRRC_kwDOABII585KrK_8",
      "original_commit_id" : "5ae45ad9cf96d91c09f242fd7292986f815937c6",
      "original_line" : 664,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 16,
      "pull_request_review_id" : 1514092159,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252831228/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T09:32:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252831228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I have historical snapshots and would be happy to help run the test. Although, since running the test is not trivial, I wouldn't make a blocker for the PR.\r\n\r\nMaybe something a bit simpler related to historical data: are we able to see what percentage of block transactions actually have ancestors/descendants? My understanding is that the percentage is quite low. So an alternative approach could be to just ignore any transactions with in-block descendants (just like we ignore any with in-block ancestors) instead of trying add logic to detect CPFPs.",
      "created_at" : "2023-07-05T09:36:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1621396296",
      "id" : 1621396296,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585gpItI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1621396296/reactions"
      },
      "updated_at" : "2023-07-05T09:36:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1621396296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r1252956237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252956237"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you\r\nIf the ancestors are confirmed in the previous block, and the child (with fee rate higher than ancestors score) is in the block we are processing, is that also considered CPFP?  if yes then we are not removing those ancestors here right (they were removed when that block was confirmed and recorded in block stats)?\r\n\r\nAlso why is  `/* inBlock = */true`  ?",
      "commit_id" : "5ae45ad9cf96d91c09f242fd7292986f815937c6",
      "created_at" : "2023-07-05T11:16:47Z",
      "diff_hunk" : "@@ -649,6 +649,23 @@ void CBlockPolicyEstimator::processBlock(unsigned int nBlockHeight,\n     shortStats->UpdateMovingAverages();\n     longStats->UpdateMovingAverages();\n \n+    // Do not consider transactions that were CPFP'd.\n+    // For each mempool transaction that was included in a block, if its individual feerate is higher\n+    // than its ancestor score it incentivized the inclusion of some of its parents in the block.\n+    // Remove all such parents whose feerate is lower than the child's of the tracking before updating\n+    // the data points.\n+    for (const auto& entry : entries) {\n+        CFeeRate individual_feerate{entry->GetFee(), static_cast<uint32_t>(entry->GetTxSize())};\n+        CFeeRate ancestor_score{entry->GetModFeesWithAncestors(), static_cast<uint32_t>(entry->GetSizeWithAncestors())};\n+\n+        if (individual_feerate > ancestor_score) {\n+            for (const CTxMemPoolEntry& parent : entry->GetMemPoolParents()) {\n+                CFeeRate parent_feerate{parent.GetFee(), static_cast<uint32_t>(parent.GetTxSize())};\n+                if (parent_feerate < individual_feerate) _removeTx(parent.GetTx().GetHash(), /* inBlock = */true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#discussion_r1252956237",
      "id" : 1252956237,
      "in_reply_to_id" : 1252358645,
      "line" : 664,
      "node_id" : "PRRC_kwDOABII585KrphN",
      "original_commit_id" : "5ae45ad9cf96d91c09f242fd7292986f815937c6",
      "original_line" : 664,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 16,
      "pull_request_review_id" : 1514279769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25380",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252956237/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-05T11:27:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252956237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Good point. I would have bet it's a non-trivial percentage (and an increasing one), so i wrote a quick Python script to measure this. It's [there](https://github.com/darosior/count_cpfps/blob/master/count_cpfps.py).\r\n\r\nHere is the results for a few (small) block ranges i picked at random. The CPFP usage seems non trivial to me (between 10% to 15% of all transactions in a block).\r\n\r\n<details>\r\n\r\n<summary>Between block heights 799241 and 799251</summary>\r\n\r\n```\r\nBetween block heights 799241 and 799251:                                                                                                                                                                                                                                                                                                                                   \r\n    - The average percentage of transactions with a descendant in the same block is 11.518659558263519%\r\n    - The average percentage of transactions with an ancestor in the same block is 19.363290175171365%\r\n    - The highest percentage of transactions with a descendant in the same block is 23.660842165568603\r\n    - The highest percentage of transactions with an ancestor in the same block is 30.215827338129497\r\n    - The lowest percentage of transactions with a descendant in the same block is 2.486788933789245\r\n    - The lowest percentage of transactions with an ancestor in the same block is 6.264840182648401\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>Between block heights 789241 and 789251</summary>\r\n\r\n```\r\nBetween block heights 789241 and 789251:                                                  \r\n    - The average percentage of transactions with a descendant in the same block is 16.697372248618247%\r\n    - The average percentage of transactions with an ancestor in the same block is 38.6041888878115%\r\n    - The highest percentage of transactions with a descendant in the same block is 22.668609492089924\r\n    - The highest percentage of transactions with an ancestor in the same block is 61.427238805970156\r\n    - The lowest percentage of transactions with a descendant in the same block is 11.335830212234708\r\n    - The lowest percentage of transactions with an ancestor in the same block is 22.358722358722357\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>Between block heights 759241 and 759251</summary>\r\n\r\n```\r\nBetween block heights 759241 and 759251:                                                  \r\n    - The average percentage of transactions with a descendant in the same block is 12.82089552238806%\r\n    - The average percentage of transactions with an ancestor in the same block is 13.124378109452737%\r\n    - The highest percentage of transactions with a descendant in the same block is 25.75250836120401\r\n    - The highest percentage of transactions with an ancestor in the same block is 23.076923076923077\r\n    - The lowest percentage of transactions with a descendant in the same block is 4.3478260869565215\r\n    - The lowest percentage of transactions with an ancestor in the same block is 4.3478260869565215\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>Between block heights 659241 and 659251</summary>\r\n\r\n```\r\nBetween block heights 659241 and 659251:\r\n    - The average percentage of transactions with a descendant in the same block is 13.264294370386692%\r\n    - The average percentage of transactions with an ancestor in the same block is 13.80412030406522%\r\n    - The highest percentage of transactions with a descendant in the same block is 18.257956448911223\r\n    - The highest percentage of transactions with an ancestor in the same block is 17.75544388609715\r\n    - The lowest percentage of transactions with a descendant in the same block is 9.807767752059632\r\n    - The lowest percentage of transactions with an ancestor in the same block is 10.6553911205074\r\n```\r\n\r\n</details>\r\n\r\nThis data is interesting, and IMO relevant, but it's missing one crucial thing in the context of this PR: the percentage of transactions with descendant(s) in the same block *among fee estimation candidates*. I'm working on adding this now.",
      "created_at" : "2023-07-18T15:50:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1640493242",
      "id" : 1640493242,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585hx_C6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1640493242/reactions"
      },
      "updated_at" : "2023-07-18T15:50:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1640493242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Here are the results for a few block ranges with the percentage of candidates for fee estimation among all transactions, and the percentage of CPFP among these candidates. It's around 10%.\r\n\r\n<details>\r\n\r\n<summary>Between block heights 798241 and 798251</summary>\r\n\r\n```\r\nBetween block heights 798241 and 798251:\r\n    - The average percentage of transactions with a descendant in the same block is 8.198356016709338%\r\n    - The average percentage of transactions with an ancestor in the same block is 16.332030723622154%\r\n    - The highest percentage of transactions with a descendant in the same block is 17.461263408820024%\r\n    - The highest percentage of transactions with an ancestor in the same block is 28.820545339251748%\r\n    - The lowest percentage of transactions with a descendant in the same block is 1.0730593607305936%\r\n    - The lowest percentage of transactions with an ancestor in the same block is 3.881278538812785%\r\n    - The average percentage of transactions in a block that would be considered for fee estimation is 83.66796927637785%\r\n    - The average percentage of transactions with a descendant in the same block among candidates is 6.22644548236431%\r\n```\r\n\r\n</details>\r\n\r\n\r\n<details>\r\n\r\n<summary>Between block heights 797241 and 797251</summary>\r\n\r\n```\r\nBetween block heights 797241 and 797251:\r\n    - The average percentage of transactions with a descendant in the same block is 22.226875865846193%\r\n    - The average percentage of transactions with an ancestor in the same block is 40.3943426012436%\r\n    - The highest percentage of transactions with a descendant in the same block is 35.889395667046756%\r\n    - The highest percentage of transactions with an ancestor in the same block is 59.27003438243851%\r\n    - The lowest percentage of transactions with a descendant in the same block is 11.915269196822594%\r\n    - The lowest percentage of transactions with an ancestor in the same block is 14.298323036187114%\r\n    - The average percentage of transactions in a block that would be considered for fee estimation is 59.60565739875641%\r\n    - The average percentage of transactions with a descendant in the same block among candidates is 13.410085941300471%\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>Between block heights 796241 and 796251</summary>\r\n\r\n```\r\nBetween block heights 796241 and 796251:\r\n    - The average percentage of transactions with a descendant in the same block is 6.943150046598323%\r\n    - The average percentage of transactions with an ancestor in the same block is 17.707362534948743%\r\n    - The highest percentage of transactions with a descendant in the same block is 20.015729453401494%\r\n    - The highest percentage of transactions with an ancestor in the same block is 44.85330681253108%\r\n    - The lowest percentage of transactions with a descendant in the same block is 0.5854372484449323%\r\n    - The lowest percentage of transactions with an ancestor in the same block is 0.7318123116659492%\r\n    - The average percentage of transactions in a block that would be considered for fee estimation is 82.29263746505126%\r\n    - The average percentage of transactions with a descendant in the same block among candidates is 5.309439744187596%\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>Between block heights 756241 and 756251</summary>\r\n\r\n```\r\nBetween block heights 756241 and 756251:\r\n    - The average percentage of transactions with a descendant in the same block is 14.151887221464301%\r\n    - The average percentage of transactions with an ancestor in the same block is 14.502046384720327%\r\n    - The highest percentage of transactions with a descendant in the same block is 23.841059602649008%\r\n    - The highest percentage of transactions with an ancestor in the same block is 25.57552822453485%\r\n    - The lowest percentage of transactions with a descendant in the same block is 5.805038335158817%\r\n    - The lowest percentage of transactions with an ancestor in the same block is 5.914567360350493%\r\n    - The average percentage of transactions in a block that would be considered for fee estimation is 85.49795361527967%\r\n    - The average percentage of transactions with a descendant in the same block among candidates is 9.845220998883038%\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n\r\n<summary>Between block heights 656241 and 656251</summary>\r\n\r\n```\r\nBetween block heights 656241 and 656251:\r\n    - The average percentage of transactions with a descendant in the same block is 19.724950884086446%\r\n    - The average percentage of transactions with an ancestor in the same block is 19.51277013752456%\r\n    - The highest percentage of transactions with a descendant in the same block is 33.03791235844412%\r\n    - The highest percentage of transactions with an ancestor in the same block is 32.890201870999505%\r\n    - The lowest percentage of transactions with a descendant in the same block is 2.5210084033613445%\r\n    - The lowest percentage of transactions with an ancestor in the same block is 2.5210084033613445%\r\n    - The average percentage of transactions in a block that would be considered for fee estimation is 80.48722986247544%\r\n    - The average percentage of transactions with a descendant in the same block among candidates is 10.447178285491116%\r\n```\r\n\r\n</details>",
      "created_at" : "2023-07-18T16:34:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1640560703",
      "id" : 1640560703,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585hyPg_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1640560703/reactions"
      },
      "updated_at" : "2023-07-18T16:34:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1640560703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.\r\n\r\n--- \r\n\r\nAlso optimized my script a bit and ran it over a longer period (through May and June of this year, which was marked with pretty high fees and usage):\r\n```\r\nBetween block heights 788250 and 796890:\r\n    - The average percentage of transactions with a descendant in the same block is 14.775036605051687%\r\n    - The average percentage of transactions with an ancestor in the same block is 32.52518731543957%\r\n    - The highest percentage of transactions with a descendant in the same block is 58.61574323112785%\r\n    - The highest percentage of transactions with an ancestor in the same block is 87.25593113583876%\r\n    - The lowest percentage of transactions with a descendant in the same block is 0.07524454477050413%\r\n    - The lowest percentage of transactions with an ancestor in the same block is 0.07524454477050413%\r\n    - The average percentage of transactions in a block that would be considered for fee estimation is 67.47481268456043%\r\n    - The average percentage of transactions with a descendant in the same block among candidates is 13.464749562330006%\r\n```",
      "created_at" : "2023-07-18T18:33:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1640745025",
      "id" : 1640745025,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585hy8hB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1640745025/reactions"
      },
      "updated_at" : "2023-07-18T18:35:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1640745025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@darosior thanks for the data! The proportion of transactions with descendants seems pretty high, so my comment about ignoring stuff with descendants is probably not a good idea.",
      "created_at" : "2023-08-01T13:05:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1660272298",
      "id" : 1660272298,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585i9b6q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1660272298/reactions"
      },
      "updated_at" : "2023-08-01T13:05:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1660272298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Please correct me if I am wrong on this.\r\n\r\nThe `CBlockPolicyEstimator` is not package aware, Some transactions that are recorded in the fee statistics as confirmed, with their actual fee rate shouldn't be.\r\nTheir child may pay for their inclusion in the block, we should record the child as confirmed with its ancestor score instead.\r\n\r\n- The fee estimator does not take into account transactions that have a parent in the mempool.\r\n\r\nThat means we are not just disregarding a some amount of fee rate statistics (all transactions with in mempool parent), We are tracking the stat with inaccurate feerate.\r\n\r\nThis PR is trying to ensure that the ancestors of a transaction that is assumed to be CPFP should not be recorded in the fee estimator statistics as confirmed. \r\n\r\nIf CPFP adoption continues to increase, the data that `CBlockPolicyEstimator` will have for fee estimation will be reduced drastically, which might potentially result in the fee estimator giving us a high fee estimate or some unexpected fee rate,  because we don't have the right amount of data.\r\n\r\nOn Master e25af11225d9d94ecf7068bf7a9a359268786fbe `CBlockPolicyEstimator` updates from mempool every time a new block is connected, Instead of mempool `cs` being blocked only on mempool transaction removal, we were blocking on both transaction removals and fee estimator updating.\r\n\r\nIf we want to further improve fee estimation e.g. opting into the approach in [#23074 comment](https://github.com/bitcoin/bitcoin/pull/23074#pullrequestreview-764375424) or add heavy-calculation steps to `CBlockPolicyEstimator`, it might not be viable as we would be slowing down block relay in the process.\r\n\r\nWith this [#28368](https://github.com/bitcoin/bitcoin/pull/28368) we can now conveniently do that and try to add transactions to the fee estimator by ancestor feerate using [#23074 comment](https://github.com/bitcoin/bitcoin/pull/23074#pullrequestreview-764375424) approach or similar.\r\nIâve started looking at that and drafted a [gist](https://gist.github.com/ismaelsadeeq/ddf6a1f990fe6cf15f3557ddda333c7f) on how that will look like.\r\nI would like to know what you think @darosior @glozow.\r\n\r\nIdk why @DrahdBot did not update but this PR conflicts with [#28368](https://github.com/bitcoin/bitcoin/pull/28368)  as updating the fee estimator from the new interface does not have details to detect the heuristic in this PR.",
      "created_at" : "2023-09-10T10:57:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1712782167",
      "id" : 1712782167,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585mFvtX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1712782167/reactions"
      },
      "updated_at" : "2023-09-10T10:57:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1712782167",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> This PR is trying to ensure that the ancestors of a transaction that is assumed to be CPFP should not be recorded in the fee estimator statistics as confirmed.\r\n\r\nThe intent of this PR is to prevent a transaction tracked in the fee estimator to be assumed as being mined thanks to solely its own feerate when it's not. Technically it's equivalent to what you describe.\r\n\r\n> If CPFP adoption continues to increase, the data that `CBlockPolicyEstimator` will have for fee estimation will be reduced drastically, which might potentially result in the fee estimator giving us a high fee estimate or some unexpected fee rate, because we don't have the right amount of data.\r\n\r\nThe fee estimator would fail if it doesn't have enough data points to give a reasonable estimation. Unfortunately right now in the situation you describe it would return an incorrectly low estimate instead for the reason mentioned above.\r\n\r\n> If we want to further improve fee estimation e.g. opting into the approach in https://github.com/bitcoin/bitcoin/pull/23074#pullrequestreview-764375424\r\n\r\nI'm skeptical we could improve the fee estimator to consider packages without a significant rewrite. The current algorithm tracks the time between arrival in our mempool and inclusion in a block. With a package you don't have a single arrival time anymore. And it's unclear how a replacement of part of the package would affect our estimates.\r\n\r\nHere is an example. A 4-txs package with a 10sats/vb feerate arrives at block height `n`. At block height `n+2` we get a fifth transaction, bumping the feerate to 12sats/vb. At `n+8` 3 of the transactions get replaced, the package feerate is bumped to 14sats/vb and included at block `n+9`. It's not clear how we would analyze this situation in the current framework.\r\n\r\nThere is certainly an argument for restricting ourselves to certain kinds of packages, or to packages that are relayed once (assuming package relay otherwise it's still more complex) and never change. This way we could adapt our fee estimation framework to what's being used on the network and maybe adapt it as usage patterns change.\r\n\r\nTo be fair this seems to me closer to a research project than something we could implement anytime soon, but maybe i'm overly pessimistic.",
      "created_at" : "2023-09-11T08:35:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1713423973",
      "id" : 1713423973,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585mIMZl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1713423973/reactions"
      },
      "updated_at" : "2023-09-11T08:35:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1713423973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Idk why @DrahdBot did not update but this PR conflicts with https://github.com/bitcoin/bitcoin/pull/28368\r\n\r\nDrahtBot doesn't detect silent merge conflicts afaik. But yeah, this PR uses the vector of entries to detect cpfp-ness in `processBlock` and those entries would be gone if the fee estimator updates in the background. I think we'd probably want to resolve that by making copies of the information the fee estimator needs.\r\n\r\n>> If we want to further improve fee estimation e.g. opting into the approach in https://github.com/bitcoin/bitcoin/pull/23074#pullrequestreview-764375424\r\n\r\n> I'm skeptical we could improve the fee estimator to consider packages without a significant rewrite.\r\n\r\nI agree I don't see any simple solution for package-aware fee estimation... fwiw I was just brainstorming in that comment and it has many of the same inaccuracy problems. Perhaps with cluster mempool, we can notify the fee estimator each time a transaction's miner score changes (which is a lot of signals but should encompass package-aware scores + timing)?\r\n\r\nI think this PR is the right thing to do for now.",
      "created_at" : "2023-09-11T09:28:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25380#issuecomment-1713512238",
      "id" : 1713512238,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25380",
      "node_id" : "IC_kwDOABII585mIh8u",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1713512238/reactions"
      },
      "updated_at" : "2023-09-11T09:28:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1713512238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   }
]
