[
   {
      "author_association" : "MEMBER",
      "body" : "Even when the peer sent the `headers` message, the block filter index could still be processing the block signals.\r\nIf possible on your tests, call `syncwithvalidationinterfacequeue` to empty the validation interface queue prior requesting the `cfheader` or, could also do it right after generating the block/s, so you ensure that the index processes the events.",
      "created_at" : "2023-02-11T17:48:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27085#issuecomment-1426836560",
      "id" : 1426836560,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27085",
      "node_id" : "IC_kwDOABII585VC8xQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1426836560/reactions"
      },
      "updated_at" : "2023-02-11T17:53:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1426836560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for pointing me in the right direction, this seems to be the equivalent in the bitcoin core python test harness https://github.com/bitcoin/bitcoin/pull/22311 . I'll patch with this on bitcoin-s and close this issue after i've verifed this is the appropriate fix.",
      "created_at" : "2023-02-11T18:25:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27085#issuecomment-1426845565",
      "id" : 1426845565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27085",
      "node_id" : "IC_kwDOABII585VC-99",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1426845565/reactions"
      },
      "updated_at" : "2023-02-11T18:25:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1426845565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3514957?v=4",
         "events_url" : "https://api.github.com/users/Christewart/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Christewart/followers",
         "following_url" : "https://api.github.com/users/Christewart/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Christewart/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Christewart",
         "id" : 3514957,
         "login" : "Christewart",
         "node_id" : "MDQ6VXNlcjM1MTQ5NTc=",
         "organizations_url" : "https://api.github.com/users/Christewart/orgs",
         "received_events_url" : "https://api.github.com/users/Christewart/received_events",
         "repos_url" : "https://api.github.com/users/Christewart/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Christewart/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Christewart/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Christewart"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This still seems to be an issue on 24.2 . I'm going to try and upgrade my nodes used for test harnesses in to use 25.x and 26.x. From a quick look through release notes, it doesn't seem like there was anything in those releases that would fix this bug. \r\n\r\nNote, i am calling `syncwithvalidationinterfacequeue` explicitly after generating blocks on regtest and waiting for that rpc call to complete before continuing with testing logic. This doesn't seem to happen as much on slower machines (x86_64), but on apple silicon it seems fairly reproducible.\r\n\r\n```\r\n2024-01-05T16:33:18Z [net] received getdata for: witness-block 5a62c32fe94767a36ed71048301e21276fbb2de6a9a392bcc4fb51571fc910fb peer=9\r\n2024-01-05T16:33:18Z [net] sending block (250 bytes) peer=9\r\n2024-01-05T16:33:18Z [net] received: getcfheaders (37 bytes) peer=9\r\n2024-01-05T16:33:18Z [net] Failed to find block filter hashes in index: filter_type=basic, start_height=209, stop_hash=2765372306e3a828a72ec307057fcc1885a1600d14087b5729020e8c8a99a8a8\r\n2024-01-05T16:33:18Z [default wallet] AddToWallet d78a57f4bf12014a12da2d1914b9fcc69277d7b4ae738a30e8cc18cdc282d7f5  new\r\n2024-01-05T16:33:18Z [validation] UpdatedBlockTip: new block hash=6b067436661a30cea95eaf93664cc9a2723372c272e80bcb97eeb2330895aecd fork block hash=5a62c32fe94767a36ed71048301e21276fbb2de6a9a392bcc4fb51571fc910fb (in IBD=false)\r\n2024-01-05T16:33:18Z [zmq] Publish hashblock 6b067436661a30cea95eaf93664cc9a2723372c272e80bcb97eeb2330895aecd to tcp://0.0.0.0:27298\r\n2024-01-05T16:33:18Z [zmq] Publish rawblock 6b067436661a30cea95eaf93664cc9a2723372c272e80bcb97eeb2330895aecd to tcp://0.0.0.0:44946\r\n2024-01-05T16:33:18Z [validation] BlockConnected: block hash=60cef82e330f20ee10402d8ec33a6dc6547063711e88c9a354cf0b4da50f4a64 block height=211\r\n2024-01-05T16:33:18Z [zmq] Publish hashtx 8606ba3634d0e87a962e0517635e8e723a57e18c7cb11a0706407c786afc50d3 to tcp://0.0.0.0:37406\r\n2024-01-05T16:33:18Z [zmq] Publish rawtx 8606ba3634d0e87a962e0517635e8e723a57e18c7cb11a0706407c786afc50d3 to tcp://0.0.0.0:31111\r\n2024-01-05T16:33:18Z [leveldb] WriteBatch memory usage: db=txindex, before=0.0MiB, after=0.0MiB\r\n2024-01-05T16:33:18Z [leveldb] WriteBatch memory usage: db=db, before=0.0MiB, after=0.0MiB\r\n2024-01-05T16:33:18Z [default wallet] AddToWallet 8606ba3634d0e87a962e0517635e8e723a57e18c7cb11a0706407c786afc50d3  new\r\n2024-01-05T16:33:18Z [validation] UpdatedBlockTip: new block hash=60cef82e330f20ee10402d8ec33a6dc6547063711e88c9a354cf0b4da50f4a64 fork block hash=6b067436661a30cea95eaf93664cc9a2723372c272e80bcb97eeb2330895aecd (in IBD=false)\r\n2024-01-05T16:33:18Z [zmq] Publish hashblock 60cef82e330f20ee10402d8ec33a6dc6547063711e88c9a354cf0b4da50f4a64 to tcp://0.0.0.0:27298\r\n2024-01-05T16:33:18Z [zmq] Publish rawblock 60cef82e330f20ee10402d8ec33a6dc6547063711e88c9a354cf0b4da50f4a64 to tcp://0.0.0.0:44946\r\n2024-01-05T16:33:18Z [validation] BlockConnected: block hash=2765372306e3a828a72ec307057fcc1885a1600d14087b5729020e8c8a99a8a8 block height=212\r\n2024-01-05T16:33:18Z [zmq] Publish hashtx 36038c1828cd2ea7d2b3432364fa480cd0bdfbaaabf06784668cd8fbc4d67da7 to tcp://0.0.0.0:37406\r\n2024-01-05T16:33:18Z [zmq] Publish rawtx 36038c1828cd2ea7d2b3432364fa480cd0bdfbaaabf06784668cd8fbc4d67da7 to tcp://0.0.0.0:31111\r\n2024-01-05T16:33:18Z [leveldb] WriteBatch memory usage: db=txindex, before=0.0MiB, after=0.0MiB\r\n2024-01-05T16:33:18Z [leveldb] WriteBatch memory usage: db=db, before=0.0MiB, after=0.0MiB\r\n2024-01-05T16:33:18Z [default wallet] AddToWallet 36038c1828cd2ea7d2b3432364fa480cd0bdfbaaabf06784668cd8fbc4d67da7  new\r\n2024-01-05T16:33:18Z [validation] UpdatedBlockTip: new block hash=2765372306e3a828a72ec307057fcc1885a1600d14087b5729020e8c8a99a8a8 fork block hash=60cef82e330f20ee10402d8ec33a6dc6547063711e88c9a354cf0b4da50f4a64 (in IBD=false)\r\n2024-01-05T16:33:18Z [zmq] Publish hashblock 2765372306e3a828a72ec307057fcc1885a1600d14087b5729020e8c8a99a8a8 to tcp://0.0.0.0:27298\r\n```",
      "created_at" : "2024-01-05T16:30:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27085#issuecomment-1878945351",
      "id" : 1878945351,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27085",
      "node_id" : "IC_kwDOABII585v_m5H",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1878945351/reactions"
      },
      "updated_at" : "2024-01-05T16:59:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1878945351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3514957?v=4",
         "events_url" : "https://api.github.com/users/Christewart/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Christewart/followers",
         "following_url" : "https://api.github.com/users/Christewart/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Christewart/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Christewart",
         "id" : 3514957,
         "login" : "Christewart",
         "node_id" : "MDQ6VXNlcjM1MTQ5NTc=",
         "organizations_url" : "https://api.github.com/users/Christewart/orgs",
         "received_events_url" : "https://api.github.com/users/Christewart/received_events",
         "repos_url" : "https://api.github.com/users/Christewart/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Christewart/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Christewart/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Christewart"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Note, i am not calling `syncwithvalidationinterfacequeue` explicitly\r\n\r\nAt least one of the following must happen, otherwise this bug will remain, obviously:\r\n\r\n* Call `syncwithvalidationinterfacequeue` to produce the compact filter prior to requesting it, to ensure arrival\r\n* Request the compact filter in a loop (busy polling) until it arrives\r\n* Change the code to `syncwithvalidationinterfacequeue` before answering compact filter requests. (This would be my preference, but there was a previous discussion, which I can't find right now)",
      "created_at" : "2024-01-05T16:47:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27085#issuecomment-1878968120",
      "id" : 1878968120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27085",
      "node_id" : "IC_kwDOABII585v_sc4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1878968120/reactions"
      },
      "updated_at" : "2024-01-05T16:47:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1878968120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   }
]
