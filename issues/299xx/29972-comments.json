[
   {
      "author_association" : "MEMBER",
      "body" : "Yes, this happens if you try to run any of the CI tasks locally in a worktree.",
      "created_at" : "2024-04-26T16:06:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29972#issuecomment-2079680643",
      "id" : 2079680643,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29972",
      "node_id" : "IC_kwDOABII58579WiD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2079680643/reactions"
      },
      "updated_at" : "2024-04-26T16:06:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2079680643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "i think the root problem here is that docker only provides access to the source directory to the container, and a worktree isn't self-contained, it contains a path to the actual repository the worktree comes from, which won't be available there. The linters need access to git metadata to do their checks (for example, to make sure that they only check files in git, not generated ones).",
      "created_at" : "2024-04-27T08:25:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29972#issuecomment-2080415116",
      "id" : 2080415116,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29972",
      "node_id" : "IC_kwDOABII5858AJ2M",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2080415116/reactions"
      },
      "updated_at" : "2024-04-27T08:25:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2080415116",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Yes, this happens if you try to run any of the CI tasks locally in a worktree.\r\n\r\nAt least for the \"real\" CI tasks, we should consider making a fallback, as I don't think much from git is needed? So far I could only find `git log -1` in `ci/test/`, but that should work in a worktree, no?",
      "created_at" : "2024-04-27T08:51:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29972#issuecomment-2080420581",
      "id" : 2080420581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29972",
      "node_id" : "IC_kwDOABII5858ALLl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2080420581/reactions"
      },
      "updated_at" : "2024-04-27T08:51:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2080420581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  but that should work in a worktree, no?\r\n\r\nAll git commands work in a worktree, but not when it is seperated from its main repository by containers.",
      "created_at" : "2024-04-27T08:57:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29972#issuecomment-2080422077",
      "id" : 2080422077,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29972",
      "node_id" : "IC_kwDOABII5858ALi9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2080422077/reactions"
      },
      "updated_at" : "2024-04-27T08:57:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2080422077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I can't reproduce that error:\r\n```\r\nbitcoin on î  exec/worktree via ð v3.8.18 via âï¸   impure (btc)\r\nâ¯ DOCKER_BUILDKIT=1 docker build -t bitcoin-linter --file \"./ci/lint_imagefile\" ./ && docker run --rm -v $(pwd):/bitcoin -it bitcoin-linter\r\n[+] Building 3.4s (12/12) FINISHED                                                                                                                                    docker:default\r\n => [internal] load build definition from lint_imagefile                                                                                                                        0.0s\r\n => => transferring dockerfile: 708B                                                                                                                                            0.0s\r\n => [internal] load .dockerignore                                                                                                                                               0.0s\r\n => => transferring context: 2B                                                                                                                                                 0.0s\r\n => [internal] load metadata for docker.io/library/debian:bookworm                                                                                                              3.4s\r\n => [1/7] FROM docker.io/library/debian:bookworm@sha256:1aadfee8d292f64b045adb830f8a58bfacc15789ae5f489a0fedcd517a862cb9                                                        0.0s\r\n => [internal] load build context                                                                                                                                               0.0s\r\n => => transferring context: 473B                                                                                                                                               0.0s\r\n => CACHED [2/7] COPY ./.python-version /.python-version                                                                                                                        0.0s\r\n => CACHED [3/7] COPY ./ci/lint/container-entrypoint.sh /entrypoint.sh                                                                                                          0.0s\r\n => CACHED [4/7] COPY ./ci/lint/04_install.sh /install.sh                                                                                                                       0.0s\r\n => CACHED [5/7] COPY ./test/lint/test_runner /test/lint/test_runner                                                                                                            0.0s\r\n => CACHED [6/7] RUN /install.sh &&   echo 'alias lint=\"./ci/lint/06_script.sh\"' >> ~/.bashrc &&   chmod 755 /entrypoint.sh &&   rm -rf /var/lib/apt/lists/*                    0.0s\r\n => CACHED [7/7] WORKDIR /bitcoin                                                                                                                                               0.0s\r\n => exporting to image                                                                                                                                                          0.0s\r\n => => exporting layers                                                                                                                                                         0.0s\r\n => => writing image sha256:f1751706ad3a59a294be4c368f55e034b440840a6a892bcc84890ca31417d273                                                                                    0.0s\r\n => => naming to docker.io/library/bitcoin-linter                                                                                                                               0.0s\r\n+ '[' -n '' ']'\r\n++ git rev-list --max-count=1 --merges HEAD\r\n+ COMMIT_RANGE=3aaf7328eb656b642e5f0f74f3e4d51645a1d0ab..HEAD\r\n+ export COMMIT_RANGE\r\n+ echo\r\n\r\n+ git log --no-merges --oneline 3aaf7328eb656b642e5f0f74f3e4d51645a1d0ab..HEAD\r\n+ echo\r\n\r\n+ test/lint/commit-script-check.sh 3aaf7328eb656b642e5f0f74f3e4d51645a1d0ab..HEAD\r\n+ RUST_BACKTRACE=1\r\n+ /lint_test_runner/test_runner\r\nsrc/crc32c in HEAD currently refers to tree 454691a9b89ee8b9e1f71a48a7398edba49c3805\r\nsrc/crc32c in HEAD was last updated in commit 5d45552fd4303f8d668ffbc50cce1053485aeead (tree 454691a9b89ee8b9e1f71a48a7398edba49c3805)\r\nGOOD\r\nsrc/crypto/ctaes in HEAD currently refers to tree 1b6c31139a71f80245c09597c343936a8e41d021\r\nsrc/crypto/ctaes in HEAD was last updated in commit 8501bedd7508ac514385806e191aec21ee978891 (tree 1b6c31139a71f80245c09597c343936a8e41d021)\r\nGOOD\r\nsrc/leveldb in HEAD currently refers to tree bd49d3c60051c1a8d8f030fa4ba7a29237fe7479\r\nsrc/leveldb in HEAD was last updated in commit 1a463c70a368fb20316e03efac273438cf47baa3 (tree bd49d3c60051c1a8d8f030fa4ba7a29237fe7479)\r\nGOOD\r\nsrc/minisketch in HEAD currently refers to tree a584efdc3ab5184a004807db66381c5c482e5f41\r\nsrc/minisketch in HEAD was last updated in commit 1eea10a6d25fd8225560347cda2b1cfdc267910d (tree a584efdc3ab5184a004807db66381c5c482e5f41)\r\nGOOD\r\nsrc/secp256k1 in HEAD currently refers to tree c3c4db9c0e4636135963272b005b11a451303feb\r\nsrc/secp256k1 in HEAD was last updated in commit 53eec53dca1cb677d11564b055d3b8581ddd6747 (tree c3c4db9c0e4636135963272b005b11a451303feb)\r\nGOOD\r\nArgs used        : 210\r\nArgs documented  : 222\r\nArgs undocumented: 0\r\nset()\r\nArgs unknown     : 12\r\n{'-zmqpubhashtx', '-zmqpubrawtx', '-zmqpubsequence', '-zmqpubhashblockhwm', '-zmqpubrawblock', '-testdatadir', '-zmqpubhashblock', '-zmqpubsequencehwm', '-zmqpubhashtxhwm', '-includeconf', '-zmqpubrawblockhwm', '-zmqpubrawtxhwm'}\r\nSuccess: no issues found in 292 source files\r\n+ '[' '' = bitcoin/bitcoin ']'\r\nbitcoin on î  exec/worktree via ð v3.8.18 via âï¸   impure (btc) took 23s\r\nâ¯ pwd\r\n/home/exec/Projects/github.com/bitcoin/bitcoin\r\nbitcoin on î  exec/worktree via ð v3.8.18 via âï¸   impure (btc)\r\nâ¯ git status\r\nOn branch exec/worktree\r\nChanges not staged for commit:\r\n  (use \"git add <file>...\" to update what will be committed)\r\n  (use \"git restore <file>...\" to discard changes in working directory)\r\n        modified:   src/addrdb.cpp\r\n\r\nno changes added to commit (use \"git add\" and/or \"git commit -a\")\r\n\r\n```",
      "created_at" : "2024-04-28T14:17:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29972#issuecomment-2081499778",
      "id" : 2081499778,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29972",
      "node_id" : "IC_kwDOABII5858ESqC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081499778/reactions"
      },
      "updated_at" : "2024-04-28T14:17:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081499778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/46400566?v=4",
         "events_url" : "https://api.github.com/users/eval-exec/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eval-exec/followers",
         "following_url" : "https://api.github.com/users/eval-exec/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eval-exec/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eval-exec",
         "id" : 46400566,
         "login" : "eval-exec",
         "node_id" : "MDQ6VXNlcjQ2NDAwNTY2",
         "organizations_url" : "https://api.github.com/users/eval-exec/orgs",
         "received_events_url" : "https://api.github.com/users/eval-exec/received_events",
         "repos_url" : "https://api.github.com/users/eval-exec/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eval-exec/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eval-exec/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eval-exec"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "On closer inspection, this seems to end up writing some files as root in the mypy_cache dire worktree which is not ideal as it means the worktree can't be deleted in the usual way.\r\n\r\n~~I think it _can_ be done, although it's quite hacky:~~\r\n\r\n```bash\r\nDOCKER_BUILDKIT=1 docker build -t bitcoin-linter --file \"./ci/lint_imagefile\" ./ && GIT_DIR=$(git rev-parse --path-format=absolute --git-common-dir) docker run --rm -v $(pwd):/bitcoin -v \"$GIT_DIR\":\"$GIT_DIR\" -it bitcoin-linter\r\n```\r\n\r\n~~This mounts the external (real) `.git` directory (which is a symlink in the worktree, and not possible to follow from inside of the container) to the same location inside of the container, making the symlink work again. The mount is not quite perfect and could perhaps be refined, but `git` does not seem to mind.~~\r\n\r\nI don't think it will be possible to support worktrees in a less hacky way with the container, so the other option is to activate a python (v)env with required deps + shellcheck, and run the test-runner manually in the worktree with e.g.:\r\n\r\n```bash\r\ncd test/lint/test_runner\r\nCOMMIT_RANGE=\"$( git rev-list --max-count=1 --merges HEAD )..HEAD\" cargo run\r\n```",
      "created_at" : "2024-05-02T21:04:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29972#issuecomment-2091588721",
      "id" : 2091588721,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29972",
      "node_id" : "IC_kwDOABII5858qxxx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2091588721/reactions"
      },
      "updated_at" : "2024-05-02T21:25:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2091588721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Update:\r\n\r\nTo avoid creating root-owned mypy files you can run the container with your user:group specified:\r\n\r\n```bash\r\nDOCKER_BUILDKIT=1 docker build -t bitcoin-linter --file \"./ci/lint_imagefile\" ./ && GIT_DIR=$(git rev-parse --path-format=absolute --git-common-dir) docker run --rm -v $(pwd):/bitcoin -v \"$GIT_DIR\":\"$GIT_DIR\" -u $(id -u):$(id -g) -it bitcoin-linter\r\n```\r\n\r\nThis allows `git worktree remove` to succeed.",
      "created_at" : "2024-05-03T07:51:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29972#issuecomment-2092489093",
      "id" : 2092489093,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29972",
      "node_id" : "IC_kwDOABII5858uNmF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2092489093/reactions"
      },
      "updated_at" : "2024-05-03T07:51:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2092489093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   }
]
