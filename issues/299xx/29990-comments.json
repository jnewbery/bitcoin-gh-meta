[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29990).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [maflcko](https://github.com/bitcoin/bitcoin/pull/29990#pullrequestreview-2027780727) |\n| Concept ACK | [brunoerg](https://github.com/bitcoin/bitcoin/pull/29990#issuecomment-2082585841) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2024-04-28T19:49:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29990#issuecomment-2081631714",
      "id" : 2081631714,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29990",
      "node_id" : "IC_kwDOABII5858Ey3i",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081631714/reactions"
      },
      "updated_at" : "2024-04-29T12:20:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081631714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I guess this isn't due to a fuzz crash, because the only thing that's off is `cachedInnerUsage` (and friends), which are not checked in this fuzz target?\r\n\r\nCorrect, I didn't see any fuzz crash on master, but this issue was leading to crashes in my cluster mempool branch, where the inconsistency manifested itself sooner.",
      "created_at" : "2024-04-29T09:13:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29990#issuecomment-2082230525",
      "id" : 2082230525,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29990",
      "node_id" : "IC_kwDOABII5858HFD9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2082230525/reactions"
      },
      "updated_at" : "2024-04-29T09:13:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2082230525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29990#discussion_r1582993565"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582993565"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Considering the purpose of fuzzing is to test the combination of valid states, shouldn't we include tests that involve sending duplicate transactions to the mempool?\r\n\r\nOr if that's irrelevant, since the proposed change affects how the `add_to_mempool` flag behaves, would it be more transparent to redefine it to directly reflect whether a transaction can be added to the mempool, i.e. `bool add_to_mempool = !pool.exists(GenTxid::Txid(tx->GetHash())) && fuzzed_data_provider.ConsumeBool();`?\r\n",
      "commit_id" : "cc15c5bfd1eb3903de246c124702a7c66c687008",
      "created_at" : "2024-04-29T12:15:33Z",
      "diff_hunk" : "@@ -72,7 +72,7 @@ FUZZ_TARGET(partially_downloaded_block, .init = initialize_pdb)\n             available.insert(i);\n         }\n \n-        if (add_to_mempool) {\n+        if (add_to_mempool && !pool.exists(GenTxid::Txid(tx->GetHash()))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29990#discussion_r1582993565",
      "id" : 1582993565,
      "line" : 75,
      "node_id" : "PRRC_kwDOABII585eWpCd",
      "original_commit_id" : "cc15c5bfd1eb3903de246c124702a7c66c687008",
      "original_line" : 75,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/fuzz/partially_downloaded_block.cpp",
      "position" : 5,
      "pull_request_review_id" : 2028344704,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29990",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582993565/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T12:16:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582993565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2024-04-29T12:20:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29990#issuecomment-2082585841",
      "id" : 2082585841,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29990",
      "node_id" : "IC_kwDOABII5858Ibzx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2082585841/reactions"
      },
      "updated_at" : "2024-04-29T12:20:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2082585841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29990#discussion_r1583009692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583009692"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Considering the purpose of fuzzing is to test the combination of valid states, shouldn't we include tests that involve sending duplicate transactions to the mempool?\r\n\r\nIn this case, it is calling `addUnchecked` directly that's why it would be proper to check whether the transaction is in mempool before. Note that, in practice, this function is used in `MemPoolAccept::Finalize` which removes conflicting transactions from the mempool before adding.",
      "commit_id" : "cc15c5bfd1eb3903de246c124702a7c66c687008",
      "created_at" : "2024-04-29T12:27:07Z",
      "diff_hunk" : "@@ -72,7 +72,7 @@ FUZZ_TARGET(partially_downloaded_block, .init = initialize_pdb)\n             available.insert(i);\n         }\n \n-        if (add_to_mempool) {\n+        if (add_to_mempool && !pool.exists(GenTxid::Txid(tx->GetHash()))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29990#discussion_r1583009692",
      "id" : 1583009692,
      "in_reply_to_id" : 1582993565,
      "line" : 75,
      "node_id" : "PRRC_kwDOABII585eWs-c",
      "original_commit_id" : "cc15c5bfd1eb3903de246c124702a7c66c687008",
      "original_line" : 75,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/fuzz/partially_downloaded_block.cpp",
      "position" : 5,
      "pull_request_review_id" : 2028372713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29990",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583009692/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T12:27:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583009692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29990#discussion_r1583059571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583059571"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> In this case, it is calling addUnchecked directly that's why it would be proper to check whether the transaction is in mempool before. Note that, in practice, this function is used in MemPoolAccept::Finalize which removes conflicting transactions from the mempool before adding.\r\n\r\nYes exactly.  The correct interface for code that is doing no sanity checking would be `AcceptToMemoryPool()`. Since we're bypassing that in the fuzz tests, we should do something else to avoid putting the mempool into an inconsistent state.",
      "commit_id" : "cc15c5bfd1eb3903de246c124702a7c66c687008",
      "created_at" : "2024-04-29T13:06:16Z",
      "diff_hunk" : "@@ -72,7 +72,7 @@ FUZZ_TARGET(partially_downloaded_block, .init = initialize_pdb)\n             available.insert(i);\n         }\n \n-        if (add_to_mempool) {\n+        if (add_to_mempool && !pool.exists(GenTxid::Txid(tx->GetHash()))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29990#discussion_r1583059571",
      "id" : 1583059571,
      "in_reply_to_id" : 1582993565,
      "line" : 75,
      "node_id" : "PRRC_kwDOABII585eW5Jz",
      "original_commit_id" : "cc15c5bfd1eb3903de246c124702a7c66c687008",
      "original_line" : 75,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/fuzz/partially_downloaded_block.cpp",
      "position" : 5,
      "pull_request_review_id" : 2028462521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29990",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583059571/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T13:06:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583059571",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
