[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29996).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29681](https://github.com/bitcoin/bitcoin/pull/29681) (test: loading assumeutxo snapshot start states by BrandonOdiwuor)\n* [#29428](https://github.com/bitcoin/bitcoin/pull/29428) (test: Assumeutxo: snapshots with less work should not be loaded by hernanmarino)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-04-29T15:13:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2083008209",
      "id" : 2083008209,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5858KC7R",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083008209/reactions"
      },
      "updated_at" : "2024-04-29T18:58:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083008209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I splitted the original commit into two commits (one for each test). The second test (https://github.com/bitcoin/bitcoin/pull/29996/commits/af0f401258e0c189799a36f4487eaa751d779e7b) may be redundant with this one: https://github.com/bitcoin/bitcoin/pull/29428. The only difference is that my test is executed on a node that has a divergent chain after block 199. I did that to cover this scenario described in the comments\r\n\r\n `[...] Loading a snapshot when the current chain tip is: [...] Not an ancestor or a descendant of the snapshot block and has more work`\r\n \r\n If it's redundant I can delete the second commit. Thoughts?",
      "created_at" : "2024-04-30T19:25:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2086782948",
      "id" : 2086782948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5858Ycfk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2086782948/reactions"
      },
      "updated_at" : "2024-04-30T19:25:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2086782948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586967904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "instead of number `298` would it make more sense to use `SNAPSHOT_BASE_HEIGHT`?",
      "commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "created_at" : "2024-05-02T01:23:21Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert_equal(node.getblockcount(), 298)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586967904",
      "id" : 1586967904,
      "line" : 172,
      "node_id" : "PRRC_kwDOABII585elzVg",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 172,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 42,
      "pull_request_review_id" : 2034676796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T01:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586968840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "is this not the same as `START_HEIGHT`?",
      "commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "created_at" : "2024-05-02T01:25:20Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586968840",
      "id" : 1586968840,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII585elzkI",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 155,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 25,
      "pull_request_review_id" : 2034676796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T01:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586972804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        block_hash = node.getblockhash(START_HEIGHT + 1)\r\n        node.invalidateblock(block_hash)\r\n        assert_equal(node.getblockcount(), START_HEIGHT)\r\n```",
      "commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "created_at" : "2024-05-02T01:34:42Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586972804",
      "id" : 1586972804,
      "line" : 159,
      "node_id" : "PRRC_kwDOABII585el0iE",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 159,
      "original_position" : 29,
      "original_start_line" : 156,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 29,
      "pull_request_review_id" : 2034676796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 156,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T01:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   }
]
