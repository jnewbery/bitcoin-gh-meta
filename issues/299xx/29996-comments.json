[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29996).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [rkrux](https://github.com/bitcoin/bitcoin/pull/29996#pullrequestreview-2045600755) |\n| Concept ACK | [naiyoma](https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2087518282) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30053](https://github.com/bitcoin/bitcoin/pull/30053) (test: added test coverage to loadtxoutset could not open file by kevkevinpal)\n* [#29681](https://github.com/bitcoin/bitcoin/pull/29681) (test: loading assumeutxo snapshot start states by BrandonOdiwuor)\n* [#29428](https://github.com/bitcoin/bitcoin/pull/29428) (test: Assumeutxo: snapshots with less work should not be loaded by hernanmarino)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-04-29T15:13:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2083008209",
      "id" : 2083008209,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5858KC7R",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083008209/reactions"
      },
      "updated_at" : "2024-05-08T13:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083008209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I splitted the original commit into two commits (one for each test). The second test (https://github.com/bitcoin/bitcoin/pull/29996/commits/af0f401258e0c189799a36f4487eaa751d779e7b) may be redundant with this one: https://github.com/bitcoin/bitcoin/pull/29428. The only difference is that my test is executed on a node that has a divergent chain after block 199. I did that to cover this scenario described in the comments\r\n\r\n `[...] Loading a snapshot when the current chain tip is: [...] Not an ancestor or a descendant of the snapshot block and has more work`\r\n \r\n If it's redundant I can delete the second commit. Thoughts?",
      "created_at" : "2024-04-30T19:25:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2086782948",
      "id" : 2086782948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5858Ycfk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2086782948/reactions"
      },
      "updated_at" : "2024-04-30T19:25:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2086782948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, covers more tests scenarios for AssumeUTXO\r\n",
      "created_at" : "2024-04-30T22:05:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2087518282",
      "id" : 2087518282,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5858bQBK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2087518282/reactions"
      },
      "updated_at" : "2024-04-30T22:05:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2087518282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/40592031?v=4",
         "events_url" : "https://api.github.com/users/naiyoma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naiyoma/followers",
         "following_url" : "https://api.github.com/users/naiyoma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naiyoma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naiyoma",
         "id" : 40592031,
         "login" : "naiyoma",
         "node_id" : "MDQ6VXNlcjQwNTkyMDMx",
         "organizations_url" : "https://api.github.com/users/naiyoma/orgs",
         "received_events_url" : "https://api.github.com/users/naiyoma/received_events",
         "repos_url" : "https://api.github.com/users/naiyoma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naiyoma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naiyoma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naiyoma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586967904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "instead of number `298` would it make more sense to use `SNAPSHOT_BASE_HEIGHT`?",
      "commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "created_at" : "2024-05-02T01:23:21Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert_equal(node.getblockcount(), 298)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586967904",
      "id" : 1586967904,
      "line" : 172,
      "node_id" : "PRRC_kwDOABII585elzVg",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 172,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 42,
      "pull_request_review_id" : 2034676796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T01:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586968840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "is this not the same as `START_HEIGHT`?",
      "commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "created_at" : "2024-05-02T01:25:20Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586968840",
      "id" : 1586968840,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII585elzkI",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 155,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 25,
      "pull_request_review_id" : 2034676796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T01:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586972804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        block_hash = node.getblockhash(START_HEIGHT + 1)\r\n        node.invalidateblock(block_hash)\r\n        assert_equal(node.getblockcount(), START_HEIGHT)\r\n```",
      "commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "created_at" : "2024-05-02T01:34:42Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586972804",
      "id" : 1586972804,
      "line" : 159,
      "node_id" : "PRRC_kwDOABII585el0iE",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 159,
      "original_position" : 29,
      "original_start_line" : 156,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 29,
      "pull_request_review_id" : 2034676796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 156,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T01:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587494035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587494035"
         }
      },
      "author_association" : "NONE",
      "body" : "Actually `SNAPSHOT_BASE_HEIGHT` is 299, and here I am trying to make sure that the snapshot was deleted and therefore the node is now using it's previous chain which has less work. I changed it to `assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT`  for more clarity",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-02T11:38:57Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert_equal(node.getblockcount(), 298)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587494035",
      "id" : 1587494035,
      "in_reply_to_id" : 1586967904,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585enzyT",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 172,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 2035514730,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587494035/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T11:38:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587494035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587496652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587496652"
         }
      },
      "author_association" : "NONE",
      "body" : "Yes, good catch. This line was removed since the iteration is no longer needed based on your other comment below.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-02T11:39:39Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587496652",
      "id" : 1587496652,
      "in_reply_to_id" : 1586968840,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585en0bM",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 155,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 2035516343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587496652/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T11:39:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587496652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587497230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587497230"
         }
      },
      "author_association" : "NONE",
      "body" : "That's a good one. Thanks. I Fixed it.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-02T11:39:59Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587497230",
      "id" : 1587497230,
      "in_reply_to_id" : 1586972804,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585en0kO",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 156,
      "original_position" : 29,
      "original_start_line" : 156,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 2035516963,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587497230/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T11:39:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587497230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've attempted to run the tests locally, but encountered an error:\r\nRestarting  node(`self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])`\r\n) fails with this error:\r\n\r\n```\r\ntest_framework.test_node.FailedToStartError: [node 2] bitcoind exited with status -6 during initialization. ./validation.h:608 CoinsDB: Assertion `m_coins_views' failed.\r\n************************\r\n```\r\nFeel free to ignore this, as it's not exclusive to the tests you've added; it also occurs in other tests. However, I would appreciate any pointers so I continue testing.",
      "created_at" : "2024-05-07T13:33:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2098422207",
      "id" : 2098422207,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5859E2G_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2098422207/reactions"
      },
      "updated_at" : "2024-05-07T13:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2098422207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/40592031?v=4",
         "events_url" : "https://api.github.com/users/naiyoma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naiyoma/followers",
         "following_url" : "https://api.github.com/users/naiyoma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naiyoma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naiyoma",
         "id" : 40592031,
         "login" : "naiyoma",
         "node_id" : "MDQ6VXNlcjQwNTkyMDMx",
         "organizations_url" : "https://api.github.com/users/naiyoma/orgs",
         "received_events_url" : "https://api.github.com/users/naiyoma/received_events",
         "repos_url" : "https://api.github.com/users/naiyoma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naiyoma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naiyoma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naiyoma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1593998574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1593998574"
         }
      },
      "author_association" : "NONE",
      "body" : "Nit: Because this test involves dealing with multiple nodes, for verbosity and clarity we can call this variable as `second_node`.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-08T13:05:05Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1593998574",
      "id" : 1593998574,
      "line" : 153,
      "node_id" : "PRRC_kwDOABII585fAnzu",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 153,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 23,
      "pull_request_review_id" : 2045600755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1593998574/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-08T13:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1593998574",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594000248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594000248"
         }
      },
      "author_association" : "NONE",
      "body" : "`nblocks=99`\r\nWe can make this value dependent on SNAPSHOT_BASE_HEIGHT such as (SNAPSHOT_BASE_HEIGHT - 200) or (SNAPSHOT_BASE_HEIGHT / 2) so that it's tied to SNAPSHOT_BASE_HEIGHT, and any future changes will automatically account for this variable as well.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-08T13:06:22Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594000248",
      "id" : 1594000248,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585fAoN4",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 160,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 30,
      "pull_request_review_id" : 2045600755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594000248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-08T13:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594000248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594008624"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594008624"
         }
      },
      "author_association" : "NONE",
      "body" : "Got to know from the CPP code that `-reindex-chainstate` will load up from the blk.dat files. That's why I understand only 2 more blocks are needed to exceed the work of the snapshot chain.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-08T13:11:00Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594008624",
      "id" : 1594008624,
      "line" : 168,
      "node_id" : "PRRC_kwDOABII585fAqQw",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 168,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 38,
      "pull_request_review_id" : 2045600755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594008624/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-08T13:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594008624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594014627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594014627"
         }
      },
      "author_association" : "NONE",
      "body" : "`-32603`\r\n\r\nAlthough not necessary for this PR, I am wondering how big of a lift would it be to tie these errors to the ones defined here: https://github.com/bitcoin/bitcoin/blob/master/src/rpc/protocol.h",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-08T13:14:42Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor or a descendant of the snapshot block and has more work\")\n+        # Generate two extra blocks and make sure node2's chain has more work than the snapshot's chain\n+        # This covers the scenario where the snapshot block is not on the most-work chain\n+        self.generate(node, nblocks=2, sync_fun=self.no_op)\n+        assert node.getblockcount() > SNAPSHOT_BASE_HEIGHT\n+        # Import the snapshot and assert its failure\n+        with node.assert_debug_log(expected_msgs=[\"[snapshot] activation failed - work does not exceed active chainstate\"]):\n+            assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594014627",
      "id" : 1594014627,
      "line" : 178,
      "node_id" : "PRRC_kwDOABII585fAruj",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 178,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 48,
      "pull_request_review_id" : 2045600755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594014627/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-08T13:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594014627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1596777994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596777994"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for your review. Actually this test uses only one node and I used the same notation used in other tests, but I am willing to change it if others agree.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-10T13:48:30Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1596777994",
      "id" : 1596777994,
      "in_reply_to_id" : 1593998574,
      "line" : 153,
      "node_id" : "PRRC_kwDOABII585fLOYK",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 153,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 23,
      "pull_request_review_id" : 2050118488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596777994/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T13:48:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596777994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1596778313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596778313"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point. The goal of this test is to generate a divergent chain starting from `START_HEIGHT` but having less work than the snapshot, which height equals `SNAPSHOT_BASE_HEIGHT`. Maybe I can set `nBlocks=SNAPSHOT_BASE_HEIGHT-START_HEIGHT-1`. This will result in `99` and it will adapt to any future changes to either `START_HEIGHT` or `SNAPSHOT_BASE_HEIGHT`",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-10T13:48:47Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1596778313",
      "id" : 1596778313,
      "in_reply_to_id" : 1594000248,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585fLOdJ",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 160,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 30,
      "pull_request_review_id" : 2050118997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596778313/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T13:48:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596778313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1597568656"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597568656"
         }
      },
      "author_association" : "NONE",
      "body" : "Yes, that would be good.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-12T07:13:56Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1597568656",
      "id" : 1597568656,
      "in_reply_to_id" : 1594000248,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585fOPaQ",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 160,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 30,
      "pull_request_review_id" : 2051304962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597568656/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-12T07:13:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597568656",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-05-13T09:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2107071362",
      "id" : 2107071362,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5859l1uC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2107071362/reactions"
      },
      "updated_at" : "2024-05-13T09:21:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2107071362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
