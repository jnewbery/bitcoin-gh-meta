[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29996).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [naiyoma](https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2087518282) |\n| Stale ACK | [rkrux](https://github.com/bitcoin/bitcoin/pull/29996#pullrequestreview-2045600755) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29681](https://github.com/bitcoin/bitcoin/pull/29681) (test: loading assumeutxo snapshot start states by BrandonOdiwuor)\n* [#29428](https://github.com/bitcoin/bitcoin/pull/29428) (test: Assumeutxo: snapshots with less work should not be loaded by hernanmarino)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-04-29T15:13:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2083008209",
      "id" : 2083008209,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5858KC7R",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083008209/reactions"
      },
      "updated_at" : "2024-05-26T00:27:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083008209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I splitted the original commit into two commits (one for each test). The second test (https://github.com/bitcoin/bitcoin/pull/29996/commits/af0f401258e0c189799a36f4487eaa751d779e7b) may be redundant with this one: https://github.com/bitcoin/bitcoin/pull/29428. The only difference is that my test is executed on a node that has a divergent chain after block 199. I did that to cover this scenario described in the comments\r\n\r\n `[...] Loading a snapshot when the current chain tip is: [...] Not an ancestor or a descendant of the snapshot block and has more work`\r\n \r\n If it's redundant I can delete the second commit. Thoughts?",
      "created_at" : "2024-04-30T19:25:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2086782948",
      "id" : 2086782948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5858Ycfk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2086782948/reactions"
      },
      "updated_at" : "2024-04-30T19:25:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2086782948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, covers more tests scenarios for AssumeUTXO\r\n",
      "created_at" : "2024-04-30T22:05:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2087518282",
      "id" : 2087518282,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5858bQBK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2087518282/reactions"
      },
      "updated_at" : "2024-04-30T22:05:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2087518282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/40592031?v=4",
         "events_url" : "https://api.github.com/users/naiyoma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naiyoma/followers",
         "following_url" : "https://api.github.com/users/naiyoma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naiyoma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naiyoma",
         "id" : 40592031,
         "login" : "naiyoma",
         "node_id" : "MDQ6VXNlcjQwNTkyMDMx",
         "organizations_url" : "https://api.github.com/users/naiyoma/orgs",
         "received_events_url" : "https://api.github.com/users/naiyoma/received_events",
         "repos_url" : "https://api.github.com/users/naiyoma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naiyoma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naiyoma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naiyoma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586967904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "instead of number `298` would it make more sense to use `SNAPSHOT_BASE_HEIGHT`?",
      "commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "created_at" : "2024-05-02T01:23:21Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert_equal(node.getblockcount(), 298)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586967904",
      "id" : 1586967904,
      "line" : 172,
      "node_id" : "PRRC_kwDOABII585elzVg",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 172,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 42,
      "pull_request_review_id" : 2034676796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T01:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586968840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "is this not the same as `START_HEIGHT`?",
      "commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "created_at" : "2024-05-02T01:25:20Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586968840",
      "id" : 1586968840,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII585elzkI",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 155,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 25,
      "pull_request_review_id" : 2034676796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T01:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586972804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        block_hash = node.getblockhash(START_HEIGHT + 1)\r\n        node.invalidateblock(block_hash)\r\n        assert_equal(node.getblockcount(), START_HEIGHT)\r\n```",
      "commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "created_at" : "2024-05-02T01:34:42Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586972804",
      "id" : 1586972804,
      "line" : 159,
      "node_id" : "PRRC_kwDOABII585el0iE",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 159,
      "original_position" : 29,
      "original_start_line" : 156,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 29,
      "pull_request_review_id" : 2034676796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 156,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T01:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15950706?v=4",
         "events_url" : "https://api.github.com/users/kevkevinpal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kevkevinpal/followers",
         "following_url" : "https://api.github.com/users/kevkevinpal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kevkevinpal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kevkevinpal",
         "id" : 15950706,
         "login" : "kevkevinpal",
         "node_id" : "MDQ6VXNlcjE1OTUwNzA2",
         "organizations_url" : "https://api.github.com/users/kevkevinpal/orgs",
         "received_events_url" : "https://api.github.com/users/kevkevinpal/received_events",
         "repos_url" : "https://api.github.com/users/kevkevinpal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kevkevinpal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kevkevinpal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kevkevinpal"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587494035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587494035"
         }
      },
      "author_association" : "NONE",
      "body" : "Actually `SNAPSHOT_BASE_HEIGHT` is 299, and here I am trying to make sure that the snapshot was deleted and therefore the node is now using it's previous chain which has less work. I changed it to `assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT`  for more clarity",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-02T11:38:57Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert_equal(node.getblockcount(), 298)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587494035",
      "id" : 1587494035,
      "in_reply_to_id" : 1586967904,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585enzyT",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 172,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 2035514730,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587494035/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T11:38:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587494035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587496652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587496652"
         }
      },
      "author_association" : "NONE",
      "body" : "Yes, good catch. This line was removed since the iteration is no longer needed based on your other comment below.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-02T11:39:39Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587496652",
      "id" : 1587496652,
      "in_reply_to_id" : 1586968840,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585en0bM",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 155,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 2035516343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587496652/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T11:39:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587496652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587497230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587497230"
         }
      },
      "author_association" : "NONE",
      "body" : "That's a good one. Thanks. I Fixed it.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-02T11:39:59Z",
      "diff_hunk" : "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587497230",
      "id" : 1587497230,
      "in_reply_to_id" : 1586972804,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585en0kO",
      "original_commit_id" : "af0f401258e0c189799a36f4487eaa751d779e7b",
      "original_line" : 156,
      "original_position" : 29,
      "original_start_line" : 156,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 2035516963,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587497230/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T11:39:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587497230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've attempted to run the tests locally, but encountered an error:\r\nRestarting  node(`self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])`\r\n) fails with this error:\r\n\r\n```\r\ntest_framework.test_node.FailedToStartError: [node 2] bitcoind exited with status -6 during initialization. ./validation.h:608 CoinsDB: Assertion `m_coins_views' failed.\r\n************************\r\n```\r\nFeel free to ignore this, as it's not exclusive to the tests you've added; it also occurs in other tests. However, I would appreciate any pointers so I continue testing.",
      "created_at" : "2024-05-07T13:33:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2098422207",
      "id" : 2098422207,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5859E2G_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2098422207/reactions"
      },
      "updated_at" : "2024-05-07T13:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2098422207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/40592031?v=4",
         "events_url" : "https://api.github.com/users/naiyoma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naiyoma/followers",
         "following_url" : "https://api.github.com/users/naiyoma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naiyoma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naiyoma",
         "id" : 40592031,
         "login" : "naiyoma",
         "node_id" : "MDQ6VXNlcjQwNTkyMDMx",
         "organizations_url" : "https://api.github.com/users/naiyoma/orgs",
         "received_events_url" : "https://api.github.com/users/naiyoma/received_events",
         "repos_url" : "https://api.github.com/users/naiyoma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naiyoma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naiyoma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naiyoma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1593998574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1593998574"
         }
      },
      "author_association" : "NONE",
      "body" : "Nit: Because this test involves dealing with multiple nodes, for verbosity and clarity we can call this variable as `second_node`.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-08T13:05:05Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1593998574",
      "id" : 1593998574,
      "line" : 153,
      "node_id" : "PRRC_kwDOABII585fAnzu",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 153,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 23,
      "pull_request_review_id" : 2045600755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1593998574/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-08T13:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1593998574",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594000248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594000248"
         }
      },
      "author_association" : "NONE",
      "body" : "`nblocks=99`\r\nWe can make this value dependent on SNAPSHOT_BASE_HEIGHT such as (SNAPSHOT_BASE_HEIGHT - 200) or (SNAPSHOT_BASE_HEIGHT / 2) so that it's tied to SNAPSHOT_BASE_HEIGHT, and any future changes will automatically account for this variable as well.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-08T13:06:22Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594000248",
      "id" : 1594000248,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585fAoN4",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 160,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 30,
      "pull_request_review_id" : 2045600755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594000248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-08T13:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594000248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594008624"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594008624"
         }
      },
      "author_association" : "NONE",
      "body" : "Got to know from the CPP code that `-reindex-chainstate` will load up from the blk.dat files. That's why I understand only 2 more blocks are needed to exceed the work of the snapshot chain.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-08T13:11:00Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594008624",
      "id" : 1594008624,
      "line" : 168,
      "node_id" : "PRRC_kwDOABII585fAqQw",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 168,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 38,
      "pull_request_review_id" : 2045600755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594008624/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-08T13:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594008624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594014627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594014627"
         }
      },
      "author_association" : "NONE",
      "body" : "`-32603`\r\n\r\nAlthough not necessary for this PR, I am wondering how big of a lift would it be to tie these errors to the ones defined here: https://github.com/bitcoin/bitcoin/blob/master/src/rpc/protocol.h",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-08T13:14:42Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor or a descendant of the snapshot block and has more work\")\n+        # Generate two extra blocks and make sure node2's chain has more work than the snapshot's chain\n+        # This covers the scenario where the snapshot block is not on the most-work chain\n+        self.generate(node, nblocks=2, sync_fun=self.no_op)\n+        assert node.getblockcount() > SNAPSHOT_BASE_HEIGHT\n+        # Import the snapshot and assert its failure\n+        with node.assert_debug_log(expected_msgs=[\"[snapshot] activation failed - work does not exceed active chainstate\"]):\n+            assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594014627",
      "id" : 1594014627,
      "line" : 178,
      "node_id" : "PRRC_kwDOABII585fAruj",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 178,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 48,
      "pull_request_review_id" : 2045600755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594014627/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-08T13:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594014627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1596777994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596777994"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for your review. Actually this test uses only one node and I used the same notation used in other tests, but I am willing to change it if others agree.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-10T13:48:30Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1596777994",
      "id" : 1596777994,
      "in_reply_to_id" : 1593998574,
      "line" : 153,
      "node_id" : "PRRC_kwDOABII585fLOYK",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 153,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 23,
      "pull_request_review_id" : 2050118488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596777994/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T13:48:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596777994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1596778313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596778313"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point. The goal of this test is to generate a divergent chain starting from `START_HEIGHT` but having less work than the snapshot, which height equals `SNAPSHOT_BASE_HEIGHT`. Maybe I can set `nBlocks=SNAPSHOT_BASE_HEIGHT-START_HEIGHT-1`. This will result in `99` and it will adapt to any future changes to either `START_HEIGHT` or `SNAPSHOT_BASE_HEIGHT`",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-10T13:48:47Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1596778313",
      "id" : 1596778313,
      "in_reply_to_id" : 1594000248,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585fLOdJ",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 160,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 30,
      "pull_request_review_id" : 2050118997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596778313/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T13:48:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596778313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1597568656"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597568656"
         }
      },
      "author_association" : "NONE",
      "body" : "Yes, that would be good.",
      "commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "created_at" : "2024-05-12T07:13:56Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1597568656",
      "id" : 1597568656,
      "in_reply_to_id" : 1594000248,
      "line" : 160,
      "node_id" : "PRRC_kwDOABII585fOPaQ",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 160,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 30,
      "pull_request_review_id" : 2051304962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597568656/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-12T07:13:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597568656",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-05-13T09:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2107071362",
      "id" : 2107071362,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5859l1uC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2107071362/reactions"
      },
      "updated_at" : "2024-05-13T09:21:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2107071362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1598649148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598649148"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done. Thanks",
      "commit_id" : "3f033542b869dfbe037cda705c3b8f7faa32da5d",
      "created_at" : "2024-05-13T15:14:29Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1598649148",
      "id" : 1598649148,
      "in_reply_to_id" : 1594000248,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fSXM8",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 160,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : null,
      "pull_request_review_id" : 2053004297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598649148/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T15:14:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598649148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1598651033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598651033"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure. Maybe you can try opening an issue to discuss it ",
      "commit_id" : "3f033542b869dfbe037cda705c3b8f7faa32da5d",
      "created_at" : "2024-05-13T15:15:56Z",
      "diff_hunk" : "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor or a descendant of the snapshot block and has more work\")\n+        # Generate two extra blocks and make sure node2's chain has more work than the snapshot's chain\n+        # This covers the scenario where the snapshot block is not on the most-work chain\n+        self.generate(node, nblocks=2, sync_fun=self.no_op)\n+        assert node.getblockcount() > SNAPSHOT_BASE_HEIGHT\n+        # Import the snapshot and assert its failure\n+        with node.assert_debug_log(expected_msgs=[\"[snapshot] activation failed - work does not exceed active chainstate\"]):\n+            assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1598651033",
      "id" : 1598651033,
      "in_reply_to_id" : 1594014627,
      "line" : 187,
      "node_id" : "PRRC_kwDOABII585fSXqZ",
      "original_commit_id" : "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "original_line" : 187,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 48,
      "pull_request_review_id" : 2053007625,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598651033/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T15:15:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598651033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased. I also addressed some feedback from rkrux's comments: changed hardcoded value of `nblocks` from 99 to a dynamic value, i.e `SNAPSHOT_BASE_HEIGHT-START_HEIGHT-1`",
      "created_at" : "2024-05-13T15:18:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2107965861",
      "id" : 2107965861,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII5859pQGl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2107965861/reactions"
      },
      "updated_at" : "2024-05-13T15:18:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2107965861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "\r\nTest  passes for  all three scenarios: \r\n- [x] https://github.com/bitcoin/bitcoin/pull/29996/commits/a7501f779eb84effd5579070b8b1c1a3020273d6 loading a snapshot when chain tip isn't ancestor but has less work\r\n- [x] https://github.com/bitcoin/bitcoin/pull/29996/commits/3f033542b869dfbe037cda705c3b8f7faa32da5d loading a snapshot when chain tip isn't ancestor/descendant, has more work  and A valid snapshot file & snapshot block, but the block is not on the most-work chain",
      "created_at" : "2024-05-16T20:43:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2116143536",
      "id" : 2116143536,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII585-Icmw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2116143536/reactions"
      },
      "updated_at" : "2024-05-16T20:43:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2116143536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/40592031?v=4",
         "events_url" : "https://api.github.com/users/naiyoma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naiyoma/followers",
         "following_url" : "https://api.github.com/users/naiyoma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naiyoma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naiyoma",
         "id" : 40592031,
         "login" : "naiyoma",
         "node_id" : "MDQ6VXNlcjQwNTkyMDMx",
         "organizations_url" : "https://api.github.com/users/naiyoma/orgs",
         "received_events_url" : "https://api.github.com/users/naiyoma/received_events",
         "repos_url" : "https://api.github.com/users/naiyoma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naiyoma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naiyoma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naiyoma"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "\r\n\r\n\r\n> I splitted the original commit into two commits (one for each test). The second test ([af0f401](https://github.com/bitcoin/bitcoin/commit/af0f401258e0c189799a36f4487eaa751d779e7b)) may be redundant with this one: #29428. The only difference is that my test is executed on a node that has a divergent chain after block 199. I did that to cover this scenario described in the comments\r\n> \r\n> `[...] Loading a snapshot when the current chain tip is: [...] Not an ancestor or a descendant of the snapshot block and has more work`\r\n> \r\n> If it's redundant I can delete the second commit. Thoughts?\r\n\r\nIMO you should not delete the second commit,  both tests verify that the snapshot load fails but under different scenarios",
      "created_at" : "2024-05-16T21:17:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2116200874",
      "id" : 2116200874,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII585-Iqmq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2116200874/reactions"
      },
      "updated_at" : "2024-05-16T21:17:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2116200874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/40592031?v=4",
         "events_url" : "https://api.github.com/users/naiyoma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naiyoma/followers",
         "following_url" : "https://api.github.com/users/naiyoma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naiyoma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naiyoma",
         "id" : 40592031,
         "login" : "naiyoma",
         "node_id" : "MDQ6VXNlcjQwNTkyMDMx",
         "organizations_url" : "https://api.github.com/users/naiyoma/orgs",
         "received_events_url" : "https://api.github.com/users/naiyoma/received_events",
         "repos_url" : "https://api.github.com/users/naiyoma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naiyoma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naiyoma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naiyoma"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-06-05T00:10:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2148607042",
      "id" : 2148607042,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
      "node_id" : "IC_kwDOABII586AESRC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2148607042/reactions"
      },
      "updated_at" : "2024-06-05T00:10:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2148607042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1629294986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629294986"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This should also check that the background validation succeeds. Otherwise there could be a bug where the diverging chain is not rewound?",
      "commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "created_at" : "2024-06-06T11:01:07Z",
      "diff_hunk" : "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1629294986",
      "id" : 1629294986,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585hHRGK",
      "original_commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "original_line" : 214,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 32,
      "pull_request_review_id" : 2101629969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629294986/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-06T11:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629294986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1631431050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1631431050"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for pointing this out. The background validation does not seem to finish in this case.\r\n\r\nI am now testing with a new node `n3` (in my local copy) to avoid the manual rollback to `START_HEIGHT` ([L207](https://github.com/bitcoin/bitcoin/pull/29996/files#diff-8eaa6b77b4e4f242deb67950425cb6b6b7de5370c56a1e8fa7e3a12e95df0a9dR207)). Additionally, `sync_blocks()` was throwing a timeout when reusing n2 for this test (not sure why). \r\n\r\nHere's the new approach I'm trying:\r\n\r\n- The new node starts at `START_HEIGHT` (199).\r\n- I generate a divergent chain from `START_HEIGHT` up to height 298 (< `SNAPSHOT_BASE_HEIGHT`).\r\n- I load the snapshot (height=299).\r\n\r\nAfter loading the snapshot, I can see these two chain states:â¨\r\n\r\n```\r\n[{'blocks': 298, 'bestblockhash': '171f1d8af9371c9d54a3731f8befdfa6dd2fe553831970ddffdaeb0b93aa54d3', 'difficulty': Decimal('4.656542373906925E-10'), 'verificationprogress': 1, 'coins_db_cache_bytes': 7969177, 'coins_tip_cache_bytes': 438304768, 'validated': True}, {'blocks': 299, 'bestblockhash': '3bb7ce5eba0be48939b7a521ac1ba9316afee2c7bada3a0cca24188e6d7d96c0', 'difficulty': Decimal('4.656542373906925E-10'), 'verificationprogress': 1, 'coins_db_cache_bytes': 419430, 'coins_tip_cache_bytes': 23068672, 'snapshot_blockhash': '3bb7ce5eba0be48939b7a521ac1ba9316afee2c7bada3a0cca24188e6d7d96c0', 'validated': False}]\r\n```\r\n\r\nNext, I connect the nodes and ensure they all see the same tip:â¨        \r\n```\r\nself.connect_nodes(0, 3)\r\nself.wait_until(lambda: n3.getchainstates()['chainstates'][-1]['blocks'] == FINAL_HEIGHT)\r\nself.sync_blocks(nodes=(self.nodes[0], n3))\r\n```\r\nâ¨After syncing, these are the chain states:\r\n\r\n```\r\n[{'blocks': 298, 'bestblockhash': '171f1d8af9371c9d54a3731f8befdfa6dd2fe553831970ddffdaeb0b93aa54d3', 'difficulty': Decimal('4.656542373906925E-10'), 'verificationprogress': 1, 'coins_db_cache_bytes': 7969177, 'coins_tip_cache_bytes': 438304768, 'validated': True}, {'blocks': 399, 'bestblockhash': '193ad9344966a54125f4b8d3596572c356ca3dcc216b25b91cb0022fbf61c7e1', 'difficulty': Decimal('4.656542373906925E-10'), 'verificationprogress': 1, 'coins_db_cache_bytes': 419430, 'coins_tip_cache_bytes': 23068672, 'snapshot_blockhash': '3bb7ce5eba0be48939b7a521ac1ba9316afee2c7bada3a0cca24188e6d7d96c0', 'validated': False}]\r\n```\r\n\r\nIt seems that the snapshot chain has now synced to the tip (height 399). However, this line times out after syncing the blocks:\r\n\r\n`self.wait_until(lambda: len(n3.getchainstates()['chainstates']) == 1)`\r\n\r\nI'm not sure if I'm doing something wrong or if there is indeed a bug where the divergent chain is not rewound. I will continue investigating. \r\n\r\n**Something to note here:** if I follow the same process but I don't generate any divergent chain, then the validation completes successfully.\r\n\r\nAny directions on how to proceed with this would be appreciated.",
      "commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "created_at" : "2024-06-07T16:12:06Z",
      "diff_hunk" : "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1631431050",
      "id" : 1631431050,
      "in_reply_to_id" : 1629294986,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585hPamK",
      "original_commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "original_line" : 214,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 32,
      "pull_request_review_id" : 2104939743,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1631431050/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-07T16:12:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1631431050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1632216319"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1632216319"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I'm not sure if I'm doing something wrong or if there is indeed a bug where the divergent chain is not rewound. I will continue investigating.\r\n\r\nThis sounds like a bug. Just to clarify, the active chain is stuck at height `298` and the background chain continues to sync past `399`?",
      "commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "created_at" : "2024-06-09T09:12:08Z",
      "diff_hunk" : "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1632216319",
      "id" : 1632216319,
      "in_reply_to_id" : 1629294986,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585hSaT_",
      "original_commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "original_line" : 214,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 32,
      "pull_request_review_id" : 2106121371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1632216319/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-09T09:12:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1632216319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1633146879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633146879"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I guess I am confused with the terms \"active\" and \"background\" chain. I assume the active chain is the snapshot chain which starts at height `299`, and the divergent chain is the one stuck at `298`. I base this on the fact that when I run `getbestblockhash` after `loadtxoutset`, I get the hash of the snapshot tip. However, I might be mistaken. Shouldn't the divergent chain be rewound to `START_HEIGHT` and become the background validation chain?\r\n\r\nTo address your questions:\r\n\r\n1. The divergent chain is indeed stuck at height `298`.\r\n2. The snapshot chain continues to sync past height `399`. Although `399` is the `FINAL_HEIGHT` for this test, I was able to mine an additional 100 blocks on top of `node0`, resulting in both `node0` and `node3` syncing again, and the snapshot chain syncing up to height `499`.\r\n\r\nHowever, even after syncing past 399, the background validation does not seem to finish. I always get a timeout when running this line after syncing the nodes:\r\n```\r\nself.wait_until(lambda: len(node.getchainstates()['chainstates']) == 1)\r\n```\r\n\r\nAdditionally, I am experiencing an intermittent issue where the sync does not always finish, and I have not been able to determine the cause yet. This issue happens only after mining past 399.",
      "commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "created_at" : "2024-06-10T12:13:13Z",
      "diff_hunk" : "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1633146879",
      "id" : 1633146879,
      "in_reply_to_id" : 1629294986,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585hV9f_",
      "original_commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "original_line" : 214,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 32,
      "pull_request_review_id" : 2107619315,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633146879/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-10T12:13:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633146879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19962151?v=4",
         "events_url" : "https://api.github.com/users/alfonsoromanz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alfonsoromanz/followers",
         "following_url" : "https://api.github.com/users/alfonsoromanz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alfonsoromanz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alfonsoromanz",
         "id" : 19962151,
         "login" : "alfonsoromanz",
         "node_id" : "MDQ6VXNlcjE5OTYyMTUx",
         "organizations_url" : "https://api.github.com/users/alfonsoromanz/orgs",
         "received_events_url" : "https://api.github.com/users/alfonsoromanz/received_events",
         "repos_url" : "https://api.github.com/users/alfonsoromanz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alfonsoromanz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alfonsoromanz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alfonsoromanz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1633915935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633915935"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I can confirm this behavior and also think that this has uncovered a bug in `net_processing`.\r\n\r\nI think that the root cause is in [TryDownloadingHistoricalBlocks](https://github.com/bitcoin/bitcoin/blob/b1ba1b178f501daa1afdd91f9efec34e5ec1e294/src/net_processing.cpp#L1511-L1538) (which is responsible for downloading the background chain):\r\nThis function calls `FindNextBlocks()` with  `pindexWalk` set to the current tip of the background chainstate (`from_tip`), and `target_block` set to the snapshot block.\r\n`FindNextBlocks` then walks from the snapshot block backwards to the the **height** of `from_tip`, save these blocks in `vToFetch` and then begins to download these blocks in forward order.\r\nThis is incorrect, because the blocks in starting at the last common ancestor of `from_tip` and the snapshot block, up to the height of `from_tip` are never requested that way (their height is smaller than the height of `from_tip`).\r\nSo, my proposed fix would be something like https://github.com/mzumsande/bitcoin/commit/edb2b69a16889552ddd40b71a491e7722d9b4e12 (feel free to cherry-pick/ adjust as you like).\r\n\r\n@alfonsoromanz: Could you check if that fix would solve the issue for you?\r\n@ryanofsky Could you take a look - would you agree with that explanation and the proposed fix?\r\n ",
      "commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "created_at" : "2024-06-10T22:35:56Z",
      "diff_hunk" : "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1633915935",
      "id" : 1633915935,
      "in_reply_to_id" : 1629294986,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585hY5Qf",
      "original_commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "original_line" : 214,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 32,
      "pull_request_review_id" : 2108877582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633915935/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-10T22:35:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633915935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1633934145"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633934145"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Although I'm not sure if this is an actual problem in practice, because with our DoS protections for low-work blocks and headers we shouldn't really get into this situation with a divergent chain in the first place.",
      "commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "created_at" : "2024-06-10T23:05:12Z",
      "diff_hunk" : "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1633934145",
      "id" : 1633934145,
      "in_reply_to_id" : 1629294986,
      "line" : 214,
      "node_id" : "PRRC_kwDOABII585hY9tB",
      "original_commit_id" : "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "original_line" : 214,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/feature_assumeutxo.py",
      "position" : 32,
      "pull_request_review_id" : 2108903806,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633934145/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-10T23:05:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633934145",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
