[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29986).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [instagibbs](https://github.com/bitcoin/bitcoin/pull/29986#pullrequestreview-2028979977), [glozow](https://github.com/bitcoin/bitcoin/pull/29986#issuecomment-2083176753) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2024-04-28T12:44:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29986#issuecomment-2081473074",
      "id" : 2081473074,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29986",
      "node_id" : "IC_kwDOABII5858EMIy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081473074/reactions"
      },
      "updated_at" : "2024-04-29T16:31:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081473074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : " @glozow @instagibbs This was something I noticed when rebasing #28676.",
      "created_at" : "2024-04-28T12:47:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29986#issuecomment-2081474305",
      "id" : 2081474305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29986",
      "node_id" : "IC_kwDOABII5858EMcB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081474305/reactions"
      },
      "updated_at" : "2024-04-28T12:47:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081474305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1583032012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583032012"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        fee_to_beat = max(int(tx_v3_child_2[\"fee\"] * COIN), int(tx_unrelated_replacee[\"fee\"] * COIN))\r\n```\r\nwould you consider this instead? seems the more direct thing we're trying to accomplish",
      "commit_id" : "c2efe9f77549ff67a623d725abf7ac7390aeef3e",
      "created_at" : "2024-04-29T12:45:25Z",
      "diff_hunk" : "@@ -536,7 +536,7 @@ def test_v3_sibling_eviction(self):\n         fee_to_beat_child2 = int(tx_v3_child_2[\"fee\"] * COIN)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1583032012",
      "id" : 1583032012,
      "line" : 536,
      "node_id" : "PRRC_kwDOABII585eWybM",
      "original_commit_id" : "c2efe9f77549ff67a623d725abf7ac7390aeef3e",
      "original_line" : 536,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : 1,
      "pull_request_review_id" : 2028410790,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583032012/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T12:45:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583032012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1583168472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583168472"
         }
      },
      "author_association" : "MEMBER",
      "body" : " makes sense to me. Use `fee_per_output=fee_to_beat_child2*2` ?",
      "commit_id" : "c2efe9f77549ff67a623d725abf7ac7390aeef3e",
      "created_at" : "2024-04-29T14:16:37Z",
      "diff_hunk" : "@@ -536,7 +536,7 @@ def test_v3_sibling_eviction(self):\n         fee_to_beat_child2 = int(tx_v3_child_2[\"fee\"] * COIN)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1583168472",
      "id" : 1583168472,
      "in_reply_to_id" : 1583032012,
      "line" : 536,
      "node_id" : "PRRC_kwDOABII585eXTvY",
      "original_commit_id" : "c2efe9f77549ff67a623d725abf7ac7390aeef3e",
      "original_line" : 536,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : 1,
      "pull_request_review_id" : 2028653521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583168472/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T14:16:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583168472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1583360322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583360322"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think that works, let me know if what I pushed matches what you're thinking!",
      "commit_id" : "f8a141c2dae2471a7ce7248e28a0bbeb8a291acd",
      "created_at" : "2024-04-29T16:17:00Z",
      "diff_hunk" : "@@ -536,7 +536,7 @@ def test_v3_sibling_eviction(self):\n         fee_to_beat_child2 = int(tx_v3_child_2[\"fee\"] * COIN)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1583360322",
      "id" : 1583360322,
      "in_reply_to_id" : 1583032012,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585eYClC",
      "original_commit_id" : "c2efe9f77549ff67a623d725abf7ac7390aeef3e",
      "original_line" : 536,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : null,
      "pull_request_review_id" : 2028968706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583360322/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-29T16:17:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583360322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK f8a141c2dae2471a7ce7248e28a0bbeb8a291acd",
      "created_at" : "2024-04-29T16:31:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29986#issuecomment-2083176753",
      "id" : 2083176753,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29986",
      "node_id" : "IC_kwDOABII5858KsEx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083176753/reactions"
      },
      "updated_at" : "2024-04-29T16:31:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083176753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1585681716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1585681716"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops -- I miscalculated the ancestor feerates after rewriting it this way, and the new tx still has insufficient fee.  Here's what everything looks like with the change here (that is now merged, doh):\r\n\r\ntx_unrelated_replacee: fee 31200, vsize 104\r\nparent tx: fee 2000, vsize 147\r\ntx_v3_child_2: fee 10400, vsize 104\r\n\r\ntx_v3_child_3: fee 62400, vsize 157\r\n\r\nSo the total fee of the new transaction is high enough, but the ancestor feerate is still too low: (62400+2000)/304 = 211, which is less than the 300 s/b we need to beat the first tx.",
      "commit_id" : "f8a141c2dae2471a7ce7248e28a0bbeb8a291acd",
      "created_at" : "2024-04-30T23:39:20Z",
      "diff_hunk" : "@@ -536,7 +536,7 @@ def test_v3_sibling_eviction(self):\n         fee_to_beat_child2 = int(tx_v3_child_2[\"fee\"] * COIN)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1585681716",
      "id" : 1585681716,
      "in_reply_to_id" : 1583032012,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585eg5U0",
      "original_commit_id" : "c2efe9f77549ff67a623d725abf7ac7390aeef3e",
      "original_line" : 536,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : null,
      "pull_request_review_id" : 2032818064,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1585681716/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-30T23:39:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1585681716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1586616806"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586616806"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oof my bad for not checking more closely. How's this?\r\n(Edited)\r\n\r\n```\r\ndiff --git a/test/functional/mempool_accept_v3.py b/test/functional/mempool_accept_v3.py\r\nindex 8285b82c19..ab43ca60c3 100755\r\n--- a/test/functional/mempool_accept_v3.py\r\n+++ b/test/functional/mempool_accept_v3.py\r\n@@ -533,10 +533,28 @@ class MempoolAcceptV3(BitcoinTestFramework):\r\n         tx_unrelated_replacee = self.wallet.send_self_transfer(from_node=node, utxo_to_spend=utxo_unrelated_conflict)\r\n         assert tx_unrelated_replacee[\"txid\"] in node.getrawmempool()\r\n \r\n-        fee_to_beat = max(int(tx_v3_child_2[\"fee\"] * COIN), int(tx_unrelated_replacee[\"fee\"]*COIN))\r\n+        fee_to_beat_absolute = int(tx_v3_child_2[\"fee\"] * COIN) + int(tx_unrelated_replacee[\"fee\"]*COIN)\r\n+\r\n+        entry_unrelated_replacee = node.getmempoolentry(tx_unrelated_replacee[\"txid\"])\r\n+        entry_tx_v3_child_2 = node.getmempoolentry(tx_v3_child_2[\"txid\"])\r\n+        entry_tx_parent = node.getmempoolentry(tx_v3_parent[\"txid\"])\r\n+\r\n+        # Need to have a higher feerate than both direct conflicts\r\n+        feerate_to_beat = max(int(entry_unrelated_replacee[\"fees\"][\"modified\"] / entry_unrelated_replacee[\"vsize\"] * COIN), \\\r\n+            int(entry_tx_v3_child_2[\"fees\"][\"modified\"] / entry_tx_v3_child_2[\"vsize\"] * COIN))\r\n+\r\n+        # Simulate to get tx size\r\n+        test_tx_v3_child_3 = self.wallet.create_self_transfer_multi(\r\n+            utxos_to_spend=[tx_v3_parent[\"new_utxos\"][0], utxo_unrelated_conflict], version=3\r\n+        )\r\n+\r\n+        # Include the parent size because the ancestor feerate is what matters.\r\n+        fee_to_beat_feerate = feerate_to_beat * (test_tx_v3_child_3[\"tx\"].get_vsize() + entry_tx_parent[\"vsize\"])\r\n+        fee_v3_child_3 = max(fee_to_beat_feerate, fee_to_beat_absolute) + 5\r\n \r\n         tx_v3_child_3 = self.wallet.create_self_transfer_multi(\r\n-            utxos_to_spend=[tx_v3_parent[\"new_utxos\"][0], utxo_unrelated_conflict], fee_per_output=fee_to_beat*2, version=3\r\n+            utxos_to_spend=[tx_v3_parent[\"new_utxos\"][0], utxo_unrelated_conflict],\r\n+            fee_per_output=fee_v3_child_3, version=3\r\n         )\r\n         node.sendrawtransaction(tx_v3_child_3[\"hex\"])\r\n         self.check_mempool(txids_v2_100 + [tx_v3_parent[\"txid\"], tx_v3_child_3[\"txid\"]])\r\n\r\n```",
      "commit_id" : "f8a141c2dae2471a7ce7248e28a0bbeb8a291acd",
      "created_at" : "2024-05-01T18:30:05Z",
      "diff_hunk" : "@@ -536,7 +536,7 @@ def test_v3_sibling_eviction(self):\n         fee_to_beat_child2 = int(tx_v3_child_2[\"fee\"] * COIN)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1586616806",
      "id" : 1586616806,
      "in_reply_to_id" : 1583032012,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ekdnm",
      "original_commit_id" : "c2efe9f77549ff67a623d725abf7ac7390aeef3e",
      "original_line" : 536,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : null,
      "pull_request_review_id" : 2034182085,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586616806/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-01T18:38:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586616806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1586637512"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586637512"
         }
      },
      "author_association" : "MEMBER",
      "body" : "above:\r\n- `fee_to_beat_absolute` is 41600 (above code uses `max(tx_unrelated_replacee, tx_v3_child_2)` but Rule 3 would require us to beat the sum of their fees haha)\r\n- `feerate_to_beat` is 300, i.e. 31200 /104\r\n- `fee_to_beat_feerate` is 300 * (147 + 154) = 90300\r\n- `fee_v3_child_3` is max(41600, 90300) + 5 = 90305\r\n- this means the ancestor feerate is 90305 / (147 + 154) = 300.017",
      "commit_id" : "f8a141c2dae2471a7ce7248e28a0bbeb8a291acd",
      "created_at" : "2024-05-01T18:44:28Z",
      "diff_hunk" : "@@ -536,7 +536,7 @@ def test_v3_sibling_eviction(self):\n         fee_to_beat_child2 = int(tx_v3_child_2[\"fee\"] * COIN)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1586637512",
      "id" : 1586637512,
      "in_reply_to_id" : 1583032012,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ekirI",
      "original_commit_id" : "c2efe9f77549ff67a623d725abf7ac7390aeef3e",
      "original_line" : 536,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : null,
      "pull_request_review_id" : 2034206480,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586637512/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-01T18:44:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586637512",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1588067475"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1588067475"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Inspired by your approach, I thought it might be helpful to just add support for setting a target feerate on a transaction in miniwallet, something like this?\r\n\r\n```diff\r\ndiff --git a/test/functional/mempool_accept_v3.py b/test/functional/mempool_accept_v3.py\r\nindex 8285b82c19..db6aa78167 100755\r\n--- a/test/functional/mempool_accept_v3.py\r\n+++ b/test/functional/mempool_accept_v3.py\r\n@@ -533,13 +533,25 @@ class MempoolAcceptV3(BitcoinTestFramework):\r\n         tx_unrelated_replacee = self.wallet.send_self_transfer(from_node=node, utxo_to_spend=utxo_unrelated_conflict)\r\n         assert tx_unrelated_replacee[\"txid\"] in node.getrawmempool()\r\n \r\n-        fee_to_beat = max(int(tx_v3_child_2[\"fee\"] * COIN), int(tx_unrelated_replacee[\"fee\"]*COIN))\r\n-\r\n+        def get_ancestor_feerate(txid):\r\n+            entry = node.getmempoolentry(txid)\r\n+            return entry[\"fees\"][\"ancestor\"]*COIN // entry[\"ancestorsize\"]\r\n+\r\n+        # For RBF to succeed, we should have a greater total fee and a greater\r\n+        # feerate than what we're replacing.\r\n+        # Use 500 vbytes as an upper bound on how big the new transaction might be.\r\n+        fee_to_beat = int(tx_v3_child_2[\"fee\"]*COIN) + int(tx_unrelated_replacee[\"fee\"]*COIN) + 500\r\n+        feerate_to_beat = max(get_ancestor_feerate(tx_v3_child_2[\"txid\"]),\r\n+                    get_ancestor_feerate(tx_unrelated_replacee[\"txid\"]))\r\n+\r\n+        # Since this transaction has a parent, double the target feerate so\r\n+        # that we'll pay for the parent (assuming comparable sizes).\r\n         tx_v3_child_3 = self.wallet.create_self_transfer_multi(\r\n-            utxos_to_spend=[tx_v3_parent[\"new_utxos\"][0], utxo_unrelated_conflict], fee_per_output=fee_to_beat*2, version=3\r\n+            utxos_to_spend=[tx_v3_parent[\"new_utxos\"][0], utxo_unrelated_conflict], fee_per_output=fee_to_beat, version=3, target_feerate=2*feerate_to_beat\r\n         )\r\n         node.sendrawtransaction(tx_v3_child_3[\"hex\"])\r\n         self.check_mempool(txids_v2_100 + [tx_v3_parent[\"txid\"], tx_v3_child_3[\"txid\"]])\r\n+        assert get_ancestor_feerate(tx_v3_child_3[\"txid\"]) > feerate_to_beat\r\n \r\n     @cleanup(extra_args=[\"-acceptnonstdtxn=1\"])\r\n     def test_reorg_sibling_eviction_1p2c(self):\r\ndiff --git a/test/functional/test_framework/wallet.py b/test/functional/test_framework/wallet.py\r\nindex 470ed08ed4..1e31ad6139 100644\r\n--- a/test/functional/test_framework/wallet.py\r\n+++ b/test/functional/test_framework/wallet.py\r\n@@ -292,6 +292,7 @@ class MiniWallet:\r\n         fee_per_output=1000,\r\n         target_weight=0,\r\n         confirmed_only=False,\r\n+        target_feerate=None\r\n     ):\r\n         \"\"\"\r\n         Create and return a transaction that spends the given UTXOs and creates a\r\n@@ -322,6 +323,20 @@ class MiniWallet:\r\n         if target_weight:\r\n             self._bulk_tx(tx, target_weight)\r\n \r\n+        # If a certain feerate is required, use the size we just calculated to\r\n+        # adjust the outputs, so that we achieve the target feerate.\r\n+        if target_feerate:\r\n+            additional_fee = target_feerate * tx.get_vsize() - fee\r\n+            if (additional_fee > 0):\r\n+                reduce_amount = additional_fee // num_outputs\r\n+                outputs_value_total = 0\r\n+                for i in range(num_outputs):\r\n+                    tx.vout[i].nValue -= int(reduce_amount)\r\n+                    assert tx.vout[i].nValue > 0\r\n+                    outputs_value_total += tx.vout[i].nValue\r\n+                self.sign_tx(tx)\r\n+                fee = Decimal(inputs_value_total - outputs_value_total) / COIN\r\n+\r\n         txid = tx.rehash()\r\n         return {\r\n```",
      "commit_id" : "f8a141c2dae2471a7ce7248e28a0bbeb8a291acd",
      "created_at" : "2024-05-02T18:01:54Z",
      "diff_hunk" : "@@ -536,7 +536,7 @@ def test_v3_sibling_eviction(self):\n         fee_to_beat_child2 = int(tx_v3_child_2[\"fee\"] * COIN)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29986#discussion_r1588067475",
      "id" : 1588067475,
      "in_reply_to_id" : 1583032012,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ep_yT",
      "original_commit_id" : "c2efe9f77549ff67a623d725abf7ac7390aeef3e",
      "original_line" : 536,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept_v3.py",
      "position" : null,
      "pull_request_review_id" : 2036501466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1588067475/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-02T18:01:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1588067475",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
