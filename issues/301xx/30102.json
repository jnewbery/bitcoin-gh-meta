{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Current behaviour\r\n\r\nMining will fail with a `Could not satisfy difficulty target`.\r\n\r\n```bash\r\nâ¯ ~/2-development/bitcoin/bitcoin-core/contrib/signet/miner --cli \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/src/bitcoin-cli -datadir=/Users/jose.edil/2-development/bitcoin/signet-mining-experiments/signet-fix-hashing\" generate --address tb1qylfujt900rjxzfxjj7sktpu7dpm2n9j60ch7jt --grind-cmd \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/src/bitcoin-util grind\" --nbits 1d008d28 --ongoing\r\n2024-05-14 16:29:05 INFO Mined block at height 10079; next in -324h56m20s (mine)\r\n2024-05-14 16:31:22 INFO Mined block at height 10080; next in -324h56m7s (mine)\r\n2024-05-14 16:32:34 INFO Mined block at height 10081; next in -324h54m49s (mine)\r\nCould not satisfy difficulty target\r\nTraceback (most recent call last):\r\n  File \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/contrib/signet/miner\", line 545, in <module>\r\n    main()\r\n  File \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/contrib/signet/miner\", line 539, in main\r\n    return args.fn(args)\r\n           ^^^^^^^^^^^^^\r\n  File \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/contrib/signet/miner\", line 418, in do_generate\r\n    block = finish_block(block, signet_solution, args.grind_cmd)\r\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/jose.edil/2-development/bitcoin/bitcoin-core/contrib/signet/miner\", line 107, in finish_block\r\n    newheadhex = subprocess.run(cmd, stdout=subprocess.PIPE, input=b\"\", check=True).stdout.strip()\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/opt/local/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/subprocess.py\", line 571, in run\r\n    raise CalledProcessError(retcode, process.args,\r\nsubprocess.CalledProcessError: Command '['/Users/jose.edil/2-development/bitcoin/bitcoin-core/src/bitcoin-util', 'grind', '0000002063d19ae45a71b26fc04ddeef152919d2ecc22ed936ea7129d3bf291f03000000703be9fb35f03fc17b9b3210ac8364c1b76888d793397b7686128107d21c0b4a39e33166ac77031d00000000']' returned non-zero exit status 1.\r\n```\r\n\r\nThis is a follow-up of the discussion in #30091: I started a signet with difficulty `--nbits 1d008d28` and mined the first block with a date 30 days in the past. That would let the miner run as fast as it can until difficulty is so high it will converge to the 10 minute average time between blocks.\r\n\r\nAfter each 2016 blocks, the difficulty is adjusted as per the network consensus and it gets increasingly harder to find new blocks. After 5 adjustments, the grinder eventually exhausts the nonce search space and fails, making the python script to fail as well.\r\n\r\nI inspected the [bitcoin-util grinder source](https://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/src/bitcoin-util.cpp#L85-L147), but could not find any problem there. Indeed, it does what one would expect: look for PoW and fail if the `nonce` search space is exhausted. That's where the stdout message comes.\r\n\r\n### Expected behaviour\r\n\r\nI tracked down the problem [to this section of the code](https://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/contrib/signet/miner#L412-L419). \r\n\r\nThe `finish_block` function should be able to catch the exception that can arise from the grinder subprocess and in case of failure try another block header. In case of signet, I believe it is a matter of resigning it [as in](https://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/contrib/signet/miner#L412) and looking for PoW again until it finds something.\r\n\r\nI started a fix to submit a PR, but wanted to see if someone else could reproduce this behavior in the meantime. It's not clear to me how to make a (unit) test to systematically expose the problem, though.\r\n\r\n### Steps to reproduce\r\n\r\nFollow the outline discussed in #30091 and let the miner run (for a few hours) until the difficulty gets high enough so that one needs a bigger search space to find valid PoW for new blocks.\r\n\r\n### Relevant log output\r\n\r\nCurrent chain info\r\n\r\n```bash\r\nâ¯ ~/2-development/bitcoin/bitcoin-core/src/bitcoin-cli -datadir=\"/Users/jose.edil/2-development/bitcoin/signet-mining-experiments/signet-fix-hashing\" -signet getblockchaininfo\r\n{\r\n  \"chain\": \"signet\",\r\n  \"blocks\": 10081,\r\n  \"headers\": 10081,\r\n  \"bestblockhash\": \"000000031f29bfd32971ea36d92ec2ecd2192915efde4dc06fb2715ae49ad163\",\r\n  \"difficulty\": 0.2883904525532027,\r\n  \"time\": 1714545315,\r\n  \"mediantime\": 1714544565,\r\n  \"verificationprogress\": 1,\r\n  \"initialblockdownload\": true,\r\n  \"chainwork\": \"000000000000000000000000000000000000000000000000000000c3e464c5fc\",\r\n  \"size_on_disk\": 4153462,\r\n  \"pruned\": false,\r\n  \"warnings\": \"\"\r\n}\r\n```\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\nCompiled from source\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\nv27.0\r\n\r\n### Operating system and version\r\n\r\nMacOS Sonoma 14.4\r\n\r\n### Machine specifications\r\n\r\nMacbook Pro M3 Pro\r\n18GB Memory",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30102/comments",
   "created_at" : "2024-05-14T20:17:28Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30102/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/30102",
   "id" : 2296347151,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30102/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII586I33oP",
   "number" : 30102,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30102/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30102/timeline",
   "title" : "contrib/signet/miner: grind will fail for high difficulty chain",
   "updated_at" : "2024-05-14T20:22:36Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30102",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/78322931?v=4",
      "events_url" : "https://api.github.com/users/edilmedeiros/events{/privacy}",
      "followers_url" : "https://api.github.com/users/edilmedeiros/followers",
      "following_url" : "https://api.github.com/users/edilmedeiros/following{/other_user}",
      "gists_url" : "https://api.github.com/users/edilmedeiros/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/edilmedeiros",
      "id" : 78322931,
      "login" : "edilmedeiros",
      "node_id" : "MDQ6VXNlcjc4MzIyOTMx",
      "organizations_url" : "https://api.github.com/users/edilmedeiros/orgs",
      "received_events_url" : "https://api.github.com/users/edilmedeiros/received_events",
      "repos_url" : "https://api.github.com/users/edilmedeiros/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/edilmedeiros/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/edilmedeiros/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/edilmedeiros"
   }
}
