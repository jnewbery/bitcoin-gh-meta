{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nWhen running in prune=550 mode, I consistently get the following error about once every 10 days per machine:\r\n\r\nLevelDB read failure: Corruption: block checksum mismatch\r\n\r\nThere is no recovery from this error (reindex doesn't work in prune mode), so the only solution is to nuke the datadir and do a full resync or restore the datadir from a backup.\r\n\r\nSearching the webs, the conventional wisdom is that this is caused by a hardware/disk problem. That is definitely not the case here, as I'll explain. I suspect a bug in the code is causing some thread to write to an incorrect memory location, possibly a memory use-after-free/reallocation/reorganization bug.\r\n\r\nDetails:\r\n\r\nI set up bitcoind in prune=550 mode to run on ten Amazon EC2 t4g.nano instances that each have 512mb ram and a 4 GB gpt3 (SSD) swap drive. The only job the machines have is to track the blockchain and provide RPC information on recent blocks and confirmed transactions. There is a lot of memory pressure and paging when a block comes in, but since speed is not an issue, that shouldn't be a problem.\r\n\r\nAbout once per day, bitcoind on one of the machines reports LevelDB read failure: Corruption: block checksum mismatch and stops working. The only fix is to delete and restore the bitcoin data directory, and then restart bitcoind to sync and catch back up.\r\n\r\nI am virtually certain this is a software bug in bitcoind because (a) Amazon EC2 has some of the most tested and reliable hardware in the world; (b) this problem had shown up on all ten Amazon EC2 instances all running in different EC2 availability zones; (c) Bitcoin Cash Node is also installed on all ten machines, and it has had zero problems. Bitcoin Cash Node forked from bitcoin core a while back and also uses LevelDB, among other commonalities.\r\n\r\nI tried this with the bitcoin binary distributions bitcoin-25.2-aarch64-linux-gnu.tar.gz and bitcoin-26.1-aarch64-linux-gnu.tar.gz, as well as well as bitcoin-25.2 compiled from source, and it made no difference.\r\n\r\nI collected some of the files that have the checksum mismatch and can provide them if someone wants to look for clues on which software component corrupted the data.\n\n### Expected behaviour\n\nI expect to never see a LevelDB data corruption failure.\n\n### Steps to reproduce\n\nbitcoind config file:\r\n\r\ndatadir=/bdata/bitcoin-data\r\n\r\ndiscover=0\r\nlisten=1\r\nmaxconnections=24\r\n\r\npar=1\r\n\r\nblocksonly=1\r\ndbcache=200\r\nmaxsigcachesize=4\r\nprune=550\r\n\r\nmaxmempool=5\r\nblockreconstructionextratxn=1\r\nmaxorphantx=1\r\nmempoolexpiry=1\r\npersistmempool=0\r\n\r\ndisablewallet=1\r\n\r\nserver=1\r\nrpcallowip=127.0.0.1\r\nrpcuser=btc\r\nrpcpassword=btc\r\nrpcworkqueue=40\r\nrpcthreads=1\r\n\r\nprinttoconsole=1\r\nnodebuglogfile=1\r\n\r\n[main]\r\nrpcport=8332\r\nrpcbind=127.0.0.1:8332\r\nbind=[::]:9333\r\nbind=127.0.0.1:8334=onion\n\n### Relevant log output\n\nThis is one example, I have more, they all look the same:\r\n\r\nStarted bitcoind.service.\r\n2024-05-22T17:53:08Z Bitcoin Core version v25.2.0 (release build)\r\n ...\r\n2024-05-22T19:05:51Z UpdateTip: new best=00000000000000000002c656268be2b9e044b5963af0507e16414552aa526d57 height=844603 version=0x237c6000 log2_work=94.939158 tx=1009037420 date='2024-05-22T14:46:04Z' progress=0.999943 cache=72.4MiB(515946txo)\r\n2024-05-22T19:05:57Z UpdateTip: new best=000000000000000000028401d5cd96ea647cc9adae836735615d7dbf64feed6f height=844604 version=0x2f50c000 log2_work=94.939172 tx=1009041112 date='2024-05-22T15:00:11Z' progress=0.999946 cache=73.9MiB(526621txo)\r\n2024-05-22T19:06:00Z Socks5() connect to 78.44.10.186:8333 failed: connection refused\r\n2024-05-22T19:06:03Z UpdateTip: new best=000000000000000000018332b3b2594e340a0dfd150cbc2a852930c0cddaa91b height=844605 version=0x20000000 log2_work=94.939185 tx=1009044861 date='2024-05-22T15:14:46Z' progress=0.999949 cache=75.4MiB(537704txo)\r\n2024-05-22T19:06:05Z Socks5() connect to 2601:283:5080:8540::55d6:8333 failed: general failure\r\n2024-05-22T19:06:12Z UpdateTip: new best=0000000000000000000163e90fef2b79654d0235d68a603f46ac5e41ce62d827 height=844606 version=0x2e000000 log2_work=94.939199 tx=1009048116 date='2024-05-22T15:31:30Z' progress=0.999953 cache=76.8MiB(548883txo)\r\n2024-05-22T19:06:20Z UpdateTip: new best=00000000000000000001a4ce0b96e5a761337a84974d27a694c7b8d2c74b8cf0 height=844607 version=0x27a94000 log2_work=94.939212 tx=1009050900 date='2024-05-22T15:43:50Z' progress=0.999956 cache=78.1MiB(558437txo)\r\n2024-05-22T19:06:26Z UpdateTip: new best=00000000000000000001d82049db35f2dfabccfba593ee3a433f0500c2734f4e height=844608 version=0x274a6000 log2_work=94.939226 tx=1009054026 date='2024-05-22T16:09:29Z' progress=0.999961 cache=79.5MiB(569127txo)\r\n2024-05-22T19:06:49Z Socks5() connect to 212.102.36.243:8333 failed: general failure\r\n2024-05-22T19:07:09Z UpdateTip: new best=00000000000000000003571b667acb77721004099827b38802f77500cd370d8b height=844609 version=0x20000000 log2_work=94.939240 tx=1009057717 date='2024-05-22T16:21:29Z' progress=0.999964 cache=5.4MiB(0txo)\r\n2024-05-22T19:07:17Z LevelDB read failure: Corruption: block checksum mismatch: /bdata/bitcoin-data/chainstate/5847811.ldb\r\n2024-05-22T19:07:17Z Fatal LevelDB error: Corruption: block checksum mismatch: /bdata/bitcoin-data/chainstate/5847811.ldb\r\n2024-05-22T19:07:17Z You can use -debug=leveldb to get more complete diagnostic messages\r\n2024-05-22T19:07:17Z Error: Error reading from database, shutting down.\r\nError: Error reading from database, shutting down.\r\n2024-05-22T19:07:17Z Error reading from database: Fatal LevelDB error: Corruption: block checksum mismatch: /bdata/bitcoin-data/chainstate/5847811.ldb\r\nbitcoind.service: Main process exited, code=dumped, status=6/ABRT\r\nbitcoind.service: Failed with result 'core-dump'.\r\nbitcoind.service: Consumed 16min 43.740s CPU time.\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nbitcoin-25.2-aarch64-linux-gnu.tar.gz and bitcoin-26.1-aarch64-linux-gnu.tar.gz\n\n### Operating system and version\n\nLinux 6.1.87-99.174.amzn2023.aarch64 #1 SMP\n\n### Machine specifications\n\nAmazon EC2 t4g.nano instance (512mb ram) with unlimited CPU\r\nzram driver disabled (sudo yum remove zram-generator, reboot)\r\n14 GB gp3 root drive\r\n4 GB gp3 swap drive\r\n40 GB gp3 data drive for bitcoin blockchain\r\n\r\nNAME          MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS\r\nnvme1n1       259:0    0  40G  0 disk /bdata\r\nnvme2n1       259:1    0   4G  0 disk [SWAP]\r\nnvme0n1       259:2    0  14G  0 disk\r\nâânvme0n1p1   259:3    0  14G  0 part /\r\nâânvme0n1p128 259:4    0  10M  0 part /boot/efi\r\n\r\nIPv4 enabled but not assigned an IP address\r\nIPv6 enabled, assigned an IP address, and routed to internet\r\n\r\nSome machines have Tor installed and enabled for testing (including the one for the log file attached above), but this made no difference in results.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 10,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30159/comments",
   "created_at" : "2024-05-23T15:22:09Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30159/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/30159",
   "id" : 2313204824,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      },
      {
         "color" : "fbca04",
         "default" : false,
         "description" : null,
         "id" : 97470796,
         "name" : "UTXO Db and Indexes",
         "node_id" : "MDU6TGFiZWw5NzQ3MDc5Ng==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes"
      },
      {
         "color" : "f7c6c7",
         "default" : false,
         "description" : null,
         "id" : 323697996,
         "name" : "Data corruption",
         "node_id" : "MDU6TGFiZWwzMjM2OTc5OTY=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Data%20corruption"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30159/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII586J4LRY",
   "number" : 30159,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30159/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30159/timeline",
   "title" : "LevelDB read failure: Corruption: block checksum mismatch",
   "updated_at" : "2024-05-23T20:20:35Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30159",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/7013474?v=4",
      "events_url" : "https://api.github.com/users/apulsifer/events{/privacy}",
      "followers_url" : "https://api.github.com/users/apulsifer/followers",
      "following_url" : "https://api.github.com/users/apulsifer/following{/other_user}",
      "gists_url" : "https://api.github.com/users/apulsifer/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/apulsifer",
      "id" : 7013474,
      "login" : "apulsifer",
      "node_id" : "MDQ6VXNlcjcwMTM0NzQ=",
      "organizations_url" : "https://api.github.com/users/apulsifer/orgs",
      "received_events_url" : "https://api.github.com/users/apulsifer/received_events",
      "repos_url" : "https://api.github.com/users/apulsifer/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/apulsifer/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/apulsifer/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/apulsifer"
   }
}
