[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30118).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2024-05-15T20:58:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30118#issuecomment-2113445276",
      "id" : 2113445276,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30118",
      "node_id" : "IC_kwDOABII5859-J2c",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113445276/reactions"
      },
      "updated_at" : "2024-05-15T20:58:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113445276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30118#discussion_r1603491415"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30118"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603491415"
         }
      },
      "author_association" : "NONE",
      "body" : "Looking at the sample output of `subversion` - `\"subversion\": \"\\/Satoshi:25.1.0\\/\"`, it doesn't seem unique enough because multiple nodes can be running the same version. Won't this cause issues in `find_conn` later?\r\n\r\nhttps://chainquery.com/bitcoin-cli/getnetworkinfo",
      "commit_id" : "59ba8735102aebd456bb9dc831759c82e95763c0",
      "created_at" : "2024-05-16T14:31:16Z",
      "diff_hunk" : "@@ -627,19 +625,28 @@ def connect_nodes(self, a, b, *, peer_advertises_v2=None, wait_for_connect: bool\n         if not wait_for_connect:\n             return\n \n+        # Use subversion as peer id\n+        from_connection_subver = from_connection.getnetworkinfo()['subversion']\n+        to_connection_subver = to_connection.getnetworkinfo()['subversion']",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30118#discussion_r1603491415",
      "id" : 1603491415,
      "line" : 630,
      "node_id" : "PRRC_kwDOABII585fk1ZX",
      "original_commit_id" : "59ba8735102aebd456bb9dc831759c82e95763c0",
      "original_line" : 630,
      "original_position" : 15,
      "original_start_line" : 629,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : 15,
      "pull_request_review_id" : 2060988698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30118",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603491415/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 629,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-16T14:37:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603491415",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30118#discussion_r1603498152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30118"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603498152"
         }
      },
      "author_association" : "NONE",
      "body" : "`find_conn(from_connection, to_connection_subver, inbound=False)`\r\n\r\nMight as well make these calls once and store in variable instead of finding 3 times? Unless I'm missing something that requires these calls to be made every time. \r\n",
      "commit_id" : "59ba8735102aebd456bb9dc831759c82e95763c0",
      "created_at" : "2024-05-16T14:35:23Z",
      "diff_hunk" : "@@ -627,19 +625,28 @@ def connect_nodes(self, a, b, *, peer_advertises_v2=None, wait_for_connect: bool\n         if not wait_for_connect:\n             return\n \n+        # Use subversion as peer id\n+        from_connection_subver = from_connection.getnetworkinfo()['subversion']\n+        to_connection_subver = to_connection.getnetworkinfo()['subversion']\n+\n+        def find_conn(node, peer_subversion, inbound):\n+            return next(filter(lambda peer: peer['subver'] == peer_subversion and peer['inbound'] == inbound, node.getpeerinfo()), None)\n+\n         # poll until version handshake complete to avoid race conditions\n         # with transaction relaying\n         # See comments in net_processing:\n         # * Must have a version message before anything else\n         # * Must have a verack message before anything else\n-        self.wait_until(lambda: sum(peer['version'] != 0 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer['version'] != 0 for peer in to_connection.getpeerinfo()) == to_num_peers)\n-        self.wait_until(lambda: sum(peer['bytesrecv_per_msg'].pop('verack', 0) >= 21 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer['bytesrecv_per_msg'].pop('verack', 0) >= 21 for peer in to_connection.getpeerinfo()) == to_num_peers)\n+        self.wait_until(lambda: find_conn(from_connection, to_connection_subver, inbound=False) is not None)\n+        self.wait_until(lambda: find_conn(to_connection, from_connection_subver, inbound=True) is not None)\n+\n+        self.wait_until(lambda: (peer := find_conn(from_connection, to_connection_subver, inbound=False)) is not None and peer['bytesrecv_per_msg'].pop('verack', 0) >= 21)\n+        self.wait_until(lambda: (peer := find_conn(to_connection, from_connection_subver, inbound=True)) is not None and peer['bytesrecv_per_msg'].pop('verack', 0) >= 21)\n+\n         # The message bytes are counted before processing the message, so make\n         # sure it was fully processed by waiting for a ping.\n-        self.wait_until(lambda: sum(peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 29 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 29 for peer in to_connection.getpeerinfo()) == to_num_peers)\n+        self.wait_until(lambda: (peer := find_conn(from_connection, to_connection_subver, inbound=False)) is not None and peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 29)\n+        self.wait_until(lambda: (peer := find_conn(to_connection, from_connection_subver, inbound=True)) is not None and peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 29)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30118#discussion_r1603498152",
      "id" : 1603498152,
      "line" : 649,
      "node_id" : "PRRC_kwDOABII585fk3Co",
      "original_commit_id" : "59ba8735102aebd456bb9dc831759c82e95763c0",
      "original_line" : 649,
      "original_position" : 40,
      "original_start_line" : 648,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : 40,
      "pull_request_review_id" : 2060988698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30118",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603498152/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 648,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-16T14:37:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603498152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30118#discussion_r1603654247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30118"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603654247"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Looking at the sample output of `subversion` - `\"subversion\": \"\\/Satoshi:25.1.0\\/\"`, it doesn't seem unique enough because multiple nodes can be running the same version. Won't this cause issues in `find_conn` later?\r\n\r\nThe test framework appends the node number to the user agent string. See [test_node](https://github.com/bitcoin/bitcoin/blob/2f53f2273da020d7fabd7c65a1bc7e69a31249b2/test/functional/test_framework/test_node.py#L109).",
      "commit_id" : "59ba8735102aebd456bb9dc831759c82e95763c0",
      "created_at" : "2024-05-16T16:02:53Z",
      "diff_hunk" : "@@ -627,19 +625,28 @@ def connect_nodes(self, a, b, *, peer_advertises_v2=None, wait_for_connect: bool\n         if not wait_for_connect:\n             return\n \n+        # Use subversion as peer id\n+        from_connection_subver = from_connection.getnetworkinfo()['subversion']\n+        to_connection_subver = to_connection.getnetworkinfo()['subversion']",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30118#discussion_r1603654247",
      "id" : 1603654247,
      "in_reply_to_id" : 1603491415,
      "line" : 630,
      "node_id" : "PRRC_kwDOABII585fldJn",
      "original_commit_id" : "59ba8735102aebd456bb9dc831759c82e95763c0",
      "original_line" : 630,
      "original_position" : 15,
      "original_start_line" : 629,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : 15,
      "pull_request_review_id" : 2061247415,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30118",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603654247/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 629,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-16T16:19:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603654247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30118#discussion_r1603657305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30118"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603657305"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Might as well make these calls once and store in variable instead of finding 3 times? Unless I'm missing something that requires these calls to be made every time.\r\n\r\nThe code waits until the data arrives. These requires polling for updates.\r\nWe could couple the checks in this way:\r\n```python3\r\n self.wait_until(lambda: (peer := find_conn(from_connection, to_connection_subver, inbound=False)) is not None\r\n                                and peer['version'] != 0\r\n                                and peer['bytesrecv_per_msg'].pop('verack', 0) >= 21)\r\n```\r\n\r\nBut I'm a ~0 here because it would make debugging harder.",
      "commit_id" : "59ba8735102aebd456bb9dc831759c82e95763c0",
      "created_at" : "2024-05-16T16:05:19Z",
      "diff_hunk" : "@@ -627,19 +625,28 @@ def connect_nodes(self, a, b, *, peer_advertises_v2=None, wait_for_connect: bool\n         if not wait_for_connect:\n             return\n \n+        # Use subversion as peer id\n+        from_connection_subver = from_connection.getnetworkinfo()['subversion']\n+        to_connection_subver = to_connection.getnetworkinfo()['subversion']\n+\n+        def find_conn(node, peer_subversion, inbound):\n+            return next(filter(lambda peer: peer['subver'] == peer_subversion and peer['inbound'] == inbound, node.getpeerinfo()), None)\n+\n         # poll until version handshake complete to avoid race conditions\n         # with transaction relaying\n         # See comments in net_processing:\n         # * Must have a version message before anything else\n         # * Must have a verack message before anything else\n-        self.wait_until(lambda: sum(peer['version'] != 0 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer['version'] != 0 for peer in to_connection.getpeerinfo()) == to_num_peers)\n-        self.wait_until(lambda: sum(peer['bytesrecv_per_msg'].pop('verack', 0) >= 21 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer['bytesrecv_per_msg'].pop('verack', 0) >= 21 for peer in to_connection.getpeerinfo()) == to_num_peers)\n+        self.wait_until(lambda: find_conn(from_connection, to_connection_subver, inbound=False) is not None)\n+        self.wait_until(lambda: find_conn(to_connection, from_connection_subver, inbound=True) is not None)\n+\n+        self.wait_until(lambda: (peer := find_conn(from_connection, to_connection_subver, inbound=False)) is not None and peer['bytesrecv_per_msg'].pop('verack', 0) >= 21)\n+        self.wait_until(lambda: (peer := find_conn(to_connection, from_connection_subver, inbound=True)) is not None and peer['bytesrecv_per_msg'].pop('verack', 0) >= 21)\n+\n         # The message bytes are counted before processing the message, so make\n         # sure it was fully processed by waiting for a ping.\n-        self.wait_until(lambda: sum(peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 29 for peer in from_connection.getpeerinfo()) == from_num_peers)\n-        self.wait_until(lambda: sum(peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 29 for peer in to_connection.getpeerinfo()) == to_num_peers)\n+        self.wait_until(lambda: (peer := find_conn(from_connection, to_connection_subver, inbound=False)) is not None and peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 29)\n+        self.wait_until(lambda: (peer := find_conn(to_connection, from_connection_subver, inbound=True)) is not None and peer[\"bytesrecv_per_msg\"].pop(\"pong\", 0) >= 29)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30118#discussion_r1603657305",
      "id" : 1603657305,
      "in_reply_to_id" : 1603498152,
      "line" : 649,
      "node_id" : "PRRC_kwDOABII585fld5Z",
      "original_commit_id" : "59ba8735102aebd456bb9dc831759c82e95763c0",
      "original_line" : 649,
      "original_position" : 40,
      "original_start_line" : 648,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : 40,
      "pull_request_review_id" : 2061247415,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30118",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603657305/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 648,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-16T16:19:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603657305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
