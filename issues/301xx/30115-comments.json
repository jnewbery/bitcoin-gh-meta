[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30115).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/30115#pullrequestreview-2058984290) |\n| Concept ACK | [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2115032923), [hebasto](https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2115594712), [laanwj](https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2115934921), [stickies-v](https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2117153581), [willcl-ark](https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2117545232) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2024-05-15T18:52:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2113242001",
      "id" : 2113242001,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII58599YOR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113242001/reactions"
      },
      "updated_at" : "2024-05-17T17:00:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113242001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I didn't check exhaustively, though, since that would be a lot more work and I think we have a clang-tidy check that would catch those cases.\r\n\r\nIndeed, I believe c-i should be doing that check. But just in case, from the PR description:\r\n\r\n> I ran these changes through clang-tidy with performance-move-const-arg and bugprone-use-after-move and no bugs were detected (though that's obviously not to say it can be trusted 100%).",
      "created_at" : "2024-05-16T01:44:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2113778062",
      "id" : 2113778062,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII5859_bGO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113778062/reactions"
      },
      "updated_at" : "2024-05-16T01:46:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113778062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nCould this be a case for a clang-tidy plugin?",
      "created_at" : "2024-05-16T11:56:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2115032923",
      "id" : 2115032923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-ENdb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115032923/reactions"
      },
      "updated_at" : "2024-05-16T11:56:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115032923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Could this be a case for a clang-tidy plugin?\r\n\r\nI considered this, but I don't think so. UniValue copies are reasonable in many cases, but our use of them often lends itself to moving. So we can't detect and disable copies as a rule, and (I assume) if clang-tidy could detect and suggest possible moves as optimizations, it would be offering a generic version of that already.\r\n\r\nHere's an upstream discussion about it that has apparently gone stale: https://github.com/llvm/llvm-project/issues/53489",
      "created_at" : "2024-05-16T15:45:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2115593653",
      "id" : 2115593653,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-GWW1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115593653/reactions"
      },
      "updated_at" : "2024-05-16T15:45:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115593653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2024-05-16T15:45:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2115594712",
      "id" : 2115594712,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-GWnY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115594712/reactions"
      },
      "updated_at" : "2024-05-16T15:45:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115594712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-05-16T15:51:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2115606772",
      "id" : 2115606772,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-GZj0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115606772/reactions"
      },
      "updated_at" : "2024-05-16T15:51:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115606772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Could this be a case for a clang-tidy plugin?\r\n\r\nI think the ideal thing to do for types that are potentially expensive to copy is to disable implicit copies, but provide explicit `T Copy() const` and `void CopyFrom(const T&)` methods so copies can be made where needed. (There was a `DISABLE_IMPLICIT_COPIES` macro proposed in #24641 that tried to do this, but it didn't seem possible to generalize the implementation so we never added it.) It think it would be probably be reasonable to allow univalue to be explicitly but not implicitly copied, but I'm sure @theuni would have a better intuition.",
      "created_at" : "2024-05-16T15:57:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2115622164",
      "id" : 2115622164,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-GdUU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115622164/reactions"
      },
      "updated_at" : "2024-05-16T15:57:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115622164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nAgree with @ryanofsky that if copy is something expensive (or generally undesirable) to do, it would make sense to make copy explicit, so that it is always a deliberate choice and stands out in code review.",
      "created_at" : "2024-05-16T18:29:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2115934921",
      "id" : 2115934921,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-HprJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115934921/reactions"
      },
      "updated_at" : "2024-05-16T18:32:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2115934921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\n> Indeed, I believe c-i should be doing that check.\r\n\r\nIt does: https://github.com/bitcoin/bitcoin/blob/2f53f2273da020d7fabd7c65a1bc7e69a31249b2/src/.clang-tidy#L6",
      "created_at" : "2024-05-17T09:39:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2117153581",
      "id" : 2117153581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-MTMt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2117153581/reactions"
      },
      "updated_at" : "2024-05-17T09:39:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2117153581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nThe code changes all look correct to me too, however\r\n\r\n> @willcl-ark, however, noticed that memory usage may increase in some cases. Logically this makes no sense to me. The only plausible explanation imo is that because the moves are faster, more ops/second occur in some cases.\r\n\r\nI still have not been able to explain why i see these type of results, but I think it's most likely user error somewhere along the line.\r\n\r\nHere is one example of a puzzling result I have, in this test fetching every 5000th block via REST (previously largely addressed by #30094). In all screenshots **this PR is on the right hand side**:\r\n\r\nWe can see here this PR made 96m allocations, vs 137m, a strict improvement?\r\n\r\n![screenshot_20240517-131022](https://github.com/bitcoin/bitcoin/assets/6606587/158b4f0d-2509-498c-b9d6-857b86c44570)\r\n\r\nThe unnecessary calls to allocator functions are clearly gotten rid of:\r\n\r\n![screenshot_20240517-131039](https://github.com/bitcoin/bitcoin/assets/6606587/731fdcec-bdb5-423d-aa60-4ae7a3529b3c)\r\n\r\nHowever despite that total resource usage increases, albeit only a little, ~10MB (also see first image) :\r\n\r\n![screenshot_20240517-131046](https://github.com/bitcoin/bitcoin/assets/6606587/a120b44e-8db7-42e4-b61b-03740f7f1893)\r\n\r\n![easy-univalue-moves-comparison](https://github.com/bitcoin/bitcoin/assets/6606587/c89ab584-536f-4086-9e92-a0de07d81562)\r\n\r\nThe changes in this PR which affect this test (since #30094) are in [core_write.cpp](https://github.com/bitcoin/bitcoin/pull/30115/files#diff-48fa743e653b0ceebb1e454766c5a2e70981a44503eca6adf24895016db9eb26)\r\n\r\nI guess this may just be allocator stuff I might never get to the bottom of, but I will continue to investigate this for a little bit before bringing a full ACK back :)\r\n\r\nFWIW these changes **did** provide a measurable speedup on my test, roughly of this order:\r\n\r\n- this PR: ~ 1:43\r\n- master: ~ 1:55\r\n\r\n\r\n-------\r\n\r\nI also see similar result just fetching a single block (in this case block 800,000). Many fewer allocations, but larger total usage:\r\n\r\n![screenshot_20240517-134351](https://github.com/bitcoin/bitcoin/assets/6606587/24721337-4151-4693-8789-6661115f32e1)\r\n\r\n![screenshot_20240517-134513](https://github.com/bitcoin/bitcoin/assets/6606587/cf711912-bd96-4de5-ab9f-56ef8aab720f)\r\n\r\n\r\nI think the clues may lie in here, but I am too dumb to know what they are. For some reason after this PR a second ~30MB allocation is made. Without this PR there are 37.2MB and 24.0MB allocations made,, and with this PR those are 38.2MB and 30.9MB, and I don't understand why:\r\n\r\n![screenshot_20240517-135346](https://github.com/bitcoin/bitcoin/assets/6606587/9a471ba8-254b-4b6c-bde8-458c431e4ab8)\r\n\r\nheaptrack dumps in case anyone else wants to take a look:\r\n\r\n[heaptrack_dumps.zip](https://github.com/bitcoin/bitcoin/files/15349481/heaptrack_dumps.zip)\r\n\r\n",
      "created_at" : "2024-05-17T12:56:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2117545232",
      "id" : 2117545232,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-Ny0Q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2117545232/reactions"
      },
      "updated_at" : "2024-05-17T12:56:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2117545232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@willcl-ark Thanks, that's very helpful. Out of curiosity, what build options are you using for these? Are optimizations on?",
      "created_at" : "2024-05-17T17:00:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2118018627",
      "id" : 2118018627,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-PmZD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2118018627/reactions"
      },
      "updated_at" : "2024-05-17T17:00:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2118018627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Maybe rebase and re-bench after 75118a608fc22a57567743000d636bc1f969f748, which replaced some copies with moves as well?",
      "created_at" : "2024-05-20T15:05:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2120649012",
      "id" : 2120649012,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-Zok0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2120649012/reactions"
      },
      "updated_at" : "2024-05-20T15:05:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2120649012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Maybe rebase and re-bench after [75118a6](https://github.com/bitcoin/bitcoin/commit/75118a608fc22a57567743000d636bc1f969f748), which replaced some copies with moves as well?\r\n\r\nAh, great, thanks for pointing me to that. I had pretty much this same commit locally to address the third point in this PR's description:\r\n> - Refactoring functions to accept UniValues by value rather than by const reference\r\n\r\nThough I think there are still other functions that need the same treatment.",
      "created_at" : "2024-05-20T15:23:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30115#issuecomment-2120681426",
      "id" : 2120681426,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30115",
      "node_id" : "IC_kwDOABII585-ZwfS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2120681426/reactions"
      },
      "updated_at" : "2024-05-20T15:23:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2120681426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
