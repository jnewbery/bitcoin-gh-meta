[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30000).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [instagibbs](https://github.com/bitcoin/bitcoin/pull/30000#pullrequestreview-2055134670), [AngusP](https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2110638042), [theStack](https://github.com/bitcoin/bitcoin/pull/30000#pullrequestreview-2055922168), [sr-gi](https://github.com/bitcoin/bitcoin/pull/30000#pullrequestreview-2056028500), [stickies-v](https://github.com/bitcoin/bitcoin/pull/30000#pullrequestreview-2053065161), [itornaza](https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2110867498) |\n| Stale ACK | [mzumsande](https://github.com/bitcoin/bitcoin/pull/30000#pullrequestreview-2053800837) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.\n",
      "created_at" : "2024-04-29T20:59:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2083652023",
      "id" : 2083652023,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII5858MgG3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083652023/reactions"
      },
      "updated_at" : "2024-05-14T18:34:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083652023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/24396449433</sub>",
      "created_at" : "2024-04-29T23:14:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2083841166",
      "id" : 2083841166,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII5858NOSO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083841166/reactions"
      },
      "updated_at" : "2024-04-29T23:14:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083841166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Will fix the linter when I rebase",
      "created_at" : "2024-04-30T15:26:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2085668407",
      "id" : 2085668407,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII5858UMY3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2085668407/reactions"
      },
      "updated_at" : "2024-04-30T15:26:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2085668407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586372606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586372606"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    /** Check if we already have an orphan transaction */\r\n```",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-01T14:43:09Z",
      "diff_hunk" : "@@ -24,7 +24,7 @@ class TxOrphanage {\n     bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586372606",
      "id" : 1586372606,
      "line" : 26,
      "node_id" : "PRRC_kwDOABII585ejh_-",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 26,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : 3,
      "pull_request_review_id" : 2033751635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586372606/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-01T19:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586372606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586410875"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586410875"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: looks like this is only used for logging (and thus can be declared right before the logging) - do we still want/need to log the txid? I'd think wtxid suffices? But nvm if that's contentious.",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-01T15:14:59Z",
      "diff_hunk" : "@@ -54,18 +52,19 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n     return true;\n }\n \n-int TxOrphanage::EraseTx(const Txid& txid)\n+int TxOrphanage::EraseTx(const Wtxid& wtxid)\n {\n     LOCK(m_mutex);\n-    return EraseTxNoLock(txid);\n+    return EraseTxNoLock(wtxid);\n }\n \n-int TxOrphanage::EraseTxNoLock(const Txid& txid)\n+int TxOrphanage::EraseTxNoLock(const Wtxid& wtxid)\n {\n     AssertLockHeld(m_mutex);\n-    std::map<Txid, OrphanTx>::iterator it = m_orphans.find(txid);\n+    std::map<Wtxid, OrphanTx>::iterator it = m_orphans.find(wtxid);\n     if (it == m_orphans.end())\n         return 0;\n+    const auto& txid = it->second.tx->GetHash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586410875",
      "id" : 1586410875,
      "line" : 67,
      "node_id" : "PRRC_kwDOABII585ejrV7",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 67,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 42,
      "pull_request_review_id" : 2033751635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586410875/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-01T19:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586410875",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586417487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586417487"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: can't we just use `first`?\r\n```suggestion\r\n            nErased += EraseTxNoLock(maybeErase->first);\r\n```",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-01T15:21:51Z",
      "diff_hunk" : "@@ -101,13 +98,13 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     m_peer_work_set.erase(peer);\n \n     int nErased = 0;\n-    std::map<Txid, OrphanTx>::iterator iter = m_orphans.begin();\n+    std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\n     while (iter != m_orphans.end())\n     {\n-        std::map<Txid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n         if (maybeErase->second.fromPeer == peer)\n         {\n-            nErased += EraseTxNoLock(maybeErase->second.tx->GetHash());\n+            nErased += EraseTxNoLock(maybeErase->second.tx->GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586417487",
      "id" : 1586417487,
      "line" : 107,
      "node_id" : "PRRC_kwDOABII585ejs9P",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 107,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 70,
      "pull_request_review_id" : 2033751635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586417487/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-01T19:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586417487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586473749"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586473749"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```Suggestion\r\n    if (m_orphanage.HaveTx(Wtxid::FromUint256(hash))) return true;\r\n```",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-01T16:19:56Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586473749",
      "id" : 1586473749,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585ej6sV",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2033911780,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586473749/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-01T16:33:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586473749",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586533521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586533521"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: can just one-line\r\n```suggestion\r\n                            Assert(orphanage.HaveTx(ref->GetWitnessHash()));\r\n```",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-01T17:20:10Z",
      "diff_hunk" : "@@ -112,21 +112,21 @@ FUZZ_TARGET(txorphan, .init = initialize_orphanage)\n                     {\n                         CTransactionRef ref = orphanage.GetTxToReconsider(peer_id);\n                         if (ref) {\n-                            bool have_tx = orphanage.HaveTx(GenTxid::Txid(ref->GetHash())) || orphanage.HaveTx(GenTxid::Wtxid(ref->GetWitnessHash()));\n+                            bool have_tx = orphanage.HaveTx(ref->GetWitnessHash());\n                             Assert(have_tx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586533521",
      "id" : 1586533521,
      "line" : 116,
      "node_id" : "PRRC_kwDOABII585ekJSR",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 116,
      "original_position" : 6,
      "original_start_line" : 115,
      "path" : "src/test/fuzz/txorphan.cpp",
      "position" : 6,
      "pull_request_review_id" : 2033751635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586533521/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 115,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-01T19:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586533521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "should be able to add fuzz coverage easily for differing wtxids but same txids in `src/test/fuzz/txorphan.cpp`",
      "created_at" : "2024-05-01T18:20:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2088877822",
      "id" : 2088877822,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII5858gb7-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2088877822/reactions"
      },
      "updated_at" : "2024-05-01T18:20:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2088877822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586638555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586638555"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Or alternatively:\r\n\r\n<details>\r\n<summary>git diff on 4b4dfaa8f3</summary>\r\n\r\n```diff\r\ndiff --git a/src/txorphanage.cpp b/src/txorphanage.cpp\r\nindex 504a1f7ec3..bed92e6b32 100644\r\n--- a/src/txorphanage.cpp\r\n+++ b/src/txorphanage.cpp\r\n@@ -98,13 +98,11 @@ void TxOrphanage::EraseForPeer(NodeId peer)\r\n     m_peer_work_set.erase(peer);\r\n \r\n     int nErased = 0;\r\n-    std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\r\n-    while (iter != m_orphans.end())\r\n-    {\r\n-        std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\r\n-        if (maybeErase->second.fromPeer == peer)\r\n+    for (auto iter = m_orphans.begin(); iter != m_orphans.end(); ) {\r\n+        const auto& [wtxid, tx] = *iter++; // increment to avoid iterator becoming invalid\r\n+        if (tx.fromPeer == peer)\r\n         {\r\n-            nErased += EraseTxNoLock(maybeErase->second.tx->GetWitnessHash());\r\n+            nErased += EraseTxNoLock(wtxid);\r\n         }\r\n     }\r\n     if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);\r\n\r\n```\r\n</details>\r\n",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-01T18:45:17Z",
      "diff_hunk" : "@@ -101,13 +98,13 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     m_peer_work_set.erase(peer);\n \n     int nErased = 0;\n-    std::map<Txid, OrphanTx>::iterator iter = m_orphans.begin();\n+    std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\n     while (iter != m_orphans.end())\n     {\n-        std::map<Txid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n         if (maybeErase->second.fromPeer == peer)\n         {\n-            nErased += EraseTxNoLock(maybeErase->second.tx->GetHash());\n+            nErased += EraseTxNoLock(maybeErase->second.tx->GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586638555",
      "id" : 1586638555,
      "in_reply_to_id" : 1586417487,
      "line" : 107,
      "node_id" : "PRRC_kwDOABII585eki7b",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 107,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 70,
      "pull_request_review_id" : 2033751635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586638555/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-01T19:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586638555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586713579"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586713579"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's not immediately obvious to me why it is safe to just convert any `gtxid` into a `Wtxid` here, especially since there are callsites of `AlreadyHaveTx` where a ` GenTxId::Txid` is passed, such as e.g. [here](https://github.com/bitcoin/bitcoin/blob/d73245abc70346a0e8805d50a1f395706084294c/src/net_processing.cpp#L4632). If it is indeed safe, I think it could be a better approach to update `AlreadyHaveTx` to take a `Wtxid` and push the conversion further to the edge, so it can be reviewed on a case-by-case basis?",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-01T19:24:21Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586713579",
      "id" : 1586713579,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585ek1Pr",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2033751635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586713579/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2298,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-01T19:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586713579",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586884665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586884665"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(Ignore me if I'm understanding) -- coinbase transactions are [required to have all `0` Wtxids](https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#commitment-structure) (`0x0000....0000`) which means for an `INV` message for a witness coinbase you have to use the non-witness txid to reference the transaction? - so `AlreadyHaveTx` in that case is explicitly *not* using a Wtxid? (Or are coinbases never `INV`'d?)\r\n\r\nAlso perhaps not great/confusing to treat Wtxid and Txids as always interchangeable (though the types allow it) because of the coinbase Wtxid caveat?",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-01T22:22:51Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1586884665",
      "id" : 1586884665,
      "in_reply_to_id" : 1586713579,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585elfA5",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2034556058,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586884665/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2298,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T08:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586884665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1328814?v=4",
         "events_url" : "https://api.github.com/users/AngusP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AngusP/followers",
         "following_url" : "https://api.github.com/users/AngusP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AngusP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AngusP",
         "id" : 1328814,
         "login" : "AngusP",
         "node_id" : "MDQ6VXNlcjEzMjg4MTQ=",
         "organizations_url" : "https://api.github.com/users/AngusP/orgs",
         "received_events_url" : "https://api.github.com/users/AngusP/received_events",
         "repos_url" : "https://api.github.com/users/AngusP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AngusP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AngusP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AngusP"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587460520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587460520"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> It's not immediately obvious to me why it is safe to just convert any gtxid into a Wtxid here\r\n\r\nThe argument I'm making in this PR is that in all the places we are checking by txid, we shouldn't be doing that, because we're missing same-txid-different-witness cases. But yeah totally fair to say it's difficult to review it together, so I'll split the first commit to make it more explicit where the change is happening and why that's ok.\r\n\r\n>  I think it could be a better approach to update AlreadyHaveTx to take a Wtxid\r\n\r\nfwiw I disagree, as we do want to check txids in the other data structures.\r\n\r\n> coinbase transactions are [required to have all 0 Wtxids](https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#commitment-structure) (0x0000....0000) which means for an INV message for a witness coinbase you have to use the non-witness txid to reference the transaction? - so AlreadyHaveTx in that case is explicitly not using a Wtxid? (Or are coinbases never INV'd?)\r\n\r\nThat link is referring to the wtxid of the coinbase transaction when calculating the witness commitment; that's not the case in any other situation. Also, yes, if we get a coinbase transaction in tx relay we'd drop that pretty much immediately and wouldn't be putting it in orphanage:\r\nhttps://github.com/bitcoin/bitcoin/blob/9d1a286f20b8a602ffe72928bcd79be09fdbf9d0/src/validation.cpp#L735-L742",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-02T11:12:16Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587460520",
      "id" : 1587460520,
      "in_reply_to_id" : 1586713579,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585enrmo",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2035457852,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587460520/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2298,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T11:12:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587460520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587694422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587694422"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> The argument I'm making in this PR is that in all the places we are checking by txid, we shouldn't be doing that, because we're missing same-txid-different-witness cases.\r\n\r\nI agree, the rationale makes sense. My concern is about segwit txs (`txid != wtxid`) where we check by txid (for whatever reason: intentional because we don't have witness data, legacy and we never updated it, buggy, ...): just creating a wtxid from the txid hash as is done here seems like it has potential to start missing things we previously wouldn't - since `TxOrphanage` now _only_ indexes by `wtxid`?\r\n\r\nI've made a [branch](https://github.com/glozow/bitcoin/compare/2024-04-orphan-use-wtxid...stickies-v:bitcoin:pr/30000) where I've created 2 overloads of `AlreadyHaveTx`: one that takes `Wtxid` and one that takes `Txid`, to force all the conversions to the edges. I implemented the `Txid` to perform less checks, based on the documentation (didn't verify the code) that `m_recent_rejects_reconsiderable` and `m_recent_rejects` uses `wtxid`, whereas `m_recent_confirmed_transactions` uses both `txid` and `wtxid`.\r\n\r\nThere are 4 callsites of `AlreadyHaveTx`. For 2 of them, [1) here](https://github.com/glozow/bitcoin/compare/2024-04-orphan-use-wtxid...stickies-v:bitcoin:pr/30000#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R4255-R4256) and [2) here](https://github.com/glozow/bitcoin/compare/2024-04-orphan-use-wtxid...stickies-v:bitcoin:pr/30000#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R4561), the conversion seems trivial/sensible.\r\n\r\nA third is more confusing to me. [3) Here in `ProcessMessage`](https://github.com/glozow/bitcoin/compare/2024-04-orphan-use-wtxid...stickies-v:bitcoin:pr/30000#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R4663), I initially used the `Txid` overload, but that fails the `p2p_orphan_handling.py::test_orphan_of_orphan` test. Switching to `Wtxid` makes it pass, but I don't understand why. Since with this pull, `TxOrphanage` indexes on `Wtxid`, calling `HaveTx` on a blind conversion of `parent_txid` into a `Wtxid` seems like it shouldn't find anything in the orphanage, unless we're dealing with non-segwit transaction?\r\n\r\nFinally, for the [4) fourth here](https://github.com/glozow/bitcoin/compare/2024-04-orphan-use-wtxid...stickies-v:bitcoin:pr/30000#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R6319-R6341), I think my refactoring is a no-op, we just blindly call the different function signatures based on `GenTxid::IsWtxid()`, no real difference with the current implementation except perhaps for making things more explicit.",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-02T14:03:35Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587694422",
      "id" : 1587694422,
      "in_reply_to_id" : 1586713579,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585eoktW",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2035842164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587694422/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2298,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T14:10:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587694422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587705035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587705035"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "To be clear: I'm not saying this PR needs to overhaul `AlreadyHaveTx` like I did, and I think having `TxOrphanage` index on `Wtxid` instead of `Txid` is better. I just think that if we're going to be calling `TxOrphanage` methods with (what are in fact) txids, we should probably have `TxOrphanage` _also_ keep a `Txid` index and not do blind conversion such as is happening here? I think that would address my concerns and make things easier to review?",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-02T14:08:54Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587705035",
      "id" : 1587705035,
      "in_reply_to_id" : 1586713579,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585eonTL",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2035860350,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587705035/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2298,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T14:09:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587705035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587705703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587705703"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fwiw, I think the in-orphanage txid==wtixd case seems pretty rare all things considered. I had 4 over a 24 hour period, vs about 400 times where we fetched a segwit parent via txid though that particular txid was in the orphanage already.\r\n\r\niow I'm not sure extra complexity is worth it, vs just dropping it altogether(and eating a tiny bit more of bandwidth?)",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-02T14:09:22Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587705703",
      "id" : 1587705703,
      "in_reply_to_id" : 1586713579,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585eondn",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2035861475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587705703/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2298,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T14:11:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587705703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587730485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587730485"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> iow I'm not sure extra complexity is worth it,\r\n\r\nOh, fair enough. I don't have a good enough view of the attack vectors here. In my review, I was operating on the assumption that we wouldn't want to miss anything we're currently doing. If it's okay to relax that, that could make sense - but it should probably be made explicit then?",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-02T14:23:52Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587730485",
      "id" : 1587730485,
      "in_reply_to_id" : 1586713579,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585eotg1",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2035904439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587730485/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2298,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T14:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587730485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587742487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587742487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIUC If the check is removed, you'll waste bandwidth when you get orphan chains that are non-segwit, but you won't keep or relay them, so it shouldn't churn the orphanage.\r\n\r\nWould it help if the comment was touched up to be explicit about what it's saving us from doing?",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-02T14:31:36Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587742487",
      "id" : 1587742487,
      "in_reply_to_id" : 1586713579,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585eowcX",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2035924068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587742487/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2298,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-02T14:31:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587742487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589529436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589529436"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 646aa4da91c03a0e72d086cae281aa0688f2f41d\r\n\r\nThis is only used for logging now. Do we care about logging the `txid` now that the map is keyed by `wtxid`?",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-03T17:40:57Z",
      "diff_hunk" : "@@ -23,7 +23,7 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n \n     const Txid& hash = tx->GetHash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589529436",
      "id" : 1589529436,
      "line" : 24,
      "node_id" : "PRRC_kwDOABII585evktc",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 24,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 2,
      "pull_request_review_id" : 2038712299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589529436/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-03T19:51:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589529436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589547282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589547282"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 646aa4da91c03a0e72d086cae281aa0688f2f41d\r\n\r\nnit: `nErased` is a counter right? Shouldn't this read `txs` instead?",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-03T17:54:15Z",
      "diff_hunk" : "@@ -101,13 +98,13 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     m_peer_work_set.erase(peer);\n \n     int nErased = 0;\n-    std::map<Txid, OrphanTx>::iterator iter = m_orphans.begin();\n+    std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\n     while (iter != m_orphans.end())\n     {\n-        std::map<Txid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n         if (maybeErase->second.fromPeer == peer)\n         {\n-            nErased += EraseTxNoLock(maybeErase->second.tx->GetHash());\n+            nErased += EraseTxNoLock(maybeErase->second.tx->GetWitnessHash());\n         }\n     }\n     if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589547282",
      "id" : 1589547282,
      "line" : 110,
      "node_id" : "PRRC_kwDOABII585evpES",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 110,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 73,
      "pull_request_review_id" : 2038712299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589547282/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-03T19:51:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589547282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589549760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589549760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 646aa4da91c03a0e72d086cae281aa0688f2f41d\r\n\r\nSame here, do we still care about logging `txids`? I guess this applies to all the file, so not pointing it out again",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-03T17:56:16Z",
      "diff_hunk" : "@@ -159,7 +156,7 @@ void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx)\n             for (const auto& elem : it_by_prev->second) {\n                 // Get this source peer's work set, emplacing an empty set if it didn't exist\n                 // (note: if this peer wasn't still connected, we would have removed the orphan tx already)\n-                std::set<Txid>& orphan_work_set = m_peer_work_set.try_emplace(elem->second.fromPeer).first->second;\n+                std::set<Wtxid>& orphan_work_set = m_peer_work_set.try_emplace(elem->second.fromPeer).first->second;\n                 // Add this tx to the work set\n                 orphan_work_set.insert(elem->first);\n                 LogPrint(BCLog::TXPACKAGES, \"added %s (wtxid=%s) to peer %d workset\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589549760",
      "id" : 1589549760,
      "line" : 162,
      "node_id" : "PRRC_kwDOABII585evprA",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 162,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 98,
      "pull_request_review_id" : 2038712299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589549760/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-03T19:51:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589549760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589569008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589569008"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 646aa4da91c03a0e72d086cae281aa0688f2f41d\r\n\r\nThis should not be called `orphanHash` anymore, but also, this could be inlined",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-03T18:10:27Z",
      "diff_hunk" : "@@ -226,7 +219,7 @@ void TxOrphanage::EraseForBlock(const CBlock& block)\n             if (itByPrev == m_outpoint_to_orphan_it.end()) continue;\n             for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n                 const CTransaction& orphanTx = *(*mi)->second.tx;\n-                const auto& orphanHash = orphanTx.GetHash();\n+                const auto& orphanHash = orphanTx.GetWitnessHash();\n                 vOrphanErase.push_back(orphanHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589569008",
      "id" : 1589569008,
      "line" : 223,
      "node_id" : "PRRC_kwDOABII585evuXw",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 223,
      "original_position" : 144,
      "original_start_line" : 222,
      "path" : "src/txorphanage.cpp",
      "position" : 144,
      "pull_request_review_id" : 2038712299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589569008/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 222,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-03T19:51:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589569008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589571339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589571339"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, in L231:\r\n\r\n`for (const auto& orphanHash : vOrphanErase)` -> `for (const auto& wtxid : vOrphanErase)`",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-03T18:12:19Z",
      "diff_hunk" : "@@ -226,7 +219,7 @@ void TxOrphanage::EraseForBlock(const CBlock& block)\n             if (itByPrev == m_outpoint_to_orphan_it.end()) continue;\n             for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n                 const CTransaction& orphanTx = *(*mi)->second.tx;\n-                const auto& orphanHash = orphanTx.GetHash();\n+                const auto& orphanHash = orphanTx.GetWitnessHash();\n                 vOrphanErase.push_back(orphanHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589571339",
      "id" : 1589571339,
      "in_reply_to_id" : 1589569008,
      "line" : 223,
      "node_id" : "PRRC_kwDOABII585evu8L",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 223,
      "original_position" : 144,
      "original_start_line" : 222,
      "path" : "src/txorphanage.cpp",
      "position" : 144,
      "pull_request_review_id" : 2038712299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589571339/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 222,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-03T19:51:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589571339",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "concept ACK\r\n\r\nAfter being caught out of guard due to the short notice on this PR at the Bitcoin Review Club, I took time to review the code changes and read the comments above. \r\n\r\nTo my understanding, we need to check the `wtxid` for screening transactions for inclusion in the orphanage in order to catch witness malleations as well. This was not previously possible because we where only checking against `txid` that does not include the `[witness]` section of a transaction as defined in [BIP141](https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#transaction-id). \r\n\r\nThis change needs to be implemented only for the orphanage and not the rest of the structures that `AlreadyHaveTx()` checks against, since `txid` might be relevant there. The new behavior is implicitly documented in the `bool TxOrphanage::HaveTx(const Wtxid& wtxid) const` function definition which now takes `wtxid` as its single argument. ",
      "created_at" : "2024-05-03T18:14:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2093526057",
      "id" : 2093526057,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII5858yKwp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2093526057/reactions"
      },
      "updated_at" : "2024-05-03T18:14:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2093526057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11520757?v=4",
         "events_url" : "https://api.github.com/users/itornaza/events{/privacy}",
         "followers_url" : "https://api.github.com/users/itornaza/followers",
         "following_url" : "https://api.github.com/users/itornaza/following{/other_user}",
         "gists_url" : "https://api.github.com/users/itornaza/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/itornaza",
         "id" : 11520757,
         "login" : "itornaza",
         "node_id" : "MDQ6VXNlcjExNTIwNzU3",
         "organizations_url" : "https://api.github.com/users/itornaza/orgs",
         "received_events_url" : "https://api.github.com/users/itornaza/received_events",
         "repos_url" : "https://api.github.com/users/itornaza/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/itornaza/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/itornaza/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/itornaza"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589584199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589584199"
         }
      },
      "author_association" : "NONE",
      "body" : "imo `wtxid` and `txid` being double SHA256 outputs and `wtxid` being essentially a superset of `txid`, makes this blind conversion legitimate in this case.",
      "commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "created_at" : "2024-05-03T18:21:58Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1589584199",
      "id" : 1589584199,
      "in_reply_to_id" : 1586713579,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585evyFH",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2038776284,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589584199/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2298,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-03T18:47:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1589584199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11520757?v=4",
         "events_url" : "https://api.github.com/users/itornaza/events{/privacy}",
         "followers_url" : "https://api.github.com/users/itornaza/followers",
         "following_url" : "https://api.github.com/users/itornaza/following{/other_user}",
         "gists_url" : "https://api.github.com/users/itornaza/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/itornaza",
         "id" : 11520757,
         "login" : "itornaza",
         "node_id" : "MDQ6VXNlcjExNTIwNzU3",
         "organizations_url" : "https://api.github.com/users/itornaza/orgs",
         "received_events_url" : "https://api.github.com/users/itornaza/received_events",
         "repos_url" : "https://api.github.com/users/itornaza/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/itornaza/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/itornaza/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/itornaza"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596607638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596607638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, I would definitely say to log both txid and wtxid when we have it. A lot of things use txid only, e.g. if you want to trace a tx through logs or look it up in mempool. Would be a pain to not have txid imo.",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T10:53:13Z",
      "diff_hunk" : "@@ -23,7 +23,7 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n \n     const Txid& hash = tx->GetHash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596607638",
      "id" : 1596607638,
      "in_reply_to_id" : 1589529436,
      "line" : 24,
      "node_id" : "PRRC_kwDOABII585fKkyW",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 24,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 2,
      "pull_request_review_id" : 2049834162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596607638/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T10:56:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596607638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596607978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596607978"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same as above, imo definitely want to log txid if we have it.",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T10:53:38Z",
      "diff_hunk" : "@@ -54,18 +52,19 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n     return true;\n }\n \n-int TxOrphanage::EraseTx(const Txid& txid)\n+int TxOrphanage::EraseTx(const Wtxid& wtxid)\n {\n     LOCK(m_mutex);\n-    return EraseTxNoLock(txid);\n+    return EraseTxNoLock(wtxid);\n }\n \n-int TxOrphanage::EraseTxNoLock(const Txid& txid)\n+int TxOrphanage::EraseTxNoLock(const Wtxid& wtxid)\n {\n     AssertLockHeld(m_mutex);\n-    std::map<Txid, OrphanTx>::iterator it = m_orphans.find(txid);\n+    std::map<Wtxid, OrphanTx>::iterator it = m_orphans.find(wtxid);\n     if (it == m_orphans.end())\n         return 0;\n+    const auto& txid = it->second.tx->GetHash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596607978",
      "id" : 1596607978,
      "in_reply_to_id" : 1586410875,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fKk3q",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 67,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 2049834162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596607978/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T10:56:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596607978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596610435"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596610435"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T10:56:23Z",
      "diff_hunk" : "@@ -159,7 +156,7 @@ void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx)\n             for (const auto& elem : it_by_prev->second) {\n                 // Get this source peer's work set, emplacing an empty set if it didn't exist\n                 // (note: if this peer wasn't still connected, we would have removed the orphan tx already)\n-                std::set<Txid>& orphan_work_set = m_peer_work_set.try_emplace(elem->second.fromPeer).first->second;\n+                std::set<Wtxid>& orphan_work_set = m_peer_work_set.try_emplace(elem->second.fromPeer).first->second;\n                 // Add this tx to the work set\n                 orphan_work_set.insert(elem->first);\n                 LogPrint(BCLog::TXPACKAGES, \"added %s (wtxid=%s) to peer %d workset\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596610435",
      "id" : 1596610435,
      "in_reply_to_id" : 1589549760,
      "line" : 162,
      "node_id" : "PRRC_kwDOABII585fKleD",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 162,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 107,
      "pull_request_review_id" : 2049834162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596610435/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T10:56:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596610435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596626751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596626751"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T11:15:01Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596626751",
      "id" : 1596626751,
      "in_reply_to_id" : 1586473749,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fKpc_",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 2049866191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596626751/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T11:40:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596626751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596626910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596626910"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T11:15:12Z",
      "diff_hunk" : "@@ -112,21 +112,21 @@ FUZZ_TARGET(txorphan, .init = initialize_orphanage)\n                     {\n                         CTransactionRef ref = orphanage.GetTxToReconsider(peer_id);\n                         if (ref) {\n-                            bool have_tx = orphanage.HaveTx(GenTxid::Txid(ref->GetHash())) || orphanage.HaveTx(GenTxid::Wtxid(ref->GetWitnessHash()));\n+                            bool have_tx = orphanage.HaveTx(ref->GetWitnessHash());\n                             Assert(have_tx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596626910",
      "id" : 1596626910,
      "in_reply_to_id" : 1586533521,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fKpfe",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 116,
      "original_position" : 6,
      "original_start_line" : 115,
      "path" : "src/test/fuzz/txorphan.cpp",
      "position" : null,
      "pull_request_review_id" : 2049866191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596626910/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-10T11:40:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596626910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596628093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596628093"
         }
      },
      "author_association" : "MEMBER",
      "body" : "inlined. didn't do the rename as I don't think it's incorrect and want to minimize diff",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T11:16:29Z",
      "diff_hunk" : "@@ -226,7 +219,7 @@ void TxOrphanage::EraseForBlock(const CBlock& block)\n             if (itByPrev == m_outpoint_to_orphan_it.end()) continue;\n             for (auto mi = itByPrev->second.begin(); mi != itByPrev->second.end(); ++mi) {\n                 const CTransaction& orphanTx = *(*mi)->second.tx;\n-                const auto& orphanHash = orphanTx.GetHash();\n+                const auto& orphanHash = orphanTx.GetWitnessHash();\n                 vOrphanErase.push_back(orphanHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596628093",
      "id" : 1596628093,
      "in_reply_to_id" : 1589569008,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fKpx9",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 223,
      "original_position" : 144,
      "original_start_line" : 222,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 2049866191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596628093/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-10T11:40:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596628093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596628218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596628218"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed thanks",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T11:16:37Z",
      "diff_hunk" : "@@ -24,7 +24,7 @@ class TxOrphanage {\n     bool AddTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n \n     /** Check if we already have an orphan transaction (by txid or wtxid) */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596628218",
      "id" : 1596628218,
      "in_reply_to_id" : 1586372606,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fKpz6",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 26,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/txorphanage.h",
      "position" : null,
      "pull_request_review_id" : 2049866191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596628218/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T11:40:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596628218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596649444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596649444"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Split up the commit, hope it helps (https://github.com/bitcoin/bitcoin/pull/30000#pullrequestreview-2049866191)",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T11:41:11Z",
      "diff_hunk" : "@@ -2295,7 +2295,9 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Orphanage is checked by wtxid. However, even if this is a txid, look up the same hash in\n+    // case this is a non-segwit transaction in the orphanage.\n+    if (m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596649444",
      "id" : 1596649444,
      "in_reply_to_id" : 1586713579,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fKu_k",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 2049904786,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596649444/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-10T11:41:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596649444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596853749"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596853749"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this could still happen",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T14:47:16Z",
      "diff_hunk" : "@@ -101,13 +98,13 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     m_peer_work_set.erase(peer);\n \n     int nErased = 0;\n-    std::map<Txid, OrphanTx>::iterator iter = m_orphans.begin();\n+    std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\n     while (iter != m_orphans.end())\n     {\n-        std::map<Txid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n         if (maybeErase->second.fromPeer == peer)\n         {\n-            nErased += EraseTxNoLock(maybeErase->second.tx->GetHash());\n+            nErased += EraseTxNoLock(maybeErase->second.tx->GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596853749",
      "id" : 1596853749,
      "in_reply_to_id" : 1586417487,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fLg31",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 107,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596853749/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596853749",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596929262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596929262"
         }
      },
      "author_association" : "MEMBER",
      "body" : "but you are sending verack just below?",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T15:55:34Z",
      "diff_hunk" : "@@ -57,10 +61,20 @@ def wrapper(self):\n \n class PeerTxRelayer(P2PTxInvStore):\n     \"\"\"A P2PTxInvStore that also remembers all of the getdata and tx messages it receives.\"\"\"\n-    def __init__(self):\n+    def __init__(self, wtxidrelay=True):\n         super().__init__()\n         self._tx_received = []\n         self._getdata_received = []\n+        self._wtxidrelay = wtxidrelay\n+\n+    def on_version(self, message):\n+        # Avoid sending verack in response to version.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596929262",
      "id" : 1596929262,
      "line" : 71,
      "node_id" : "PRRC_kwDOABII585fLzTu",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 71,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 37,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596929262/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596929262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596930516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596930516"
         }
      },
      "author_association" : "MEMBER",
      "body" : "but `wait_for_verack=False` isn't being set?",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T15:56:43Z",
      "diff_hunk" : "@@ -57,10 +61,20 @@ def wrapper(self):\n \n class PeerTxRelayer(P2PTxInvStore):\n     \"\"\"A P2PTxInvStore that also remembers all of the getdata and tx messages it receives.\"\"\"\n-    def __init__(self):\n+    def __init__(self, wtxidrelay=True):\n         super().__init__()\n         self._tx_received = []\n         self._getdata_received = []\n+        self._wtxidrelay = wtxidrelay\n+\n+    def on_version(self, message):\n+        # Avoid sending verack in response to version.\n+        # When calling add_p2p_connection, wait_for_verack=False must be set (see",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596930516",
      "id" : 1596930516,
      "line" : 72,
      "node_id" : "PRRC_kwDOABII585fLznU",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 72,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 38,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596930516/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596930516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596947704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596947704"
         }
      },
      "author_association" : "MEMBER",
      "body" : "might want to note this line is necessary for the reconsideration step to always happen",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T16:13:24Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596947704",
      "id" : 1596947704,
      "line" : 467,
      "node_id" : "PRRC_kwDOABII585fL3z4",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 467,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 110,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596947704/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596947704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596966608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596966608"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```Suggestion\r\n        # 2. Node requests tx_grandparent by txid.\r\n```",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T16:31:07Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596966608",
      "id" : 1596966608,
      "line" : 499,
      "node_id" : "PRRC_kwDOABII585fL8bQ",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 499,
      "original_position" : 142,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 142,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596966608/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596966608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596969302"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596969302"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```Suggestion\r\n        # exists in orphanage, but should be re-requested due to having witness data.\r\n```",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T16:33:57Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596969302",
      "id" : 1596969302,
      "line" : 505,
      "node_id" : "PRRC_kwDOABII585fL9FW",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 505,
      "original_position" : 148,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 148,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596969302/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596969302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596975768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596975768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```Suggestion\r\n        assert_equal(node.getrawmempool(), [])\r\n\r\n        # 5. The parent is requested. Honest peer sends it.\r\n```",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T16:40:50Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596975768",
      "id" : 1596975768,
      "line" : 517,
      "node_id" : "PRRC_kwDOABII585fL-qY",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 517,
      "original_position" : 160,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 160,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596975768/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596975768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596977375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596977375"
         }
      },
      "author_association" : "MEMBER",
      "body" : "is `send_message` + `sync_with_ping` always enough to resolve two generations of orphans to ensure we hit the mempool?",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T16:42:25Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.\n+        honest_peer.send_message(msg_tx(tx_grandparent[\"tx\"]))\n+        honest_peer.sync_with_ping()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596977375",
      "id" : 1596977375,
      "line" : 519,
      "node_id" : "PRRC_kwDOABII585fL_Df",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 519,
      "original_position" : 162,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 162,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596977375/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596977375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596981173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596981173"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```Suggestion\r\n        # 3. Honest peer announces the real child by txid (this isn't common but the node should\r\n```",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T16:44:47Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.\n+        honest_peer.send_message(msg_tx(tx_grandparent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check what happens when node receives announcement with same txid as tx in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child and fake version\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(PeerTxRelayer())\n+        # Must not send wtxidrelay because otherwise the inv(TX) will be ignored later\n+        honest_peer = node.add_p2p_connection(PeerTxRelayer(wtxidrelay=False))\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer announces the real parent, by txid (this isn't common but the node should",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596981173",
      "id" : 1596981173,
      "line" : 552,
      "node_id" : "PRRC_kwDOABII585fL_-1",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 552,
      "original_position" : 195,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 195,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596981173/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596981173",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596986213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596986213"
         }
      },
      "author_association" : "MEMBER",
      "body" : "micronit to sound more prescriptive\r\n```Suggestion\r\n        self.log.info(\"Check node handles receiving announcement with same txid as tx in orphanage\")\r\n```",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T16:48:28Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.\n+        honest_peer.send_message(msg_tx(tx_grandparent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check what happens when node receives announcement with same txid as tx in orphanage\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596986213",
      "id" : 1596986213,
      "line" : 531,
      "node_id" : "PRRC_kwDOABII585fMBNl",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 531,
      "original_position" : 174,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 174,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596986213/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596986213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596988905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596988905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note for readers: If the child tx ended up being the same wtxid, and in that case the node would simply not add to the orphanage or request anything further.",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-10T16:50:13Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.\n+        honest_peer.send_message(msg_tx(tx_grandparent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check what happens when node receives announcement with same txid as tx in orphanage\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1596988905",
      "id" : 1596988905,
      "in_reply_to_id" : 1596986213,
      "line" : 531,
      "node_id" : "PRRC_kwDOABII585fMB3p",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 531,
      "original_position" : 174,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 174,
      "pull_request_review_id" : 2050241117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596988905/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-10T16:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596988905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1597723673"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597723673"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\r\n```",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-12T22:07:21Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.\n+        honest_peer.send_message(msg_tx(tx_grandparent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check what happens when node receives announcement with same txid as tx in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child and fake version\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(PeerTxRelayer())\n+        # Must not send wtxidrelay because otherwise the inv(TX) will be ignored later\n+        honest_peer = node.add_p2p_connection(PeerTxRelayer(wtxidrelay=False))\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer announces the real parent, by txid (this isn't common but the node should\n+        # still keep track of it).\n+        child_txid_int = int(tx_child[\"txid\"], 16)\n+        honest_peer.send_and_ping(msg_inv([CInv(t=MSG_TX, h=child_txid_int)]))\n+\n+        # 4. The child is requested. Honest peer sends it.\n+        node.bumpmocktime(TXREQUEST_TIME_SKIP)\n+        honest_peer.wait_for_getdata([child_txid_int])\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_message(msg_tx(tx_child[\"tx\"]))\n+\n+        # 5. After first parent request times out, the node sends another one for the missing parent\n+        # of the real orphan child.\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1597723673",
      "id" : 1597723673,
      "line" : 574,
      "node_id" : "PRRC_kwDOABII585fO1QZ",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 574,
      "original_position" : 217,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 217,
      "pull_request_review_id" : 2051463502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597723673/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-12T22:28:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597723673",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1597725786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597725786"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\r\n```",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-12T22:23:32Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1597725786",
      "id" : 1597725786,
      "line" : 474,
      "node_id" : "PRRC_kwDOABII585fO1xa",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 474,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 117,
      "pull_request_review_id" : 2051463502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597725786/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-12T22:28:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597725786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598332839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598332839"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, this is a bad copy-paste. I forgot to delete this comment I copied over.",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-13T11:42:35Z",
      "diff_hunk" : "@@ -57,10 +61,20 @@ def wrapper(self):\n \n class PeerTxRelayer(P2PTxInvStore):\n     \"\"\"A P2PTxInvStore that also remembers all of the getdata and tx messages it receives.\"\"\"\n-    def __init__(self):\n+    def __init__(self, wtxidrelay=True):\n         super().__init__()\n         self._tx_received = []\n         self._getdata_received = []\n+        self._wtxidrelay = wtxidrelay\n+\n+    def on_version(self, message):\n+        # Avoid sending verack in response to version.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598332839",
      "id" : 1598332839,
      "in_reply_to_id" : 1596929262,
      "line" : 71,
      "node_id" : "PRRC_kwDOABII585fRJ-n",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 71,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 37,
      "pull_request_review_id" : 2052452333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598332839/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T11:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598332839",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598333278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598333278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same - forgot to delete, sorry",
      "commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "created_at" : "2024-05-13T11:43:01Z",
      "diff_hunk" : "@@ -57,10 +61,20 @@ def wrapper(self):\n \n class PeerTxRelayer(P2PTxInvStore):\n     \"\"\"A P2PTxInvStore that also remembers all of the getdata and tx messages it receives.\"\"\"\n-    def __init__(self):\n+    def __init__(self, wtxidrelay=True):\n         super().__init__()\n         self._tx_received = []\n         self._getdata_received = []\n+        self._wtxidrelay = wtxidrelay\n+\n+    def on_version(self, message):\n+        # Avoid sending verack in response to version.\n+        # When calling add_p2p_connection, wait_for_verack=False must be set (see",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598333278",
      "id" : 1598333278,
      "in_reply_to_id" : 1596930516,
      "line" : 72,
      "node_id" : "PRRC_kwDOABII585fRKFe",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 72,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 38,
      "pull_request_review_id" : 2052453250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598333278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T11:43:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598333278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598461107"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598461107"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:16:24Z",
      "diff_hunk" : "@@ -57,10 +61,20 @@ def wrapper(self):\n \n class PeerTxRelayer(P2PTxInvStore):\n     \"\"\"A P2PTxInvStore that also remembers all of the getdata and tx messages it receives.\"\"\"\n-    def __init__(self):\n+    def __init__(self, wtxidrelay=True):\n         super().__init__()\n         self._tx_received = []\n         self._getdata_received = []\n+        self._wtxidrelay = wtxidrelay\n+\n+    def on_version(self, message):\n+        # Avoid sending verack in response to version.\n+        # When calling add_p2p_connection, wait_for_verack=False must be set (see",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598461107",
      "id" : 1598461107,
      "in_reply_to_id" : 1596930516,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fRpSz",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 72,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598461107/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598461107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598461970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598461970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added comment",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:17:04Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598461970",
      "id" : 1598461970,
      "in_reply_to_id" : 1596947704,
      "line" : 467,
      "node_id" : "PRRC_kwDOABII585fRpgS",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 467,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 110,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598461970/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598461970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598462421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598462421"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:17:23Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598462421",
      "id" : 1598462421,
      "in_reply_to_id" : 1597725786,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fRpnV",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 474,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598462421/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598462421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598463139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598463139"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:17:49Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598463139",
      "id" : 1598463139,
      "in_reply_to_id" : 1596966608,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fRpyj",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 499,
      "original_position" : 142,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598463139/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598463139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598465418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598465418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "elaborated",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:19:12Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598465418",
      "id" : 1598465418,
      "in_reply_to_id" : 1596969302,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fRqWK",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 505,
      "original_position" : 148,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598465418/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598465418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598466023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598466023"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:19:36Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598466023",
      "id" : 1598466023,
      "in_reply_to_id" : 1596975768,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fRqfn",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 517,
      "original_position" : 160,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598466023/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598466023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598496074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598496074"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I would say so. We do all `ProcessOrphanTx` before processing the ping; the child will be added to workset when the parent is accepted through `ProcessOrphanTx`",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:39:05Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.\n+        honest_peer.send_message(msg_tx(tx_grandparent[\"tx\"]))\n+        honest_peer.sync_with_ping()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598496074",
      "id" : 1598496074,
      "in_reply_to_id" : 1596977375,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fRx1K",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 519,
      "original_position" : 162,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598496074/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598496074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598497584"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598497584"
         }
      },
      "author_association" : "MEMBER",
      "body" : "changed to be more perscriptive",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:39:58Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.\n+        honest_peer.send_message(msg_tx(tx_grandparent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check what happens when node receives announcement with same txid as tx in orphanage\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598497584",
      "id" : 1598497584,
      "in_reply_to_id" : 1596986213,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fRyMw",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 531,
      "original_position" : 174,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598497584/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598497584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598498581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598498581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "gah thanks",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:40:36Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.\n+        honest_peer.send_message(msg_tx(tx_grandparent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check what happens when node receives announcement with same txid as tx in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child and fake version\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(PeerTxRelayer())\n+        # Must not send wtxidrelay because otherwise the inv(TX) will be ignored later\n+        honest_peer = node.add_p2p_connection(PeerTxRelayer(wtxidrelay=False))\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer announces the real parent, by txid (this isn't common but the node should",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598498581",
      "id" : 1598498581,
      "in_reply_to_id" : 1596981173,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fRycV",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 552,
      "original_position" : 195,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598498581/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598498581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598499228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598499228"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:41:02Z",
      "diff_hunk" : "@@ -398,6 +428,152 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+\n+        # 5. The parent is requested. Honest peer sends it.\n+        honest_peer.send_message(msg_tx(tx_grandparent[\"tx\"]))\n+        honest_peer.sync_with_ping()\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check what happens when node receives announcement with same txid as tx in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child and fake version\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(PeerTxRelayer())\n+        # Must not send wtxidrelay because otherwise the inv(TX) will be ignored later\n+        honest_peer = node.add_p2p_connection(PeerTxRelayer(wtxidrelay=False))\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer announces the real parent, by txid (this isn't common but the node should\n+        # still keep track of it).\n+        child_txid_int = int(tx_child[\"txid\"], 16)\n+        honest_peer.send_and_ping(msg_inv([CInv(t=MSG_TX, h=child_txid_int)]))\n+\n+        # 4. The child is requested. Honest peer sends it.\n+        node.bumpmocktime(TXREQUEST_TIME_SKIP)\n+        honest_peer.wait_for_getdata([child_txid_int])\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_message(msg_tx(tx_child[\"tx\"]))\n+\n+        # 5. After first parent request times out, the node sends another one for the missing parent\n+        # of the real orphan child.\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"] == tx_child[\"wtxid\"]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598499228",
      "id" : 1598499228,
      "in_reply_to_id" : 1597723673,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fRymc",
      "original_commit_id" : "65f69bf533f66ecfb2695b03204bd437f1fe692d",
      "original_line" : 574,
      "original_position" : 217,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598499228/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598499228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598526584"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598526584"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok I've added a commit to fix this and another log to say \"transaction(s)\". I took the opportunity to add a few nice things to the logs as well.",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T13:58:43Z",
      "diff_hunk" : "@@ -101,13 +98,13 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     m_peer_work_set.erase(peer);\n \n     int nErased = 0;\n-    std::map<Txid, OrphanTx>::iterator iter = m_orphans.begin();\n+    std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\n     while (iter != m_orphans.end())\n     {\n-        std::map<Txid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n         if (maybeErase->second.fromPeer == peer)\n         {\n-            nErased += EraseTxNoLock(maybeErase->second.tx->GetHash());\n+            nErased += EraseTxNoLock(maybeErase->second.tx->GetWitnessHash());\n         }\n     }\n     if (nErased > 0) LogPrint(BCLog::TXPACKAGES, \"Erased %d orphan tx from peer=%d\\n\", nErased, peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598526584",
      "id" : 1598526584,
      "in_reply_to_id" : 1589547282,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fR5R4",
      "original_commit_id" : "646aa4da91c03a0e72d086cae281aa0688f2f41d",
      "original_line" : 110,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 2052675039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598526584/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T13:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598526584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @instagibbs @theStack @sr-gi! Addressed the comments and added a few minor log improvements.",
      "created_at" : "2024-05-13T14:00:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2107656257",
      "id" : 2107656257,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII5859oEhB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2107656257/reactions"
      },
      "updated_at" : "2024-05-13T14:00:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2107656257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598532513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598532513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this was (mostly) taken",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T14:02:40Z",
      "diff_hunk" : "@@ -101,13 +98,13 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     m_peer_work_set.erase(peer);\n \n     int nErased = 0;\n-    std::map<Txid, OrphanTx>::iterator iter = m_orphans.begin();\n+    std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\n     while (iter != m_orphans.end())\n     {\n-        std::map<Txid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n         if (maybeErase->second.fromPeer == peer)\n         {\n-            nErased += EraseTxNoLock(maybeErase->second.tx->GetHash());\n+            nErased += EraseTxNoLock(maybeErase->second.tx->GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598532513",
      "id" : 1598532513,
      "in_reply_to_id" : 1586417487,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fR6uh",
      "original_commit_id" : "4b4dfaa8f3fb98696ab19962e07db51046137542",
      "original_line" : 107,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 2052800274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598532513/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T14:02:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598532513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598686662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598686662"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In c31f148166f01a9167d82501a77823785d28a841:\r\n\r\nIf this is indeed a refactor commit, I think this line should never be hit. I ran the unit and functional tests with the below diff and didn't get any errors locally. Still, perhaps worth updating the commit like this to make that explicit, and then remove the assertion again in the next commit?\r\n\r\n<details>\r\n<summary>git diff on c31f148166</summary>\r\n\r\n```diff\r\ndiff --git a/src/txorphanage.cpp b/src/txorphanage.cpp\r\nindex ca8a0e3a92..7132660695 100644\r\n--- a/src/txorphanage.cpp\r\n+++ b/src/txorphanage.cpp\r\n@@ -68,7 +68,7 @@ int TxOrphanage::EraseTxNoLock(const Wtxid& wtxid)\r\n \r\n     std::map<Txid, OrphanTx>::iterator it = it_by_wtxid->second;\r\n     if (it == m_orphans.end())\r\n-        return 0;\r\n+        Assert(false);  // we should have already returned early based on it_by_wtxid.\r\n     for (const CTxIn& txin : it->second.tx->vin)\r\n     {\r\n         auto itPrev = m_outpoint_to_orphan_it.find(txin.prevout);\r\n\r\n```\r\n</details>\r\n",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-13T15:41:52Z",
      "diff_hunk" : "@@ -54,16 +54,19 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n     return true;\n }\n \n-int TxOrphanage::EraseTx(const Txid& txid)\n+int TxOrphanage::EraseTx(const Wtxid& wtxid)\n {\n     LOCK(m_mutex);\n-    return EraseTxNoLock(txid);\n+    return EraseTxNoLock(wtxid);\n }\n \n-int TxOrphanage::EraseTxNoLock(const Txid& txid)\n+int TxOrphanage::EraseTxNoLock(const Wtxid& wtxid)\n {\n     AssertLockHeld(m_mutex);\n-    std::map<Txid, OrphanTx>::iterator it = m_orphans.find(txid);\n+    auto it_by_wtxid = m_wtxid_to_orphan_it.find(wtxid);\n+    if (it_by_wtxid == m_wtxid_to_orphan_it.end()) return 0;\n+\n+    std::map<Txid, OrphanTx>::iterator it = it_by_wtxid->second;\n     if (it == m_orphans.end())\n         return 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598686662",
      "id" : 1598686662,
      "line" : 66,
      "node_id" : "PRRC_kwDOABII585fSgXG",
      "original_commit_id" : "838f63e2f4978d34e9d1bbdecc8fb7b0aef8b039",
      "original_line" : 66,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 44,
      "pull_request_review_id" : 2053065161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598686662/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T18:34:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598686662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598764600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598764600"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "tidy nit:\r\n```suggestion\r\n    FastRandomContext det_rand{/*fDeterministic=*/true};\r\n```",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-13T16:43:40Z",
      "diff_hunk" : "@@ -180,6 +190,49 @@ BOOST_AUTO_TEST_CASE(DoS_mapOrphans)\n     BOOST_CHECK(orphanage.CountOrphans() == 0);\n }\n \n+BOOST_AUTO_TEST_CASE(same_txid_diff_witness)\n+{\n+    FastRandomContext det_rand{true};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598764600",
      "id" : 1598764600,
      "line" : 195,
      "node_id" : "PRRC_kwDOABII585fSzY4",
      "original_commit_id" : "822b2f147791e01ab041238d4cbc8bc7a2bb3069",
      "original_line" : 195,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/test/orphanage_tests.cpp",
      "position" : 34,
      "pull_request_review_id" : 2053065161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598764600/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T18:34:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598764600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598780909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598780909"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hondest",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T16:58:15Z",
      "diff_hunk" : "@@ -398,6 +427,154 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        # This ensures the peer's orphans were reconsidered.\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests missing tx_grandparent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested because the node shouldn't assume that the\n+        # witness data is the same. In this case, a same-txid-different-witness transaction exists!\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+        assert_equal(len(node.getrawmempool()), 0)\n+\n+        # 5. Hondest peer sends tx_grandparent",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598780909",
      "id" : 1598780909,
      "line" : 519,
      "node_id" : "PRRC_kwDOABII585fS3Xt",
      "original_commit_id" : "1aea9f21571470a37cc0a776bc16b9c2855a81d9",
      "original_line" : 519,
      "original_position" : 162,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 162,
      "pull_request_review_id" : 2053233269,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598780909/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T17:19:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598780909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ah, p2p_invalid_tx.py failed because `assert_debug_log` didn't match anymore (those should be unit tests!)",
      "created_at" : "2024-05-13T17:03:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2108249084",
      "id" : 2108249084,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII5859qVP8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2108249084/reactions"
      },
      "updated_at" : "2024-05-13T17:03:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2108249084",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598790197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598790197"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think either of these need to be `PeerTxRelayer`, just use `P2PInterface` and pass in `wtxidrelay` to remove the custom `on_version` handshake?",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T17:06:53Z",
      "diff_hunk" : "@@ -398,6 +427,154 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        # This ensures the peer's orphans were reconsidered.\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests missing tx_grandparent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested because the node shouldn't assume that the\n+        # witness data is the same. In this case, a same-txid-different-witness transaction exists!\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+        assert_equal(len(node.getrawmempool()), 0)\n+\n+        # 5. Hondest peer sends tx_grandparent\n+        honest_peer.send_and_ping(msg_tx(tx_grandparent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check node does not ignore announcement with same txid as tx in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child and fake version\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(PeerTxRelayer())\n+        # Must not send wtxidrelay because otherwise the inv(TX) will be ignored later\n+        honest_peer = node.add_p2p_connection(PeerTxRelayer(wtxidrelay=False))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598790197",
      "id" : 1598790197,
      "line" : 543,
      "node_id" : "PRRC_kwDOABII585fS5o1",
      "original_commit_id" : "1aea9f21571470a37cc0a776bc16b9c2855a81d9",
      "original_line" : 543,
      "original_position" : 186,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 186,
      "pull_request_review_id" : 2053233269,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598790197/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T17:19:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598790197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598792832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598792832"
         }
      },
      "author_association" : "MEMBER",
      "body" : "weight no \"size\"? :pleading_face: ",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T17:08:57Z",
      "diff_hunk" : "@@ -47,7 +47,7 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n         m_outpoint_to_orphan_it[txin.prevout].insert(ret.first);\n     }\n \n-    LogPrint(BCLog::TXPACKAGES, \"stored orphan tx %s (wtxid=%s) (mapsz %u outsz %u)\\n\", hash.ToString(), wtxid.ToString(),\n+    LogPrint(BCLog::TXPACKAGES, \"stored orphan tx %s (wtxid=%s), size: %u (mapsz %u outsz %u)\\n\", hash.ToString(), wtxid.ToString(), sz,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1598792832",
      "id" : 1598792832,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII585fS6SA",
      "original_commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "original_line" : 50,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 5,
      "pull_request_review_id" : 2053233269,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598792832/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T17:19:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598792832",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599064530"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599064530"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "i don't think that's a problem, just mentioning that whether we disconnect the  bad peer for misbehavior depends on the order in which the `ProcessOrphanTx` is called, so it could be random:\r\nIf the valid pair of txns is processed first, the invalid tx is removed with \"txn-same-nonwitness-data-in-mempool\" and no punishment. If the invalid pair is processed first, the bad peer is disconnected.",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T20:48:50Z",
      "diff_hunk" : "@@ -398,6 +427,154 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        # This ensures the peer's orphans were reconsidered.\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests missing tx_grandparent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested because the node shouldn't assume that the\n+        # witness data is the same. In this case, a same-txid-different-witness transaction exists!\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+        assert_equal(len(node.getrawmempool()), 0)\n+\n+        # 5. Hondest peer sends tx_grandparent\n+        honest_peer.send_and_ping(msg_tx(tx_grandparent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check node does not ignore announcement with same txid as tx in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child and fake version\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(PeerTxRelayer())\n+        # Must not send wtxidrelay because otherwise the inv(TX) will be ignored later\n+        honest_peer = node.add_p2p_connection(PeerTxRelayer(wtxidrelay=False))\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer announces the real child, by txid (this isn't common but the node should\n+        # still keep track of it).\n+        child_txid_int = int(tx_child[\"txid\"], 16)\n+        honest_peer.send_and_ping(msg_inv([CInv(t=MSG_TX, h=child_txid_int)]))\n+\n+        # 4. The child is requested. Honest peer sends it.\n+        node.bumpmocktime(TXREQUEST_TIME_SKIP)\n+        honest_peer.wait_for_getdata([child_txid_int])\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_message(msg_tx(tx_child[\"tx\"]))\n+\n+        # 5. After first parent request times out, the node sends another one for the missing parent\n+        # of the real orphan child.\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599064530",
      "id" : 1599064530,
      "line" : 571,
      "node_id" : "PRRC_kwDOABII585fT8nS",
      "original_commit_id" : "1aea9f21571470a37cc0a776bc16b9c2855a81d9",
      "original_line" : 571,
      "original_position" : 214,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 214,
      "pull_request_review_id" : 2053800837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599064530/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T23:17:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599064530",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599118360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599118360"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: given the discussion in the PR, you could extend this with a note on why we might still want to keep multiple same-txid-diff-witness transactions in the orphanage\r\n\r\n```suggestion\r\n    // It is possible that the transaction in the orphanage has the same txid but a different\r\n    // witness (e.g. malleated by an attacker) and we don't want to return false positives,\r\n    // nor can we tell which of the same-txid-different-witness transactions in the orphanage\r\n    // could be evicted without seeing their parent transactions.\r\n```",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T21:40:39Z",
      "diff_hunk" : "@@ -2295,7 +2295,12 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Always query by wtxid, even if gtxid has a Txid type.\n+    // It is possible that the transaction in the orphanage has the same txid but a different\n+    // witness (e.g. malleated by an attacker) and we don't want to return false positives.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599118360",
      "id" : 1599118360,
      "line" : 2300,
      "node_id" : "PRRC_kwDOABII585fUJwY",
      "original_commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2299,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 2053871488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599118360/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2299,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-13T22:04:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599118360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1328814?v=4",
         "events_url" : "https://api.github.com/users/AngusP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AngusP/followers",
         "following_url" : "https://api.github.com/users/AngusP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AngusP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AngusP",
         "id" : 1328814,
         "login" : "AngusP",
         "node_id" : "MDQ6VXNlcjEzMjg4MTQ=",
         "organizations_url" : "https://api.github.com/users/AngusP/orgs",
         "received_events_url" : "https://api.github.com/users/AngusP/received_events",
         "repos_url" : "https://api.github.com/users/AngusP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AngusP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AngusP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AngusP"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599138412"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599138412"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        # 3. Honest peer relays the grandchild, which is missing a parent. The parent by txid already\r\n```",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T22:02:02Z",
      "diff_hunk" : "@@ -398,6 +427,154 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        # This ensures the peer's orphans were reconsidered.\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests missing tx_grandparent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599138412",
      "id" : 1599138412,
      "line" : 504,
      "node_id" : "PRRC_kwDOABII585fUOps",
      "original_commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "original_line" : 504,
      "original_position" : 147,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 147,
      "pull_request_review_id" : 2053871488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599138412/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T22:04:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599138412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1328814?v=4",
         "events_url" : "https://api.github.com/users/AngusP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AngusP/followers",
         "following_url" : "https://api.github.com/users/AngusP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AngusP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AngusP",
         "id" : 1328814,
         "login" : "AngusP",
         "node_id" : "MDQ6VXNlcjEzMjg4MTQ=",
         "organizations_url" : "https://api.github.com/users/AngusP/orgs",
         "received_events_url" : "https://api.github.com/users/AngusP/received_events",
         "repos_url" : "https://api.github.com/users/AngusP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AngusP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AngusP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AngusP"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599193199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599193199"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: could use `send_and_ping` here too (as in the other subtests).",
      "commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "created_at" : "2024-05-13T23:07:37Z",
      "diff_hunk" : "@@ -398,6 +427,154 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599193199",
      "id" : 1599193199,
      "line" : 465,
      "node_id" : "PRRC_kwDOABII585fUcBv",
      "original_commit_id" : "1aea9f21571470a37cc0a776bc16b9c2855a81d9",
      "original_line" : 465,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 108,
      "pull_request_review_id" : 2053800837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599193199/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-13T23:17:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599193199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599660492"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599660492"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T09:04:22Z",
      "diff_hunk" : "@@ -398,6 +427,154 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599660492",
      "id" : 1599660492,
      "in_reply_to_id" : 1599193199,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fWOHM",
      "original_commit_id" : "1aea9f21571470a37cc0a776bc16b9c2855a81d9",
      "original_line" : 465,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2054751541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599660492/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T09:36:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599660492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599660844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599660844"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T09:04:39Z",
      "diff_hunk" : "@@ -398,6 +427,154 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        # This ensures the peer's orphans were reconsidered.\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests missing tx_grandparent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599660844",
      "id" : 1599660844,
      "in_reply_to_id" : 1599138412,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fWOMs",
      "original_commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "original_line" : 504,
      "original_position" : 147,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2054751541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599660844/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T09:36:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599660844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599660982"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599660982"
         }
      },
      "author_association" : "MEMBER",
      "body" : "haha fixed",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T09:04:44Z",
      "diff_hunk" : "@@ -398,6 +427,154 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        # This ensures the peer's orphans were reconsidered.\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests missing tx_grandparent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested because the node shouldn't assume that the\n+        # witness data is the same. In this case, a same-txid-different-witness transaction exists!\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+        assert_equal(len(node.getrawmempool()), 0)\n+\n+        # 5. Hondest peer sends tx_grandparent",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599660982",
      "id" : 1599660982,
      "in_reply_to_id" : 1598780909,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fWOO2",
      "original_commit_id" : "1aea9f21571470a37cc0a776bc16b9c2855a81d9",
      "original_line" : 519,
      "original_position" : 162,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2054751541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599660982/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T09:36:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599660982",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599661537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599661537"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah I missed that `P2PInterface` already had that! Thanks, deleted the unnecessary stuff.",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T09:05:03Z",
      "diff_hunk" : "@@ -398,6 +427,154 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        # This ensures the peer's orphans were reconsidered.\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests missing tx_grandparent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested because the node shouldn't assume that the\n+        # witness data is the same. In this case, a same-txid-different-witness transaction exists!\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+        assert_equal(len(node.getrawmempool()), 0)\n+\n+        # 5. Hondest peer sends tx_grandparent\n+        honest_peer.send_and_ping(msg_tx(tx_grandparent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check node does not ignore announcement with same txid as tx in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child and fake version\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(PeerTxRelayer())\n+        # Must not send wtxidrelay because otherwise the inv(TX) will be ignored later\n+        honest_peer = node.add_p2p_connection(PeerTxRelayer(wtxidrelay=False))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599661537",
      "id" : 1599661537,
      "in_reply_to_id" : 1598790197,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fWOXh",
      "original_commit_id" : "1aea9f21571470a37cc0a776bc16b9c2855a81d9",
      "original_line" : 543,
      "original_position" : 186,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2054751541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599661537/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T09:36:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599661537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599667375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599667375"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, I've added a comment to help explain why we aren't asserting the exact error/disconnection.",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T09:09:23Z",
      "diff_hunk" : "@@ -398,6 +427,154 @@ def test_orphan_inherit_rejection(self):\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_message(msg_tx(tx_parent[\"tx\"]))\n+        # This ensures the peer's orphans were reconsidered.\n+        honest_peer.sync_with_ping()\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests missing tx_grandparent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the granchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested because the node shouldn't assume that the\n+        # witness data is the same. In this case, a same-txid-different-witness transaction exists!\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+        assert_equal(len(node.getrawmempool()), 0)\n+\n+        # 5. Hondest peer sends tx_grandparent\n+        honest_peer.send_and_ping(msg_tx(tx_grandparent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check node does not ignore announcement with same txid as tx in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child and fake version\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(PeerTxRelayer())\n+        # Must not send wtxidrelay because otherwise the inv(TX) will be ignored later\n+        honest_peer = node.add_p2p_connection(PeerTxRelayer(wtxidrelay=False))\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer announces the real child, by txid (this isn't common but the node should\n+        # still keep track of it).\n+        child_txid_int = int(tx_child[\"txid\"], 16)\n+        honest_peer.send_and_ping(msg_inv([CInv(t=MSG_TX, h=child_txid_int)]))\n+\n+        # 4. The child is requested. Honest peer sends it.\n+        node.bumpmocktime(TXREQUEST_TIME_SKIP)\n+        honest_peer.wait_for_getdata([child_txid_int])\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_message(msg_tx(tx_child[\"tx\"]))\n+\n+        # 5. After first parent request times out, the node sends another one for the missing parent\n+        # of the real orphan child.\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599667375",
      "id" : 1599667375,
      "in_reply_to_id" : 1599064530,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fWPyv",
      "original_commit_id" : "1aea9f21571470a37cc0a776bc16b9c2855a81d9",
      "original_line" : 571,
      "original_position" : 214,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : null,
      "pull_request_review_id" : 2054751541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599667375/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T09:36:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599667375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599669435"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599669435"
         }
      },
      "author_association" : "MEMBER",
      "body" : "changed to \"weight\" !",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T09:10:45Z",
      "diff_hunk" : "@@ -47,7 +47,7 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n         m_outpoint_to_orphan_it[txin.prevout].insert(ret.first);\n     }\n \n-    LogPrint(BCLog::TXPACKAGES, \"stored orphan tx %s (wtxid=%s) (mapsz %u outsz %u)\\n\", hash.ToString(), wtxid.ToString(),\n+    LogPrint(BCLog::TXPACKAGES, \"stored orphan tx %s (wtxid=%s), size: %u (mapsz %u outsz %u)\\n\", hash.ToString(), wtxid.ToString(), sz,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599669435",
      "id" : 1599669435,
      "in_reply_to_id" : 1598792832,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fWQS7",
      "original_commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "original_line" : 50,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : null,
      "pull_request_review_id" : 2054751541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599669435/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T09:36:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599669435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599702152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599702152"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a sentence to the comment, though slightly different wording. I've also expanded it in general.",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T09:33:42Z",
      "diff_hunk" : "@@ -2295,7 +2295,12 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    // Always query by wtxid, even if gtxid has a Txid type.\n+    // It is possible that the transaction in the orphanage has the same txid but a different\n+    // witness (e.g. malleated by an attacker) and we don't want to return false positives.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1599702152",
      "id" : 1599702152,
      "in_reply_to_id" : 1599118360,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fWYSI",
      "original_commit_id" : "16483fee7c6d93722bfb79fce9efbe841ec13d6a",
      "original_line" : 2300,
      "original_position" : 7,
      "original_start_line" : 2299,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 2054751541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599702152/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-14T09:36:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1599702152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/24941257406</sub>",
      "created_at" : "2024-05-14T09:39:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2109744175",
      "id" : 2109744175,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII5859wCQv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2109744175/reactions"
      },
      "updated_at" : "2024-05-14T11:53:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2109744175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600159941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600159941"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 7e475b9648bbee04f5825b922ba0399373eaa5a9:\r\n\r\nI think having the `if/else` path in this commit is helpful, since it distinguishes between when we cast the txid and when we don't.\r\n\r\nnit: I think this already works pretty well, but some bits (e.g. \"guess what the wtxid is\") are not super clear imo. I've summarized my understanding into the below, feel free to use what you like.\r\n\r\n```\r\n        // Never query by txid: it is possible that an existing transaction in the orphanage has the\r\n        // same txid but a different witness, which would give us a false positive result. If we\r\n        // don't request the transaction based on this result, an attacker could prevent us from\r\n        // downloading a transaction by intentionally creating a malleated version of it.\r\n        //\r\n        // False positive are unsafe and must be avoided.False negatives are acceptable and just\r\n        // lead to increased bandwidth usage.\r\n        //\r\n        // When gtxid is a txid it means when we don't have enough information to query by wtxid,\r\n        // e.g. because the transaction was announced by a non-wtxid-relay peer, or because we're\r\n        // checking the prevouts of a transaction. It doesn't mean that the transaction has no\r\n        // witness data, so we need to distinguish between those cases.\r\n        //\r\n        // If the transaction:\r\n        // 1) does not have witness data, we can safely query the orphanage by casting a txid to a\r\n        //    wtxid because they are equivalent. False positives and false negatives are impossible.\r\n        // 2) has witness data, the txid and wtxid are different by definition, making this query a\r\n        //    no-op. False positives are not possible, but we may have false negatives.\r\n        //\r\n        // So, by querying for a txid cast to a wtxid, we avoid false positives entirely, but we\r\n        // save bandwidth for the case where txid == wtxid.\r\n```\r\n\r\nside-note rant: I think the fact that we need such a verbose comment is a pretty strong sign `AlreadyHaveTx` should be refactored, e.g. using `{Wt,T}xid` types as I suggested [here](https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1587694422), but I appreciate that it's mostly orthogonal to this PR. Renaming `AlreadyHaveTx` to e.g. `ShouldRequestTx` or something would probably already clarify quite a bit, too (although also not blocking for this PR either).",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T14:36:23Z",
      "diff_hunk" : "@@ -2295,7 +2295,20 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    if (gtxid.IsWtxid()) {\n+        // Normal query by wtxid.\n+        if (m_orphanage.HaveTx(gtxid)) return true;\n+    } else {\n+        // Never query by txid: it is possible that the transaction in the orphanage has the same\n+        // txid but a different witness, which would give us a false positive result. If we decided\n+        // not to request the transaction based on this result, an attacker could prevent us from\n+        // downloading a transaction by intentionally creating a malleated version of it.\n+        //\n+        // While we won't query by txid, we can try to \"guess\" what the wtxid is based on the txid.\n+        // A non-segwit transaction's txid == wtxid. Query this txid \"casted\" to a wtxid. This will\n+        // help us find non-segwit transactions, saving bandwidth, and should have no false positives.\n+        if (m_orphanage.HaveTx(GenTxid::Wtxid(hash))) return true;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600159941",
      "id" : 1600159941,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585fYIDF",
      "original_commit_id" : "7e475b9648bbee04f5825b922ba0399373eaa5a9",
      "original_line" : 2311,
      "original_position" : 18,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 2053065161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600159941/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-14T18:34:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600159941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600233020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600233020"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(since @sr-gi mentioned this offline) Yes, the last push turned this 1 line into 2 identical lines. The purpose is to illustrate to current reviewers and future readers more clearly... if wtxid, we do this. if txid, we also do this, but notice that we are actually doing a \"cast\" and that's ok because we are *guessing* what the wtxid is.\r\n\r\nAlso, perhaps these will diverge again in the future if `GenTxid` becomes a `std::variant<Txid, Wtxid>`.",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T15:20:20Z",
      "diff_hunk" : "@@ -2295,7 +2295,23 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n \n     const uint256& hash = gtxid.GetHash();\n \n-    if (m_orphanage.HaveTx(gtxid)) return true;\n+    if (gtxid.IsWtxid()) {\n+        // Normal query by wtxid.\n+        if (m_orphanage.HaveTx(Wtxid::FromUint256(hash))) return true;\n+    } else {\n+        // Never query by txid: it is possible that the transaction in the orphanage has the same\n+        // txid but a different witness, which would give us a false positive result. If we decided\n+        // not to request the transaction based on this result, an attacker could prevent us from\n+        // downloading a transaction by intentionally creating a malleated version of it.  While\n+        // only one (or none!) of these transactions can ultimately be confirmed, we have no way of\n+        // discerning which one that is, so the orphanage can store multiple transactions with the\n+        // same txid.\n+        //\n+        // While we won't query by txid, we can try to \"guess\" what the wtxid is based on the txid.\n+        // A non-segwit transaction's txid == wtxid. Query this txid \"casted\" to a wtxid. This will\n+        // help us find non-segwit transactions, saving bandwidth, and should have no false positives.\n+        if (m_orphanage.HaveTx(Wtxid::FromUint256(hash))) return true;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600233020",
      "id" : 1600233020,
      "line" : 2314,
      "node_id" : "PRRC_kwDOABII585fYZ48",
      "original_commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "original_line" : 2314,
      "original_position" : 21,
      "original_start_line" : 2298,
      "path" : "src/net_processing.cpp",
      "position" : 21,
      "pull_request_review_id" : 2055731535,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600233020/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2298,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-14T15:20:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600233020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600235258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600235258"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "c++-20 nit:\r\n```suggestion\r\n    if (m_orphans.contains(wtxid))\r\n```",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T15:21:56Z",
      "diff_hunk" : "@@ -23,7 +23,7 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n \n     const Txid& hash = tx->GetHash();\n     const Wtxid& wtxid = tx->GetWitnessHash();\n-    if (m_orphans.count(hash))\n+    if (m_orphans.count(wtxid))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600235258",
      "id" : 1600235258,
      "line" : 26,
      "node_id" : "PRRC_kwDOABII585fYab6",
      "original_commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "original_line" : 26,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 5,
      "pull_request_review_id" : 2053065161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600235258/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T18:34:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600235258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600235908"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600235908"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "c++20-nit:\r\n```suggestion\r\n    return m_orphans.contains(wtxid);\r\n```",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T15:22:24Z",
      "diff_hunk" : "@@ -169,14 +169,10 @@ void TxOrphanage::AddChildrenToWorkSet(const CTransaction& tx)\n     }\n }\n \n-bool TxOrphanage::HaveTx(const GenTxid& gtxid) const\n+bool TxOrphanage::HaveTx(const Wtxid& wtxid) const\n {\n     LOCK(m_mutex);\n-    if (gtxid.IsWtxid()) {\n-        return m_wtxid_to_orphan_it.count(Wtxid::FromUint256(gtxid.GetHash()));\n-    } else {\n-        return m_orphans.count(Txid::FromUint256(gtxid.GetHash()));\n-    }\n+    return m_orphans.count(wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600235908",
      "id" : 1600235908,
      "line" : 175,
      "node_id" : "PRRC_kwDOABII585fYamE",
      "original_commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "original_line" : 175,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/txorphanage.cpp",
      "position" : 132,
      "pull_request_review_id" : 2053065161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600235908/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T18:34:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600235908",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600252935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600252935"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 8923edfc1f12ebc6a074651c084ba7d249074799:\r\n\r\nnit: I feel like documentation on why `TxOrphanage` indexes by wtxid/allows multiple versions of the same transaction should be documented in `TxOrphanage` instead of here.",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T15:32:50Z",
      "diff_hunk" : "@@ -2302,7 +2302,10 @@ bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid, bool include_reconside\n         // Never query by txid: it is possible that the transaction in the orphanage has the same\n         // txid but a different witness, which would give us a false positive result. If we decided\n         // not to request the transaction based on this result, an attacker could prevent us from\n-        // downloading a transaction by intentionally creating a malleated version of it.\n+        // downloading a transaction by intentionally creating a malleated version of it.  While\n+        // only one (or none!) of these transactions can ultimately be confirmed, we have no way of\n+        // discerning which one that is, so the orphanage can store multiple transactions with the\n+        // same txid.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600252935",
      "id" : 1600252935,
      "line" : 2308,
      "node_id" : "PRRC_kwDOABII585fYewH",
      "original_commit_id" : "8923edfc1f12ebc6a074651c084ba7d249074799",
      "original_line" : 2308,
      "original_position" : 8,
      "original_start_line" : 2305,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 2053065161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600252935/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2305,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-14T18:34:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600252935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T16:20:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2110638042",
      "id" : 2110638042,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII5859zcfa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2110638042/reactions"
      },
      "updated_at" : "2024-05-14T16:20:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2110638042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1328814?v=4",
         "events_url" : "https://api.github.com/users/AngusP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AngusP/followers",
         "following_url" : "https://api.github.com/users/AngusP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AngusP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AngusP",
         "id" : 1328814,
         "login" : "AngusP",
         "node_id" : "MDQ6VXNlcjEzMjg4MTQ=",
         "organizations_url" : "https://api.github.com/users/AngusP/orgs",
         "received_events_url" : "https://api.github.com/users/AngusP/received_events",
         "repos_url" : "https://api.github.com/users/AngusP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AngusP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AngusP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AngusP"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600337905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600337905"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I first interpreted that as that an input had been removed from the transaction, perhaps better to use \"parent\" as to stay consistent with the language in the next steps?\r\n```suggestion\r\n        # 1. Fake orphan is received first, the parent is not yet broadcast.\r\n```",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T16:31:35Z",
      "diff_hunk" : "@@ -394,10 +412,161 @@ def test_orphan_inherit_rejection(self):\n         peer2.assert_never_requested(child[\"tx\"].getwtxid())\n \n         # The child should never be requested, even if announced again with potentially different witness.\n+        # Sync with ping to ensure orphans are reconsidered\n         peer3.send_and_ping(msg_inv([CInv(t=MSG_TX, h=int(child[\"txid\"], 16))]))\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600337905",
      "id" : 1600337905,
      "line" : 436,
      "node_id" : "PRRC_kwDOABII585fYzfx",
      "original_commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "original_line" : 436,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 74,
      "pull_request_review_id" : 2053065161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600337905/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T18:34:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600337905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600351923"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600351923"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, potential follow-up material: the test is imho a bit easier to follow if the naming refers to the original (non-malleated) counter-part:\r\n```suggestion\r\n        tx_child_bad_wit = self.create_malleated_version(tx_child)\r\n```\r\n(same as for the other two sub-tests below)",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T16:42:15Z",
      "diff_hunk" : "@@ -394,10 +412,161 @@ def test_orphan_inherit_rejection(self):\n         peer2.assert_never_requested(child[\"tx\"].getwtxid())\n \n         # The child should never be requested, even if announced again with potentially different witness.\n+        # Sync with ping to ensure orphans are reconsidered\n         peer3.send_and_ping(msg_inv([CInv(t=MSG_TX, h=int(child[\"txid\"], 16))]))\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600351923",
      "id" : 1600351923,
      "line" : 431,
      "node_id" : "PRRC_kwDOABII585fY26z",
      "original_commit_id" : "b16da7eda76944719713be68b61f03d4acdd3e16",
      "original_line" : 431,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 69,
      "pull_request_review_id" : 2055922168,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600351923/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T16:55:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600351923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600356156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600356156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: would `tx_middle_bad_wit` be more consistent naming here?",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T16:45:48Z",
      "diff_hunk" : "@@ -394,10 +412,161 @@ def test_orphan_inherit_rejection(self):\n         peer2.assert_never_requested(child[\"tx\"].getwtxid())\n \n         # The child should never be requested, even if announced again with potentially different witness.\n+        # Sync with ping to ensure orphans are reconsidered\n         peer3.send_and_ping(msg_inv([CInv(t=MSG_TX, h=int(child[\"txid\"], 16))]))\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        # Sync with ping to ensure orphans are reconsidered\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600356156",
      "id" : 1600356156,
      "line" : 476,
      "node_id" : "PRRC_kwDOABII585fY388",
      "original_commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "original_line" : 476,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 114,
      "pull_request_review_id" : 2053065161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600356156/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T18:34:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600356156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600417106"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600417106"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In b16da7eda76944719713be68b61f03d4acdd3e16\r\n\r\nThe fake one is not really rejected, is it? It'll stay in the orphanage until a new block is mined (or until it times out)",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T17:36:41Z",
      "diff_hunk" : "@@ -394,10 +412,161 @@ def test_orphan_inherit_rejection(self):\n         peer2.assert_never_requested(child[\"tx\"].getwtxid())\n \n         # The child should never be requested, even if announced again with potentially different witness.\n+        # Sync with ping to ensure orphans are reconsidered\n         peer3.send_and_ping(msg_inv([CInv(t=MSG_TX, h=int(child[\"txid\"], 16))]))\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        # Sync with ping to ensure orphans are reconsidered\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600417106",
      "id" : 1600417106,
      "line" : 459,
      "node_id" : "PRRC_kwDOABII585fZG1S",
      "original_commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "original_line" : 459,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 97,
      "pull_request_review_id" : 2056028500,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600417106/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-14T17:48:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600417106",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600431768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600431768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In b16da7eda76944719713be68b61f03d4acdd3e16\r\n\r\nIs this the case? Didn't we prioritize children from the same peer, so given the parent was given by the honest, and he also has presented a child, we will pick that one?\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/src/net_processing.cpp#L3341-L3344\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/src/net_processing.cpp#L3361-L3363\r\n\r\n",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T17:47:07Z",
      "diff_hunk" : "@@ -394,10 +412,161 @@ def test_orphan_inherit_rejection(self):\n         peer2.assert_never_requested(child[\"tx\"].getwtxid())\n \n         # The child should never be requested, even if announced again with potentially different witness.\n+        # Sync with ping to ensure orphans are reconsidered\n         peer3.send_and_ping(msg_inv([CInv(t=MSG_TX, h=int(child[\"txid\"], 16))]))\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        # Sync with ping to ensure orphans are reconsidered\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests missing tx_grandparent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the grandchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested because the node shouldn't assume that the\n+        # witness data is the same. In this case, a same-txid-different-witness transaction exists!\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+        assert_equal(len(node.getrawmempool()), 0)\n+\n+        # 5. Honest peer sends tx_grandparent\n+        honest_peer.send_and_ping(msg_tx(tx_grandparent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check node does not ignore announcement with same txid as tx in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child and fake version\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(PeerTxRelayer())\n+        # Must not send wtxidrelay because otherwise the inv(TX) will be ignored later\n+        honest_peer = node.add_p2p_connection(P2PInterface(wtxidrelay=False))\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer announces the real child, by txid (this isn't common but the node should\n+        # still keep track of it).\n+        child_txid_int = int(tx_child[\"txid\"], 16)\n+        honest_peer.send_and_ping(msg_inv([CInv(t=MSG_TX, h=child_txid_int)]))\n+\n+        # 4. The child is requested. Honest peer sends it.\n+        node.bumpmocktime(TXREQUEST_TIME_SKIP)\n+        honest_peer.wait_for_getdata([child_txid_int])\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # 5. After first parent request times out, the node sends another one for the missing parent\n+        # of the real orphan child.\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected. This may happen in either\n+        # order since the message-processing is randomized. If tx_orphan_bad_wit is validated first,\n+        # its consensus error leads to disconnection of bad_peer. If tx_child is validated first,\n+        # tx_orphan_bad_wit is rejected for txn-same-nonwitness-data-in-mempool (no punishment).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1600431768",
      "id" : 1600431768,
      "line" : 563,
      "node_id" : "PRRC_kwDOABII585fZKaY",
      "original_commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "original_line" : 563,
      "original_position" : 201,
      "original_start_line" : 559,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 201,
      "pull_request_review_id" : 2056028500,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600431768/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 559,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-14T17:48:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1600431768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Maybe adding some \"this is intended\" comment would make sense for a follow-up.\r\n\r\nCould make the 'cast' explicit in the second branch, though there's already the comment making it pretty clear this is intentional so may be unnecessary\r\n\r\n```c++\r\nconst auto guessed_wtxid = Wtxid::FromUint256(hash);\r\nif (m_orphanage.HaveTx(guessed_wtxid)) return true;\r\n```",
      "created_at" : "2024-05-14T17:48:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2110795746",
      "id" : 2110795746,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII58590C_i",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2110795746/reactions"
      },
      "updated_at" : "2024-05-14T17:48:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2110795746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1328814?v=4",
         "events_url" : "https://api.github.com/users/AngusP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AngusP/followers",
         "following_url" : "https://api.github.com/users/AngusP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AngusP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AngusP",
         "id" : 1328814,
         "login" : "AngusP",
         "node_id" : "MDQ6VXNlcjEzMjg4MTQ=",
         "organizations_url" : "https://api.github.com/users/AngusP/orgs",
         "received_events_url" : "https://api.github.com/users/AngusP/received_events",
         "repos_url" : "https://api.github.com/users/AngusP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AngusP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AngusP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AngusP"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "trACK 0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-14T18:34:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#issuecomment-2110867498",
      "id" : 2110867498,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30000",
      "node_id" : "IC_kwDOABII58590Ugq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2110867498/reactions"
      },
      "updated_at" : "2024-05-14T18:34:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2110867498",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11520757?v=4",
         "events_url" : "https://api.github.com/users/itornaza/events{/privacy}",
         "followers_url" : "https://api.github.com/users/itornaza/followers",
         "following_url" : "https://api.github.com/users/itornaza/following{/other_user}",
         "gists_url" : "https://api.github.com/users/itornaza/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/itornaza",
         "id" : 11520757,
         "login" : "itornaza",
         "node_id" : "MDQ6VXNlcjExNTIwNzU3",
         "organizations_url" : "https://api.github.com/users/itornaza/orgs",
         "received_events_url" : "https://api.github.com/users/itornaza/received_events",
         "repos_url" : "https://api.github.com/users/itornaza/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/itornaza/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/itornaza/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/itornaza"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1601351165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1601351165"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're referring to the 1p1c logic, which isn't executed here (notice that all of the feerates are \"normal\" feerates).\r\nHere, the orphans are reconsidered with `ProcessOrphanTx`, which is called at the top of `ProcessMessages`.\r\nhttps://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/src/net_processing.cpp#L5355-L5369\r\n\r\n`ProcessMessages` is called for each peer in a random order\r\nhttps://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/src/net.cpp#L2945-L2955",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-15T10:08:12Z",
      "diff_hunk" : "@@ -394,10 +412,161 @@ def test_orphan_inherit_rejection(self):\n         peer2.assert_never_requested(child[\"tx\"].getwtxid())\n \n         # The child should never be requested, even if announced again with potentially different witness.\n+        # Sync with ping to ensure orphans are reconsidered\n         peer3.send_and_ping(msg_inv([CInv(t=MSG_TX, h=int(child[\"txid\"], 16))]))\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        # Sync with ping to ensure orphans are reconsidered\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_parent[\"txid\"] in node_mempool\n+        assert tx_child[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_child[\"txid\"])[\"wtxid\"], tx_child[\"wtxid\"])\n+\n+    @cleanup\n+    def test_same_txid_orphan_of_orphan(self):\n+        self.log.info(\"Check what happens when orphan's parent with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_grandparent = self.wallet.create_self_transfer()\n+\n+        # Create middle tx (both parent and child) which will be in orphanage.\n+        tx_middle = self.wallet.create_self_transfer(utxo_to_spend=tx_grandparent[\"new_utxo\"])\n+\n+        # Create a fake version of the middle tx\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_middle)\n+\n+        # Create grandchild spending from tx_middle (and spending from tx_orphan_bad_wit since they\n+        # have the same txid).\n+        tx_grandchild = self.wallet.create_self_transfer(utxo_to_spend=tx_middle[\"new_utxo\"])\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests missing tx_grandparent by txid.\n+        grandparent_txid_int = int(tx_grandparent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([grandparent_txid_int])\n+\n+        # 3. Honest peer relays the grandchild, which is missing a parent. The parent by txid already\n+        # exists in orphanage, but should be re-requested because the node shouldn't assume that the\n+        # witness data is the same. In this case, a same-txid-different-witness transaction exists!\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_grandchild[\"tx\"]))\n+        middle_txid_int = int(tx_middle[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        honest_peer.wait_for_getdata([middle_txid_int])\n+\n+        # 4. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_middle[\"tx\"]))\n+        assert_equal(len(node.getrawmempool()), 0)\n+\n+        # 5. Honest peer sends tx_grandparent\n+        honest_peer.send_and_ping(msg_tx(tx_grandparent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.\n+        node_mempool = node.getrawmempool()\n+        assert tx_grandparent[\"txid\"] in node_mempool\n+        assert tx_middle[\"txid\"] in node_mempool\n+        assert tx_grandchild[\"txid\"] in node_mempool\n+        assert_equal(node.getmempoolentry(tx_middle[\"txid\"])[\"wtxid\"], tx_middle[\"wtxid\"])\n+\n+    @cleanup\n+    def test_orphan_txid_inv(self):\n+        self.log.info(\"Check node does not ignore announcement with same txid as tx in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child and fake version\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(PeerTxRelayer())\n+        # Must not send wtxidrelay because otherwise the inv(TX) will be ignored later\n+        honest_peer = node.add_p2p_connection(P2PInterface(wtxidrelay=False))\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer announces the real child, by txid (this isn't common but the node should\n+        # still keep track of it).\n+        child_txid_int = int(tx_child[\"txid\"], 16)\n+        honest_peer.send_and_ping(msg_inv([CInv(t=MSG_TX, h=child_txid_int)]))\n+\n+        # 4. The child is requested. Honest peer sends it.\n+        node.bumpmocktime(TXREQUEST_TIME_SKIP)\n+        honest_peer.wait_for_getdata([child_txid_int])\n+        with node.assert_debug_log([\"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # 5. After first parent request times out, the node sends another one for the missing parent\n+        # of the real orphan child.\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 6. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected. This may happen in either\n+        # order since the message-processing is randomized. If tx_orphan_bad_wit is validated first,\n+        # its consensus error leads to disconnection of bad_peer. If tx_child is validated first,\n+        # tx_orphan_bad_wit is rejected for txn-same-nonwitness-data-in-mempool (no punishment).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1601351165",
      "id" : 1601351165,
      "in_reply_to_id" : 1600431768,
      "line" : 563,
      "node_id" : "PRRC_kwDOABII585fcq39",
      "original_commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "original_line" : 563,
      "original_position" : 201,
      "original_start_line" : 559,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 201,
      "pull_request_review_id" : 2057529200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1601351165/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 559,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-05-15T10:08:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1601351165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1601354578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1601354578"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is rejected. The acceptance of the parent triggers the node to reconsider all children in orphanage (grep `AddChildrenToWorkset`. If the failure isn't `TX_MISSING_INPUTS`, it is removed from orphanage.\r\nhttps://github.com/bitcoin/bitcoin/blob/dbb3113082a75035b14d20021036d2166171976e/src/net_processing.cpp#L3402-L3414",
      "commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "created_at" : "2024-05-15T10:10:53Z",
      "diff_hunk" : "@@ -394,10 +412,161 @@ def test_orphan_inherit_rejection(self):\n         peer2.assert_never_requested(child[\"tx\"].getwtxid())\n \n         # The child should never be requested, even if announced again with potentially different witness.\n+        # Sync with ping to ensure orphans are reconsidered\n         peer3.send_and_ping(msg_inv([CInv(t=MSG_TX, h=int(child[\"txid\"], 16))]))\n         self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n         peer3.assert_never_requested(child[\"txid\"])\n \n+    @cleanup\n+    def test_same_txid_orphan(self):\n+        self.log.info(\"Check what happens when orphan with same txid is already in orphanage\")\n+        node = self.nodes[0]\n+\n+        tx_parent = self.wallet.create_self_transfer()\n+\n+        # Create the real child\n+        tx_child = self.wallet.create_self_transfer(utxo_to_spend=tx_parent[\"new_utxo\"])\n+\n+        # Create a fake version of the child\n+        tx_orphan_bad_wit = self.create_malleated_version(tx_child)\n+\n+        bad_peer = node.add_p2p_connection(P2PInterface())\n+        honest_peer = node.add_p2p_connection(P2PInterface())\n+\n+        # 1. Fake orphan is received first. It is missing an input.\n+        bad_peer.send_and_ping(msg_tx(tx_orphan_bad_wit))\n+\n+        # 2. Node requests the missing parent by txid.\n+        parent_txid_int = int(tx_parent[\"txid\"], 16)\n+        node.bumpmocktime(NONPREF_PEER_TX_DELAY + TXID_RELAY_DELAY)\n+        bad_peer.wait_for_getdata([parent_txid_int])\n+\n+        # 3. Honest peer relays the real child, which is also missing parents and should be placed\n+        # in the orphanage.\n+        with node.assert_debug_log([\"missingorspent\", \"stored orphan tx\"]):\n+            honest_peer.send_and_ping(msg_tx(tx_child[\"tx\"]))\n+\n+        # Time out the previous request for the parent (node will not request the same transaction\n+        # from multiple nodes at the same time)\n+        node.bumpmocktime(GETDATA_TX_INTERVAL)\n+\n+        # 4. The parent is requested. Honest peer sends it.\n+        honest_peer.wait_for_getdata([parent_txid_int])\n+        # Sync with ping to ensure orphans are reconsidered\n+        honest_peer.send_and_ping(msg_tx(tx_parent[\"tx\"]))\n+\n+        # 5. After parent is accepted, orphans should be reconsidered.\n+        # The real child should be accepted and the fake one rejected.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30000#discussion_r1601354578",
      "id" : 1601354578,
      "in_reply_to_id" : 1600417106,
      "line" : 459,
      "node_id" : "PRRC_kwDOABII585fcrtS",
      "original_commit_id" : "0fb17bf61a40b73a2b81a18e70b3de180c917f22",
      "original_line" : 459,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "test/functional/p2p_orphan_handling.py",
      "position" : 97,
      "pull_request_review_id" : 2057534574,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30000",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1601354578/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-05-15T10:10:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1601354578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   }
]
