[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2023-09-12T20:36:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28463#issuecomment-1716393130",
      "id" : 1716393130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28463",
      "node_id" : "IC_kwDOABII585mThSq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1716393130/reactions"
      },
      "updated_at" : "2023-09-12T20:36:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1716393130",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "### Status Quo\r\nWe have a default maximum of 125 connections (not counting manual ones). Out of these, \r\n11 (8 full outbounds, 2 block-relay-only, 1 feeler) are reserved for outbounds, leaving us with \r\n114 inbound slots. There are currently no limits on how many of the inbounds can support transaction relay.\r\n\r\n### Problem\r\nWe want to increase the number of inbound slots specifically offered to block-relay-only connections, but don't want to significantly change the number of tx-relaying inbound peers, because we donât want to radically change the memory and traffic requirements that come with running a full node with the default configuration.\r\nThis is complicated by a timing issue: When a new peer connects to us, we don't know yet whether it is block-relay-only before we have processed their version message.\r\nInbound peer eviction, however, happens right after a peer connects to us and before processing its version msg. This means that we don't yet know during inbound eviction, if the new peer wants tx relay.\r\n\r\n### Approach\r\nWe propose to introduce a separate maximum of tx-relaying inbound connections, in addition to the existing global maximum.\r\nThe new maximum for tx-relaying inbounds gets chosen such that 60% of the total inbound slots can be utilized by tx-relaying peers. We choose a ratio here instead of a fixed number here so that it scales with users changing their `-maxconnections` value from the default. The ratio of 60% is also made adjustable in the form of a new startup parameter. \r\n\r\n### Changes to the eviction logic\r\nUpon a new peer connection, we treat them as tx-relay while doing a possible eviction, until we have processed their version message. Furthermore, we change the eviction logic as follows: \r\nFirst check if the maximum for tx-relaying inbounds is exceeded, and if so, run the eviction algorithm specifically for tx-relaying peers (protecting all block-relay-only peers).\r\nIf that didnât result in an eviction, also check if the global maximum is breached, and run the existing eviction algorithm for all peers.\r\nAs a consequence of this, block-relay-only peers may occupy some of the tx-relay connection slots like today (no specific limit is imposed for block-relay-only inbounds) but the reverse is not true.\r\n\r\nThis approach achieves that the number of tx-relaying peers can never exceed the limit without the need to delay the eviction decision after the version processing. One possible downside is that if all tx-relay inbound slots are full but we have capacity for block-relay-only inbound peers, we can evict a tx-relay peer after a new peer connects, even if itâs block-relay-only. However, this affects just one inbound slot: When the incoming peer has sent their version and is known to be block-relay-only, the tx-relay inbound slot it temporarily had will be free again.\r\n\r\n### Numbers\r\nSpecifically, we propose to increase the total number of connections from 125 to 200, with a  suggested ratio of 60% tx-relay inbounds. With 11 connection slots reserved for outbound peers, \r\nthis results in (200 - 11) * 0.6 = 113 slots for tx-relaying inbound peers, which closely aligns with the current count of 114.\r\nThese numbers were chosen to be sufficient to raise the number of block-relay-only connections from 2 to 8 once this patch is widely deployed (see Issue #28462 for more details on this).\r\n\r\n### Handling bloom filter peers\r\nThe logic gets a bit complicated if a node supports BIP37 (bloom filters), because then an inbound peer can be switched to tx-relay after sending a `FILTERLOAD` or `FILTERCLEAR` message (but never back!), which could result in an excess of tx-relaying inbounds. We propose to solve this by triggering the eviction logic for a tx-relaying from `net_processing` whenever we switch a peer to tx-relay due to a BIP37-related message.\r\n",
      "created_at" : "2023-09-12T20:37:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28463#issuecomment-1716393675",
      "id" : 1716393675,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28463",
      "node_id" : "IC_kwDOABII585mThbL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1716393675/reactions"
      },
      "updated_at" : "2023-09-12T20:37:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1716393675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
