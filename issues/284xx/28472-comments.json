[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28471](https://github.com/bitcoin/bitcoin/pull/28471) (Fix virtual size limit enforcement in transaction package context by instagibbs)\n* [#28335](https://github.com/bitcoin/bitcoin/pull/28335) (RFC: Remove boost usage from kernel api / headers by TheCharlatan)\n* [#26711](https://github.com/bitcoin/bitcoin/pull/26711) (validate package transactions with their in-package ancestor sets by glozow)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-09-13T18:33:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28472#issuecomment-1718125464",
      "id" : 1718125464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28472",
      "node_id" : "IC_kwDOABII585maIOY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718125464/reactions"
      },
      "updated_at" : "2023-09-14T19:34:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1718125464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28472#discussion_r1325174467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325174467"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This prevents `PackageMempoolChecks` and `SubmitPackage` from seeing the bumped limits. Maybe have `const m_base_limits` and `m_current_limits` and have `PreChecks()` reset `m_current_limits=m_base_limits` before bumping it?",
      "commit_id" : "275687f03f6fb6b9960543b240e05af02cab5da1",
      "created_at" : "2023-09-13T23:45:35Z",
      "diff_hunk" : "@@ -905,11 +909,11 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n         assert(ws.m_iters_conflicting.size() == 1);\n         CTxMemPool::txiter conflict = *ws.m_iters_conflicting.begin();\n \n-        m_limits.descendant_count += 1;\n-        m_limits.descendant_size_vbytes += conflict->GetSizeWithDescendants();\n+        maybe_rbf_limits.descendant_count += 1;\n+        maybe_rbf_limits.descendant_size_vbytes += conflict->GetSizeWithDescendants();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28472#discussion_r1325174467",
      "id" : 1325174467,
      "line" : 913,
      "node_id" : "PRRC_kwDOABII585O_I7D",
      "original_commit_id" : "275687f03f6fb6b9960543b240e05af02cab5da1",
      "original_line" : 913,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 27,
      "pull_request_review_id" : 1625596163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28472",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325174467/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-13T23:45:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1325174467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Could you add a test?",
      "created_at" : "2023-09-14T10:43:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28472#issuecomment-1719211409",
      "id" : 1719211409,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28472",
      "node_id" : "IC_kwDOABII585meRWR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719211409/reactions"
      },
      "updated_at" : "2023-09-14T10:43:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719211409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@glozow good idea, I think removing it entirely makes a lot of sense if your assumptions are correct, and they sound correct to me.\r\n\r\n@dergoegge ~Ok, I don't think this is easy(possible?) to hit in master as it shows easier when `PreChecks` are being called more often, and allowed to fail the first time, such as https://github.com/bitcoin/bitcoin/pull/26711~ it's possible\r\n\r\nExample on ~#26711~ master\r\n```\r\nancestor limit: 2\r\ndescendant limit: 1\r\n\r\nA (already in mempool, to be RBF'd by A')\r\nA' -> B (A is RBF'd  and where B > 4kWu)\r\n\r\nif you run PreChecks once over A', then B, it's now 2 and 2(thanks to RBF of A), making A'+B  allowed even though it shouldn't be\r\n```",
      "created_at" : "2023-09-14T17:37:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28472#issuecomment-1719874242",
      "id" : 1719874242,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28472",
      "node_id" : "IC_kwDOABII585mgzLC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719874242/reactions"
      },
      "updated_at" : "2023-09-14T18:26:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719874242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Pushed a test that fails on master",
      "created_at" : "2023-09-14T18:26:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28472#issuecomment-1719939370",
      "id" : 1719939370,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28472",
      "node_id" : "IC_kwDOABII585mhDEq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719939370/reactions"
      },
      "updated_at" : "2023-09-14T18:26:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1719939370",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28472#discussion_r1326877400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326877400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\r\n```\r\n test  2023-09-14T23:10:39.063000Z TestFramework (ERROR): Assertion failed \r\n                                   Traceback (most recent call last):\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/test_framework/util.py\", line 140, in try_rpc\r\n                                       fun(*args, **kwds)\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/test_framework/coverage.py\", line 50, in __call__\r\n                                       return_val = self.auth_service_proxy_instance.__call__(*args, **kwargs)\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/test_framework/authproxy.py\", line 129, in __call__\r\n                                       raise JSONRPCException(response['error'], status)\r\n                                   test_framework.authproxy.JSONRPCException: c15f8dbec585be90e17a0757b8a6ad3f21863ae9db90a5d69ad31e5c047c8f7e failed: mempool min fee not met (-26)\r\n                                   During handling of the above exception, another exception occurred:\r\n                                   Traceback (most recent call last):\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 131, in main\r\n                                       self.run_test()\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/mempool_limit.py\", line 375, in run_test\r\n                                       self.test_rbf_carveout_disallowed()\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/mempool_limit.py\", line 127, in test_rbf_carveout_disallowed\r\n                                       assert_raises_rpc_error(-26, \"too-long-mempool-chain\", node.submitpackage, [tx_B[\"hex\"], tx_C[\"hex\"]])\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/test_framework/util.py\", line 131, in assert_raises_rpc_error\r\n                                       assert try_rpc(code, message, fun, *args, **kwds), \"No exception raised\"\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-i686-pc-linux-gnu/test/functional/test_framework/util.py\", line 146, in try_rpc\r\n                                       raise AssertionError(\r\n                                   AssertionError: Expected substring not found in error message:\r\n                                   substring: 'too-long-mempool-chain'\r\n                                   error message: 'c15f8dbec585be90e17a0757b8a6ad3f21863ae9db90a5d69ad31e5c047c8f7e failed: mempool min fee not met'.",
      "commit_id" : "1b7f54b0339f38a15e2039981a021c58b07beaad",
      "created_at" : "2023-09-15T06:55:26Z",
      "diff_hunk" : "@@ -78,6 +78,54 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_rbf_carveout_disallowed(self):\n+        node = self.nodes[0]\n+\n+        self.log.info(\"Check that individually-evaluated transactions in a package don't increase package limits for other subpackage parts\")\n+\n+        # We set chain limits to 2 ancestors, 1 descendant, then try to get a parents-and-child chain of 2 in mempool\n+        #\n+        # A: Solo transaction to be RBF'd (to bump descendant limit for package later)\n+        # B: First transaction in package, RBFs A by itself under individual evaluation, which would give it +1 descendant limit\n+        # C: Second transaction in package, spends C. If the +1 descendant limit persisted, would make it into mempool\n+\n+        self.restart_node(0, extra_args=self.extra_args[0] + [\"-limitancestorcount=2\", \"-limitdescendantcount=1\"])\n+\n+        # Generate a confirmed utxo we will double-spend\n+        rbf_utxo = self.wallet.send_self_transfer(\n+            from_node=node,\n+            confirmed_only=True\n+        )[\"new_utxo\"]\n+        self.generate(node, 1)\n+\n+        # tx_A needs to be RBF'd, set minfee at set size\n+        A_weight = 1000\n+        mempoolmin_feerate = node.getmempoolinfo()[\"mempoolminfee\"]\n+        tx_A = self.wallet.send_self_transfer(\n+            from_node=node,\n+            fee=(mempoolmin_feerate / 1000) * (A_weight // 4) + Decimal('0.000001'),\n+            target_weight=A_weight,\n+            utxo_to_spend=rbf_utxo,\n+            confirmed_only=True\n+        )\n+\n+        # RBF's tx_A, is not yet submitted\n+        tx_B = self.wallet.create_self_transfer(\n+            fee=tx_A[\"fee\"] * 4,\n+            target_weight=A_weight,\n+            utxo_to_spend=rbf_utxo,\n+            confirmed_only=True\n+        )\n+\n+        # Spends tx_B's output, too big for cpfp carveout (because that would also increase the descendant limit by 1)\n+        tx_C = self.wallet.create_self_transfer(\n+            target_weight=40001, # EXTRA_DESCENDANT_TX_SIZE_LIMIT + 1\n+            utxo_to_spend=tx_B[\"new_utxo\"],\n+            confirmed_only=True\n+        )\n+\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", node.submitpackage, [tx_B[\"hex\"], tx_C[\"hex\"]])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28472#discussion_r1326877400",
      "id" : 1326877400,
      "line" : 129,
      "node_id" : "PRRC_kwDOABII585PForY",
      "original_commit_id" : "cddf03e3fb6ade4f5efbc053ee8177c7236a9132",
      "original_line" : 129,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 52,
      "pull_request_review_id" : 1628317402,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28472",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326877400/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-15T06:55:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326877400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28472#discussion_r1326877476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326877476"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://cirrus-ci.com/task/6070864190373888?logs=ci#L3352",
      "commit_id" : "1b7f54b0339f38a15e2039981a021c58b07beaad",
      "created_at" : "2023-09-15T06:55:31Z",
      "diff_hunk" : "@@ -78,6 +78,54 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_rbf_carveout_disallowed(self):\n+        node = self.nodes[0]\n+\n+        self.log.info(\"Check that individually-evaluated transactions in a package don't increase package limits for other subpackage parts\")\n+\n+        # We set chain limits to 2 ancestors, 1 descendant, then try to get a parents-and-child chain of 2 in mempool\n+        #\n+        # A: Solo transaction to be RBF'd (to bump descendant limit for package later)\n+        # B: First transaction in package, RBFs A by itself under individual evaluation, which would give it +1 descendant limit\n+        # C: Second transaction in package, spends C. If the +1 descendant limit persisted, would make it into mempool\n+\n+        self.restart_node(0, extra_args=self.extra_args[0] + [\"-limitancestorcount=2\", \"-limitdescendantcount=1\"])\n+\n+        # Generate a confirmed utxo we will double-spend\n+        rbf_utxo = self.wallet.send_self_transfer(\n+            from_node=node,\n+            confirmed_only=True\n+        )[\"new_utxo\"]\n+        self.generate(node, 1)\n+\n+        # tx_A needs to be RBF'd, set minfee at set size\n+        A_weight = 1000\n+        mempoolmin_feerate = node.getmempoolinfo()[\"mempoolminfee\"]\n+        tx_A = self.wallet.send_self_transfer(\n+            from_node=node,\n+            fee=(mempoolmin_feerate / 1000) * (A_weight // 4) + Decimal('0.000001'),\n+            target_weight=A_weight,\n+            utxo_to_spend=rbf_utxo,\n+            confirmed_only=True\n+        )\n+\n+        # RBF's tx_A, is not yet submitted\n+        tx_B = self.wallet.create_self_transfer(\n+            fee=tx_A[\"fee\"] * 4,\n+            target_weight=A_weight,\n+            utxo_to_spend=rbf_utxo,\n+            confirmed_only=True\n+        )\n+\n+        # Spends tx_B's output, too big for cpfp carveout (because that would also increase the descendant limit by 1)\n+        tx_C = self.wallet.create_self_transfer(\n+            target_weight=40001, # EXTRA_DESCENDANT_TX_SIZE_LIMIT + 1\n+            utxo_to_spend=tx_B[\"new_utxo\"],\n+            confirmed_only=True\n+        )\n+\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", node.submitpackage, [tx_B[\"hex\"], tx_C[\"hex\"]])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28472#discussion_r1326877476",
      "id" : 1326877476,
      "in_reply_to_id" : 1326877400,
      "line" : 129,
      "node_id" : "PRRC_kwDOABII585PFosk",
      "original_commit_id" : "cddf03e3fb6ade4f5efbc053ee8177c7236a9132",
      "original_line" : 129,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 52,
      "pull_request_review_id" : 1628317520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28472",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326877476/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-15T06:55:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1326877476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28472#discussion_r1327245352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327245352"
         }
      },
      "author_association" : "MEMBER",
      "body" : "hmm, not sure why miniwallet is making something that doesn't hit minfee, pushed specific fee arg to avoid this\r\n\r\nedit: I guess if miniwallet doesn't check minfee, trimming could cause it",
      "commit_id" : "1b7f54b0339f38a15e2039981a021c58b07beaad",
      "created_at" : "2023-09-15T12:51:24Z",
      "diff_hunk" : "@@ -78,6 +78,54 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_rbf_carveout_disallowed(self):\n+        node = self.nodes[0]\n+\n+        self.log.info(\"Check that individually-evaluated transactions in a package don't increase package limits for other subpackage parts\")\n+\n+        # We set chain limits to 2 ancestors, 1 descendant, then try to get a parents-and-child chain of 2 in mempool\n+        #\n+        # A: Solo transaction to be RBF'd (to bump descendant limit for package later)\n+        # B: First transaction in package, RBFs A by itself under individual evaluation, which would give it +1 descendant limit\n+        # C: Second transaction in package, spends C. If the +1 descendant limit persisted, would make it into mempool\n+\n+        self.restart_node(0, extra_args=self.extra_args[0] + [\"-limitancestorcount=2\", \"-limitdescendantcount=1\"])\n+\n+        # Generate a confirmed utxo we will double-spend\n+        rbf_utxo = self.wallet.send_self_transfer(\n+            from_node=node,\n+            confirmed_only=True\n+        )[\"new_utxo\"]\n+        self.generate(node, 1)\n+\n+        # tx_A needs to be RBF'd, set minfee at set size\n+        A_weight = 1000\n+        mempoolmin_feerate = node.getmempoolinfo()[\"mempoolminfee\"]\n+        tx_A = self.wallet.send_self_transfer(\n+            from_node=node,\n+            fee=(mempoolmin_feerate / 1000) * (A_weight // 4) + Decimal('0.000001'),\n+            target_weight=A_weight,\n+            utxo_to_spend=rbf_utxo,\n+            confirmed_only=True\n+        )\n+\n+        # RBF's tx_A, is not yet submitted\n+        tx_B = self.wallet.create_self_transfer(\n+            fee=tx_A[\"fee\"] * 4,\n+            target_weight=A_weight,\n+            utxo_to_spend=rbf_utxo,\n+            confirmed_only=True\n+        )\n+\n+        # Spends tx_B's output, too big for cpfp carveout (because that would also increase the descendant limit by 1)\n+        tx_C = self.wallet.create_self_transfer(\n+            target_weight=40001, # EXTRA_DESCENDANT_TX_SIZE_LIMIT + 1\n+            utxo_to_spend=tx_B[\"new_utxo\"],\n+            confirmed_only=True\n+        )\n+\n+        assert_raises_rpc_error(-26, \"too-long-mempool-chain\", node.submitpackage, [tx_B[\"hex\"], tx_C[\"hex\"]])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28472#discussion_r1327245352",
      "id" : 1327245352,
      "in_reply_to_id" : 1326877400,
      "line" : 129,
      "node_id" : "PRRC_kwDOABII585PHCgo",
      "original_commit_id" : "cddf03e3fb6ade4f5efbc053ee8177c7236a9132",
      "original_line" : 129,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 52,
      "pull_request_review_id" : 1628886738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28472",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327245352/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-15T12:56:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1327245352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28472#discussion_r1328988355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328988355"
         }
      },
      "author_association" : "MEMBER",
      "body" : "should sayâ spend Bâ.",
      "commit_id" : "1b7f54b0339f38a15e2039981a021c58b07beaad",
      "created_at" : "2023-09-18T16:31:05Z",
      "diff_hunk" : "@@ -78,6 +78,56 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_rbf_carveout_disallowed(self):\n+        node = self.nodes[0]\n+\n+        self.log.info(\"Check that individually-evaluated transactions in a package don't increase package limits for other subpackage parts\")\n+\n+        # We set chain limits to 2 ancestors, 1 descendant, then try to get a parents-and-child chain of 2 in mempool\n+        #\n+        # A: Solo transaction to be RBF'd (to bump descendant limit for package later)\n+        # B: First transaction in package, RBFs A by itself under individual evaluation, which would give it +1 descendant limit\n+        # C: Second transaction in package, spends C. If the +1 descendant limit persisted, would make it into mempool",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28472#discussion_r1328988355",
      "id" : 1328988355,
      "line" : 90,
      "node_id" : "PRRC_kwDOABII585PNsDD",
      "original_commit_id" : "1b7f54b0339f38a15e2039981a021c58b07beaad",
      "original_line" : 90,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/mempool_limit.py",
      "position" : 13,
      "pull_request_review_id" : 1631498658,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28472",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328988355/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-18T16:49:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1328988355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   }
]
