[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2023-09-04T08:04:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28400#issuecomment-1704801655",
      "id" : 1704801655,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28400",
      "node_id" : "IC_kwDOABII585lnTV3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1704801655/reactions"
      },
      "updated_at" : "2023-09-04T08:04:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1704801655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Changing the `IsUnspendable` logic in general seems very brittle, as it obviously leads to nodes with diverging UTXO sets. Even if _all_ nodes would run this patch, they'd start to run it at different block heights (if between blocks M and N an UTXO enters the set that classifies for pruning, you'd already diverge), and you'd only end up with the same fully pruned UTXO set if all of them also did a `-reindex` once.\r\n\r\nWhen the pruning of OP_RETURN outputs was implemented over 10 years ago (see https://github.com/bitcoin/bitcoin/pull/2791) this was seemingly less of a problem, but now that many projects depend on a normalized view of the UTXO set (muhash, assumeutxo, utreexo etc.), I think that would lead to much unwanted chaos.\r\n\r\nHappy to hear other inputs how this could be solved, maybe I'm missing something.",
      "created_at" : "2023-09-04T10:46:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28400#issuecomment-1705040932",
      "id" : 1705040932,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28400",
      "node_id" : "IC_kwDOABII585loNwk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1705040932/reactions"
      },
      "updated_at" : "2023-09-04T10:46:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1705040932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28400#discussion_r1314856043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314856043"
         }
      },
      "author_association" : "NONE",
      "body" : "did you find anything interesting when you added this check?",
      "commit_id" : "5892815cedef828a34e5efb1c9f32e3877eadd8c",
      "created_at" : "2023-09-04T11:59:53Z",
      "diff_hunk" : "@@ -258,6 +324,44 @@ bool CScript::IsPushOnly() const\n     return this->IsPushOnly(begin());\n }\n \n+\n+bool CScript::IsUnspendable() const\n+{\n+    if (size() > MAX_SCRIPT_SIZE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28400#discussion_r1314856043",
      "id" : 1314856043,
      "line" : 330,
      "node_id" : "PRRC_kwDOABII585OXxxr",
      "original_commit_id" : "5892815cedef828a34e5efb1c9f32e3877eadd8c",
      "original_line" : 330,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/script/script.cpp",
      "position" : 87,
      "pull_request_review_id" : 1609404682,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28400",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314856043/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-04T11:59:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314856043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/115941166?v=4",
         "events_url" : "https://api.github.com/users/rot13maxi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rot13maxi/followers",
         "following_url" : "https://api.github.com/users/rot13maxi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rot13maxi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rot13maxi",
         "id" : 115941166,
         "login" : "rot13maxi",
         "node_id" : "U_kgDOBukfLg",
         "organizations_url" : "https://api.github.com/users/rot13maxi/orgs",
         "received_events_url" : "https://api.github.com/users/rot13maxi/received_events",
         "repos_url" : "https://api.github.com/users/rot13maxi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rot13maxi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rot13maxi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rot13maxi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28400#discussion_r1314863864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314863864"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No as it was previously defined here.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/6f03c45f6bb5a6edaa3051968b6a1ca4f84d2ccb/src/script/script.h#L551-L554\r\n\r\nThe reason I placed it at the top of the if else stack was to avoid doing work on a script that already is invalid due to length. _If the script is too long just mark as unspendable and avoid any extra checking_",
      "commit_id" : "5892815cedef828a34e5efb1c9f32e3877eadd8c",
      "created_at" : "2023-09-04T12:08:10Z",
      "diff_hunk" : "@@ -258,6 +324,44 @@ bool CScript::IsPushOnly() const\n     return this->IsPushOnly(begin());\n }\n \n+\n+bool CScript::IsUnspendable() const\n+{\n+    if (size() > MAX_SCRIPT_SIZE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28400#discussion_r1314863864",
      "id" : 1314863864,
      "in_reply_to_id" : 1314856043,
      "line" : 330,
      "node_id" : "PRRC_kwDOABII585OXzr4",
      "original_commit_id" : "5892815cedef828a34e5efb1c9f32e3877eadd8c",
      "original_line" : 330,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/script/script.cpp",
      "position" : 87,
      "pull_request_review_id" : 1609417395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28400",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314863864/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-04T12:08:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314863864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3104223?v=4",
         "events_url" : "https://api.github.com/users/russeree/events{/privacy}",
         "followers_url" : "https://api.github.com/users/russeree/followers",
         "following_url" : "https://api.github.com/users/russeree/following{/other_user}",
         "gists_url" : "https://api.github.com/users/russeree/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/russeree",
         "id" : 3104223,
         "login" : "russeree",
         "node_id" : "MDQ6VXNlcjMxMDQyMjM=",
         "organizations_url" : "https://api.github.com/users/russeree/orgs",
         "received_events_url" : "https://api.github.com/users/russeree/received_events",
         "repos_url" : "https://api.github.com/users/russeree/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/russeree/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/russeree/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/russeree"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Changing the `IsUnspendable` logic in general seems very brittle, as it obviously leads to nodes with diverging UTXO sets. \r\n> \r\n> now that many projects depend on a normalized view of the UTXO set (muhash, assumeutxo, utreexo etc.), I think that would lead to much unwanted chaos.\r\n\r\nI think muhash provides a pretty straightforward way of dealing with this. Namely: rather than only maintaining a single muhash for the utxo set you have, also maintain one for the outputs you've pruned as unspendable (or multiple indexes if you introduce more over time). Then you might have:\r\n\r\n * at block height 810,000\r\n * the spendable utxo set has muhash X\r\n * the OP_RETURN utxos have muhash Y\r\n * the bad pubkey utxos have muhash Z\r\n\r\nif you compare with a node running current master, you then verify that your `X+Z` matches their `X`.\r\n\r\nIt's easy to initialize these values on upgrade: Z=0, then iterate through your utxo set looking for bad pubkeys, adding them to Z as you find them, and removing them from the utxo set. Downgrading breaks things though.\r\n\r\nI don't think you can bootstrap utreexo from just the utxo set at an arbitrary height in the first place, so I don't think its really affected by this. For assumeutxo, if you want to be able to distribute the utxo set snapshots over p2p, then peers that have pruned unspendable utxos won't have them to share with peers that don't realise they're unspendable in the first place, but if you're just producing signed snapshots, then you could probably just publish two versions until the old software goes out of its support window.",
      "created_at" : "2023-09-04T12:29:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28400#issuecomment-1705186294",
      "id" : 1705186294,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28400",
      "node_id" : "IC_kwDOABII585loxP2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1705186294/reactions"
      },
      "updated_at" : "2023-09-04T12:29:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1705186294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ajtowns: Neat idea with the additional MuHash! I agree this should work, but obviously at the cost of increased complexity (as there is much more to change than only the logic of a single method), and there should be a really good reason for doing it.\r\n\r\n> It's easy to initialize these values on upgrade: Z=0, then iterate through your utxo set looking for bad pubkeys, adding them to Z as you find them, and removing them from the utxo set. Downgrading breaks things though.\r\n\r\nRight, and you'd also need to somehow detect if an upgrade has already happened. In #2791 it was proposed to either scan for a particular output in the UTXO set (https://github.com/bitcoin/bitcoin/pull/2791#issuecomment-21256241) or to introduce a flag in the chainstate database (https://github.com/bitcoin/bitcoin/pull/2791#issuecomment-21292138).\r\n\r\n@russeree: Can you give some additional motivation? While I enjoy very much reasoning about these kind of topics, it's still unclear to me what concrete problem this PR is trying to solve. The description claims that about 20k of outputs could be pruned. As of now (block 806205), that's merely 0.016% of the total UTXO set size, freeing up about 1,24 MB of chainstate space (if we assume an average size of 65 bytes per UTXO). I'd argue that these numbers are way too low (even if you 10x them for the sake of projecting into the future) to justify the increased complexity in different areas that would need to be touched (i.e. differentiating between different `IsUnspendable` reasons and update all call-sites correctly, maintaining an extra MuHash, implementing an UTXO set upgrade mechanism, probably adapting `gettxoutsetinfo` RPC results to include both \"new-pruned-MuHash\" and \"old-unpruned-MuHash\", dealing with different `dumptxoutset`/`loadtxoutset` result/behaviour on old vs new nodes for AssumeUTXO etc. etc.).\r\n\r\nAlso, calling `IsFullyValid` is significantly more expensive than just doing the usual Solver matching and length checks, so one would also need to analyze if this has a noticable negative performance impact on standardness checks.\r\n",
      "created_at" : "2023-09-04T15:27:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28400#issuecomment-1705447458",
      "id" : 1705447458,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28400",
      "node_id" : "IC_kwDOABII585lpxAi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1705447458/reactions"
      },
      "updated_at" : "2023-09-04T15:27:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1705447458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   }
]
