[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28280).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [jamesob](https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1691875284), [hernanmarino](https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2052697672) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29700](https://github.com/bitcoin/bitcoin/pull/29700) (kernel, refactor: return error status on all fatal errors by ryanofsky)\n* [#28233](https://github.com/bitcoin/bitcoin/pull/28233) (validation: don't clear cache on periodic flush: >2x block connection speed by andrewtoth)\n* [#28216](https://github.com/bitcoin/bitcoin/pull/28216) (fuzz: a new target for the coins database by darosior)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-08-16T22:38:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1681358199",
      "id" : 1681358199,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585kN313",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1681358199/reactions"
      },
      "updated_at" : "2024-05-02T08:18:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1681358199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1296524385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296524385"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If these were iterators into the map, rather than pointers to the value, I think you wouldn't need the `m_outpoint`.",
      "commit_id" : "0d83e209311d7286465255e592c9cfd9c8f84e7f",
      "created_at" : "2023-08-16T23:14:03Z",
      "diff_hunk" : "@@ -103,8 +103,16 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    //! These are used to create a doubly linked list of dirty entries. They are\n+    //! set in SetFlags and unset in ClearFlags.\n+    CCoinsCacheEntry *m_prev{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1296524385",
      "id" : 1296524385,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NR2Rh",
      "original_commit_id" : "dbd663c4461cf0d8f478d46e224a966293db3bd3",
      "original_line" : 109,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 1581554153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296524385/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T23:14:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296524385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1297300532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297300532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually, it seems iterators may get invalidated when a map rehash occurs, but pointers to elements don't.\r\n\r\nI think you can however store pointers to `std::pair<const COutPoint, CoinsCacheEntry>` (the `value_type` of the map). Would that help alleviate the need for `m_outpoint`?",
      "commit_id" : "0d83e209311d7286465255e592c9cfd9c8f84e7f",
      "created_at" : "2023-08-17T14:23:57Z",
      "diff_hunk" : "@@ -103,8 +103,16 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    //! These are used to create a doubly linked list of dirty entries. They are\n+    //! set in SetFlags and unset in ClearFlags.\n+    CCoinsCacheEntry *m_prev{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1297300532",
      "id" : 1297300532,
      "in_reply_to_id" : 1296524385,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NUzw0",
      "original_commit_id" : "dbd663c4461cf0d8f478d46e224a966293db3bd3",
      "original_line" : 109,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 1582751611,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297300532/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T14:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297300532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1297307567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297307567"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Brilliant, thanks! Was just trying this last night, this looks like the way. Will give it a shot.",
      "commit_id" : "0d83e209311d7286465255e592c9cfd9c8f84e7f",
      "created_at" : "2023-08-17T14:28:58Z",
      "diff_hunk" : "@@ -103,8 +103,16 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    //! These are used to create a doubly linked list of dirty entries. They are\n+    //! set in SetFlags and unset in ClearFlags.\n+    CCoinsCacheEntry *m_prev{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1297307567",
      "id" : 1297307567,
      "in_reply_to_id" : 1296524385,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NU1ev",
      "original_commit_id" : "dbd663c4461cf0d8f478d46e224a966293db3bd3",
      "original_line" : 109,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 1582762652,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297307567/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T14:29:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297307567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1297701571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297701571"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@sipa done! Thank you for the elegant solution.",
      "commit_id" : "0d83e209311d7286465255e592c9cfd9c8f84e7f",
      "created_at" : "2023-08-17T20:21:49Z",
      "diff_hunk" : "@@ -103,8 +103,16 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    //! These are used to create a doubly linked list of dirty entries. They are\n+    //! set in SetFlags and unset in ClearFlags.\n+    CCoinsCacheEntry *m_prev{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1297701571",
      "id" : 1297701571,
      "in_reply_to_id" : 1296524385,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NWVrD",
      "original_commit_id" : "dbd663c4461cf0d8f478d46e224a966293db3bd3",
      "original_line" : 109,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 1583408156,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297701571/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T20:21:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297701571",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK! I'll try to repro the bench results in the next week or so.",
      "created_at" : "2023-08-24T15:14:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1691875284",
      "id" : 1691875284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585k1_fU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 2,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1691875284/reactions"
      },
      "updated_at" : "2023-08-24T15:14:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1691875284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@andrewtoth Not sure if you have seen https://github.com/bitcoin/bitcoin/pull/20827 which is a different approach but has a similar effect.",
      "created_at" : "2023-08-30T07:52:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1698672209",
      "id" : 1698672209,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585lP65R",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1698672209/reactions"
      },
      "updated_at" : "2023-08-30T07:52:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1698672209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@0xB10C indeed I have seen that one. I believe they complement each other. #20827 reduces IBD time for larger `prune` values and this PR reduces it even more for smaller `prune` values. I should benchmark this on top of that one.\r\nAlso, I'm curious how you are performing your benchmarks and generating all those nice graphs. Do you mind sharing what tools you use?",
      "created_at" : "2023-08-30T19:13:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1699702875",
      "id" : 1699702875,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585lT2hb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1699702875/reactions"
      },
      "updated_at" : "2023-08-31T02:24:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1699702875",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Also, I'm curious how you are performing your benchmarks and generating all those nice graphs. Do you mind sharing what tools you use?\r\n\r\nAt the time I had a spare and otherwise idle machine set up I could use. I don't have the bash script at hand but IIRC I had a merge base (MB)  and a pull-request (PR) binary I'd run with different `prune` and `dbcache` configurations. After each run, the script would rename and move the debug log (with extra `-debug=coindb -debug=prune`) to a separate folder. After all runs were done, I loaded the debug logs into the following Jupyter notebooks to parse the debug logs and to generate the graphs. For anyone revisiting this, these are the relevant comments https://github.com/bitcoin/bitcoin/pull/20827#issuecomment-1009016428, https://github.com/bitcoin/bitcoin/pull/20827#issuecomment-1017603590, and https://github.com/bitcoin/bitcoin/pull/20827#issuecomment-1023108273 for my setup and results.\r\n\r\nI've uploaded the jupyter nodebooks here https://gist.github.com/0xB10C/89c2903290cfb1840792d41dcd079646. The first was used for a partial IBD from 500k-600k and the second one with a full IBD. Both times syncing from a local node on the same host. The notebooks expect the debug log files with the name `debug_{binary}_{cset}_{run}.log` where {binary} is either MB or PR, {cset} is an integer specifying the configuration set (pruning and dbcache parameter), and {run} is an integer numbering the run of this binary-cset combination if I did multiple. Feel free to remix and share in any way you want. Keep in mind that parsing logs is quite fragile as log message format can change. Feel free to reach out if there are questions. \r\n\r\n\r\n\r\n\r\n",
      "created_at" : "2023-08-31T06:35:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1700446063",
      "id" : 1700446063,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585lWr9v",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1700446063/reactions"
      },
      "updated_at" : "2023-08-31T06:35:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1700446063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Bench running now, should have some results in the next day or so.\r\n```shell\r\n$ ( bitcoinperf --no-teardown bench-pr --num-blocks 30_000 --run-id no-flush-on-prune \\\r\n    --bitcoind-args='-dbcache=4000 -prune=550' --run-count 3 28280 && \\\r\n    pushover 'Bench for andrewtoth SUCCEEDED!' ) || \\\r\n  pushover 'Bench for andrewtoth failed'\r\n```",
      "created_at" : "2023-09-20T17:47:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1728185226",
      "id" : 1728185226,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585nAgOK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1728185226/reactions"
      },
      "updated_at" : "2023-09-20T17:47:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1728185226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Local IBD of 30_000 blocks with `-prune=550` from a Taproot-enabled height didn't show any difference. I didn't have `-log=prune` enabled, so my bench debug.log was basically useless. Rerunning...",
      "created_at" : "2023-09-27T10:25:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1737126367",
      "id" : 1737126367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585ninHf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1737126367/reactions"
      },
      "updated_at" : "2023-09-27T10:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1737126367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-11-08T15:29:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1802125401",
      "id" : 1802125401,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585rakBZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1802125401/reactions"
      },
      "updated_at" : "2023-11-08T15:29:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1802125401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased, ran the following benchmark using hyperfine. Sync to block 800k 3 times on master commit and the last commit of this branch (I updated the commit recently, but no code changes only commit order changes to satisfy CI), dbcache=4000 and prune=550:\r\n\r\n```\r\nhyperfine \\\r\n--export-markdown ~/bench.md \\\r\n--show-output --parameter-list commit 498994b6f55d04a7940f832e7fbd17e5acdaff15,216bd93138a46cdfa66523878a36d0e634476079 \\\r\n--prepare 'git checkout {commit} && make -j$(nproc) src/bitcoind; sync; sudo /sbin/sysctl vm.drop_caches=3; rm -rf ~/.bitcoin/blocks; rm -rf ~/.bitcoin/chainstate;' \\\r\n-M 3 './src/bitcoind -dbcache=4000 -prune=550 -printtoconsole=0 -connect=<local_node> -stopatheight=800000'\r\n```\r\n\r\nResults from `~/bench.md`:\r\n| Command | Mean [s] | Min [s] | Max [s] | Relative |\r\n|:---|---:|---:|---:|---:|\r\n| `./src/bitcoind -dbcache=4000 -datadir=/home/user/.bitcoin -prune=550 -printtoconsole=0 -connect=192.168.2.11:8333 -stopatheight=800000` | 27609.574 Â± 37.857 | 27580.531 | 27652.389 | 1.24 Â± 0.00 |\r\n| `./src/bitcoind -dbcache=4000 -datadir=/home/user/.bitcoin -prune=550 -printtoconsole=0 -connect=192.168.2.11:8333 -stopatheight=800000` | 22188.405 Â± 52.561 | 22128.517 | 22226.878 | 1.00 |\r\n\r\nThe second commit is this branch, so it runs 24% faster than master.\r\n\r\n@jamesob I suppose 30k blocks is not enough to appreciate the effect of syncing with a full cache?",
      "created_at" : "2023-12-03T18:30:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1837561632",
      "id" : 1837561632,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585thvcg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1837561632/reactions"
      },
      "updated_at" : "2023-12-03T18:34:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1837561632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414243104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414243104"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "While you are at it, I'd use `CCoinsCacheEntry = default;`. clang-tidy usually warns against this: https://clang.llvm.org/extra/clang-tidy/checks/modernize/use-equals-default.html",
      "commit_id" : "0d83e209311d7286465255e592c9cfd9c8f84e7f",
      "created_at" : "2023-12-04T17:26:57Z",
      "diff_hunk" : "@@ -138,9 +137,9 @@ struct CCoinsCacheEntry\n         FRESH = (1 << 1),\n     };\n \n-    CCoinsCacheEntry() : flags(0) {}\n-    explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n-    CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    CCoinsCacheEntry() {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414243104",
      "id" : 1414243104,
      "line" : 140,
      "node_id" : "PRRC_kwDOABII585US6Mg",
      "original_commit_id" : "ba09f5039c4bd2868335d5616f86acbfa41bedd9",
      "original_line" : 140,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 34,
      "pull_request_review_id" : 1763003369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414243104/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T20:16:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414243104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414384720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414384720"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think `SetFlags` is a bit confusing name, since it's more a `AddFlags`, because it doesn't simply set the flags, it ORs them together.\r\n\r\nAlternatively (and I think this is the better solution) really use `m_flags = flags` instead of `mflags |= flags`.",
      "commit_id" : "0d83e209311d7286465255e592c9cfd9c8f84e7f",
      "created_at" : "2023-12-04T19:25:35Z",
      "diff_hunk" : "@@ -9,6 +9,42 @@\n #include <random.h>\n #include <util/trace.h>\n \n+void CCoinsCacheEntry::SetFlags(uint8_t flags, CoinsCachePair &self, CoinsCachePair &head)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414384720",
      "id" : 1414384720,
      "line" : 12,
      "node_id" : "PRRC_kwDOABII585UTcxQ",
      "original_commit_id" : "d66ad8efafe95445fcfcec6c07a6117faa32fa36",
      "original_line" : 12,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 4,
      "pull_request_review_id" : 1763003369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414384720/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T20:16:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414384720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414394258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414394258"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure if that is possible in the call, but when `emplace` doesn't create a new object because the outpoint is already present, then previously the flags didn't change. Now, the flag DIRTY is always added, regardless if the outpoint was already present in `cacheCoins` or not.",
      "commit_id" : "0d83e209311d7286465255e592c9cfd9c8f84e7f",
      "created_at" : "2023-12-04T19:32:52Z",
      "diff_hunk" : "@@ -144,10 +144,11 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n \n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n-    cacheCoins.emplace(\n+    auto it{cacheCoins.emplace(\n         std::piecewise_construct,\n         std::forward_as_tuple(std::move(outpoint)),\n-        std::forward_as_tuple(std::move(coin), CCoinsCacheEntry::DIRTY));\n+        std::forward_as_tuple(std::move(coin))).first};\n+    it->second.SetFlags(CCoinsCacheEntry::DIRTY, *it, m_flagged_head);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414394258",
      "id" : 1414394258,
      "line" : 151,
      "node_id" : "PRRC_kwDOABII585UTfGS",
      "original_commit_id" : "ba09f5039c4bd2868335d5616f86acbfa41bedd9",
      "original_line" : 151,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 89,
      "pull_request_review_id" : 1763003369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414394258/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T20:16:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414394258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414402060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414402060"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'd use `itUs = cacheCoins.try_emplace(it->first).first;` instead, it's just less code and does the same thing",
      "commit_id" : "0d83e209311d7286465255e592c9cfd9c8f84e7f",
      "created_at" : "2023-12-04T19:40:15Z",
      "diff_hunk" : "@@ -214,22 +216,23 @@ void CCoinsViewCache::SetBestBlock(const uint256 &hashBlockIn) {\n     hashBlock = hashBlockIn;\n }\n \n-bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn, bool erase) {\n-    for (CCoinsMap::iterator it = mapCoins.begin();\n-            it != mapCoins.end();\n-            it = erase ? mapCoins.erase(it) : std::next(it)) {\n+bool CCoinsViewCache::BatchWrite(CoinsCachePair *pairs, const uint256 &hashBlockIn, bool erase) {\n+    for (auto it{pairs};\n+            it != nullptr;\n+            it = it->second.Next(erase)) {\n         // Ignore non-dirty entries (optimization).\n-        if (!(it->second.flags & CCoinsCacheEntry::DIRTY)) {\n+        if (!(it->second.GetFlags() & CCoinsCacheEntry::DIRTY)) {\n             continue;\n         }\n         CCoinsMap::iterator itUs = cacheCoins.find(it->first);\n         if (itUs == cacheCoins.end()) {\n             // The parent cache does not have an entry, while the child cache does.\n             // We can ignore it if it's both spent and FRESH in the child\n-            if (!(it->second.flags & CCoinsCacheEntry::FRESH && it->second.coin.IsSpent())) {\n+            if (!(it->second.GetFlags() & CCoinsCacheEntry::FRESH && it->second.coin.IsSpent())) {\n                 // Create the coin in the parent cache, move the data up\n                 // and mark it as dirty.\n-                CCoinsCacheEntry& entry = cacheCoins[it->first];\n+                itUs = cacheCoins.emplace(std::piecewise_construct, std::forward_as_tuple(it->first), std::tuple<>()).first;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414402060",
      "id" : 1414402060,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII585UThAM",
      "original_commit_id" : "ba09f5039c4bd2868335d5616f86acbfa41bedd9",
      "original_line" : 234,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 133,
      "pull_request_review_id" : 1763003369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414402060/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T20:16:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414402060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414435232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414435232"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, you could move that line in front of the `if`, then remove the else, like so:\r\n\r\n```cpp\r\nconst auto next_entry{it->second.Next(/*clear_flags=*/true)};\r\nif (it->second.coin.IsSpent()) {\r\n    cachedCoinsUsage -= it->second.coin.DynamicMemoryUsage();\r\n    cacheCoins.erase(it->first);\r\n}\r\nit = next_entry;\r\n```",
      "commit_id" : "0d83e209311d7286465255e592c9cfd9c8f84e7f",
      "created_at" : "2023-12-04T20:12:08Z",
      "diff_hunk" : "@@ -301,16 +306,20 @@ bool CCoinsViewCache::Flush() {\n \n bool CCoinsViewCache::Sync()\n {\n-    bool fOk = base->BatchWrite(cacheCoins, hashBlock, /*erase=*/false);\n+    const auto fOk{base->BatchWrite(m_flagged_head.second.Next(), hashBlock, /*erase=*/false)};\n     // Instead of clearing `cacheCoins` as we would in Flush(), just clear the\n     // FRESH/DIRTY flags of any coin that isn't spent.\n-    for (auto it = cacheCoins.begin(); it != cacheCoins.end(); ) {\n+    for (auto it{m_flagged_head.second.Next()}; it != nullptr; ) {\n         if (it->second.coin.IsSpent()) {\n+            // We need to get next entry before we erase this entry.\n+            // Since cacheCoins owns the entry, it will be deallocated before we\n+            // can access the next entry if we erase first.\n+            const auto next_entry{it->second.Next(/*clear_flags=*/true)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414435232",
      "id" : 1414435232,
      "line" : 317,
      "node_id" : "PRRC_kwDOABII585UTpGg",
      "original_commit_id" : "ba09f5039c4bd2868335d5616f86acbfa41bedd9",
      "original_line" : 317,
      "original_position" : 175,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 214,
      "pull_request_review_id" : 1763003369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414435232/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T20:16:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414435232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414758537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414758537"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Only 2 of the 6 previous `flags` assignments (aside from `= 0`) used simple assignment, the other 4 use OR assignment. The 2 that use simple assignment we know logically that they must have been just created and therefore their flags are 0 so we are not overwriting any existing flags. Therefore an OR assignment in those 2 cases is logically equivalent.\r\n\r\nSo if we were to go with your second suggestion we would need to modify behavior to make sure we assign the new flags we wish to set OR'd with the current flags so we don't overwrite existing flags. Or create separate Set and Add methods. I think that would make this patch more cumbersome.\r\n\r\nIt seems to me your first suggestion would be the path of least resistance. Updated to `AddFlags`.",
      "commit_id" : "c40714d94fa7fb68d1e61e5f192084289276cb74",
      "created_at" : "2023-12-05T02:15:17Z",
      "diff_hunk" : "@@ -9,6 +9,42 @@\n #include <random.h>\n #include <util/trace.h>\n \n+void CCoinsCacheEntry::SetFlags(uint8_t flags, CoinsCachePair &self, CoinsCachePair &head)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1414758537",
      "id" : 1414758537,
      "in_reply_to_id" : 1414384720,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UU4CJ",
      "original_commit_id" : "d66ad8efafe95445fcfcec6c07a6117faa32fa36",
      "original_line" : 12,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : null,
      "pull_request_review_id" : 1763789494,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414758537/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-05T03:32:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414758537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@martinus thank you very much for your review! I updated the PR with all your suggestions.",
      "created_at" : "2023-12-05T03:03:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1839920097",
      "id" : 1839920097,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585tqvPh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1839920097/reactions"
      },
      "updated_at" : "2023-12-05T03:03:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1839920097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I didn't think this through yet, but this might be an alternative way to achieve the same thing: Instead of the double linked list, split the `cacheCoins` map up into 4 different maps, one map for each flag setting, e.g. as a `std::array<CCoinMap, 4> m_cache_coins_per_flag;`. Index is the flag, e.g. `m_cache_coins_per_flag[FRESH | DIRTY]` to get the map with all entries that are fresh & dirty. Instead of setting a flag & linking the list, use the unordered_map's `auto node = extract(...)` and `insert(std::move(node))` to move the entry to the corresponding map. This only relinks the unordered_map node and causes no allocation, pointers to the entry stay valid. \r\n\r\nThis approach would have a few advantages:\r\n* Less memory usage: no `m_flag` member is needed that actually required 8 bytes due to alignment, no 2 pointers needed for interlinking, and multiple maps means overall bucket sizes will stay smaller.\r\n* processing the maps might be faster: iteration is fast because e.g. skipping non-dirty entries is trivial (they are in a different map). There might be a hashing overhead though from `extract()` and `insert()`.\r\n\r\nFor this to work, all 4 maps need to use the same `m_cache_coins_memory_resource` (`insert()` into a different map where the allocator doesn't compare equal is undefined behavior).",
      "created_at" : "2023-12-05T05:55:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1840061587",
      "id" : 1840061587,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585trRyT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1840061587/reactions"
      },
      "updated_at" : "2023-12-05T05:59:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1840061587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1415458663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415458663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "One thing I don't like about `modernize-use-equals-default` is that it makes aggregate initialization possible again, when a developer disabled it by declaring a constructor.\r\n\r\nThough, now that C++20 will be required soon, I guess it can be enabled. C.f.\r\n\r\n```cpp\r\nstruct A {\r\n    // A() {}; // \"main\" fn fails to compile under C++17 and 20\r\n    A() = default;  // \"main\" fn fails to compile under C++20\r\n    int b{};\r\n};\r\n\r\nint main() { (void)A{1}; }\r\n",
      "commit_id" : "c40714d94fa7fb68d1e61e5f192084289276cb74",
      "created_at" : "2023-12-05T11:46:54Z",
      "diff_hunk" : "@@ -138,9 +137,9 @@ struct CCoinsCacheEntry\n         FRESH = (1 << 1),\n     };\n \n-    CCoinsCacheEntry() : flags(0) {}\n-    explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n-    CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    CCoinsCacheEntry() {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1415458663",
      "id" : 1415458663,
      "in_reply_to_id" : 1414243104,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UXi9n",
      "original_commit_id" : "ba09f5039c4bd2868335d5616f86acbfa41bedd9",
      "original_line" : 140,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 1764866102,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415458663/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-05T11:46:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415458663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1415481883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415481883"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, I wasn't aware of that, good to know :+1: ",
      "commit_id" : "c40714d94fa7fb68d1e61e5f192084289276cb74",
      "created_at" : "2023-12-05T12:00:07Z",
      "diff_hunk" : "@@ -138,9 +137,9 @@ struct CCoinsCacheEntry\n         FRESH = (1 << 1),\n     };\n \n-    CCoinsCacheEntry() : flags(0) {}\n-    explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n-    CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    CCoinsCacheEntry() {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1415481883",
      "id" : 1415481883,
      "in_reply_to_id" : 1414243104,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585UXoob",
      "original_commit_id" : "ba09f5039c4bd2868335d5616f86acbfa41bedd9",
      "original_line" : 140,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : null,
      "pull_request_review_id" : 1764898773,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415481883/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-05T12:00:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1415481883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@martinus something similar was mentioned in https://github.com/bitcoin/bitcoin/pull/15265#issuecomment-457720636. However, with your approach every access would require 4 lookups.",
      "created_at" : "2023-12-05T13:19:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1840779612",
      "id" : 1840779612,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585tuBFc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1840779612/reactions"
      },
      "updated_at" : "2023-12-05T13:19:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1840779612",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @martinus something similar was mentioned in [#15265 (comment)](https://github.com/bitcoin/bitcoin/pull/15265#issuecomment-457720636). However, with your approach every access would require 4 lookups.\r\n\r\nHa, of course; I didn't think about that at all. ",
      "created_at" : "2023-12-05T19:43:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1841506238",
      "id" : 1841506238,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585twye-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1841506238/reactions"
      },
      "updated_at" : "2023-12-05T19:43:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1841506238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/22665800478</sub>",
      "created_at" : "2024-03-14T18:08:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-1998045192",
      "id" : 1998045192,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII5853F8AI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1998045192/reactions"
      },
      "updated_at" : "2024-03-14T18:08:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1998045192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1527532617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527532617"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"coins: add cache entry linked list fields and methods\"\r\n\r\nNit: `//!` is for doxygen comments on the *next* definition. Since this is really a comment on the next two, it probably shouldn't be a doxygen comment.",
      "commit_id" : "25bdbc7f340884b3ab871c7948a4f2693037b871",
      "created_at" : "2024-03-17T15:12:09Z",
      "diff_hunk" : "@@ -103,6 +106,14 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    //! These are used to create a doubly linked list of flagged entries. They",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1527532617",
      "id" : 1527532617,
      "line" : 110,
      "node_id" : "PRRC_kwDOABII585bDExJ",
      "original_commit_id" : "56faed97cd462345578b482c2d2089081ca393b6",
      "original_line" : 110,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 15,
      "pull_request_review_id" : 1941500013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527532617/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-17T15:22:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527532617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1527533452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527533452"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"coins: track dirty cache entries in doubly linked list\"\r\n\r\nUse a C++17 structured binding:\r\n\r\n```c++\r\nauto [it, inserted] = cacheCoins.emplace(\r\n```",
      "commit_id" : "25bdbc7f340884b3ab871c7948a4f2693037b871",
      "created_at" : "2024-03-17T15:16:08Z",
      "diff_hunk" : "@@ -108,10 +108,15 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n \n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n-    cacheCoins.emplace(\n+    CCoinsMap::iterator it;\n+    bool inserted;\n+    std::tie(it, inserted) = cacheCoins.emplace(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1527533452",
      "id" : 1527533452,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII585bDE-M",
      "original_commit_id" : "75a248f770fed4d8bf664bb9d5ed1f80e51c9bc8",
      "original_line" : 113,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 47,
      "pull_request_review_id" : 1941500013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527533452/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-17T15:22:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527533452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1527534087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527534087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"coins: track dirty cache entries in doubly linked list\"\r\n\r\nShould `FRESH`-but-not-`DIRTY` be flagged? I believe those correspond to spent but unmodified coins fetched from the parent cache.\r\n\r\nIf the rule is flagged == dirty, then perhaps it makes sense to instead of having `AddFlags` and `Clearflags` have a single `SetFlags`, which knows whether the new state is supposed to be in the list or not (moving the responsibility of flagged-or-not to that function instead of the caller). EDIT: I notice you used to have a `SetFlags`, actually, but my comments is more about where the responsibility lies for deciding whether an entry ought to be flagged or not than the actual function names.",
      "commit_id" : "25bdbc7f340884b3ab871c7948a4f2693037b871",
      "created_at" : "2024-03-17T15:19:45Z",
      "diff_hunk" : "@@ -51,7 +51,7 @@ CCoinsMap::iterator CCoinsViewCache::FetchCoin(const COutPoint &outpoint) const\n     if (ret->second.coin.IsSpent()) {\n         // The parent only has an empty entry for this outpoint; we can consider our\n         // version as fresh.\n-        ret->second.flags = CCoinsCacheEntry::FRESH;\n+        ret->second.AddFlags(CCoinsCacheEntry::FRESH, *ret, m_flagged_head);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1527534087",
      "id" : 1527534087,
      "line" : 54,
      "node_id" : "PRRC_kwDOABII585bDFIH",
      "original_commit_id" : "75a248f770fed4d8bf664bb9d5ed1f80e51c9bc8",
      "original_line" : 54,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 23,
      "pull_request_review_id" : 1941500013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527534087/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-17T15:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527534087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1532602577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1532602577"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Should `FRESH`-but-not-`DIRTY` be flagged? I believe those correspond to spent but unmodified coins fetched from the parent cache.\r\n\r\nYes, but only because in this case they are also spent. We erase all spent coins from the cache after doing a non-erasing batch write. There would be no way to track spent-but-not-`DIRTY` otherwise except by scanning the entire cache.\r\n\r\nSince the only case where we have `FRESH`-but-not-`DIRTY` is where the coin is spent, it makes sense to me to just add this to the linked list as well. Before proposing this PR I did call the linked list head `m_dirty_head`, but after not finding an efficient way to remove non-dirty spent entries, I decided to call it `m_flagged_head`.\r\n\r\nIf this makes sense to you I can add a comment here explaining this.",
      "commit_id" : "25bdbc7f340884b3ab871c7948a4f2693037b871",
      "created_at" : "2024-03-20T18:32:51Z",
      "diff_hunk" : "@@ -51,7 +51,7 @@ CCoinsMap::iterator CCoinsViewCache::FetchCoin(const COutPoint &outpoint) const\n     if (ret->second.coin.IsSpent()) {\n         // The parent only has an empty entry for this outpoint; we can consider our\n         // version as fresh.\n-        ret->second.flags = CCoinsCacheEntry::FRESH;\n+        ret->second.AddFlags(CCoinsCacheEntry::FRESH, *ret, m_flagged_head);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1532602577",
      "id" : 1532602577,
      "in_reply_to_id" : 1527534087,
      "line" : 54,
      "node_id" : "PRRC_kwDOABII585bWajR",
      "original_commit_id" : "75a248f770fed4d8bf664bb9d5ed1f80e51c9bc8",
      "original_line" : 54,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 23,
      "pull_request_review_id" : 1949746270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1532602577/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-20T18:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1532602577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1532606237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1532606237"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@andrewtoth Ah, I see, that makes sense. It would be good to add comments to explain that flagged means \"FRESH, DIRTY, or both\" and why.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-03-20T18:35:18Z",
      "diff_hunk" : "@@ -51,7 +51,7 @@ CCoinsMap::iterator CCoinsViewCache::FetchCoin(const COutPoint &outpoint) const\n     if (ret->second.coin.IsSpent()) {\n         // The parent only has an empty entry for this outpoint; we can consider our\n         // version as fresh.\n-        ret->second.flags = CCoinsCacheEntry::FRESH;\n+        ret->second.AddFlags(CCoinsCacheEntry::FRESH, *ret, m_flagged_head);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1532606237",
      "id" : 1532606237,
      "in_reply_to_id" : 1527534087,
      "line" : 54,
      "node_id" : "PRRC_kwDOABII585bWbcd",
      "original_commit_id" : "75a248f770fed4d8bf664bb9d5ed1f80e51c9bc8",
      "original_line" : 54,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 23,
      "pull_request_review_id" : 1949752247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1532606237/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-03-20T19:16:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1532606237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@0xB10C rebased after https://github.com/bitcoin/bitcoin/pull/20827 was merged, and ran the following benchmark:\r\n```\r\nhyperfine --export-markdown ~/bench.md --show-output --parameter-list commit 015ac13dcc964a31ef06dfdb565f88f901607f0e,25bdbc7f340884b3ab871c7948a4f2693037b871 --prepare 'git checkout {commit} && make -j$(nproc) src/bitcoind; sync; sudo /sbin/sysctl vm.drop_caches=3; rm -rf ~/.bitcoin/blocks; rm -rf ~/.bitcoin/chainstate;' -M 3 './src/bitcoind -dbcache=4000 -prune=550 -printtoconsole=0 -connect=<local network node ip> -stopatheight=800000'\r\n\r\n...\r\n\r\nBenchmark 1: ./src/bitcoind -dbcache=4000 -prune=550 -printtoconsole=0 -connect=<local network node ip> -stopatheight=800000 (commit = 015ac13dcc964a31ef06dfdb565f88f901607f0e)\r\n\r\n  Time (mean Â± Ï):     27241.365 s Â± 33.693 s    [User: 34791.898 s, System: 7357.098 s]\r\n  Range (min â¦ max):   27202.978 s â¦ 27266.037 s    3 runs\r\n\r\nBenchmark 2: ./src/bitcoind -dbcache=4000 -prune=550 -printtoconsole=0 -connect=<local network node ip> -stopatheight=800000 (commit = 25bdbc7f340884b3ab871c7948a4f2693037b871)\r\n\r\n  Time (mean Â± Ï):     22153.568 s Â± 37.663 s    [User: 27818.681 s, System: 4309.878 s]\r\n  Range (min â¦ max):   22119.682 s â¦ 22194.118 s    3 runs\r\n \r\nSummary\r\n  ./src/bitcoind -dbcache=4000 -prune=550 -printtoconsole=0 -connect=192.168.2.13 -stopatheight=800000 (commit = 25bdbc7f340884b3ab871c7948a4f2693037b871) ran\r\n    1.23 Â± 0.00 times faster than ./src/bitcoind -dbcache=4000 -prune=550 -printtoconsole=0 -connect=192.168.2.13 -stopatheight=800000 (commit = 015ac13dcc964a31ef06dfdb565f88f901607f0e)\r\n```\r\nSo this is 23% faster than master when using `dbcache=4000`, `prune=550`. (I just rebased again but 015ac13dcc964a31ef06dfdb565f88f901607f0e is master and 25bdbc7f340884b3ab871c7948a4f2693037b871 is my branch).\r\n\r\n@sipa thank you for your review! Addressed your nits and added more comments about flagged entries.\r\n",
      "created_at" : "2024-03-21T14:11:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2012404862",
      "id" : 2012404862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII58538tx-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2012404862/reactions"
      },
      "updated_at" : "2024-03-21T14:15:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2012404862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-03-22T20:09:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2015828895",
      "id" : 2015828895,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII5854Jxuf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2015828895/reactions"
      },
      "updated_at" : "2024-03-22T20:09:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2015828895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and ran some faster benchmarks, 2 each but only until 400k. Will do some more going to 800k.\r\n\r\n|  | prune | dbcache | mean time (s) | speedup |\r\n|-----------:|----------:|------------:|--------:|--------------:|\r\n| master | 550 | 16384 | 2,018 | - |\r\n| branch | 550 | 16384 | 1,667 | 17.4% |\r\n| master | 550 | 450 | 2,069 | - |\r\n| branch | 550 | 450 | 1,822 | 11.9% |\r\n| master | 0 | 16384 | 1,447 | - |\r\n| branch | 0 | 16384 | 1,396 | 3.5% |\r\n| master | 0 | 450 | 1,546 | - |\r\n| branch | 0 | 450 | 1,527 |1.2%|\r\n\r\nCommand was\r\n```\r\nhyperfine \\\r\n--export-markdown ~/bench.md \\\r\n--show-output \\\r\n--parameter-list commit 0d509bab45d292caeaf34600e57b5928757c6005,499f1f029a265fbeb4824e5cb84726f82ca2824b \\\r\n--parameter-list dbcache 450,16384 \\\r\n--parameter-list prune 550,0 \\\r\n--prepare 'git checkout {commit} && \\\r\nmake -j$(nproc) src/bitcoind; \\\r\nsync; sudo /sbin/sysctl vm.drop_caches=3; \\\r\nrm -rf /home/user/.bitcoin/blocks; \\\r\nrm -rf /home/user/.bitcoin/chainstate;' \\\r\n-M 2 \\\r\n'echo '{commit}' && \\\r\n./src/bitcoind -datadir=/home/user/.bitcoin \\\r\n-dbcache={dbcache} \\\r\n-prune={prune} \\\r\n-printtoconsole=0 \\\r\n-connect=<local node> \\\r\n-stopatheight=400000'\r\n```",
      "created_at" : "2024-04-04T21:26:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2038255584",
      "id" : 2038255584,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII5855fU_g",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2038255584/reactions"
      },
      "updated_at" : "2024-04-04T21:31:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2038255584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ran benchmarks to 800k blocks, 2 times each. As expected, results are very good when running pruned. When running non-pruned with default `dbcache`, however, `master` was 1% faster. I think this slowdown is negligible though and the improvements to syncing with pruning enabled make this worth the changes here. Also, potential improvements like https://github.com/bitcoin/bitcoin/pull/28945 will make up for it.\r\n\r\n|  | prune | dbcache | mean time | speedup |\r\n|-----------:|----------:|------------:|--------:|--------------:|\r\n| master | 550 | 16384 | 7h 29m | - |\r\n| branch | 550 | 16384 | 4h 56m | 34% |\r\n| branch | 550 | 450 | 6h 33m | 12% |\r\n| master | 0 | 16384 | 3h 34m | - |\r\n| branch | 0 | 16384 | 3h 29m | 2% |\r\n| master | 0 | 450 | 5h 34m | 1% |\r\n| branch | 0 | 450 | 5h 40m | - |",
      "created_at" : "2024-04-09T04:03:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2044108942",
      "id" : 2044108942,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII58551qCO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2044108942/reactions"
      },
      "updated_at" : "2024-04-09T04:03:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2044108942",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK . I 'd really like to see this merged",
      "created_at" : "2024-04-12T23:37:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2052697672",
      "id" : 2052697672,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII5856Wa5I",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2052697672/reactions"
      },
      "updated_at" : "2024-04-12T23:37:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2052697672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/87907936?v=4",
         "events_url" : "https://api.github.com/users/hernanmarino/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hernanmarino/followers",
         "following_url" : "https://api.github.com/users/hernanmarino/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hernanmarino/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hernanmarino",
         "id" : 87907936,
         "login" : "hernanmarino",
         "node_id" : "MDQ6VXNlcjg3OTA3OTM2",
         "organizations_url" : "https://api.github.com/users/hernanmarino/orgs",
         "received_events_url" : "https://api.github.com/users/hernanmarino/received_events",
         "repos_url" : "https://api.github.com/users/hernanmarino/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hernanmarino/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hernanmarino/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hernanmarino"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> For frequent pruning flushes there's no need to empty the cache and kill connect block speed. However, simply using `Sync` in place of `Flush` actually slows down a pruned full IBD with a high `dbcache` value. This is because as the cache grows, sync takes longer since every coin in the cache is scanned to check if it's dirty. For frequent prune flushes and a large cache this constant scanning starts to really slow IBD down, and just emptying the cache on every prune becomes faster.\r\n> \r\n> To fix this, we can add two pointers to each cache entry and construct a doubly linked list of dirty entries. We can then only iterate through all dirty entries on each `Sync`, and simply clear the pointers after.\r\n\r\nPerhaps I'm missing something, but it seems to me that the obvious solution to this problem is to have `BatchWrite` always delete dirty entries and clear the flags on all entries, rather than implementing a whole new data structure? `BatchWrite` already iterates the entire cache anyways, so it would make sense to me that we can consolidate all of the operations that occur for each cache entry.",
      "created_at" : "2024-05-13T20:21:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2108732705",
      "id" : 2108732705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII5859sLUh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2108732705/reactions"
      },
      "updated_at" : "2024-05-13T20:21:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2108732705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@achow101 That works, but it misses the point. If you delete the dirty entries on a prune flush, then those entries need to be re-read from disk when they are (likely soon) spent.",
      "created_at" : "2024-05-13T20:35:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2108754056",
      "id" : 2108754056,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII5859sQiI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2108754056/reactions"
      },
      "updated_at" : "2024-05-13T20:35:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2108754056",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> @achow101 That works, but it misses the point. If you delete the dirty entries on a prune flush, then those entries need to be re-read from disk when they are (likely soon) spent.\r\n\r\nSorry, I meant clear the Dirty and spent ones. Basically just move the stuff that `Sync()` does into the loop that `BatchWrite` is doing.",
      "created_at" : "2024-05-13T20:36:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2108756050",
      "id" : 2108756050,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII5859sRBS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2108756050/reactions"
      },
      "updated_at" : "2024-05-13T20:37:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2108756050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-05-13T22:01:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2108877264",
      "id" : 2108877264,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII5859sunQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2108877264/reactions"
      },
      "updated_at" : "2024-05-13T22:01:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2108877264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@achow101 I see what you mean, clear the flags and delete spent entries in the loop in `BatchWrite`. That would reduce each `Sync` from 2 full scans of the `coinsCache` to 1. It still scans the entire `coinsCache`, while the current change here only loops through flagged entries. Will experiment with how that performs, and possibly combining both ideas to do a single loop of only the flagged entries. ",
      "created_at" : "2024-05-14T02:32:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2109161840",
      "id" : 2109161840,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII5859t0Fw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2109161840/reactions"
      },
      "updated_at" : "2024-05-14T02:32:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2109161840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Am I right that after this change (or alternatives which let BatchWrite just iterate dirty/fresh entries), it would be possible to (perhaps dramatically) reduce the periodic flush time, so that after IBD, we basically always have a mostly non-dirty cache? Such a change could be made today of course, but the cost of iterating the entire cache every time would add up quickly.",
      "created_at" : "2024-05-20T19:44:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2121088705",
      "id" : 2121088705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585-bT7B",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2121088705/reactions"
      },
      "updated_at" : "2024-05-20T20:25:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2121088705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Am I right that after this change (or alternatives which let BatchWrite just iterate dirty/fresh entries), it would be possible to (perhaps dramatically) reduce the periodic flush time, so that after IBD, we basically always have a mostly non-dirty cache? Such a change could be made today of course, but the cost of iterating the entire cache every time would add up quickly.\r\n\r\nI believe you are right, but I'm unsure what the benefit is that you see. From my understanding, the periodic flushes are solely to prevent data loss in case of unclean shutdown (otherwise, flushing from filling the dbcache or flushing from shutting down cleanly prevent data loss). With a 24 hour periodic flush schedule and https://github.com/bitcoin/bitcoin/pull/15218, the most that is at risk is ~144 blocks worth of data?\r\n\r\nIf you are talking about periodic flushes *during* IBD though, that might be a benefit that could obviate https://github.com/bitcoin/bitcoin/pull/15218 and properly fix https://github.com/bitcoin/bitcoin/issues/11600. If we reduce the periodic flush interval to an hour or so, then only an hour or so of IBD data would be at risk of rolling back. This would of course mean that there is less opportunity for the cache to delete FRESH & DIRTY entries on spend so they never have to hit the disk, so it would be less performant. But it would still keep the cache for connecting blocks quickly.",
      "created_at" : "2024-05-21T16:44:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2123033320",
      "id" : 2123033320,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585-iuro",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2123033320/reactions"
      },
      "updated_at" : "2024-05-21T16:44:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2123033320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@andrewtoth I was talking about post-IBD. And one advantage to more frequent flushing is reducing the latency spikes you get when a flush is triggered.",
      "created_at" : "2024-05-21T16:51:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2123045950",
      "id" : 2123045950,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585-ixw-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2123045950/reactions"
      },
      "updated_at" : "2024-05-21T16:51:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2123045950",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> `BatchWrite` already iterates the entire cache anyways\r\n\r\n@achow101 I think this is what you might not be clear about. `BatchWrite` iterates the entire cache, but this patch does not. After this patch `BatchWrite` only iterates flagged entries, which is a much smaller subset of the cache.\r\n\r\nI tried moving everything in the loop in `Sync` into `BatchWrite`, along with `cachedCoinsUsage` so it can be decremented as we delete spent coins from the child cache, and it looks like it will take many times longer to sync with `dbcache=16384 prune=550` than current `master`. So I don't think that's a viable alternative solution to what is proposed here.",
      "created_at" : "2024-06-03T12:43:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2145109407",
      "id" : 2145109407,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28280",
      "node_id" : "IC_kwDOABII585_28Wf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2145109407/reactions"
      },
      "updated_at" : "2024-06-03T12:43:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2145109407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1652853326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1652853326"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "would it make sense to use `cacheCoins.try_emplace` without the `forward_as_tuple` parts (similarly to what I've tried [in a related PR](https://github.com/bitcoin/bitcoin/pull/30326/files#diff-f0ed73d62dae6ca28ebd3045e5fc0d5d02eaaacadb4c2a292985a3fbd7e1c77cR44)) (in a separate commit or PR)",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-25T13:44:43Z",
      "diff_hunk" : "@@ -108,10 +108,13 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n \n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n-    cacheCoins.emplace(\n+    auto [it, inserted] = cacheCoins.emplace(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1652853326",
      "id" : 1652853326,
      "line" : 111,
      "node_id" : "PRRC_kwDOABII585ihIpO",
      "original_commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "original_line" : 111,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 45,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1652853326/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1652853326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1655477509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1655477509"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This comment and the implementation further persists the notion of FRESH-but-not-DIRTY coin, which I think is unfortunate, because it should be impossible for them to exist:\r\nThe only place in which they could be created is [here](https://github.com/bitcoin/bitcoin/blob/b27afb7fb774809c9c075d56e44657e0b607a00c/src/coins.cpp#L54), while fetching a coin from the parent that is spent. However that is not possible because we'd only get to that point if the [GetCoin()](https://github.com/bitcoin/bitcoin/blob/b27afb7fb774809c9c075d56e44657e0b607a00c/src/coins.cpp#L48) call a few lines above returned `true` - which is impossible for spent coins because according to the abstract `CCoinsView` interface, `GetCoin` \"[Returns true only when an unspent coin was found, which is returned in coin](https://github.com/bitcoin/bitcoin/blob/b27afb7fb774809c9c075d56e44657e0b607a00c/src/coins.h#L176).\" This is followed both by `CCoinsViewCache::GetCoin`, which returns `false` if spent and `CCoinsViewDB::GetCoin` which doesn't return spent coins because they are never saved to disk.\r\n\r\nMaybe it would be good to revive #18746 which attempted to fix this but got closed.\r\n\r\nWith that, this PR could add only DIRTY coins and ignore the FRESH flag, which would be simpler.\r\n",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-26T20:24:17Z",
      "diff_hunk" : "@@ -103,6 +106,30 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    /**\n+     * These are used to create a doubly linked list of flagged entries.\n+     * They are set in AddFlags and unset in ClearFlags.\n+     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     *\n+     * DIRTY entries are tracked so that only modified entries can be passed to\n+     * the parent cache to do a batch write. This is a performance optimization\n+     * compared to giving all entries in the cache to the parent and having the\n+     * parent scan for only modified entries.\n+     *\n+     * FRESH entries are tracked because a FRESH-but-not-DIRTY entry can only be\n+     * a spent coin that exists in the parent cache. When performing a batch",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1655477509",
      "id" : 1655477509,
      "line" : 121,
      "node_id" : "PRRC_kwDOABII585irJUF",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 121,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 26,
      "pull_request_review_id" : 2142888699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1655477509/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-27T18:45:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1655477509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1657288151"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1657288151"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that it should be explained in a comment similar as it's already done in `CCoinsViewCache::BatchWrite` why we keep unspent coins because this is not obvious.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-27T14:51:20Z",
      "diff_hunk" : "@@ -124,7 +124,7 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock, boo\n             changed++;\n         }\n         count++;\n-        it = erase ? mapCoins.erase(it) : std::next(it);\n+        it = it->second.Next(will_erase || !it->second.coin.IsSpent());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1657288151",
      "id" : 1657288151,
      "line" : 127,
      "node_id" : "PRRC_kwDOABII585iyDXX",
      "original_commit_id" : "a6324db9c6ae1b71b9687923a516a8adc01b7e1a",
      "original_line" : 127,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : 25,
      "pull_request_review_id" : 2142888699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1657288151/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-27T18:45:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1657288151",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1657659234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1657659234"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "see https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1655477509, I think that FRESH-but-not-DIRTY coins may not exist.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-27T18:48:14Z",
      "diff_hunk" : "@@ -51,7 +51,7 @@ CCoinsMap::iterator CCoinsViewCache::FetchCoin(const COutPoint &outpoint) const\n     if (ret->second.coin.IsSpent()) {\n         // The parent only has an empty entry for this outpoint; we can consider our\n         // version as fresh.\n-        ret->second.flags = CCoinsCacheEntry::FRESH;\n+        ret->second.AddFlags(CCoinsCacheEntry::FRESH, *ret, m_flagged_head);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1657659234",
      "id" : 1657659234,
      "in_reply_to_id" : 1527534087,
      "line" : 54,
      "node_id" : "PRRC_kwDOABII585izd9i",
      "original_commit_id" : "75a248f770fed4d8bf664bb9d5ed1f80e51c9bc8",
      "original_line" : 54,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 23,
      "pull_request_review_id" : 2146259536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1657659234/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-27T18:48:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1657659234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658060325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658060325"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> With that, this PR could add only DIRTY coins and ignore the FRESH flag, which would be simpler.\n\nI'm not sure how that would be simpler. The two flags are coupled and so adding one and not the other would be a more complex diff. Perhaps I don't understand what you are suggesting?\n\nI could just replace the single FRESH-but-not-DIRTY check with an assertion and remove this comment about tracking FRESH coins?",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T02:36:04Z",
      "diff_hunk" : "@@ -103,6 +106,30 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    /**\n+     * These are used to create a doubly linked list of flagged entries.\n+     * They are set in AddFlags and unset in ClearFlags.\n+     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     *\n+     * DIRTY entries are tracked so that only modified entries can be passed to\n+     * the parent cache to do a batch write. This is a performance optimization\n+     * compared to giving all entries in the cache to the parent and having the\n+     * parent scan for only modified entries.\n+     *\n+     * FRESH entries are tracked because a FRESH-but-not-DIRTY entry can only be\n+     * a spent coin that exists in the parent cache. When performing a batch",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658060325",
      "id" : 1658060325,
      "in_reply_to_id" : 1655477509,
      "line" : 121,
      "node_id" : "PRRC_kwDOABII585i0_4l",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 121,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 26,
      "pull_request_review_id" : 2146910713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658060325/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T02:36:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658060325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658390684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658390684"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n     * write without clearing the cache (CCoinsViewCache::Sync), we must also\r\n```",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T09:03:27Z",
      "diff_hunk" : "@@ -103,6 +106,30 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    /**\n+     * These are used to create a doubly linked list of flagged entries.\n+     * They are set in AddFlags and unset in ClearFlags.\n+     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     *\n+     * DIRTY entries are tracked so that only modified entries can be passed to\n+     * the parent cache to do a batch write. This is a performance optimization\n+     * compared to giving all entries in the cache to the parent and having the\n+     * parent scan for only modified entries.\n+     *\n+     * FRESH entries are tracked because a FRESH-but-not-DIRTY entry can only be\n+     * a spent coin that exists in the parent cache. When performing a batch\n+     * write but not clearing the cache (CCoinsViewCache::Sync), we must also",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658390684",
      "id" : 1658390684,
      "line" : 122,
      "node_id" : "PRRC_kwDOABII585i2Qic",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 122,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 27,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658390684/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658390684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658391340"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658391340"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit:\r\n```suggestion\r\n     * the parent cache for batch writing. This is a performance optimization\r\n```",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T09:04:01Z",
      "diff_hunk" : "@@ -103,6 +106,30 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    /**\n+     * These are used to create a doubly linked list of flagged entries.\n+     * They are set in AddFlags and unset in ClearFlags.\n+     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     *\n+     * DIRTY entries are tracked so that only modified entries can be passed to\n+     * the parent cache to do a batch write. This is a performance optimization",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658391340",
      "id" : 1658391340,
      "line" : 116,
      "node_id" : "PRRC_kwDOABII585i2Qss",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 116,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 21,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658391340/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658391340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658394351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658394351"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: redundant comment",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T09:06:44Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658394351",
      "id" : 1658394351,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585i2Rbv",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 163,
      "original_position" : 48,
      "original_start_line" : 162,
      "path" : "src/coins.h",
      "position" : 55,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658394351/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 160,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658394351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658399777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658399777"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably not a realistic scenario (may require multithreaded access because of the `m_flags` guard, not sure) , but `m_prev` will never be `null` when we get here, right?",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T09:11:34Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list\n+        ClearFlags();\n+    }\n+\n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the head of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)\n+    {\n+        if (flags == 0) return;\n+        if (m_flags != 0) {\n+            m_flags |= flags;\n+            return;\n+        }\n+        m_prev = &head;\n+        m_next = head.second.m_next;\n+        head.second.m_next = &self;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = &self;\n+        }\n+        m_flags = flags;\n+    }\n+\n+    inline void ClearFlags()\n+    {\n+        if (m_flags == 0) return;\n+        m_prev->second.m_next = m_next;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658399777",
      "id" : 1658399777,
      "line" : 187,
      "node_id" : "PRRC_kwDOABII585i2Swh",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 189,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 81,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658399777/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658399777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658417894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658417894"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n    // Check that calling `ClearFlags` with 0 flags has no effect\r\n```",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T09:26:33Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <list>\n+\n+BOOST_AUTO_TEST_SUITE(coinscachepair_tests)\n+\n+static constexpr auto NUM_NODES{4};\n+\n+std::list<CoinsCachePair> CreatePairs(CoinsCachePair& head)\n+{\n+    std::list<CoinsCachePair> nodes;\n+    for (auto i{0}; i < NUM_NODES; ++i) {\n+        nodes.emplace_front();\n+\n+        auto node{nodes.begin()};\n+        node->second.AddFlags(CCoinsCacheEntry::DIRTY, *node, head);\n+\n+        BOOST_CHECK_EQUAL(node->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+        BOOST_CHECK_EQUAL(head.second.Next(), &(*node));\n+\n+        if (i > 0) {\n+            BOOST_CHECK_EQUAL(&(*std::next(node)), node->second.Next());\n+        } else {\n+            BOOST_CHECK_EQUAL(nullptr, node->second.Next());\n+        }\n+    }\n+    return nodes;\n+}\n+\n+BOOST_AUTO_TEST_CASE(linked_list_iteration)\n+{\n+    CoinsCachePair head;\n+    auto nodes{CreatePairs(head)};\n+\n+    // Check iterating through pairs is identical to iterating through a list\n+    auto lit{nodes.begin()};\n+    for (auto it{head.second.Next()}; it != nullptr; it = it->second.Next(/*clear_flags=*/false), ++lit) {\n+        BOOST_CHECK_EQUAL(&(*lit), it);\n+    }\n+\n+    // Check iterating through pairs is identical to iterating through a list\n+    // Clear the flags during iteration\n+    lit = nodes.begin();\n+    for (auto it{head.second.Next()}; it != nullptr; it = it->second.Next(/*clear_flags=*/true), ++lit) {\n+        BOOST_CHECK_EQUAL(&(*lit), it);\n+    }\n+    // Check that head is empty\n+    BOOST_CHECK_EQUAL(head.second.Next(), nullptr);\n+\n+    // Delete the nodes from the list to make sure there are no dangling pointers\n+    for (auto it{nodes.begin()}; it != nodes.end(); it = nodes.erase(it)) {\n+        BOOST_CHECK_EQUAL(it->second.GetFlags(), 0);\n+        BOOST_CHECK_EQUAL(it->second.Next(), nullptr);\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(linked_list_iterate_erase)\n+{\n+    CoinsCachePair head;\n+    auto nodes{CreatePairs(head)};\n+\n+    // Check iterating through pairs is identical to iterating through a list\n+    // Erase the nodes as we iterate through, but don't clear flags\n+    // The flags will be cleared by the CCoinsCacheEntry's destructor\n+    auto lit{nodes.begin()};\n+    for (auto it{head.second.Next()}; it != nullptr; it = it->second.Next(/*clear_flags=*/false), lit = nodes.erase(lit)) {\n+        BOOST_CHECK_EQUAL(&(*lit), it);\n+    }\n+    // Check that head is empty\n+    BOOST_CHECK_EQUAL(head.second.Next(), nullptr);\n+}\n+\n+BOOST_AUTO_TEST_CASE(linked_list_random_deletion)\n+{\n+    CoinsCachePair head;\n+    auto nodes{CreatePairs(head)};\n+\n+    // Create linked list head->n1->n2->n3->n4->nullptr\n+    auto n1{nodes.begin()};\n+    auto n2{std::next(n1)};\n+    auto n3{std::next(n2)};\n+    auto n4{std::next(n3)};\n+\n+    // Delete n2\n+    // head->n1->n3->n4->nullptr\n+    nodes.erase(n2);\n+    // Check that n1 now points to n3, and n3 still points to n4\n+    // Also check that flags were not altered\n+    BOOST_CHECK_EQUAL(n1->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK_EQUAL(n1->second.Next(), &(*n3));\n+    BOOST_CHECK_EQUAL(n3->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK_EQUAL(n3->second.Next(), &(*n4));\n+\n+    // Delete n1\n+    // head->n3->n4->nullptr\n+    nodes.erase(n1);\n+    // Check that head now points to n3, and n3 still points to n4\n+    // Also check that flags were not altered\n+    BOOST_CHECK_EQUAL(n3->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK_EQUAL(head.second.Next(), &(*n3));\n+    BOOST_CHECK_EQUAL(n3->second.Next(), &(*n4));\n+\n+    // Delete n4\n+    // head->n3->nullptr\n+    nodes.erase(n4);\n+    // Check that head still points to n3, and n3 points to nullptr\n+    // Also check that flags were not altered\n+    BOOST_CHECK_EQUAL(n3->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK_EQUAL(head.second.Next(), &(*n3));\n+    BOOST_CHECK_EQUAL(n3->second.Next(), nullptr);\n+\n+    // Delete n3\n+    // head->nullptr\n+    nodes.erase(n3);\n+    // Check that head now points to nullptr\n+    BOOST_CHECK_EQUAL(head.second.Next(), nullptr);\n+}\n+\n+BOOST_AUTO_TEST_CASE(linked_list_add_flags)\n+{\n+    CoinsCachePair head;\n+    CoinsCachePair n1;\n+    CoinsCachePair n2;\n+\n+    // Check that adding 0 flag has no effect\n+    n1.second.AddFlags(0, n1, head);\n+    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n+    BOOST_CHECK_EQUAL(n1.second.Next(), nullptr);\n+    BOOST_CHECK_EQUAL(head.second.Next(), nullptr);\n+\n+    // Check that adding DIRTY flag inserts it into linked list and sets flags\n+    n1.second.AddFlags(CCoinsCacheEntry::DIRTY, n1, head);\n+    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK_EQUAL(n1.second.Next(), nullptr);\n+    BOOST_CHECK_EQUAL(head.second.Next(), &n1);\n+\n+    // Check that adding FRESH flag on new node inserts it after head\n+    n2.second.AddFlags(CCoinsCacheEntry::FRESH, n2, head);\n+    BOOST_CHECK_EQUAL(n2.second.GetFlags(), CCoinsCacheEntry::FRESH);\n+    BOOST_CHECK_EQUAL(n2.second.Next(), &n1);\n+    BOOST_CHECK_EQUAL(head.second.Next(), &n2);\n+\n+    // Check that adding 0 flag has no effect, and doesn't change position\n+    n1.second.AddFlags(0, n1, head);\n+    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK_EQUAL(n1.second.Next(), nullptr);\n+    BOOST_CHECK_EQUAL(head.second.Next(), &n2);\n+    BOOST_CHECK_EQUAL(n2.second.Next(), &n1);\n+\n+    // Check that we can add extra flags, but they don't change our position\n+    n1.second.AddFlags(CCoinsCacheEntry::FRESH, n1, head);\n+    BOOST_CHECK_EQUAL(n1.second.GetFlags(), CCoinsCacheEntry::DIRTY | CCoinsCacheEntry::FRESH);\n+    BOOST_CHECK_EQUAL(n1.second.Next(), nullptr);\n+    BOOST_CHECK_EQUAL(head.second.Next(), &n2);\n+    BOOST_CHECK_EQUAL(n2.second.Next(), &n1);\n+\n+    // Check that we can clear flags then re-add them\n+    n1.second.ClearFlags();\n+    BOOST_CHECK_EQUAL(n1.second.GetFlags(), 0);\n+    BOOST_CHECK_EQUAL(n2.second.Next(), nullptr);\n+\n+    // Check that we calling `ClearFlags` with 0 flags has no effect",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658417894",
      "id" : 1658417894,
      "line" : 168,
      "node_id" : "PRRC_kwDOABII585i2XLm",
      "original_commit_id" : "6508bdfe437100a10be3730cefdb26efa5b5ad37",
      "original_line" : 168,
      "original_position" : 168,
      "original_start_line" : null,
      "path" : "src/test/coinscachepair_tests.cpp",
      "position" : 168,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658417894/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658417894",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658694832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658694832"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not yet sure why iteration is tied to mutation here",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T12:49:09Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list\n+        ClearFlags();\n+    }\n+\n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the head of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)\n+    {\n+        if (flags == 0) return;\n+        if (m_flags != 0) {\n+            m_flags |= flags;\n+            return;\n+        }\n+        m_prev = &head;\n+        m_next = head.second.m_next;\n+        head.second.m_next = &self;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = &self;\n+        }\n+        m_flags = flags;\n+    }\n+\n+    inline void ClearFlags()\n+    {\n+        if (m_flags == 0) return;\n+        m_prev->second.m_next = m_next;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = m_prev;\n+        }\n+        m_prev = nullptr;\n+        m_next = nullptr;\n+        m_flags = 0;\n+    }\n+\n+    inline uint8_t GetFlags() const { return m_flags; }\n+\n+    //! Get the next entry in the flagged linked list, optionally removing the\n+    //! current entry and clearing the flags.\n+    inline CoinsCachePair* Next(bool clear_flags = false)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658694832",
      "id" : 1658694832,
      "line" : 200,
      "node_id" : "PRRC_kwDOABII585i3ayw",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 202,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 94,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658694832/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:08:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658694832",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658743023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658743023"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I find it quite confusing that `AddFlags` modifies the linked list as well (vs `GetFlags` only returning the flags, of course). Could make sense to split it to multiple methods or add the side-effect to the name",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T13:26:54Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list\n+        ClearFlags();\n+    }\n+\n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the head of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658743023",
      "id" : 1658743023,
      "line" : 168,
      "node_id" : "PRRC_kwDOABII585i3mjv",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 170,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 62,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658743023/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658743023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658765626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658765626"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since iteration could misbehave severely and this would pass (e.g. if `Next()` would return `nullptr` we wouldn't even enter the loop), it could make more sense to iterate over the target nodes instead, something like:\r\n```C++\r\n    auto node{head.second.Next()};\r\n    for (const auto& expected : nodes) {\r\n        BOOST_CHECK_EQUAL(&expected, node);\r\n        node = node->second.Next();\r\n    }\r\n    BOOST_CHECK_EQUAL(nullptr, node);\r\n```\r\nor\r\n```C++\r\n    auto node{&head};\r\n    for (const auto& expected : nodes) {\r\n        node = node->second.Next();\r\n        BOOST_CHECK_EQUAL(&expected, node);\r\n    }\r\n    BOOST_CHECK_EQUAL(node->second.Next(), nullptr);\r\n```",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T13:38:27Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <list>\n+\n+BOOST_AUTO_TEST_SUITE(coinscachepair_tests)\n+\n+static constexpr auto NUM_NODES{4};\n+\n+std::list<CoinsCachePair> CreatePairs(CoinsCachePair& head)\n+{\n+    std::list<CoinsCachePair> nodes;\n+    for (auto i{0}; i < NUM_NODES; ++i) {\n+        nodes.emplace_front();\n+\n+        auto node{nodes.begin()};\n+        node->second.AddFlags(CCoinsCacheEntry::DIRTY, *node, head);\n+\n+        BOOST_CHECK_EQUAL(node->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+        BOOST_CHECK_EQUAL(head.second.Next(), &(*node));\n+\n+        if (i > 0) {\n+            BOOST_CHECK_EQUAL(&(*std::next(node)), node->second.Next());\n+        } else {\n+            BOOST_CHECK_EQUAL(nullptr, node->second.Next());\n+        }\n+    }\n+    return nodes;\n+}\n+\n+BOOST_AUTO_TEST_CASE(linked_list_iteration)\n+{\n+    CoinsCachePair head;\n+    auto nodes{CreatePairs(head)};\n+\n+    // Check iterating through pairs is identical to iterating through a list\n+    auto lit{nodes.begin()};\n+    for (auto it{head.second.Next()}; it != nullptr; it = it->second.Next(/*clear_flags=*/false), ++lit) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658765626",
      "id" : 1658765626,
      "line" : 43,
      "node_id" : "PRRC_kwDOABII585i3sE6",
      "original_commit_id" : "6508bdfe437100a10be3730cefdb26efa5b5ad37",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/test/coinscachepair_tests.cpp",
      "position" : 43,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658765626/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T16:01:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658765626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658780016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658780016"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "shouldn't we construct this via production code somehow?\r\nOtherwise we're just testing test code...",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T13:45:49Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <list>\n+\n+BOOST_AUTO_TEST_SUITE(coinscachepair_tests)\n+\n+static constexpr auto NUM_NODES{4};\n+\n+std::list<CoinsCachePair> CreatePairs(CoinsCachePair& head)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658780016",
      "id" : 1658780016,
      "line" : 15,
      "node_id" : "PRRC_kwDOABII585i3vlw",
      "original_commit_id" : "6508bdfe437100a10be3730cefdb26efa5b5ad37",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/test/coinscachepair_tests.cpp",
      "position" : 15,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658780016/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658780016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658810375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658810375"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not exactly sure what this test is checking, that the doubly linked list is unaffected by the std::list's modification?",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T14:03:37Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <list>\n+\n+BOOST_AUTO_TEST_SUITE(coinscachepair_tests)\n+\n+static constexpr auto NUM_NODES{4};\n+\n+std::list<CoinsCachePair> CreatePairs(CoinsCachePair& head)\n+{\n+    std::list<CoinsCachePair> nodes;\n+    for (auto i{0}; i < NUM_NODES; ++i) {\n+        nodes.emplace_front();\n+\n+        auto node{nodes.begin()};\n+        node->second.AddFlags(CCoinsCacheEntry::DIRTY, *node, head);\n+\n+        BOOST_CHECK_EQUAL(node->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+        BOOST_CHECK_EQUAL(head.second.Next(), &(*node));\n+\n+        if (i > 0) {\n+            BOOST_CHECK_EQUAL(&(*std::next(node)), node->second.Next());\n+        } else {\n+            BOOST_CHECK_EQUAL(nullptr, node->second.Next());\n+        }\n+    }\n+    return nodes;\n+}\n+\n+BOOST_AUTO_TEST_CASE(linked_list_iteration)\n+{\n+    CoinsCachePair head;\n+    auto nodes{CreatePairs(head)};\n+\n+    // Check iterating through pairs is identical to iterating through a list\n+    auto lit{nodes.begin()};\n+    for (auto it{head.second.Next()}; it != nullptr; it = it->second.Next(/*clear_flags=*/false), ++lit) {\n+        BOOST_CHECK_EQUAL(&(*lit), it);\n+    }\n+\n+    // Check iterating through pairs is identical to iterating through a list\n+    // Clear the flags during iteration\n+    lit = nodes.begin();\n+    for (auto it{head.second.Next()}; it != nullptr; it = it->second.Next(/*clear_flags=*/true), ++lit) {\n+        BOOST_CHECK_EQUAL(&(*lit), it);\n+    }\n+    // Check that head is empty\n+    BOOST_CHECK_EQUAL(head.second.Next(), nullptr);\n+\n+    // Delete the nodes from the list to make sure there are no dangling pointers\n+    for (auto it{nodes.begin()}; it != nodes.end(); it = nodes.erase(it)) {\n+        BOOST_CHECK_EQUAL(it->second.GetFlags(), 0);\n+        BOOST_CHECK_EQUAL(it->second.Next(), nullptr);\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(linked_list_iterate_erase)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658810375",
      "id" : 1658810375,
      "line" : 63,
      "node_id" : "PRRC_kwDOABII585i33AH",
      "original_commit_id" : "6508bdfe437100a10be3730cefdb26efa5b5ad37",
      "original_line" : 63,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/test/coinscachepair_tests.cpp",
      "position" : 63,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658810375/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T16:43:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658810375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658824573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658824573"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "is this here just for completeness' sake? Or how would a list operation affect the head node's behavior?",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T14:13:00Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <list>\n+\n+BOOST_AUTO_TEST_SUITE(coinscachepair_tests)\n+\n+static constexpr auto NUM_NODES{4};\n+\n+std::list<CoinsCachePair> CreatePairs(CoinsCachePair& head)\n+{\n+    std::list<CoinsCachePair> nodes;\n+    for (auto i{0}; i < NUM_NODES; ++i) {\n+        nodes.emplace_front();\n+\n+        auto node{nodes.begin()};\n+        node->second.AddFlags(CCoinsCacheEntry::DIRTY, *node, head);\n+\n+        BOOST_CHECK_EQUAL(node->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+        BOOST_CHECK_EQUAL(head.second.Next(), &(*node));\n+\n+        if (i > 0) {\n+            BOOST_CHECK_EQUAL(&(*std::next(node)), node->second.Next());\n+        } else {\n+            BOOST_CHECK_EQUAL(nullptr, node->second.Next());\n+        }\n+    }\n+    return nodes;\n+}\n+\n+BOOST_AUTO_TEST_CASE(linked_list_iteration)\n+{\n+    CoinsCachePair head;\n+    auto nodes{CreatePairs(head)};\n+\n+    // Check iterating through pairs is identical to iterating through a list\n+    auto lit{nodes.begin()};\n+    for (auto it{head.second.Next()}; it != nullptr; it = it->second.Next(/*clear_flags=*/false), ++lit) {\n+        BOOST_CHECK_EQUAL(&(*lit), it);\n+    }\n+\n+    // Check iterating through pairs is identical to iterating through a list\n+    // Clear the flags during iteration\n+    lit = nodes.begin();\n+    for (auto it{head.second.Next()}; it != nullptr; it = it->second.Next(/*clear_flags=*/true), ++lit) {\n+        BOOST_CHECK_EQUAL(&(*lit), it);\n+    }\n+    // Check that head is empty\n+    BOOST_CHECK_EQUAL(head.second.Next(), nullptr);\n+\n+    // Delete the nodes from the list to make sure there are no dangling pointers\n+    for (auto it{nodes.begin()}; it != nodes.end(); it = nodes.erase(it)) {\n+        BOOST_CHECK_EQUAL(it->second.GetFlags(), 0);\n+        BOOST_CHECK_EQUAL(it->second.Next(), nullptr);\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(linked_list_iterate_erase)\n+{\n+    CoinsCachePair head;\n+    auto nodes{CreatePairs(head)};\n+\n+    // Check iterating through pairs is identical to iterating through a list\n+    // Erase the nodes as we iterate through, but don't clear flags\n+    // The flags will be cleared by the CCoinsCacheEntry's destructor\n+    auto lit{nodes.begin()};\n+    for (auto it{head.second.Next()}; it != nullptr; it = it->second.Next(/*clear_flags=*/false), lit = nodes.erase(lit)) {\n+        BOOST_CHECK_EQUAL(&(*lit), it);\n+    }\n+    // Check that head is empty\n+    BOOST_CHECK_EQUAL(head.second.Next(), nullptr);\n+}\n+\n+BOOST_AUTO_TEST_CASE(linked_list_random_deletion)\n+{\n+    CoinsCachePair head;\n+    auto nodes{CreatePairs(head)};\n+\n+    // Create linked list head->n1->n2->n3->n4->nullptr\n+    auto n1{nodes.begin()};\n+    auto n2{std::next(n1)};\n+    auto n3{std::next(n2)};\n+    auto n4{std::next(n3)};\n+\n+    // Delete n2\n+    // head->n1->n3->n4->nullptr\n+    nodes.erase(n2);\n+    // Check that n1 now points to n3, and n3 still points to n4\n+    // Also check that flags were not altered\n+    BOOST_CHECK_EQUAL(n1->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK_EQUAL(n1->second.Next(), &(*n3));\n+    BOOST_CHECK_EQUAL(n3->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK_EQUAL(n3->second.Next(), &(*n4));\n+\n+    // Delete n1\n+    // head->n3->n4->nullptr\n+    nodes.erase(n1);\n+    // Check that head now points to n3, and n3 still points to n4\n+    // Also check that flags were not altered\n+    BOOST_CHECK_EQUAL(n3->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK_EQUAL(head.second.Next(), &(*n3));\n+    BOOST_CHECK_EQUAL(n3->second.Next(), &(*n4));\n+\n+    // Delete n4\n+    // head->n3->nullptr\n+    nodes.erase(n4);\n+    // Check that head still points to n3, and n3 points to nullptr\n+    // Also check that flags were not altered\n+    BOOST_CHECK_EQUAL(n3->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+    BOOST_CHECK_EQUAL(head.second.Next(), &(*n3));\n+    BOOST_CHECK_EQUAL(n3->second.Next(), nullptr);\n+\n+    // Delete n3\n+    // head->nullptr\n+    nodes.erase(n3);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658824573",
      "id" : 1658824573,
      "line" : 120,
      "node_id" : "PRRC_kwDOABII585i36d9",
      "original_commit_id" : "6508bdfe437100a10be3730cefdb26efa5b5ad37",
      "original_line" : 120,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/test/coinscachepair_tests.cpp",
      "position" : 120,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658824573/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658824573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658828407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658828407"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "we should validate the `m_prev` as well here",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T14:15:39Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <list>\n+\n+BOOST_AUTO_TEST_SUITE(coinscachepair_tests)\n+\n+static constexpr auto NUM_NODES{4};\n+\n+std::list<CoinsCachePair> CreatePairs(CoinsCachePair& head)\n+{\n+    std::list<CoinsCachePair> nodes;\n+    for (auto i{0}; i < NUM_NODES; ++i) {\n+        nodes.emplace_front();\n+\n+        auto node{nodes.begin()};\n+        node->second.AddFlags(CCoinsCacheEntry::DIRTY, *node, head);\n+\n+        BOOST_CHECK_EQUAL(node->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+        BOOST_CHECK_EQUAL(head.second.Next(), &(*node));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658828407",
      "id" : 1658828407,
      "line" : 25,
      "node_id" : "PRRC_kwDOABII585i37Z3",
      "original_commit_id" : "6508bdfe437100a10be3730cefdb26efa5b5ad37",
      "original_line" : 25,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/test/coinscachepair_tests.cpp",
      "position" : 25,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658828407/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658828407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658879134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658879134"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I find it confusing that `m_flags` is set multiple times (suggestion below)",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T14:54:19Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list\n+        ClearFlags();\n+    }\n+\n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the head of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)\n+    {\n+        if (flags == 0) return;\n+        if (m_flags != 0) {\n+            m_flags |= flags;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658879134",
      "id" : 1658879134,
      "line" : 172,
      "node_id" : "PRRC_kwDOABII585i4Hye",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 174,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 66,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658879134/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658879134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658888841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658888841"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "we could move the `m_next` setter closer to the check, something like:\r\n```C++\r\n    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)\r\n    {\r\n        if (!m_flags && flags) {\r\n            m_prev = &head;\r\n            m_next = head.second.m_next;\r\n            if (m_next) m_next->second.m_prev = &self;\r\n            head.second.m_next = &self;\r\n        }\r\n        m_flags |= flags;\r\n    }\r\n```",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T15:02:00Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list\n+        ClearFlags();\n+    }\n+\n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the head of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)\n+    {\n+        if (flags == 0) return;\n+        if (m_flags != 0) {\n+            m_flags |= flags;\n+            return;\n+        }\n+        m_prev = &head;\n+        m_next = head.second.m_next;\n+        head.second.m_next = &self;\n+        if (m_next != nullptr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658888841",
      "id" : 1658888841,
      "line" : 178,
      "node_id" : "PRRC_kwDOABII585i4KKJ",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 180,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 72,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658888841/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:45:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658888841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658892949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658892949"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "we could apply the same concept here to separate the constants from the condition (i.e. flags are always 0 after this call):\r\n```C++\r\n    inline void ClearFlags()\r\n    {\r\n        if (m_flags) {\r\n            if (m_next) m_next->second.m_prev = m_prev;\r\n            m_prev->second.m_next = m_next;\r\n            m_prev = m_next = nullptr;\r\n        }\r\n        m_flags = 0;\r\n    }\r\n```",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T15:05:34Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list\n+        ClearFlags();\n+    }\n+\n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the head of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)\n+    {\n+        if (flags == 0) return;\n+        if (m_flags != 0) {\n+            m_flags |= flags;\n+            return;\n+        }\n+        m_prev = &head;\n+        m_next = head.second.m_next;\n+        head.second.m_next = &self;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = &self;\n+        }\n+        m_flags = flags;\n+    }\n+\n+    inline void ClearFlags()\n+    {\n+        if (m_flags == 0) return;\n+        m_prev->second.m_next = m_next;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = m_prev;\n+        }\n+        m_prev = nullptr;\n+        m_next = nullptr;\n+        m_flags = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658892949",
      "id" : 1658892949,
      "line" : 193,
      "node_id" : "PRRC_kwDOABII585i4LKV",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 195,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 87,
      "pull_request_review_id" : 2138727793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658892949/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658892949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658924696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658924696"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I thought some more and don't find a great way to simplify the logic. I think it would be enough to remove / amend the comment, maybe mentioning instead that FRESH-but-not-DIRTY coins are not expected to occur but would be handled well if they did.\r\n\r\n> replace the single FRESH-but-not-DIRTY check \r\n\r\nNot sure if that's the \"check\" you mean, but replacing [this](https://github.com/bitcoin/bitcoin/blob/b27afb7fb774809c9c075d56e44657e0b607a00c/src/coins.cpp#L51-L55) with an assertion was essentially what #18746 did in its latest version. Since that PR was mildly controversial (I think mostly because it originally had the spin of \"These coins may be unnecessarily added today; don't add them anymore\" instead of \"We already don't add them. Remove unreachable code\") I think the question of adding an assert should be separated from this PR.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T15:31:57Z",
      "diff_hunk" : "@@ -103,6 +106,30 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    /**\n+     * These are used to create a doubly linked list of flagged entries.\n+     * They are set in AddFlags and unset in ClearFlags.\n+     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     *\n+     * DIRTY entries are tracked so that only modified entries can be passed to\n+     * the parent cache to do a batch write. This is a performance optimization\n+     * compared to giving all entries in the cache to the parent and having the\n+     * parent scan for only modified entries.\n+     *\n+     * FRESH entries are tracked because a FRESH-but-not-DIRTY entry can only be\n+     * a spent coin that exists in the parent cache. When performing a batch",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658924696",
      "id" : 1658924696,
      "in_reply_to_id" : 1655477509,
      "line" : 121,
      "node_id" : "PRRC_kwDOABII585i4S6Y",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 121,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 26,
      "pull_request_review_id" : 2148325051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658924696/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T15:31:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658924696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658985403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658985403"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "doing refactoring and logic changes in the same commit makes reviewing slightly harder - could you extract all non-critical changes in a separate commit so that we can concentrate on high-risk code more than on stylistic changes (which are important, but shouldn't distract us)",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T16:21:57Z",
      "diff_hunk" : "@@ -12,7 +12,7 @@\n bool CCoinsView::GetCoin(const COutPoint &outpoint, Coin &coin) const { return false; }\n uint256 CCoinsView::GetBestBlock() const { return uint256(); }\n std::vector<uint256> CCoinsView::GetHeadBlocks() const { return std::vector<uint256>(); }\n-bool CCoinsView::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock, bool erase) { return false; }\n+bool CCoinsView::BatchWrite(CoinsCachePair *pairs, const uint256 &hashBlock, bool will_erase) { return false; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1658985403",
      "id" : 1658985403,
      "line" : 15,
      "node_id" : "PRRC_kwDOABII585i4hu7",
      "original_commit_id" : "a6324db9c6ae1b71b9687923a516a8adc01b7e1a",
      "original_line" : 15,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 5,
      "pull_request_review_id" : 2148425344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658985403/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T16:37:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1658985403",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659000088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659000088"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        auto attr = entry.GetFlags();\r\n```\r\n\r\n(or just remove the assert, doesn't make a lot of sense to me)",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T16:30:39Z",
      "diff_hunk" : "@@ -326,8 +328,8 @@ void CCoinsViewCache::SanityCheck() const\n     size_t recomputed_usage = 0;\n     for (const auto& [_, entry] : cacheCoins) {\n         unsigned attr = 0;\n-        if (entry.flags & CCoinsCacheEntry::DIRTY) attr |= 1;\n-        if (entry.flags & CCoinsCacheEntry::FRESH) attr |= 2;\n+        if (entry.GetFlags() & CCoinsCacheEntry::DIRTY) attr |= 1;\n+        if (entry.GetFlags() & CCoinsCacheEntry::FRESH) attr |= 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659000088",
      "id" : 1659000088,
      "line" : 332,
      "node_id" : "PRRC_kwDOABII585i4lUY",
      "original_commit_id" : "a6324db9c6ae1b71b9687923a516a8adc01b7e1a",
      "original_line" : 332,
      "original_position" : 226,
      "original_start_line" : 330,
      "path" : "src/coins.cpp",
      "position" : 226,
      "pull_request_review_id" : 2148425344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659000088/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 330,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-28T16:37:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659000088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659005029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659005029"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "this `it->second.GetFlags() & CCoinsCacheEntry::DIRTY` appears quite often, maybe it would make sense to extract it to `it->second.IsDirty()` (and `it->second.IsFresh()`, of course)",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T16:34:21Z",
      "diff_hunk" : "@@ -55,10 +55,10 @@ class CCoinsViewTest : public CCoinsView\n \n     uint256 GetBestBlock() const override { return hashBestBlock_; }\n \n-    bool BatchWrite(CCoinsMap& mapCoins, const uint256& hashBlock, bool erase = true) override\n+    bool BatchWrite(CoinsCachePair* pairs, const uint256& hashBlock, bool will_erase = true) override\n     {\n-        for (CCoinsMap::iterator it = mapCoins.begin(); it != mapCoins.end(); it = erase ? mapCoins.erase(it) : std::next(it)) {\n-            if (it->second.flags & CCoinsCacheEntry::DIRTY) {\n+        for (auto it{pairs}; it != nullptr; it = it->second.Next(will_erase || !it->second.coin.IsSpent())) {\n+            if (it->second.GetFlags() & CCoinsCacheEntry::DIRTY) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659005029",
      "id" : 1659005029,
      "line" : 61,
      "node_id" : "PRRC_kwDOABII585i4mhl",
      "original_commit_id" : "a6324db9c6ae1b71b9687923a516a8adc01b7e1a",
      "original_line" : 61,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 10,
      "pull_request_review_id" : 2148425344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659005029/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T16:37:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659005029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659006186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659006186"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, too many changes in one commit",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T16:35:37Z",
      "diff_hunk" : "@@ -124,7 +124,7 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock, boo\n             changed++;\n         }\n         count++;\n-        it = erase ? mapCoins.erase(it) : std::next(it);\n+        it = it->second.Next(will_erase || !it->second.coin.IsSpent());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659006186",
      "id" : 1659006186,
      "in_reply_to_id" : 1657288151,
      "line" : 127,
      "node_id" : "PRRC_kwDOABII585i4mzq",
      "original_commit_id" : "a6324db9c6ae1b71b9687923a516a8adc01b7e1a",
      "original_line" : 127,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : 25,
      "pull_request_review_id" : 2148425344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659006186/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T16:37:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659006186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659023545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659023545"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't fully understand why we need `m_prev` here, but have you investigated whether it's possible to get rid of it and rely on `m_next` only?\r\nSometimes we still have a reference to both (current and next, so we wouldn't need the next's prev), but I assume that wasn't always the case, right?",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T16:50:53Z",
      "diff_hunk" : "@@ -103,8 +106,31 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    /**\n+     * These are used to create a doubly linked list of flagged entries.\n+     * They are set in AddFlags and unset in ClearFlags.\n+     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     *\n+     * DIRTY entries are tracked so that only modified entries can be passed to\n+     * the parent cache to do a batch write. This is a performance optimization\n+     * compared to giving all entries in the cache to the parent and having the\n+     * parent scan for only modified entries.\n+     *\n+     * FRESH entries are tracked because a FRESH-but-not-DIRTY entry can only be\n+     * a spent coin that exists in the parent cache. When performing a batch\n+     * write but not clearing the cache (CCoinsViewCache::Sync), we must also\n+     * erase all spent entries. Since only DIRTY or FRESH entries can be spent,\n+     * we can track them in the linked list to erase them. This is a performance\n+     * optimization compared to scanning all cache entries to find any that are\n+     * spent-but-not-DIRTY.\n+     */\n+    CoinsCachePair* m_prev{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659023545",
      "id" : 1659023545,
      "line" : 128,
      "node_id" : "PRRC_kwDOABII585i4rC5",
      "original_commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "original_line" : 128,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 33,
      "pull_request_review_id" : 2148488069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659023545/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T16:55:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659023545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659178102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659178102"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "With `m_next` we have constant time insertion at the head, which would be fine if we only added flagged entries and cleared them as we traverse them.\r\n\r\nHowever, we also need to delete entries in constant time if they are both `FRESH` and `DIRTY` and get spent. For this we need a doubly linked list.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T18:49:15Z",
      "diff_hunk" : "@@ -103,8 +106,31 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    /**\n+     * These are used to create a doubly linked list of flagged entries.\n+     * They are set in AddFlags and unset in ClearFlags.\n+     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     *\n+     * DIRTY entries are tracked so that only modified entries can be passed to\n+     * the parent cache to do a batch write. This is a performance optimization\n+     * compared to giving all entries in the cache to the parent and having the\n+     * parent scan for only modified entries.\n+     *\n+     * FRESH entries are tracked because a FRESH-but-not-DIRTY entry can only be\n+     * a spent coin that exists in the parent cache. When performing a batch\n+     * write but not clearing the cache (CCoinsViewCache::Sync), we must also\n+     * erase all spent entries. Since only DIRTY or FRESH entries can be spent,\n+     * we can track them in the linked list to erase them. This is a performance\n+     * optimization compared to scanning all cache entries to find any that are\n+     * spent-but-not-DIRTY.\n+     */\n+    CoinsCachePair* m_prev{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659178102",
      "id" : 1659178102,
      "in_reply_to_id" : 1659023545,
      "line" : 128,
      "node_id" : "PRRC_kwDOABII585i5Qx2",
      "original_commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "original_line" : 128,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 33,
      "pull_request_review_id" : 2148737002,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659178102/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T18:49:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659178102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659182104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659182104"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this makes the diff easier to follow, since in git it highlights only the `flags` and `GetFlags()` in the line.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T18:53:32Z",
      "diff_hunk" : "@@ -55,10 +55,10 @@ class CCoinsViewTest : public CCoinsView\n \n     uint256 GetBestBlock() const override { return hashBestBlock_; }\n \n-    bool BatchWrite(CCoinsMap& mapCoins, const uint256& hashBlock, bool erase = true) override\n+    bool BatchWrite(CoinsCachePair* pairs, const uint256& hashBlock, bool will_erase = true) override\n     {\n-        for (CCoinsMap::iterator it = mapCoins.begin(); it != mapCoins.end(); it = erase ? mapCoins.erase(it) : std::next(it)) {\n-            if (it->second.flags & CCoinsCacheEntry::DIRTY) {\n+        for (auto it{pairs}; it != nullptr; it = it->second.Next(will_erase || !it->second.coin.IsSpent())) {\n+            if (it->second.GetFlags() & CCoinsCacheEntry::DIRTY) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659182104",
      "id" : 1659182104,
      "in_reply_to_id" : 1659005029,
      "line" : 61,
      "node_id" : "PRRC_kwDOABII585i5RwY",
      "original_commit_id" : "a6324db9c6ae1b71b9687923a516a8adc01b7e1a",
      "original_line" : 61,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 10,
      "pull_request_review_id" : 2148743861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659182104/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T18:53:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659182104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659186375"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659186375"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's mostly convenience. Otherwise to clear flags while iterating we would have to bind `m_next` to another variable first, then call `ClearFlags` on the current pair, and then bind the the other variable holding the old `m_next` to the current pair variable.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T18:57:24Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list\n+        ClearFlags();\n+    }\n+\n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the head of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)\n+    {\n+        if (flags == 0) return;\n+        if (m_flags != 0) {\n+            m_flags |= flags;\n+            return;\n+        }\n+        m_prev = &head;\n+        m_next = head.second.m_next;\n+        head.second.m_next = &self;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = &self;\n+        }\n+        m_flags = flags;\n+    }\n+\n+    inline void ClearFlags()\n+    {\n+        if (m_flags == 0) return;\n+        m_prev->second.m_next = m_next;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = m_prev;\n+        }\n+        m_prev = nullptr;\n+        m_next = nullptr;\n+        m_flags = 0;\n+    }\n+\n+    inline uint8_t GetFlags() const { return m_flags; }\n+\n+    //! Get the next entry in the flagged linked list, optionally removing the\n+    //! current entry and clearing the flags.\n+    inline CoinsCachePair* Next(bool clear_flags = false)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659186375",
      "id" : 1659186375,
      "in_reply_to_id" : 1658694832,
      "line" : 200,
      "node_id" : "PRRC_kwDOABII585i5SzH",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 202,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 94,
      "pull_request_review_id" : 2148750685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659186375/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T18:57:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659186375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659190841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659190841"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, this code is single threaded so not possible to get past the previous line if `m_prev` is `null`.\r\nIt is possible for `m_prev` to point to a pair that has been freed if the linked list head is destroyed, which is why `cacheCoins` must always be destroyed before the linked list head.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T19:00:35Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list\n+        ClearFlags();\n+    }\n+\n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the head of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)\n+    {\n+        if (flags == 0) return;\n+        if (m_flags != 0) {\n+            m_flags |= flags;\n+            return;\n+        }\n+        m_prev = &head;\n+        m_next = head.second.m_next;\n+        head.second.m_next = &self;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = &self;\n+        }\n+        m_flags = flags;\n+    }\n+\n+    inline void ClearFlags()\n+    {\n+        if (m_flags == 0) return;\n+        m_prev->second.m_next = m_next;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659190841",
      "id" : 1659190841,
      "in_reply_to_id" : 1658399777,
      "line" : 187,
      "node_id" : "PRRC_kwDOABII585i5T45",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 189,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 81,
      "pull_request_review_id" : 2148757621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659190841/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T19:00:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659190841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659205863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659205863"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "if there was a separate commit doing only this, it would simplify the other important commits a lot",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T19:12:32Z",
      "diff_hunk" : "@@ -55,10 +55,10 @@ class CCoinsViewTest : public CCoinsView\n \n     uint256 GetBestBlock() const override { return hashBestBlock_; }\n \n-    bool BatchWrite(CCoinsMap& mapCoins, const uint256& hashBlock, bool erase = true) override\n+    bool BatchWrite(CoinsCachePair* pairs, const uint256& hashBlock, bool will_erase = true) override\n     {\n-        for (CCoinsMap::iterator it = mapCoins.begin(); it != mapCoins.end(); it = erase ? mapCoins.erase(it) : std::next(it)) {\n-            if (it->second.flags & CCoinsCacheEntry::DIRTY) {\n+        for (auto it{pairs}; it != nullptr; it = it->second.Next(will_erase || !it->second.coin.IsSpent())) {\n+            if (it->second.GetFlags() & CCoinsCacheEntry::DIRTY) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659205863",
      "id" : 1659205863,
      "in_reply_to_id" : 1659005029,
      "line" : 61,
      "node_id" : "PRRC_kwDOABII585i5Xjn",
      "original_commit_id" : "a6324db9c6ae1b71b9687923a516a8adc01b7e1a",
      "original_line" : 61,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/test/coins_tests.cpp",
      "position" : 10,
      "pull_request_review_id" : 2148780756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659205863/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T19:12:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659205863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659223824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659223824"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What prohibits us from accessing the previous ones in constant time during iteration (I haven't had the energy to delve into it properly yet)?",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T19:25:58Z",
      "diff_hunk" : "@@ -103,8 +106,31 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    /**\n+     * These are used to create a doubly linked list of flagged entries.\n+     * They are set in AddFlags and unset in ClearFlags.\n+     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     *\n+     * DIRTY entries are tracked so that only modified entries can be passed to\n+     * the parent cache to do a batch write. This is a performance optimization\n+     * compared to giving all entries in the cache to the parent and having the\n+     * parent scan for only modified entries.\n+     *\n+     * FRESH entries are tracked because a FRESH-but-not-DIRTY entry can only be\n+     * a spent coin that exists in the parent cache. When performing a batch\n+     * write but not clearing the cache (CCoinsViewCache::Sync), we must also\n+     * erase all spent entries. Since only DIRTY or FRESH entries can be spent,\n+     * we can track them in the linked list to erase them. This is a performance\n+     * optimization compared to scanning all cache entries to find any that are\n+     * spent-but-not-DIRTY.\n+     */\n+    CoinsCachePair* m_prev{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659223824",
      "id" : 1659223824,
      "in_reply_to_id" : 1659023545,
      "line" : 128,
      "node_id" : "PRRC_kwDOABII585i5b8Q",
      "original_commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "original_line" : 128,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 33,
      "pull_request_review_id" : 2148810822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659223824/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T19:25:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659223824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659225286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659225286"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can you find a way to separate the side-effects? I find this very confusing.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T19:27:13Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list\n+        ClearFlags();\n+    }\n+\n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the head of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)\n+    {\n+        if (flags == 0) return;\n+        if (m_flags != 0) {\n+            m_flags |= flags;\n+            return;\n+        }\n+        m_prev = &head;\n+        m_next = head.second.m_next;\n+        head.second.m_next = &self;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = &self;\n+        }\n+        m_flags = flags;\n+    }\n+\n+    inline void ClearFlags()\n+    {\n+        if (m_flags == 0) return;\n+        m_prev->second.m_next = m_next;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = m_prev;\n+        }\n+        m_prev = nullptr;\n+        m_next = nullptr;\n+        m_flags = 0;\n+    }\n+\n+    inline uint8_t GetFlags() const { return m_flags; }\n+\n+    //! Get the next entry in the flagged linked list, optionally removing the\n+    //! current entry and clearing the flags.\n+    inline CoinsCachePair* Next(bool clear_flags = false)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659225286",
      "id" : 1659225286,
      "in_reply_to_id" : 1658694832,
      "line" : 200,
      "node_id" : "PRRC_kwDOABII585i5cTG",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 202,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 94,
      "pull_request_review_id" : 2148812718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659225286/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T19:27:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659225286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659225694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659225694"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Got it, thanks",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T19:27:32Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list\n+        ClearFlags();\n+    }\n+\n+    //! Adding a flag also requires a self reference to the pair that contains\n+    //! this entry in the CCoinsCache map and a reference to the head of the\n+    //! flagged pair linked list.\n+    inline void AddFlags(uint8_t flags, CoinsCachePair& self, CoinsCachePair& head)\n+    {\n+        if (flags == 0) return;\n+        if (m_flags != 0) {\n+            m_flags |= flags;\n+            return;\n+        }\n+        m_prev = &head;\n+        m_next = head.second.m_next;\n+        head.second.m_next = &self;\n+        if (m_next != nullptr) {\n+            m_next->second.m_prev = &self;\n+        }\n+        m_flags = flags;\n+    }\n+\n+    inline void ClearFlags()\n+    {\n+        if (m_flags == 0) return;\n+        m_prev->second.m_next = m_next;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659225694",
      "id" : 1659225694,
      "in_reply_to_id" : 1658399777,
      "line" : 187,
      "node_id" : "PRRC_kwDOABII585i5cZe",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 189,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 81,
      "pull_request_review_id" : 2148813234,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659225694/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T19:27:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659225694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659275459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659275459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> What prohibits us from accessing the previous ones in constant time during iteration\r\n\r\nNothing during iteration. But we need to delete entries randomly when a FRESH coin is spent, which is not during any iteration.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T20:16:21Z",
      "diff_hunk" : "@@ -103,8 +106,31 @@ class Coin\n  */\n struct CCoinsCacheEntry\n {\n+private:\n+    /**\n+     * These are used to create a doubly linked list of flagged entries.\n+     * They are set in AddFlags and unset in ClearFlags.\n+     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     *\n+     * DIRTY entries are tracked so that only modified entries can be passed to\n+     * the parent cache to do a batch write. This is a performance optimization\n+     * compared to giving all entries in the cache to the parent and having the\n+     * parent scan for only modified entries.\n+     *\n+     * FRESH entries are tracked because a FRESH-but-not-DIRTY entry can only be\n+     * a spent coin that exists in the parent cache. When performing a batch\n+     * write but not clearing the cache (CCoinsViewCache::Sync), we must also\n+     * erase all spent entries. Since only DIRTY or FRESH entries can be spent,\n+     * we can track them in the linked list to erase them. This is a performance\n+     * optimization compared to scanning all cache entries to find any that are\n+     * spent-but-not-DIRTY.\n+     */\n+    CoinsCachePair* m_prev{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659275459",
      "id" : 1659275459,
      "in_reply_to_id" : 1659023545,
      "line" : 128,
      "node_id" : "PRRC_kwDOABII585i5ojD",
      "original_commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "original_line" : 128,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/coins.h",
      "position" : 33,
      "pull_request_review_id" : 2148897653,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659275459/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T20:16:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659275459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659299969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659299969"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this really obvious though that we need to clear flags before destruction? Normally flags wouldn't affect destroying an object, but in this case they also tie the object to a linked list.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T20:39:47Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659299969",
      "id" : 1659299969,
      "in_reply_to_id" : 1658394351,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585i5uiB",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 163,
      "original_position" : 48,
      "original_start_line" : 162,
      "path" : "src/coins.h",
      "position" : 55,
      "pull_request_review_id" : 2148940116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659299969/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 160,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-28T20:39:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659299969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659304288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659304288"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, but it's in a destructor, calling the `ClearFlags` method - I didn't seen what the comment added beyond what the code already explained well.\r\nIt could explain why you chose this style, or what alternatives you've considered, or something else that the code cannot, but this just seemed redundant to me.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T20:44:25Z",
      "diff_hunk" : "@@ -130,6 +157,56 @@ struct CCoinsCacheEntry\n     CCoinsCacheEntry() : flags(0) {}\n     explicit CCoinsCacheEntry(Coin&& coin_) : coin(std::move(coin_)), flags(0) {}\n     CCoinsCacheEntry(Coin&& coin_, unsigned char flag) : coin(std::move(coin_)), flags(flag) {}\n+    ~CCoinsCacheEntry()\n+    {\n+        // We must always clear the flags when destroying this to remove it from\n+        // the flagged linked list",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659304288",
      "id" : 1659304288,
      "in_reply_to_id" : 1658394351,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585i5vlg",
      "original_commit_id" : "0a2bc92b0c642ae72a10f687e0758c59c8ffd79c",
      "original_line" : 163,
      "original_position" : 48,
      "original_start_line" : 162,
      "path" : "src/coins.h",
      "position" : 55,
      "pull_request_review_id" : 2148947454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659304288/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 160,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2024-06-28T20:45:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659304288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659308223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659308223"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry, can you elaborate on what benefit that would have here, and any possible downsides? I'm not 100% sure what all the differences are between the two methods, so preferred to stick to status quo.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T20:48:40Z",
      "diff_hunk" : "@@ -108,10 +108,13 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n \n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n-    cacheCoins.emplace(\n+    auto [it, inserted] = cacheCoins.emplace(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659308223",
      "id" : 1659308223,
      "in_reply_to_id" : 1652853326,
      "line" : 111,
      "node_id" : "PRRC_kwDOABII585i5wi_",
      "original_commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "original_line" : 111,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 45,
      "pull_request_review_id" : 2148954909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659308223/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T20:48:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659308223",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659322903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659322903"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In that case stick to it and I'll add it in a separate PR once this is merged!",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-28T21:01:26Z",
      "diff_hunk" : "@@ -108,10 +108,13 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n \n void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n     cachedCoinsUsage += coin.DynamicMemoryUsage();\n-    cacheCoins.emplace(\n+    auto [it, inserted] = cacheCoins.emplace(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659322903",
      "id" : 1659322903,
      "in_reply_to_id" : 1652853326,
      "line" : 111,
      "node_id" : "PRRC_kwDOABII585i50IX",
      "original_commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "original_line" : 111,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/coins.cpp",
      "position" : 45,
      "pull_request_review_id" : 2148980544,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659322903/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-28T21:01:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659322903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1841944?v=4",
         "events_url" : "https://api.github.com/users/paplorinc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paplorinc/followers",
         "following_url" : "https://api.github.com/users/paplorinc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paplorinc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paplorinc",
         "id" : 1841944,
         "login" : "paplorinc",
         "node_id" : "MDQ6VXNlcjE4NDE5NDQ=",
         "organizations_url" : "https://api.github.com/users/paplorinc/orgs",
         "received_events_url" : "https://api.github.com/users/paplorinc/received_events",
         "repos_url" : "https://api.github.com/users/paplorinc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paplorinc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paplorinc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paplorinc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659831027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659831027"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There's no accessor to `m_prev` though. This is checked below in the random deletion test.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-29T13:57:27Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <list>\n+\n+BOOST_AUTO_TEST_SUITE(coinscachepair_tests)\n+\n+static constexpr auto NUM_NODES{4};\n+\n+std::list<CoinsCachePair> CreatePairs(CoinsCachePair& head)\n+{\n+    std::list<CoinsCachePair> nodes;\n+    for (auto i{0}; i < NUM_NODES; ++i) {\n+        nodes.emplace_front();\n+\n+        auto node{nodes.begin()};\n+        node->second.AddFlags(CCoinsCacheEntry::DIRTY, *node, head);\n+\n+        BOOST_CHECK_EQUAL(node->second.GetFlags(), CCoinsCacheEntry::DIRTY);\n+        BOOST_CHECK_EQUAL(head.second.Next(), &(*node));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659831027",
      "id" : 1659831027,
      "in_reply_to_id" : 1658828407,
      "line" : 25,
      "node_id" : "PRRC_kwDOABII585i7wLz",
      "original_commit_id" : "6508bdfe437100a10be3730cefdb26efa5b5ad37",
      "original_line" : 25,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/test/coinscachepair_tests.cpp",
      "position" : 25,
      "pull_request_review_id" : 2149631400,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659831027/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-29T13:57:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659831027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659831168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659831168"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm well the `AddFlags` function is in production code, so this is constructing the linked list via production code. The `std::list` we create is a test harness helper that we use to check that our linked list behaves the same.",
      "commit_id" : "6ed20408df85ed31cfb0ca7bc8da7b8140e1ef2f",
      "created_at" : "2024-06-29T13:58:44Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <list>\n+\n+BOOST_AUTO_TEST_SUITE(coinscachepair_tests)\n+\n+static constexpr auto NUM_NODES{4};\n+\n+std::list<CoinsCachePair> CreatePairs(CoinsCachePair& head)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28280#discussion_r1659831168",
      "id" : 1659831168,
      "in_reply_to_id" : 1658780016,
      "line" : 15,
      "node_id" : "PRRC_kwDOABII585i7wOA",
      "original_commit_id" : "6508bdfe437100a10be3730cefdb26efa5b5ad37",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/test/coinscachepair_tests.cpp",
      "position" : 15,
      "pull_request_review_id" : 2149633735,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28280",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659831168/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-29T13:58:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1659831168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   }
]
