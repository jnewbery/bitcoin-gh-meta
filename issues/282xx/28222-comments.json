[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/28222#pullrequestreview-1565029167) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28196](https://github.com/bitcoin/bitcoin/pull/28196) (BIP324 connection support by sipa)\n* [#28170](https://github.com/bitcoin/bitcoin/pull/28170) (p2p: adaptive connections services flags by furszy)\n* [#28165](https://github.com/bitcoin/bitcoin/pull/28165) (net: transport abstraction by sipa)\n* [#28155](https://github.com/bitcoin/bitcoin/pull/28155) (Improves addnode / m_added_nodes logic by sr-gi)\n* [#28016](https://github.com/bitcoin/bitcoin/pull/28016) (p2p: gives seednode priority over dnsseed if both are provided by sr-gi)\n* [#27981](https://github.com/bitcoin/bitcoin/pull/27981) (Fix potential network stalling bug by sipa)\n* [#27912](https://github.com/bitcoin/bitcoin/pull/27912) (net: disconnect inside AttemptToEvictConnection by willcl-ark)\n* [#27837](https://github.com/bitcoin/bitcoin/pull/27837) (net: introduce block tracker to retry to download blocks after failure by furszy)\n* [#27600](https://github.com/bitcoin/bitcoin/pull/27600) (net: Add new permission `forceinbound` to evict a random unprotected connection if all slots are otherwise full by pinheadmz)\n* [#27509](https://github.com/bitcoin/bitcoin/pull/27509) (Relay own transactions only via short-lived Tor or I2P connections by vasild)\n* [#27407](https://github.com/bitcoin/bitcoin/pull/27407) (net, refactor: Privatise CNode send queue by dergoegge)\n* [#27213](https://github.com/bitcoin/bitcoin/pull/27213) (p2p: Diversify automatic outbound connections with respect to networks by amitiuttarwar)\n* [#27114](https://github.com/bitcoin/bitcoin/pull/27114) (p2p: Allow whitelisting outgoing connections by brunoerg)\n* [#26938](https://github.com/bitcoin/bitcoin/pull/26938) ([WIP] p2p: asmap, avoid inbound connections from a specific AS by brunoerg)\n* [#26621](https://github.com/bitcoin/bitcoin/pull/26621) (refactor: Continue moving application data from CNode to Peer by dergoegge)\n* [#25572](https://github.com/bitcoin/bitcoin/pull/25572) (refactor: Introduce EvictionManager and use it for the inbound eviction logic by dergoegge)\n* [#25268](https://github.com/bitcoin/bitcoin/pull/25268) (refactor: Introduce EvictionManager by dergoegge)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-08-05T09:45:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#issuecomment-1666456560",
      "id" : 1666456560,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28222",
      "node_id" : "IC_kwDOABII585jVBvw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1666456560/reactions"
      },
      "updated_at" : "2023-08-07T12:00:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1666456560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Also see #10738",
      "created_at" : "2023-08-05T13:35:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#issuecomment-1666508138",
      "id" : 1666508138,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28222",
      "node_id" : "IC_kwDOABII585jVOVq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1666508138/reactions"
      },
      "updated_at" : "2023-08-05T13:35:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1666508138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Also see #10738\r\n\r\nThanks, I hadn't seen this one before. Will take a look tonight\r\n\r\nEdit: Really like the last commit. Will see if I can also drop a few locks too..",
      "created_at" : "2023-08-05T14:14:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#issuecomment-1666517688",
      "id" : 1666517688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28222",
      "node_id" : "IC_kwDOABII585jVQq4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1666517688/reactions"
      },
      "updated_at" : "2023-08-05T20:52:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1666517688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-08-06T17:46:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#issuecomment-1666931527",
      "id" : 1666931527,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28222",
      "node_id" : "IC_kwDOABII585jW1tH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1666931527/reactions"
      },
      "updated_at" : "2023-08-06T17:46:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1666931527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Also see #10738\r\n\r\n:+1: \r\n\r\nI guess it must be possible to do that without \"reinventing the wheel aka introducing custom smart pointer types\", like mentioned in the last comment.",
      "created_at" : "2023-08-07T06:42:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#issuecomment-1667275661",
      "id" : 1667275661,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28222",
      "node_id" : "IC_kwDOABII585jYJuN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1667275661/reactions"
      },
      "updated_at" : "2023-08-07T06:42:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1667275661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1285681548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285681548"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there a reason why we need to use the shared_ptr type in net processing?",
      "commit_id" : "095482204591c9a2d149dd4e00dbb77d94e0b017",
      "created_at" : "2023-08-07T10:24:54Z",
      "diff_hunk" : "@@ -502,7 +502,7 @@ class PeerManagerImpl final : public PeerManager\n \n     /** Implement NetEventsInterface */\n     void InitializeNode(CNode& node, ServiceFlags our_services) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n-    void FinalizeNode(const CNode& node) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex, !m_headers_presync_mutex);\n+    void FinalizeNode(const CNodeRef node) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex, !m_headers_presync_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1285681548",
      "id" : 1285681548,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MofGM",
      "original_commit_id" : "499f267050d076a9065342c58338d5f2da791053",
      "original_line" : 505,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1565029167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285681548/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-07T12:00:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285681548",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1285682361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285682361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(I know this will get push back but)\r\n\r\nnit: Could we call this `ConnectionRef`? After all the connection manager is managing... connections.",
      "commit_id" : "095482204591c9a2d149dd4e00dbb77d94e0b017",
      "created_at" : "2023-08-07T10:25:46Z",
      "diff_hunk" : "@@ -651,6 +633,8 @@ class CNode\n     std::unique_ptr<i2p::sam::Session> m_i2p_sam_session GUARDED_BY(m_sock_mutex);\n };\n \n+typedef std::shared_ptr<CNode> CNodeRef;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1285682361",
      "id" : 1285682361,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585MofS5",
      "original_commit_id" : "499f267050d076a9065342c58338d5f2da791053",
      "original_line" : 636,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1565029167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 1,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285682361/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-07T12:00:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285682361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1285683763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285683763"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It would also seem more modern to use `using` here",
      "commit_id" : "095482204591c9a2d149dd4e00dbb77d94e0b017",
      "created_at" : "2023-08-07T10:27:16Z",
      "diff_hunk" : "@@ -651,6 +633,8 @@ class CNode\n     std::unique_ptr<i2p::sam::Session> m_i2p_sam_session GUARDED_BY(m_sock_mutex);\n };\n \n+typedef std::shared_ptr<CNode> CNodeRef;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1285683763",
      "id" : 1285683763,
      "in_reply_to_id" : 1285682361,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Mofoz",
      "original_commit_id" : "499f267050d076a9065342c58338d5f2da791053",
      "original_line" : 636,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1565029167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285683763/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-07T12:00:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285683763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1285689978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285689978"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In a way this is worse than the custom ref counting because it is harder to assert that we actually don't take new references after this check.",
      "commit_id" : "095482204591c9a2d149dd4e00dbb77d94e0b017",
      "created_at" : "2023-08-07T10:33:50Z",
      "diff_hunk" : "@@ -1138,23 +1135,23 @@ void CConnman::DisconnectNodes()\n                 // close socket and cleanup\n                 pnode->CloseSocketDisconnect();\n \n-                // hold in disconnected pool until all refs are released\n-                pnode->Release();\n+                // move to m_nodes_disconnected until all refs are released\n                 m_nodes_disconnected.push_back(pnode);\n             }\n         }\n     }\n     {\n         // Delete disconnected nodes\n-        std::list<CNode*> nodes_disconnected_copy = m_nodes_disconnected;\n-        for (CNode* pnode : nodes_disconnected_copy)\n-        {\n-            // Destroy the object only after other threads have stopped using it.\n-            if (pnode->GetRefCount() <= 0) {\n-                m_nodes_disconnected.remove(pnode);\n-                DeleteNode(pnode);\n+        std::vector<CNodeRef> disconnected_still_in_use;\n+        for (auto& pnode : m_nodes_disconnected) {\n+            // Finalize when we have the final reference inside this block\n+            if (pnode.use_count() == 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1285689978",
      "id" : 1285689978,
      "line" : 1148,
      "node_id" : "PRRC_kwDOABII585MohJ6",
      "original_commit_id" : "499f267050d076a9065342c58338d5f2da791053",
      "original_line" : 1148,
      "original_position" : 239,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 274,
      "pull_request_review_id" : 1565029167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285689978/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-07T12:00:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1285689978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cc @theuni (just in case you are interested in chiming in)",
      "created_at" : "2023-08-07T12:01:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#issuecomment-1667726251",
      "id" : 1667726251,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28222",
      "node_id" : "IC_kwDOABII585jZ3ur",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1667726251/reactions"
      },
      "updated_at" : "2023-08-07T12:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1667726251",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the conceptual review @dergoegge.\r\n\r\nI've forced push a relatively different approach here, trying to take into consideration your review points, and #10738, but trying not to require introducing the decaying pointers. This has resulted in the following conceptual changes:\r\n\r\n1. Taking the idea of @theuni's `GetnodesCopy()` in `m_nodes` iterations by re-purposing and upgrading `NodesSnapshot()` a bit, allowing removal of many instances of `m_nodes_mutex` in the code, as he achieved.\r\n2. Made `CNode` a friend of `CConnman`. This allows us to call back to `DeleteNode()` automagically ðª  on CNode destruction when the final reference is dropped. Then we can just worry about dropping all references, which seems easier to reason about for me. I think it might be possible to modify `DeleteNode()` further to assert no `shared_ptr`s remain for it --ensuring that nobody can accidently re-introduce unsafe deletion in the codebase in the future --, but I haven't looked at this yet.\r\n\r\n> In a way this is worse than the custom ref counting because it is harder to assert that we actually don't take new references after this check.\r\n\r\n3. I re-worked this part of `DisconnectNodes()` in general, but IMO this is safe-enough to drop from `m_nodes_disconnected` outright, as the only users of `m_nodes_disconnected` are `StopNodes()` and `DisconnectNodes()`. To belt-and-suspenders this anyway, I added a final optional commit which adds an `m_nodes_disconnected_mutex` to ensure no new references can be created while we are dropping from `m_nodes_disconnected`.\r\n\r\nThe commits need tidying up, rewording etc. still, but otherwise would be curious to know if this new approach looked better to you? ",
      "created_at" : "2023-08-09T10:49:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#issuecomment-1671097648",
      "id" : 1671097648,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28222",
      "node_id" : "IC_kwDOABII585jmu0w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1671097648/reactions"
      },
      "updated_at" : "2023-08-09T10:49:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1671097648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1288400379"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288400379"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Having the managed objects have a reference to the manager leads to absolute spaghetti code, so leaning towards NACK on that.",
      "commit_id" : "095482204591c9a2d149dd4e00dbb77d94e0b017",
      "created_at" : "2023-08-09T12:23:25Z",
      "diff_hunk" : "@@ -665,8 +650,11 @@ class CNode\n      * Otherwise this unique_ptr is empty.\n      */\n     std::unique_ptr<i2p::sam::Session> m_i2p_sam_session GUARDED_BY(m_sock_mutex);\n+    CConnman* m_connman;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1288400379",
      "id" : 1288400379,
      "line" : 653,
      "node_id" : "PRRC_kwDOABII585My237",
      "original_commit_id" : "82dc400170414129aedf4b32870b2ade2a5cd71c",
      "original_line" : 653,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 63,
      "pull_request_review_id" : 1569429475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288400379/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-09T14:47:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288400379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1288527915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288527915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You can just get rid of NodesSnapshot entirely now, it was only needed as a RAII helper for the manual ref counting.",
      "commit_id" : "095482204591c9a2d149dd4e00dbb77d94e0b017",
      "created_at" : "2023-08-09T13:57:39Z",
      "diff_hunk" : "@@ -1219,43 +1206,48 @@ class CConnman\n     static constexpr size_t MAX_UNUSED_I2P_SESSIONS_SIZE{10};\n \n     /**\n-     * RAII helper to atomically create a copy of `m_nodes` and add a reference\n-     * to each of the nodes. The nodes are released when this object is destroyed.\n+     * RAII helper to atomically create a copy of `m_nodes` with shared pointers and manual reference counting.\n      */\n     class NodesSnapshot\n     {\n     public:\n-        explicit NodesSnapshot(const CConnman& connman, bool shuffle)\n+        explicit NodesSnapshot(const CConnman& connman, bool shuffle = false)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1288527915",
      "id" : 1288527915,
      "line" : 1214,
      "node_id" : "PRRC_kwDOABII585MzWAr",
      "original_commit_id" : "36c6fe59b21999c0ea904d310bcc794d0736628d",
      "original_line" : 1214,
      "original_position" : 175,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 175,
      "pull_request_review_id" : 1569429475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288527915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-09T14:47:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288527915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1314264417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314264417"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think this makes sense in general? If you have a shared_ptr, you should normally just pass the reference to the object (`CNode&`) if you've checked it's not null, or the pointer itself (`CNode*`).\r\n\r\ncf http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-smart",
      "commit_id" : "095482204591c9a2d149dd4e00dbb77d94e0b017",
      "created_at" : "2023-09-03T14:01:00Z",
      "diff_hunk" : "@@ -798,11 +798,11 @@ class CConnman\n     // alias for thread safety annotations only, not defined\n     RecursiveMutex& GetNodesMutex() const LOCK_RETURNED(m_nodes_mutex);\n \n-    bool ForNode(NodeId id, std::function<bool(CNode* pnode)> func);\n+    bool ForNode(NodeId id, std::function<bool(CNodeRef pnode)> func);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28222#discussion_r1314264417",
      "id" : 1314264417,
      "line" : 787,
      "node_id" : "PRRC_kwDOABII585OVhVh",
      "original_commit_id" : "1f612cded86dd8e0406d7c7feaef065bfbeb6f4b",
      "original_line" : 801,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 76,
      "pull_request_review_id" : 1608532082,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314264417/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-03T14:10:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1314264417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
