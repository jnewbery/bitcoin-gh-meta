[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Approach ACK | [stickies-v](https://github.com/bitcoin/bitcoin/pull/27909#pullrequestreview-1502978676) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.\n",
      "created_at" : "2023-06-17T15:14:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1595783239",
      "id" : 1595783239,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fHbhH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1595783239/reactions"
      },
      "updated_at" : "2023-06-28T12:39:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1595783239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cc @fjahr ",
      "created_at" : "2023-06-20T09:17:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1598417257",
      "id" : 1598417257,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fRelp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598417257/reactions"
      },
      "updated_at" : "2023-06-20T09:17:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598417257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Why I am not co-author?",
      "created_at" : "2023-06-20T18:11:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1599276924",
      "id" : 1599276924,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fUwd8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599276924/reactions"
      },
      "updated_at" : "2023-06-20T18:11:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599276924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Why I am not co-author?\r\n\r\nHappy to add you of course since you wrote it -- I couldn't find your email via `git log` to add it and I wasn't sure how to give credit w/o an email",
      "created_at" : "2023-06-20T18:16:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1599282966",
      "id" : 1599282966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fUx8W",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599282966/reactions"
      },
      "updated_at" : "2023-06-20T18:16:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599282966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'd suggest using @promag's commit authored by him (and then maybe/maybe not an additional commit if any substantive new changes).",
      "created_at" : "2023-06-20T18:17:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1599284029",
      "id" : 1599284029,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fUyM9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599284029/reactions"
      },
      "updated_at" : "2023-06-20T18:17:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599284029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Can you advise on how to do that? I can close this in favor of another and let somebody take it over with proper commit attribution. I opened this PR since it wasn't addressed for a month",
      "created_at" : "2023-06-20T18:20:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1599287285",
      "id" : 1599287285,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fUy_1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599287285/reactions"
      },
      "updated_at" : "2023-06-20T18:20:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599287285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`git log` for me has @promag's email as `JoÃ£o Barbosa <joao.paulo.barbosa@gmail.com>`\r\n\r\nWould be something like `git commit --amend --author=\"JoÃ£o Barbosa <joao.paulo.barbosa@gmail.com>\"`",
      "created_at" : "2023-06-20T18:21:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1599288580",
      "id" : 1599288580,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fUzUE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599288580/reactions"
      },
      "updated_at" : "2023-06-20T18:21:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599288580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "or git cherry-pick d41736beb",
      "created_at" : "2023-06-20T18:21:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1599289544",
      "id" : 1599289544,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fUzjI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599289544/reactions"
      },
      "updated_at" : "2023-06-20T18:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599289544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> git log for me has @promag's email as JoÃ£o Barbosa <joao.paulo.barbosa@gmail.com>\r\n\r\nI see, I grepped for `promag` instead of the name. Anyways, the commit attribution is fixed. Sorry about that @promag \r\n\r\n> or git cherry-pick https://github.com/bitcoin/bitcoin/commit/d41736beb0701242e2f7f6ba2f3bb0192126fbad\r\n\r\nI didn't do this because that commit only fixes it for certain libevent versions",
      "created_at" : "2023-06-20T18:26:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1599294916",
      "id" : 1599294916,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fU03E",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599294916/reactions"
      },
      "updated_at" : "2023-06-20T18:27:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599294916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Crypt-iQ No worries mate, thanks for picking this work!",
      "created_at" : "2023-06-20T18:51:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1599339257",
      "id" : 1599339257,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fU_r5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599339257/reactions"
      },
      "updated_at" : "2023-06-20T18:51:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599339257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1238858377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238858377"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This will never get called, I think you mean `||`?\r\n```suggestion\r\n        if (event_get_version_number() < 0x02010600 || event_get_version_number() >= 0x02020001) {\r\n```",
      "commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "created_at" : "2023-06-22T17:53:41Z",
      "diff_hunk" : "@@ -215,6 +215,30 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // The EV_READ enablement is off-set by the workaround for the libevent\n+        // bug further below. This is why it can only be used with libevent\n+        // versions that are not affected by the workaround code.\n+        if (event_get_version_number() < 0x02010600 && event_get_version_number() >= 0x02020001) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1238858377",
      "id" : 1238858377,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII585J13qJ",
      "original_commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "original_line" : 224,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 10,
      "pull_request_review_id" : 1493733432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238858377/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T18:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238858377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1238858604"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238858604"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The libevent bug was actually patched in [2.1.9](https://github.com/libevent/libevent/blob/release-2.1.9-beta/http.c#L3455) already, so I think we should update our version check to reflect that? Although it might warrant a separate PR to do so.",
      "commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "created_at" : "2023-06-22T17:53:56Z",
      "diff_hunk" : "@@ -215,6 +215,30 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // The EV_READ enablement is off-set by the workaround for the libevent\n+        // bug further below. This is why it can only be used with libevent\n+        // versions that are not affected by the workaround code.\n+        if (event_get_version_number() < 0x02010600 && event_get_version_number() >= 0x02020001) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1238858604",
      "id" : 1238858604,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII585J13ts",
      "original_commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "original_line" : 224,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 10,
      "pull_request_review_id" : 1493733432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238858604/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T18:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238858604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1238859568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238859568"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this safe to do? Unless I misunderstand, this effectively disables the bugfix introduced in https://github.com/libevent/libevent/commit/5ff8eb26371c4dc56f384b2de35bea2d87814779, which means that if we get new data in our inbound buffer this will put the connection in an invalid state. I'm not sure yet how that would get triggered in practice, so I'm just going off what I read so far as I can't reproduce the race condition reported in https://github.com/bitcoin/bitcoin/pull/11593.",
      "commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "created_at" : "2023-06-22T17:54:57Z",
      "diff_hunk" : "@@ -215,6 +215,30 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // The EV_READ enablement is off-set by the workaround for the libevent\n+        // bug further below. This is why it can only be used with libevent\n+        // versions that are not affected by the workaround code.\n+        if (event_get_version_number() < 0x02010600 && event_get_version_number() >= 0x02020001) {\n+            // Enable EV_READ to detect remote disconnection meaning that the close\n+            // callback set below is called.\n+            bufferevent* bev = evhttp_connection_get_bufferevent(conn);\n+            bufferevent_enable(bev, EV_READ);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1238859568",
      "id" : 1238859568,
      "line" : 228,
      "node_id" : "PRRC_kwDOABII585J138w",
      "original_commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "original_line" : 228,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 14,
      "pull_request_review_id" : 1493733432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238859568/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T18:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238859568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1238984406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238984406"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes that's right",
      "commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "created_at" : "2023-06-22T20:12:56Z",
      "diff_hunk" : "@@ -215,6 +215,30 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // The EV_READ enablement is off-set by the workaround for the libevent\n+        // bug further below. This is why it can only be used with libevent\n+        // versions that are not affected by the workaround code.\n+        if (event_get_version_number() < 0x02010600 && event_get_version_number() >= 0x02020001) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1238984406",
      "id" : 1238984406,
      "in_reply_to_id" : 1238858377,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII585J2WbW",
      "original_commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "original_line" : 224,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 10,
      "pull_request_review_id" : 1493927326,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238984406/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T20:12:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238984406",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1238987822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238987822"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I wasn't able to reproduce using this https://github.com/bitcoin/bitcoin/pull/11593#issuecomment-341489496 and since you pointed out that the change wasn't merged into 2.2, I think it's better to err on the side of caution and not enable reading",
      "commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "created_at" : "2023-06-22T20:16:22Z",
      "diff_hunk" : "@@ -215,6 +215,30 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // The EV_READ enablement is off-set by the workaround for the libevent\n+        // bug further below. This is why it can only be used with libevent\n+        // versions that are not affected by the workaround code.\n+        if (event_get_version_number() < 0x02010600 && event_get_version_number() >= 0x02020001) {\n+            // Enable EV_READ to detect remote disconnection meaning that the close\n+            // callback set below is called.\n+            bufferevent* bev = evhttp_connection_get_bufferevent(conn);\n+            bufferevent_enable(bev, EV_READ);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1238987822",
      "id" : 1238987822,
      "in_reply_to_id" : 1238859568,
      "line" : 228,
      "node_id" : "PRRC_kwDOABII585J2XQu",
      "original_commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "original_line" : 228,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 14,
      "pull_request_review_id" : 1493931883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238987822/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-22T20:16:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238987822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I opened this PR since it wasn't addressed for a month\r\n\r\nWhy didn't you ask me first if I am still working on this? A month isn't a long time in this project when you working on multiple things at the same time...\r\n\r\nTypically people leave a review comment in a situation like this instead of opening a new PR.",
      "created_at" : "2023-06-22T22:34:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1603395073",
      "id" : 1603395073,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fkd4B",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1603395073/reactions"
      },
      "updated_at" : "2023-06-22T22:36:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1603395073",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@Crypt-iQ There is no need to close this PR now since it got attention and review. I will close mine if you want to continue. But I wanted to clarify this for the future.",
      "created_at" : "2023-06-23T08:54:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1603955123",
      "id" : 1603955123,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fmmmz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1603955123/reactions"
      },
      "updated_at" : "2023-06-23T08:54:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1603955123",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok I reopened, it would be helpful if these things were made explicit (leave a comment) rather than implicit",
      "created_at" : "2023-06-23T08:59:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1603961615",
      "id" : 1603961615,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fmoMP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1603961615/reactions"
      },
      "updated_at" : "2023-06-23T08:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1603961615",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1240017063"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1240017063"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Opened a pull to correct this: https://github.com/bitcoin/bitcoin/pull/27949",
      "commit_id" : "710985d6953eb73b5edddaa7d4d54b58c90d1d34",
      "created_at" : "2023-06-23T16:28:42Z",
      "diff_hunk" : "@@ -215,6 +215,30 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // The EV_READ enablement is off-set by the workaround for the libevent\n+        // bug further below. This is why it can only be used with libevent\n+        // versions that are not affected by the workaround code.\n+        if (event_get_version_number() < 0x02010600 && event_get_version_number() >= 0x02020001) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1240017063",
      "id" : 1240017063,
      "in_reply_to_id" : 1238858604,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585J6Sin",
      "original_commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "original_line" : 224,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1495460298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1240017063/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-23T16:28:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1240017063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @Crypt-iQ There is no need to close this PR now since it got attention and review. I will close mine if you want to continue. But I wanted to clarify this for the future.\r\n\r\nI think you can reopen your PR to include the bufferevent read enable. I've updated this PR to include a minimal fix for the issue (without the bufferevent read enable) because I'm still a little unclear on what exactly the bug fix was originally for and I can't reproduce it. Also happy to close this PR in favor of yours since this is now missing the read enable.",
      "created_at" : "2023-06-23T17:56:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1604635264",
      "id" : 1604635264,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585fpMqA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1604635264/reactions"
      },
      "updated_at" : "2023-06-23T17:56:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1604635264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1240122246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1240122246"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've updated the PR and removed this",
      "commit_id" : "710985d6953eb73b5edddaa7d4d54b58c90d1d34",
      "created_at" : "2023-06-23T17:57:11Z",
      "diff_hunk" : "@@ -215,6 +215,30 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // The EV_READ enablement is off-set by the workaround for the libevent\n+        // bug further below. This is why it can only be used with libevent\n+        // versions that are not affected by the workaround code.\n+        if (event_get_version_number() < 0x02010600 && event_get_version_number() >= 0x02020001) {\n+            // Enable EV_READ to detect remote disconnection meaning that the close\n+            // callback set below is called.\n+            bufferevent* bev = evhttp_connection_get_bufferevent(conn);\n+            bufferevent_enable(bev, EV_READ);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1240122246",
      "id" : 1240122246,
      "in_reply_to_id" : 1238859568,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585J6sOG",
      "original_commit_id" : "1296038463670393fa22c0f06321686d691eee0d",
      "original_line" : 228,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1495624517,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1240122246/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-23T17:57:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1240122246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1245140984"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245140984"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit\r\n```suggestion\r\n        auto conn{evhttp_request_get_connection(req)};\r\n```",
      "commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "created_at" : "2023-06-28T12:33:28Z",
      "diff_hunk" : "@@ -215,6 +215,20 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1245140984",
      "id" : 1245140984,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KN1f4",
      "original_commit_id" : "710985d6953eb73b5edddaa7d4d54b58c90d1d34",
      "original_line" : 219,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1502978676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245140984/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-28T12:39:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245140984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1245141287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245141287"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit\r\n```suggestion\r\n            auto req{static_cast<evhttp_request*>(arg)};\r\n```",
      "commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "created_at" : "2023-06-28T12:33:43Z",
      "diff_hunk" : "@@ -215,6 +215,20 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // Close callback to clear active but running request. This is also\n+        // called if the connection is closed after a successful request, but\n+        // complete callback set below already cleared the state.\n+        evhttp_connection_set_closecb(conn, [](evhttp_connection* conn, void* arg) {\n+            auto req = static_cast<evhttp_request*>(arg);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1245141287",
      "id" : 1245141287,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KN1kn",
      "original_commit_id" : "710985d6953eb73b5edddaa7d4d54b58c90d1d34",
      "original_line" : 225,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1502978676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245141287/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-28T12:39:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245141287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1245143903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245143903"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm curious why we make `notify_all()` dependent on `g_requests.empty()` here, when in all other places we notify for all added and removed events?\r\n\r\n```suggestion\r\n            if (g_requests.erase(req)) g_requests_cv.notify_all();\r\n```",
      "commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "created_at" : "2023-06-28T12:36:13Z",
      "diff_hunk" : "@@ -215,6 +215,20 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // Close callback to clear active but running request. This is also\n+        // called if the connection is closed after a successful request, but\n+        // complete callback set below already cleared the state.\n+        evhttp_connection_set_closecb(conn, [](evhttp_connection* conn, void* arg) {\n+            auto req = static_cast<evhttp_request*>(arg);\n+            LOCK(g_requests_mutex);\n+            auto n{g_requests.erase(req)};\n+            if (n == 1 && g_requests.empty()) g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1245143903",
      "id" : 1245143903,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585KN2Nf",
      "original_commit_id" : "710985d6953eb73b5edddaa7d4d54b58c90d1d34",
      "original_line" : 228,
      "original_position" : 14,
      "original_start_line" : 227,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1502978676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245143903/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-28T12:39:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1245143903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1263162187"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1263162187"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think because the only call to `g_requests_cv.wait(...)` has a predicate that waits for `g_requests.empty()`. I've removed the dependency in the latest patch",
      "commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "created_at" : "2023-07-14T00:31:19Z",
      "diff_hunk" : "@@ -215,6 +215,20 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // Close callback to clear active but running request. This is also\n+        // called if the connection is closed after a successful request, but\n+        // complete callback set below already cleared the state.\n+        evhttp_connection_set_closecb(conn, [](evhttp_connection* conn, void* arg) {\n+            auto req = static_cast<evhttp_request*>(arg);\n+            LOCK(g_requests_mutex);\n+            auto n{g_requests.erase(req)};\n+            if (n == 1 && g_requests.empty()) g_requests_cv.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1263162187",
      "id" : 1263162187,
      "in_reply_to_id" : 1245143903,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LSlNL",
      "original_commit_id" : "710985d6953eb73b5edddaa7d4d54b58c90d1d34",
      "original_line" : 228,
      "original_position" : 14,
      "original_start_line" : 227,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1529402247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1263162187/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-07-14T00:31:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1263162187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've removed the `assert(n == 1)` in `evhttp_request_set_on_complete_cb` because of this comment: https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1611979215. It appears that both `evhttp_connection_set_closecb` and `evhttp_request_set_on_complete_cb` can run which causes a crash. I wasn't able to reproduce it and still want to know what exactly happened, but I think removing the assert here is certainly better than having a crash. ",
      "created_at" : "2023-07-14T00:33:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1635090604",
      "id" : 1635090604,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585hdYCs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1635090604/reactions"
      },
      "updated_at" : "2023-07-14T00:33:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1635090604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1263163161"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1263163161"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "created_at" : "2023-07-14T00:34:01Z",
      "diff_hunk" : "@@ -215,6 +215,20 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1263163161",
      "id" : 1263163161,
      "in_reply_to_id" : 1245140984,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LSlcZ",
      "original_commit_id" : "710985d6953eb73b5edddaa7d4d54b58c90d1d34",
      "original_line" : 219,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1529403592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1263163161/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-14T00:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1263163161",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1263163190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1263163190"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "created_at" : "2023-07-14T00:34:08Z",
      "diff_hunk" : "@@ -215,6 +215,20 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn = evhttp_request_get_connection(req);\n+\n+        // Close callback to clear active but running request. This is also\n+        // called if the connection is closed after a successful request, but\n+        // complete callback set below already cleared the state.\n+        evhttp_connection_set_closecb(conn, [](evhttp_connection* conn, void* arg) {\n+            auto req = static_cast<evhttp_request*>(arg);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1263163190",
      "id" : 1263163190,
      "in_reply_to_id" : 1245141287,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LSlc2",
      "original_commit_id" : "710985d6953eb73b5edddaa7d4d54b58c90d1d34",
      "original_line" : 225,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 1529403635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1263163190/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-14T00:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1263163190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I wasn't able to reproduce it and still want to know what exactly happened, but I think removing the assert here is certainly better than having a crash.\r\n\r\nI'm able to reproduce @dooglus's observed crash quite quickly (< 1 second usually) by blasting the server with requests from > 1 thread.\r\n\r\n<details>\r\n<summary>diff and script to make it crash</summary>\r\n\r\nOn top of d170e6c60cd9f46da1794448b8be55ba6f0b2922, first re-add the assertion:\r\n\r\n```diff\r\ndiff --git a/src/httpserver.cpp b/src/httpserver.cpp\r\nindex 849e9b482..5683e761f 100644\r\n--- a/src/httpserver.cpp\r\n+++ b/src/httpserver.cpp\r\n@@ -229,7 +229,8 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\r\n \r\n         // Clear state after successful request.\r\n         evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\r\n-            WITH_LOCK(g_requests_mutex, g_requests.erase(req));\r\n+            auto n{WITH_LOCK(g_requests_mutex, return g_requests.erase(req))};\r\n+            assert(n == 1);\r\n             g_requests_cv.notify_all();\r\n         }, nullptr);\r\n     }\r\n\r\n```\r\n\r\nI'm running on signet with `user:pass` credentials:\r\n\r\n```sh\r\n./src/bitcoind -signet -debug=http -rpcuser=user -rpcpassword=pass\r\n```\r\n\r\nAnd then finally the script to make it crash:\r\n```py\r\nimport http.client\r\nimport base64\r\nfrom concurrent.futures import ThreadPoolExecutor\r\n\r\nhost = \"localhost\"\r\nport = 38332\r\n\r\nauth_string = base64.b64encode('user:pass'.encode()).decode()\r\n\r\nnum_threads = 2\r\niterations_per_thread = 10000\r\n\r\ndef send_requests(i):\r\n    for _ in range(iterations_per_thread):\r\n        conn = http.client.HTTPConnection(host, port)\r\n        conn.request(\"POST\", \"/\")\r\n        response = conn.getresponse()\r\n\r\n        conn.close()\r\n\r\nwith ThreadPoolExecutor(max_workers=num_threads) as executor:\r\n    executor.map(send_requests, range(num_threads))\r\n```\r\n</details>\r\n\r\nI agree that keeping the assertion in as is is bad, but I don't like just removing it without properly understanding why this fails (or probably in other words, why/when the `evhttp_connection_set_closecb` cb is called before the `evhttp_request_set_on_complete_cb` cb) either, so I think we need to investigate first before proceeding?",
      "created_at" : "2023-07-14T15:56:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1636058567",
      "id" : 1636058567,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585hhEXH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1636058567/reactions"
      },
      "updated_at" : "2023-07-14T15:56:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1636058567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I am a complete libevent noob, but I noticed some odd behavior that makes me think this is a race condition. I used the following diff that logged both sides' port numbers and the above python script:\r\n\r\n<details>\r\n<summary>diff</summary>\r\n<br>\r\n\r\n```\r\ndiff --git a/src/httpserver.cpp b/src/httpserver.cpp\r\nindex 849e9b482..8bb9d407f 100644\r\n--- a/src/httpserver.cpp\r\n+++ b/src/httpserver.cpp\r\n@@ -223,13 +223,21 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\r\n         // complete callback set below already cleared the state.\r\n         evhttp_connection_set_closecb(conn, [](evhttp_connection* conn, void* arg) {\r\n             auto req{static_cast<evhttp_request*>(arg)};\r\n+\t    auto sockd = (struct sockaddr_in*)evhttp_connection_get_addr(conn);\r\n+\t    auto addr = sockd->sin_port;\r\n+\t    LogPrint(BCLog::HTTP, \"close callback remote port %d conn port %d\\n\", req->remote_port, addr);\r\n             WITH_LOCK(g_requests_mutex, g_requests.erase(req));\r\n             g_requests_cv.notify_all();\r\n         }, req);\r\n \r\n         // Clear state after successful request.\r\n         evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\r\n-            WITH_LOCK(g_requests_mutex, g_requests.erase(req));\r\n+\t    auto conn = req->evcon;\r\n+\t    auto sockd = (struct sockaddr_in*)evhttp_connection_get_addr(conn);\r\n+\t    auto addr = sockd->sin_port;\r\n+            LogPrint(BCLog::HTTP, \"complete callback remote port %d conn port %d\\n\", req->remote_port, addr);\r\n+\t    auto n{WITH_LOCK(g_requests_mutex, return g_requests.erase(req))};\r\n+\t    assert(n == 1);\r\n             g_requests_cv.notify_all();\r\n         }, nullptr);\r\n     }\r\n```\r\n\r\n</details>\r\n\r\nMost of the time (98-99%), I would see normal log lines where both ports were the same in the complete and close callbacks:\r\n\r\n```\r\n2023-07-16T22:25:46Z [http] Received a POST request for / from 127.0.0.1:44596\r\n2023-07-16T22:25:46Z [http] complete callback remote port 44596 conn port 13486\r\n2023-07-16T22:25:46Z [http] close callback remote port 44596 conn port 13486\r\n```\r\n\r\nHowever, every time the assert failure was hit, the port numbers were not the same for the complete/close callbacks. The port numbers were also re-used from another ongoing request. In the below snippet, the close callback for the request using remote port 44688 uses the local port 36526 which also matches the local port used in the complete callback for remote port 44686. Also, the complete callback for remote port 44688 has a local port 37038 instead of 36526.\r\n\r\n```\r\n2023-07-16T22:25:46Z [http] close callback remote port 44686 conn port 34990\r\n2023-07-16T22:25:46Z [http] Received a POST request for / from 127.0.0.1:44686\r\n2023-07-16T22:25:46Z [http] complete callback remote port 44686 conn port 36526\r\n2023-07-16T22:25:46Z [http] Received a POST request for / from 127.0.0.1:44688\r\n2023-07-16T22:25:46Z [http] close callback remote port 44688 conn port 36526\r\n2023-07-16T22:25:46Z [http] complete callback remote port 44688 conn port 37038\r\n<crash here>\r\n```",
      "created_at" : "2023-07-17T00:43:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1637239099",
      "id" : 1637239099,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585hlkk7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1637239099/reactions"
      },
      "updated_at" : "2023-07-17T00:43:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1637239099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I modified the diff above and printed out the `evhttp_request` memory address as well as the `req->output_buffer` memory address. I noticed that the`evhttp_request` address is re-used when there's a crash and the `output_buffer` address is not consistent between callbacks in the error case.\r\n\r\n<details>\r\n<summary>diff</summary>\r\n<br>\r\n\r\n```\r\ndiff --git a/src/httpserver.cpp b/src/httpserver.cpp\r\nindex 849e9b482..9fefad6bd 100644\r\n--- a/src/httpserver.cpp\r\n+++ b/src/httpserver.cpp\r\n@@ -211,6 +211,7 @@ std::string RequestMethodString(HTTPRequest::RequestMethod m)\r\n /** HTTP request callback */\r\n static void http_request_cb(struct evhttp_request* req, void* arg)\r\n {\r\n+    LogPrint(BCLog::HTTP, \"Received a request from %d req %p\\n\", req->remote_port, (void*)req);\r\n     // Track requests and notify when a request is completed.\r\n     {\r\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\r\n@@ -222,14 +223,22 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\r\n         // called if the connection is closed after a successful request, but\r\n         // complete callback set below already cleared the state.\r\n         evhttp_connection_set_closecb(conn, [](evhttp_connection* conn, void* arg) {\r\n-            auto req{static_cast<evhttp_request*>(arg)};\r\n+\t     auto req{static_cast<evhttp_request*>(arg)};\r\n+            auto sockd = (struct sockaddr_in*)evhttp_connection_get_addr(conn);\r\n+\t     auto addr = sockd->sin_port;\r\n+\t     LogPrint(BCLog::HTTP, \"set_closecb called for remote port %d conn port %d req %p output buffer %p\\n\", req->remote_port, addr, (void*)req, (void*)req->output_buffer);\r\n             WITH_LOCK(g_requests_mutex, g_requests.erase(req));\r\n             g_requests_cv.notify_all();\r\n         }, req);\r\n \r\n         // Clear state after successful request.\r\n         evhttp_request_set_on_complete_cb(req, [](struct evhttp_request* req, void*) {\r\n-            WITH_LOCK(g_requests_mutex, g_requests.erase(req));\r\n+\t     auto conn = req->evcon;\r\n+\t     auto sockd = (struct sockaddr_in*)evhttp_connection_get_addr(conn);\r\n+\t     auto addr = sockd->sin_port;\r\n+            LogPrint(BCLog::HTTP, \"set_on_complete_cb called for remote port %d conn port %d req %p output buffer %p\\n\", req->remote_port, addr, (void*)req, (void*)req->output_buffer);\r\n+            auto n{WITH_LOCK(g_requests_mutex, return g_requests.erase(req))};\r\n+            assert(n == 1);\r\n             g_requests_cv.notify_all();\r\n         }, nullptr);\r\n     }\r\n\r\n```\r\n</details>\r\n\r\nIn the following log snippet, the request from remote ports 56815 and 56816 use the same memory address `0x600000224000`. When the close callback is called, I would have expected an `output_buffer` address of `0x6000009301b0` rather than `0x6000009302d0`. Note that `g_requests` is a set of `evhttp_request*`.  So the first complete callback removes the request with address `0x600000224000`. Then a new request is received with the same address and is inserted into `g_requests`. Then the close callback runs (I'm not sure which request this close callback belongs to) and removes the entry with address `0x600000224000`. Then the last complete callback runs and the entry has already been deleted.\r\n\r\n```\r\n2023-07-17T11:50:09Z [http] Received a request from 56815 req 0x600000224000\r\n2023-07-17T11:50:09Z [http] Received a POST request for / from [::1]:56815\r\n2023-07-17T11:50:09Z [http] set_on_complete_cb called for remote port 56815 conn port 61405 req 0x600000224000 output buffer 0x6000009301b0\r\n2023-07-17T11:50:09Z [http] Received a request from 56816 req 0x600000224000\r\n2023-07-17T11:50:09Z [http] Received a POST request for / from [::1]:56816\r\n2023-07-17T11:50:09Z [http] set_closecb called for remote port 56816 conn port 61405 req 0x600000224000 output buffer 0x6000009302d0\r\n2023-07-17T11:50:09Z [http] set_on_complete_cb called for remote port 56816 conn port 61661 req 0x600000224000 output buffer 0x6000009302d0\r\nAssertion failed: (n == 1), function operator(), file httpserver.cpp, line 241.\r\nAbort trap: 6\r\n```",
      "created_at" : "2023-07-17T12:04:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1637992727",
      "id" : 1637992727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585hockX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1637992727/reactions"
      },
      "updated_at" : "2023-07-17T12:05:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1637992727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1265614783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265614783"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is the culprit of [what you're observing](https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1637992727). `req` becomes a dangling pointer as soon as a request is completed. In most cases (which is why we typically need > 1 number of iterations), this just means that `g_requests.erase(req)` removes 0 elements because it points to a non-existing request, but sometimes (and actually quite frequently as addresses seem to be reused quite aggressively) this will point to an unrelated request which has already been added into `g_requests`, erasing it unintentionally.\r\n\r\nThe underlying issue is that an `evhttp_connection` and an `evhttp_request` simply have different lifecycles, with connections living longer than requests. It seems that passing `req` as an argument to `evhttp_connection_set_closecb` is a fundamentally unsafe thing to do if we can't guarantee that `req` hasn't been completed by the time `closecb` is called (which in the happy path, we always expect it to be).",
      "commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "created_at" : "2023-07-17T16:30:04Z",
      "diff_hunk" : "@@ -215,9 +215,21 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn{evhttp_request_get_connection(req)};\n+\n+        // Close callback to clear active but running request. This is also\n+        // called if the connection is closed after a successful request, but\n+        // complete callback set below already cleared the state.\n+        evhttp_connection_set_closecb(conn, [](evhttp_connection* conn, void* arg) {\n+            auto req{static_cast<evhttp_request*>(arg)};\n+            WITH_LOCK(g_requests_mutex, g_requests.erase(req));\n+            g_requests_cv.notify_all();\n+        }, req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1265614783",
      "id" : 1265614783,
      "line" : 228,
      "node_id" : "PRRC_kwDOABII585Lb7-_",
      "original_commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "original_line" : 228,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 14,
      "pull_request_review_id" : 1533190394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265614783/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-17T17:00:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265614783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1268330073"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1268330073"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nice catch!",
      "commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "created_at" : "2023-07-19T16:35:48Z",
      "diff_hunk" : "@@ -215,9 +215,21 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn{evhttp_request_get_connection(req)};\n+\n+        // Close callback to clear active but running request. This is also\n+        // called if the connection is closed after a successful request, but\n+        // complete callback set below already cleared the state.\n+        evhttp_connection_set_closecb(conn, [](evhttp_connection* conn, void* arg) {\n+            auto req{static_cast<evhttp_request*>(arg)};\n+            WITH_LOCK(g_requests_mutex, g_requests.erase(req));\n+            g_requests_cv.notify_all();\n+        }, req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1268330073",
      "id" : 1268330073,
      "in_reply_to_id" : 1265614783,
      "line" : 228,
      "node_id" : "PRRC_kwDOABII585LmS5Z",
      "original_commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "original_line" : 228,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 14,
      "pull_request_review_id" : 1537504458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1268330073/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-19T16:35:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1268330073",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> This assumes that a connection can never have more than 1 request, and I'm not sure if that's the case.\r\n\r\nI'm also not sure. This PR body leads me to believe that it is possible to have more than 1 request per connection: https://github.com/libevent/libevent/pull/592#issue-292981989 , however I'm not sure whether it's possible for them to be interleaved and cause problems with your connection-based patch. Something I'll try to investigate.",
      "created_at" : "2023-07-19T16:39:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1642413131",
      "id" : 1642413131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585h5TxL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1642413131/reactions"
      },
      "updated_at" : "2023-07-19T16:39:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1642413131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It is possible for a connection to have more than one request (see: https://github.com/libevent/libevent/issues/1383#issuecomment-1383249281) or `evhttp_associate_new_request_with_connection` in the libevent code. It appears though that the requests are sequential so when one completes the next one can run. I modified the python script to test this, but it doesn't lead to a deadlock or crash because when the next request comes in, it uses the same `evhttp_connection*` and so the insert into `g_http_conns` is a no-op. The next request will also update the callback on the `evhttp_connection*` via `evhttp_connection_set_closecb` so that only one callback is run. When the connection is finally closed, it will find the connection & delete it. I think this means your patch works, but I'll continue to investigate a little more\r\n\r\n<details>\r\n<summary>python script</summary>\r\n<br>\r\n\r\n```python\r\nimport http.client\r\nimport base64\r\nfrom concurrent.futures import ThreadPoolExecutor\r\nimport time\r\n\r\nhost = \"localhost\"\r\nport = 18443\r\n\r\nauth_string = base64.b64encode('user:pass'.encode()).decode()\r\n\r\nnum_threads =  1\r\niterations_per_thread = 1\r\n\r\ndef send_requests(i):\r\n    for _ in range(iterations_per_thread):\r\n        conn = http.client.HTTPConnection(host, port)\r\n        conn.request(\"POST\", \"/\", headers={\"Keep-Alive\": \"timeout=500, max=1000\"})\r\n        \r\n        #response = conn.getresponse()\r\n        #conn.close()\r\n\r\n        time.sleep(3)\r\n\r\n        conn.request(\"POST\", \"/\", headers={\"Keep-Alive\": \"timeout=500, max=1000\"})\r\n\r\n        time.sleep(100)\r\n\r\nwith ThreadPoolExecutor(max_workers=num_threads) as executor:\r\n    executor.map(send_requests, range(num_threads))\r\n```\r\n</details>",
      "created_at" : "2023-07-21T14:14:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1645661021",
      "id" : 1645661021,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585iFstd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1645661021/reactions"
      },
      "updated_at" : "2023-07-21T14:14:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1645661021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I haven't been able to cause a crash with the connection-based code. Given that the connection-based code is different than the crashing code here, do you want to open a new PR with the connection-based code @stickies-v ?",
      "created_at" : "2023-08-04T02:03:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1664868727",
      "id" : 1664868727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585jO-F3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1664868727/reactions"
      },
      "updated_at" : "2023-08-04T02:03:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1664868727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "What is that status of this? cc @stickies-v.",
      "created_at" : "2023-09-15T09:12:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1720944089",
      "id" : 1720944089,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585mk4XZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1720944089/reactions"
      },
      "updated_at" : "2023-09-15T09:12:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1720944089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/libevent/libevent/issues/78 is relevant. Need to check how libevent was fixed to detect client close and make use of that in `bitcoind`.",
      "created_at" : "2023-09-19T08:12:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1725031052",
      "id" : 1725031052,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585m0eKM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1725031052/reactions"
      },
      "updated_at" : "2023-09-19T08:12:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1725031052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Need to check how libevent was fixed to detect client close and make use of that in `bitcoind`.\r\n\r\nAs far as I could find, it's not yet fixed but it's also largely orthogonal, see my comment [here](https://github.com/bitcoin/bitcoin/pull/27909#pullrequestreview-1493733432) and [this open libevent issue](https://github.com/libevent/libevent/issues/666). Detecting a remote disconnect would help save resources by not completing a request we'll no longer be serving, but isn't necessary to avoid the hangs on shutdown.",
      "created_at" : "2023-09-19T10:32:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#issuecomment-1725245876",
      "id" : 1725245876,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27909",
      "node_id" : "IC_kwDOABII585m1Sm0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1725245876/reactions"
      },
      "updated_at" : "2023-09-19T10:32:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1725245876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1329921718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329921718"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What about this:\r\n\r\n```cpp\r\nevhttp_connection_set_closecb(\r\n    evhttp_request_get_connection(req),\r\n    [](evhttp_connection* conn, void* arg) {\r\n        auto req{static_cast<evhttp_request*>(arg)};\r\n        // By the time the connection close callback is executed (this lambda)\r\n        // the request we scheduled to be passed as an argument (arg) may\r\n        // have been destroyed and a new, unrelated, one could have been\r\n        // created at the same address. So arg may be a stale pointer or\r\n        // a valid pointer, pointing to a new request object.\r\n        LOCK(g_requests_mutex);\r\n        if (g_requests.count(req) > 0 /* is not a stale pointer */\r\n            && evhttp_request_get_connection(req) == conn /* is not pointing to a new request */) {\r\n\r\n            g_requests.erase(req);\r\n            g_requests_cv.notify_all();\r\n        }\r\n    },\r\n    req);\r\n```",
      "commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "created_at" : "2023-09-19T10:40:32Z",
      "diff_hunk" : "@@ -215,9 +215,21 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn{evhttp_request_get_connection(req)};\n+\n+        // Close callback to clear active but running request. This is also\n+        // called if the connection is closed after a successful request, but\n+        // complete callback set below already cleared the state.\n+        evhttp_connection_set_closecb(conn, [](evhttp_connection* conn, void* arg) {\n+            auto req{static_cast<evhttp_request*>(arg)};\n+            WITH_LOCK(g_requests_mutex, g_requests.erase(req));\n+            g_requests_cv.notify_all();\n+        }, req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1329921718",
      "id" : 1329921718,
      "in_reply_to_id" : 1265614783,
      "line" : 228,
      "node_id" : "PRRC_kwDOABII585PRP62",
      "original_commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "original_line" : 228,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 14,
      "pull_request_review_id" : 1632953330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329921718/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-19T10:40:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1329921718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1330187013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330187013"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```\r\n            && evhttp_request_get_connection(req) == conn /* is not pointing to a new request */) {\r\n```\r\n\r\nI'm not sure this will be 100% robust when we have multiple requests in a connection, I think this can still lead to usage of stale pointers? But as we're closing the connection anyway, it may not be an issue.",
      "commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "created_at" : "2023-09-19T14:02:45Z",
      "diff_hunk" : "@@ -215,9 +215,21 @@ static void http_request_cb(struct evhttp_request* req, void* arg)\n     {\n         WITH_LOCK(g_requests_mutex, g_requests.insert(req));\n         g_requests_cv.notify_all();\n+\n+        auto conn{evhttp_request_get_connection(req)};\n+\n+        // Close callback to clear active but running request. This is also\n+        // called if the connection is closed after a successful request, but\n+        // complete callback set below already cleared the state.\n+        evhttp_connection_set_closecb(conn, [](evhttp_connection* conn, void* arg) {\n+            auto req{static_cast<evhttp_request*>(arg)};\n+            WITH_LOCK(g_requests_mutex, g_requests.erase(req));\n+            g_requests_cv.notify_all();\n+        }, req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27909#discussion_r1330187013",
      "id" : 1330187013,
      "in_reply_to_id" : 1265614783,
      "line" : 228,
      "node_id" : "PRRC_kwDOABII585PSQsF",
      "original_commit_id" : "d170e6c60cd9f46da1794448b8be55ba6f0b2922",
      "original_line" : 228,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 14,
      "pull_request_review_id" : 1633377488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27909",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330187013/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-19T14:02:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1330187013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   }
]
