[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/28542#pullrequestreview-1646856194) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-09-27T02:37:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28542#issuecomment-1736582717",
      "id" : 1736582717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28542",
      "node_id" : "IC_kwDOABII585ngiY9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1736582717/reactions"
      },
      "updated_at" : "2023-09-27T14:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1736582717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "From CI https://cirrus-ci.com/task/4777376270254080?logs=ci#L2730:\r\n\r\n```\r\n node0 2023-09-27T02:59:50.041782Z [http] [httpserver.cpp:255] [http_request_cb] [http] Received a POST request for / from 127.0.0.1:50492 \r\n node0 2023-09-27T02:59:50.041968Z [httpworker.0] [rpc/request.cpp:181] [parse] [rpc] ThreadRPCServer method=getbestblockhash user=__cookie__ \r\n node2 2023-09-27T02:59:50.042734Z [http] [httpserver.cpp:255] [http_request_cb] [http] Received a POST request for / from 127.0.0.1:37528 \r\n node2 2023-09-27T02:59:50.042872Z [httpworker.0] [rpc/request.cpp:181] [parse] [rpc] ThreadRPCServer method=getbestblockhash user=__cookie__ \r\n node0 2023-09-27T02:59:50.043575Z [http] [httpserver.cpp:255] [http_request_cb] [http] Received a POST request for / from 127.0.0.1:50492 \r\n node0 2023-09-27T02:59:50.043722Z [httpworker.2] [rpc/request.cpp:181] [parse] [rpc] ThreadRPCServer method=gettransaction user=__cookie__ \r\n node0 2023-09-27T02:59:50.045190Z [http] [httpserver.cpp:255] [http_request_cb] [http] Received a POST request for / from 127.0.0.1:50492 \r\n node0 2023-09-27T02:59:50.045301Z [httpworker.1] [rpc/request.cpp:181] [parse] [rpc] ThreadRPCServer method=gettransaction user=__cookie__ \r\n test  2023-09-27T02:59:50.047000Z TestFramework (ERROR): Assertion failed \r\n                                   Traceback (most recent call last):\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 131, in main\r\n                                       self.run_test()\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/wallet_reorgsrestore.py\", line 76, in run_test\r\n                                       assert_equal(conflicted[\"confirmations\"], -9)\r\n                                     File \"/ci_container_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/util.py\", line 57, in assert_equal\r\n                                       raise AssertionError(\"not(%s)\" % \" == \".join(str(arg) for arg in (thing1, thing2) + args))\r\n                                   AssertionError: not(-8 == -9)",
      "created_at" : "2023-09-27T06:14:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28542#issuecomment-1736765816",
      "id" : 1736765816,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28542",
      "node_id" : "IC_kwDOABII585nhPF4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1736765816/reactions"
      },
      "updated_at" : "2023-09-27T06:14:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1736765816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Can't reproduce the CI failure.",
      "created_at" : "2023-09-27T15:02:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28542#issuecomment-1737582529",
      "id" : 1737582529,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28542",
      "node_id" : "IC_kwDOABII585nkWfB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1737582529/reactions"
      },
      "updated_at" : "2023-09-27T15:02:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1737582529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Can't reproduce the CI failure.\r\n\r\n10 re-runs were scheduled. Let's see what happens.",
      "created_at" : "2023-09-27T15:09:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28542#issuecomment-1737595484",
      "id" : 1737595484,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28542",
      "node_id" : "IC_kwDOABII585nkZpc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1737595484/reactions"
      },
      "updated_at" : "2023-09-27T15:09:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1737595484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28542#discussion_r1338855810"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28542"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338855810"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do you know when `conflicting_height` can be negative? It looks like a different bug if that happens.\r\n\r\nAs far as I can see, we only set the `TxStateConflicted` state at `AddToWalletIfInvolvingMe`, where `confirmed_block_height` is always positive. In `LoadToWallet`, we take the conflicting height of the prev tx, so it should never be negative.",
      "commit_id" : "782701ce7d31919dba2241ee43b582d8ae5a2541",
      "created_at" : "2023-09-27T16:11:59Z",
      "diff_hunk" : "@@ -1339,11 +1339,14 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n {\n     LOCK(cs_wallet);\n \n-    int conflictconfirms = (m_last_block_processed_height - conflicting_height + 1) * -1;\n     // If number of conflict confirms cannot be determined, this means\n     // that the block is still unknown or not yet part of the main chain,\n     // for example when loading the wallet during a reindex. Do nothing in that\n     // case.\n+    if (m_last_block_processed_height < 0 || conflicting_height < 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28542#discussion_r1338855810",
      "id" : 1338855810,
      "line" : 1346,
      "node_id" : "PRRC_kwDOABII585PzVGC",
      "original_commit_id" : "782701ce7d31919dba2241ee43b582d8ae5a2541",
      "original_line" : 1346,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 9,
      "pull_request_review_id" : 1647100043,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28542",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338855810/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T16:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338855810",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28542#discussion_r1338934110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28542"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338934110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "When the `CWalletTx` is loaded, it only contains the hash of conflicting block. The height will be set to -1. `LoadToWallet` will try to lookup the block by hash, but if there is not chain available (as with the wallet tool and during migration), then it cannot do that. So the height will remain -1. If that transaction has a child, and that child is loaded after the parent is loaded, then `MarkConflicted` will be called using the parent's in-memory conflicted state. Since there was no chain, the `conflicting_height` that is passed to `MarkConflicted` is -1, hence triggering this error.",
      "commit_id" : "782701ce7d31919dba2241ee43b582d8ae5a2541",
      "created_at" : "2023-09-27T17:03:35Z",
      "diff_hunk" : "@@ -1339,11 +1339,14 @@ void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, c\n {\n     LOCK(cs_wallet);\n \n-    int conflictconfirms = (m_last_block_processed_height - conflicting_height + 1) * -1;\n     // If number of conflict confirms cannot be determined, this means\n     // that the block is still unknown or not yet part of the main chain,\n     // for example when loading the wallet during a reindex. Do nothing in that\n     // case.\n+    if (m_last_block_processed_height < 0 || conflicting_height < 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28542#discussion_r1338934110",
      "id" : 1338934110,
      "in_reply_to_id" : 1338855810,
      "line" : 1346,
      "node_id" : "PRRC_kwDOABII585PzoNe",
      "original_commit_id" : "782701ce7d31919dba2241ee43b582d8ae5a2541",
      "original_line" : 1346,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 9,
      "pull_request_review_id" : 1647192343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28542",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338934110/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-27T17:03:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1338934110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
