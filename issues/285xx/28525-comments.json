[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [naumenkogs](https://github.com/bitcoin/bitcoin/pull/28525#pullrequestreview-1643691130) |\n| Approach ACK | [ajtowns](https://github.com/bitcoin/bitcoin/pull/28525#issuecomment-1735129734) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-09-24T13:46:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28525#issuecomment-1732574160",
      "id" : 1732574160,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28525",
      "node_id" : "IC_kwDOABII585nRPvQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1732574160/reactions"
      },
      "updated_at" : "2023-09-26T09:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1732574160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1336842411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336842411"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">further packets are expected to use the empty string as AAD.\r\n\r\nthis part is irrelevant here?",
      "commit_id" : "f02fb7119eca6ee9744fa7c28291e6351650291a",
      "created_at" : "2023-09-26T08:38:08Z",
      "diff_hunk" : "@@ -1266,18 +1253,16 @@ bool V2Transport::ProcessReceivedPacketBytes() noexcept\n         // At this point we have a valid packet decrypted into m_recv_decode_buffer. Depending on\n         // the current state, decide what to do with it.\n         switch (m_recv_state) {\n-        case RecvState::GARBAUTH:\n-            // Ignore flag does not matter for garbage authentication. Any valid packet functions\n-            // as authentication. Receive and process the version packet next.\n-            SetReceiveState(RecvState::VERSION);\n-            ClearShrink(m_recv_garbage);\n-            break;\n         case RecvState::VERSION:\n             if (!ignore) {\n                 // Version message received; transition to application phase. The contents is\n                 // ignored, but can be used for future extensions.\n                 SetReceiveState(RecvState::APP);\n             }\n+            // We have decrypted one valid packet (which may or may not have been a decoy) with the\n+            // received garbage as AAD. We no longer need the received garbage and further packets",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1336842411",
      "id" : 1336842411,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Prpir",
      "original_commit_id" : "8753b6af9bf8767be50d71d1bf7e3711738fcfd2",
      "original_line" : 1263,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1643691130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336842411/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-26T08:48:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336842411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1336844877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336844877"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`non-decoy decoy`? Not sure if this is intentional, although i can see some sense in this... :)",
      "commit_id" : "f02fb7119eca6ee9744fa7c28291e6351650291a",
      "created_at" : "2023-09-26T08:39:55Z",
      "diff_hunk" : "@@ -485,24 +485,19 @@ class V2Transport final : public Transport\n         /** Garbage and garbage terminator.\n          *\n          * Whenever a byte is received, the last 16 bytes are compared with the expected garbage\n-         * terminator. When that happens, the state becomes GARBAUTH. If no matching terminator is\n+         * terminator. When that happens, the state becomes VERSION. If no matching terminator is\n          * received in 4111 bytes (4095 for the maximum garbage length, and 16 bytes for the\n          * terminator), the connection aborts. */\n         GARB_GARBTERM,\n \n-        /** Garbage authentication packet.\n-         *\n-         * A packet is received, and decrypted/verified with AAD set to the garbage received during\n-         * the GARB_GARBTERM state. If that succeeds, the state becomes VERSION. If it fails the\n-         * connection aborts. */\n-        GARBAUTH,\n-\n         /** Version packet.\n          *\n-         * A packet is received, and decrypted/verified. If that succeeds, the state becomes APP,\n-         * and the decrypted contents is interpreted as version negotiation (currently, that means\n-         * ignoring it, but it can be used for negotiating future extensions). If it fails, the\n-         * connection aborts. */\n+         * A packet is received, and decrypted/verified. The first received packet in this state\n+         * (whether it's a decoy or not) is expected to authenticate the garbage received during\n+         * the GARB_GARBTERM state as AAD. If decryption/verification (of the first non-decoy",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1336844877",
      "id" : 1336844877,
      "line" : 497,
      "node_id" : "PRRC_kwDOABII585PrqJN",
      "original_commit_id" : "8753b6af9bf8767be50d71d1bf7e3711738fcfd2",
      "original_line" : 497,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 40,
      "pull_request_review_id" : 1643691130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336844877/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-26T08:48:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336844877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1336851588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336851588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This description is confusing.\r\nCurrently, we will switch to APP no matter whether the authenticating package was decoy or version.\r\n\r\nIn future, `the state becomes APP, and the decrypted contents is interpreted as version negotiation`might not be the case, if the authenticating package was decoy.\r\n\r\nAt that point we might as well change this comment, but why having something certainly confusing in the first place?",
      "commit_id" : "f02fb7119eca6ee9744fa7c28291e6351650291a",
      "created_at" : "2023-09-26T08:44:59Z",
      "diff_hunk" : "@@ -485,24 +485,19 @@ class V2Transport final : public Transport\n         /** Garbage and garbage terminator.\n          *\n          * Whenever a byte is received, the last 16 bytes are compared with the expected garbage\n-         * terminator. When that happens, the state becomes GARBAUTH. If no matching terminator is\n+         * terminator. When that happens, the state becomes VERSION. If no matching terminator is\n          * received in 4111 bytes (4095 for the maximum garbage length, and 16 bytes for the\n          * terminator), the connection aborts. */\n         GARB_GARBTERM,\n \n-        /** Garbage authentication packet.\n-         *\n-         * A packet is received, and decrypted/verified with AAD set to the garbage received during\n-         * the GARB_GARBTERM state. If that succeeds, the state becomes VERSION. If it fails the\n-         * connection aborts. */\n-        GARBAUTH,\n-\n         /** Version packet.\n          *\n-         * A packet is received, and decrypted/verified. If that succeeds, the state becomes APP,\n-         * and the decrypted contents is interpreted as version negotiation (currently, that means\n-         * ignoring it, but it can be used for negotiating future extensions). If it fails, the\n-         * connection aborts. */\n+         * A packet is received, and decrypted/verified. The first received packet in this state\n+         * (whether it's a decoy or not) is expected to authenticate the garbage received during\n+         * the GARB_GARBTERM state as AAD. If decryption/verification (of the first non-decoy\n+         * decoy) succeeds, the state becomes APP, and the decrypted contents is interpreted as\n+         * version negotiation (currently, that means ignoring it, but it can be used for",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1336851588",
      "id" : 1336851588,
      "line" : 499,
      "node_id" : "PRRC_kwDOABII585PrryE",
      "original_commit_id" : "8753b6af9bf8767be50d71d1bf7e3711738fcfd2",
      "original_line" : 499,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 42,
      "pull_request_review_id" : 1643691130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336851588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-26T08:48:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1336851588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Approach ACK assuming BIP change is accepted",
      "created_at" : "2023-09-26T09:04:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28525#issuecomment-1735129734",
      "id" : 1735129734,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28525",
      "node_id" : "IC_kwDOABII585na_qG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1735129734/reactions"
      },
      "updated_at" : "2023-09-26T09:04:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1735129734",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1337026829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337026829"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh, I wanted to write \"first non-decoy **packet**\" here. Fixed.",
      "commit_id" : "f02fb7119eca6ee9744fa7c28291e6351650291a",
      "created_at" : "2023-09-26T10:58:59Z",
      "diff_hunk" : "@@ -485,24 +485,19 @@ class V2Transport final : public Transport\n         /** Garbage and garbage terminator.\n          *\n          * Whenever a byte is received, the last 16 bytes are compared with the expected garbage\n-         * terminator. When that happens, the state becomes GARBAUTH. If no matching terminator is\n+         * terminator. When that happens, the state becomes VERSION. If no matching terminator is\n          * received in 4111 bytes (4095 for the maximum garbage length, and 16 bytes for the\n          * terminator), the connection aborts. */\n         GARB_GARBTERM,\n \n-        /** Garbage authentication packet.\n-         *\n-         * A packet is received, and decrypted/verified with AAD set to the garbage received during\n-         * the GARB_GARBTERM state. If that succeeds, the state becomes VERSION. If it fails the\n-         * connection aborts. */\n-        GARBAUTH,\n-\n         /** Version packet.\n          *\n-         * A packet is received, and decrypted/verified. If that succeeds, the state becomes APP,\n-         * and the decrypted contents is interpreted as version negotiation (currently, that means\n-         * ignoring it, but it can be used for negotiating future extensions). If it fails, the\n-         * connection aborts. */\n+         * A packet is received, and decrypted/verified. The first received packet in this state\n+         * (whether it's a decoy or not) is expected to authenticate the garbage received during\n+         * the GARB_GARBTERM state as AAD. If decryption/verification (of the first non-decoy",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1337026829",
      "id" : 1337026829,
      "in_reply_to_id" : 1336844877,
      "line" : 497,
      "node_id" : "PRRC_kwDOABII585PsWkN",
      "original_commit_id" : "8753b6af9bf8767be50d71d1bf7e3711738fcfd2",
      "original_line" : 497,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 40,
      "pull_request_review_id" : 1643975973,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337026829/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-26T11:40:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337026829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1071625?v=4",
         "events_url" : "https://api.github.com/users/real-or-random/events{/privacy}",
         "followers_url" : "https://api.github.com/users/real-or-random/followers",
         "following_url" : "https://api.github.com/users/real-or-random/following{/other_user}",
         "gists_url" : "https://api.github.com/users/real-or-random/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/real-or-random",
         "id" : 1071625,
         "login" : "real-or-random",
         "node_id" : "MDQ6VXNlcjEwNzE2MjU=",
         "organizations_url" : "https://api.github.com/users/real-or-random/orgs",
         "received_events_url" : "https://api.github.com/users/real-or-random/received_events",
         "repos_url" : "https://api.github.com/users/real-or-random/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/real-or-random/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/real-or-random"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1337030584"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337030584"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> In future, `the state becomes APP, and the decrypted contents is interpreted as version negotiation` might not be the case, if the authenticating package was decoy.\r\n\r\n`the state becomes APP, and the decrypted contents is interpreted as version negotiation` *is* always the case. The first non-decoy packet received in VERSION state is the version packet, and that means that we interpret the contents as version info and switch to APP.\r\n\r\n> At that point we might as well change this comment, but why having something certainly confusing in the first place?\r\n\r\nI'm not sure what you're suggesting. Can you elaborate? (Maybe it's based on a misunderstanding that has been resolved now?)",
      "commit_id" : "f02fb7119eca6ee9744fa7c28291e6351650291a",
      "created_at" : "2023-09-26T11:02:32Z",
      "diff_hunk" : "@@ -485,24 +485,19 @@ class V2Transport final : public Transport\n         /** Garbage and garbage terminator.\n          *\n          * Whenever a byte is received, the last 16 bytes are compared with the expected garbage\n-         * terminator. When that happens, the state becomes GARBAUTH. If no matching terminator is\n+         * terminator. When that happens, the state becomes VERSION. If no matching terminator is\n          * received in 4111 bytes (4095 for the maximum garbage length, and 16 bytes for the\n          * terminator), the connection aborts. */\n         GARB_GARBTERM,\n \n-        /** Garbage authentication packet.\n-         *\n-         * A packet is received, and decrypted/verified with AAD set to the garbage received during\n-         * the GARB_GARBTERM state. If that succeeds, the state becomes VERSION. If it fails the\n-         * connection aborts. */\n-        GARBAUTH,\n-\n         /** Version packet.\n          *\n-         * A packet is received, and decrypted/verified. If that succeeds, the state becomes APP,\n-         * and the decrypted contents is interpreted as version negotiation (currently, that means\n-         * ignoring it, but it can be used for negotiating future extensions). If it fails, the\n-         * connection aborts. */\n+         * A packet is received, and decrypted/verified. The first received packet in this state\n+         * (whether it's a decoy or not) is expected to authenticate the garbage received during\n+         * the GARB_GARBTERM state as AAD. If decryption/verification (of the first non-decoy\n+         * decoy) succeeds, the state becomes APP, and the decrypted contents is interpreted as\n+         * version negotiation (currently, that means ignoring it, but it can be used for",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1337030584",
      "id" : 1337030584,
      "in_reply_to_id" : 1336851588,
      "line" : 499,
      "node_id" : "PRRC_kwDOABII585PsXe4",
      "original_commit_id" : "8753b6af9bf8767be50d71d1bf7e3711738fcfd2",
      "original_line" : 499,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 42,
      "pull_request_review_id" : 1643975973,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337030584/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-26T11:40:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337030584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1071625?v=4",
         "events_url" : "https://api.github.com/users/real-or-random/events{/privacy}",
         "followers_url" : "https://api.github.com/users/real-or-random/followers",
         "following_url" : "https://api.github.com/users/real-or-random/following{/other_user}",
         "gists_url" : "https://api.github.com/users/real-or-random/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/real-or-random",
         "id" : 1071625,
         "login" : "real-or-random",
         "node_id" : "MDQ6VXNlcjEwNzE2MjU=",
         "organizations_url" : "https://api.github.com/users/real-or-random/orgs",
         "received_events_url" : "https://api.github.com/users/real-or-random/received_events",
         "repos_url" : "https://api.github.com/users/real-or-random/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/real-or-random/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/real-or-random"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1337071855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337071855"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hah, it's not. We need to clear `m_recv_garbage` to make sure potential further packets in VERSION state don't except AAD. I agree that it's confusing. Added a commit to simply further. (Happy to squash if that's simpler.)",
      "commit_id" : "f02fb7119eca6ee9744fa7c28291e6351650291a",
      "created_at" : "2023-09-26T11:38:24Z",
      "diff_hunk" : "@@ -1266,18 +1253,16 @@ bool V2Transport::ProcessReceivedPacketBytes() noexcept\n         // At this point we have a valid packet decrypted into m_recv_decode_buffer. Depending on\n         // the current state, decide what to do with it.\n         switch (m_recv_state) {\n-        case RecvState::GARBAUTH:\n-            // Ignore flag does not matter for garbage authentication. Any valid packet functions\n-            // as authentication. Receive and process the version packet next.\n-            SetReceiveState(RecvState::VERSION);\n-            ClearShrink(m_recv_garbage);\n-            break;\n         case RecvState::VERSION:\n             if (!ignore) {\n                 // Version message received; transition to application phase. The contents is\n                 // ignored, but can be used for future extensions.\n                 SetReceiveState(RecvState::APP);\n             }\n+            // We have decrypted one valid packet (which may or may not have been a decoy) with the\n+            // received garbage as AAD. We no longer need the received garbage and further packets",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28525#discussion_r1337071855",
      "id" : 1337071855,
      "in_reply_to_id" : 1336842411,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Pshjv",
      "original_commit_id" : "8753b6af9bf8767be50d71d1bf7e3711738fcfd2",
      "original_line" : 1263,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1643975973,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28525",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337071855/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-09-26T11:40:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1337071855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1071625?v=4",
         "events_url" : "https://api.github.com/users/real-or-random/events{/privacy}",
         "followers_url" : "https://api.github.com/users/real-or-random/followers",
         "following_url" : "https://api.github.com/users/real-or-random/following{/other_user}",
         "gists_url" : "https://api.github.com/users/real-or-random/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/real-or-random",
         "id" : 1071625,
         "login" : "real-or-random",
         "node_id" : "MDQ6VXNlcjEwNzE2MjU=",
         "organizations_url" : "https://api.github.com/users/real-or-random/orgs",
         "received_events_url" : "https://api.github.com/users/real-or-random/received_events",
         "repos_url" : "https://api.github.com/users/real-or-random/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/real-or-random/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/real-or-random"
      }
   }
]
