[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [Sjors](https://github.com/bitcoin/bitcoin/pull/28361#issuecomment-1697111837) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-08-29T08:12:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28361#issuecomment-1696974106",
      "id" : 1696974106,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28361",
      "node_id" : "IC_kwDOABII585lJcUa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1696974106/reactions"
      },
      "updated_at" : "2023-08-29T09:45:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1696974106",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "~utACK bc5b39375a36f5b76ebd1d23faab0eea077f08ef~\r\n\r\nMaybe add `0x07` in a separate commit.\r\n\r\nThere's another behavior change here, probably a good one: while generating N keys, they're now completely different. Previously we would only change the last byte to make them unique.",
      "created_at" : "2023-08-29T09:45:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28361#issuecomment-1697111837",
      "id" : 1697111837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28361",
      "node_id" : "IC_kwDOABII585lJ98d",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697111837/reactions"
      },
      "updated_at" : "2023-08-29T09:52:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697111837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28361#discussion_r1308510940"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28361"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308510940"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe add a comment to this helper function that the resulting key is not necessarily valid. Or add a `const bool valid` argument which loops until `IsValid()` passes.",
      "commit_id" : "bc5b39375a36f5b76ebd1d23faab0eea077f08ef",
      "created_at" : "2023-08-29T09:47:37Z",
      "diff_hunk" : "@@ -14,6 +14,20 @@\n \n #include <memory>\n \n+CPubKey ConsumePubKey(FuzzedDataProvider& fuzzed_data_provider, const bool compressed) noexcept\n+{\n+    uint8_t pk_type;\n+    if (compressed) {\n+        pk_type = fuzzed_data_provider.PickValueInArray({0x02, 0x03});\n+    } else {\n+        pk_type = fuzzed_data_provider.PickValueInArray({0x04, 0x06, 0x07});\n+    }\n+    std::vector<uint8_t> pk_data = ConsumeFixedLengthByteVector(fuzzed_data_provider, pk_type >= 0x04 ? 65 : 33);\n+    pk_data[0] = pk_type;\n+    CPubKey pk{pk_data.begin(), pk_data.end()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28361#discussion_r1308510940",
      "id" : 1308510940,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII585N_krc",
      "original_commit_id" : "bc5b39375a36f5b76ebd1d23faab0eea077f08ef",
      "original_line" : 27,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/fuzz/util.cpp",
      "position" : 14,
      "pull_request_review_id" : 1599957866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28361",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308510940/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T09:47:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308510940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> There's another behavior change here, probably a good one: while generating N keys, they're now completely different. Previously we would only change the last byte to make them unique.\r\n\r\nNo, they are not guaranteed to. Now they will consume bytes for their whole length, which may exhaust the available bytes faster and thus result in all-zeros and also bloat the fuzz inputs git folder. Previously they consumed no additional bytes.\r\n\r\nNot sure why this is called a refactor, when everything is changed.",
      "created_at" : "2023-08-29T09:51:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28361#issuecomment-1697120506",
      "id" : 1697120506,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28361",
      "node_id" : "IC_kwDOABII585lKAD6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697120506/reactions"
      },
      "updated_at" : "2023-08-29T09:51:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697120506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Now they will consume bytes for their whole length, which may exhaust the available bytes faster and thus result in all-zeros and also bloat the fuzz inputs git folder\r\n\r\nAh, that's not good.",
      "created_at" : "2023-08-29T09:52:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28361#issuecomment-1697122922",
      "id" : 1697122922,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28361",
      "node_id" : "IC_kwDOABII585lKApq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697122922/reactions"
      },
      "updated_at" : "2023-08-29T09:52:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1697122922",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28361#discussion_r1308522629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28361"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308522629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Given @MarcoFalke's point about having to be frugal with consuming input bytes, maybe move this out of the loop and then have the loop tweak the public key. Like before it would start with one compressed and one uncompressed key. We'll still get diversity in `{0x04, 0x06, 0x07}` and `{0x02, 0x03}` combinations between multiple runs.",
      "commit_id" : "bc5b39375a36f5b76ebd1d23faab0eea077f08ef",
      "created_at" : "2023-08-29T09:57:24Z",
      "diff_hunk" : "@@ -103,16 +117,9 @@ CScript ConsumeScript(FuzzedDataProvider& fuzzed_data_provider, const bool maybe\n                     // navigate the highly structured multisig format.\n                     r_script << fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(0, 22);\n                     int num_data{fuzzed_data_provider.ConsumeIntegralInRange(1, 22)};\n-                    std::vector<uint8_t> pubkey_comp{buffer.begin(), buffer.begin() + CPubKey::COMPRESSED_SIZE};\n-                    pubkey_comp.front() = fuzzed_data_provider.ConsumeIntegralInRange(2, 3); // Set first byte for GetLen() to pass\n-                    std::vector<uint8_t> pubkey_uncomp{buffer.begin(), buffer.begin() + CPubKey::SIZE};\n-                    pubkey_uncomp.front() = fuzzed_data_provider.ConsumeIntegralInRange(4, 7); // Set first byte for GetLen() to pass\n                     while (num_data--) {\n-                        auto& pubkey{fuzzed_data_provider.ConsumeBool() ? pubkey_uncomp : pubkey_comp};\n-                        if (fuzzed_data_provider.ConsumeBool()) {\n-                            pubkey.back() = num_data; // Make each pubkey different\n-                        }\n-                        r_script << pubkey;\n+                        const auto pubkey = ConsumePubKey(fuzzed_data_provider, fuzzed_data_provider.ConsumeBool());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28361#discussion_r1308522629",
      "id" : 1308522629,
      "line" : 121,
      "node_id" : "PRRC_kwDOABII585N_niF",
      "original_commit_id" : "bc5b39375a36f5b76ebd1d23faab0eea077f08ef",
      "original_line" : 121,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/test/fuzz/util.cpp",
      "position" : 35,
      "pull_request_review_id" : 1599975508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28361",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308522629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T09:57:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308522629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28361#discussion_r1308730886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28361"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308730886"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> which loops until IsValid() passes\r\n\r\nI don't think it would be good in fuzzing.\r\n\r\nPerhaps something like:\r\n```diff\r\ndiff --git a/src/test/fuzz/util.cpp b/src/test/fuzz/util.cpp\r\nindex 1eb3583669..454e34f10f 100644\r\n--- a/src/test/fuzz/util.cpp\r\n+++ b/src/test/fuzz/util.cpp\r\n@@ -119,6 +119,7 @@ CScript ConsumeScript(FuzzedDataProvider& fuzzed_data_provider, const bool maybe\r\n                     int num_data{fuzzed_data_provider.ConsumeIntegralInRange(1, 22)};\r\n                     while (num_data--) {\r\n                         const auto pubkey = ConsumePubKey(fuzzed_data_provider, fuzzed_data_provider.ConsumeBool());\r\n+                        if (!pubkey.IsValid()) return;\r\n                         r_script << std::vector<uint8_t>(pubkey.data(), pubkey.data() + pubkey.size());\r\n                     }\r\n                     r_script << fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(0, 22);\r\n```",
      "commit_id" : "bc5b39375a36f5b76ebd1d23faab0eea077f08ef",
      "created_at" : "2023-08-29T12:19:31Z",
      "diff_hunk" : "@@ -14,6 +14,20 @@\n \n #include <memory>\n \n+CPubKey ConsumePubKey(FuzzedDataProvider& fuzzed_data_provider, const bool compressed) noexcept\n+{\n+    uint8_t pk_type;\n+    if (compressed) {\n+        pk_type = fuzzed_data_provider.PickValueInArray({0x02, 0x03});\n+    } else {\n+        pk_type = fuzzed_data_provider.PickValueInArray({0x04, 0x06, 0x07});\n+    }\n+    std::vector<uint8_t> pk_data = ConsumeFixedLengthByteVector(fuzzed_data_provider, pk_type >= 0x04 ? 65 : 33);\n+    pk_data[0] = pk_type;\n+    CPubKey pk{pk_data.begin(), pk_data.end()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28361#discussion_r1308730886",
      "id" : 1308730886,
      "in_reply_to_id" : 1308510940,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII585OAaYG",
      "original_commit_id" : "bc5b39375a36f5b76ebd1d23faab0eea077f08ef",
      "original_line" : 27,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/fuzz/util.cpp",
      "position" : 14,
      "pull_request_review_id" : 1600274570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28361",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308730886/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T12:21:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308730886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   }
]
