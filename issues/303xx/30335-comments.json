[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30335).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2024-06-25T11:38:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#issuecomment-2188706791",
      "id" : 2188706791,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30335",
      "node_id" : "IC_kwDOABII586CdQPn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2188706791/reactions"
      },
      "updated_at" : "2024-06-25T11:38:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2188706791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1652647962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1652647962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added blank line here for consistency.",
      "commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "created_at" : "2024-06-25T11:44:09Z",
      "diff_hunk" : "@@ -44,6 +45,7 @@ class Mining\n      * @returns a block template\n      */\n     virtual std::unique_ptr<node::CBlockTemplate> createNewBlock(const CScript& script_pub_key, bool use_mempool = true) = 0;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1652647962",
      "id" : 1652647962,
      "line" : 48,
      "node_id" : "PRRC_kwDOABII585igWga",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 48,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/interfaces/mining.h",
      "position" : 12,
      "pull_request_review_id" : 2138427048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1652647962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-25T11:44:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1652647962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654338332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654338332"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What is this lock used for?",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T08:07:28Z",
      "diff_hunk" : "@@ -390,7 +390,7 @@ static RPCHelpMan generateblock()\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654338332",
      "id" : 1654338332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585imzMc",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 390,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 2141051831,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654338332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T08:19:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654338332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654345783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654345783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same in line 374",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T08:12:36Z",
      "diff_hunk" : "@@ -390,7 +390,7 @@ static RPCHelpMan generateblock()\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654345783",
      "id" : 1654345783,
      "in_reply_to_id" : 1654338332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585im1A3",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 390,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 2141051831,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654345783/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T08:19:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654345783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654485896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654485896"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It is also acquired within `miner.testBlockValidity` (and in `miner.createNewBlock`) so maybe is now unnecessary outside the Miner interface?\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/a9716c53f05082d6d89ebea51a46d4404efb12d7/src/node/interfaces.cpp#L873-L877",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T09:45:31Z",
      "diff_hunk" : "@@ -390,7 +390,7 @@ static RPCHelpMan generateblock()\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654485896",
      "id" : 1654485896,
      "in_reply_to_id" : 1654338332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585inXOI",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 390,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 2141291717,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654485896/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T09:45:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654485896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1328814?v=4",
         "events_url" : "https://api.github.com/users/AngusP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AngusP/followers",
         "following_url" : "https://api.github.com/users/AngusP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AngusP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AngusP",
         "id" : 1328814,
         "login" : "AngusP",
         "node_id" : "MDQ6VXNlcjEzMjg4MTQ=",
         "organizations_url" : "https://api.github.com/users/AngusP/orgs",
         "received_events_url" : "https://api.github.com/users/AngusP/received_events",
         "repos_url" : "https://api.github.com/users/AngusP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AngusP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AngusP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AngusP"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654551558"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654551558"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I pushed 1f0559e9954253c23af7ee9b49e57eb3d7a45bea to drop it from `createNewBlock`. Will look at the other occurances too.",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T10:28:00Z",
      "diff_hunk" : "@@ -390,7 +390,7 @@ static RPCHelpMan generateblock()\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654551558",
      "id" : 1654551558,
      "in_reply_to_id" : 1654338332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585innQG",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 390,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 2141396682,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654551558/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T10:28:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654551558",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654581962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654581962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I pushed [1f0559e](https://github.com/bitcoin/bitcoin/commit/1f0559e9954253c23af7ee9b49e57eb3d7a45bea) to drop it from `createNewBlock`. Will look at the other occurances too.\r\n\r\nThe commit referenced in this commit message is wrong.",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T10:42:33Z",
      "diff_hunk" : "@@ -390,7 +390,7 @@ static RPCHelpMan generateblock()\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654581962",
      "id" : 1654581962,
      "in_reply_to_id" : 1654338332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585inurK",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 390,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 2141434734,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654581962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T10:42:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654581962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654603274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654603274"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The lock at line 390 has been there from the introduction of the `generateblock` RPC call in #17693. I don't see any discussion of it in the reviews.\r\n\r\nI think it's because `assert(pindexPrev && pindexPrev == chainstate.m_chain.Tip());` inside of `TestBlockValidity`. Added 18d6b0f86769f89738a3b08aa8152a8479cef5d4 to explain that, and also make `testBlockValidity` require the lock.\r\n\r\n@maflcko I fixed the commit reference. Still looking at the other lock you mentioned.",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T10:56:41Z",
      "diff_hunk" : "@@ -390,7 +390,7 @@ static RPCHelpMan generateblock()\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654603274",
      "id" : 1654603274,
      "in_reply_to_id" : 1654338332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585inz4K",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 390,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 2141461894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654603274/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T10:58:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654603274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654615945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654615945"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Lock annotations in the cpp file will be ignored by the compiler, because it usually only sees the `.h` file.",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T11:07:38Z",
      "diff_hunk" : "@@ -870,9 +870,10 @@ class MinerImpl : public Mining\n         return context()->mempool->GetTransactionsUpdated();\n     }\n \n-    bool testBlockValidity(BlockValidationState& state, const CBlock& block, bool check_merkle_root) override\n+    bool testBlockValidity(const CBlock& block, bool check_merkle_root, BlockValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654615945",
      "id" : 1654615945,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585in2-J",
      "original_commit_id" : "18d6b0f86769f89738a3b08aa8152a8479cef5d4",
      "original_line" : 873,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 2141482570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654615945/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T11:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654615945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654633765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654633765"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I initially added it only to the header, but that resulted in:\r\n\r\n```\r\nnode/interfaces.cpp:875:9: warning: calling function 'AssertLockHeldInternal<AnnotatedMixin<std::recursive_mutex>>' requires holding mutex 'cs_main' exclusively [-Wthread-safety-analysis]\r\n        AssertLockHeld(cs_main);\r\n        ^\r\n```\r\n\r\n\r\nShould I add it in both? Or declare the `override` first (which would need a new header).",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T11:23:13Z",
      "diff_hunk" : "@@ -870,9 +870,10 @@ class MinerImpl : public Mining\n         return context()->mempool->GetTransactionsUpdated();\n     }\n \n-    bool testBlockValidity(BlockValidationState& state, const CBlock& block, bool check_merkle_root) override\n+    bool testBlockValidity(const CBlock& block, bool check_merkle_root, BlockValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654633765",
      "id" : 1654633765,
      "in_reply_to_id" : 1654615945,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585in7Ul",
      "original_commit_id" : "18d6b0f86769f89738a3b08aa8152a8479cef5d4",
      "original_line" : 873,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 2141511895,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654633765/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T11:23:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654633765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654636609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654636609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Well, I don't even understand the big picture. Isn't the point of interfaces to have (possibly) multiple processes? How would one even take and release a lock in another process?",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T11:25:37Z",
      "diff_hunk" : "@@ -870,9 +870,10 @@ class MinerImpl : public Mining\n         return context()->mempool->GetTransactionsUpdated();\n     }\n \n-    bool testBlockValidity(BlockValidationState& state, const CBlock& block, bool check_merkle_root) override\n+    bool testBlockValidity(const CBlock& block, bool check_merkle_root, BlockValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654636609",
      "id" : 1654636609,
      "in_reply_to_id" : 1654615945,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585in8BB",
      "original_commit_id" : "18d6b0f86769f89738a3b08aa8152a8479cef5d4",
      "original_line" : 873,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 2141516466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654636609/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T11:25:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654636609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654637548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654637548"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually that assert isn't the problem, it merely checks that the `chainman().ActiveChainstate()` and `chainman().ActiveChain().Tip()` that we passed in match.\r\n\r\nThe problem is deeper down the call stack, where `TestBlockValidity` calls `ConnectBlock`. That takes a `viewNew` argument which is `chainstate.CoinsTip()`, and our proposed block (`pindex`), and then it does `assert(hashPrevBlock == view.GetBestBlock());` where `hashPrevBlock = pindex->pprev`. In other words, if our proposed block no longer points to the tip it crashes.",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T11:26:25Z",
      "diff_hunk" : "@@ -390,7 +390,7 @@ static RPCHelpMan generateblock()\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654637548",
      "id" : 1654637548,
      "in_reply_to_id" : 1654338332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585in8Ps",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 390,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 2141517964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654637548/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T11:27:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654637548",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654647663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654647663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, it doesn't make sense to require the lock. Will try something else.",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T11:34:48Z",
      "diff_hunk" : "@@ -870,9 +870,10 @@ class MinerImpl : public Mining\n         return context()->mempool->GetTransactionsUpdated();\n     }\n \n-    bool testBlockValidity(BlockValidationState& state, const CBlock& block, bool check_merkle_root) override\n+    bool testBlockValidity(const CBlock& block, bool check_merkle_root, BlockValidationState& state) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654647663",
      "id" : 1654647663,
      "in_reply_to_id" : 1654615945,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585in-tv",
      "original_commit_id" : "18d6b0f86769f89738a3b08aa8152a8479cef5d4",
      "original_line" : 873,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 2141534227,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654647663/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654647663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654661048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654661048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Pushed c8343e29a66082b37c37ee0ff8f7433b97eea9b1 to deal with this (replaces https://github.com/bitcoin/bitcoin/commit/18d6b0f86769f89738a3b08aa8152a8479cef5d4). This drops both locks from the RPC code.\r\n\r\nAn alternative that would actually prevent the tip from updating, rather than fail the RPC call, is to hold the lock even longer. But callers need to handle failure anyway since `testBlockValidity` can fail for other reasons.\r\n\r\nAlso note that with the original two separate `LOCK(cs_main)` calls the tip could have been updated before `testBlockValidity` anyway, so this is probably a bug fix.",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T11:46:11Z",
      "diff_hunk" : "@@ -390,7 +390,7 @@ static RPCHelpMan generateblock()\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654661048",
      "id" : 1654661048,
      "in_reply_to_id" : 1654338332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ioB-4",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 390,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 2141555499,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654661048/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T11:53:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654661048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654687943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654687943"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`state` will be valid, no? So this may be confusing?",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T12:08:48Z",
      "diff_hunk" : "@@ -870,18 +870,21 @@ class MinerImpl : public Mining\n         return context()->mempool->GetTransactionsUpdated();\n     }\n \n-    bool testBlockValidity(BlockValidationState& state, const CBlock& block, bool check_merkle_root) override\n+    bool testBlockValidity(const CBlock& block, bool check_merkle_root, BlockValidationState& state) override\n     {\n-        LOCK(::cs_main);\n-        return TestBlockValidity(state, chainman().GetParams(), chainman().ActiveChainstate(), block, chainman().ActiveChain().Tip(), /*fCheckPOW=*/false, check_merkle_root);\n+        LOCK(cs_main);\n+        CBlockIndex* tip{chainman().ActiveChain().Tip()};\n+        // Fail if the tip updated before the lock was taken\n+        if (block.hashPrevBlock != tip->GetBlockHash()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654687943",
      "id" : 1654687943,
      "line" : 878,
      "node_id" : "PRRC_kwDOABII585ioIjH",
      "original_commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "original_line" : 878,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 12,
      "pull_request_review_id" : 2141599897,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654687943/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T12:08:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654687943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654690210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654690210"
         }
      },
      "author_association" : "MEMBER",
      "body" : "just a nit, because it only affects test-only code, but wanted to leave the comment.",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T12:10:29Z",
      "diff_hunk" : "@@ -870,18 +870,21 @@ class MinerImpl : public Mining\n         return context()->mempool->GetTransactionsUpdated();\n     }\n \n-    bool testBlockValidity(BlockValidationState& state, const CBlock& block, bool check_merkle_root) override\n+    bool testBlockValidity(const CBlock& block, bool check_merkle_root, BlockValidationState& state) override\n     {\n-        LOCK(::cs_main);\n-        return TestBlockValidity(state, chainman().GetParams(), chainman().ActiveChainstate(), block, chainman().ActiveChain().Tip(), /*fCheckPOW=*/false, check_merkle_root);\n+        LOCK(cs_main);\n+        CBlockIndex* tip{chainman().ActiveChain().Tip()};\n+        // Fail if the tip updated before the lock was taken\n+        if (block.hashPrevBlock != tip->GetBlockHash()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654690210",
      "id" : 1654690210,
      "in_reply_to_id" : 1654687943,
      "line" : 878,
      "node_id" : "PRRC_kwDOABII585ioJGi",
      "original_commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "original_line" : 878,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 12,
      "pull_request_review_id" : 2141603422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654690210/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T12:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654690210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654705968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654705968"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: In the RPC error you'll give `state.ToString()` as the failure reason, but if this tip check fails that'll be the default `BLOCK_RESULT_UNSET`.\r\n\r\nbetter suggestion https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654864264 ~~Seems correct to fail if the tip has updated to avoid building a fork on an older block, but I can't see a `BlockValidationResult` that would make sense here other than maybe stretching the meaning of `BLOCK_INVALID_HEADER` -- perhaps you could add another that only makes sense in a templating context like `BLOCK_NOT_TIP` (or wrap `BlockValidationState` in something like `BlockTemplateValidationState` allowing for other template-specific reults but that might be too messy?)~~",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T12:20:32Z",
      "diff_hunk" : "@@ -872,8 +872,12 @@ class MinerImpl : public Mining\n \n     bool testBlockValidity(const CBlock& block, bool check_merkle_root, BlockValidationState& state) override\n     {\n-        LOCK(::cs_main);\n-        return TestBlockValidity(state, chainman().GetParams(), chainman().ActiveChainstate(), block, chainman().ActiveChain().Tip(), /*fCheckPOW=*/false, check_merkle_root);\n+        LOCK(cs_main);\n+        CBlockIndex* tip{chainman().ActiveChain().Tip()};\n+        // Fail if the tip updated before the lock was taken\n+        if (block.hashPrevBlock != tip->GetBlockHash()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654705968",
      "id" : 1654705968,
      "line" : 878,
      "node_id" : "PRRC_kwDOABII585ioM8w",
      "original_commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "original_line" : 878,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 9,
      "pull_request_review_id" : 2141631956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654705968/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T13:54:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654705968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1328814?v=4",
         "events_url" : "https://api.github.com/users/AngusP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AngusP/followers",
         "following_url" : "https://api.github.com/users/AngusP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AngusP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AngusP",
         "id" : 1328814,
         "login" : "AngusP",
         "node_id" : "MDQ6VXNlcjEzMjg4MTQ=",
         "organizations_url" : "https://api.github.com/users/AngusP/orgs",
         "received_events_url" : "https://api.github.com/users/AngusP/received_events",
         "repos_url" : "https://api.github.com/users/AngusP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AngusP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AngusP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AngusP"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654715485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654715485"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Currently if this happens as you said https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654637548 it looks like we'd have crashed which is fun",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T12:24:56Z",
      "diff_hunk" : "@@ -872,8 +872,12 @@ class MinerImpl : public Mining\n \n     bool testBlockValidity(const CBlock& block, bool check_merkle_root, BlockValidationState& state) override\n     {\n-        LOCK(::cs_main);\n-        return TestBlockValidity(state, chainman().GetParams(), chainman().ActiveChainstate(), block, chainman().ActiveChain().Tip(), /*fCheckPOW=*/false, check_merkle_root);\n+        LOCK(cs_main);\n+        CBlockIndex* tip{chainman().ActiveChain().Tip()};\n+        // Fail if the tip updated before the lock was taken\n+        if (block.hashPrevBlock != tip->GetBlockHash()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654715485",
      "id" : 1654715485,
      "in_reply_to_id" : 1654705968,
      "line" : 878,
      "node_id" : "PRRC_kwDOABII585ioPRd",
      "original_commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "original_line" : 878,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 9,
      "pull_request_review_id" : 2141645593,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654715485/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T12:24:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654715485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1328814?v=4",
         "events_url" : "https://api.github.com/users/AngusP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/AngusP/followers",
         "following_url" : "https://api.github.com/users/AngusP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/AngusP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/AngusP",
         "id" : 1328814,
         "login" : "AngusP",
         "node_id" : "MDQ6VXNlcjEzMjg4MTQ=",
         "organizations_url" : "https://api.github.com/users/AngusP/orgs",
         "received_events_url" : "https://api.github.com/users/AngusP/received_events",
         "repos_url" : "https://api.github.com/users/AngusP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/AngusP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/AngusP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/AngusP"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654751499"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654751499"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> probably a bug fix.\r\n\r\nIn test-only code. But seems fine to fix, if the fix is correct.",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T12:44:38Z",
      "diff_hunk" : "@@ -390,7 +390,7 @@ static RPCHelpMan generateblock()\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654751499",
      "id" : 1654751499,
      "in_reply_to_id" : 1654338332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ioYEL",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 390,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 2141699576,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654751499/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T12:44:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654751499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654843443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654843443"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654338332\r\n\r\n> What is this lock used for?\r\n\r\nMarking this thread resolved as the lock is now removed in later commit c8343e29a66082b37c37ee0ff8f7433b97eea9b1\r\n",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T13:29:30Z",
      "diff_hunk" : "@@ -390,7 +390,7 @@ static RPCHelpMan generateblock()\n         LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654843443",
      "id" : 1654843443,
      "in_reply_to_id" : 1654338332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iougz",
      "original_commit_id" : "22fe97a5cc612f438ec6280757487934501bf527",
      "original_line" : 390,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 2141846291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654843443/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T13:29:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654843443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654849168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654849168"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Drop unneeded lock from createNewBlock\" (1e4918b8f3af20577acdc9f201af44153e29bcb3)\r\n\r\nCommit message could mention the reason the lock is not required in CreateNewBlock, which is just that CreateNewBlock already locks cs_main internally.",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T13:32:23Z",
      "diff_hunk" : "@@ -881,7 +881,6 @@ class MinerImpl : public Mining\n         BlockAssembler::Options options;\n         ApplyArgsManOptions(gArgs, options);\n \n-        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654849168",
      "id" : 1654849168,
      "line" : 884,
      "node_id" : "PRRC_kwDOABII585iov6Q",
      "original_commit_id" : "1e4918b8f3af20577acdc9f201af44153e29bcb3",
      "original_line" : 884,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 22,
      "pull_request_review_id" : 2141854539,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654849168/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T13:44:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654849168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654864264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654864264"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Have testBlockValidity hold cs_main instead of caller\" (c8343e29a66082b37c37ee0ff8f7433b97eea9b1)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654687943\r\n\r\n> `state` will be valid, no? So this may be confusing?\r\n\r\nIt seems like it would be better to do something like:\r\n\r\n\r\n```c++\r\nif (block.hashPrevBlock != tip->GetBlockHash()) {\r\n    state.Error(\"Block does not connect to current chain tip.\")\r\n    return false;\r\n}\r\n```",
      "commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "created_at" : "2024-06-26T13:39:30Z",
      "diff_hunk" : "@@ -870,18 +870,21 @@ class MinerImpl : public Mining\n         return context()->mempool->GetTransactionsUpdated();\n     }\n \n-    bool testBlockValidity(BlockValidationState& state, const CBlock& block, bool check_merkle_root) override\n+    bool testBlockValidity(const CBlock& block, bool check_merkle_root, BlockValidationState& state) override\n     {\n-        LOCK(::cs_main);\n-        return TestBlockValidity(state, chainman().GetParams(), chainman().ActiveChainstate(), block, chainman().ActiveChain().Tip(), /*fCheckPOW=*/false, check_merkle_root);\n+        LOCK(cs_main);\n+        CBlockIndex* tip{chainman().ActiveChain().Tip()};\n+        // Fail if the tip updated before the lock was taken\n+        if (block.hashPrevBlock != tip->GetBlockHash()) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30335#discussion_r1654864264",
      "id" : 1654864264,
      "in_reply_to_id" : 1654687943,
      "line" : 878,
      "node_id" : "PRRC_kwDOABII585iozmI",
      "original_commit_id" : "c8343e29a66082b37c37ee0ff8f7433b97eea9b1",
      "original_line" : 878,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 12,
      "pull_request_review_id" : 2141854539,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30335",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654864264/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-26T13:44:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1654864264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
