[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30338).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30324](https://github.com/bitcoin/bitcoin/pull/30324) (optimization: Moved repeated `-printpriority` fetching out of AddToBlock by paplorinc)\n* [#30320](https://github.com/bitcoin/bitcoin/pull/30320) (assumeutxo: Don't load a snapshot if it's not in the best header chain by mzumsande)\n* [#30277](https://github.com/bitcoin/bitcoin/pull/30277) ([DO NOT MERGE] Erlay: bandwidth-efficient transaction relay protocol (Full implementation) by sr-gi)\n* [#30267](https://github.com/bitcoin/bitcoin/pull/30267) (assumeutxo: Check snapshot base block is not in invalid chain by fjahr)\n* [#30155](https://github.com/bitcoin/bitcoin/pull/30155) (validation: Make ReplayBlocks interruptible by mzumsande)\n* [#30141](https://github.com/bitcoin/bitcoin/pull/30141) (kernel: De-globalize validation caches by TheCharlatan)\n* [#30116](https://github.com/bitcoin/bitcoin/pull/30116) (p2p: Fill reconciliation sets (Erlay) attempt 2 by sr-gi)\n* [#30065](https://github.com/bitcoin/bitcoin/pull/30065) (init: fixes file descriptor accounting by sr-gi)\n* [#30064](https://github.com/bitcoin/bitcoin/pull/30064) (net: log connections failures via SOCKS5 with less severity by vasild)\n* [#30043](https://github.com/bitcoin/bitcoin/pull/30043) (net: Replace libnatpmp with built-in PCP+NATPMP implementation by laanwj)\n* [#29833](https://github.com/bitcoin/bitcoin/pull/29833) (i2p: fix and improve logs by brunoerg)\n* [#29702](https://github.com/bitcoin/bitcoin/pull/29702) (fees: Remove CLIENT_VERSION serialization by maflcko)\n* [#29656](https://github.com/bitcoin/bitcoin/pull/29656) (chainparams: Change nChainTx type to uint64_t by fjahr)\n* [#29641](https://github.com/bitcoin/bitcoin/pull/29641) (scripted-diff: Use LogInfo/LogDebug over LogPrintf/LogPrint by maflcko)\n* [#29640](https://github.com/bitcoin/bitcoin/pull/29640) (Fix tiebreak when loading blocks from disk (and add tests for comparing chain ties) by sr-gi)\n* [#29625](https://github.com/bitcoin/bitcoin/pull/29625) (Several randomness improvements by sipa)\n* [#29605](https://github.com/bitcoin/bitcoin/pull/29605) (net: Favor peers from addrman over fetching seednodes by sr-gi)\n* [#29480](https://github.com/bitcoin/bitcoin/pull/29480) (Drop log category in `SeedStartup` by hebasto)\n* [#29431](https://github.com/bitcoin/bitcoin/pull/29431) (test/BIP324: disconnection scenarios during v2 handshake by stratospher)\n* [#29415](https://github.com/bitcoin/bitcoin/pull/29415) (Broadcast own transactions only via short-lived Tor or I2P connections by vasild)\n* [#29307](https://github.com/bitcoin/bitcoin/pull/29307) (util: explicitly close all AutoFiles that have been written by vasild)\n* [#29256](https://github.com/bitcoin/bitcoin/pull/29256) (Improve new LogDebug/Trace/Info/Warning/Error Macros by ryanofsky)\n* [#29141](https://github.com/bitcoin/bitcoin/pull/29141) (Bugfix: RPC: Check for blank rpcauth on a per-param basis by luke-jr)\n* [#28792](https://github.com/bitcoin/bitcoin/pull/28792) (Embedding ASMap files as binary dump header file by fjahr)\n* [#28521](https://github.com/bitcoin/bitcoin/pull/28521) (net: additional disconnect logging by Sjors)\n* [#28167](https://github.com/bitcoin/bitcoin/pull/28167) (init: Add option for rpccookie permissions (replace 26088) by willcl-ark)\n* [#27826](https://github.com/bitcoin/bitcoin/pull/27826) (validation: log which peer sent us a header by Sjors)\n* [#27052](https://github.com/bitcoin/bitcoin/pull/27052) (test: rpc: add last block announcement time to getpeerinfo result by LarryRuane)\n* [#27006](https://github.com/bitcoin/bitcoin/pull/27006) (reduce cs_main scope, guard block index 'nFile' under a local mutex by furszy)\n* [#26114](https://github.com/bitcoin/bitcoin/pull/26114) (net: Make AddrFetch connections to fixed seeds by mzumsande)\n* [#26022](https://github.com/bitcoin/bitcoin/pull/26022) (Add util::ResultPtr class by ryanofsky)\n* [#25832](https://github.com/bitcoin/bitcoin/pull/25832) (tracing: network connection tracepoints by 0xB10C)\n* [#25722](https://github.com/bitcoin/bitcoin/pull/25722) (refactor: Use util::Result class for wallet loading by ryanofsky)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result failure values, multiple error and warning messages by ryanofsky)\n* [#19463](https://github.com/bitcoin/bitcoin/pull/19463) (Prune locks by luke-jr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-06-25T17:47:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2189605882",
      "id" : 2189605882,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586Cgrv6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2189605882/reactions"
      },
      "updated_at" : "2024-06-25T22:19:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2189605882",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ping @TheCharlatan @ajtowns @maflcko for Concept (N)ACKs",
      "created_at" : "2024-06-25T17:48:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2189606984",
      "id" : 2189606984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586CgsBI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2189606984/reactions"
      },
      "updated_at" : "2024-06-25T17:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2189606984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@theuni I made a similar change in #29256. That approach might be less invasive because it makes the instance argument optional. So kernel code can be changed to log to a configurable instance while other code uses a global instance.",
      "created_at" : "2024-06-25T18:15:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2189661783",
      "id" : 2189661783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586Cg5ZX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2189661783/reactions"
      },
      "updated_at" : "2024-06-25T18:15:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2189661783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/26668500153</sub>",
      "created_at" : "2024-06-25T21:42:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2190020727",
      "id" : 2190020727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586CiRB3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2190020727/reactions"
      },
      "updated_at" : "2024-06-25T21:42:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2190020727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-06-26T19:51:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2192512712",
      "id" : 2192512712,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586CrxbI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2192512712/reactions"
      },
      "updated_at" : "2024-06-26T19:51:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2192512712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> this will allow us to instantiate a per-context logger, which is necessary for the kernel.\r\n\r\nI don't understand where this is coming from. Libraries can export globals, eg `stdin`, so I don't see why you're claiming it's necessary for the kernel when it's not even necessary for libc.",
      "created_at" : "2024-06-27T14:53:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2194940918",
      "id" : 2194940918,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586C1CP2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2194940918/reactions"
      },
      "updated_at" : "2024-06-27T14:53:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2194940918",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Re https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2194940918\r\n\r\n> I don't understand where this is coming from. Libraries can export globals, eg stdin, so I don't see why you're claiming it's necessary for the kernel when it's not even necessary for libc.\r\n\r\nBeing forced to eliminate all globals doesn't seem to be the claim here? As long as the globals don't carry over annoying state from previous usage, require annoying initialization, or aren't mostly safe from user misuse, their usage is fine. Next to what was brought up before about having the ability to distinguish between between the logged lines from multiple instances, there are a few other problems with the existing implementation that make its usage as a global annoying at the moment. If an instantiated logger is a red line here, we might be able to find other solutions though.\r\n\r\nThe current implementation buffers without a limit until `StartLogging()` is called. This forces the user to at least eventually call `StartLogging()`, even if they don't wish to consume logs. We could limit the buffer to some acceptably low amount, or ensure that `StartLogging()` is statically called when the library is loaded (similar to how the static secp context is created when bitcoin is started). This would discard previous logging messages though.\r\n\r\nI also noticed that any logs buffered before the user applies their own user-defined options will be printed in the default format and with default categories. Re-starting logging is also awkward to do at the moment.\r\n\r\nLogging is workable for the kernel library as is, but it would be nice to address the remaining pain points. I think having instantiated logging would be the best way to solve these issues, making it clear to the user when something will be logged, as well as giving guarantees on its format.\r\n",
      "created_at" : "2024-06-28T16:11:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2197248760",
      "id" : 2197248760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586C91r4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2197248760/reactions"
      },
      "updated_at" : "2024-06-28T16:11:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2197248760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Re [#30338 (comment)](https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2194940918)\r\n> \r\n> > I don't understand where this is coming from. Libraries can export globals, eg stdin, so I don't see why you're claiming it's necessary for the kernel when it's not even necessary for libc.\r\n> \r\n> Being forced to eliminate all globals doesn't seem to be the claim here?\r\n\r\nThe opposite of instanced parameters is globals; if instanced parameters are necessary, then globals aren't possible. The claim in the OP is that the \"instanced logs\" proposed here are \"necessary for the kernel\".\r\n\r\n> Next to what was brought up before about having the ability to distinguish between between the logged lines from multiple instances, there are a few other problems with the existing implementation that make its usage as a global annoying at the moment. \r\n\r\nI assume that's referring to the [concept](https://github.com/bitcoin/bitcoin/pull/29256#issuecomment-2189810744) of rewriting `contrib/linearize` from python to C++. That doesn't make sense to me as any kind of priority (and seems to conflict with other proposed benefits of instanced logging), so I'm going to assume that the \"few other problems\" are the real issue.\r\n \r\n> The current implementation buffers without a limit until `StartLogging()` is called. This forces the user to at least eventually call `StartLogging()`, even if they don't wish to consume logs. We could limit the buffer to some acceptably low amount, or ensure that `StartLogging()` is statically called when the library is loaded (similar to how the static secp context is created when bitcoin is started). This would discard previous logging messages though.\r\n\r\n`StartLogging` is meant to indicate the appropriate configuration values have been applied to the logger; so calling it on library load wouldn't make sense, as far as I can see.\r\n\r\nLimiting the buffer could make sense. We could also tweak the defaults to be more suitable for the kernel (eg, no buffering of logs prior to `StartLogging()` at all), and override the settings for bitcoind/etc with something like:\r\n\r\n ```c++\r\n// logging.h\r\nclass LoggingLaunchSettings\r\n{\r\npublic:\r\n    template<typename Fn>\r\n    LoggingLaunchSettings(Fn&& fn) { Logger logger = LogInstance(); fn(logger); }\r\n};\r\n\r\n// init.cpp\r\nstatic BCLog::LoggingLaunchSettings bitcoind_logging_control{\r\n  [](auto& logger) { logger.m_early_buffer = true; }\r\n};\r\n```     \r\n\r\nOther users of libkernel who wanted buffering could then do the same thing.\r\n\r\n> I also noticed that any logs buffered before the user applies their own user-defined options will be printed in the default format and with default categories.\r\n\r\nBuffering debug/trace logging prior to `StartLogging` doesn't really make sense as far as I can see.\r\n\r\nFixing the formatting of buffered logs is a bit of work, but not very complicated. It doesn't seem particularly related to the kernel, though. Would you review a PR to do that?\r\n\r\n> Re-starting logging is also awkward to do at the moment.\r\n\r\nI'm not sure what you mean? There's `DisconnectTestLogger(); StartLogging();` ?\r\n\r\n> Logging is workable for the kernel library as is, but it would be nice to address the remaining pain points. I think having instantiated logging would be the best way to solve these issues, making it clear to the user when something will be logged, as well as giving guarantees on its format.\r\n\r\nTouching every single line of logging code for a \"nice to have\" doesn't make much sense to me. It's nice to be able to just shove a `LogInfo(\"XXX %s happened\", thing);` anywhere in the code and have it work, without having to find/add an enclosing manager object that has had a logging context passed in from init.",
      "created_at" : "2024-06-28T18:30:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2197436060",
      "id" : 2197436060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586C-jac",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2197436060/reactions"
      },
      "updated_at" : "2024-06-28T18:30:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2197436060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Touching every single line of logging code for a \"nice to have\" doesn't make much sense to me.\r\n\r\nAJ I know we are disagreeing about a lot of things, and I do not fault you in any way for this, but your reactions seem very strong relative the actual scope of changes we would like to make.\r\n\r\nWe should set aside Cory's big scripted diff commit here, which I think is a proof of concept and an illustrative change, not an actual change being proposed to merge. I think the actual changes being considered would look a lot more like:\r\n\r\n- [ ] e9b91f5c5c9283516e67dd4e21d61c6b154672b6 refactor: Pass Logger instances to kernel objects\r\n- [ ] facc2d0edff9831b35dd3d7bcc82fc9b94e4cdd6 refactor: Log kernel output to local log instances\r\n\r\nWhich come from #30342 and yes, I can understand, probably you do not love. But I don't understand how they would have a discernible negative impact or why you would want to spend time arguing against them? These seem like basically trivial changes.\r\n\r\nI am sincerely asking about this, because I do not understand what you see as being at stake here.",
      "created_at" : "2024-06-28T19:05:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2197476854",
      "id" : 2197476854,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586C-tX2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2197476854/reactions"
      },
      "updated_at" : "2024-06-28T19:05:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2197476854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, @ryanofsky. This was a POC (FWIW I am actually very ok with the scripted-diff approach which touches every line, but I didn't expect it to be popular). At this point I'd prefer to throw my weight behind #30342 as it accomplishes what I want without being so invasive.\r\n\r\nI won't add to the arguing here as I think you and @TheCharlatan have said what I would've anyway.",
      "created_at" : "2024-06-28T19:10:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2197483154",
      "id" : 2197483154,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586C-u6S",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2197483154/reactions"
      },
      "updated_at" : "2024-06-28T19:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2197483154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Re https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2197436060\r\n\r\nThanks for going through this. Having something like `LaunchSettings` seems like a good thing.\r\n\r\n> Fixing the formatting of buffered logs is a bit of work, but not very complicated. It doesn't seem particularly related to the kernel, though. Would you review a PR to do that?\r\n\r\nyes :)\r\n\r\n> I'm not sure what you mean? There's DisconnectTestLogger(); StartLogging(); ?\r\n\r\nBesides the incoherent naming between the two, it also starts buffering again when calling `DisconnectTestLogger()`, which does not seem immediately intuitive to me. It seems like what these methods are actually doing is disconnect all callbacks and start buffering, and stop buffering and flushing the buffered messages respectively.  I'm not saying this is bad, just that they should have better ergonomics that clearly convey what they do.  The current state is workable as is, albeit a bit rough.",
      "created_at" : "2024-06-28T19:40:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30338#issuecomment-2197523046",
      "id" : 2197523046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30338",
      "node_id" : "IC_kwDOABII586C-4pm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2197523046/reactions"
      },
      "updated_at" : "2024-06-28T19:40:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2197523046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   }
]
