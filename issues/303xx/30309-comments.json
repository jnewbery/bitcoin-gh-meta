[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30309).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [tdb3](https://github.com/bitcoin/bitcoin/pull/30309#pullrequestreview-2131483027), [rkrux](https://github.com/bitcoin/bitcoin/pull/30309#pullrequestreview-2132779327) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2024-06-19T17:34:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#issuecomment-2179222067",
      "id" : 2179222067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30309",
      "node_id" : "IC_kwDOABII586B5Eoz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2179222067/reactions"
      },
      "updated_at" : "2024-06-21T15:27:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2179222067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1648208431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1648208431"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested that this would fail if the `return util::Error...` line was commented out in source/wallet/spend.cpp.  It did (as expected).",
      "commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "created_at" : "2024-06-20T22:38:31Z",
      "diff_hunk" : "@@ -1312,6 +1313,38 @@ def test_weight_calculation(self):\n \n         self.nodes[2].unloadwallet(\"test_weight_calculation\")\n \n+    def test_weight_limits(self):\n+        self.log.info(\"Test weight limits\")\n+\n+        self.nodes[2].createwallet(\"test_weight_limits\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_weight_limits\")\n+\n+        outputs = []\n+        for _ in range(1472):\n+            outputs.append({wallet.getnewaddress(address_type=\"legacy\"): 0.1})\n+        txid = self.nodes[0].send(outputs=outputs)[\"txid\"]\n+        self.generate(self.nodes[0], 1)\n+\n+        # 272 WU per input (273 when high-s); picking 1471 inputs will exceed the max standard tx weight.\n+        rawtx = wallet.createrawtransaction([], [{wallet.getnewaddress(): 0.1 * 1471}])\n+\n+        # 1) Try to fund transaction only using the preset inputs\n+        input_weights = []\n+        for i in range(1471):\n+            input_weights.append({\"txid\": txid, \"vout\": i, \"weight\": 273})\n+        assert_raises_rpc_error(-4, \"Transaction too large\", wallet.fundrawtransaction, hexstring=rawtx, input_weights=input_weights)\n+\n+        # 2) Let the wallet fund the transaction\n+        assert_raises_rpc_error(-4, \"The inputs size exceeds the maximum weight. Please try sending a smaller amount or manually consolidating your wallet's UTXOs\",\n+                                wallet.fundrawtransaction, hexstring=rawtx)\n+\n+        # 3) Pre-select some inputs and let the wallet fill-up the remaining amount\n+        inputs = input_weights[0:1000]\n+        assert_raises_rpc_error(-4, \"The combination of the pre-selected inputs and the wallet automatic inputs selection exceeds the transaction maximum weight. Please try sending a smaller amount or manually consolidating your wallet's UTXOs\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1648208431",
      "id" : 1648208431,
      "line" : 1343,
      "node_id" : "PRRC_kwDOABII585iPaov",
      "original_commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "original_line" : 1343,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/wallet_fundrawtransaction.py",
      "position" : 39,
      "pull_request_review_id" : 2131483027,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1648208431/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-20T22:39:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1648208431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649036915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649036915"
         }
      },
      "author_association" : "NONE",
      "body" : "The comment above MAX_STANDARD_WEIGHT says it's the maximum weight we are willing to mine: https://github.com/bitcoin/bitcoin/blob/master/src/policy/policy.h#L27\r\n\r\nShould the condition here not be strictly greater than? ",
      "commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "created_at" : "2024-06-21T14:22:27Z",
      "diff_hunk" : "@@ -799,6 +799,13 @@ util::Result<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& av\n         op_selection_result->RecalculateWaste(coin_selection_params.min_viable_change,\n                                                 coin_selection_params.m_cost_of_change,\n                                                 coin_selection_params.m_change_fee);\n+\n+        // Verify we haven't exceeded the maximum allowed weight\n+        int max_inputs_weight = MAX_STANDARD_TX_WEIGHT - (coin_selection_params.tx_noinputs_size * WITNESS_SCALE_FACTOR);\n+        if (op_selection_result->GetWeight() >= max_inputs_weight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649036915",
      "id" : 1649036915,
      "line" : 805,
      "node_id" : "PRRC_kwDOABII585iSk5z",
      "original_commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "original_line" : 805,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 7,
      "pull_request_review_id" : 2132779327,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649036915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-21T15:28:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649036915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Anything that should be added to unit tests?\r\n\r\nThe behavior change is tested on a functional test. No need to duplicate the same test twice.\r\nFunctional tests are portable across releases due to our API stability requirement. Unit tests are harder to maintain due to internal code changes.",
      "created_at" : "2024-06-21T15:19:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#issuecomment-2182953969",
      "id" : 2182953969,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/30309",
      "node_id" : "IC_kwDOABII586CHTvx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2182953969/reactions"
      },
      "updated_at" : "2024-06-21T15:20:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2182953969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649111896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649111896"
         }
      },
      "author_association" : "NONE",
      "body" : "From `(273 when high-s)`, I assume this considers a signed input but the docs of `createrawtransaction` and `fundrawtransaction` say that these commands don't generate a signed transaction. So this max weight check on picking 1472 inputs of 273 WU each internally seems to be dependent only on the `weight` parameter passed to `fundrawtransaction` RPC, which is dependent on the user input. \r\nIs there not any other internal worst-case scenario treatment of the inputs weights that might not be dependent on user input?",
      "commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "created_at" : "2024-06-21T15:24:03Z",
      "diff_hunk" : "@@ -1312,6 +1313,38 @@ def test_weight_calculation(self):\n \n         self.nodes[2].unloadwallet(\"test_weight_calculation\")\n \n+    def test_weight_limits(self):\n+        self.log.info(\"Test weight limits\")\n+\n+        self.nodes[2].createwallet(\"test_weight_limits\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_weight_limits\")\n+\n+        outputs = []\n+        for _ in range(1472):\n+            outputs.append({wallet.getnewaddress(address_type=\"legacy\"): 0.1})\n+        txid = self.nodes[0].send(outputs=outputs)[\"txid\"]\n+        self.generate(self.nodes[0], 1)\n+\n+        # 272 WU per input (273 when high-s); picking 1471 inputs will exceed the max standard tx weight.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649111896",
      "id" : 1649111896,
      "line" : 1328,
      "node_id" : "PRRC_kwDOABII585iS3NY",
      "original_commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "original_line" : 1328,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "test/functional/wallet_fundrawtransaction.py",
      "position" : 24,
      "pull_request_review_id" : 2132779327,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649111896/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-21T15:27:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649111896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649113587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649113587"
         }
      },
      "author_association" : "NONE",
      "body" : "I assume the `MAX_STANDARD_TX_WEIGHT` will be replaced by `max_tx_weight` (if present) during or after [29523](https://github.com/bitcoin/bitcoin/pull/29523) PR is merged?\r\n",
      "commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "created_at" : "2024-06-21T15:25:25Z",
      "diff_hunk" : "@@ -799,6 +799,13 @@ util::Result<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& av\n         op_selection_result->RecalculateWaste(coin_selection_params.min_viable_change,\n                                                 coin_selection_params.m_cost_of_change,\n                                                 coin_selection_params.m_change_fee);\n+\n+        // Verify we haven't exceeded the maximum allowed weight\n+        int max_inputs_weight = MAX_STANDARD_TX_WEIGHT - (coin_selection_params.tx_noinputs_size * WITNESS_SCALE_FACTOR);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649113587",
      "id" : 1649113587,
      "line" : 804,
      "node_id" : "PRRC_kwDOABII585iS3nz",
      "original_commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "original_line" : 804,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 6,
      "pull_request_review_id" : 2132779327,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649113587/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-21T15:30:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649113587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5960750?v=4",
         "events_url" : "https://api.github.com/users/rkrux/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rkrux/followers",
         "following_url" : "https://api.github.com/users/rkrux/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rkrux/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rkrux",
         "id" : 5960750,
         "login" : "rkrux",
         "node_id" : "MDQ6VXNlcjU5NjA3NTA=",
         "organizations_url" : "https://api.github.com/users/rkrux/orgs",
         "received_events_url" : "https://api.github.com/users/rkrux/received_events",
         "repos_url" : "https://api.github.com/users/rkrux/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rkrux/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rkrux/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rkrux"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649417438"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649417438"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes, thx",
      "commit_id" : "72b226882fe2348a9a66aee1d8d21b4e2d275e68",
      "created_at" : "2024-06-21T20:48:58Z",
      "diff_hunk" : "@@ -799,6 +799,13 @@ util::Result<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& av\n         op_selection_result->RecalculateWaste(coin_selection_params.min_viable_change,\n                                                 coin_selection_params.m_cost_of_change,\n                                                 coin_selection_params.m_change_fee);\n+\n+        // Verify we haven't exceeded the maximum allowed weight\n+        int max_inputs_weight = MAX_STANDARD_TX_WEIGHT - (coin_selection_params.tx_noinputs_size * WITNESS_SCALE_FACTOR);\n+        if (op_selection_result->GetWeight() >= max_inputs_weight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649417438",
      "id" : 1649417438,
      "in_reply_to_id" : 1649036915,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585iUBze",
      "original_commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "original_line" : 805,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 2133400797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649417438/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-21T21:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649417438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649425300"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649425300"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, good eye. `send()` and `walletprocesspsbt()` will also fail. Will add coverage for one of them.",
      "commit_id" : "72b226882fe2348a9a66aee1d8d21b4e2d275e68",
      "created_at" : "2024-06-21T21:00:25Z",
      "diff_hunk" : "@@ -1312,6 +1313,38 @@ def test_weight_calculation(self):\n \n         self.nodes[2].unloadwallet(\"test_weight_calculation\")\n \n+    def test_weight_limits(self):\n+        self.log.info(\"Test weight limits\")\n+\n+        self.nodes[2].createwallet(\"test_weight_limits\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_weight_limits\")\n+\n+        outputs = []\n+        for _ in range(1472):\n+            outputs.append({wallet.getnewaddress(address_type=\"legacy\"): 0.1})\n+        txid = self.nodes[0].send(outputs=outputs)[\"txid\"]\n+        self.generate(self.nodes[0], 1)\n+\n+        # 272 WU per input (273 when high-s); picking 1471 inputs will exceed the max standard tx weight.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649425300",
      "id" : 1649425300,
      "in_reply_to_id" : 1649111896,
      "line" : 1328,
      "node_id" : "PRRC_kwDOABII585iUDuU",
      "original_commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "original_line" : 1328,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "test/functional/wallet_fundrawtransaction.py",
      "position" : 24,
      "pull_request_review_id" : 2133400797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649425300/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-21T21:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649425300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649434850"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649434850"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I assume the `MAX_STANDARD_TX_WEIGHT` will be replaced by `max_tx_weight` (if present) during or after [29523](https://github.com/bitcoin/bitcoin/pull/29523) PR is merged?\r\n\r\nYes.",
      "commit_id" : "72b226882fe2348a9a66aee1d8d21b4e2d275e68",
      "created_at" : "2024-06-21T21:14:22Z",
      "diff_hunk" : "@@ -799,6 +799,13 @@ util::Result<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& av\n         op_selection_result->RecalculateWaste(coin_selection_params.min_viable_change,\n                                                 coin_selection_params.m_cost_of_change,\n                                                 coin_selection_params.m_change_fee);\n+\n+        // Verify we haven't exceeded the maximum allowed weight\n+        int max_inputs_weight = MAX_STANDARD_TX_WEIGHT - (coin_selection_params.tx_noinputs_size * WITNESS_SCALE_FACTOR);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649434850",
      "id" : 1649434850,
      "in_reply_to_id" : 1649113587,
      "line" : 804,
      "node_id" : "PRRC_kwDOABII585iUGDi",
      "original_commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "original_line" : 804,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 6,
      "pull_request_review_id" : 2133400797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649434850/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-21T21:14:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649434850",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649519554"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649519554"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Re-ran this test (comment out `return util::Error...`) for 72b226882fe2348a9a66aee1d8d21b4e2d275e68.  Failed as expected.",
      "commit_id" : "72b226882fe2348a9a66aee1d8d21b4e2d275e68",
      "created_at" : "2024-06-22T01:03:52Z",
      "diff_hunk" : "@@ -1312,6 +1313,38 @@ def test_weight_calculation(self):\n \n         self.nodes[2].unloadwallet(\"test_weight_calculation\")\n \n+    def test_weight_limits(self):\n+        self.log.info(\"Test weight limits\")\n+\n+        self.nodes[2].createwallet(\"test_weight_limits\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_weight_limits\")\n+\n+        outputs = []\n+        for _ in range(1472):\n+            outputs.append({wallet.getnewaddress(address_type=\"legacy\"): 0.1})\n+        txid = self.nodes[0].send(outputs=outputs)[\"txid\"]\n+        self.generate(self.nodes[0], 1)\n+\n+        # 272 WU per input (273 when high-s); picking 1471 inputs will exceed the max standard tx weight.\n+        rawtx = wallet.createrawtransaction([], [{wallet.getnewaddress(): 0.1 * 1471}])\n+\n+        # 1) Try to fund transaction only using the preset inputs\n+        input_weights = []\n+        for i in range(1471):\n+            input_weights.append({\"txid\": txid, \"vout\": i, \"weight\": 273})\n+        assert_raises_rpc_error(-4, \"Transaction too large\", wallet.fundrawtransaction, hexstring=rawtx, input_weights=input_weights)\n+\n+        # 2) Let the wallet fund the transaction\n+        assert_raises_rpc_error(-4, \"The inputs size exceeds the maximum weight. Please try sending a smaller amount or manually consolidating your wallet's UTXOs\",\n+                                wallet.fundrawtransaction, hexstring=rawtx)\n+\n+        # 3) Pre-select some inputs and let the wallet fill-up the remaining amount\n+        inputs = input_weights[0:1000]\n+        assert_raises_rpc_error(-4, \"The combination of the pre-selected inputs and the wallet automatic inputs selection exceeds the transaction maximum weight. Please try sending a smaller amount or manually consolidating your wallet's UTXOs\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649519554",
      "id" : 1649519554,
      "in_reply_to_id" : 1648208431,
      "line" : 1343,
      "node_id" : "PRRC_kwDOABII585iUavC",
      "original_commit_id" : "3f5027626593c7af546d3b53fc658c87bb815348",
      "original_line" : 1343,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/wallet_fundrawtransaction.py",
      "position" : 39,
      "pull_request_review_id" : 2133551145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649519554/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-22T01:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649519554",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649519927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649519927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Saw that the same expected failure occurs here when commenting out `return util::Error...` for 72b226882fe2348a9a66aee1d8d21b4e2d275e68.",
      "commit_id" : "72b226882fe2348a9a66aee1d8d21b4e2d275e68",
      "created_at" : "2024-06-22T01:05:47Z",
      "diff_hunk" : "@@ -577,5 +577,39 @@ def run_test(self):\n         # but rounded to nearest integer, it should be the same as the target fee rate\n         assert_equal(round(actual_fee_rate_sat_vb), target_fee_rate_sat_vb)\n \n+        # Check tx creation size limits\n+        self.test_weight_limits()\n+\n+    def test_weight_limits(self):\n+        self.log.info(\"Test weight limits\")\n+\n+        self.nodes[1].createwallet(\"test_weight_limits\")\n+        wallet = self.nodes[1].get_wallet_rpc(\"test_weight_limits\")\n+\n+        # Generate future inputs; 272 WU per input (273 when high-s).\n+        # Picking 1471 inputs will exceed the max standard tx weight.\n+        outputs = []\n+        for _ in range(1472):\n+            outputs.append({wallet.getnewaddress(address_type=\"legacy\"): 0.1})\n+        self.nodes[0].send(outputs=outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # 1) Try to fund transaction only using the preset inputs\n+        inputs = wallet.listunspent()\n+        assert_raises_rpc_error(-4, \"Transaction too large\",\n+                                wallet.send, outputs=[{wallet.getnewaddress(): 0.1 * 1471}], options={\"inputs\": inputs, \"add_inputs\": False})\n+\n+        # 2) Let the wallet fund the transaction\n+        assert_raises_rpc_error(-4, \"The inputs size exceeds the maximum weight. Please try sending a smaller amount or manually consolidating your wallet's UTXOs\",\n+                                wallet.send, outputs=[{wallet.getnewaddress(): 0.1 * 1471}])\n+\n+        # 3) Pre-select some inputs and let the wallet fill-up the remaining amount\n+        inputs = inputs[0:1000]\n+        assert_raises_rpc_error(-4, \"The combination of the pre-selected inputs and the wallet automatic inputs selection exceeds the transaction maximum weight. Please try sending a smaller amount or manually consolidating your wallet's UTXOs\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/30309#discussion_r1649519927",
      "id" : 1649519927,
      "line" : 608,
      "node_id" : "PRRC_kwDOABII585iUa03",
      "original_commit_id" : "72b226882fe2348a9a66aee1d8d21b4e2d275e68",
      "original_line" : 608,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/wallet_send.py",
      "position" : 32,
      "pull_request_review_id" : 2133551145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/30309",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649519927/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-06-22T01:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649519927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/106488469?v=4",
         "events_url" : "https://api.github.com/users/tdb3/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tdb3/followers",
         "following_url" : "https://api.github.com/users/tdb3/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tdb3/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tdb3",
         "id" : 106488469,
         "login" : "tdb3",
         "node_id" : "U_kgDOBljilQ",
         "organizations_url" : "https://api.github.com/users/tdb3/orgs",
         "received_events_url" : "https://api.github.com/users/tdb3/received_events",
         "repos_url" : "https://api.github.com/users/tdb3/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tdb3/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tdb3/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tdb3"
      }
   }
]
