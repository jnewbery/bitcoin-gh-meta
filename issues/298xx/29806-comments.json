[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "seen in #29898 too - https://cirrus-ci.com/task/5457627730149376?logs=ci#L3718",
      "created_at" : "2024-04-17T16:56:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29806#issuecomment-2061766412",
      "id" : 2061766412,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29806",
      "node_id" : "IC_kwDOABII58565A8M",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2061766412/reactions"
      },
      "updated_at" : "2024-04-17T16:56:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2061766412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/44024636?v=4",
         "events_url" : "https://api.github.com/users/stratospher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stratospher/followers",
         "following_url" : "https://api.github.com/users/stratospher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stratospher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stratospher",
         "id" : 44024636,
         "login" : "stratospher",
         "node_id" : "MDQ6VXNlcjQ0MDI0NjM2",
         "organizations_url" : "https://api.github.com/users/stratospher/orgs",
         "received_events_url" : "https://api.github.com/users/stratospher/received_events",
         "repos_url" : "https://api.github.com/users/stratospher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stratospher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stratospher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stratospher"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The [relevant part of the test](https://github.com/bitcoin/bitcoin/blob/7fee0ca014b1513e836d2550d1b7512739d5a79a/test/functional/wallet_backwards_compatibility.py#L173-L176) in `wallet_backwards_compatibility.py` creates tx3, calls bump fee to replace it in the wallet (creating tx4), and calls `abandontransaction` on tx3. Later on there's an assertion to check if tx3 is marked as abandoned, but this is the call that sporadically fails.\r\n\r\nThe failure seems to occur because the `TransactionAddedToMempool` signal from the creation of tx3, and the `TransactionRemovedFromMempool` signal from the replacement of tx3 are handled after `abandontransaction` is called and overwrites the wallet's version of the abandoned tx3. \r\n\r\n[In the logs posted in the first comment](https://cirrus-ci.com/task/5524545770094592?logs=ci#L3290), we can see this in the timestamps (`Enqueuing ...` happens before abandontransaction is called, while the handling of the enqueued task occurs after):\r\n```\r\nnode1 2024-04-03T22:38:25.781773Z [httpworker.0] [validationinterface.cpp:191] [TransactionAddedToMempool] [validation] Enqueuing TransactionAddedToMempool: txid=41ac814a7e27d942d5f8bd212d83090114dd3d28a2d264eeaa1a53873e727de6 wtxid=dafaa05b20990d2dbdb6488e2a9d405e5bcc4ae32b3c012557fb6c1ef9dd2c8c \r\n\r\n node1 2024-04-03T22:38:25.783955Z [httpworker.1] [validation.cpp:1165] [Finalize] [mempool] replacing tx 41ac814a7e27d942d5f8bd212d83090114dd3d28a2d264eeaa1a53873e727de6 (wtxid=dafaa05b20990d2dbdb6488e2a9d405e5bcc4ae32b3c012557fb6c1ef9dd2c8c) with 190fd4bd5fab876d2d6258952d487a98965d2092810f964b44af2ea02c5512e9 (wtxid=74725b97d0668fc3aea49d3322a9f4ed4daf7809c42cf06740b3ef8a12d7c9fa) for 0.00000706 additional fees, 0 delta bytes \r\n\r\nnode1 2024-04-03T22:38:25.783969Z [httpworker.1] [validationinterface.cpp:200] [TransactionRemovedFromMempool] [validation] Enqueuing TransactionRemovedFromMempool: txid=41ac814a7e27d942d5f8bd212d83090114dd3d28a2d264eeaa1a53873e727de6 wtxid=dafaa05b20990d2dbdb6488e2a9d405e5bcc4ae32b3c012557fb6c1ef9dd2c8c reason=replaced \r\n\r\nnode1 2024-04-03T22:38:25.785044Z [httpworker.2] [rpc/request.cpp:187] [parse] [rpc] ThreadRPCServer method=abandontransaction user=__cookie__ \r\n\r\nnode1 2024-04-03T22:38:25.785369Z [scheduler] [validationinterface.cpp:191] [operator()] [validation] TransactionAddedToMempool: txid=41ac814a7e27d942d5f8bd212d83090114dd3d28a2d264eeaa1a53873e727de6 wtxid=dafaa05b20990d2dbdb6488e2a9d405e5bcc4ae32b3c012557fb6c1ef9dd2c8c \r\n\r\nnode1 2024-04-03T22:38:25.794933Z [scheduler] [wallet/wallet.h:933] [WalletLogPrintf] [w1] AddToWallet 41ac814a7e27d942d5f8bd212d83090114dd3d28a2d264eeaa1a53873e727de6  update InMempool\r\n\r\nnode1 2024-04-03T22:38:25.795430Z [scheduler] [validationinterface.cpp:200] [operator()] [validation] TransactionRemovedFromMempool: txid=41ac814a7e27d942d5f8bd212d83090114dd3d28a2d264eeaa1a53873e727de6 wtxid=dafaa05b20990d2dbdb6488e2a9d405e5bcc4ae32b3c012557fb6c1ef9dd2c8c reason=replaced \r\n```\r\n\r\nThis can be fixed by calling `self.sync_mempools()` before `node_master.abandontransaction(tx3_id)`, but I wanted to confirm whether overriding the abandoned status of the wallet transaction is expected behavior before tackling this.\r\n\r\n---\r\nThe failure can be reproduced locally by wrapping `callbacks.TransactionAddedToMempool` and `callbacks.TransactionRemovedFromMempool` (in `validationinterface.cpp`) with a lambda introducing an `UninterruptibleSleep(40ms)`, and calling `self.sync_mempools()` after `node_master.abandontransaction(tx3_id)` in `wallet_backwards_compatibility.py`",
      "created_at" : "2024-04-27T14:55:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29806#issuecomment-2080840395",
      "id" : 2080840395,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29806",
      "node_id" : "IC_kwDOABII5858BxrL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2080840395/reactions"
      },
      "updated_at" : "2024-04-27T14:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2080840395",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4742100?v=4",
         "events_url" : "https://api.github.com/users/Randy808/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Randy808/followers",
         "following_url" : "https://api.github.com/users/Randy808/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Randy808/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Randy808",
         "id" : 4742100,
         "login" : "Randy808",
         "node_id" : "MDQ6VXNlcjQ3NDIxMDA=",
         "organizations_url" : "https://api.github.com/users/Randy808/orgs",
         "received_events_url" : "https://api.github.com/users/Randy808/received_events",
         "repos_url" : "https://api.github.com/users/Randy808/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Randy808/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Randy808/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Randy808"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If the transaction is eventually considered abandoned in all cases, then adding the `sync_mempools` (or I guess `syncwithvalidationinterface` would be enough) seems fine.",
      "created_at" : "2024-04-27T15:01:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29806#issuecomment-2080852359",
      "id" : 2080852359,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29806",
      "node_id" : "IC_kwDOABII5858B0mH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2080852359/reactions"
      },
      "updated_at" : "2024-04-27T15:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2080852359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Sounds good, I'll add `sync_mempools()` to mitigate the immediate inconsistency observed with the `abandontransaction` call. I'll mention the potential race conditions between the signals and wallet operations, but I'm thinking that could be treated as a separate issue.\r\n",
      "created_at" : "2024-04-28T04:17:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/29806#issuecomment-2081321444",
      "id" : 2081321444,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29806",
      "node_id" : "IC_kwDOABII5858DnHk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081321444/reactions"
      },
      "updated_at" : "2024-04-28T04:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081321444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4742100?v=4",
         "events_url" : "https://api.github.com/users/Randy808/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Randy808/followers",
         "following_url" : "https://api.github.com/users/Randy808/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Randy808/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Randy808",
         "id" : 4742100,
         "login" : "Randy808",
         "node_id" : "MDQ6VXNlcjQ3NDIxMDA=",
         "organizations_url" : "https://api.github.com/users/Randy808/orgs",
         "received_events_url" : "https://api.github.com/users/Randy808/received_events",
         "repos_url" : "https://api.github.com/users/Randy808/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Randy808/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Randy808/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Randy808"
      }
   }
]
