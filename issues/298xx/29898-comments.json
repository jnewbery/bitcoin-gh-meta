[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29898).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2024-04-17T08:16:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29898#issuecomment-2060674263",
      "id" : 2060674263,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29898",
      "node_id" : "IC_kwDOABII585602TX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2060674263/reactions"
      },
      "updated_at" : "2024-04-17T08:16:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2060674263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29898#discussion_r1569470049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29898"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1569470049"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it would be more stable to have a global counter, so that `peer_id` is never reused. Currently, it is still reused over different `test_desirable_service_flags` calls.\r\nE.g., if I add the net sleep and also change `CONNECTION_TYPES = [\"outbound-full-relay\"]` so that  `test_desirable_service_flags` only makes one connection, I run into the timeout even with your fix.",
      "commit_id" : "b199b323840cf4978bda3437eee36c3dd228702a",
      "created_at" : "2024-04-17T20:13:17Z",
      "diff_hunk" : "@@ -47,6 +47,7 @@ def test_desirable_service_flags(self, node, service_flag_tests, desirable_servi\n            service flags in the VERSION message. The test is exercised for all relevant\n            outbound connection types where the desirable service flags check is done.\"\"\"\n         CONNECTION_TYPES = [\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]\n+        peer_id = 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29898#discussion_r1569470049",
      "id" : 1569470049,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII585djDZh",
      "original_commit_id" : "b199b323840cf4978bda3437eee36c3dd228702a",
      "original_line" : 50,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 16,
      "pull_request_review_id" : 2007043243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29898",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1569470049/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-17T20:24:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1569470049",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29898#discussion_r1569994243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29898"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1569994243"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "makes sense, less diff too. but `peer_id` is bounded to [0, 11]/`p2p_idx = peer_id + 1` is bounded to [1, 12] [here](https://github.com/bitcoin/bitcoin/blob/dbd2000b34903b87ae2e02eb2fc6c4a2f7d11451/test/functional/test_framework/p2p.py#L745). so we'd cross that limit if we do global counters.\r\n\r\nEDIT: wondering why there are limits - looks like there weren't limits before: https://github.com/bitcoin/bitcoin/commit/fabbf6bd62c1d8a290841b63fb1e5acec42ba3b0#diff-ca0d4d4c4cfe461c71633bbc358b2f38ef4aa1351f0e461c28b570928c9503eb. I guess it's because each `P2PConnection` for obvious reasons can accept only 1 connection from `TestNode` and there could only be 12 possible simultaneous outbound connections among all `TestNodes` in a python test.",
      "commit_id" : "b199b323840cf4978bda3437eee36c3dd228702a",
      "created_at" : "2024-04-18T05:19:18Z",
      "diff_hunk" : "@@ -47,6 +47,7 @@ def test_desirable_service_flags(self, node, service_flag_tests, desirable_servi\n            service flags in the VERSION message. The test is exercised for all relevant\n            outbound connection types where the desirable service flags check is done.\"\"\"\n         CONNECTION_TYPES = [\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]\n+        peer_id = 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29898#discussion_r1569994243",
      "id" : 1569994243,
      "in_reply_to_id" : 1569470049,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII585dlDYD",
      "original_commit_id" : "b199b323840cf4978bda3437eee36c3dd228702a",
      "original_line" : 50,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 16,
      "pull_request_review_id" : 2007870990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29898",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1569994243/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-18T05:43:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1569994243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/44024636?v=4",
         "events_url" : "https://api.github.com/users/stratospher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stratospher/followers",
         "following_url" : "https://api.github.com/users/stratospher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stratospher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stratospher",
         "id" : 44024636,
         "login" : "stratospher",
         "node_id" : "MDQ6VXNlcjQ0MDI0NjM2",
         "organizations_url" : "https://api.github.com/users/stratospher/orgs",
         "received_events_url" : "https://api.github.com/users/stratospher/received_events",
         "repos_url" : "https://api.github.com/users/stratospher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stratospher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stratospher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stratospher"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29898#discussion_r1570597336"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29898"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1570597336"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "oh - I didn't know about that, interesting!\r\nAnother thing we could do is to not only do `peer.wait_for_disconnect()` but also wait until the bitcoind side has disconnected - something like `self.wait_until(lambda: len(self.nodes[0].getpeerinfo()) == X)`. Haven't tried that though.",
      "commit_id" : "b199b323840cf4978bda3437eee36c3dd228702a",
      "created_at" : "2024-04-18T12:06:32Z",
      "diff_hunk" : "@@ -47,6 +47,7 @@ def test_desirable_service_flags(self, node, service_flag_tests, desirable_servi\n            service flags in the VERSION message. The test is exercised for all relevant\n            outbound connection types where the desirable service flags check is done.\"\"\"\n         CONNECTION_TYPES = [\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]\n+        peer_id = 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29898#discussion_r1570597336",
      "id" : 1570597336,
      "in_reply_to_id" : 1569470049,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII585dnWnY",
      "original_commit_id" : "b199b323840cf4978bda3437eee36c3dd228702a",
      "original_line" : 50,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 16,
      "pull_request_review_id" : 2008703224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29898",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1570597336/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-18T12:06:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1570597336",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/29898#discussion_r1570777163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29898"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1570777163"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> EDIT: wondering why there are limits\r\n\r\nThere needs to be a limit, because each test gets allocated the full (maximum) range of ports for the duration of the test_runner (that is for the duration of *all* tests, not the test itself) to avoid port collisions. Thus, the limit needs to exist, because there is a finite number of ports on any system.",
      "commit_id" : "b199b323840cf4978bda3437eee36c3dd228702a",
      "created_at" : "2024-04-18T13:38:58Z",
      "diff_hunk" : "@@ -47,6 +47,7 @@ def test_desirable_service_flags(self, node, service_flag_tests, desirable_servi\n            service flags in the VERSION message. The test is exercised for all relevant\n            outbound connection types where the desirable service flags check is done.\"\"\"\n         CONNECTION_TYPES = [\"outbound-full-relay\", \"block-relay-only\", \"addr-fetch\"]\n+        peer_id = 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29898#discussion_r1570777163",
      "id" : 1570777163,
      "in_reply_to_id" : 1569470049,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII585doChL",
      "original_commit_id" : "b199b323840cf4978bda3437eee36c3dd228702a",
      "original_line" : 50,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "test/functional/p2p_handshake.py",
      "position" : 16,
      "pull_request_review_id" : 2008937834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29898",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1570777163/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2024-04-18T13:38:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1570777163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   }
]
