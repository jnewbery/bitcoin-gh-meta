[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [stickies-v](https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1702612290) |\n| Concept ACK | [hebasto](https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1635642358) |\n| Stale ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/27866#pullrequestreview-1591525089) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27596](https://github.com/bitcoin/bitcoin/pull/27596) (assumeutxo (2) by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-06-12T18:43:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1587880258",
      "id" : 1587880258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585epSFC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1587880258/reactions"
      },
      "updated_at" : "2023-09-01T11:39:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1587880258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1227107197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227107197"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: Return on fatal flush errors\" (1fe06a811bf8be941bef5336af97688f48885828)\r\n\r\nThis method is not marked nodiscard, and it seems like there are some cases where this error is ignored and not returned to the caller.",
      "commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "created_at" : "2023-06-12T18:53:22Z",
      "diff_hunk" : "@@ -2506,7 +2506,9 @@ bool Chainstate::FlushStateToDisk(\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"write block and undo data to disk\", BCLog::BENCH);\n \n                 // First make sure all block and undo data is flushed to disk.\n-                m_blockman.FlushBlockFile();\n+                if (!m_blockman.FlushBlockFile()) {\n+                    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1227107197",
      "id" : 1227107197,
      "line" : 2510,
      "node_id" : "PRRC_kwDOABII585JJCt9",
      "original_commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "original_line" : 2510,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 1475602374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227107197/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T19:22:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227107197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1227119951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227119951"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"chainstate: Return on ValidatedSnapshotCleanup fatal failure\" (360fe5a47f75514621ef62bc4c906f2112d3308f)\r\n\r\nI think this should return FAILURE not INTERRUPTED so caller can know that an error happened, not just an early shutdown request.\r\n\r\nBut I'd actually suggest dropping this commit from the PR. #27862 should cover this case, and I opened it earlier because I think AbortNode calls in assumeutxo code and in flush code seem different. There should be less of a rationale for ignoring errors in assumeutxo.",
      "commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "created_at" : "2023-06-12T19:03:17Z",
      "diff_hunk" : "@@ -207,7 +207,9 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     } else if (snapshot_completion == SnapshotCompletionResult::SUCCESS) {\n         LogPrintf(\"[snapshot] cleaning up unneeded background chainstate, then reinitializing\\n\");\n         if (!chainman.ValidatedSnapshotCleanup()) {\n-            AbortNode(\"Background chainstate cleanup failed unexpectedly.\");\n+            const auto error = _(\"Background chainstate cleanup failed unexpectedly.\");\n+            AbortNode(error.original);\n+            return {ChainstateLoadStatus::INTERRUPTED, error};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1227119951",
      "id" : 1227119951,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJF1P",
      "original_commit_id" : "360fe5a47f75514621ef62bc4c906f2112d3308f",
      "original_line" : 212,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1475602374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227119951/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T19:22:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227119951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1227166132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227166132"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yup, I'll drop, make this PR about the flush errors only and continue discussion on your PR.",
      "commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "created_at" : "2023-06-12T19:51:24Z",
      "diff_hunk" : "@@ -207,7 +207,9 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     } else if (snapshot_completion == SnapshotCompletionResult::SUCCESS) {\n         LogPrintf(\"[snapshot] cleaning up unneeded background chainstate, then reinitializing\\n\");\n         if (!chainman.ValidatedSnapshotCleanup()) {\n-            AbortNode(\"Background chainstate cleanup failed unexpectedly.\");\n+            const auto error = _(\"Background chainstate cleanup failed unexpectedly.\");\n+            AbortNode(error.original);\n+            return {ChainstateLoadStatus::INTERRUPTED, error};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1227166132",
      "id" : 1227166132,
      "in_reply_to_id" : 1227119951,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJRG0",
      "original_commit_id" : "360fe5a47f75514621ef62bc4c906f2112d3308f",
      "original_line" : 212,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1475700763,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227166132/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T19:51:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227166132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Re https://github.com/bitcoin/bitcoin/pull/27866#pullrequestreview-1475602374\r\n\r\n> It also seems reasonable that some failed flushes like periodic flushes might not need to be fatal errors.\r\n\r\nThis is a good point, and I did not think of this before. A flush may fail once due to some sporadic error, but may succeed again at a later point in time. I'm still not sure though if it is really correct to ignore the flush error. If we fail to flush, but succeed in writing the block index, and then crash, we might have indexed a block, that has not been synced to disk. It also feels weird that we are currently okay with the block files failing to flush, while the call to `CoinsTip().Flush()` returns early on failure. Can you comment on this rationale?",
      "created_at" : "2023-06-12T20:39:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1588058565",
      "id" : 1588058565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585ep9nF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1588058565/reactions"
      },
      "updated_at" : "2023-06-12T20:39:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1588058565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> A flush may fail once due to some sporadic error, but may succeed again at a later point in time. I'm still not sure though if it is really correct to ignore the flush error.\r\n\r\nAt least, such a flush error can be logged.",
      "created_at" : "2023-06-15T13:44:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1593096707",
      "id" : 1593096707,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585e9LoD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593096707/reactions"
      },
      "updated_at" : "2023-06-15T13:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593096707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Can you comment on this rationale?\r\n\r\nI'm not familiar enough with existing code to know why it's written the way it is. It could have a great rationale or just be weird like it appears to be.\r\n\r\nI'm less concerned about this PR than I am about #27861, which is treating flush errors as fatal errors when they are not inherently fatal. If code writing to disk fails it could either mean (1) state on disk is corrupt or invalid and can't be recovered from or (2) state on disk is valid but out of date and requires more work to catch up. These cases are inherently different and I think kernel API would benefit off having separate \"flush error\" and \"fatal error\" notifications to distinguish them, regardless of implementation details of current code.",
      "created_at" : "2023-06-15T14:24:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1593169273",
      "id" : 1593169273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585e9dV5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593169273/reactions"
      },
      "updated_at" : "2023-06-15T14:24:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593169273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1246307365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246307365"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There are many cases where these fatal error codes are eventually ignored as you go up the call stack. I would like to keep this PR focused on the question whether these blockstorage flush functions should at least indicate that they ran into an error. If you want to get a sense of just how many such \"ignored\" cases there are, I have my own set of patches that achieve something similar to Cory's \"bubble up\", but with your `Result<T, E>` type and introduced granularly for each fatal error call site here: https://github.com/TheCharlatan/bitcoin/pull/13. ",
      "commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "created_at" : "2023-06-29T08:33:40Z",
      "diff_hunk" : "@@ -2506,7 +2506,9 @@ bool Chainstate::FlushStateToDisk(\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"write block and undo data to disk\", BCLog::BENCH);\n \n                 // First make sure all block and undo data is flushed to disk.\n-                m_blockman.FlushBlockFile();\n+                if (!m_blockman.FlushBlockFile()) {\n+                    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1246307365",
      "id" : 1246307365,
      "in_reply_to_id" : 1227107197,
      "line" : 2510,
      "node_id" : "PRRC_kwDOABII585KSSQl",
      "original_commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "original_line" : 2510,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 1504816042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246307365/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-29T08:33:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246307365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1246940264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246940264"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Formatting: `if (`",
      "commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "created_at" : "2023-06-29T17:36:41Z",
      "diff_hunk" : "@@ -733,7 +739,9 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // with the block writes (usually when a synced up node is getting newly mined blocks) -- this case is caught in\n         // the FindBlockPos function\n         if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n-            FlushUndoFile(_pos.nFile, true);\n+            if(!FlushUndoFile(_pos.nFile, true)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1246940264",
      "id" : 1246940264,
      "line" : 742,
      "node_id" : "PRRC_kwDOABII585KUsxo",
      "original_commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "original_line" : 742,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 60,
      "pull_request_review_id" : 1505795854,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246940264/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-29T17:36:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246940264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1247198730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247198730"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Any reason why this isn't `[[nodiscard]]` too? Given that it returns the `AbortNode` result, and is used in blockstorage?",
      "commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "created_at" : "2023-06-29T21:35:28Z",
      "diff_hunk" : "@@ -90,9 +90,9 @@ class BlockManager\n      */\n     bool LoadBlockIndex()\n         EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-    void FlushBlockFile(bool fFinalize = false, bool finalize_undo = false);\n-    void FlushUndoFile(int block_file, bool finalize = false);\n-    bool FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigned int nHeight, CChain& active_chain, uint64_t nTime, bool fKnown);\n+    [[nodiscard]] bool FlushBlockFile(bool fFinalize = false, bool finalize_undo = false);\n+    [[nodiscard]] bool FlushUndoFile(int block_file, bool finalize = false);\n+    [[nodiscard]] bool FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigned int nHeight, CChain& active_chain, uint64_t nTime, bool fKnown);\n     bool FindUndoPos(BlockValidationState& state, int nFile, FlatFilePos& pos, unsigned int nAddSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1247198730",
      "id" : 1247198730,
      "line" : 96,
      "node_id" : "PRRC_kwDOABII585KVr4K",
      "original_commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "original_line" : 96,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 10,
      "pull_request_review_id" : 1506167577,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247198730/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-29T22:05:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247198730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1247595124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247595124"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I can't think of a good reason why this shouldn't be `[[nodiscard]]` too. However, as I said [here](https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1246307365) I am trying to keep this PR's scope limited to just the flush functions and their immediate call sites. I added the `[[nodiscard]]` to `FindBlockPos`, because it reports on the flush error now too. `FindUndoPos` on the other hand is not immediately affected by the flush errors. There are many such examples where we ignore error codes upon return throughout the kernel code and I'd like to tackle them bit by bit.",
      "commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "created_at" : "2023-06-30T08:32:58Z",
      "diff_hunk" : "@@ -90,9 +90,9 @@ class BlockManager\n      */\n     bool LoadBlockIndex()\n         EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n-    void FlushBlockFile(bool fFinalize = false, bool finalize_undo = false);\n-    void FlushUndoFile(int block_file, bool finalize = false);\n-    bool FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigned int nHeight, CChain& active_chain, uint64_t nTime, bool fKnown);\n+    [[nodiscard]] bool FlushBlockFile(bool fFinalize = false, bool finalize_undo = false);\n+    [[nodiscard]] bool FlushUndoFile(int block_file, bool finalize = false);\n+    [[nodiscard]] bool FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigned int nHeight, CChain& active_chain, uint64_t nTime, bool fKnown);\n     bool FindUndoPos(BlockValidationState& state, int nFile, FlatFilePos& pos, unsigned int nAddSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1247595124",
      "id" : 1247595124,
      "in_reply_to_id" : 1247198730,
      "line" : 96,
      "node_id" : "PRRC_kwDOABII585KXMp0",
      "original_commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "original_line" : 96,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 10,
      "pull_request_review_id" : 1506757994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247595124/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-30T08:32:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1247595124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1254749159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254749159"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1227107197\r\n\r\n> introduced granularly for each fatal error call site here: [TheCharlatan#13](https://github.com/TheCharlatan/bitcoin/pull/13).\r\n\r\nThanks, it's good to see nodiscard being used there, and introducing more meaningful error codes.\r\n\r\nIt's possible my suggestion and your PRs have slightly different goals. Maybe your goal is to enhance libbitcoinkernel applications ability to handle and report errors, and my goal is to improve clarify of validation code and find to potential bugs in it. From my perspective, just adding `[[nodiscard]]` to function declarations and `(void)` to call sites along with \"// This error is intentionally ignored because ...\" and \"// This error is currently ignored but might be better to handle by ...\" comments would already be improvements. Maybe that doesn't go far enough though, or is more tangential to what this PR is trying to do.",
      "commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "created_at" : "2023-07-06T17:50:05Z",
      "diff_hunk" : "@@ -2506,7 +2506,9 @@ bool Chainstate::FlushStateToDisk(\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"write block and undo data to disk\", BCLog::BENCH);\n \n                 // First make sure all block and undo data is flushed to disk.\n-                m_blockman.FlushBlockFile();\n+                if (!m_blockman.FlushBlockFile()) {\n+                    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1254749159",
      "id" : 1254749159,
      "in_reply_to_id" : 1227107197,
      "line" : 2510,
      "node_id" : "PRRC_kwDOABII585KyfPn",
      "original_commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "original_line" : 2510,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 1517040699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254749159/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-06T18:00:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254749159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1254840912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254840912"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Maybe your goal is to enhance libbitcoinkernel applications ability to handle and report errors, and my goal is to improve clarify of validation code and find to potential bugs in it.\r\n\r\nI think that hits it on the nail. In any case I updated the PR description with much of the body of the commit message to make it clearer what I am trying to achieve here and why I'd consider it an improvement.",
      "commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "created_at" : "2023-07-06T19:34:49Z",
      "diff_hunk" : "@@ -2506,7 +2506,9 @@ bool Chainstate::FlushStateToDisk(\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"write block and undo data to disk\", BCLog::BENCH);\n \n                 // First make sure all block and undo data is flushed to disk.\n-                m_blockman.FlushBlockFile();\n+                if (!m_blockman.FlushBlockFile()) {\n+                    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1254840912",
      "id" : 1254840912,
      "in_reply_to_id" : 1227107197,
      "line" : 2510,
      "node_id" : "PRRC_kwDOABII585Ky1pQ",
      "original_commit_id" : "1fe06a811bf8be941bef5336af97688f48885828",
      "original_line" : 2510,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 1517184299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254840912/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-06T19:34:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254840912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-07-06T22:04:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1624365745",
      "id" : 1624365745,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585g0dqx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1624365745/reactions"
      },
      "updated_at" : "2023-07-06T22:04:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1624365745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 1fe06a811bf8be941bef5336af97688f48885828 -> d1c92b57a72b62ffa202f1d3d357b59befdc9c12 ([kernelReturnOnAbort_0](https://github.com/TheCharlatan/bitcoin/tree/kernelReturnOnAbort_0) -> [kernelReturnOnAbort_1](https://github.com/TheCharlatan/bitcoin/tree/kernelReturnOnAbort_1),  [compare](https://github.com/TheCharlatan/bitcoin/compare/kernelReturnOnAbort_0..kernelReturnOnAbort_1))\r\n\r\n* Fixed conflict with #27861\r\n* Fixed formatting if formatting",
      "created_at" : "2023-07-07T17:30:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1625724128",
      "id" : 1625724128,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585g5pTg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625724128/reactions"
      },
      "updated_at" : "2023-07-07T17:30:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625724128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256284494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256284494"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: Return on fatal flush errors\" (d1c92b57a72b62ffa202f1d3d357b59befdc9c12)\r\n\r\nLet me know if I understand this correctly: The new `return false` avoids writing block data to a new block file if the _previous_ block file is full and cannot be synced and trimmed. This seems to be safe because this `FindBlockPos` function only has one caller, `SaveBlockToDisk`, which only has two callers, `Chainstate::AcceptBlock` and `Chainstate::LoadGenesisBlock` which both seem to handle this error by stopping what they are doing and writing \"Failed to find position to write new block\" log messages. I did not look up `AcceptBlock` and `LoadGenesisBlock` callers but assume they are handling this case reasonably.\r\n\r\nI think existing log messages are vague / misleading, so would suggest adding a new log message here like:\r\n\r\n```c++\r\nLogPrintf(\"Failed to flush previous block file %05i (finalize=%i, finalize_undo=%i) before opening new block file %05i\", m_last_blockfile, !fKnown, finalize_undo, nFile)`.\r\n```\r\n\r\nI'm not sure what the benefits are of returning false here. I think unlike the other changes in this commit, this change doesn't help avoid any \"potential write from WriteBlockIndexDB that may refer to a block that is not fully flushed to disk yet\", because this flush call is happening after previous block data has already been successfully written and the database has already been updated.\r\n\r\nI think the clearest and most conservative thing to do would be to drop \"return false\" line in this commit, and only log an error message here. If you think returning false is a good idea, just do it in a followup commit decoupled from the other changes here with a commit message that explains why that is safe / desirable.",
      "commit_id" : "d1c92b57a72b62ffa202f1d3d357b59befdc9c12",
      "created_at" : "2023-07-07T18:37:20Z",
      "diff_hunk" : "@@ -644,7 +650,9 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n         if (!fKnown) {\n             LogPrint(BCLog::BLOCKSTORAGE, \"Leaving block file %i: %s\\n\", m_last_blockfile, m_blockfile_info[m_last_blockfile].ToString());\n         }\n-        FlushBlockFile(!fKnown, finalize_undo);\n+        if (!FlushBlockFile(!fKnown, finalize_undo)) {\n+            return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256284494",
      "id" : 1256284494,
      "line" : 654,
      "node_id" : "PRRC_kwDOABII585K4WFO",
      "original_commit_id" : "d1c92b57a72b62ffa202f1d3d357b59befdc9c12",
      "original_line" : 654,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 50,
      "pull_request_review_id" : 1519541703,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256284494/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-07T19:57:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256284494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256329428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256329428"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: Return on fatal flush errors\" (d1c92b57a72b62ffa202f1d3d357b59befdc9c12)\r\n\r\nThis skips trying to flush the undo file if flushing the block file fails. It think it would be safer and more conservative to keep previous behavior of flushing both files in sequence.\r\n\r\nYou can still return false if either flush call fails, but I don't see a benefit in changing behavior here and potentially making code less robust, when it's not necessary just to add a return code.\r\n\r\nI think it would also make review simpler to get rid of this unnecessary change, since the other changes in this commit are already pretty complex.",
      "commit_id" : "d1c92b57a72b62ffa202f1d3d357b59befdc9c12",
      "created_at" : "2023-07-07T19:03:03Z",
      "diff_hunk" : "@@ -541,17 +543,21 @@ void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n         // chainstate init, when we call ChainstateManager::MaybeRebalanceCaches() (which\n         // then calls FlushStateToDisk()), resulting in a call to this function before we\n         // have populated `m_blockfile_info` via LoadBlockIndexDB().\n-        return;\n+        return true;\n     }\n     assert(static_cast<int>(m_blockfile_info.size()) > m_last_blockfile);\n \n     FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);\n     if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         m_opts.notifications.flushError(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256329428",
      "id" : 1256329428,
      "line" : 553,
      "node_id" : "PRRC_kwDOABII585K4hDU",
      "original_commit_id" : "d1c92b57a72b62ffa202f1d3d357b59befdc9c12",
      "original_line" : 553,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 32,
      "pull_request_review_id" : 1519541703,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256329428/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-07T19:57:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256329428",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256350394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256350394"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: Return on fatal flush errors\" (d1c92b57a72b62ffa202f1d3d357b59befdc9c12)\r\n\r\nThis change seems fragile to me, and it's unclear what the benefits are. I think it would be great to add a log print here, but if this this code is going to be changed to return false, I think that should happen in a separate followup commit, not combined with other changes here, and have a clear explanation and justification.\r\n\r\nIIUC, this change introduces an inconsistency. For all block data, and for vast majority of undo data, the data is considered to be successfully written if the write call succeeeds regardless of whether syncing and trimming succeeds later. But now with this change, for some small fraction of undo block data, the data will be considered not written if the syncing or trimming fails. And the fraction of blocks this will be true for will be essentially random due to the undo flush heuristic (described in a new [comment](https://github.com/sdaftuar/bitcoin/blob/03dfe04075668aa3b99a5d6d68adfcecffca0593/src/node/blockstorage.h#L129-L139) from #27746)\r\n\r\nI understand that your [goal](https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1254840912) here is to have libbitcoinkernel functions return more complete error information. I understand that goal is easier to achieve by changing behavior of validation and block storage code and returning early in certain cases. But fundamentally it is not necessary to change behavior of any existing code to have it return more error information. Without returning early, you can always accumulate errors and just return the error code at the end.\r\n\r\nIf returning early makes sense, I think it should be justified in its own terms and done carefully in smaller commits.",
      "commit_id" : "f7072be104a8cf0516def7a4d9fca4791a8d2269",
      "created_at" : "2023-07-07T19:24:25Z",
      "diff_hunk" : "@@ -734,7 +742,9 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // with the block writes (usually when a synced up node is getting newly mined blocks) -- this case is caught in\n         // the FindBlockPos function\n         if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n-            FlushUndoFile(_pos.nFile, true);\n+            if (!FlushUndoFile(_pos.nFile, true)) {\n+                return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256350394",
      "id" : 1256350394,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585K4mK6",
      "original_commit_id" : "d1c92b57a72b62ffa202f1d3d357b59befdc9c12",
      "original_line" : 746,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1519541703,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256350394/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-07T19:59:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256350394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256378064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256378064"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockstorage: Return on fatal flush errors\" (d1c92b57a72b62ffa202f1d3d357b59befdc9c12)\r\n\r\nThis line appears to implement the major change in behavior which is avoiding the \"write from \r\n`WriteBlockIndexDB` that may refer to a block that is not fully flushed to disk yet.\"\r\n\r\nI wonder what this failure looks like in practice, though. Could we write a test for it? I think it would at least make sense to have a log print that explains the problem that's happening.\r\n\r\nThere are also a *lot* of callers to `FlushStateToDisk` and I haven't looked at all of them to determine if they are handling this correctly. Can you describe what they should be doing, and do you know if they actually are doing it? The commit message says \"no extra logic for functions calling `Chainstate::FlushStateToDisk` is required\" mentioning an \"abort error\", but there is no abort error here, only a \"return false\" so I'm not sure how this is supposed to work.\r\n",
      "commit_id" : "f7072be104a8cf0516def7a4d9fca4791a8d2269",
      "created_at" : "2023-07-07T19:48:53Z",
      "diff_hunk" : "@@ -2505,7 +2505,9 @@ bool Chainstate::FlushStateToDisk(\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"write block and undo data to disk\", BCLog::BENCH);\n \n                 // First make sure all block and undo data is flushed to disk.\n-                m_blockman.FlushBlockFile();\n+                if (!m_blockman.FlushBlockFile()) {\n+                    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256378064",
      "id" : 1256378064,
      "line" : 2509,
      "node_id" : "PRRC_kwDOABII585K4s7Q",
      "original_commit_id" : "d1c92b57a72b62ffa202f1d3d357b59befdc9c12",
      "original_line" : 2509,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 1519541703,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256378064/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-07T20:00:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256378064",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2023-07-14T10:19:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1635642358",
      "id" : 1635642358,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585hfev2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1635642358/reactions"
      },
      "updated_at" : "2023-07-14T10:19:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1635642358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Putting this back to draft until I've invested the time to properly address @ryanofsky's comments.",
      "created_at" : "2023-07-18T21:23:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1641009949",
      "id" : 1641009949,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585hz9Md",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1641009949/reactions"
      },
      "updated_at" : "2023-07-18T21:23:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1641009949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you for the excellent review @ryanofsky.\r\n\r\nUpdated d1c92b57a72b62ffa202f1d3d357b59befdc9c12 -> 5720741c14e617ed338f64361b23f4e66ec99e07 ([kernelReturnOnAbort_1](https://github.com/TheCharlatan/bitcoin/tree/kernelReturnOnAbort_1) -> [kernelReturnOnAbort_2](https://github.com/TheCharlatan/bitcoin/tree/kernelReturnOnAbort_2),  [compare](https://github.com/TheCharlatan/bitcoin/compare/kernelReturnOnAbort_1..kernelReturnOnAbort_2))\r\n\r\n* Split the changes up into three commits\r\n* Addressed @ryanofsky's [comment](https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256284494), ignoring `FlushBlockFile` failure in `FindBlockPos`. Also added a comment explaining why the return type is ignored and added the suggested log line.\r\n* Addressed @ryanofsky's [comment](https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256329428), always attempting `FlushUndoFile` in `FlushBlockFIle`, even when the block file flushing fails and return a success code only at the end of the function.\r\n* Addressed @ryanofsky's [comment](https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1256350394), ignoring the `FlushUndoFile` failure in `WriteUndoDataForBlock` and instead added a comment and a log message in case of flush failure.",
      "created_at" : "2023-07-25T15:25:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1650056185",
      "id" : 1650056185,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585iWdv5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1650056185/reactions"
      },
      "updated_at" : "2023-07-26T20:54:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1650056185",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1273739178"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1273739178"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I wonder what this failure looks like in practice, though. Could we write a test for it?\r\n\r\nI could not come up with a way to test this with our existing code. If anybody has any pointers for how to achieve this, I'd happy to give it a shot at implementing the test.\r\n\r\n> Can you describe what they should be doing, and do you know if they actually are doing it? \r\n\r\nCallers of `FlushStateToDisk` already need to handle failures of the block index writing, so I don't think they require extra logic for handling block file flushing failures. We already have places in the code where we ignore flushing errors (including the block index writing), so I think in places where we are fine with that failure, we should also be fine with the block file flushing failing.",
      "commit_id" : "f7072be104a8cf0516def7a4d9fca4791a8d2269",
      "created_at" : "2023-07-25T15:35:54Z",
      "diff_hunk" : "@@ -2505,7 +2505,9 @@ bool Chainstate::FlushStateToDisk(\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"write block and undo data to disk\", BCLog::BENCH);\n \n                 // First make sure all block and undo data is flushed to disk.\n-                m_blockman.FlushBlockFile();\n+                if (!m_blockman.FlushBlockFile()) {\n+                    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1273739178",
      "id" : 1273739178,
      "in_reply_to_id" : 1256378064,
      "line" : 2509,
      "node_id" : "PRRC_kwDOABII585L67eq",
      "original_commit_id" : "d1c92b57a72b62ffa202f1d3d357b59befdc9c12",
      "original_line" : 2509,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 1545797741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1273739178/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-25T15:35:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1273739178",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-07-31T22:14:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1659261478",
      "id" : 1659261478,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585i5lIm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1659261478/reactions"
      },
      "updated_at" : "2023-07-31T22:14:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1659261478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 5720741c14e617ed338f64361b23f4e66ec99e07 -> 7721ab9139013d70ef0f058754fabc5aaeda2246 ([kernelReturnOnAbort_2](https://github.com/TheCharlatan/bitcoin/tree/kernelReturnOnAbort_2) -> [kernelReturnOnAbort_3](https://github.com/TheCharlatan/bitcoin/tree/kernelReturnOnAbort_3),  [compare](https://github.com/TheCharlatan/bitcoin/compare/kernelReturnOnAbort_2..kernelReturnOnAbort_3))\r\n\r\n* Fixed conflict with https://github.com/bitcoin/bitcoin/pull/27746",
      "created_at" : "2023-08-01T21:28:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1661125511",
      "id" : 1661125511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585jAsOH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1661125511/reactions"
      },
      "updated_at" : "2023-08-01T21:28:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1661125511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1288920603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288920603"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: can be declared closer to where it's used",
      "commit_id" : "7721ab9139013d70ef0f058754fabc5aaeda2246",
      "created_at" : "2023-08-09T17:06:46Z",
      "diff_hunk" : "@@ -538,34 +538,43 @@ bool BlockManager::UndoReadFromDisk(CBlockUndo& blockundo, const CBlockIndex& in\n     return true;\n }\n \n-void BlockManager::FlushUndoFile(int block_file, bool finalize)\n+bool BlockManager::FlushUndoFile(int block_file, bool finalize)\n {\n     FlatFilePos undo_pos_old(block_file, m_blockfile_info[block_file].nUndoSize);\n     if (!UndoFileSeq().Flush(undo_pos_old, finalize)) {\n         m_opts.notifications.flushError(\"Flushing undo file to disk failed. This is likely the result of an I/O error.\");\n+        return false;\n     }\n+    return true;\n }\n \n-void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n+bool BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n {\n+    bool success = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1288920603",
      "id" : 1288920603,
      "line" : 553,
      "node_id" : "PRRC_kwDOABII585M014b",
      "original_commit_id" : "7721ab9139013d70ef0f058754fabc5aaeda2246",
      "original_line" : 553,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 18,
      "pull_request_review_id" : 1570159243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288920603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-10T10:23:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288920603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1288925171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288925171"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: long line",
      "commit_id" : "7721ab9139013d70ef0f058754fabc5aaeda2246",
      "created_at" : "2023-08-09T17:09:36Z",
      "diff_hunk" : "@@ -658,7 +667,17 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n         if (!fKnown) {\n             LogPrint(BCLog::BLOCKSTORAGE, \"Leaving block file %i: %s\\n\", m_last_blockfile, m_blockfile_info[m_last_blockfile].ToString());\n         }\n-        FlushBlockFile(!fKnown, finalize_undo);\n+\n+        // Do not propagate the return code. The flush concerns a previous block\n+        // and undo file that has already been written to. If a flush fails\n+        // here, and we crash, there is no expected additional block data\n+        // inconsistency arising from the flush failure here. However, the undo\n+        // data may be inconsistent after a crash if the flush is called during\n+        // a reindex. A flush error might also leave some of the data files\n+        // untrimmed.\n+        if (!FlushBlockFile(!fKnown, finalize_undo)) {\n+            LogPrintf(\"Failed to flush previous block file %05i (finalize=%i, finalize_undo=%i) before opening new block file %05i\\n\", m_last_blockfile, !fKnown, finalize_undo, nFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1288925171",
      "id" : 1288925171,
      "line" : 679,
      "node_id" : "PRRC_kwDOABII585M02_z",
      "original_commit_id" : "7721ab9139013d70ef0f058754fabc5aaeda2246",
      "original_line" : 679,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 62,
      "pull_request_review_id" : 1570159243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288925171/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-10T10:23:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1288925171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1297313148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297313148"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1273739178\r\n\r\nI think this `return false` should be removed and replaced by a log print and comment, at least in this PR. Maybe a followup PR could try to change behavior in a bigger way, but it's not clear here that the intended change of returning false is here actually good, and that there aren't other unintended effects.\r\n\r\nIf a `FlatFileSeq::Flush` call fails, effectively meaning that an `fflush` or `ftruncate` call failed on block file (or undo file after the next commit), it's not clear to me that the new behavior of shutting down right away without trying to save state to disk is better than the old behavior of updating the block index, pruning old block files (which may free up disk space), and updating the coins database. This appears to be the intended change, and it does not seem to be a clear win. In general if there is some low level filesystem error which might be transient or spurious, it seems better to me for an application to handle it by at least trying to save its state than to just give up immediately and throw away data that's still in memory.\r\n\r\nI'm also concerned about possible unintended effects of this change because FlushStateToDisk is called so many places, that it's not clear what other effects are outside of this function if it now returns false instead of true.\r\n\r\nI like all the other changes in this PR of adding more return information and adding comments explaining error how errors are handled. And I wouldn't be even be surprised if it turns out the new behavior here is actually better than the old behavior in relevant cases. But I think if behavior is going to change, it should really be motivated by something specific like a bug report or test case, and ideally it should happen in a separate PR that doesn't mostly consist of code cleanup.",
      "commit_id" : "7721ab9139013d70ef0f058754fabc5aaeda2246",
      "created_at" : "2023-08-17T14:32:39Z",
      "diff_hunk" : "@@ -2505,7 +2505,9 @@ bool Chainstate::FlushStateToDisk(\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"write block and undo data to disk\", BCLog::BENCH);\n \n                 // First make sure all block and undo data is flushed to disk.\n-                m_blockman.FlushBlockFile();\n+                if (!m_blockman.FlushBlockFile()) {\n+                    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1297313148",
      "id" : 1297313148,
      "in_reply_to_id" : 1256378064,
      "line" : 2515,
      "node_id" : "PRRC_kwDOABII585NU218",
      "original_commit_id" : "d1c92b57a72b62ffa202f1d3d357b59befdc9c12",
      "original_line" : 2515,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 1582770374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297313148/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T15:39:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297313148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1297489117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297489117"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you retouch, the transition to severity-based logging will be easier if used when adding new ones. Probably choose between error or warning here; along with info, all 3 will be logged unconditionally by default, unless the user sets a custom severity level.\r\n\r\n```suggestion\r\n            LogPrintLevel(BCLog::BLOCKSTORAGE, BCLog::Level::Warning, \"Failed to flush previous block file %05i (finalize=%i, finalize_undo=%i) before opening new block file %05i\\n\", m_last_blockfile, !fKnown, finalize_undo, nFile);\r\n```",
      "commit_id" : "7721ab9139013d70ef0f058754fabc5aaeda2246",
      "created_at" : "2023-08-17T16:50:55Z",
      "diff_hunk" : "@@ -658,7 +667,17 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n         if (!fKnown) {\n             LogPrint(BCLog::BLOCKSTORAGE, \"Leaving block file %i: %s\\n\", m_last_blockfile, m_blockfile_info[m_last_blockfile].ToString());\n         }\n-        FlushBlockFile(!fKnown, finalize_undo);\n+\n+        // Do not propagate the return code. The flush concerns a previous block\n+        // and undo file that has already been written to. If a flush fails\n+        // here, and we crash, there is no expected additional block data\n+        // inconsistency arising from the flush failure here. However, the undo\n+        // data may be inconsistent after a crash if the flush is called during\n+        // a reindex. A flush error might also leave some of the data files\n+        // untrimmed.\n+        if (!FlushBlockFile(!fKnown, finalize_undo)) {\n+            LogPrintf(\"Failed to flush previous block file %05i (finalize=%i, finalize_undo=%i) before opening new block file %05i\\n\", m_last_blockfile, !fKnown, finalize_undo, nFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1297489117",
      "id" : 1297489117,
      "line" : 679,
      "node_id" : "PRRC_kwDOABII585NVhzd",
      "original_commit_id" : "7721ab9139013d70ef0f058754fabc5aaeda2246",
      "original_line" : 679,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 62,
      "pull_request_review_id" : 1583044655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297489117/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T16:56:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297489117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1297490048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297490048"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Idem as https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1297489117 if you retouch.",
      "commit_id" : "7721ab9139013d70ef0f058754fabc5aaeda2246",
      "created_at" : "2023-08-17T16:51:54Z",
      "diff_hunk" : "@@ -749,7 +768,14 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // with the block writes (usually when a synced up node is getting newly mined blocks) -- this case is caught in\n         // the FindBlockPos function\n         if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n-            FlushUndoFile(_pos.nFile, true);\n+            // Do not propagate the return code, a failed flush here should not\n+            // be an indication for a failed write. If it were propagated here,\n+            // the caller would assume the undo data not to be written, when in\n+            // fact it is. Note though, that a failed flush might leave the data\n+            // file untrimmed.\n+            if (!FlushUndoFile(_pos.nFile, true)) {\n+                LogPrintf(\"Failed to flush undo file %05i\\n\", _pos.nFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1297490048",
      "id" : 1297490048,
      "line" : 777,
      "node_id" : "PRRC_kwDOABII585NViCA",
      "original_commit_id" : "7721ab9139013d70ef0f058754fabc5aaeda2246",
      "original_line" : 777,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 78,
      "pull_request_review_id" : 1583046160,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297490048/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-17T16:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1297490048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1302972326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1302972326"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fwiw I think it is fine to change the behavior here but also don't mind if it's done in a follow-up. To me this just seems like a weird quirk given that we do return a fatal error for other flush operations.\r\n\r\nI think, a failed flush opens the node up to be crashed in any case, e.g.:\r\nhttps://github.com/bitcoin/bitcoin/blob/5aa67eb3655a0023f0cf115176fc8d5bac53cdcd/src/net_processing.cpp#L2217-L2219\r\n\r\nCleanly shutting down seems preferable.",
      "commit_id" : "7721ab9139013d70ef0f058754fabc5aaeda2246",
      "created_at" : "2023-08-23T12:54:08Z",
      "diff_hunk" : "@@ -2505,7 +2505,9 @@ bool Chainstate::FlushStateToDisk(\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"write block and undo data to disk\", BCLog::BENCH);\n \n                 // First make sure all block and undo data is flushed to disk.\n-                m_blockman.FlushBlockFile();\n+                if (!m_blockman.FlushBlockFile()) {\n+                    return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#discussion_r1302972326",
      "id" : 1302972326,
      "in_reply_to_id" : 1256378064,
      "line" : 2515,
      "node_id" : "PRRC_kwDOABII585Nqcem",
      "original_commit_id" : "d1c92b57a72b62ffa202f1d3d357b59befdc9c12",
      "original_line" : 2515,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 1591525089,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27866",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1302972326/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-23T12:57:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1302972326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Putting this back in draft while I address the change requests here.",
      "created_at" : "2023-08-29T19:37:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1698022394",
      "id" : 1698022394,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585lNcP6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1698022394/reactions"
      },
      "updated_at" : "2023-08-29T19:37:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1698022394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated 7721ab9139013d70ef0f058754fabc5aaeda2246 -> d8041d4e042957660827313951b18c8dd9a99a16 ([kernelReturnOnAbort_3](https://github.com/TheCharlatan/bitcoin/tree/kernelReturnOnAbort_3) -> [kernelReturnOnAbort_4](https://github.com/TheCharlatan/bitcoin/tree/kernelReturnOnAbort_4),  [compare](https://github.com/TheCharlatan/bitcoin/compare/kernelReturnOnAbort_3..kernelReturnOnAbort_4))\r\n\r\n* Removed early return in `FlushStateToDisk`, replaced it with a TODO comment and a log line.\r\n* Addressed @jonatack's comment, added severity-based logging.\r\n* Addressed @stickies-v's comment, splitting up long log line.",
      "created_at" : "2023-09-01T05:30:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1702186979",
      "id" : 1702186979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585ldU_j",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1702186979/reactions"
      },
      "updated_at" : "2023-09-01T05:30:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1702186979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re-ACK d8041d4\r\n\r\nI was okay with the validation logic change that we had before, but as I don't have a lot of familiarity with the complexities of `FlushStateToDisk` I am definitely okay with ryanofsky's suggestion to keep that for a later, more focused improvement and making this pretty much a no-brainer PR.",
      "created_at" : "2023-09-01T11:39:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27866#issuecomment-1702612290",
      "id" : 1702612290,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27866",
      "node_id" : "IC_kwDOABII585le81C",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1702612290/reactions"
      },
      "updated_at" : "2023-09-01T11:39:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1702612290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   }
]
