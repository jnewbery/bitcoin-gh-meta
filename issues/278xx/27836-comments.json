[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Approach ACK | [ismaelsadeeq](https://github.com/bitcoin/bitcoin/pull/27836#pullrequestreview-1483920481) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28055](https://github.com/bitcoin/bitcoin/pull/28055) (Bugfix: net_processing: Restore \"Already requested\" error for FetchBlock by luke-jr)\n* [#27837](https://github.com/bitcoin/bitcoin/pull/27837) (net: introduce block tracker to retry to download blocks after failure by furszy)\n* [#25722](https://github.com/bitcoin/bitcoin/pull/25722) (refactor: Use util::Result class for wallet loading by ryanofsky)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result failure values, multiple error and warning messages by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-06-07T18:43:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#issuecomment-1581333837",
      "id" : 1581333837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27836",
      "node_id" : "IC_kwDOABII585eQT1N",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1581333837/reactions"
      },
      "updated_at" : "2023-07-22T08:02:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1581333837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1232484014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232484014"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: feel free to ignore\r\n```suggestion\r\n    bool allow_limited_peers{false};\r\n``` ",
      "commit_id" : "31ae2d20da0800201376be71d41f19064edd3f92",
      "created_at" : "2023-06-16T16:33:43Z",
      "diff_hunk" : "@@ -1780,13 +1780,24 @@ std::optional<std::string> PeerManagerImpl::FetchBlock(NodeId peer_id, const CBl\n {\n     if (m_chainman.m_blockman.LoadingBlocks()) return \"Loading blocks ...\";\n \n+    // Only allow fetching from limited peers if the block height is within the allowed window\n+    bool allow_limited_peers = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1232484014",
      "id" : 1232484014,
      "line" : 1784,
      "node_id" : "PRRC_kwDOABII585Jdjau",
      "original_commit_id" : "e743efe691564840bcbf6353dc2c52904f74a852",
      "original_line" : 1784,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 20,
      "pull_request_review_id" : 1483920481,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232484014/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T17:08:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232484014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1232499541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232499541"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : " It would be nice to include a test specifically targeting the scenario of retrieving a block within the last 288 blocks from a Network Limited peer.\r\n\r\nThe 'prune' option cannot be set below 550 MiB, it is unclear whether it allows pruning to the last 288 blocks.\r\n( That is the possibility of a node not having any of the last 288 blocks ). \r\nWe could just exclude limited peers from fetching the blocks?",
      "commit_id" : "31ae2d20da0800201376be71d41f19064edd3f92",
      "created_at" : "2023-06-16T16:49:33Z",
      "diff_hunk" : "@@ -152,6 +153,19 @@ def run_test(self):\n         assert_equal(pruned_node.pruneblockchain(1000), pruneheight)\n         assert_raises_rpc_error(-1, \"Block not available (pruned data)\", pruned_node.getblock, pruned_block)\n \n+        ######################################################\n+        # Test reject fetching old block from a limited peer #\n+        ######################################################\n+\n+        self.log.info(\"Test reject fetching old block from limited peer\")\n+        pruned_node.add_p2p_connection(P2PInterface(), services=NODE_NETWORK_LIMITED | NODE_WITNESS)\n+        limited_peer_id = next(peer for peer in pruned_node.getpeerinfo() if peer[\"servicesnames\"] == ['WITNESS', 'NETWORK_LIMITED'])[\"id\"]\n+\n+        pruned_block_10 = self.nodes[0].getblockhash(10)\n+        assert_raises_rpc_error(-1, \"Cannot fetch old block from a limited peer\", pruned_node.getblockfrompeer, pruned_block_10, limited_peer_id)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1232499541",
      "id" : 1232499541,
      "line" : 169,
      "node_id" : "PRRC_kwDOABII585JdnNV",
      "original_commit_id" : "e743efe691564840bcbf6353dc2c52904f74a852",
      "original_line" : 166,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : 50,
      "pull_request_review_id" : 1483920481,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232499541/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T17:08:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232499541",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1232506679"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232506679"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        \"Returns the peer id we are requesting the block from if the request was successfully scheduled.\",\r\n```",
      "commit_id" : "31ae2d20da0800201376be71d41f19064edd3f92",
      "created_at" : "2023-06-16T16:56:28Z",
      "diff_hunk" : "@@ -435,7 +435,8 @@ static RPCHelpMan getblockfrompeer()\n         \"Returns an empty JSON object if the request was successfully scheduled.\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1232506679",
      "id" : 1232506679,
      "line" : 435,
      "node_id" : "PRRC_kwDOABII585Jdo83",
      "original_commit_id" : "31ae2d20da0800201376be71d41f19064edd3f92",
      "original_line" : 435,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 1,
      "pull_request_review_id" : 1483920481,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232506679/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T17:08:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232506679",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1233370820"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233370820"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> The 'prune' option cannot be set below 550 MiB, it is unclear whether it allows pruning to the last 288 blocks.\r\n( That is the possibility of a node not having any of the last 288 blocks ).\r\n\r\nHave you seen `FindFilesToPrune`?, `MIN_BLOCKS_TO_KEEP` prevents pruning from deleting files that contain a block within the last 288 range.",
      "commit_id" : "94e6eeabd9f20028d0d15cd74543a48ad06aa267",
      "created_at" : "2023-06-18T20:12:08Z",
      "diff_hunk" : "@@ -152,6 +153,19 @@ def run_test(self):\n         assert_equal(pruned_node.pruneblockchain(1000), pruneheight)\n         assert_raises_rpc_error(-1, \"Block not available (pruned data)\", pruned_node.getblock, pruned_block)\n \n+        ######################################################\n+        # Test reject fetching old block from a limited peer #\n+        ######################################################\n+\n+        self.log.info(\"Test reject fetching old block from limited peer\")\n+        pruned_node.add_p2p_connection(P2PInterface(), services=NODE_NETWORK_LIMITED | NODE_WITNESS)\n+        limited_peer_id = next(peer for peer in pruned_node.getpeerinfo() if peer[\"servicesnames\"] == ['WITNESS', 'NETWORK_LIMITED'])[\"id\"]\n+\n+        pruned_block_10 = self.nodes[0].getblockhash(10)\n+        assert_raises_rpc_error(-1, \"Cannot fetch old block from a limited peer\", pruned_node.getblockfrompeer, pruned_block_10, limited_peer_id)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1233370820",
      "id" : 1233370820,
      "in_reply_to_id" : 1232499541,
      "line" : 169,
      "node_id" : "PRRC_kwDOABII585Jg77E",
      "original_commit_id" : "e743efe691564840bcbf6353dc2c52904f74a852",
      "original_line" : 166,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : 50,
      "pull_request_review_id" : 1485184448,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233370820/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-18T20:13:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233370820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1233371214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233371214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Updated, thanks",
      "commit_id" : "94e6eeabd9f20028d0d15cd74543a48ad06aa267",
      "created_at" : "2023-06-18T20:15:33Z",
      "diff_hunk" : "@@ -435,7 +435,8 @@ static RPCHelpMan getblockfrompeer()\n         \"Returns an empty JSON object if the request was successfully scheduled.\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1233371214",
      "id" : 1233371214,
      "in_reply_to_id" : 1232506679,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Jg8BO",
      "original_commit_id" : "31ae2d20da0800201376be71d41f19064edd3f92",
      "original_line" : 435,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 1485184829,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233371214/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-18T20:15:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233371214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1233840589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233840589"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh yeah, the MIN_BLOCKS_TO_KEEP are protected from pruning, all pruned nodes retain the last 288 blocks. \r\nLimited peers should just be excluded from fetching blocks, unless there are any cases where the last 288 blocks might not be available?",
      "commit_id" : "94e6eeabd9f20028d0d15cd74543a48ad06aa267",
      "created_at" : "2023-06-19T10:11:11Z",
      "diff_hunk" : "@@ -152,6 +153,19 @@ def run_test(self):\n         assert_equal(pruned_node.pruneblockchain(1000), pruneheight)\n         assert_raises_rpc_error(-1, \"Block not available (pruned data)\", pruned_node.getblock, pruned_block)\n \n+        ######################################################\n+        # Test reject fetching old block from a limited peer #\n+        ######################################################\n+\n+        self.log.info(\"Test reject fetching old block from limited peer\")\n+        pruned_node.add_p2p_connection(P2PInterface(), services=NODE_NETWORK_LIMITED | NODE_WITNESS)\n+        limited_peer_id = next(peer for peer in pruned_node.getpeerinfo() if peer[\"servicesnames\"] == ['WITNESS', 'NETWORK_LIMITED'])[\"id\"]\n+\n+        pruned_block_10 = self.nodes[0].getblockhash(10)\n+        assert_raises_rpc_error(-1, \"Cannot fetch old block from a limited peer\", pruned_node.getblockfrompeer, pruned_block_10, limited_peer_id)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1233840589",
      "id" : 1233840589,
      "in_reply_to_id" : 1232499541,
      "line" : 169,
      "node_id" : "PRRC_kwDOABII585JiunN",
      "original_commit_id" : "e743efe691564840bcbf6353dc2c52904f74a852",
      "original_line" : 166,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : 50,
      "pull_request_review_id" : 1485886686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233840589/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T10:11:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233840589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I would much prefer an approach where this is handled by the existing background block fetches, because that one is aware of which peers have which blocks, and can load balance across this, and re-issue on timeout etc.\n\nIt would make the functionality also usable for e.g. redownloading for wallet rescan after pruning or so.",
      "created_at" : "2023-06-19T12:32:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#issuecomment-1597105856",
      "id" : 1597105856,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27836",
      "node_id" : "IC_kwDOABII585fMebA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1597105856/reactions"
      },
      "updated_at" : "2023-06-19T12:36:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1597105856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1234023590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234023590"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Limited peers should just be excluded from fetching blocks, unless there are any cases where the last 288 blocks might not be available?\r\n\r\nNot yet. Basically, one of the features that have locally for the on-going #21267 working path, is to be able to sync-up the node on-demand by doing `getblockfrompeer` requests instead of using the node's automatic sync process. Which is later used for the filters matching block requests too.\r\n\r\nSaid that, no problem on excluding limited peers for now. We could enable them later, when the new feature is introduced.",
      "commit_id" : "94e6eeabd9f20028d0d15cd74543a48ad06aa267",
      "created_at" : "2023-06-19T12:54:00Z",
      "diff_hunk" : "@@ -152,6 +153,19 @@ def run_test(self):\n         assert_equal(pruned_node.pruneblockchain(1000), pruneheight)\n         assert_raises_rpc_error(-1, \"Block not available (pruned data)\", pruned_node.getblock, pruned_block)\n \n+        ######################################################\n+        # Test reject fetching old block from a limited peer #\n+        ######################################################\n+\n+        self.log.info(\"Test reject fetching old block from limited peer\")\n+        pruned_node.add_p2p_connection(P2PInterface(), services=NODE_NETWORK_LIMITED | NODE_WITNESS)\n+        limited_peer_id = next(peer for peer in pruned_node.getpeerinfo() if peer[\"servicesnames\"] == ['WITNESS', 'NETWORK_LIMITED'])[\"id\"]\n+\n+        pruned_block_10 = self.nodes[0].getblockhash(10)\n+        assert_raises_rpc_error(-1, \"Cannot fetch old block from a limited peer\", pruned_node.getblockfrompeer, pruned_block_10, limited_peer_id)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#discussion_r1234023590",
      "id" : 1234023590,
      "in_reply_to_id" : 1232499541,
      "line" : 169,
      "node_id" : "PRRC_kwDOABII585JjbSm",
      "original_commit_id" : "e743efe691564840bcbf6353dc2c52904f74a852",
      "original_line" : 166,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/rpc_getblockfrompeer.py",
      "position" : 50,
      "pull_request_review_id" : 1486169270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27836",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234023590/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T12:54:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234023590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I would much prefer an approach where this is handled by the existing background block fetches, because that one is aware of which peers have which blocks, and can load balance across this, and re-issue on timeout etc.\r\n\r\nGuess that you are talking about the random peer selection part? Like, you are expecting to have a set of \"retry\" blocks in net_processing, so `FindNextBlocksToDownload` can take one of those, mark it as in-flight, request it to a peer, and track the timeout etc (like what you suggested in #27652)\r\n\r\nBecause, that is implemented in the follow-up #27837, in a slightly different way. With a `BlockRequestTracker` class, which does a bit more; with a pending requests queue instead of the retry set (I coded your suggestion first and IIRC, what didn't convince me was the need to be continually traversing the retry set to see if any of those timed out).\r\n\r\nThe purpose of this PR was to limit the scope of the initial changes to `getblockfrompeer` so that the user is aware of the source from which the block is initially being fetched, without introducing additional functionality beyond that. Then, in #27837, the tracking aspect is implemented, along with a fallback mechanism to handle cases where the initial fetch fails, and other related functionalities.\r\n\r\nBut.. thinking further, what if instead of returning the initial peer id, we return the tracking request id from `getblockfrompeer`, then extend the command to return information about tracked block requests. With this, we wouldn't need the random peer selection changes (nor most of the changes here), everything will be contained inside the background fetching logic. Which means that focus would be directly on #27837.\r\nThe only drawback of this approach is that the \"fetch from any\" functionality will not be available until the entire `BlockRequestTracker` class is introduced. Which I think that is fine.\r\n\r\nWhat do you think?\r\n\r\n---\r\n\r\nSide note about the tracker class:\r\nMy idea is to start with this `getblockfrompeer` scenario, so we can add proper test coverage for the class, and then expand it to track what is currently being tracked by `mapBlocksInFlight` (which involves few more changes like the peer stalling detection).\r\n\r\n> It would make the functionality also usable for e.g. redownloading for wallet rescan after pruning or so.\r\n\r\nYeah. That one, and the rescan by using compact block filters, are my long-term goals.",
      "created_at" : "2023-06-19T14:23:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#issuecomment-1597284064",
      "id" : 1597284064,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27836",
      "node_id" : "IC_kwDOABII585fNJ7g",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1597284064/reactions"
      },
      "updated_at" : "2023-06-19T14:40:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1597284064",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@furszy Thanks for giving some background, I do see better where this is coming from now.\r\n\r\nBut yes, my thinking is that it's the wrong approach to assign block requests to random peers, for multiple reasons:\r\n* It doesn't take into account which peer has what.\r\n* If it gets assigned incorrectly, there is no way to recover by retrying from another peer (on timeout or disconnect).\r\n* It ignores the existing information we have about currently outstanding block requests to peers (e.g. we may wish to avoid requesting from peers which already have many unanswered block requests).\r\n\r\nAnd it seemed to me that tacking something on, without reusing the existing logic for downloading and tracking blocks, seemed both unnecessary and inferior to me.\r\n\r\nHowever, thinking about it more, I realize there is perhaps something I missed, if that's an intended use case: downloading blocks we don't have a block header for. All the existing logic in FindNextBlockToDownload, the reasoning about which peers have what, and the timeout logic/tracking around block downloading in general is based on identifying blocks using their entry in the block index. For downloading blocks just by hash, very little of that is reusable. So perhaps the right (eventual) approach is actually treating these two separately: redownloading of known blocks using the existing logic, but downloading of unknown blocks using a new mechanism.\r\n\r\nRegarding identification of tracking requests: is there a need for that? For normal IBD/sync, there is no such functionality either. Perhaps I'm missing the use case for this. If you do need an identifier to track (re)download requests, what about using the block hash itself? Multiple redownload requests for the same block don't make sense anyway.",
      "created_at" : "2023-06-19T14:53:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#issuecomment-1597329260",
      "id" : 1597329260,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27836",
      "node_id" : "IC_kwDOABII585fNU9s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1597329260/reactions"
      },
      "updated_at" : "2023-06-19T14:53:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1597329260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks sipa for all the feedback!\r\n\r\n> @furszy Thanks for giving some background, I do see better where this is coming from now.\r\n> \r\n> But yes, my thinking is that it's the wrong approach to assign block requests to random peers, for multiple reasons:\r\n> \r\n> * It doesn't take into account which peer has what.\r\n> * If it gets assigned incorrectly, there is no way to recover by retrying from another peer (on timeout or disconnect).\r\n> * It ignores the existing information we have about currently outstanding block requests to peers (e.g. we may wish to avoid requesting from peers which already have many unanswered block requests).\r\n> \r\n> And it seemed to me that tacking something on, without reusing the existing logic for downloading and tracking blocks, seemed both unnecessary and inferior to me.\r\n\r\nOk yeah, now I see the full picture, and agree.\r\nFor manually requested blocks, #27837 introduces most of those points while re-using the existing downloading logic. It just need few adjustments.\r\n\r\n> However, thinking about it more, I realize there is perhaps something I missed, if that's an intended use case: downloading blocks we don't have a block header for. All the existing logic in FindNextBlockToDownload, the reasoning about which peers have what, and the timeout logic/tracking around block downloading in general is based on identifying blocks using their entry in the block index. For downloading blocks just by hash, very little of that is reusable. So perhaps the right (eventual) approach is actually treating these two separately: redownloading of known blocks using the existing logic, but downloading of unknown blocks using a new mechanism.\r\n\r\nHmm, yeah.\r\nRight now, it is not possible to call `getblockfrompeer` with a hash of an unknown block. But, might be useful to enable it in the future. The tracking mechanism being introduced in #27837 can help with the timeouts, disconnections and even to set a max number of download attempts or a request TTL.\r\n\r\n> Regarding identification of tracking requests: is there a need for that? For normal IBD/sync, there is no such functionality either. Perhaps I'm missing the use case for this. If you do need an identifier to track (re)download requests, what about using the block hash itself? Multiple redownload requests for the same block don't make sense anyway.\r\n\r\nYeah, no.. I had one of those fake epiphanies, probably originated by a lack of caffeine in my system.. block requests are tracked by hash in #27837. So we can easily retrieve their tracking information with it.\r\n\r\n---\r\n\r\nSo, to summarize:\r\n\r\nIâm going to decouple the commit that prevents users from calling `getblockfrompeer` with a network limited peer id into another PR (bugfix). Close this one, and adjust #27837 so it also handles the initial peer selection (removing the random selection). This is because the existing download logic is used in 27837 when the initial download attempt fails.",
      "created_at" : "2023-06-19T16:18:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#issuecomment-1597453546",
      "id" : 1597453546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27836",
      "node_id" : "IC_kwDOABII585fNzTq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1597453546/reactions"
      },
      "updated_at" : "2023-07-18T21:20:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1597453546",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Work implemented in #27837. Closing.",
      "created_at" : "2023-08-02T12:28:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27836#issuecomment-1662121821",
      "id" : 1662121821,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27836",
      "node_id" : "IC_kwDOABII585jEfdd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1662121821/reactions"
      },
      "updated_at" : "2023-08-02T12:29:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1662121821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
