[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This is currently giving me somewhat lower feerate estimates on mainnet -- 173sat/vb becomes 142sat/vb for 4 blocks, 82sat/vb becomes 65sat/vb for 25 blocks. Not sure if that's fixing a bug, or introducing a bug though -- I don't *think* it's noise, because I'm also seeing a reduction when running the estimates against the fixed fee_estimates dat I had in #13990.\r\n\r\nEDIT: at first glance looks like these fee differences were due to the mishandling of fail buckets morcos describes below",
      "created_at" : "2021-02-12T13:21:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-778192028",
      "id" : 778192028,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3ODE5MjAyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-13T04:04:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/778192028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Nice find on the bug and I think you've more or less identified the problem (I think I recapped it below)\r\n\r\nHowever I believe there are 2 issues with your potential fix.\r\n1) I think there is a new quadratic behavior now where if there are consistently not enough transactions in the buckets, you'll count up all the buckets to determine that, and then again all the buckets except the top one and so on...   Or some lesser variation on that if there are enough transactions at some point.  Not sure if thats actually a problem.\r\n\r\n2) I believe in your code you now only extend bucket ranges to achieve the required number of transactions, whereas the old code extended bucket ranges for that reason OR if the current buckets were failing.  It's that second condition that caused the bug because the bucket ranges didn't always match between targets, BUT I believe its important not to just eliminate that.  The reason the search for passing buckets continues even after you find a failing bucket is that you don't want to allow for the possibility that a small number of stuck transactions at a high feerate can peg fee estimates to be stuck at a high level.  Your code still solves for that, but it now completely ignores those failed transactions which I fear could lead to a different type of manipulation where a very low bucket of just enough transactions could be confirmed and it would cause the estimator to return artificially low estimates even if the vast majority of transactions at higher fee rates were not being confirmed.  \r\n\r\nI'll try to check IRC over the next few days if you want to ping me to discuss further.  A solution is not immediately apparent to me.   It's possible that the best solution is to just relax the requirement that fee rates have to be monotonically decreasing as confirmation target increases.   These are edge cases where it's not clear which answer would be better anyway.  I think the monotonic requirement was good as a QA check, but at this point may be causing more harm than good.\r\n\r\n\r\n\r\nProblem recap:  \r\nImagine only 2 buckets and an 85% threshold: \r\nfeerate: 100 sat/vb has 2/2 transactions confirmed within a target of 3 blocks (same within a target of 4 blocks.)\r\nfeerate: 150 sat/vb has 84/100 transactions confirmed within a target of 3 blocks and 85/100 transactions within 4 blocks.\r\n\r\nThe estimate for 3-block target fails at 150 sat/vb but passes when you add in the 100 sat/vb bucket, so it returns a median fee somewhere in the middle of those 2 buckets. \r\n\r\nOn the other hand the estimate for the 4-block target passes at 150 sat/vb, but then does not have enough data at 100 sat/vb alone and fails.  So it returns a median fee in the 150 sat/vb bucket (HIGHER than the rate for the 3-block target)",
      "created_at" : "2021-02-12T15:59:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-778280467",
      "id" : 778280467,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3ODI4MDQ2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-12T15:59:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/778280467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=4",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "node_id" : "MDQ6VXNlcjQzNjAzNDk=",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@morcos Yes, that makes sense! I think I'm only looking at each bucket once (`bucket` is always what I'm looking at, and it's only decremented never reset/incremented), so there shouldn't be quadratic behaviour -- though it was getting late so what was in my head may not match what was in my editor...\r\n\r\nAgree that the new code is ignoring high feerate failures now and that that is wrong; I think I've got an idea how to fix that, will see about updating the PR over the weekend.",
      "created_at" : "2021-02-13T02:14:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-778546332",
      "id" : 778546332,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3ODU0NjMzMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-13T02:14:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/778546332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated -- I traded in my hatchet for a scalpel; think this should exactly fix the problem.",
      "created_at" : "2021-02-13T07:43:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-778578214",
      "id" : 778578214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3ODU3ODIxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-13T07:43:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/778578214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Problem recap:\r\n> Imagine only 2 buckets and an 85% threshold:\r\n> feerate: 100 sat/vb has 2/2 transactions confirmed within a target of 3 blocks (same within a target of 4 blocks.)\r\n> feerate: 150 sat/vb has 84/100 transactions confirmed within a target of 3 blocks and 85/100 transactions within 4 blocks.\r\n> \r\n> The estimate for 3-block target fails at 150 sat/vb but passes when you add in the 100 sat/vb bucket, so it returns a median fee somewhere in the middle of those 2 buckets.\r\n\r\nI think in this case the 4-block target would calculate:\r\n\r\n  * 150 sat/vb has 85/100 -- passing, 150sat/vb is good\r\n  * 100 sat/vb has 2/2 -- ~also passing, 100sat/vb is good~ [EDIT: fails because `2 < 0.5/(1-0.962) ~= 26.3`]\r\n  * median value is in the 100 sat/vb bucket\r\n\r\nand 3-block target would say:\r\n\r\n  * 150 sat/vb has 84/100 -- not passing, extend\r\n  * 100 sat/vb has (84+2)/(100+2) -- passing\r\n  * median fee is in the 150 sat/vb bucket\r\n  \r\nbut that just gives a higher fee to the lower target which is correct.\r\n\r\nI think the actual bug needs more than 2 buckets, so that you get:\r\n\r\n  * 200-250 sat/vb buckets; 3-block / 4-block: failing\r\n  * 190-250 sat/vb buckets: 3-block failing, 4-block: passing\r\n\r\nat which point they start locking at separate bucket sets, and get: \r\n \r\n  * 3-blocks: 180-250 sat/vb buckets: 3-block passing\r\n  * 3-blocks: 0-170 sat/vb: not enough info\r\n  * 4-blocks: 0-190 sat/vb: not enough info\r\n\r\nat which point 3-blocks is locking for a median in 180-250 sat/vb while 4 blocks is looking for a median in 190-250 sat/vb and the higher target can get a higher fee rate.",
      "created_at" : "2021-02-13T07:56:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-778579772",
      "id" : 778579772,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3ODU3OTc3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T02:55:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/778579772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK on initial, non-expert look and `test/functional/feature_fee_estimation.py --randomseed 108574360997204915` passes with this patch. I need to study this code more.",
      "created_at" : "2021-02-15T17:41:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-779369146",
      "id" : 779369146,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTM2OTE0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T17:41:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779369146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ah, perhaps I misread on the quadratic issues.   \r\n\r\nNot that it really matters, but I think both of our recaps of the problem were not quite right.  In the first part of your recap, the count for sufficient number of transactions resets when a passing bucket is found so 100 sat/vb would not be passing for a 4-block target.   but you are right that in my version the 3-block target would find the median fee in the 150 bucket which would still be ok.    So yeah something like your more complicated scenario is probably what happens.\r\n\r\nWhat you've done with a5e33d3b782d33dc71653912e2d370f9a06b79e4 looks like it should work.  I'd be a little worried there is some unintended consequence though.  What I would have done in the past with a change like this is to run the fee estimator through historical transaction and block data and then look at places where the new and old differed and make sure that I thought the difference made sense.   Not sure how easy that is for anyone to do right now.",
      "created_at" : "2021-02-15T19:55:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-779422357",
      "id" : 779422357,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTQyMjM1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T19:55:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779422357",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=4",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "node_id" : "MDQ6VXNlcjQzNjAzNDk=",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Don't have historical data but i've been running an `estimatesmartfee` (on 1, 3, 6, 12, 24, 48 and 100) every 15 seconds on both this branch and master for some time (~15 hours).\r\n\r\nHere are my findings so far, this branch seems to give constantly increasing and higher estimates and i believe there is definitely something wrong with estimates for large targets.\r\n\r\n## 1 block target\r\n![1_block](https://user-images.githubusercontent.com/22457751/108594499-a9636580-737a-11eb-9a9c-5559f8eccffc.png)\r\n\r\n## 3 blocks target\r\n![3_blocks](https://user-images.githubusercontent.com/22457751/108594511-ba13db80-737a-11eb-86c2-c4b0adbbdcca.png)\r\n\r\n## 6 blocks\r\n![6_blocks](https://user-images.githubusercontent.com/22457751/108594516-c26c1680-737a-11eb-98fe-a0ee2b01ab00.png)\r\n\r\n## 12 blocks\r\n![12_blocks](https://user-images.githubusercontent.com/22457751/108594521-c730ca80-737a-11eb-85b2-fda1699b6fe5.png)\r\n\r\n## 24 blocks\r\n![24_blocks](https://user-images.githubusercontent.com/22457751/108594525-cd26ab80-737a-11eb-8f60-5024ce1da2d6.png)\r\n\r\n## 48 blocks\r\n![48_blocks](https://user-images.githubusercontent.com/22457751/108594528-d1eb5f80-737a-11eb-8a14-bcab661e4081.png)\r\n\r\n## 100 blocks\r\n![100_blocks](https://user-images.githubusercontent.com/22457751/108594531-d57ee680-737a-11eb-95d8-eae18afb1184.png)\r\n\r\n## points\r\n\r\nGithub won't let me upload a csv, so here:\r\n- http://download.darosior.ninja/estimates_21161_02-20.csv\r\n- http://download.darosior.ninja/estimates_21161_02-21.csv\r\n- http://download.darosior.ninja/estimates_master_02-20.csv (messed up master's one for 02/21)",
      "created_at" : "2021-02-20T11:56:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-782614132",
      "id" : 782614132,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MjYxNDEzMg==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/782614132/reactions"
      },
      "updated_at" : "2021-02-21T10:44:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/782614132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21161#discussion_r726646611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21161"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/726646611"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `that meet`",
      "commit_id" : "a5e33d3b782d33dc71653912e2d370f9a06b79e4",
      "created_at" : "2021-10-11T23:37:49Z",
      "diff_hunk" : "@@ -223,6 +223,11 @@ double TxConfirmStats::EstimateMedianVal(int confTarget, double sufficientTxVal,\n     unsigned int curFarBucket = maxbucketindex;\n     unsigned int bestFarBucket = maxbucketindex;\n \n+    // We'll always group buckets into sets tha meets sufficientTxVal --",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#discussion_r726646611",
      "id" : 726646611,
      "line" : 226,
      "node_id" : "PRRC_kwDOABII584rT79T",
      "original_commit_id" : "a5e33d3b782d33dc71653912e2d370f9a06b79e4",
      "original_line" : 226,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 4,
      "pull_request_review_id" : 776771533,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21161",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/726646611/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-11T23:41:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/726646611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased so tests can update.\r\n\r\n@darosior I'm not seeing the behaviour you did (and what you saw doesn't make sense to me). For me, duplicating node state, and starting two nodes, one with this pr, and one without it, I see fee rates tracking each other pretty precisely. I've put my data in a [google sheet](https://docs.google.com/spreadsheets/d/1mFZC1vTBJ5T_m96AzQMvivPtppuYdgm_ppmnzgxaE9E/edit?usp=sharing) (the pr21161 log has ~12 less entries than the master one, so they're up to 10 minutes out of sync by the end).",
      "created_at" : "2022-09-02T12:42:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-1235457664",
      "id" : 1235457664,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "IC_kwDOABII585Jo5aA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235457664/reactions"
      },
      "updated_at" : "2022-09-02T12:42:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235457664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--8ac04cdde196e94527acabf64b896448-->\nThere hasn't been much activity lately. What is the status here?\n\n[Finding reviewers](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#finding-reviewers) may take time. However, if the patch is no longer relevant, please close this pull request. If the author lost interest or time to work on this, please close it and mark it 'Up for grabs' with the label, so that it can be picked up in the future.\n",
      "created_at" : "2023-03-12T01:17:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-1465064320",
      "id" : 1465064320,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "IC_kwDOABII585XUxuA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1465064320/reactions"
      },
      "updated_at" : "2023-03-12T01:17:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1465064320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/21161).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [glozow](https://github.com/bitcoin/bitcoin/pull/21161#pullrequestreview-1671505906), [jonatack](https://github.com/bitcoin/bitcoin/pull/21161#pullrequestreview-1672764590), [ismaelsadeeq](https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-1759975077) |\n| Concept ACK | [darosior](https://github.com/bitcoin/bitcoin/pull/21161#pullrequestreview-589458908), [meshcollider](https://github.com/bitcoin/bitcoin/pull/21161#pullrequestreview-776771533) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-03-21T11:49:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-1477699553",
      "id" : 1477699553,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "IC_kwDOABII585YE-fh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1477699553/reactions"
      },
      "updated_at" : "2023-10-12T16:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1477699553",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Approach ACK\r\n\r\nWhat I understand from the discussion and the code, the issue this PR is solving is that intermittently `CBlockPolicyEstimator` returns higher fee estimates for higher confirmation targets, but as confirmation target increases the fee estimate suppose to decrease.\r\n\r\nThis occurs because of the way the `CBlockPolicyEstimator` `estimateMedianVal` works.\r\n\r\n1. `estimateMedianVal` keeps accumulating fee rate buckets until the total fee rates in the accumulated buckets reaches the `sufficientTxVal` (number of fee rates enough to make a valid fee estimate)\r\n\r\n2. \r\n    i) If number of fee rates in the range of the buckets after the accumulations did not meet the success threshold we keep accumulating fee rate buckets until we reach the success threshold, then reset the number of fee rates we have and go to step 1.\r\n\r\n   ii)Else if number the fee rates in the range of the accumulated bucket met the success threshold, we reset the number of fee rates we have go to step 1.\r\n\r\nHence the the number of fee rates (bucket ranges) that we use to determine the success threshold sometimes overlaps the `sufficientTxVal` which means bucket ranges are not consistent for some confirmation targets.\r\nWe end up having a high fee for a higher confirmation target.\r\n\r\nI will expand on the example @ajtowns gave to show how this occurs\r\n\r\n\r\nAssuming\r\nSuccess threshold = 85%\r\n`sufficientTxVal` = 40 fee rates\r\n\r\n\r\n<details> \r\n<summary>Our fee rate buckets data points are: </summary>\r\n\r\nFeerate Bucket | Txs | 3 Conf target Conf Txs | 4 Conf target Conf Txs\r\n--- | --- | --- | ---\r\n200-250 s/vb | 40 | 32 |32\r\n190-199 s/vb | 30 | 25 |28\r\n180-189 s/vb | 38 | 35 |35\r\n170-179 s/vb | 0 | 0 |0\r\n160-169 s/vb | 0 | 0 |0\r\n    \r\n</details>\r\nOn Master\r\n\r\n<details> \r\n<summary>Confirmation Target: 3</summary>\r\n\r\nFeerate Bucket | Txs | Conf Txs | Success Rate Calculation | Result\r\n--- | --- | --- | --- | ---\r\n200-250 s/vb | 40 | 32 | 32/40 = 80% | Failed - Does not meet threshold\r\n190-199 s/vb | 30 | 25 | (32+25) / (40+30) = 81.4% | Failed - Does not meet threshold\r\n180-189 s/vb | 38 | 35 | (32 + 25 + 35) / (40 + 30 + 38) = 85.1% | Passed\r\n170-179 s/vb | 0 | 0 | Does not reach `sufficientTxVal` | Failed \r\n160-169 s/vb | 0 | 0 | Does not reach `sufficientTxVal` | Failed\r\n\r\n**Median Fee:** 180-250 Fee rate bucket\r\n\r\n</details>\r\n\r\n<details> \r\n<summary>Confirmation Target: 4</summary>\r\n\r\nFeerate Bucket | Txs | Conf Txs | Success Rate Calculation | Result\r\n--- | --- | --- | --- | ---\r\n200-250 s/vb | 40 | 32 | 32/ 40 = 80% | Failed - Does not meet threshold\r\n190-199 s/vb | 30 | 28 | (32 + 28) / (40 + 30) = 85.7% | Passed\r\n180-189 s/vb | 38 | 35 | Failed Does not reach `sufficientTxVal` | Failed\r\n170-179 s/vb | 0 | 0 | Does not reach `sufficientTxVal` | Failed\r\n160-169 s/vb | 0 | 0 | Does not reach `sufficientTxVal` | Failed \r\n\r\n**Median Fee:** 190-250 Fee rate bucket\r\n\r\n</details>\r\n\r\nConfirmation target 4 fee rate will end up being higher than 3.\r\n\r\n\r\nWith this PR \r\nBuckets ranges are consistent i.e. once we reach the `sufficientTxVal` of 40 and did not meet success rate we dont keep accumulating we start counting a new `sufficientTxVal`.\r\n\r\n<details> \r\n<summary>Confirmation Target 3 will then be</summary>\r\n \r\n\r\nFeerate Bucket | Txs | Conf Txs | Success Rate Calculation | Result\r\n--- | --- | --- | --- | ---\r\n200-250 s/vb | 40 | 32 | 32/40 = 80% | Failed - Does not meet threshold\r\n190-199 s/vb | 30 | 25 | Does not reach `sufficientTxVal` | Failed\r\n180-189 s/vb | 38 | 35 | (25 + 35) / (30 + 38) = 88.2% | Passed\r\n170-179 s/vb | 0 | 0 | Does not reach `sufficientTxVal`  | Failed \r\n160-169 s/vb | 0 | 0 | Does not reach `sufficientTxVal`  | Failed \r\n\r\n**Median Fee:** 180-199 \r\n\r\n</details>\r\n\r\n<details> \r\n<summary>Confirmation Target 4 will also be</summary>\r\n\r\nFeerate Bucket | Txs | Conf Txs | Success Rate Calculation | Result\r\n--- | --- | --- | --- | ---\r\n200-250 s/vb | 40 | 32 | 32/40 = 80% | Failed - Does not meet threshold\r\n190-199 s/vb | 30 | 28 |  Does not reach `sufficientTxVal` | Failed\r\n180-189 s/vb | 38 | 35 | (28 + 35) / (30 + 38) = 92.6% | Passed\r\n170-179 s/vb | 0 | 0 | Does not reach `sufficientTxVal`  | Failed\r\n160-169 s/vb | 0 | 0 | Does not reach `sufficientTxVal`  | Failed\r\n\r\n**Median Fee:** 180-199 Fee rate bucket\r\n\r\n</details>\r\n\r\nHence it is will not be higher because.\r\n\r\n>These bucket ranges are consistent regardless of what the      target is, since the total number of transactions isn't different.\r\n\r\nThe above example also indicates that the number of transactions will not change [Txs column] irrespective of confirmation target, the bucket range and the data points are the same and will not overlap.\r\n\r\nAlso originally for e.g given a bucket range of 200-250 with 40 transactions, the confirmed transactions of target 2 is 32, then the number of confirmed transactions for target 3 above must be 32 above.\r\n\r\nThis PR ensures the fee estimate will decrease monotonically as the confirmation target increases.\r\n\r\nI will test the fee estimate in this branch against the fee estimate on master to see if there is much difference, but I don't think this will bring any unintended results though given this [extensive test](https://docs.google.com/spreadsheets/d/1mFZC1vTBJ5T_m96AzQMvivPtppuYdgm_ppmnzgxaE9E/edit?usp=sharing)",
      "created_at" : "2023-10-02T12:20:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-1742914334",
      "id" : 1742914334,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "IC_kwDOABII585n4sMe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 2,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1742914334/reactions"
      },
      "updated_at" : "2023-10-02T12:35:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1742914334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK a5e39d325da4eeb9273fb7c919fcbfbc721ed75d\r\nTo test this PR I have created another rpc `estimatesmartfeecons` that uses consistent bucket ranges, that is a5e39d325da4eeb9273fb7c919fcbfbc721ed75d  version of `estimatemedianval` I made sure thats the only diff between `estimatesmartfeecons` and `estimatesmartfee` (which uses the default master `estimatemedianval`).\r\nI then run a script that gets the fee estimates with the two rpc's after every 10 minutes from block `811834` to `811844`.\r\nFee estimates are pretty much the same and consistent. [see here](https://docs.google.com/spreadsheets/d/1qioubTwBOnXTG0lPH3QgLxgQ0bgiYkwHPBiUQG89V8I/edit?usp=sharing)",
      "created_at" : "2023-10-12T16:38:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21161#issuecomment-1759975077",
      "id" : 1759975077,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21161",
      "node_id" : "IC_kwDOABII585o5xal",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1759975077/reactions"
      },
      "updated_at" : "2023-10-12T16:38:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1759975077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48946461?v=4",
         "events_url" : "https://api.github.com/users/ismaelsadeeq/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ismaelsadeeq/followers",
         "following_url" : "https://api.github.com/users/ismaelsadeeq/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ismaelsadeeq/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ismaelsadeeq",
         "id" : 48946461,
         "login" : "ismaelsadeeq",
         "node_id" : "MDQ6VXNlcjQ4OTQ2NDYx",
         "organizations_url" : "https://api.github.com/users/ismaelsadeeq/orgs",
         "received_events_url" : "https://api.github.com/users/ismaelsadeeq/received_events",
         "repos_url" : "https://api.github.com/users/ismaelsadeeq/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ismaelsadeeq/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ismaelsadeeq/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ismaelsadeeq"
      }
   }
]
