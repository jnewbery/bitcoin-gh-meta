[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29491).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29803](https://github.com/bitcoin/bitcoin/pull/29803) (Update libsecp256k1 subtree to latest master by fanquake)\n* [#29745](https://github.com/bitcoin/bitcoin/pull/29745) (bench: Adds a benchmark for CheckInputScripts by kevkevinpal)\n* [#29675](https://github.com/bitcoin/bitcoin/pull/29675) (wallet: Be able to receive and spend inputs involving MuSig2 aggregate keys by achow101)\n* [#28122](https://github.com/bitcoin/bitcoin/pull/28122) (Silent Payments: Implement BIP352 by josibake)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2024-02-27T17:06:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29491#issuecomment-1967171280",
      "id" : 1967171280,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29491",
      "node_id" : "IC_kwDOABII5851QKbQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1967171280/reactions"
      },
      "updated_at" : "2024-04-06T06:59:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1967171280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--85328a0da195eb286784d51f73fa0af9-->\n\nð§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/22041704016</sub>",
      "created_at" : "2024-02-27T17:11:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29491#issuecomment-1967190805",
      "id" : 1967190805,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29491",
      "node_id" : "IC_kwDOABII5851QPMV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1967190805/reactions"
      },
      "updated_at" : "2024-02-27T17:11:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1967190805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I guess this is most interesting to test against the last 50K blocks on mainnet, i.e. since early 2023? Given the high percentage of taproot transactions. Such testing could benefit from a assume utxo snapshot, saving everyone the pain of rewinding. I can bake one, though ideally I'd like #26045 to land first.\r\n\r\nIs the current PR already using batches? It's unclear to me by glancing over `validation.cpp` if and how it's collecting up to `max_batch_size{106}` signatures before calling `batch.Verify()`.\r\n\r\nMaybe add a `-schnorrbatchverify` startup argument so more people can try it once it gets through review.",
      "created_at" : "2024-02-28T09:40:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29491#issuecomment-1968590438",
      "id" : 1968590438,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29491",
      "node_id" : "IC_kwDOABII5851Vk5m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1968590438/reactions"
      },
      "updated_at" : "2024-02-28T09:41:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1968590438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I guess this is most interesting to test against the last 50K blocks on mainnet, i.e. since early 2023? Given the high percentage of taproot transactions. Such testing could benefit from a assume utxo snapshot, saving everyone the pain of rewinding. I can bake one, though ideally I'd like #26045 to land first.\r\n\r\nYeah, that would be great. I have to get the tracing part to work in my setup again before I can start.\r\n\r\n> Is the current PR already using batches? It's unclear to me by glancing over `validation.cpp` if and how it's collecting up to `max_batch_size{106}` signatures before calling `batch.Verify()`.\r\n\r\nYes, the rough architecture is as as follows (sorry for not writing a better explanation above but it's still very rough and I expect it to change). So, the [`batch` object is constructed](https://github.com/bitcoin/bitcoin/pull/29491/commits/0a5e6128680c8b4f43fcb2d0450d41d5e4603c9d#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98R2401) and then [handed down from `ConnectBlock()` to `CheckInputScripts()`](https://github.com/bitcoin/bitcoin/pull/29491/commits/0a5e6128680c8b4f43fcb2d0450d41d5e4603c9d#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98R2454) which [hands it to the `CScriptCheck` constructor](https://github.com/bitcoin/bitcoin/pull/29491/commits/0a5e6128680c8b4f43fcb2d0450d41d5e4603c9d#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98R1961). When the [`CScriptCheck` instance is executed](https://github.com/bitcoin/bitcoin/pull/29491/commits/0a5e6128680c8b4f43fcb2d0450d41d5e4603c9d#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98R1863) and the batch object is present [`BatchingCachingTransactionSignatureChecker` is used](https://github.com/bitcoin/bitcoin/pull/29491/commits/0a5e6128680c8b4f43fcb2d0450d41d5e4603c9d#diff-0618dae2990d096e96e0283f7ab8cee069469f1ce603b58c0bb289e154f3aa17R40) which only differs from the default `CachingTransactionSignatureChecker` in that its [implementation of `VerifySchnorrSignature()`](https://github.com/bitcoin/bitcoin/pull/29491/commits/0a5e6128680c8b4f43fcb2d0450d41d5e4603c9d#diff-612abe4a74f2e9f6903cebff057d47bfe4f8a57507c175743f4b62fde0d3cc58R132) and adds the Schnorr sig to the `batch` object instead of verifying it right there. (Here we have an issue because the function is not doing what the name says anymore but it is a much simpler change this way and I find it hard to predict where we will land with this in the end.) Then [back in `ConnectBlock()` the `batch` object is verified](https://github.com/bitcoin/bitcoin/pull/29491/commits/0a5e6128680c8b4f43fcb2d0450d41d5e4603c9d#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98R2489) after all transactions have been iterated over.\r\n\r\nThe 106 is an implementation detail from `secp256k1` that I am not sure needs to be really exposed here. But what matters for the question is: if there are more than 106 sigs added to the batch the verification for the already added sigs will happen when the next sig is added and if the verification fails the adding itself will fail. So, a callback to the last paragraph, every 106 sigs the naming of `VerifySchnorrSignature()` is actually still correct ;) and the one verify call in the end just verifies the last n % 106 sigs left for that block. I did not put any effort in documenting this properly here yet because the `secp256k1` API is not finalized yet and the details on this particular topic might still change, see for example https://github.com/bitcoin-core/secp256k1/pull/1134#pullrequestreview-1083948472\r\n\r\nEverything should be conditional on the presence of a `batch` object which defaults to `nullptr` and if that is the case all the other functions should work as usual, for example when used outside of the context of a new block.\r\n\r\n> Maybe add a `-schnorrbatchverify` startup argument so more people can try it once it gets through review.\r\n\r\nYeah, I have been thinking that or maybe even a compiler argument",
      "created_at" : "2024-02-28T12:53:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29491#issuecomment-1968923056",
      "id" : 1968923056,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29491",
      "node_id" : "IC_kwDOABII5851W2Gw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1968923056/reactions"
      },
      "updated_at" : "2024-02-28T15:59:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1968923056",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@Sjors maybe what confused you is that `BatchingCachingTransactionSignatureChecker::VerifySchnorrSignatureBatch()` was unused. That was actually a leftover from an earlier design spike and I just forgot to remove it. It's gone now.",
      "created_at" : "2024-02-28T13:14:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29491#issuecomment-1968959800",
      "id" : 1968959800,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29491",
      "node_id" : "IC_kwDOABII5851W_E4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1968959800/reactions"
      },
      "updated_at" : "2024-02-28T13:14:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1968959800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> if there are more than 106 sigs added to the batch the verification for the already added sigs will happen when the next sig is added and if the verification fails the adding itself will fail.\r\n\r\nThat clarifies a lot, and should be documented :-)",
      "created_at" : "2024-02-28T13:36:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29491#issuecomment-1969001095",
      "id" : 1969001095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29491",
      "node_id" : "IC_kwDOABII5851XJKH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1969001095/reactions"
      },
      "updated_at" : "2024-02-28T13:36:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1969001095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2024-04-06T10:26:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29491#issuecomment-2041041664",
      "id" : 2041041664,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29491",
      "node_id" : "IC_kwDOABII5855p9MA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2041041664/reactions"
      },
      "updated_at" : "2024-04-06T10:26:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2041041664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
