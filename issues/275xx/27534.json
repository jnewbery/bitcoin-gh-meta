{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "Introduce a new RPC, `getnetmsgstats` to retrieve network message statistics. This work addresses https://github.com/bitcoin/bitcoin/issues/26337. More information on the RPC design and implementation can be found in that issue.\r\n\r\n**_Massive_** thank-you to amitiuttarwar, vasild, and ajtowns for their help on this :pray: Over the course of several months, they have patiently provided a tremendous amount of guidance and assistance in more ways than I can count! \r\n\r\n-------\r\n\r\n## getnetmsgstats RPC\r\nReturns the message count and total number of bytes for sent and received network traffic. Results may optionally be arranged by direction, network, connection type and/or message type.\r\n\r\n### Arguments\r\n\r\n**show_only**: an optional array of one or more dimensions to show as part of the results. Valid options are: direction, network, message_type, and connection_type. If no dimensions are specified, totals are returned.\r\n\r\n\r\n## Examples\r\n\r\nBelow are some examples on how the new `getnetmsgstats` RPC can be used.\r\n\r\n<details>\r\n  <summary>getnetmsgstats</summary>\r\n\r\n```\r\n ./src/bitcoin-cli getnetmsgstats\r\n{\r\n  \"totals\": {\r\n    \"message_count\": 1905,\r\n    \"byte_count\": 818941962\r\n  }\r\n}\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>getnetmsgstats '[\"conntype\",\"msgtype\"]'</summary>\r\n\r\n```\r\n./src/bitcoin-cli getnetmsgstats '[\"conntype\",\"msgtype\"]'\r\n{\r\n  \"block-relay-only\": {\r\n    \"addrv2\": {\r\n      \"message_count\": 1,\r\n      \"byte_count\": 40\r\n    },\r\n    \"block\": {\r\n      \"message_count\": 6,\r\n      \"byte_count\": 9899426\r\n    },\r\n    \"cmpctblock\": {\r\n      \"message_count\": 1,\r\n      \"byte_count\": 16615\r\n    },\r\n    \"feefilter\": {\r\n      \"message_count\": 1,\r\n      \"byte_count\": 32\r\n    },\r\n    \"getdata\": {\r\n      \"message_count\": 1,\r\n      \"byte_count\": 241\r\n    },\r\n    \"getheaders\": {\r\n      \"message_count\": 4,\r\n      \"byte_count\": 4212\r\n    },\r\n    \"headers\": {\r\n      \"message_count\": 10,\r\n      \"byte_count\": 1303\r\n    },\r\n    \"inv\": {\r\n      \"message_count\": 6,\r\n      \"byte_count\": 366\r\n    },\r\n    \"ping\": {\r\n      \"message_count\": 4,\r\n      \"byte_count\": 128\r\n    },\r\n    \"pong\": {\r\n      \"message_count\": 4,\r\n      \"byte_count\": 128\r\n    },\r\n    \"sendaddrv2\": {\r\n      \"message_count\": 4,\r\n      \"byte_count\": 96\r\n    },\r\n    \"sendcmpct\": {\r\n      \"message_count\": 6,\r\n      \"byte_count\": 198\r\n    },\r\n    \"sendheaders\": {\r\n      \"message_count\": 4,\r\n      \"byte_count\": 96\r\n    },\r\n    \"verack\": {\r\n      \"message_count\": 4,\r\n      \"byte_count\": 96\r\n    },\r\n    \"version\": {\r\n      \"message_count\": 4,\r\n      \"byte_count\": 507\r\n    },\r\n    \"wtxidrelay\": {\r\n      \"message_count\": 4,\r\n      \"byte_count\": 96\r\n    }\r\n  },\r\n  \"outbound-full-relay\": {\r\n    \"addr\": {\r\n      \"message_count\": 6,\r\n      \"byte_count\": 30302\r\n    },\r\n    \"addrv2\": {\r\n      \"message_count\": 10,\r\n      \"byte_count\": 76016\r\n    },\r\n    \"blocktxn\": {\r\n      \"message_count\": 1,\r\n      \"byte_count\": 1288086\r\n    },\r\n    \"cmpctblock\": {\r\n      \"message_count\": 1,\r\n      \"byte_count\": 16615\r\n    },\r\n    \"feefilter\": {\r\n      \"message_count\": 15,\r\n      \"byte_count\": 480\r\n    },\r\n    \"getaddr\": {\r\n      \"message_count\": 8,\r\n      \"byte_count\": 192\r\n    },\r\n    \"getblocktxn\": {\r\n      \"message_count\": 1,\r\n      \"byte_count\": 2515\r\n    },\r\n    \"getdata\": {\r\n      \"message_count\": 79,\r\n      \"byte_count\": 16951\r\n    },\r\n    \"getheaders\": {\r\n      \"message_count\": 15,\r\n      \"byte_count\": 15795\r\n    },\r\n    \"headers\": {\r\n      \"message_count\": 20,\r\n      \"byte_count\": 2039\r\n    },\r\n    \"inv\": {\r\n      \"message_count\": 134,\r\n      \"byte_count\": 58826\r\n    },\r\n    \"notfound\": {\r\n      \"message_count\": 7,\r\n      \"byte_count\": 787\r\n    },\r\n    \"other\": {\r\n      \"message_count\": 6,\r\n      \"byte_count\": 438\r\n    },\r\n    \"ping\": {\r\n      \"message_count\": 15,\r\n      \"byte_count\": 480\r\n    },\r\n    \"pong\": {\r\n      \"message_count\": 14,\r\n      \"byte_count\": 448\r\n    },\r\n    \"sendaddrv2\": {\r\n      \"message_count\": 10,\r\n      \"byte_count\": 240\r\n    },\r\n    \"sendcmpct\": {\r\n      \"message_count\": 19,\r\n      \"byte_count\": 627\r\n    },\r\n    \"sendheaders\": {\r\n      \"message_count\": 14,\r\n      \"byte_count\": 336\r\n    },\r\n    \"tx\": {\r\n      \"message_count\": 398,\r\n      \"byte_count\": 211333\r\n    },\r\n    \"verack\": {\r\n      \"message_count\": 16,\r\n      \"byte_count\": 384\r\n    },\r\n    \"version\": {\r\n      \"message_count\": 17,\r\n      \"byte_count\": 2151\r\n    },\r\n    \"wtxidrelay\": {\r\n      \"message_count\": 10,\r\n      \"byte_count\": 240\r\n    }\r\n  }\r\n}\r\n```\r\n</details>\r\n\r\n\r\n<details>\r\n<summary>getnetmsgstats '[\"network\", \"direction\", \"connection_type\", \"message_type\"]'</summary>\r\n\r\n```\r\n./src/bitcoin-cli getnetmsgstats '[\"network\", \"direction\", \"connection_type\", \"message_type\"]'\r\n{\r\n  \"ipv4\": {\r\n    \"received\": {\r\n      \"block-relay-only\": {\r\n        \"addrv2\": {\r\n          \"message_count\": 5,\r\n          \"byte_count\": 227\r\n        },\r\n        \"block\": {\r\n          \"message_count\": 6,\r\n          \"byte_count\": 9899426\r\n        },\r\n        \"cmpctblock\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 25184\r\n        },\r\n        \"feefilter\": {\r\n          \"message_count\": 1,\r\n          \"byte_count\": 32\r\n        },\r\n        \"getheaders\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 2106\r\n        },\r\n        \"headers\": {\r\n          \"message_count\": 6,\r\n          \"byte_count\": 1041\r\n        },\r\n        \"inv\": {\r\n          \"message_count\": 3,\r\n          \"byte_count\": 183\r\n        },\r\n        \"ping\": {\r\n          \"message_count\": 6,\r\n          \"byte_count\": 192\r\n        },\r\n        \"pong\": {\r\n          \"message_count\": 6,\r\n          \"byte_count\": 192\r\n        },\r\n        \"sendaddrv2\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 48\r\n        },\r\n        \"sendcmpct\": {\r\n          \"message_count\": 3,\r\n          \"byte_count\": 99\r\n        },\r\n        \"sendheaders\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 48\r\n        },\r\n        \"verack\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 48\r\n        },\r\n        \"version\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 253\r\n        },\r\n        \"wtxidrelay\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 48\r\n        }\r\n      },\r\n      \"outbound-full-relay\": {\r\n        \"addr\": {\r\n          \"message_count\": 4,\r\n          \"byte_count\": 30222\r\n        },\r\n        \"addrv2\": {\r\n          \"message_count\": 26,\r\n          \"byte_count\": 148422\r\n        },\r\n        \"blocktxn\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 3752987\r\n        },\r\n        \"cmpctblock\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 25184\r\n        },\r\n        \"feefilter\": {\r\n          \"message_count\": 11,\r\n          \"byte_count\": 352\r\n        },\r\n        \"getdata\": {\r\n          \"message_count\": 24,\r\n          \"byte_count\": 2184\r\n        },\r\n        \"getheaders\": {\r\n          \"message_count\": 11,\r\n          \"byte_count\": 11583\r\n        },\r\n        \"headers\": {\r\n          \"message_count\": 20,\r\n          \"byte_count\": 2120\r\n        },\r\n        \"inv\": {\r\n          \"message_count\": 275,\r\n          \"byte_count\": 116207\r\n        },\r\n        \"notfound\": {\r\n          \"message_count\": 9,\r\n          \"byte_count\": 981\r\n        },\r\n        \"other\": {\r\n          \"message_count\": 44,\r\n          \"byte_count\": 3430\r\n        },\r\n        \"ping\": {\r\n          \"message_count\": 20,\r\n          \"byte_count\": 640\r\n        },\r\n        \"pong\": {\r\n          \"message_count\": 20,\r\n          \"byte_count\": 640\r\n        },\r\n        \"sendaddrv2\": {\r\n          \"message_count\": 9,\r\n          \"byte_count\": 216\r\n        },\r\n        \"sendcmpct\": {\r\n          \"message_count\": 18,\r\n          \"byte_count\": 594\r\n        },\r\n        \"sendheaders\": {\r\n          \"message_count\": 11,\r\n          \"byte_count\": 264\r\n        },\r\n        \"tx\": {\r\n          \"message_count\": 1161,\r\n          \"byte_count\": 596142\r\n        },\r\n        \"verack\": {\r\n          \"message_count\": 12,\r\n          \"byte_count\": 288\r\n        },\r\n        \"version\": {\r\n          \"message_count\": 12,\r\n          \"byte_count\": 1536\r\n        },\r\n        \"wtxidrelay\": {\r\n          \"message_count\": 9,\r\n          \"byte_count\": 216\r\n        }\r\n      }\r\n    },\r\n    \"sent\": {\r\n      \"block-relay-only\": {\r\n        \"getdata\": {\r\n          \"message_count\": 1,\r\n          \"byte_count\": 241\r\n        },\r\n        \"getheaders\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 2106\r\n        },\r\n        \"headers\": {\r\n          \"message_count\": 6,\r\n          \"byte_count\": 474\r\n        },\r\n        \"inv\": {\r\n          \"message_count\": 3,\r\n          \"byte_count\": 183\r\n        },\r\n        \"ping\": {\r\n          \"message_count\": 6,\r\n          \"byte_count\": 192\r\n        },\r\n        \"pong\": {\r\n          \"message_count\": 6,\r\n          \"byte_count\": 192\r\n        },\r\n        \"sendaddrv2\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 48\r\n        },\r\n        \"sendcmpct\": {\r\n          \"message_count\": 3,\r\n          \"byte_count\": 99\r\n        },\r\n        \"sendheaders\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 48\r\n        },\r\n        \"verack\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 48\r\n        },\r\n        \"version\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 254\r\n        },\r\n        \"wtxidrelay\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 48\r\n        }\r\n      },\r\n      \"outbound-full-relay\": {\r\n        \"addr\": {\r\n          \"message_count\": 4,\r\n          \"byte_count\": 250\r\n        },\r\n        \"addrv2\": {\r\n          \"message_count\": 19,\r\n          \"byte_count\": 938\r\n        },\r\n        \"feefilter\": {\r\n          \"message_count\": 12,\r\n          \"byte_count\": 384\r\n        },\r\n        \"getaddr\": {\r\n          \"message_count\": 12,\r\n          \"byte_count\": 288\r\n        },\r\n        \"getblocktxn\": {\r\n          \"message_count\": 2,\r\n          \"byte_count\": 3883\r\n        },\r\n        \"getdata\": {\r\n          \"message_count\": 249,\r\n          \"byte_count\": 48813\r\n        },\r\n        \"getheaders\": {\r\n          \"message_count\": 12,\r\n          \"byte_count\": 12636\r\n        },\r\n        \"headers\": {\r\n          \"message_count\": 13,\r\n          \"byte_count\": 1297\r\n        },\r\n        \"inv\": {\r\n          \"message_count\": 464,\r\n          \"byte_count\": 166868\r\n        },\r\n        \"ping\": {\r\n          \"message_count\": 21,\r\n          \"byte_count\": 672\r\n        },\r\n        \"pong\": {\r\n          \"message_count\": 20,\r\n          \"byte_count\": 640\r\n        },\r\n        \"sendaddrv2\": {\r\n          \"message_count\": 9,\r\n          \"byte_count\": 216\r\n        },\r\n        \"sendcmpct\": {\r\n          \"message_count\": 13,\r\n          \"byte_count\": 429\r\n        },\r\n        \"sendheaders\": {\r\n          \"message_count\": 11,\r\n          \"byte_count\": 264\r\n        },\r\n        \"tx\": {\r\n          \"message_count\": 44,\r\n          \"byte_count\": 18966\r\n        },\r\n        \"verack\": {\r\n          \"message_count\": 12,\r\n          \"byte_count\": 288\r\n        },\r\n        \"version\": {\r\n          \"message_count\": 13,\r\n          \"byte_count\": 1651\r\n        },\r\n        \"wtxidrelay\": {\r\n          \"message_count\": 9,\r\n          \"byte_count\": 216\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n</details>\r\n\r\n## Things to consider\r\n\r\n### RPC behavior: Should we allow dimensions to be rearraged?\r\n\r\nWhen it comes time to gather up the RPC results, @vasild has provided an [alternate implementation](https://github.com/vasild/bitcoin/commits/getnetmsgstats) that uses an array instead of the `MultiMap` structure. This results in two changes:\r\n\r\n- using the stack over the heap (yay!)\r\n- enforcing a strict ordering of dimensions (direction, network, connection type, message type)\r\n\r\nAside from being good for memory, the reasoning here is allowing users to rearrange dimensions may be too confusing. I personally really like the ability to rearrange dimensions, which is why I have not integrated that solution into this PR, but am open to whatever the larger community prefers :)\r\n\r\n### Locking & Consistency Beyond Individual Values\r\n\r\nWith atomics, we know we can rely on the values for individual stats like bye count and message count. However, the byte count and message count may not always match. For example, letâs say we currently have 5 messages, and 100 bytes:\r\n\r\n    1. A new 20 byte message comes in. First the byte count is incremented to 120.\r\n    2. A request to read the stats comes in. The RPC returns message count 5 and byte count 120.\r\n    3. The message count is incremented to 6 in response to the new message that came in at step 1.\r\n\r\nThe read operation did not return accurate data! Unlike the torn write example for a single value, It returned data that was true for some point in time, itâs just that the values for message count and byte count were inconsistent.\r\n\r\nTo solve this, itâs actually not enough to lock the `MsgStat` struct. It's my understanding that you need a mutex to protect the entire `NetStats` data structure.\r\n\r\nThe trade off here isnât attractive. A lock would halt network threads that are doing important stuff, all for the sake of consistent stats. Even for reads, we would have to stop writes. Weâd end up stopping threads that are doing important things for something that is not that important.\r\n\r\nAnother thing to consider is how often will this RPC be called? If itâs once in a blue moon, then such a mutex is probably fine. But for a live dashboard that is making a call every second, this is not acceptable.\r\n\r\n### Making Enum Indices Safe and Reliable\r\n\r\n`src/net.cpp` contains a bunch of `*To/FromIndex()` methods that convert an enum to an index number. Iâve decided to be explicit about these conversions because enums are not guaranteed to start at zero and itâs not enough to simply associate the first value in an enum with a number. \r\n\r\nTo protect against potential gaps or overlaps in numbering, every single enum value must be assigned an index. This is the only way to guarantee that the numbering is safe and reliable. \r\n\r\nInstead of updating the existing `Network` and `ConnectionType` enums to assign indices to each enum value, and risk unintentionally modifying the behavior of code that uses these enums, Iâve opted for the conversion methods. This also narrows the scope of the conversion methods, making changed behavior easier to spot if the indices are modified.\r\n\r\nIâm interested in feedback on this. The `*To/FromIndex()` methods have low review and maintenance cost, but Iâm unsure if Iâve correctly evaluated the risks associated with updating the `Network` and `ConnectionType` enums <can insert an example of assigning specific indices to each enum value>. Also open to discussion on if there is a better place for these conversion methods to live.\r\n",
   "closed_at" : "2023-09-22T01:06:39Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/1823216?v=4",
      "events_url" : "https://api.github.com/users/satsie/events{/privacy}",
      "followers_url" : "https://api.github.com/users/satsie/followers",
      "following_url" : "https://api.github.com/users/satsie/following{/other_user}",
      "gists_url" : "https://api.github.com/users/satsie/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/satsie",
      "id" : 1823216,
      "login" : "satsie",
      "node_id" : "MDQ6VXNlcjE4MjMyMTY=",
      "organizations_url" : "https://api.github.com/users/satsie/orgs",
      "received_events_url" : "https://api.github.com/users/satsie/received_events",
      "repos_url" : "https://api.github.com/users/satsie/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/satsie/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/satsie/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/satsie"
   },
   "comments" : 10,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27534/comments",
   "created_at" : "2023-04-26T20:21:37Z",
   "draft" : true,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27534/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/27534",
   "id" : 1685662150,
   "labels" : [
      {
         "color" : "0052cc",
         "default" : false,
         "description" : null,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "node_id" : "MDU6TGFiZWw5ODI3OTE3Nw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      },
      {
         "color" : "cccccc",
         "default" : false,
         "description" : "",
         "id" : 955867938,
         "name" : "Needs rebase",
         "node_id" : "MDU6TGFiZWw5NTU4Njc5Mzg=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase"
      },
      {
         "color" : "cccccc",
         "default" : false,
         "description" : "",
         "id" : 5334691551,
         "name" : "CI failed",
         "node_id" : "LA_kwDOABII588AAAABPfju3w",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27534/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII585PO_KB",
   "number" : 27534,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/27534.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27534",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/27534.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27534"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27534/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27534/timeline",
   "title" : "rpc: add 'getnetmsgstats', new rpc to view network message statistics",
   "updated_at" : "2023-09-22T01:06:40Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27534",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/1823216?v=4",
      "events_url" : "https://api.github.com/users/satsie/events{/privacy}",
      "followers_url" : "https://api.github.com/users/satsie/followers",
      "following_url" : "https://api.github.com/users/satsie/following{/other_user}",
      "gists_url" : "https://api.github.com/users/satsie/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/satsie",
      "id" : 1823216,
      "login" : "satsie",
      "node_id" : "MDQ6VXNlcjE4MjMyMTY=",
      "organizations_url" : "https://api.github.com/users/satsie/orgs",
      "received_events_url" : "https://api.github.com/users/satsie/received_events",
      "repos_url" : "https://api.github.com/users/satsie/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/satsie/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/satsie/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/satsie"
   }
}
