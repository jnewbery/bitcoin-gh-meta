[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [D33r-Gee](https://github.com/bitcoin/bitcoin/pull/27596#pullrequestreview-1516971308) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28327](https://github.com/bitcoin/bitcoin/pull/28327) (RFC: remove clientversion.h usage from kernel by theuni)\n* [#28202](https://github.com/bitcoin/bitcoin/pull/28202) (Silent Payments: receiving by josibake)\n* [#28120](https://github.com/bitcoin/bitcoin/pull/28120) (p2p: make block download logic aware of limited peers threshold by furszy)\n* [#27866](https://github.com/bitcoin/bitcoin/pull/27866) (blockstorage: Return on fatal flush errors by TheCharlatan)\n* [#27837](https://github.com/bitcoin/bitcoin/pull/27837) (net: introduce block tracker to retry to download blocks after failure by furszy)\n* [#27827](https://github.com/bitcoin/bitcoin/pull/27827) (Silent Payments: send and receive by josibake)\n* [#27770](https://github.com/bitcoin/bitcoin/pull/27770) (Introduce 'getblockfileinfo' RPC command by furszy)\n* [#27277](https://github.com/bitcoin/bitcoin/pull/27277) (Move log messages: tx enqueue to mempool, allocation to blockstorage by Sjors)\n* [#26966](https://github.com/bitcoin/bitcoin/pull/26966) (index: blockfilter initial sync speedup, parallelize process by furszy)\n* [#26762](https://github.com/bitcoin/bitcoin/pull/26762) (bugfix: Make `CCheckQueue` RAII-styled (attempt 2) by hebasto)\n* [#25970](https://github.com/bitcoin/bitcoin/pull/25970) (Add headerssync tuning parameters optimization script to repo by sipa)\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-08T15:08:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1538523343",
      "id" : 1538523343,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585btADP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1538523343/reactions"
      },
      "updated_at" : "2023-08-25T22:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1538523343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "CI's passing after a silent conflict in the rebase. I've added a link to @Sjors' snapshot torrent in the PR description.\r\n\r\nNo known outstanding issues here; ready for testing!",
      "created_at" : "2023-05-08T17:26:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1538759099",
      "id" : 1538759099,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585bt5m7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1538759099/reactions"
      },
      "updated_at" : "2023-05-08T17:26:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1538759099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.",
      "created_at" : "2023-05-09T15:30:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1540397377",
      "id" : 1540397377,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585b0JlB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540397377/reactions"
      },
      "updated_at" : "2023-05-09T15:30:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540397377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "When running 8f431ad3b600a8f7e6dff83354ac3475b8936505 I noticed (and reproduced) that `-prune` is not fully honored when loading a snapshot and doing background validation. When I set `-prune=550` the blocks dir ends up somewhere between 3 and 5 GB. Judging by the blkâ¦.dat timestamps it seems that both the snapshot and background IBD hold on to more blocks than they should. Tested on Ubuntu 23.04 and with coinstats- and blockfilterindex enabled. The first time I tested I allowed the node to sync for a few hours before loading the snapshot, the second time I loaded the snapshot almost immediately.",
      "created_at" : "2023-05-10T07:10:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1541467462",
      "id" : 1541467462,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585b4O1G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1541467462/reactions"
      },
      "updated_at" : "2023-05-10T07:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1541467462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jamesob What's your feeling on how important figuring out the fix for the pruning issue is at the moment? People don't consider it blocking #24008, right? Just curious about where to spend review time right now. FWIW, I noted the same issue on `getblockfrompeer` and wrote a test for it back then, in case you haven't seen it, it might come in handy: https://github.com/bitcoin/bitcoin/pull/23813",
      "created_at" : "2023-05-10T12:58:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1542165949",
      "id" : 1542165949,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585b65W9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542165949/reactions"
      },
      "updated_at" : "2023-05-10T12:58:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542165949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> What's your feeling on how important figuring out the fix for the pruning issue is at the moment? People don't consider it blocking https://github.com/bitcoin/bitcoin/pull/24008, right?\r\n\r\nRight, pruning issues shouldn't block #24008 - those changes need to happen regardless of how we manage pruning with snapshots.\r\n\r\nI'll reproduce/investigate the pruning issues over the coming days. But it's worth noting that @Sjors didn't see any regressions in pruning on this branch _before_ loading the snapshot, meaning the degraded pruning behavior only kicks in if the user loads a snapshot. And even though, the code just doesn't prune as aggressively as it seems it should.",
      "created_at" : "2023-05-10T15:05:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1542375384",
      "id" : 1542375384,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585b7sfY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542375384/reactions"
      },
      "updated_at" : "2023-05-10T15:05:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542375384",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Hm, for what it's worth, pruning is working as expected for me on this branch.\r\n\r\n![image](https://github.com/bitcoin/bitcoin/assets/73197/95b5615a-f4ca-4af5-96e4-30969fdc6940)\r\n\r\n```\r\nEvery 2.0s: cat <(./src/bitcoin-cli -datadir=/home/james/tmp/bitcoin-au-testing getmempoolinfo) <( ./src/bitcoin-cli -datadir=/home/james/tmp/bitcoin-au-testing getchainstates)                                                                                                                                                                         fido: Wed May 10 11:16:49 2023\r\n\r\n{\r\n  \"loaded\": true,\r\n  \"size\": 108146,\r\n  \"bytes\": 42192499,\r\n  \"usage\": 234882016,\r\n  \"total_fee\": 23.04459003,\r\n  \"maxmempool\": 300000000,\r\n  \"mempoolminfee\": 0.00013381,\r\n  \"minrelaytxfee\": 0.00001000,\r\n  \"incrementalrelayfee\": 0.00001000,\r\n  \"unbroadcastcount\": 0,\r\n  \"fullrbf\": false\r\n}\r\n{\r\n  \"active_chain_type\": \"validated_snapshot\",\r\n  \"validated_snapshot\": {\r\n    \"blocks\": 789094,\r\n    \"bestblockhash\": \"00000000000000000002dad6b3cd82fc00075978eb0d63dcbf6bce3bdc2c3f32\",\r\n    \"difficulty\": 48005534313578.78,\r\n    \"verificationprogress\": 0.9999931560421257,\r\n    \"snapshot_blockhash\": \"00000000000000000001f3fa1b4c03c877740778f56b0d5456b18dd88f7f695e\",\r\n    \"initialblockdownload\": false,\r\n    \"coins_db_cache_bytes\": 8388608,\r\n    \"coins_tip_cache_bytes\": 11498684416,\r\n    \"has_mempool\": true\r\n  },\r\n  \"headers\": 789094\r\n}\r\n```\r\n\r\nWill attempt to repro with a fresh run, I guess?\r\n",
      "created_at" : "2023-05-10T15:17:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1542394306",
      "id" : 1542394306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585b7xHC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542394306/reactions"
      },
      "updated_at" : "2023-05-10T15:17:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542394306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-05-11T10:24:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1543736177",
      "id" : 1543736177,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cA4tx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543736177/reactions"
      },
      "updated_at" : "2023-05-11T10:24:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543736177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.",
      "created_at" : "2023-05-12T01:22:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1544970920",
      "id" : 1544970920,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cFmKo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544970920/reactions"
      },
      "updated_at" : "2023-05-12T01:22:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544970920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've done a number of runs here with some combination of indexing and pruning, and I think this is in about as good a shape as it can be, with the following caveat:\r\n\r\nWhen using assumeutxo with pruning and indexing, the snapshot chainstate cannot be pruned because of how we handle indexing during bg sync. Since the snapshot chainstate isn't indexed until after the background sync completes (in order to avoid out-of-order indexation), we aren't able to prune the snapshot chainstate based upon the prune blocks that the indices configure.\r\n\r\nSo the upshot of all this is that pruning, when used with assumeutxo and indexing, is basically best-effort. I think that's an okay state as long as we're clear about it to end users. Probably merits some kind of GUI alert which I think can be done later.\r\n\r\nAfter bg sync completes, we're in a pretty good state (`-blockfilterindex` + `-coinstatsindex` + `-prune=550`):\r\n```\r\n777M    /home/james/tmp/bitcoin-au-testing/blocks\r\ntotal 667M\r\ndrwx------ 3 james users 4.0K May 12 07:02 .\r\ndrwx------ 5 james users 4.0K May 12 10:34 ..\r\n-rw------- 1 james users 128M May 11 21:24 blk00014.dat\r\n-rw------- 1 james users 128M May 11 21:24 blk00015.dat\r\n-rw------- 1 james users 127M May 11 21:24 blk00016.dat\r\n-rw------- 1 james users 128M May 12 05:04 blk00017.dat\r\n-rw------- 1 james users  32M May 12 06:41 blk02910.dat\r\n-rw------- 1 james users  48M May 12 10:31 blk03593.dat\r\ndrwx------ 2 james users 4.0K May 12 10:34 index\r\n-rw------- 1 james users  18M May 11 21:24 rev00014.dat\r\n-rw------- 1 james users  18M May 11 21:24 rev00015.dat\r\n-rw------- 1 james users  18M May 11 21:24 rev00016.dat\r\n-rw------- 1 james users  16M May 12 05:04 rev00017.dat\r\n-rw------- 1 james users 3.3M May 12 06:41 rev02910.dat\r\n-rw------- 1 james users 6.0M May 12 10:31 rev03593.dat\r\n```\r\n\r\n---\r\n\r\nThrough the last few days of testing, I did find that I forgot to the divide the prune target by the number of chainstates outstanding, so that may have created some of the weirdness @Sjors was seeing. But otherwise I just think that enabling all these features together results in the necessary trade-off of blowing out the pruning budget.\r\n\r\nAlso worth noting that based on the current size of blocks over the last few weeks, the 244 block trailing prune window is potentially going to result in over 550MB of block data, which is our lowest allowable target.",
      "created_at" : "2023-05-12T14:43:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1545856135",
      "id" : 1545856135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cI-SH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545856135/reactions"
      },
      "updated_at" : "2023-05-12T14:43:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545856135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Here's a signet snapshot torrent: `magnet:?xt=urn:btih:0e1a61b4ed9a57c41d98f1ddd5061bc088c857b6&dn=utxo-signet-140000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`\r\n\r\nCan be added to `kernel/chainparams.cpp` with:\r\n\r\n```cpp\r\nm_assumeutxo_data = MapAssumeutxo{\r\n            {\r\n                140'000,\r\n                {AssumeutxoHash{uint256S(\"0x91412d7018c8564beef1938eef2bfe18feee53674fd26bea425daa4280437641\")}, 2233882},\r\n            },\r\n        };\r\n```\r\n\r\nThis basically gets you to the signet tip faster than you can hit enter :-)",
      "created_at" : "2023-05-16T10:42:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1549423309",
      "id" : 1549423309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cWlLN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1549423309/reactions"
      },
      "updated_at" : "2023-05-16T10:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1549423309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-05-17T19:12:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1551921618",
      "id" : 1551921618,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cgHHS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1551921618/reactions"
      },
      "updated_at" : "2023-05-17T19:12:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1551921618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1197159021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1197159021"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right now if a non-existing file path is passed, a rather cryptic error message appears:\r\n```\r\n$ ./src/bitcoin-cli loadtxoutset jslkdf \r\nerror code: -1\r\nerror message:\r\nCAutoFile::operator>>: file handle is nullptr: unspecified iostream_category error\r\n```\r\n\r\nShould ensure that `afile` is not null and throw an explicit error if it is (like `dumptxoutset` already does), e.g.:\r\n```suggestion\r\n    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\r\n    if (afile.IsNull()) {\r\n        throw JSONRPCError(\r\n            RPC_INVALID_PARAMETER,\r\n            \"Couldn't open file \" + path.u8string() + \" for reading.\");\r\n    }\r\n```",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-17T23:25:38Z",
      "diff_hunk" : "@@ -2700,6 +2700,86 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1197159021",
      "id" : 1197159021,
      "line" : 2727,
      "node_id" : "PRRC_kwDOABII585HWzJt",
      "original_commit_id" : "bbaa5812258e33ca8a5a63f28c7da6b1d78433a1",
      "original_line" : 2727,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 28,
      "pull_request_review_id" : 1431794725,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1197159021/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-18T00:37:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1197159021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for testing, @theStack!\r\n\r\n> So far so good, everything went quite smooth and nothing unexpected happened! The only disappointment was finding that apparently the provided prune target of 800MB was not respected:\r\n\r\nYes, this is unfortunately expected behavior. Since you have `-blockfilterindex` enabled and the background sync hasn't yet completed, prune locks are preventing any pruning from happening on the snapshot chainstate. I mentioned this obliquely here: https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1545856135\r\n\r\nThe only way around this would be to mark indexes which can be built out of order (i.e. everything except coinstats) and only halt snapshot indexation for those that can't. But this is something that could be done after the initial assumeutxo feature.\r\n",
      "created_at" : "2023-05-18T14:15:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1553127188",
      "id" : 1553127188,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585cktcU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553127188/reactions"
      },
      "updated_at" : "2023-05-18T14:15:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553127188",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : ">>So far so good, everything went quite smooth and nothing unexpected happened! The only disappointment was finding that apparently the provided prune target of 800MB was not respected:\r\n>\r\n>Yes, this is unfortunately expected behavior. Since you have -blockfilterindex enabled and the background sync hasn't yet completed, prune locks are preventing any pruning from happening on the snapshot chainstate. I mentioned this obliquely here: https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1545856135\r\n\r\n@jamesob: Thanks for clarifying (admittedly I didn't read your comment just a few posts above before posting my test results), it makes sense that we have to keep the blocks from the snapshot chainstate for the indexer at least until background sync completes. I'd agree that this is not a problem as long as it is clearly communicated to the user, e.g. by putting a well-visible warning into the `loadtxoutset` RPC help. The ultra-conservative approach here would be to simply throw an error if a snapshot is loaded on a node that was started with both pruning and an index enabled (if keeping the `-prune` target promise has absolute highest priority), but that seems to be too limiting.\r\n\r\n",
      "created_at" : "2023-05-22T23:55:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1558205497",
      "id" : 1558205497,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585c4FQ5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1558205497/reactions"
      },
      "updated_at" : "2023-05-22T23:55:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1558205497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2023-05-23T16:12:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1559752787",
      "id" : 1559752787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585c9_BT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559752787/reactions"
      },
      "updated_at" : "2023-05-23T16:12:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559752787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Cross-linking to some discussion on how we load the block index that @sdaftuar has surfaced: https://github.com/bitcoin/bitcoin/pull/23174/files#r1198450499\r\n\r\nIf anyone has encountered an issue like this while testing this branch, a comment would be welcome.",
      "created_at" : "2023-05-23T16:48:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1559813326",
      "id" : 1559813326,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585c-NzO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559813326/reactions"
      },
      "updated_at" : "2023-05-23T16:48:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559813326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "New bug, albeit pretty minor:\r\n\r\n- [x] ~~if you restart the node after activating the snapshot but before connecting any blocks to the snapshot chainstate, `ReadBlockFromDisk` checks fail when calling `VerifyDB()` during chainstate initialization. I'm not sure when this would happen in practice, but it's an annoying edge case.~~\r\n\r\nEdit: fixed this.",
      "created_at" : "2023-05-23T19:49:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1560035238",
      "id" : 1560035238,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585c_D-m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1560035238/reactions"
      },
      "updated_at" : "2023-05-25T20:08:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1560035238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.\r\n\r\nI've made a few changes/improvements that I think fixes the bug @sdaftuar found (not adding all potential tips to `setBlockIndexCandidates`), albeit I'm not yet integrating the changes in #27746.\r\n\r\n- More comprehensive functional tests: the tests now stop and start at more points throughout the sync process, including immediately after snapshot load and before bg validation completes.\r\n- We now include the blockhash of the snapshot base in `m_assumeutxo_data`; this allows us to move the `nChainTx` reconstruction where it belongs, into `BlockManager::LoadBlockIndex()`.\r\n- All blocks for which we have data (or are assumedvalid) are added to all chainstates' `setBlockIndexCandidates`.\r\n  - Some related changes in `CheckBlockIndex()` needed to be made to update some outdated assertions.\r\n\r\nI'm going to be taking a close look at @sdaftuar's proposed changes over the next few days to see if I can integrate them here.",
      "created_at" : "2023-05-25T20:16:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1563455744",
      "id" : 1563455744,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585dMHEA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563455744/reactions"
      },
      "updated_at" : "2023-05-25T20:16:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563455744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> All blocks for which we have data (or are assumedvalid) are added to all chainstates' setBlockIndexCandidates.\r\n\r\nBeing assumedvalid is unrelated to whether we should add an entry to `setBlockIndexCandidates`; `setBlockIndexCandidates` should have the current tip and any block for which we HAVE_DATA and for which we HAVE_DATA for all the blocks that we'd need to connect, in order to get from our current tip to that target block.  \r\n\r\nThe assumedvalid bit is really just something we're using to help with adjusting the invariants in `CheckBlockIndex()`; it should have no bearing on any of the actual validation logic outside of that.",
      "created_at" : "2023-05-25T22:13:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1563571639",
      "id" : 1563571639,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585dMjW3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563571639/reactions"
      },
      "updated_at" : "2023-05-25T22:13:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563571639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210211360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210211360"
         }
      },
      "author_association" : "NONE",
      "body" : "Getting `syntax error: operand expected (error token is \"\"30000\" + \"20000\"\")` on macOS\r\n```suggestion\r\nFINAL_HEIGHT=$(($BASE_HEIGHT + $INCREMENTAL_HEIGHT))\r\n```",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-30T12:38:57Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210211360",
      "id" : 1210211360,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585IIlwg",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 20,
      "pull_request_review_id" : 1450841472,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210211360/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T12:38:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210211360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/37130778?v=4",
         "events_url" : "https://api.github.com/users/alexanderwiederin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alexanderwiederin/followers",
         "following_url" : "https://api.github.com/users/alexanderwiederin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alexanderwiederin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alexanderwiederin",
         "id" : 37130778,
         "login" : "alexanderwiederin",
         "node_id" : "MDQ6VXNlcjM3MTMwNzc4",
         "organizations_url" : "https://api.github.com/users/alexanderwiederin/orgs",
         "received_events_url" : "https://api.github.com/users/alexanderwiederin/received_events",
         "repos_url" : "https://api.github.com/users/alexanderwiederin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alexanderwiederin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alexanderwiederin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alexanderwiederin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210212400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210212400"
         }
      },
      "author_association" : "NONE",
      "body" : "Missing the second \"t\" of \"Starting\"\r\n```suggestion\r\necho \"-- Starting the server node to provide blocks to the client node...\"\r\n```",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-30T12:39:49Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from.\n+CHAIN_HACK_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"\n+\n+server_rpc() {\n+  ./src/bitcoin-cli -rpcport=$SERVER_RPC_PORT -datadir=\"$SERVER_DATADIR\" \"$@\"\n+}\n+client_rpc() {\n+  ./src/bitcoin-cli -rpcport=$CLIENT_RPC_PORT -datadir=\"$CLIENT_DATADIR\" \"$@\"\n+}\n+server_sleep_til_boot() {\n+  while ! server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+client_sleep_til_boot() {\n+  while ! client_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+\n+mkdir -p \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+\n+echo \"Hi, welcome to the assumeutxo demo/test\"\n+echo\n+echo \"We're going to\"\n+echo\n+echo \"  - start up a 'server' node, sync it via mainnet IBD to height ${BASE_HEIGHT}\"\n+echo \"  - create a UTXO snapshot at that height\"\n+echo \"  - IBD ${INCREMENTAL_HEIGHT} more blocks on top of that\"\n+echo\n+echo \"then we'll demonstrate assumeutxo by \"\n+echo\n+echo \"  - starting another node (the 'client') and loading the snapshot in\"\n+echo \"    * first you'll have to modify the code slightly (chainparams) and recompile\"\n+echo \"    * don't worry, we'll make it easy\"\n+echo \"  - observing the client sync ${INCREMENTAL_HEIGHT} blocks on top of the snapshot from the server\"\n+echo \"  - observing the client validate the snapshot chain via background IBD\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- Starting the demo. You might want to run the two following commands in\"\n+echo \"   separate terminal windows:\"\n+echo\n+echo \"   watch -n0.1 tail -n 30 $SERVER_DATADIR/debug.log\"\n+echo \"   watch -n0.1 tail -n 30 $CLIENT_DATADIR/debug.log\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- IBDing the blocks (height=$BASE_HEIGHT) required to the server node...\"\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $CHAIN_HACK_FLAGS -stopatheight=\"$BASE_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Creating snapshot at ~ height $BASE_HEIGHT ($UTXO_DAT_FILE)...\"\n+sleep 2\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $CHAIN_HACK_FLAGS -connect=0 -listen=0 >/dev/null &\n+SERVER_PID=\"$!\"\n+\n+DUMP_OUTPUT=\"dumptxoutset-output-$BASE_HEIGHT.json\"\n+\n+server_sleep_til_boot\n+server_rpc dumptxoutset \"$UTXO_DAT_FILE\" > \"$DUMP_OUTPUT\"\n+cat \"$DUMP_OUTPUT\"\n+kill -9 \"$SERVER_PID\"\n+\n+RPC_BASE_HEIGHT=$(jq -r .base_height < \"$DUMP_OUTPUT\")\n+RPC_AU=$(jq -r .txoutset_hash < \"$DUMP_OUTPUT\")\n+RPC_NCHAINTX=$(jq -r .nchaintx < \"$DUMP_OUTPUT\")\n+RPC_BLOCKHASH=$(jq -r .base_hash < \"$DUMP_OUTPUT\")\n+\n+# Wait for server to shutdown...\n+while server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+\n+echo\n+echo \"-- Now: add the following to CMainParams::m_assumeutxo_data\"\n+echo \"   in src/kernel/chainparams.cpp, and recompile:\"\n+echo\n+echo \"   {${RPC_BASE_HEIGHT}, AssumeutxoHash{uint256S(\\\"0x${RPC_AU}\\\")}, ${RPC_NCHAINTX}, uint256S(\\\"0x${RPC_BLOCKHASH}\\\")},\"\n+echo\n+echo\n+echo \"-- IBDing more blocks to the server node (height=$FINAL_HEIGHT) so there is a diff between snapshot and tip...\"\n+./src/bitcoind $SERVER_PORTS -logthreadnames=1 -datadir=\"$SERVER_DATADIR\" \\\n+    $CHAIN_HACK_FLAGS -stopatheight=\"$FINAL_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Staring the server node to provide blocks to the client node...\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210212400",
      "id" : 1210212400,
      "line" : 141,
      "node_id" : "PRRC_kwDOABII585IImAw",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 141,
      "original_position" : 141,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 141,
      "pull_request_review_id" : 1450842970,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210212400/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T12:39:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210212400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/37130778?v=4",
         "events_url" : "https://api.github.com/users/alexanderwiederin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alexanderwiederin/followers",
         "following_url" : "https://api.github.com/users/alexanderwiederin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alexanderwiederin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alexanderwiederin",
         "id" : 37130778,
         "login" : "alexanderwiederin",
         "node_id" : "MDQ6VXNlcjM3MTMwNzc4",
         "organizations_url" : "https://api.github.com/users/alexanderwiederin/orgs",
         "received_events_url" : "https://api.github.com/users/alexanderwiederin/received_events",
         "repos_url" : "https://api.github.com/users/alexanderwiederin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alexanderwiederin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alexanderwiederin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alexanderwiederin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210397176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210397176"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Which version of Python are you using?",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-30T14:45:25Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210397176",
      "id" : 1210397176,
      "in_reply_to_id" : 1210211360,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585IJTH4",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 20,
      "pull_request_review_id" : 1451142607,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210397176/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T14:45:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210397176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210425053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210425053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@Sjors this is bash :). If he's on macOS, probably some kind of zsh?",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-30T15:05:14Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210425053",
      "id" : 1210425053,
      "in_reply_to_id" : 1210211360,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585IJZ7d",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 20,
      "pull_request_review_id" : 1451192866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210425053/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T15:05:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210425053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210488998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210488998"
         }
      },
      "author_association" : "MEMBER",
      "body" : "macOS ships an ancient version of bash",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-30T15:52:07Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1210488998",
      "id" : 1210488998,
      "in_reply_to_id" : 1210211360,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585IJpim",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 20,
      "pull_request_review_id" : 1451289875,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210488998/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T15:52:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1210488998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211504043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211504043"
         }
      },
      "author_association" : "NONE",
      "body" : "@jamesob line 1 (`#!/usr/bin/env bash`) sets the interpreter to Bash regardless of what the system default is.\r\n\r\n@MarcoFalke you were right! macOS comes with an outdated version of bash (`3.2.57`). I have updated to `5.2.15`. Script runs like a charm now. \r\n\r\nThanks for the help!",
      "commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "created_at" : "2023-05-31T10:41:26Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211504043",
      "id" : 1211504043,
      "in_reply_to_id" : 1210211360,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII585INhWr",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : 20,
      "pull_request_review_id" : 1452852799,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211504043/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T10:41:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211504043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/37130778?v=4",
         "events_url" : "https://api.github.com/users/alexanderwiederin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alexanderwiederin/followers",
         "following_url" : "https://api.github.com/users/alexanderwiederin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alexanderwiederin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alexanderwiederin",
         "id" : 37130778,
         "login" : "alexanderwiederin",
         "node_id" : "MDQ6VXNlcjM3MTMwNzc4",
         "organizations_url" : "https://api.github.com/users/alexanderwiederin/orgs",
         "received_events_url" : "https://api.github.com/users/alexanderwiederin/received_events",
         "repos_url" : "https://api.github.com/users/alexanderwiederin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alexanderwiederin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alexanderwiederin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alexanderwiederin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211763951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763951"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> @Sjors this is bash :)\r\n\r\n*bashes head against table*",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-05-31T13:56:41Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211763951",
      "id" : 1211763951,
      "in_reply_to_id" : 1210211360,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IOgzv",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : null,
      "pull_request_review_id" : 1453295026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763951/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T13:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211763951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211880620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880620"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-05-31T15:13:11Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))\n+\n+SERVER_DATADIR=\"$(pwd)/utxodemo-data-server-$BASE_HEIGHT\"\n+CLIENT_DATADIR=\"$(pwd)/utxodemo-data-client-$BASE_HEIGHT\"\n+UTXO_DAT_FILE=\"$(pwd)/utxo.$BASE_HEIGHT.dat\"\n+\n+# Chosen to try to not interfere with any running bitcoind processes.\n+SERVER_PORT=8633\n+SERVER_RPC_PORT=8632\n+\n+CLIENT_PORT=8733\n+CLIENT_RPC_PORT=8732\n+\n+SERVER_PORTS=\"-port=${SERVER_PORT} -rpcport=${SERVER_RPC_PORT}\"\n+CLIENT_PORTS=\"-port=${CLIENT_PORT} -rpcport=${CLIENT_RPC_PORT}\"\n+\n+# Ensure the client exercises all indexes.\n+ALL_INDEXES=\"-txindex -coinstatsindex -blockfilterindex=1\"\n+\n+if ! command -v jq >/dev/null ; then\n+  echo \"This script requires jq to parse JSON RPC output. Please install it.\"\n+  echo \"(e.g. sudo apt install jq)\"\n+  exit 1\n+fi\n+\n+finish() {\n+  echo\n+  echo \"Killing server and client PIDs ($SERVER_PID, $CLIENT_PID) and cleaning up datadirs\"\n+  echo\n+  rm -f \"$UTXO_DAT_FILE\" \"$DUMP_OUTPUT\"\n+  rm -rf \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+  kill -9 \"$SERVER_PID\" \"$CLIENT_PID\"\n+}\n+\n+trap finish EXIT\n+\n+# Need to specify these to trick client into accepting server as a peer\n+# it can IBD from.\n+CHAIN_HACK_FLAGS=\"-maxtipage=9223372036854775207 -minimumchainwork=0x00\"\n+\n+server_rpc() {\n+  ./src/bitcoin-cli -rpcport=$SERVER_RPC_PORT -datadir=\"$SERVER_DATADIR\" \"$@\"\n+}\n+client_rpc() {\n+  ./src/bitcoin-cli -rpcport=$CLIENT_RPC_PORT -datadir=\"$CLIENT_DATADIR\" \"$@\"\n+}\n+server_sleep_til_boot() {\n+  while ! server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+client_sleep_til_boot() {\n+  while ! client_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+}\n+\n+mkdir -p \"$SERVER_DATADIR\" \"$CLIENT_DATADIR\"\n+\n+echo \"Hi, welcome to the assumeutxo demo/test\"\n+echo\n+echo \"We're going to\"\n+echo\n+echo \"  - start up a 'server' node, sync it via mainnet IBD to height ${BASE_HEIGHT}\"\n+echo \"  - create a UTXO snapshot at that height\"\n+echo \"  - IBD ${INCREMENTAL_HEIGHT} more blocks on top of that\"\n+echo\n+echo \"then we'll demonstrate assumeutxo by \"\n+echo\n+echo \"  - starting another node (the 'client') and loading the snapshot in\"\n+echo \"    * first you'll have to modify the code slightly (chainparams) and recompile\"\n+echo \"    * don't worry, we'll make it easy\"\n+echo \"  - observing the client sync ${INCREMENTAL_HEIGHT} blocks on top of the snapshot from the server\"\n+echo \"  - observing the client validate the snapshot chain via background IBD\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- Starting the demo. You might want to run the two following commands in\"\n+echo \"   separate terminal windows:\"\n+echo\n+echo \"   watch -n0.1 tail -n 30 $SERVER_DATADIR/debug.log\"\n+echo \"   watch -n0.1 tail -n 30 $CLIENT_DATADIR/debug.log\"\n+echo\n+read -p \"Press [enter] to continue\" _\n+\n+echo\n+echo \"-- IBDing the blocks (height=$BASE_HEIGHT) required to the server node...\"\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $CHAIN_HACK_FLAGS -stopatheight=\"$BASE_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Creating snapshot at ~ height $BASE_HEIGHT ($UTXO_DAT_FILE)...\"\n+sleep 2\n+./src/bitcoind -logthreadnames=1 $SERVER_PORTS \\\n+    -datadir=\"$SERVER_DATADIR\" $CHAIN_HACK_FLAGS -connect=0 -listen=0 >/dev/null &\n+SERVER_PID=\"$!\"\n+\n+DUMP_OUTPUT=\"dumptxoutset-output-$BASE_HEIGHT.json\"\n+\n+server_sleep_til_boot\n+server_rpc dumptxoutset \"$UTXO_DAT_FILE\" > \"$DUMP_OUTPUT\"\n+cat \"$DUMP_OUTPUT\"\n+kill -9 \"$SERVER_PID\"\n+\n+RPC_BASE_HEIGHT=$(jq -r .base_height < \"$DUMP_OUTPUT\")\n+RPC_AU=$(jq -r .txoutset_hash < \"$DUMP_OUTPUT\")\n+RPC_NCHAINTX=$(jq -r .nchaintx < \"$DUMP_OUTPUT\")\n+RPC_BLOCKHASH=$(jq -r .base_hash < \"$DUMP_OUTPUT\")\n+\n+# Wait for server to shutdown...\n+while server_rpc ping >/dev/null 2>&1; do sleep 0.1; done\n+\n+echo\n+echo \"-- Now: add the following to CMainParams::m_assumeutxo_data\"\n+echo \"   in src/kernel/chainparams.cpp, and recompile:\"\n+echo\n+echo \"   {${RPC_BASE_HEIGHT}, AssumeutxoHash{uint256S(\\\"0x${RPC_AU}\\\")}, ${RPC_NCHAINTX}, uint256S(\\\"0x${RPC_BLOCKHASH}\\\")},\"\n+echo\n+echo\n+echo \"-- IBDing more blocks to the server node (height=$FINAL_HEIGHT) so there is a diff between snapshot and tip...\"\n+./src/bitcoind $SERVER_PORTS -logthreadnames=1 -datadir=\"$SERVER_DATADIR\" \\\n+    $CHAIN_HACK_FLAGS -stopatheight=\"$FINAL_HEIGHT\" >/dev/null\n+\n+echo\n+echo \"-- Staring the server node to provide blocks to the client node...\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211880620",
      "id" : 1211880620,
      "in_reply_to_id" : 1210212400,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IO9Ss",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 141,
      "original_position" : 141,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : null,
      "pull_request_review_id" : 1453503822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880620/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T15:13:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211880971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880971"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks all.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-05-31T15:13:24Z",
      "diff_hunk" : "@@ -0,0 +1,199 @@\n+#!/usr/bin/env bash\n+# Demonstrate the creation and usage of UTXO snapshots.\n+#\n+# A server node starts up, IBDs up to a certain height, then generates a UTXO\n+# snapshot at that point.\n+#\n+# The server then downloads more blocks (to create a diff from the snapshot).\n+#\n+# We bring a client up, load the UTXO snapshot, and we show the client sync to\n+# the \"network tip\" and then start a background validation of the snapshot it\n+# loaded. We see the background validation chainstate removed after validation\n+# completes.\n+#\n+\n+export LC_ALL=C\n+set -e\n+\n+BASE_HEIGHT=${1:-30000}\n+INCREMENTAL_HEIGHT=20000\n+FINAL_HEIGHT=$((\"$BASE_HEIGHT\" + \"$INCREMENTAL_HEIGHT\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1211880971",
      "id" : 1211880971,
      "in_reply_to_id" : 1210211360,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IO9YL",
      "original_commit_id" : "fc6299c8c23479e3596c68920fa2a576488119c6",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "contrib/devtools/test_utxo_snapshots.sh",
      "position" : null,
      "pull_request_review_id" : 1453504505,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880971/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T15:13:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1211880971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased\r\n\r\nAlso fixed the minor issues with the `test_utxo_snapshots.sh` demo script.\r\n\r\nSince last push, I've completed a full test of the mainnet snapshot; after a few days having finished the background sync, `-prune=550` (and everything else) working as expected.\r\n\r\n```\r\n759M    /home/james/tmp/bitcoin-au-testing/blocks\r\ntotal 650M\r\ndrwx------ 3 james users 4.0K May 31 10:54 .\r\ndrwx------ 5 james users 4.0K May 31 11:09 ..\r\n-rw------- 1 james users 127M May 29 15:33 blk03626.dat\r\n-rw------- 1 james users 128M May 30 02:38 blk03627.dat\r\n-rw------- 1 james users 128M May 30 17:29 blk03628.dat\r\n-rw------- 1 james users 128M May 31 06:05 blk03629.dat\r\n-rw------- 1 james users  64M May 31 10:57 blk03630.dat\r\ndrwx------ 2 james users 4.0K May 31 10:54 index\r\n-rw------- 1 james users  17M May 29 15:30 rev03626.dat\r\n-rw------- 1 james users  15M May 30 02:36 rev03627.dat\r\n-rw------- 1 james users  19M May 30 17:23 rev03628.dat\r\n-rw------- 1 james users  18M May 31 06:01 rev03629.dat\r\n-rw------- 1 james users 8.0M May 31 10:57 rev03630.dat\r\n```",
      "created_at" : "2023-05-31T15:16:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1570432290",
      "id" : 1570432290,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585dmuUi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570432290/reactions"
      },
      "updated_at" : "2023-05-31T15:16:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570432290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2023-05-31T19:21:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1570801767",
      "id" : 1570801767,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585doIhn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570801767/reactions"
      },
      "updated_at" : "2023-05-31T19:21:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570801767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Related minor issue: https://github.com/bitcoin/bitcoin/issues/27841. I don't think it matters but posting for visibility in case it happens to be helpful to someone.",
      "created_at" : "2023-06-09T00:05:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1583637570",
      "id" : 1583637570,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585eZGRC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1583637570/reactions"
      },
      "updated_at" : "2023-06-09T00:24:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1583637570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22148308?v=4",
         "events_url" : "https://api.github.com/users/hazeycode/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hazeycode/followers",
         "following_url" : "https://api.github.com/users/hazeycode/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hazeycode/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hazeycode",
         "id" : 22148308,
         "login" : "hazeycode",
         "node_id" : "MDQ6VXNlcjIyMTQ4MzA4",
         "organizations_url" : "https://api.github.com/users/hazeycode/orgs",
         "received_events_url" : "https://api.github.com/users/hazeycode/received_events",
         "repos_url" : "https://api.github.com/users/hazeycode/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hazeycode/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hazeycode/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hazeycode"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> This may look like a lot to review, but note that\r\n> \r\n>     * 200 lines are duplicated in #24008\r\n\r\nThis should refer to #27746 now, shouldn't it?\r\n",
      "created_at" : "2023-06-10T09:45:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1585587421",
      "id" : 1585587421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585egiTd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1585587421/reactions"
      },
      "updated_at" : "2023-06-10T09:45:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1585587421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-06-12T12:53:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1587284696",
      "id" : 1587284696,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585enArY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1587284696/reactions"
      },
      "updated_at" : "2023-06-12T12:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1587284696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Marcus Maurice Williams\r\n\r\nOn Mon, May 8, 2023, 10:12 AM jamesob ***@***.***> wrote:\r\n\r\n>\r\n>    - Background and FAQ:\r\n>    https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal\r\n>    - Prior progress/project:\r\n>    https://github.com/bitcoin/bitcoin/projects/11\r\n>    - Replaces #15606 <https://github.com/bitcoin/bitcoin/pull/15606>,\r\n>    which was closed due to Github slowness. Original description and\r\n>    commentary can be found there.\r\n>\r\n> ------------------------------\r\n>\r\n> This changeset finishes the first phase of the assumeutxo project. It\r\n> makes UTXO snapshots loadable via RPC (loadtxoutset) and adds assumeutxo\r\n> parameters to chainparams. It contains all the remaining changes necessary\r\n> to both use an assumedvalid snapshot chainstate and do a full validation\r\n> sync in the background.\r\n>\r\n> This may look like a lot to review, but note that\r\n>\r\n>    - 200 lines are duplicated in #24008\r\n>    <https://github.com/bitcoin/bitcoin/pull/24008>\r\n>    - ~200 lines are a demo shell script\r\n>    - Many lines are functional test, documentation, and relatively dilute\r\n>    RPC code.\r\n>\r\n> So it shouldn't be as burdensome to review as the linecount might suggest.\r\n>\r\n>    - *P2P*: minor changes are made to init.cpp and net_processing.cpp to\r\n>    make simultaneous IBD across multiple chainstates work.\r\n>       - #24008 <https://github.com/bitcoin/bitcoin/pull/24008>\r\n>    - *Pruning*: implement correct pruning behavior when using a\r\n>    background chainstate\r\n>    - *Blockfile separation*: to prevent \"fragmentation\" in blockfile\r\n>    storage, have background chainstates use separate blockfiles from active\r\n>    snapshot chainstates to avoid interleaving heights and impairing pruning.\r\n>    - *Indexing*: all existing CValidationInterface events are given with\r\n>    an additional parameter, ChainstateRole, and all indexers ignore events\r\n>    from ChainstateRole::ASSUMEDVALID so that indexation only happens\r\n>    sequentially.\r\n>    - Raise error when both -reindex and assumeutxo are in use.\r\n>    - *RPC*: introduce RPC commands loadtxoutset and (hidden)\r\n>    getchainstates.\r\n>    - *Release docs & first assumeutxo commitment*: add notes and a\r\n>    particular assumeutxo hash value for first AU-enabled release.\r\n>       - This will complete the project and allow use of UTXO snapshots\r\n>       for faster node bootstrap.\r\n>\r\n> The next phase, if it were to be pursued, would be coming up with a way to\r\n> distribute the UTXO snapshots over the P2P network.\r\n> ------------------------------\r\n> Testing For fun (~5min)\r\n>\r\n> If you want to do a quick test, you can run\r\n> ./contrib/devtools/test_utxo_snapshots.sh and follow the instructions.\r\n> This is mostly obviated by the functional tests, though.\r\n> For real (longer)\r\n>\r\n> If you'd like to experience a real usage of assumeutxo, you can do that\r\n> too.\r\n> I've cut a new snapshot at height 788'000 (\r\n> http://img.jameso.be/utxo-788000.dat - but you can do it yourself with\r\n> ./contrib/devtools/utxo_snapshot.sh if you want). Download that, and then\r\n> create a datadir for testing:\r\n>\r\n> $ cd ~/src/bitcoin  # or whatever\r\n> # get the snapshot\r\n> $ curl http://img.jameso.be/utxo-788000.dat > utxo-788000.dat\r\n> # you'll want to do this if you like copy/pasting\r\n> $ export AU_DATADIR=/home/${USER}/au-test # or wherever\r\n>\r\n> $ mkdir ${AU_DATADIR}\r\n> $ vim ${AU_DATADIR}/bitcoin.conf\r\n>\r\n> dbcache=8000  # or, you know, something high\r\n> blockfilterindex=1\r\n> coinstatsindex=1\r\n> prune=3000\r\n> logthreadnames=1\r\n>\r\n> Obtain this branch, build it, and then start bitcoind:\r\n>\r\n> $ git remote add jamesob https://github.com/jamesob/bitcoin\r\n> $ git fetch jamesob utxo-dumpload-compressed\r\n> $ git checkout jamesob/utxo-dumpload-compressed\r\n>\r\n> $ ./configure $conf_args && make  # (whatever you like to do here)\r\n> # start 'er up and watch the logs\r\n> $ ./src/bitcoind -datadir=${AU_DATADIR}\r\n>\r\n> Then, in some other window, load the snapshot\r\n>\r\n> $ ./src/bitcoin-cli -datadir=${AU_DATADIR} loadtxoutset $(pwd)/utxo-788000.dat\r\n>\r\n> You'll see some log messages about headers retrieval and waiting to see\r\n> the snapshot in the headers chain. Once you get the full headers chain,\r\n> you'll spend a decent amount of time (~10min) loading the snapshot,\r\n> checking it, and flushing it to disk. After all that happens, you should be\r\n> syncing to tip in pretty short order, and you'll see the occasional [background\r\n> validation] log message go by.\r\n>\r\n> In yet another window, you can check out chainstate status with\r\n>\r\n> $ ./src/bitcoin-cli -datadir=${AU_DATADIR} getchainstates\r\n>\r\n> as well as usual favorites like getblockchaininfo.\r\n> ------------------------------\r\n> You can view, comment on, or merge this pull request online at:\r\n>\r\n>   https://github.com/bitcoin/bitcoin/pull/27596\r\n> Commit Summary\r\n>\r\n>    - 862346f\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/862346f870d73fc3d11fead1afc8b3379984bdfb>\r\n>    validation: introduce ChainstateManager::GetChainstateForNewBlock\r\n>    - 89fe4b3\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/89fe4b3a2c4480573598f865757c9a36e75d2864>\r\n>    validation: add ChainstateManager::GetAllForBlockDownload()\r\n>    - 4b68a3a\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/4b68a3a85fca3fbc4befa58bd8ac3c91a6d58c79>\r\n>    doc: add docstring for CanDirectFetch()\r\n>    - 86d5cfd\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/86d5cfdd78fd70250fb5b96d3c5e85e8afb5c71f>\r\n>    net_processing: work with multiple chainstates\r\n>    - a966a54\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/a966a54df5032f4a01d4d2f5eb006d41cea31c7c>\r\n>    p2p: don't advertise until we finish all IBDs\r\n>    - 84a7c15\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/84a7c15ef835f4846ccffca663d194de071ed49a>\r\n>    net_processing: add commentary describing IsIBD use\r\n>    - 1899c76\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/1899c76609ab1ec38947201227e6872a2c47f5a8>\r\n>    assumeutxo: disallow -reindex when background syncing\r\n>    - 5cdc31a\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/5cdc31a25279fdf5d434d36a360d256db48a6a44>\r\n>    validation: MaybeRebalanceCaches when chain leaves IBD\r\n>    - fb817f7\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/fb817f71e8565b71394b21e036ad1235c679bd5e>\r\n>    validation: add ChainstateRole\r\n>    - a284813\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/a284813336cd29862a24b95c283795c8b89d5549>\r\n>    validation: pass ChainstateRole for validationinterface calls\r\n>    - deea1c0\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/deea1c0b946887d57709c34bc7a96383de11f5ee>\r\n>    validationinterface: only send zmq notifications for active\r\n>    - cc59c06\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/cc59c060d05c3c8a2a949e1bcfe58ef0d2cbd6b8>\r\n>    wallet: validationinterface: only handle active chain notifications\r\n>    - fec9c9a\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/fec9c9aaf920bba6f519dd34d950d5a8a2a5b424>\r\n>    net_processing: validationinterface: ignore some events for bg chain\r\n>    - 460978b\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/460978b778df9f9a56242bf16e78230b1d5cb566>\r\n>    index: cache indexer references on ChainstateManager\r\n>    - e73fc1b\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/e73fc1b56dc7a8700e46e3c7d0f78af81c81d4bf>\r\n>    validation: indexing changes for assumeutxo\r\n>    - c0fe191\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/c0fe1918480ff7aedef274b72e1fb58eee1bd98b>\r\n>    validation: pruning for multiple chainstates\r\n>    - 8d887bc\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/8d887bcb023ae57a43d4753592bb19fc1595392f>\r\n>    blockstorage: segment normal/assumedvalid blockfiles\r\n>    - 1375263\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/13752635f8544b517ad0a701e0a3871126f9cf4e>\r\n>    validation: run CheckBlockIndex on all chainstates during ProcessNewHeaders\r\n>    - 501633d\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/501633da24c0c976062e6731fe4cfff6e57da265>\r\n>    validation: populate nChainTx value for assumedvalid chainstates\r\n>    - eae8d5b\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/eae8d5bcfbc74a8f294fc0ea5bf7b15557d9e0a3>\r\n>    validation: assumeutxo: swap m_mempool on snapshot activation\r\n>    - ff1d1d2\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/ff1d1d265422698dfa83934f8562cbfbe0176bcb>\r\n>    rpc: add loadtxoutset\r\n>    - 386ddcb\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/386ddcb05ab67f27147e7bdba7271ef7b0f0a6d8>\r\n>    rpc: add getchainstates\r\n>    - 5f19585\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/5f19585e6a0f983ed4977fc4848810471c122a4d>\r\n>    test: add feature_assumeutxo functional test\r\n>    - 39c2438\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/39c2438b8806800b6c30749c0ea7f915cea5dc21>\r\n>    contrib: add script to demo/test assumeutxo\r\n>    - 86aa9f5\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/86aa9f506dd79d9bdc7a9acb682a0e68a2651af5>\r\n>    doc: update release-process.md for assumeutxo\r\n>    - e546c77\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/commits/e546c77f6344dd5e156db8fbef568b376b16b36c>\r\n>    chainparams: add assumeutxo param at height 788_000\r\n>\r\n> File Changes\r\n>\r\n> (38 files <https://github.com/bitcoin/bitcoin/pull/27596/files>)\r\n>\r\n>    - *A* contrib/devtools/test_utxo_snapshots.sh\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-bf5041637049f714f9770cd1fdbeb8c56113ba445158afe4d15df32b5b393c5e>\r\n>    (201)\r\n>    - *M* doc/release-process.md\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-723b9eeeb819047ef03f827ee8a3ccfef48ce7ef6a340a068a68b551993fe70b>\r\n>    (5)\r\n>    - *M* src/bench/wallet_create_tx.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-e9fe86a6cb5a18f8bf472c45e9d02cca8aea5dac8e3d2a0b81ce25a734458139>\r\n>    (2)\r\n>    - *M* src/bitcoin-chainstate.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-04e685224f1ac5bfd91d47d8d7528a2e44f94fab5535d4b6b5af79b5a13aeb93>\r\n>    (2)\r\n>    - *M* src/index/base.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-5251d93616c116c364d2d502ad2a59e901a3512194462fabacc9756f96fd8ddd>\r\n>    (45)\r\n>    - *M* src/index/base.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-7788bdbad32d436bca22d0c729b136d185852f2f06bf389de660a27209605b1e>\r\n>    (16)\r\n>    - *M* src/init.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-b1e19192258d83199d8adaa5ac31f067af98f63554bfdd679bd8e8073815e69d>\r\n>    (28)\r\n>    - *M* src/interfaces/chain.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-8e9fef4d0718d085f31da382899d97e3bbefc8d6a72ede95916a0e2fbd1a532f>\r\n>    (7)\r\n>    - *M* src/kernel/chain.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-d3d6e652e68e3ef8083f804a2d9bf6bbe6f56d8be131ec27caa2d22aadd26308>\r\n>    (16)\r\n>    - *M* src/kernel/chainparams.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-e20339c384d6f19b519ea2de7f4ba4fed92a36d66a80f0339b09927c3fa38d6d>\r\n>    (10)\r\n>    - *M* src/net_processing.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3>\r\n>    (192)\r\n>    - *M* src/node/blockstorage.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-114c2880ec1ff2c5293ac65ceda0637bf92c05745b74b58410585a549464a33f>\r\n>    (171)\r\n>    - *M* src/node/blockstorage.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-ed3f90693a242b38b9719af171de8f55183576957676dfa358945bea22276bd5>\r\n>    (51)\r\n>    - *M* src/node/chainstate.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-2d7b280e97018679cac8dc4fc7a1f172c4a7784196a6563814c2720a5fe4f5cf>\r\n>    (9)\r\n>    - *M* src/node/chainstate.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-5c4b54b8e7e79dc69ba8718a3560a500c3ee188cb41ef2d871f1618430ed05ab>\r\n>    (1)\r\n>    - *M* src/node/interfaces.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-0ef8ae12c6e9ef2accc78537f42612b3267e8a7c45dc7e9eb998f797e79f2e95>\r\n>    (12)\r\n>    - *M* src/rpc/blockchain.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-decae4be02fb8a47ab4557fe74a9cb853bdfa3ec0fa1b515c0a1e5de91f4ad0b>\r\n>    (145)\r\n>    - *M* src/rpc/mining.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-ccc24453c13307f815879738d3bf00eec351417537fbf10dde1468180cacd2f1>\r\n>    (2)\r\n>    - *M* src/test/blockmanager_tests.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-d6d633592a40f5f3d8b03863e41547de8751b874c1d20f129a616b9dd719b999>\r\n>    (22)\r\n>    - *M* src/test/coinstatsindex_tests.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-3a52da0f780b7496cbd3be5349331f223c59c0744a4e9250b4ce9447af49cc3f>\r\n>    (2)\r\n>    - *M* src/test/fuzz/rpc.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-ee7cf727299bfa316da96e98513ee31af263b0e7a6d11c4ab4925c4d39cf8f26>\r\n>    (2)\r\n>    - *M* src/test/util/validation.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-064350ac182b83003193c123be2641ccf8193acc345ffe414a296564abae8ba5>\r\n>    (8)\r\n>    - *M* src/test/util/validation.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-fc320b912f26bb38bdf2dbfa04eff079171998213bb4613c70fde3ba55633011>\r\n>    (6)\r\n>    - *M* src/test/validation_block_tests.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-c51ca52621176697b8a93a05bcf50f4d6e9918858c2e7f433a5643d5f8cfcb49>\r\n>    (4)\r\n>    - *M* src/test/validation_chainstatemanager_tests.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-dbada1fe3a3d0af884304dd28be8c9df74b592401dec2c6400f6b491aefe6c9b>\r\n>    (51)\r\n>    - *M* src/test/validationinterface_tests.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-f3c4c9b3d62db182f8504262b16a60e355c147f24cc4b68a9d22d2f73478c2c8>\r\n>    (9)\r\n>    - *M* src/validation.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98>\r\n>    (186)\r\n>    - *M* src/validation.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-d3c243938494b10666b44404a27af7d84b44a72b85a27431e0c89e181462ca6e>\r\n>    (59)\r\n>    - *M* src/validationinterface.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-cd341be4887e632ceba211aee03c948d964396f7aed0146435163844fbcbad42>\r\n>    (27)\r\n>    - *M* src/validationinterface.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-b169bd0694e8b0a87fd1097c8cfc1d6c8a926b49b375bb4141d37dcc624f975e>\r\n>    (38)\r\n>    - *M* src/wallet/test/fuzz/notifications.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-56ec91afa7041341aa4d260eae3e38f4ce0593b3d099e84ae3a3ac23c364825a>\r\n>    (5)\r\n>    - *M* src/wallet/wallet.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-1f2db0e4d5c12d109c7f0962333c245b49b696cb39ff432da048e9d6c08944d8>\r\n>    (20)\r\n>    - *M* src/wallet/wallet.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-9ce137cd784ea308778842120aa2af6d2bb8369485b71f25e72b2a32cf0a5b21>\r\n>    (6)\r\n>    - *M* src/zmq/zmqnotificationinterface.cpp\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-ac4b2d3a8de2c4dd41ad9d75505ea6ce4dc87a476710a9ebee8acf9bebf5cca2>\r\n>    (11)\r\n>    - *M* src/zmq/zmqnotificationinterface.h\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-ac02747459d343f20f8f722042856d31d6a4af8db84da8c761f56a3c04356df1>\r\n>    (4)\r\n>    - *A* test/functional/feature_assumeutxo.py\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-8eaa6b77b4e4f242deb67950425cb6b6b7de5370c56a1e8fa7e3a12e95df0a9d>\r\n>    (145)\r\n>    - *M* test/functional/test_runner.py\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-437d7f6e9f2229879b60aae574a8217f14c643bbf3cfa9225d8011d6d52df00c>\r\n>    (1)\r\n>    - *M* test/lint/lint-shell.py\r\n>    <https://github.com/bitcoin/bitcoin/pull/27596/files#diff-91d0650eb13c42e4373349f80200ea548b560a916ddc11decaba31d04bf6addf>\r\n>    (8)\r\n>\r\n> Patch Links:\r\n>\r\n>    - https://github.com/bitcoin/bitcoin/pull/27596.patch\r\n>    - https://github.com/bitcoin/bitcoin/pull/27596.diff\r\n>\r\n> â\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/bitcoin/bitcoin/pull/27596>, or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/ASHJW56YS762NMBB2GGDN6DXFEENXANCNFSM6AAAAAAX2CKYPM>\r\n> .\r\n> You are receiving this because you are subscribed to this thread.Message\r\n> ID: ***@***.***>\r\n>\r\n",
      "created_at" : "2023-06-28T22:30:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1612199588",
      "id" : 1612199588,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585gGDak",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1612199588/reactions"
      },
      "updated_at" : "2023-06-28T22:30:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1612199588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/76454775?v=4",
         "events_url" : "https://api.github.com/users/MarcusMWilliams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcusMWilliams/followers",
         "following_url" : "https://api.github.com/users/MarcusMWilliams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcusMWilliams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcusMWilliams",
         "id" : 76454775,
         "login" : "MarcusMWilliams",
         "node_id" : "MDQ6VXNlcjc2NDU0Nzc1",
         "organizations_url" : "https://api.github.com/users/MarcusMWilliams/orgs",
         "received_events_url" : "https://api.github.com/users/MarcusMWilliams/received_events",
         "repos_url" : "https://api.github.com/users/MarcusMWilliams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcusMWilliams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcusMWilliams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcusMWilliams"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "With #24008 landed this would a great time for a rebase (I briefly tried but it's non-trivial).",
      "created_at" : "2023-08-01T08:11:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1659794915",
      "id" : 1659794915,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585i7nXj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1659794915/reactions"
      },
      "updated_at" : "2023-08-01T08:11:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1659794915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "In the process of rebasing now.",
      "created_at" : "2023-08-01T18:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1660856546",
      "id" : 1660856546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585i_qji",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1660856546/reactions"
      },
      "updated_at" : "2023-08-01T18:21:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1660856546",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased [`au.027`](https://github.com/jamesob/bitcoin/tree/au.027) -> [`au.029`](https://github.com/jamesob/bitcoin/tree/au.029)\r\n\r\nThe merge of #27607 really made that difficult.\r\n\r\nThis rebase fixes merge conflicts as well as incorporates @sdaftuar's changes from #27746. His net changes are in the first commit here.\r\n\r\nI'm very tired of this project and hope we can focus effort on getting this changeset reviewed and merged to be done with the development of this feature.",
      "created_at" : "2023-08-07T19:36:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1668468059",
      "id" : 1668468059,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585jcs1b",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668468059/reactions"
      },
      "updated_at" : "2023-08-07T19:36:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668468059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-08-07T20:45:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1668555204",
      "id" : 1668555204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585jdCHE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 1,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668555204/reactions"
      },
      "updated_at" : "2023-08-07T20:45:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1668555204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(The next rebase should be trivial, only a one-line include conflict, I think)",
      "created_at" : "2023-08-08T07:29:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1669064576",
      "id" : 1669064576,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585je-eA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1669064576/reactions"
      },
      "updated_at" : "2023-08-08T07:29:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1669064576",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290225497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290225497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This look suspiciously similar to `FindNextBlocksToDownload`, is there no way to unify the two?\r\n\r\n(sorry if I missed previous discussion on this)",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-10T14:30:00Z",
      "diff_hunk" : "@@ -1406,6 +1410,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290225497",
      "id" : 1290225497,
      "line" : 1413,
      "node_id" : "PRRC_kwDOABII585M50dZ",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 1413,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 49,
      "pull_request_review_id" : 1572046251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290225497/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-10T14:54:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290225497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290237668"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290237668"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`NewPoWValidBlock` is already gated with `m_highest_fast_announce` but I think it would make sense to also ignore bg chainstate events explicitly.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-10T14:38:37Z",
      "diff_hunk" : "@@ -1901,7 +1970,10 @@ void PeerManagerImpl::BlockDisconnected(const std::shared_ptr<const CBlock> &blo\n  * Maintain state about the best-seen block and fast-announce a compact block\n  * to compatible peers.\n  */\n-void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock)\n+void PeerManagerImpl::NewPoWValidBlock(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290237668",
      "id" : 1290237668,
      "line" : 1973,
      "node_id" : "PRRC_kwDOABII585M53bk",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 1973,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 136,
      "pull_request_review_id" : 1572046251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290237668/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-10T14:54:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290237668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290241176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290241176"
         }
      },
      "author_association" : "MEMBER",
      "body" : "propbably not worth it to pass the chainstate role then?",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-10T14:41:03Z",
      "diff_hunk" : "@@ -87,13 +88,13 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290241176",
      "id" : 1290241176,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585M54SY",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 91,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 13,
      "pull_request_review_id" : 1572046251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290241176/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-10T14:54:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290241176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291426426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291426426"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Better to be precise and ask them to only recommend deleting `blocks`, `chainstate` and `indexes`. Or alternatively add a reminder that they should backup their wallet before deleting the whole datadir.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-11T14:42:31Z",
      "diff_hunk" : "@@ -185,7 +185,14 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     chainman.InitializeChainstate(options.mempool);\n \n     // Load a chain created from a UTXO snapshot, if any exist.\n-    chainman.DetectSnapshotChainstate(options.mempool);\n+    bool has_snapshot = chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    if (has_snapshot && (options.reindex || options.reindex_chainstate)) {\n+        return {ChainstateLoadStatus::FAILURE_NO_REINDEX, _(\n+            \"Reindex cannot be performed while background validation is in progress. \"\n+            \"Please wait for background sync to complete, or delete data directory \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291426426",
      "id" : 1291426426,
      "line" : 193,
      "node_id" : "PRRC_kwDOABII585M-Zp6",
      "original_commit_id" : "3b9d3d63d9ccb609ec08da34776f7c5f29d21a20",
      "original_line" : 193,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 10,
      "pull_request_review_id" : 1477561344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291426426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-11T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291426426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291431562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291431562"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Doesn't `std::find_if` work for this?",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-11T14:46:56Z",
      "diff_hunk" : "@@ -49,4 +51,15 @@ inline V Cat(V v1, const V& v2)\n     return v1;\n }\n \n+template<typename V, typename L>\n+inline std::optional<V> FindFirst(const std::vector<V>& vec, const L fnc)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291431562",
      "id" : 1291431562,
      "line" : 55,
      "node_id" : "PRRC_kwDOABII585M-a6K",
      "original_commit_id" : "cdb73e44b7f0d4ea186ba657ddf7809434f0a12a",
      "original_line" : 55,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/util/vector.h",
      "position" : 15,
      "pull_request_review_id" : 1477561344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291431562/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-11T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291431562",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291620032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291620032"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, might be good to update ZMQ and wallet docs as a follow-up that blocks that are connected to the background chain will not be notified...",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-11T17:31:20Z",
      "diff_hunk" : "@@ -173,6 +174,9 @@ void CZMQNotificationInterface::TransactionRemovedFromMempool(const CTransaction\n \n void CZMQNotificationInterface::BlockConnected(const ChainstateRole role, const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected)\n {\n+    if (role == ChainstateRole::BACKGROUND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291620032",
      "id" : 1291620032,
      "line" : 177,
      "node_id" : "PRRC_kwDOABII585M_I7A",
      "original_commit_id" : "f2a15428277090d6ad387de6d517303b9bc4e2af",
      "original_line" : 177,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 28,
      "pull_request_review_id" : 1477561344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291620032/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-11T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291620032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291649621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291649621"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am not sure it makes sense to distribute the prune budget between all chainstates equally. Ideally we would sync the background chainstate block by block and throw them away instantly because if we are pruning the likelihood that we keep the bg blocks at the end of IBD is much lower. I'm not sure what the perfect distribution would be but I would shift it more towards the assumed chainstate.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-11T18:09:07Z",
      "diff_hunk" : "@@ -153,31 +158,54 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    unsigned int min_block_to_prune;\n+    unsigned int nLastBlockWeCanPrune;\n+\n+    std::tie(min_block_to_prune, nLastBlockWeCanPrune) = chainman.GetPruneRange(\n+        chain, chain_tip_height);\n+\n+    nLastBlockWeCanPrune = std::min(nLastBlockWeCanPrune, (unsigned)nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > nLastBlockWeCanPrune || fileinfo.nHeightFirst < min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), nLastBlockWeCanPrune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int chain_tip_height,\n+    int prune_height,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = GetPruneTarget() / chainman.GetAll().size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291649621",
      "id" : 1291649621,
      "line" : 195,
      "node_id" : "PRRC_kwDOABII585M_QJV",
      "original_commit_id" : "9e2b8ef836aeb1dc2e4b57449fc56badebea6772",
      "original_line" : 194,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 66,
      "pull_request_review_id" : 1477561344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291649621/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-11T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291649621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291670706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291670706"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A bit simpler approach for this RPC would be to return to the user that the headers are not synced yet immediately and tell them they should try again when the headers are fully synced. I would be interested if others favor this approach as well.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-11T18:37:08Z",
      "diff_hunk" : "@@ -2699,6 +2699,86 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291670706",
      "id" : 1291670706,
      "line" : 2740,
      "node_id" : "PRRC_kwDOABII585M_VSy",
      "original_commit_id" : "8ac7427b41fdec1dbc7e06d0aa2c0e469b879ba2",
      "original_line" : 2740,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 42,
      "pull_request_review_id" : 1477561344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291670706/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-11T22:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291670706",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Test failure for a66790c662d6516b9fec9ca2cc97e410a72fe899 on Ubuntu 23.04 (gcc 12.3.0) \r\n\r\n```\r\n$ src/test/test_bitcoin --run_test=validation_chainstatemanager_tests\r\nRunning 7 test cases...\r\nnode/blockstorage.cpp:307 LoadBlockIndex: Assertion `GetParams().AssumeutxoForBlockhash(*snapshot_blockhash)' failed.\r\nunknown location(0): fatal error: in \"validation_chainstatemanager_tests/chainstatemanager_loadblockindex\": signal: SIGABRT (application abort requested)\r\ntest/validation_chainstatemanager_tests.cpp(441): last checkpoint\r\ntest_bitcoin: common/args.cpp:577: void ArgsManager::AddArg(const std::string&, const std::string&, unsigned int, const OptionsCategory&): Assertion `ret.second' failed.\r\nunknown location(0): fatal error: in \"validation_chainstatemanager_tests/chainstatemanager_snapshot_init\": signal: SIGABRT (application abort requested)\r\ntest/validation_chainstatemanager_tests.cpp(508): last checkpoint: \"chainstatemanager_snapshot_init\" fixture ctor\r\ntest_bitcoin: common/args.cpp:577: void ArgsManager::AddArg(const std::string&, const std::string&, unsigned int, const OptionsCategory&): Assertion `ret.second' failed.\r\nunknown location(0): fatal error: in \"validation_chainstatemanager_tests/chainstatemanager_snapshot_completion\": signal: SIGABRT (application abort requested)\r\ntest/validation_chainstatemanager_tests.cpp(577): last checkpoint: \"chainstatemanager_snapshot_completion\" fixture ctor\r\ntest_bitcoin: common/args.cpp:577: void ArgsManager::AddArg(const std::string&, const std::string&, unsigned int, const OptionsCategory&): Assertion `ret.second' failed.\r\nunknown location(0): fatal error: in \"validation_chainstatemanager_tests/chainstatemanager_snapshot_completion_hash_mismatch\": signal: SIGABRT (application abort requested)\r\ntest/validation_chainstatemanager_tests.cpp(660): last checkpoint: \"chainstatemanager_snapshot_completion_hash_mismatch\" fixture ctor\r\n```\r\n\r\nIt's happy again the next commit fe735572d05b95569e9c82fa1b1767c7da23b423.\r\n\r\n\r\nâ\r\nHere's a torrent for 800,000: `magnet:?xt=urn:btih:50ee955bef37f5ec3e5b0df4cf0288af3d715a2e&dn=utxo-800000.dat&tr=udp%3A%2F%2Ftracker.bitcoin.sprovoost.nl%3A6969`\r\n\r\nYou'll need this:\r\n\r\n```json\r\n{\r\n  \"coins_written\": 111535121,\r\n  \"base_hash\": \"00000000000000000002a7c4c1e48d76c5a37902165a270156b7a8d72728a054\",\r\n  \"base_height\": 800000,\r\n  \"txoutset_hash\": \"7d69b87512db3d13b9758ea32b93ce468d18cf7456fb5d250c9e1bed9339e4d2\",\r\n  \"nchaintx\": 868965226\r\n}\r\n```\r\n\r\nI'll try a sync with this shortly. _Update_: ran successful IBD on Intel macOS and on Ubuntu 23. With the latter I first had it sync until 2013 so the dbcache would be 1 GB, before loading the snapshot. \r\n\r\nâ\r\n\r\nOn macOS the shutdown (a day) after completing background sync seems gets stuck:\r\n\r\n```\r\n023-08-16T07:48:43Z [msghand] [net] Saw new cmpctblock header hash=0000000000000000000229118fcb007fc035045c3a3394233116aa25d496129e peer=398\r\n2023-08-16T07:48:44Z [msghand] UpdateTip: new best=0000000000000000000229118fcb007fc035045c3a3394233116aa25d496129e height=803421 version=0x20000000 log2_work=94.362393 tx=879900343 date='2023-08-16T07:48:37Z' progress=1.000000 cache=114.9MiB(924996txo)\r\n2023-08-16T07:49:00Z [msghand] New outbound peer connected: version: 70016, blocks=803421, peer=491 (block-relay-only)\r\n^C2023-08-16T07:50:33Z [addcon] addcon thread exit\r\n2023-08-16T07:50:33Z [opencon] opencon thread exit\r\n2023-08-16T07:50:33Z [init] Shutdown: In progress...\r\n2023-08-16T07:50:33Z [net] net thread exit\r\n2023-08-16T07:50:33Z [msghand] msghand thread exit\r\n2023-08-16T07:55:12Z [scheduler] Flushed fee estimates to fee_estimates.dat.\r\n2023-08-16T08:23:36Z [scheduler] Potential stale tip detected, will try using extra outbound peer (last tip update: 2092 seconds ago)\r\n```\r\n\r\nI didn't run with useful debug flags unfortunately. It was a pruned node. Despite `kill -9` it was able to restart in good shape though:\r\n\r\n```\r\n2023-08-16T09:03:57Z [init] [snapshot] cleaning up unneeded background chainstate, then reinitializing\r\n```",
      "created_at" : "2023-08-14T11:17:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1677134971",
      "id" : 1677134971,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585j9wx7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1677134971/reactions"
      },
      "updated_at" : "2023-08-16T09:05:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1677134971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294582794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294582794"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"First draft of background sync logic\" (6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1290225497\r\n\r\n> This look suspiciously similar to `FindNextBlocksToDownload`, is there no way to unify the two?\r\n\r\nThis seems pretty bad. The most complicated part of the function is copied and pasted basically verbatim, and to make things worse, the comments which explain how it works are removed in the duplicated code.\r\n\r\nWould suggest 43b322188de227c1161fe3ee2dfd7b3a019cfc6a ([branch](https://github.com/ryanofsky/bitcoin/commits/pr/assumedl)) as a simpler alternative. It also add a commit description and a doxygen comment to explain all the variables which I found confusing. Feel free to add it to this PR or adopt anything there.\r\n\r\n\r\n",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-15T13:14:53Z",
      "diff_hunk" : "@@ -1406,6 +1410,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294582794",
      "id" : 1294582794,
      "in_reply_to_id" : 1290225497,
      "line" : 1413,
      "node_id" : "PRRC_kwDOABII585NKcQK",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 1413,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 49,
      "pull_request_review_id" : 1578539655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294582794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-15T16:49:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294582794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294850766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294850766"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"First draft of background sync logic\" (6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b)\r\n\r\nThis code is just copied and pasted from previous code which was added back in #4468, but `std::max` seems like a bug here, and I would expect it to be `std::min` if the point is to read up to 128 successors of pIndexWalk at a time.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-15T16:30:39Z",
      "diff_hunk" : "@@ -1406,6 +1409,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)\n+{\n+    if (vBlocks.size() >= count) {\n+        return;\n+    }\n+\n+    vBlocks.reserve(count);\n+    CNodeState *state = State(peer.m_id);\n+    assert(state != nullptr);\n+\n+    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->GetAncestor(target_block->nHeight) != target_block) {\n+        // This peer is useless to us -- it has a chain that doesn't contain\n+        // our assumeutxo target.\n+        // Presumably this peer's chain has less work than our ActiveChain()'s tip, or else we\n+        // will eventually crash when we try to reorg to it. Let other logic\n+        // deal with whether we disconnect this peer.\n+        return;\n+    }\n+\n+    const CBlockIndex *pindexWalk = from_tip;\n+\n+    int nWindowEnd = pindexWalk->nHeight + BLOCK_DOWNLOAD_WINDOW;\n+    int nMaxHeight = std::min<int>(target_block->nHeight, nWindowEnd + 1);\n+\n+    std::vector<const CBlockIndex*> vToFetch;\n+\n+    while (pindexWalk->nHeight < nMaxHeight) {\n+        int nToFetch = std::min(nMaxHeight-pindexWalk->nHeight, std::max<int>(count-vBlocks.size(), 128));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294850766",
      "id" : 1294850766,
      "line" : 1440,
      "node_id" : "PRRC_kwDOABII585NLdrO",
      "original_commit_id" : "6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b",
      "original_line" : 1439,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 76,
      "pull_request_review_id" : 1578539655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294850766/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-15T16:49:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294850766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294879351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294879351"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"First draft of background sync logic\" (6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b)\r\n\r\nThis is an exaggeration, right? Peer doesn't seem completely useless if it doesn't contain the snapshot block because it could contain blocks leading up the snapshot block. It this is right it would be good to clarify, or maybe change to allow requesting blocks from the peer.",
      "commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "created_at" : "2023-08-15T16:58:54Z",
      "diff_hunk" : "@@ -1406,6 +1409,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)\n+{\n+    if (vBlocks.size() >= count) {\n+        return;\n+    }\n+\n+    vBlocks.reserve(count);\n+    CNodeState *state = State(peer.m_id);\n+    assert(state != nullptr);\n+\n+    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->GetAncestor(target_block->nHeight) != target_block) {\n+        // This peer is useless to us -- it has a chain that doesn't contain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294879351",
      "id" : 1294879351,
      "line" : 1424,
      "node_id" : "PRRC_kwDOABII585NLkp3",
      "original_commit_id" : "6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b",
      "original_line" : 1423,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 60,
      "pull_request_review_id" : 1579020103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294879351/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-15T16:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1294879351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1296088099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296088099"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"assumeutxo: disallow -reindex when background syncing\" (3b9d3d63d9ccb609ec08da34776f7c5f29d21a20)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1291426426\r\n\r\nI don't understand the advice to \"wait for background sync to complete\" in this error message. I thought use-cases for reindex were mostly things like recovering from data corruption or restoring from backup. Is there a case where you would ever want to wait for a sync to complete and then reindex after that?\r\n\r\nAlso, I'm not sure why it needs be an error to reindex when a snapshot is loaded. The reindex options are supposed delete the UTXO database (and optionally other databases) without deleting block data, and rebuild using whatever data is left over. So if a snapshot is loaded it seems like the -reindex implementation could just delete both UTXO databases and then continue as normal without the snapshot. If the user still had a copy of the snapshot, they could reload it with the `loadtxoutset` RPC later and reuse the blocks that were already downloaded.\r\n\r\nIt seems like implementing this making making reindex work cleanly with assumeutxo would not be much harder than adding this error message.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-16T15:29:08Z",
      "diff_hunk" : "@@ -185,7 +185,14 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     chainman.InitializeChainstate(options.mempool);\n \n     // Load a chain created from a UTXO snapshot, if any exist.\n-    chainman.DetectSnapshotChainstate(options.mempool);\n+    bool has_snapshot = chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    if (has_snapshot && (options.reindex || options.reindex_chainstate)) {\n+        return {ChainstateLoadStatus::FAILURE_NO_REINDEX, _(\n+            \"Reindex cannot be performed while background validation is in progress. \"\n+            \"Please wait for background sync to complete, or delete data directory \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1296088099",
      "id" : 1296088099,
      "in_reply_to_id" : 1291426426,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NQLwj",
      "original_commit_id" : "3b9d3d63d9ccb609ec08da34776f7c5f29d21a20",
      "original_line" : 193,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1580896920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296088099/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T18:01:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296088099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1296254459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296254459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: MaybeRebalanceCaches when chain leaves IBD\" (5ea9abfbac3543f2d2cef90a1528abed35623822)\r\n\r\nIt seems dangerous if just calling IsInitialBlockDownload to find out IBD state could now block and resize caches and flush state to disk. It also makes the codebase hard to understand if you can't answer a basic question like \"when do caches get resized\" without having to look up IsInitialBlockDownload() calls all over the codebase.\r\n\r\nI think it would be better to choose one place where it would be logical to check for the end of IBD and rebalance caches, like after a block is connected or after a header is received, and put the MaybeRebalanceCaches in a specific place instead of letting it happen anywhere.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-16T17:56:03Z",
      "diff_hunk" : "@@ -1642,6 +1642,9 @@ bool Chainstate::IsInitialBlockDownload() const\n     }\n     LogPrintf(\"Leaving InitialBlockDownload (latching to false)\\n\");\n     m_cached_finished_ibd.store(true, std::memory_order_relaxed);\n+    // Important that this comes *after* the previous line, else we'll wind up in an\n+    // infinite recursion.\n+    m_chainman.MaybeRebalanceCaches();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1296254459",
      "id" : 1296254459,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585NQ0X7",
      "original_commit_id" : "5ea9abfbac3543f2d2cef90a1528abed35623822",
      "original_line" : 1647,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1580896920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296254459/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-16T18:01:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1296254459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2023-08-21T11:18:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1686138366",
      "id" : 1686138366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585kgG3-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1686138366/reactions"
      },
      "updated_at" : "2023-08-21T11:18:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1686138366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303334266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303334266"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2856710077abbc8f07a97adfff5f6829358155be)\r\n\r\nWould suggest moving this change to a separate commit. Otherwise adding the chainstate check here is a behavior change in a refactoring commit. Also it doesn't seem directly related to the other changes here ",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-23T17:28:41Z",
      "diff_hunk" : "@@ -3178,15 +3179,16 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n             // Enqueue while holding cs_main to ensure that UpdatedBlockTip is called in the order in which blocks are connected\n             if (pindexFork != pindexNewTip) {\n                 // Notify ValidationInterface subscribers\n-                GetMainSignals().UpdatedBlockTip(pindexNewTip, pindexFork, fInitialDownload);\n-\n-                // Always notify the UI if a new block tip was connected\n-                if (kernel::IsInterrupted(m_chainman.GetNotifications().blockTip(GetSynchronizationState(fInitialDownload), *pindexNewTip))) {\n-                    // Just breaking and returning success for now. This could\n-                    // be changed to bubble up the kernel::Interrupted value to\n-                    // the caller so the caller could distinguish between\n-                    // completed and interrupted operations.\n-                    break;\n+                GetMainSignals().UpdatedBlockTip(this->GetRole(), pindexNewTip, pindexFork, fInitialDownload);\n+\n+                if (this == &m_chainman.ActiveChainstate() &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303334266",
      "id" : 1303334266,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Nr016",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 3184,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1592088142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303334266/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-23T21:25:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303334266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303337523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303337523"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2856710077abbc8f07a97adfff5f6829358155be)\r\n\r\nI don't see the BlockChecked `role` parameter being used later in the PR, and I don't know another reason why it should be added. It seems like it would be simpler to not add the parameter and get rid of the code above, which is not very straightforward and seems to basically be making up the `role` value.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-23T17:31:56Z",
      "diff_hunk" : "@@ -4057,7 +4060,18 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n             ret = AcceptBlock(block, state, &pindex, force_processing, nullptr, new_block, min_pow_checked);\n         }\n         if (!ret) {\n-            GetMainSignals().BlockChecked(*block, state);\n+            const auto& snapshot = this->SnapshotBlockhash();\n+            ChainstateRole role{ChainstateRole::NORMAL};\n+\n+            // Determine whether or not this block belongs to an assumedvalid chainstate, which\n+            // will affect block storage.\n+            if (snapshot) {\n+                const auto au_data = Assert(GetParams().AssumeutxoForBlockhash(*snapshot));\n+                role = (pindex->nHeight >= au_data->height) ?\n+                    ChainstateRole::ASSUMEDVALID : ChainstateRole::BACKGROUND;\n+            }\n+\n+            GetMainSignals().BlockChecked(role, *block, state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303337523",
      "id" : 1303337523,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Nr1oz",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 4074,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1592088142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303337523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-23T21:25:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303337523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303342871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303342871"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2856710077abbc8f07a97adfff5f6829358155be)\r\n\r\nThese TransactionAddedToMempool and TransactionRemovedFromMempool comments are a little confusing because I wouldn't expect the background chainstate to have a mempool, and even if there were multiple mempools, I wouldn't think knowing what chainstate they build on to be enough to identify them. I think it would be better to drop this new comment and avoid mixing up chainstate/mempool concepts.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-23T17:37:17Z",
      "diff_hunk" : "@@ -87,13 +88,13 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.\n      */\n-    virtual void UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) {}\n+    virtual void UpdatedBlockTip(const ChainstateRole, const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) {}\n     /**\n      * Notifies listeners of a transaction having been added to mempool.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1303342871",
      "id" : 1303342871,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Nr28X",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 97,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 1592088142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303342871/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-23T21:26:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303342871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304837385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304837385"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks - fixed and added you as a coauther.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-24T20:34:19Z",
      "diff_hunk" : "@@ -2700,6 +2700,86 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304837385",
      "id" : 1304837385,
      "in_reply_to_id" : 1197159021,
      "line" : 2726,
      "node_id" : "PRRC_kwDOABII585Nxj0J",
      "original_commit_id" : "bbaa5812258e33ca8a5a63f28c7da6b1d78433a1",
      "original_line" : 2726,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 28,
      "pull_request_review_id" : 1594414348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304837385/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T20:34:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304837385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304838783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304838783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks guys - I've taken https://github.com/bitcoin/bitcoin/commit/43b322188de227c1161fe3ee2dfd7b3a019cfc6a and made a cosmetic refactoring change.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-24T20:36:01Z",
      "diff_hunk" : "@@ -1406,6 +1410,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304838783",
      "id" : 1304838783,
      "in_reply_to_id" : 1290225497,
      "line" : 1384,
      "node_id" : "PRRC_kwDOABII585NxkJ_",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 1384,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 84,
      "pull_request_review_id" : 1594416523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304838783/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T20:36:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304838783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304845272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304845272"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea; done.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-24T20:42:27Z",
      "diff_hunk" : "@@ -87,13 +88,13 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304845272",
      "id" : 1304845272,
      "in_reply_to_id" : 1290241176,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585NxlvY",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 91,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 13,
      "pull_request_review_id" : 1594426081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304845272/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T20:42:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304845272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304849279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good find! I'll remove this unused parameter.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-24T20:47:00Z",
      "diff_hunk" : "@@ -4057,7 +4060,18 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n             ret = AcceptBlock(block, state, &pindex, force_processing, nullptr, new_block, min_pow_checked);\n         }\n         if (!ret) {\n-            GetMainSignals().BlockChecked(*block, state);\n+            const auto& snapshot = this->SnapshotBlockhash();\n+            ChainstateRole role{ChainstateRole::NORMAL};\n+\n+            // Determine whether or not this block belongs to an assumedvalid chainstate, which\n+            // will affect block storage.\n+            if (snapshot) {\n+                const auto au_data = Assert(GetParams().AssumeutxoForBlockhash(*snapshot));\n+                role = (pindex->nHeight >= au_data->height) ?\n+                    ChainstateRole::ASSUMEDVALID : ChainstateRole::BACKGROUND;\n+            }\n+\n+            GetMainSignals().BlockChecked(role, *block, state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304849279",
      "id" : 1304849279,
      "in_reply_to_id" : 1303337523,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Nxmt_",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 4074,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1594432267,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849279/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T20:47:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304849858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, that's fair criticism. I've moved this potential rebalance to within `ActivateBestChain()`, which requires a little bit of extra code but is as you say much more explicit.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-24T20:47:45Z",
      "diff_hunk" : "@@ -1642,6 +1642,9 @@ bool Chainstate::IsInitialBlockDownload() const\n     }\n     LogPrintf(\"Leaving InitialBlockDownload (latching to false)\\n\");\n     m_cached_finished_ibd.store(true, std::memory_order_relaxed);\n+    // Important that this comes *after* the previous line, else we'll wind up in an\n+    // infinite recursion.\n+    m_chainman.MaybeRebalanceCaches();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1304849858",
      "id" : 1304849858,
      "in_reply_to_id" : 1296254459,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Nxm3C",
      "original_commit_id" : "5ea9abfbac3543f2d2cef90a1528abed35623822",
      "original_line" : 1647,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1594433276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849858/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-24T20:47:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304849858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased, but only part of the way addressing all feedback so far.\r\n\r\n- Took @ryanofsky's net_processing cleanup commit\r\n- Better error handling in loadtxoutset (@theStack)\r\n- Cleaned up unnecessary chainstate roles (@dergoegge, @ryanofsky)\r\n  - Refactoring and behavior changes are now separate commits\r\n",
      "created_at" : "2023-08-24T21:11:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1692415097",
      "id" : 1692415097,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585k4DR5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1692415097/reactions"
      },
      "updated_at" : "2023-08-24T21:11:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1692415097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305702150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305702150"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, makes sense. Done!",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T14:01:32Z",
      "diff_hunk" : "@@ -1901,7 +1970,10 @@ void PeerManagerImpl::BlockDisconnected(const std::shared_ptr<const CBlock> &blo\n  * Maintain state about the best-seen block and fast-announce a compact block\n  * to compatible peers.\n  */\n-void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock)\n+void PeerManagerImpl::NewPoWValidBlock(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305702150",
      "id" : 1305702150,
      "in_reply_to_id" : 1290237668,
      "line" : 1965,
      "node_id" : "PRRC_kwDOABII585N028G",
      "original_commit_id" : "253bcd5fd392f70de82ec7c675f9777d1e098d50",
      "original_line" : 1965,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 160,
      "pull_request_review_id" : 1595799643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305702150/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T14:01:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305702150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305760028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305760028"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Okay, good points. I've removed this error message completely and instead have implemented the behavior that the snapshot chainstate is completely removed during `-reindex{-chainstate}`. This is consistent with the spirit of the existing reindex operation, I think. The change is also about as simple as this one.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T14:45:34Z",
      "diff_hunk" : "@@ -185,7 +185,14 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     chainman.InitializeChainstate(options.mempool);\n \n     // Load a chain created from a UTXO snapshot, if any exist.\n-    chainman.DetectSnapshotChainstate(options.mempool);\n+    bool has_snapshot = chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    if (has_snapshot && (options.reindex || options.reindex_chainstate)) {\n+        return {ChainstateLoadStatus::FAILURE_NO_REINDEX, _(\n+            \"Reindex cannot be performed while background validation is in progress. \"\n+            \"Please wait for background sync to complete, or delete data directory \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305760028",
      "id" : 1305760028,
      "in_reply_to_id" : 1291426426,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585N1FEc",
      "original_commit_id" : "3b9d3d63d9ccb609ec08da34776f7c5f29d21a20",
      "original_line" : 193,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305760028/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305760028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305781595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305781595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I went to change this and found that, surprisingly, massaging `find_if` into a `std::optional` output was actually wordier than the current approach:\r\n```diff\r\ndiff --git a/src/util/vector.h b/src/util/vector.h\r\nindex 9cd5e118a6..32d1e7f933 100644\r\n--- a/src/util/vector.h\r\n+++ b/src/util/vector.h\r\n@@ -54,12 +54,12 @@ inline V Cat(V v1, const V& v2)\r\n template<typename V, typename L>\r\n inline std::optional<V> FindFirst(const std::vector<V>& vec, const L fnc)\r\n {\r\n-    for (const auto& el : vec) {\r\n-        if (fnc(el)) {\r\n-            return el;\r\n-        }\r\n+    auto got = std::find_if(vec.begin(), vec.end(), fnc);\r\n+    if (got != vec.end()) {\r\n+        return *got;\r\n+    } else {\r\n+        return std::nullopt;\r\n     }\r\n-    return std::nullopt;\r\n }\r\n \r\n #endif // BITCOIN_UTIL_VECTOR_H\r\n```",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T15:03:12Z",
      "diff_hunk" : "@@ -49,4 +51,15 @@ inline V Cat(V v1, const V& v2)\n     return v1;\n }\n \n+template<typename V, typename L>\n+inline std::optional<V> FindFirst(const std::vector<V>& vec, const L fnc)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305781595",
      "id" : 1305781595,
      "in_reply_to_id" : 1291431562,
      "line" : 55,
      "node_id" : "PRRC_kwDOABII585N1KVb",
      "original_commit_id" : "cdb73e44b7f0d4ea186ba657ddf7809434f0a12a",
      "original_line" : 55,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/util/vector.h",
      "position" : 15,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305781595/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305781595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305885944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305885944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, added release notes for ZMQ.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T16:28:30Z",
      "diff_hunk" : "@@ -173,6 +174,9 @@ void CZMQNotificationInterface::TransactionRemovedFromMempool(const CTransaction\n \n void CZMQNotificationInterface::BlockConnected(const ChainstateRole role, const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected)\n {\n+    if (role == ChainstateRole::BACKGROUND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305885944",
      "id" : 1305885944,
      "in_reply_to_id" : 1291620032,
      "line" : 177,
      "node_id" : "PRRC_kwDOABII585N1jz4",
      "original_commit_id" : "f2a15428277090d6ad387de6d517303b9bc4e2af",
      "original_line" : 177,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 25,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305885944/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305885944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305946231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305946231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, agree this is weirdly implicit and am open to alternative approaches here. Since we expect headers to sync within a relatively short amount of time, I can see the utility of waiting. If anyone has strong feelings here please chime in.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T17:27:01Z",
      "diff_hunk" : "@@ -2699,6 +2699,86 @@ UniValue CreateUTXOSnapshot(\n     return result;\n }\n \n+static RPCHelpMan loadtxoutset()\n+{\n+    return RPCHelpMan{\n+        \"loadtxoutset\",\n+        \"Load the serialized UTXO set from disk.\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                \"path to the snapshot file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::ELISION, \"\", \"\",\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"loadtxoutset\", \"utxo.dat\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    fs::path path = fs::PathFromString(request.params[0].get_str());\n+    if (path.is_relative()) {\n+        path = gArgs.GetDataDirNet() / path;\n+    }\n+    FILE* file{fsbridge::fopen(path, \"rb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    SnapshotMetadata metadata;\n+    afile >> metadata;\n+\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+    int max_secs_to_wait_for_headers = 60 * 10;\n+    CBlockIndex* snapshot_start_block = nullptr;\n+\n+    LogPrintf(\"[snapshot] waiting to see blockheader %s in headers chain before snapshot activation\\n\",\n+        base_blockhash.ToString());\n+\n+    NodeContext& node = EnsureAnyNodeContext(request.context);\n+    ChainstateManager& chainman = *node.chainman;\n+\n+    while (max_secs_to_wait_for_headers > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305946231",
      "id" : 1305946231,
      "in_reply_to_id" : 1291670706,
      "line" : 2745,
      "node_id" : "PRRC_kwDOABII585N1yh3",
      "original_commit_id" : "8ac7427b41fdec1dbc7e06d0aa2c0e469b879ba2",
      "original_line" : 2745,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 47,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305946231/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305946231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305947674"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305947674"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah I definitely think we can be smarter about pruning, but because we do it chainstate-by-chainstate I think that better management of the prune budget between chainstates might take a little more rework. Maybe something for a follow-up?",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T17:28:38Z",
      "diff_hunk" : "@@ -153,31 +158,54 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    unsigned int min_block_to_prune;\n+    unsigned int nLastBlockWeCanPrune;\n+\n+    std::tie(min_block_to_prune, nLastBlockWeCanPrune) = chainman.GetPruneRange(\n+        chain, chain_tip_height);\n+\n+    nLastBlockWeCanPrune = std::min(nLastBlockWeCanPrune, (unsigned)nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > nLastBlockWeCanPrune || fileinfo.nHeightFirst < min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), nLastBlockWeCanPrune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int chain_tip_height,\n+    int prune_height,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = GetPruneTarget() / chainman.GetAll().size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305947674",
      "id" : 1305947674,
      "in_reply_to_id" : 1291649621,
      "line" : 195,
      "node_id" : "PRRC_kwDOABII585N1y4a",
      "original_commit_id" : "9e2b8ef836aeb1dc2e4b57449fc56badebea6772",
      "original_line" : 195,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 66,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305947674/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305947674",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305951844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305951844"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T17:32:42Z",
      "diff_hunk" : "@@ -3178,15 +3179,16 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n             // Enqueue while holding cs_main to ensure that UpdatedBlockTip is called in the order in which blocks are connected\n             if (pindexFork != pindexNewTip) {\n                 // Notify ValidationInterface subscribers\n-                GetMainSignals().UpdatedBlockTip(pindexNewTip, pindexFork, fInitialDownload);\n-\n-                // Always notify the UI if a new block tip was connected\n-                if (kernel::IsInterrupted(m_chainman.GetNotifications().blockTip(GetSynchronizationState(fInitialDownload), *pindexNewTip))) {\n-                    // Just breaking and returning success for now. This could\n-                    // be changed to bubble up the kernel::Interrupted value to\n-                    // the caller so the caller could distinguish between\n-                    // completed and interrupted operations.\n-                    break;\n+                GetMainSignals().UpdatedBlockTip(this->GetRole(), pindexNewTip, pindexFork, fInitialDownload);\n+\n+                if (this == &m_chainman.ActiveChainstate() &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305951844",
      "id" : 1305951844,
      "in_reply_to_id" : 1303334266,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585N1z5k",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 3184,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305951844/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305951844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305965612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305965612"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, I think these are a vestige when mempool ownership wasn't so clear. I've removed them.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-25T17:45:09Z",
      "diff_hunk" : "@@ -87,13 +88,13 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.\n      */\n-    virtual void UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) {}\n+    virtual void UpdatedBlockTip(const ChainstateRole, const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) {}\n     /**\n      * Notifies listeners of a transaction having been added to mempool.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1305965612",
      "id" : 1305965612,
      "in_reply_to_id" : 1303342871,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585N13Qs",
      "original_commit_id" : "2856710077abbc8f07a97adfff5f6829358155be",
      "original_line" : 97,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : null,
      "pull_request_review_id" : 1595889617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305965612/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-25T18:21:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305965612",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Okay, the latest rebase is pushed, and I believe I've addressed all outstanding feedback (with the exception of two marginal comments from @ryanofsky relating to the first commit here, which perhaps I'll leave to @sdaftuar... unless he doesn't get back in some amount of time, in which case I'll take a look myself).\r\n\r\nI've iterated through all commits to ensure they build and pass the chainstate unittests. I've also fixed the intermediate-commit test failure that @Sjors discovered, which was based on not updating the unittest to use a \"recognized\" snapshot early enough. I've introduced a commit that fixes that sequencing.\r\n\r\nFor anyone curious, the tag updates here are [`au.029`](https://github.com/jamesob/bitcoin/tree/au.029) -> [`au.031`](https://github.com/jamesob/bitcoin/tree/au.031) ([GitHub range diff](https://github.com/jamesob/bitcoin/compare/au.029..au.031)) but the diff is kind of useless because of the rebase.\r\n\r\nMuch more useful is doing the range-diff locally yourself:\r\n```sh\r\ngit range-diff master jamesob/au.029 jamesob/au.031\r\n```\r\n\r\nThanks again for continued review and testing @ryanofsky @dergoegge @fjahr @Sjors @theStack @achow101 @D33r-Gee @ismaelsadeeq @alexanderwiederin @mzumsande @hazeycode and anyone else I forgot.",
      "created_at" : "2023-08-25T18:20:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1693764004",
      "id" : 1693764004,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585k9Mmk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1693764004/reactions"
      },
      "updated_at" : "2023-08-25T18:20:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1693764004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Small update, I did a lot of manual testing on 157e510bc6deaaca43401f15f10105e44926ca68 while also monitoring stats like the size of the datadir etc. I mostly created my own snapshots on the current tip and then patched chainparams myself to be able to use them to push the limit a bit. It worked well and I didn't run into any issues aside from what I mention in #28350 which is not only an assumeutxo problem.",
      "created_at" : "2023-08-27T12:50:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#issuecomment-1694660622",
      "id" : 1694660622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27596",
      "node_id" : "IC_kwDOABII585lAngO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1694660622/reactions"
      },
      "updated_at" : "2023-08-27T12:50:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1694660622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307949616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307949616"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: Request assumeutxo background chain blocks\" (08a34e56ba7aa8714982d352238f1cb6eba43e29)\r\n\r\nSuggested comment updates to clarify effect of passing `activeChain` and better describe what it means for a `nodeStaller` value to be returned:\r\n\r\n```diff\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -906,18 +906,20 @@ private:\r\n     * \\param nWindowEnd   Maximum height of blocks to allow in vBlocks. No\r\n     *                     blocks will be added above this height.\r\n     * \\param activeChain  Optional pointer to a chain to compare against. If\r\n-    *                     provided, any blocks contained by this chain will only\r\n-    *                     be used to update state->pindexLastCommonBlock, and\r\n-    *                     will not be appended to vBlocks.\r\n+    *                     provided, any next blocks which are already contained\r\n+    *                     in this chain will not be appended to vBlocks, but\r\n+    *                     instead will be used to update the\r\n+    *                     state->pindexLastCommonBlock pointer.\r\n     * \\param nodeStaller  Optional pointer to a NodeId variable that will receive\r\n     *                     the ID of another peer that might be causing this peer\r\n     *                     to stall. This is set to the ID of the peer which\r\n     *                     first requested the first in-flight block in the\r\n     *                     download window. It is only set if vBlocks is empty at\r\n     *                     the end of this function call and if increasing\r\n-    *                     nWindowEnd by 1 would have caused it to be non-empty\r\n-    *                     (which indicates the download might be stalled since\r\n-    *                     every block in the window is in flight.)\r\n+    *                     nWindowEnd by 1 would cause it to be non-empty (which\r\n+    *                     indicates the download might be stalled because every\r\n+    *                     block in the window is in flight and no other peer is\r\n+    *                     trying to download the next block).\r\n     */\r\n     void FindNextBlocks(std::vector<const CBlockIndex*>& vBlocks, const Peer& peer, CNodeState *state, const CBlockIndex *pindexWalk, unsigned int count, int nWindowEnd, const CChain* activeChain=nullptr, NodeId* nodeStaller=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n \r\n```",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:04:29Z",
      "diff_hunk" : "@@ -892,6 +892,35 @@ class PeerManagerImpl final : public PeerManager\n      */\n     void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    void TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex* from_tip, const CBlockIndex* target_block) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    /**\n+    * \\brief Find next blocks to download from a peer after a starting block.\n+    *\n+    * \\param vBlocks      Vector of blocks to download which will be appended to.\n+    * \\param peer         ID of peer which blocks will be downloaded from.\n+    * \\param state        Pointer to the state of the peer.\n+    * \\param pindexWalk   Pointer to the starting block to add to vBlocks.\n+    * \\param count        Maximum number of blocks to allow in vBlocks. No more\n+    *                     blocks will be added if it reaches this size.\n+    * \\param nWindowEnd   Maximum height of blocks to allow in vBlocks. No\n+    *                     blocks will be added above this height.\n+    * \\param activeChain  Optional pointer to a chain to compare against. If\n+    *                     provided, any blocks contained by this chain will only\n+    *                     be used to update state->pindexLastCommonBlock, and\n+    *                     will not be appended to vBlocks.\n+    * \\param nodeStaller  Optional pointer to a NodeId variable that will receive\n+    *                     the ID of another peer that might be causing this peer\n+    *                     to stall. This is set to the ID of the peer which\n+    *                     first requested the first in-flight block in the\n+    *                     download window. It is only set if vBlocks is empty at\n+    *                     the end of this function call and if increasing\n+    *                     nWindowEnd by 1 would have caused it to be non-empty\n+    *                     (which indicates the download might be stalled since\n+    *                     every block in the window is in flight.)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307949616",
      "id" : 1307949616,
      "line" : 921,
      "node_id" : "PRRC_kwDOABII585N9bow",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 920,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 55,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307949616/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307949616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307955088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307955088"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1294879351\r\n\r\n> This is an exaggeration, right?\r\n\r\nIn commit \"net_processing: Request assumeutxo background chain blocks\" (08a34e56ba7aa8714982d352238f1cb6eba43e29)\r\n\r\nStill curious about this and think it would be good to either explain it more, or change the behavior, or just s/useless/less useful/ if that would be more accurate to avoid confusion.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:11:24Z",
      "diff_hunk" : "@@ -1406,6 +1409,62 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     }\n }\n \n+void PeerManagerImpl::TryDownloadingHistoricalBlocks(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, const CBlockIndex *from_tip, const CBlockIndex* target_block)\n+{\n+    if (vBlocks.size() >= count) {\n+        return;\n+    }\n+\n+    vBlocks.reserve(count);\n+    CNodeState *state = State(peer.m_id);\n+    assert(state != nullptr);\n+\n+    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->GetAncestor(target_block->nHeight) != target_block) {\n+        // This peer is useless to us -- it has a chain that doesn't contain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307955088",
      "id" : 1307955088,
      "in_reply_to_id" : 1294879351,
      "line" : 1395,
      "node_id" : "PRRC_kwDOABII585N9c-Q",
      "original_commit_id" : "6be9fd22ee2b9759cdd30a7bca4d07a9346eb57b",
      "original_line" : 1395,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 95,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307955088/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307955088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307957163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307957163"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: Request assumeutxo background chain blocks\" (08a34e56ba7aa8714982d352238f1cb6eba43e29)\r\n\r\nAny reason these two lines are moving? This change seems like it have been accidentally added in a rebase. Would probably be good to revert.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:14:12Z",
      "diff_hunk" : "@@ -1036,12 +1033,25 @@ class ChainstateManager\n     //! Otherwise, revert to using the ibd chainstate and shutdown.\n     SnapshotCompletionResult MaybeCompleteSnapshotValidation() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Returns nullptr if no snapshot has been loaded.\n+    const CBlockIndex* GetSnapshotBaseBlock() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307957163",
      "id" : 1307957163,
      "line" : 1046,
      "node_id" : "PRRC_kwDOABII585N9der",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 1037,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 60,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307957163/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307957163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307968803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307968803"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: Request assumeutxo background chain blocks\" (08a34e56ba7aa8714982d352238f1cb6eba43e29)\r\n\r\n`background_sync_state` variable is not actually referenced below, and code which locks and unlocks cs_main twice seems potentially racy. Would suggest cleaning this up with:\r\n\r\n```diff\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -4070,10 +4070,11 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\r\n     if (!ActiveChainstate().ActivateBestChain(state, block)) {\r\n         return error(\"%s: ActivateBestChain failed (%s)\", __func__, state.ToString());\r\n     }\r\n-    BlockValidationState background_sync_state;\r\n-    if (WITH_LOCK(::cs_main, return BackgroundSyncInProgress()) &&\r\n-            !WITH_LOCK(::cs_main, return *m_ibd_chainstate).ActivateBestChain(state, block)) {\r\n-        return error(\"%s: [background] ActivateBestChain failed (%s)\", __func__, state.ToString());\r\n+\r\n+    Chainstate* bg_chain{WITH_LOCK(cs_main, return BackgroundSyncInProgress() ? m_ibd_chainstate.get() : nullptr)};\r\n+    BlockValidationState bg_state;\r\n+    if (bg_chain && !bg_chain->ActivateBestChain(bg_state, block)) {\r\n+        return error(\"%s: [background] ActivateBestChain failed (%s)\", __func__, bg_state.ToString());\r\n     }\r\n \r\n     return true;\r\n```",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:24:09Z",
      "diff_hunk" : "@@ -4070,6 +4070,11 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n     if (!ActiveChainstate().ActivateBestChain(state, block)) {\n         return error(\"%s: ActivateBestChain failed (%s)\", __func__, state.ToString());\n     }\n+    BlockValidationState background_sync_state;\n+    if (WITH_LOCK(::cs_main, return BackgroundSyncInProgress()) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307968803",
      "id" : 1307968803,
      "line" : 4117,
      "node_id" : "PRRC_kwDOABII585N9gUj",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 4074,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 174,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307968803/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307968803",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307984332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307984332"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: Request assumeutxo background chain blocks\" (08a34e56ba7aa8714982d352238f1cb6eba43e29)\r\n\r\nIt seems impossible that target could be nullptr here if condition above is true and cs_main is held. Would be clearer to just `assert(target)` rather than checking for this condition which should be impossible. Or if this is actually expected would be good to add a comment saying when target may be null.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:35:54Z",
      "diff_hunk" : "@@ -5831,6 +5889,14 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             std::vector<const CBlockIndex*> vToDownload;\n             NodeId staller = -1;\n             FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.vBlocksInFlight.size(), vToDownload, staller);\n+            if (m_chainman.BackgroundSyncInProgress() && !IsLimitedPeer(*peer)) {\n+                const CBlockIndex *target = m_chainman.GetSnapshotBaseBlock();\n+                if (target != nullptr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307984332",
      "id" : 1307984332,
      "line" : 5911,
      "node_id" : "PRRC_kwDOABII585N9kHM",
      "original_commit_id" : "08a34e56ba7aa8714982d352238f1cb6eba43e29",
      "original_line" : 5894,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 178,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307984332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307984332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307996274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307996274"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"assumeutxo: remove snapshot during -reindex{-chainstate}\" (1755c53365d53693213a721138a44bdd889d8794)\r\n\r\nReturn value from this delete is being ignored. I think DeleteSnapshotChainstate should return a bool and return false if this fails. It would also be good to mark both functions [[nodiscard]] and exit with InitError if the DeleteSnapshotChainstate call fails. I don't think it makes sense to ignore the failure and do a partial reindexing of the background chain only.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T21:52:22Z",
      "diff_hunk" : "@@ -5712,6 +5717,18 @@ util::Result<void> Chainstate::InvalidateCoinsDBOnDisk()\n     return {};\n }\n \n+void ChainstateManager::DeleteSnapshotChainstate()\n+{\n+    AssertLockHeld(::cs_main);\n+    Assert(m_snapshot_chainstate);\n+    Assert(m_ibd_chainstate);\n+\n+    fs::path snapshot_datadir = GetSnapshotCoinsDBPath(*m_snapshot_chainstate);\n+    DeleteCoinsDBFromDisk(snapshot_datadir, /*is_snapshot=*/ true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1307996274",
      "id" : 1307996274,
      "line" : 5767,
      "node_id" : "PRRC_kwDOABII585N9nBy",
      "original_commit_id" : "1755c53365d53693213a721138a44bdd889d8794",
      "original_line" : 5727,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 320,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307996274/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1307996274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308014826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308014826"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: MaybeRebalanceCaches when chain leaves IBD\" (3e7d3537fc06c8aff8a48edc8f179a70af46e04c)\r\n\r\nI think it would be helpful to have a reminder about why this is necessary, maybe \"// Call MaybeRebalanceCaches in case background and snapshot chainstates both exist, and the snapshot chainstate is almost finished downloading blocks, so more resources can be shifted to the background download.\"",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T22:21:44Z",
      "diff_hunk" : "@@ -3195,6 +3202,11 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n         }\n         // When we reach this point, we switched to a new tip (stored in pindexNewTip).\n \n+        if (exited_ibd) {\n+            LOCK(::cs_main);\n+            m_chainman.MaybeRebalanceCaches();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308014826",
      "id" : 1308014826,
      "line" : 3217,
      "node_id" : "PRRC_kwDOABII585N9rjq",
      "original_commit_id" : "3e7d3537fc06c8aff8a48edc8f179a70af46e04c",
      "original_line" : 3207,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 122,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308014826/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308014826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308025208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308025208"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainstateRole\" (95f45e38b5e47eaef56468909d04418b93e9c962)\r\n\r\nI don't have a specific suggestion here, just an observation that this method seems like it is called from multiple threads but it doesn't require cs_main. So potentially there could be a race condition where a snapshot is loaded during this call, or validated during this call and it returns a stale value. I think this is not a new issue, since returning stale values also seems to be characteristic of the existing `GetAll()` and `ActiveChainstate()` methods. But in the long term it would probably be better if all of these methods were marked `EXCLUSIVE_LOCKS_REQUIRED(cs_main)` and stopped acquiring `cs_main` internally so they could not return stale values and create potential race conditions.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T22:38:42Z",
      "diff_hunk" : "@@ -5729,6 +5729,16 @@ void ChainstateManager::DeleteSnapshotChainstate()\n     m_snapshot_chainstate.reset();\n }\n \n+ChainstateRole Chainstate::GetRole() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308025208",
      "id" : 1308025208,
      "line" : 5772,
      "node_id" : "PRRC_kwDOABII585N9uF4",
      "original_commit_id" : "95f45e38b5e47eaef56468909d04418b93e9c962",
      "original_line" : 5732,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 325,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308025208/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308025208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308029027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308029027"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: only call UpdatedBlockTip for active chainstate\" (9eda8224119450b8614837e0c8decfc81a6b9915)\r\n\r\nCould update commit message to mention that in addition to skipping `CValidationInterface::UpdatedBlockTip` notifications for the background chainstate, it also skips `kernel::Notifications::blockTip` notifications.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T22:45:57Z",
      "diff_hunk" : "@@ -3186,7 +3186,7 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n \n             // Notify external listeners about the new tip.\n             // Enqueue while holding cs_main to ensure that UpdatedBlockTip is called in the order in which blocks are connected\n-            if (pindexFork != pindexNewTip) {\n+            if (this == &m_chainman.ActiveChainstate() && pindexFork != pindexNewTip) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308029027",
      "id" : 1308029027,
      "line" : 3199,
      "node_id" : "PRRC_kwDOABII585N9vBj",
      "original_commit_id" : "9eda8224119450b8614837e0c8decfc81a6b9915",
      "original_line" : 3189,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 105,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308029027/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308029027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308031241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308031241"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2873d91ada1c240de280a35bbf169ed0c708e057)\r\n\r\nArgument order here is a little weird. It would make more sense for it to be `obj, role` rather than `role, obj` so the object is still first and so `role` is right before `block` just like everywhere else.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T22:50:05Z",
      "diff_hunk" : "@@ -19,7 +19,11 @@ struct TestChainstateManager : public ChainstateManager {\n class ValidationInterfaceTest\n {\n public:\n-    static void BlockConnected(CValidationInterface& obj, const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex);\n+    static void BlockConnected(\n+        const ChainstateRole role,\n+        CValidationInterface& obj,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308031241",
      "id" : 1308031241,
      "line" : 24,
      "node_id" : "PRRC_kwDOABII585N9vkJ",
      "original_commit_id" : "2873d91ada1c240de280a35bbf169ed0c708e057",
      "original_line" : 24,
      "original_position" : 7,
      "original_start_line" : 23,
      "path" : "src/test/util/validation.h",
      "position" : 7,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308031241/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 23,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308031241",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308032026"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308032026"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2873d91ada1c240de280a35bbf169ed0c708e057)\r\n\r\nWould make more sense to update this comment in the previous commit \"validation: only call UpdatedBlockTip for active chainstate\" (9eda8224119450b8614837e0c8decfc81a6b9915) instead of this commit.\r\n",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T22:51:43Z",
      "diff_hunk" : "@@ -87,7 +88,7 @@ class CValidationInterface {\n      * but may not be called on every intermediate tip. If the latter behavior is desired,\n      * subscribe to BlockConnected() instead.\n      *\n-     * Called on a background thread.\n+     * Called on a background thread. Only called for the active chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308032026",
      "id" : 1308032026,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII585N9vwa",
      "original_commit_id" : "2873d91ada1c240de280a35bbf169ed0c708e057",
      "original_line" : 91,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 13,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308032026/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308032026",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308039060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308039060"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pass ChainstateRole for validationinterface calls\" (2873d91ada1c240de280a35bbf169ed0c708e057)\r\n\r\nIgnore this comment if this was intentional, but it seems unusual to make the `ChainstateRole` parameter const, when the codebase doesn't use const value parameters in general or in this interface for other parameters like `MemPoolRemovalReason`. IMO the `const` just adds noise without being more safe, and makes the method less convenient to implement. But not a problem if this is just a style difference and was intended.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T23:05:30Z",
      "diff_hunk" : "@@ -199,11 +205,11 @@ class CMainSignals {\n     void UpdatedBlockTip(const CBlockIndex *, const CBlockIndex *, bool fInitialDownload);\n     void TransactionAddedToMempool(const CTransactionRef&, uint64_t mempool_sequence);\n     void TransactionRemovedFromMempool(const CTransactionRef&, MemPoolRemovalReason, uint64_t mempool_sequence);\n-    void BlockConnected(const std::shared_ptr<const CBlock> &, const CBlockIndex *pindex);\n+    void BlockConnected(const ChainstateRole, const std::shared_ptr<const CBlock> &, const CBlockIndex *pindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308039060",
      "id" : 1308039060,
      "line" : 208,
      "node_id" : "PRRC_kwDOABII585N9xeU",
      "original_commit_id" : "2873d91ada1c240de280a35bbf169ed0c708e057",
      "original_line" : 208,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 64,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308039060/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308039060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308042767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308042767"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validationinterface: only send zmq notifications for active\" (b48729144fba1dbc64d603b2644a76c3f00d44eb)\r\n\r\nI'm surprised to see this release note. It seems like no observable behavior change could be happening with this PR because it wasn't possible to load a snapshot previously. If this is the case, I think putting this information in release notes could only be confusing and it would be better to document this behavior in `doc/zmq.md` instead",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T23:13:14Z",
      "diff_hunk" : "@@ -0,0 +1,7 @@\n+ZMQ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308042767",
      "id" : 1308042767,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII585N9yYP",
      "original_commit_id" : "b48729144fba1dbc64d603b2644a76c3f00d44eb",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "doc/release-notes-27596.md",
      "position" : 1,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308042767/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308042767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308047801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308047801"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validationinterface: only send zmq notifications for active\" (b48729144fba1dbc64d603b2644a76c3f00d44eb)\r\n\r\nThis seems like no-op change that could be reverted. Or if this is supposed to be a style cleanup, would probably make sense to add {} and modernize it since the line is changing anyway.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T23:22:33Z",
      "diff_hunk" : "@@ -144,7 +144,8 @@ void TryForEachAndRemoveFailed(std::list<std::unique_ptr<CZMQAbstractNotifier>>&\n \n void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload)\n {\n-    if (fInitialDownload || pindexNew == pindexFork) // In IBD or blocks were disconnected without any new ones\n+    // In IBD or blocks were disconnected without any new ones\n+    if (fInitialDownload || pindexNew == pindexFork)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308047801",
      "id" : 1308047801,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII585N9zm5",
      "original_commit_id" : "b48729144fba1dbc64d603b2644a76c3f00d44eb",
      "original_line" : 148,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 14,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308047801/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308047801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308053648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308053648"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"index: cache indexer references on ChainstateManager\" (688b68f34fe061c3064a516cdf77d4c155bfcafd)\r\n\r\nHaven't reviewed later commits yet, but it seems not ideal for ChainstateManager to be aware of indexes. I think it would might be better to add a new ValidationInterface method that indexes (and wallets) could handle to start resyncing themselves whenever the background download finishes. \r\n\r\nMinor: Since this is a member, should be prefixed with `m_`. Also would be good to `s/indexer/index/` everywhere for consistency with `NodeContext::indexes and other index variables. (In general I think \"index\" sounds better than \"indexer\" and \"indexing\" sounds better than \"indexation\" to stick to more common terms.)\r\n\r\n",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-28T23:35:37Z",
      "diff_hunk" : "@@ -909,6 +910,8 @@ class ChainstateManager\n \n     explicit ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options);\n \n+    std::vector<BaseIndex*> indexers{};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308053648",
      "id" : 1308053648,
      "line" : 909,
      "node_id" : "PRRC_kwDOABII585N91CQ",
      "original_commit_id" : "688b68f34fe061c3064a516cdf77d4c155bfcafd",
      "original_line" : 913,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 46,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308053648/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308053648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308066452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066452"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: validationinterface: ignore some events for bg chain\" (5d096add65e84530c907b5ee934af144067d5ef1)\r\n\r\nThis could probably loop over `node.indexes` instead of `chainman.indexers` and then the `chainman.indexers` variable could be eliminated.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:04:25Z",
      "diff_hunk" : "@@ -1473,6 +1473,26 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         node.chainman = std::make_unique<ChainstateManager>(node.kernel->interrupt, chainman_opts, blockman_opts);\n         ChainstateManager& chainman = *node.chainman;\n \n+        // This is defined and set here instead of inline in validation.h to avoid a hard\n+        // dependency between validation and index/base, since the latter is not in\n+        // libbitcoinkernel.\n+        chainman.restart_indexers = [](const ChainstateManager& chainman) {\n+            LogPrintf(\"[snapshot] restarting indexers\\n\");\n+\n+            // Drain the validation interface queue to ensure that the old indexers\n+            // don't have any pending work.\n+            SyncWithValidationInterfaceQueue();\n+\n+            for (auto* indexer : chainman.indexers) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308066452",
      "id" : 1308066452,
      "line" : 1486,
      "node_id" : "PRRC_kwDOABII585N94KU",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 1486,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 14,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066452/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308066973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066973"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: validationinterface: ignore some events for bg chain\" (5d096add65e84530c907b5ee934af144067d5ef1)\r\n\r\nWould be nice to s/indexers/indexes/, s/indexer/s/index/ /s/indexation/indexing/ everywhere.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:05:37Z",
      "diff_hunk" : "@@ -1473,6 +1473,26 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         node.chainman = std::make_unique<ChainstateManager>(node.kernel->interrupt, chainman_opts, blockman_opts);\n         ChainstateManager& chainman = *node.chainman;\n \n+        // This is defined and set here instead of inline in validation.h to avoid a hard\n+        // dependency between validation and index/base, since the latter is not in\n+        // libbitcoinkernel.\n+        chainman.restart_indexers = [](const ChainstateManager& chainman) {\n+            LogPrintf(\"[snapshot] restarting indexers\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308066973",
      "id" : 1308066973,
      "line" : 1480,
      "node_id" : "PRRC_kwDOABII585N94Sd",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 1480,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 8,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066973/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308066973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308070723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308070723"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: validationinterface: ignore some events for bg chain\" (5d096add65e84530c907b5ee934af144067d5ef1)\r\n\r\nWould suggest simplifying function type to `std::function<void()>` because handler should be able to determine what state is needs to run and capture it explicitly. Also the reference might be unnecessary if the m_indexers variable is removed as suggested.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:13:48Z",
      "diff_hunk" : "@@ -911,6 +911,10 @@ class ChainstateManager\n     explicit ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options);\n \n     std::vector<BaseIndex*> indexers{};\n+    //! Function to restart active indexers; set dynamically to avoid a circular\n+    //! dependency on `base/index.cpp`.\n+    std::function<void(const ChainstateManager&)> restart_indexers =",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308070723",
      "id" : 1308070723,
      "line" : 912,
      "node_id" : "PRRC_kwDOABII585N95ND",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 916,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 49,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308070723/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308070723",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308071774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308071774"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: validationinterface: ignore some events for bg chain\" (5d096add65e84530c907b5ee934af144067d5ef1)\r\n\r\nI'm surprised this method can't just return `m_ibd_chainstate.get()`. It would be good to simplify this code if possible or else add some explanation for the logic, which seems pretty complicated.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:16:15Z",
      "diff_hunk" : "@@ -5838,3 +5848,9 @@ bool ChainstateManager::ValidatedSnapshotCleanup()\n     }\n     return true;\n }\n+\n+Chainstate& ChainstateManager::GetChainstateForIndexing()\n+{\n+    return (IsSnapshotActive() && !IsSnapshotValidated()) ?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308071774",
      "id" : 1308071774,
      "line" : 5882,
      "node_id" : "PRRC_kwDOABII585N95de",
      "original_commit_id" : "5d01151b41b244dabeda54122400df17a3dfc4d2",
      "original_line" : 5854,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 345,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308071774/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308071774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308075373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308075373"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nI think it would be good `assert(snapshot_height)` or else add a comment saying when `snapshot_height` is expected to be `nullopt`, rather than write code that seems like it is trying to handle an impossible condition.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:25:06Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    unsigned int prune_start{0};\n+\n+    if (this->GetAll().size() > 1) {\n+        std::optional<int> snapshot_height{GetSnapshotBaseHeight()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308075373",
      "id" : 1308075373,
      "line" : 5895,
      "node_id" : "PRRC_kwDOABII585N96Vt",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5876,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 358,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308075373/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308075373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308076179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308076179"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nSeems like the code would be a little simpler if this said `if (this->GetAll().size() > 1 && &chainstate == m_snapshot_chainstate.get())` so relevant conditions would be stated up front, and nested if statement below could go away",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:26:50Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    unsigned int prune_start{0};\n+\n+    if (this->GetAll().size() > 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308076179",
      "id" : 1308076179,
      "line" : 5894,
      "node_id" : "PRRC_kwDOABII585N96iT",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5875,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 357,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308076179/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308076179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308082844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308082844"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nWould definitely suggest using plain `int` instead of `unsigned int` for heights everywhere to avoid overflow bugs and extra type casts. The rest of the code represents block heights with ints, and unsigned types are great for representing bits but less great at representing quantities you would like to perform arithmetic on.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:42:46Z",
      "diff_hunk" : "@@ -1248,6 +1244,17 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.\n+    //!\n+    //! If we're pruning the snapshot chainstate, be sure not to\n+    //! prune blocks being used by the background chainstate.\n+    std::pair<unsigned int, unsigned int> GetPruneRange(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308082844",
      "id" : 1308082844,
      "line" : 1251,
      "node_id" : "PRRC_kwDOABII585N98Kc",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 1251,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 110,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308082844/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308082844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308085308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308085308"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: validationinterface: ignore some events for bg chain\" (5d096add65e84530c907b5ee934af144067d5ef1)\r\n\r\nProbably doesn't matter in practice, but according to the function documentation, this would indicate the pruning range includes the genesis block. Would suggest returning `{1, 0}` here and also initializing `prune_start` to 1 instead of 0 below.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T00:48:47Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308085308",
      "id" : 1308085308,
      "line" : 5890,
      "node_id" : "PRRC_kwDOABII585N98w8",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5871,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 353,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308085308/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308085308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308096895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308096895"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nNo reason to pass `m_chain.Height()` here anymore now this is passing `*this` chainstate reference. Having the redundant parameter makes code in the function more complicated and hard to follow because there are multiple variables referring to the same height.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T01:16:55Z",
      "diff_hunk" : "@@ -2474,11 +2475,19 @@ bool Chainstate::FlushStateToDisk(\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, std::min(last_prune, nManualPruneHeight), m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(\n+                    setFilesToPrune,\n+                    std::min(last_prune, nManualPruneHeight),\n+                    m_chain.Height(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308096895",
      "id" : 1308096895,
      "line" : 2481,
      "node_id" : "PRRC_kwDOABII585N9_l_",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 2481,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 33,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308096895/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308096895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308104549"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308104549"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nSame as earlier comment, but again it is confusing to keep this `chain_tip_height` parameter which is redundant with the `chain` parameter and makes the implementation more complicated because there are multiple variables referring to the same height.\r\n\r\nAlso would suggest calling the `prune_height` parameter `last_prune` to be be more descriptive, and consistent with the argument that is passed in validation.cpp. Also could add documentation for the parameter as \"the last height we can prune\" or something similar.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T01:31:48Z",
      "diff_hunk" : "@@ -122,7 +128,13 @@ class BlockManager\n      *\n      * @param[out]   setFilesToPrune   The set of file indices that can be unlinked will be returned\n      */\n-    void FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd);\n+    void FindFilesToPrune(\n+        std::set<int>& setFilesToPrune,\n+        uint64_t nPruneAfterHeight,\n+        int chain_tip_height,\n+        int prune_height,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308104549",
      "id" : 1308104549,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585N-Bdl",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 135,
      "original_position" : 31,
      "original_start_line" : 134,
      "path" : "src/node/blockstorage.h",
      "position" : 86,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308104549/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 160,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308104549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308108294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308108294"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nWould be good to say that `start > end` is possible and indicates prune range is empty.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T01:40:36Z",
      "diff_hunk" : "@@ -1248,6 +1244,17 @@ class ChainstateManager\n     //!   fully validated chain.\n     Chainstate& GetChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return the [start, end] (inclusive) of block heights we can prune.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308108294",
      "id" : 1308108294,
      "line" : 1247,
      "node_id" : "PRRC_kwDOABII585N-CYG",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 1247,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 106,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308108294/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308108294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308114692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308114692"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nI think if you divide by 2 you also need to take max with MIN_DISK_SPACE_FOR_BLOCK_FILES to avoid going below the minimum supported pruning size.\r\n\r\nMaybe the easiest and most conservative thing to do for now would just be to keep the pruning target the same and just write documentation that says if you load a snapshot, you may temporarily need twice as much disk space as otherwise,",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T01:55:59Z",
      "diff_hunk" : "@@ -153,31 +158,54 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    unsigned int min_block_to_prune;\n+    unsigned int nLastBlockWeCanPrune;\n+\n+    std::tie(min_block_to_prune, nLastBlockWeCanPrune) = chainman.GetPruneRange(\n+        chain, chain_tip_height);\n+\n+    nLastBlockWeCanPrune = std::min(nLastBlockWeCanPrune, (unsigned)nManualPruneHeight);\n+\n     int count = 0;\n     for (int fileNumber = 0; fileNumber < m_last_blockfile; fileNumber++) {\n-        if (m_blockfile_info[fileNumber].nSize == 0 || m_blockfile_info[fileNumber].nHeightLast > nLastBlockWeCanPrune) {\n+        const auto& fileinfo = m_blockfile_info[fileNumber];\n+        if (fileinfo.nSize == 0 || fileinfo.nHeightLast > nLastBlockWeCanPrune || fileinfo.nHeightFirst < min_block_to_prune) {\n             continue;\n         }\n+\n         PruneOneBlockFile(fileNumber);\n         setFilesToPrune.insert(fileNumber);\n         count++;\n     }\n-    LogPrintf(\"Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\", nLastBlockWeCanPrune, count);\n+    LogPrintf(\"[%s] Prune (Manual): prune_height=%d removed %d blk/rev pairs\\n\",\n+        chain.GetRole(), nLastBlockWeCanPrune, count);\n }\n \n-void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPruneAfterHeight, int chain_tip_height, int prune_height, bool is_ibd)\n+void BlockManager::FindFilesToPrune(\n+    std::set<int>& setFilesToPrune,\n+    uint64_t nPruneAfterHeight,\n+    int chain_tip_height,\n+    int prune_height,\n+    const Chainstate& chain,\n+    ChainstateManager& chainman)\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n-    if (chain_tip_height < 0 || GetPruneTarget() == 0) {\n+    // Distribute our -prune budget over all chainstates.\n+    const auto target = GetPruneTarget() / chainman.GetAll().size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308114692",
      "id" : 1308114692,
      "in_reply_to_id" : 1291649621,
      "line" : 195,
      "node_id" : "PRRC_kwDOABII585N-D8E",
      "original_commit_id" : "9e2b8ef836aeb1dc2e4b57449fc56badebea6772",
      "original_line" : 195,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 66,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308114692/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308114692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308119179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308119179"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nCode would be simpler if this line were dropped and `nManualPruneHeight` was passed as the parameter to `GetPruneRange` above instead of `chain_tip_height`. Passing `chain_tip_height` above has no effect because `GetPruneRange` already takes the min with the `chain.m_chain.Height()`.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T02:07:57Z",
      "diff_hunk" : "@@ -153,31 +158,54 @@ void BlockManager::FindFilesToPruneManual(std::set<int>& setFilesToPrune, int nM\n         return;\n     }\n \n-    // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n-    unsigned int nLastBlockWeCanPrune = std::min((unsigned)nManualPruneHeight, chain_tip_height - MIN_BLOCKS_TO_KEEP);\n+    unsigned int min_block_to_prune;\n+    unsigned int nLastBlockWeCanPrune;\n+\n+    std::tie(min_block_to_prune, nLastBlockWeCanPrune) = chainman.GetPruneRange(\n+        chain, chain_tip_height);\n+\n+    nLastBlockWeCanPrune = std::min(nLastBlockWeCanPrune, (unsigned)nManualPruneHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308119179",
      "id" : 1308119179,
      "line" : 168,
      "node_id" : "PRRC_kwDOABII585N-FCL",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 167,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 34,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308119179/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308119179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308128467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308128467"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: pruning for multiple chainstates\" (b9ac4f7925e2d9dec67be06fdc2a381532581136)\r\n\r\nWould suggest compressing this all down to:\r\n\r\n```c++\r\n// Set the end of the prune range to the maximum height which is at least\r\n// MIN_BLOCKS_TO_KEEP blocks away from the chain tip, and is not higher than the\r\n// highest block that is allowed to be pruned according to the caller.\r\nprune_end = std::min(std::max<int>(0, chain_height - MIN_BLOCKS_TO_KEEP), last_prune);\r\n```\r\n\r\nAssuming `prune_height` is renamed back to `last_prune` as suggested earlier and made into an int.",
      "commit_id" : "e44815e9a754c967415402b34807633625393084",
      "created_at" : "2023-08-29T02:29:53Z",
      "diff_hunk" : "@@ -5854,3 +5863,40 @@ Chainstate& ChainstateManager::GetChainstateForIndexing()\n     return (IsSnapshotActive() && !IsSnapshotValidated()) ?\n         *m_ibd_chainstate : *m_active_chainstate;\n }\n+\n+std::pair<unsigned int, unsigned int> ChainstateManager::GetPruneRange(\n+    const Chainstate& chainstate, unsigned int prune_height)\n+{\n+    if (chainstate.m_chain.Height() <= 0) {\n+        return {0, 0};\n+    }\n+    unsigned int prune_start{0};\n+\n+    if (this->GetAll().size() > 1) {\n+        std::optional<int> snapshot_height{GetSnapshotBaseHeight()};\n+\n+        // Leave the blocks in the background IBD chain alone if we're pruning\n+        // the snapshot chain.\n+        if (&chainstate == m_snapshot_chainstate.get() && snapshot_height) {\n+            prune_start = *snapshot_height + 1;\n+        }\n+    }\n+\n+    unsigned int prune_end{0};\n+    unsigned int chain_height{static_cast<unsigned int>(chainstate.m_chain.Height())};\n+\n+    if (MIN_BLOCKS_TO_KEEP > chain_height) {\n+        // Prevent underflow.\n+        prune_end = 0;\n+    } else {\n+        // last block to prune is the lesser of (user-specified height, MIN_BLOCKS_TO_KEEP from the tip)\n+        //\n+        // While you might be tempted to prune the background chainstate more\n+        // aggressively (i.e. fewer MIN_BLOCKS_TO_KEEP), this won't work with index\n+        // building - specifically blockfilterindex requires undo data, and if\n+        // we don't maintain this trailing window, we hit indexation failures.\n+        prune_end = std::min(prune_height, chain_height - MIN_BLOCKS_TO_KEEP);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1308128467",
      "id" : 1308128467,
      "line" : 5918,
      "node_id" : "PRRC_kwDOABII585N-HTT",
      "original_commit_id" : "b9ac4f7925e2d9dec67be06fdc2a381532581136",
      "original_line" : 5899,
      "original_position" : 67,
      "original_start_line" : 5888,
      "path" : "src/validation.cpp",
      "position" : 381,
      "pull_request_review_id" : 1599109755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27596",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308128467/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5907,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-08-29T02:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1308128467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
