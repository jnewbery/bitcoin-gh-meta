[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28994).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Approach ACK | [murchandamus](https://github.com/bitcoin/bitcoin/pull/28994#pullrequestreview-1762920527), [achow101](https://github.com/bitcoin/bitcoin/pull/28994#pullrequestreview-1763310634) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28985](https://github.com/bitcoin/bitcoin/pull/28985) (Avoid changeless input sets when SFFO is active by murchandamus)\n* [#26812](https://github.com/bitcoin/bitcoin/pull/26812) (test: add end-to-end tests for CConnman and PeerManager by vasild)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result failure values, multiple error and warning messages by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-12-04T15:25:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#issuecomment-1838878775",
      "id" : 1838878775,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28994",
      "node_id" : "IC_kwDOABII585tmxA3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1838878775/reactions"
      },
      "updated_at" : "2023-12-04T20:13:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1838878775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414078838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414078838"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The `DISABLE` case doesnât seem to get used anywhere.",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T15:31:33Z",
      "diff_hunk" : "@@ -25,7 +25,19 @@ void DebugLogHelper::check_found()\n {\n     noui_reconnect();\n     LogInstance().DeleteCallback(m_print_connection);\n-    if (!m_found && m_match(nullptr)) {\n-        throw std::runtime_error(strprintf(\"'%s' not found in debug log\\n\", m_message));\n+\n+    switch (m_check_type) {\n+        case CheckType::MATCH:\n+            if (!m_found && m_match(nullptr)) {\n+                throw std::runtime_error(strprintf(\"'%s' not found in debug log\\n\", m_message));\n+            }\n+            break;\n+        case CheckType::NOT_MATCH:\n+            if (m_found && m_match(nullptr)) {\n+                throw std::runtime_error(strprintf(\"'%s' found in debug log\\n\", m_message));\n+            }\n+            break;\n+        case CheckType::DISABLE:\n+            break; // do nothing",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414078838",
      "id" : 1414078838,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII585USSF2",
      "original_commit_id" : "db13d8ab64173e3fc51e04a2e89931f98366df5b",
      "original_line" : 41,
      "original_position" : 30,
      "original_start_line" : 40,
      "path" : "src/test/util/logging.cpp",
      "position" : 30,
      "pull_request_review_id" : 1762736877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414078838/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 40,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-04T15:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414078838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414083527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414083527"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this used? What would this be used for? Seems easier to use a bool, no?",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T15:34:50Z",
      "diff_hunk" : "@@ -11,6 +11,12 @@\n #include <list>\n #include <string>\n \n+enum class CheckType {\n+    MATCH,          // asserts message is found\n+    NOT_MATCH,      // asserts message is not found\n+    DISABLE         // disable assertion",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414083527",
      "id" : 1414083527,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII585USTPH",
      "original_commit_id" : "db13d8ab64173e3fc51e04a2e89931f98366df5b",
      "original_line" : 17,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/test/util/logging.h",
      "position" : 7,
      "pull_request_review_id" : 1762744578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414083527/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T15:34:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414083527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414086098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414086098"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d62d49c605f89a325b929e8fb48091b0b56399ee: is there really no other way to know which coin selection algorithm is being used, than to grep output logs for non-existence? This doesn't seem like the best way to test for a condition.",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T15:36:51Z",
      "diff_hunk" : "@@ -453,6 +456,37 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n     }\n }\n \n+BOOST_AUTO_TEST_CASE(tx_creation_bnb_sffo_restriction)\n+{\n+    // Verify the transaction creation process does not produce a BnB solution when SFFO is enabled.\n+    // This is currently problematic because it could require a change output. And BnB is specialized on changeless solutions.\n+    std::unique_ptr<CWallet> wallet = NewWallet(m_node);\n+    WITH_LOCK(wallet->cs_wallet, wallet->SetLastBlockProcessed(300, uint256{})); // set a high block so internal UTXOs are selectable\n+\n+    CTxDestination change_dest = *Assert(wallet->GetNewChangeDestination(OutputType::BECH32));\n+    CTxOut change_out(0, GetScriptForDestination(change_dest));\n+    size_t change_output_size = GetSerializeSize(change_out);\n+\n+    CFeeRate effective_feerate(10000);\n+    CFeeRate discard_feerate = GetDiscardRate(*wallet);\n+\n+    CAmount change_fee = effective_feerate.GetFee(change_output_size);\n+    size_t change_spend_size = CalculateMaximumSignedInputSize(change_out, wallet.get(), nullptr);\n+    CAmount cost_of_change = discard_feerate.GetFee(change_spend_size) + change_fee;\n+\n+    // Add spendable coin at the BnB selection upper bound\n+    CoinsResult available_coins;\n+    add_coin(available_coins, *wallet, COIN + cost_of_change, /*feerate=*/CFeeRate(0), /*nAge=*/6*24, /*fIsFromMe=*/true, /*nInput=*/0, /*spendable=*/true);\n+\n+    // Now verify coin selection does not produce BnB result\n+    ASSERT_DEBUG_LOG_NOT_FOUND(\"Coin Selection: Algorithm:bnb\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414086098",
      "id" : 1414086098,
      "line" : 482,
      "node_id" : "PRRC_kwDOABII585UST3S",
      "original_commit_id" : "d62d49c605f89a325b929e8fb48091b0b56399ee",
      "original_line" : 482,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 116,
      "pull_request_review_id" : 1762748987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414086098/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T15:36:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414086098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414092139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414092139"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: I think \"deduct\" would fit better here than \"deduce\":\r\n\r\n```suggestion\r\n        CAmount fee_to_deduct = available_coins.coins[OutputType::BECH32].begin()->GetFee();\r\n        const auto result11 = SelectCoins(*wallet, available_coins, /*pre_set_inputs=*/{}, 10 * CENT - fee_to_deduct, coin_control, coin_selection_params_bnb);\r\n```",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T15:41:25Z",
      "diff_hunk" : "@@ -377,7 +381,8 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n         expected_result.Clear();\n         add_coin(10 * CENT, 2, expected_result);\n         CCoinControl coin_control;\n-        const auto result11 = SelectCoins(*wallet, available_coins, /*pre_set_inputs=*/{}, 10 * CENT, coin_control, coin_selection_params_bnb);\n+        CAmount fee_to_deduce = available_coins.coins[OutputType::BECH32].begin()->GetFee();\n+        const auto result11 = SelectCoins(*wallet, available_coins, /*pre_set_inputs=*/{}, 10 * CENT - fee_to_deduce, coin_control, coin_selection_params_bnb);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414092139",
      "id" : 1414092139,
      "line" : 385,
      "node_id" : "PRRC_kwDOABII585USVVr",
      "original_commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "original_line" : 385,
      "original_position" : 55,
      "original_start_line" : 384,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 55,
      "pull_request_review_id" : 1762736877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414092139/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 384,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-04T15:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414092139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414092780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414092780"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        fee_to_deduct = available_coins.coins[OutputType::BECH32].begin()->GetFee() * 2; // x2 because we expect two inputs\r\n        const auto result12 = SelectCoins(*wallet, available_coins, /*pre_set_inputs=*/{}, 10 * CENT - fee_to_deduct, coin_control, coin_selection_params_bnb);\r\n```",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T15:41:54Z",
      "diff_hunk" : "@@ -390,9 +395,10 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n         add_coin(available_coins, *wallet, 1 * CENT, coin_selection_params_bnb.m_effective_feerate, 6 * 24, false, 0, true);\n \n         expected_result.Clear();\n-        add_coin(9 * CENT, 2, expected_result);\n-        add_coin(1 * CENT, 2, expected_result);\n-        const auto result12 = SelectCoins(*wallet, available_coins, /*pre_set_inputs=*/{}, 10 * CENT, coin_control, coin_selection_params_bnb);\n+        add_coin(9 * CENT, /*nInput=*/0, expected_result);\n+        add_coin(1 * CENT, /*nInput=*/0, expected_result);\n+        fee_to_deduce = available_coins.coins[OutputType::BECH32].begin()->GetFee() * 2; // x2 because we expect two inputs\n+        const auto result12 = SelectCoins(*wallet, available_coins, /*pre_set_inputs=*/{}, 10 * CENT - fee_to_deduce, coin_control, coin_selection_params_bnb);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414092780",
      "id" : 1414092780,
      "line" : 401,
      "node_id" : "PRRC_kwDOABII585USVfs",
      "original_commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "original_line" : 401,
      "original_position" : 69,
      "original_start_line" : 400,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 69,
      "pull_request_review_id" : 1762736877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414092780/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 400,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-04T15:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414092780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414093219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414093219"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        fee_to_deduct = available_coins.coins[OutputType::BECH32].begin()->GetFee() * 2; // x2 because we expect two inputs\r\n```",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T15:42:16Z",
      "diff_hunk" : "@@ -407,13 +413,14 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n         expected_result.Clear();\n         add_coin(9 * CENT, 2, expected_result);\n         add_coin(1 * CENT, 2, expected_result);\n+        fee_to_deduce = available_coins.coins[OutputType::BECH32].begin()->GetFee() * 2; // x2 because we expect two inputs",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414093219",
      "id" : 1414093219,
      "line" : 416,
      "node_id" : "PRRC_kwDOABII585USVmj",
      "original_commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "original_line" : 416,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 77,
      "pull_request_review_id" : 1762736877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414093219/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T15:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414093219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414093367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414093367"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        const auto result13 = SelectCoins(*wallet, available_coins, selected_input, 10 * CENT - fee_to_deduct, coin_control, coin_selection_params_bnb);\r\n```",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T15:42:23Z",
      "diff_hunk" : "@@ -407,13 +413,14 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n         expected_result.Clear();\n         add_coin(9 * CENT, 2, expected_result);\n         add_coin(1 * CENT, 2, expected_result);\n+        fee_to_deduce = available_coins.coins[OutputType::BECH32].begin()->GetFee() * 2; // x2 because we expect two inputs\n         coin_control.m_allow_other_inputs = true;\n         COutput select_coin = available_coins.All().at(1); // pre select 9 coin\n         coin_control.Select(select_coin.outpoint);\n         PreSelectedInputs selected_input;\n         selected_input.Insert(select_coin, coin_selection_params_bnb.m_subtract_fee_outputs);\n         available_coins.Erase({(++available_coins.coins[OutputType::BECH32].begin())->outpoint});\n-        const auto result13 = SelectCoins(*wallet, available_coins, selected_input, 10 * CENT, coin_control, coin_selection_params_bnb);\n+        const auto result13 = SelectCoins(*wallet, available_coins, selected_input, 10 * CENT - fee_to_deduce, coin_control, coin_selection_params_bnb);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414093367",
      "id" : 1414093367,
      "line" : 423,
      "node_id" : "PRRC_kwDOABII585USVo3",
      "original_commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "original_line" : 423,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 85,
      "pull_request_review_id" : 1762736877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414093367/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T15:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414093367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414142645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414142645"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I actually did it in this way per achow request during coredev. My initial version involved returning the coin selection information in a separate struct https://github.com/furszy/bitcoin-core/commit/a1b2c53d1feddf748d7d91a884fe52e50998f61e in the tx creation result.\r\n\r\nI do prefer my previous approach because it would allows us to retrieve this information at the RPC level as well. However, I am also fine going with this other option as well. It's not something widely used nowadays anyway. We can also revisit this when another feature/test needs it.",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T16:13:48Z",
      "diff_hunk" : "@@ -453,6 +456,37 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n     }\n }\n \n+BOOST_AUTO_TEST_CASE(tx_creation_bnb_sffo_restriction)\n+{\n+    // Verify the transaction creation process does not produce a BnB solution when SFFO is enabled.\n+    // This is currently problematic because it could require a change output. And BnB is specialized on changeless solutions.\n+    std::unique_ptr<CWallet> wallet = NewWallet(m_node);\n+    WITH_LOCK(wallet->cs_wallet, wallet->SetLastBlockProcessed(300, uint256{})); // set a high block so internal UTXOs are selectable\n+\n+    CTxDestination change_dest = *Assert(wallet->GetNewChangeDestination(OutputType::BECH32));\n+    CTxOut change_out(0, GetScriptForDestination(change_dest));\n+    size_t change_output_size = GetSerializeSize(change_out);\n+\n+    CFeeRate effective_feerate(10000);\n+    CFeeRate discard_feerate = GetDiscardRate(*wallet);\n+\n+    CAmount change_fee = effective_feerate.GetFee(change_output_size);\n+    size_t change_spend_size = CalculateMaximumSignedInputSize(change_out, wallet.get(), nullptr);\n+    CAmount cost_of_change = discard_feerate.GetFee(change_spend_size) + change_fee;\n+\n+    // Add spendable coin at the BnB selection upper bound\n+    CoinsResult available_coins;\n+    add_coin(available_coins, *wallet, COIN + cost_of_change, /*feerate=*/CFeeRate(0), /*nAge=*/6*24, /*fIsFromMe=*/true, /*nInput=*/0, /*spendable=*/true);\n+\n+    // Now verify coin selection does not produce BnB result\n+    ASSERT_DEBUG_LOG_NOT_FOUND(\"Coin Selection: Algorithm:bnb\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414142645",
      "id" : 1414142645,
      "in_reply_to_id" : 1414086098,
      "line" : 482,
      "node_id" : "PRRC_kwDOABII585UShq1",
      "original_commit_id" : "d62d49c605f89a325b929e8fb48091b0b56399ee",
      "original_line" : 482,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 116,
      "pull_request_review_id" : 1762840031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414142645/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T16:13:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414142645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414154588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414154588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> My initial version involved returning the coin selection information in a separate struct https://github.com/furszy/bitcoin-core/commit/a1b2c53d1feddf748d7d91a884fe52e50998f61e in the tx creation result.\r\n\r\nYour initial version seems better to me. Looks like about the same amount of code or less for the better outcome. Checking for log messages in tests is a bit brittle and usually results in more churn down the line when log messages change.",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T16:21:52Z",
      "diff_hunk" : "@@ -453,6 +456,37 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n     }\n }\n \n+BOOST_AUTO_TEST_CASE(tx_creation_bnb_sffo_restriction)\n+{\n+    // Verify the transaction creation process does not produce a BnB solution when SFFO is enabled.\n+    // This is currently problematic because it could require a change output. And BnB is specialized on changeless solutions.\n+    std::unique_ptr<CWallet> wallet = NewWallet(m_node);\n+    WITH_LOCK(wallet->cs_wallet, wallet->SetLastBlockProcessed(300, uint256{})); // set a high block so internal UTXOs are selectable\n+\n+    CTxDestination change_dest = *Assert(wallet->GetNewChangeDestination(OutputType::BECH32));\n+    CTxOut change_out(0, GetScriptForDestination(change_dest));\n+    size_t change_output_size = GetSerializeSize(change_out);\n+\n+    CFeeRate effective_feerate(10000);\n+    CFeeRate discard_feerate = GetDiscardRate(*wallet);\n+\n+    CAmount change_fee = effective_feerate.GetFee(change_output_size);\n+    size_t change_spend_size = CalculateMaximumSignedInputSize(change_out, wallet.get(), nullptr);\n+    CAmount cost_of_change = discard_feerate.GetFee(change_spend_size) + change_fee;\n+\n+    // Add spendable coin at the BnB selection upper bound\n+    CoinsResult available_coins;\n+    add_coin(available_coins, *wallet, COIN + cost_of_change, /*feerate=*/CFeeRate(0), /*nAge=*/6*24, /*fIsFromMe=*/true, /*nInput=*/0, /*spendable=*/true);\n+\n+    // Now verify coin selection does not produce BnB result\n+    ASSERT_DEBUG_LOG_NOT_FOUND(\"Coin Selection: Algorithm:bnb\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414154588",
      "id" : 1414154588,
      "in_reply_to_id" : 1414086098,
      "line" : 482,
      "node_id" : "PRRC_kwDOABII585USklc",
      "original_commit_id" : "d62d49c605f89a325b929e8fb48091b0b56399ee",
      "original_line" : 482,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 116,
      "pull_request_review_id" : 1762859005,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414154588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T16:21:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414154588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414156191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414156191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, it is not used. IIRC, I did it in this way to get a mechanism to enable/disable the logs watcher on the fly, without requiring to create a new one per watched message.\r\nCan migrate it to use a bool too. Was just considering potential future utilities.",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T16:23:12Z",
      "diff_hunk" : "@@ -11,6 +11,12 @@\n #include <list>\n #include <string>\n \n+enum class CheckType {\n+    MATCH,          // asserts message is found\n+    NOT_MATCH,      // asserts message is not found\n+    DISABLE         // disable assertion",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414156191",
      "id" : 1414156191,
      "in_reply_to_id" : 1414083527,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII585USk-f",
      "original_commit_id" : "db13d8ab64173e3fc51e04a2e89931f98366df5b",
      "original_line" : 17,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/test/util/logging.h",
      "position" : 7,
      "pull_request_review_id" : 1762861694,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414156191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T16:23:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414156191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414161933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414161933"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit from tidy CI:\r\n\r\n\r\n```\r\ntainer_base/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/wallet/spend.cpp\r\nwallet/spend.cpp:1266:28: error: Unterminated format string used with LogPrintf [bitcoin-unterminated-logprintf,-warnings-as-errors]\r\n 1266 |     wallet.WalletLogPrintf(\"Coin Selection: Algorithm:%s, Waste:%d\", GetAlgorithmName(result.GetAlgo()), result.GetWaste());\r\n      |                            ^                                      \r\n      |                                                                   \\n\r\n",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T16:27:21Z",
      "diff_hunk" : "@@ -1260,6 +1263,7 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n     // accidental reuse.\n     reservedest.KeepDestination();\n \n+    wallet.WalletLogPrintf(\"Coin Selection: Algorithm:%s, Waste:%d\", GetAlgorithmName(result.GetAlgo()), result.GetWaste());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414161933",
      "id" : 1414161933,
      "line" : 1266,
      "node_id" : "PRRC_kwDOABII585USmYN",
      "original_commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "original_line" : 1266,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 20,
      "pull_request_review_id" : 1762872018,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414161933/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T16:27:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414161933",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/maflcko/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maflcko/followers",
         "following_url" : "https://api.github.com/users/maflcko/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maflcko/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maflcko",
         "id" : 6399679,
         "login" : "maflcko",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/maflcko/orgs",
         "received_events_url" : "https://api.github.com/users/maflcko/received_events",
         "repos_url" : "https://api.github.com/users/maflcko/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maflcko/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maflcko/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maflcko"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414190927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414190927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: This test was already a bit weird to me, because it is categorized as belonging to \"BnB\", but the composition of preset inputs and the selection of additional inputs is a `SelectCoins`-level functionality that has little to do with specific coin selection algorithms. Composability should be tested at `SelectCoins` level (which it is in `spend_tests` and `wallet_fundrawtransaction.py`, although it could probably be more extensive). Since we already tested whether we can select two UTXOs that exactly match an amount in absence of fees above, I expect that we could remove this test altogether without losing coverage.",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T16:45:51Z",
      "diff_hunk" : "@@ -345,6 +348,7 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n \n         CoinsResult available_coins;\n \n+        coin_selection_params_bnb.m_effective_feerate = CFeeRate(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414190927",
      "id" : 1414190927,
      "line" : 351,
      "node_id" : "PRRC_kwDOABII585UStdP",
      "original_commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "original_line" : 351,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 36,
      "pull_request_review_id" : 1762920527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414190927/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T16:46:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414190927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/murchandamus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/murchandamus/followers",
         "following_url" : "https://api.github.com/users/murchandamus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/murchandamus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/murchandamus",
         "id" : 4060799,
         "login" : "murchandamus",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/murchandamus/orgs",
         "received_events_url" : "https://api.github.com/users/murchandamus/received_events",
         "repos_url" : "https://api.github.com/users/murchandamus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/murchandamus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/murchandamus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/murchandamus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414228551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414228551"
         }
      },
      "author_association" : "MEMBER",
      "body" : "For unit tests, having the information in a struct is fine. However I'm not sure that it is really useful information to return in the RPC. IIRC my suggestion for searching the debug log is for functional tests since those already have an `assert_debug_log` helper.",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T17:15:40Z",
      "diff_hunk" : "@@ -453,6 +456,37 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n     }\n }\n \n+BOOST_AUTO_TEST_CASE(tx_creation_bnb_sffo_restriction)\n+{\n+    // Verify the transaction creation process does not produce a BnB solution when SFFO is enabled.\n+    // This is currently problematic because it could require a change output. And BnB is specialized on changeless solutions.\n+    std::unique_ptr<CWallet> wallet = NewWallet(m_node);\n+    WITH_LOCK(wallet->cs_wallet, wallet->SetLastBlockProcessed(300, uint256{})); // set a high block so internal UTXOs are selectable\n+\n+    CTxDestination change_dest = *Assert(wallet->GetNewChangeDestination(OutputType::BECH32));\n+    CTxOut change_out(0, GetScriptForDestination(change_dest));\n+    size_t change_output_size = GetSerializeSize(change_out);\n+\n+    CFeeRate effective_feerate(10000);\n+    CFeeRate discard_feerate = GetDiscardRate(*wallet);\n+\n+    CAmount change_fee = effective_feerate.GetFee(change_output_size);\n+    size_t change_spend_size = CalculateMaximumSignedInputSize(change_out, wallet.get(), nullptr);\n+    CAmount cost_of_change = discard_feerate.GetFee(change_spend_size) + change_fee;\n+\n+    // Add spendable coin at the BnB selection upper bound\n+    CoinsResult available_coins;\n+    add_coin(available_coins, *wallet, COIN + cost_of_change, /*feerate=*/CFeeRate(0), /*nAge=*/6*24, /*fIsFromMe=*/true, /*nInput=*/0, /*spendable=*/true);\n+\n+    // Now verify coin selection does not produce BnB result\n+    ASSERT_DEBUG_LOG_NOT_FOUND(\"Coin Selection: Algorithm:bnb\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414228551",
      "id" : 1414228551,
      "in_reply_to_id" : 1414086098,
      "line" : 482,
      "node_id" : "PRRC_kwDOABII585US2pH",
      "original_commit_id" : "d62d49c605f89a325b929e8fb48091b0b56399ee",
      "original_line" : 482,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 116,
      "pull_request_review_id" : 1762980951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414228551/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T17:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414228551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414434210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414434210"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d62d49c605f89a325b929e8fb48091b0b56399ee \"test: add coverage for BnB-SFFO restriction\"\r\n\r\nIt seems like using `CreateTransaction` is a bit too high level for the goal of this test. Really this test is targeting the function that runs the various coin selection algorithms and chooses the result to return. This would be `ChooseSelectionResult`. Although this function is not exposed, its callers are, so this test could use either `SelectCoins` or `AutomaticCoinSelection` to test the same behavior. This would also remove the need to have the debug.log helper or even changing `CreatedTransactionResult` to contain the coin selection algorithm used since both of those functions return a `SelectionResult` which will contain the algo.\r\n\r\n```suggestion\r\n    FastRandomContext rand{};\r\n    CoinSelectionParams params{\r\n        rand,\r\n        /*change_output_size=*/ 31,\r\n        /*change_spend_size=*/ 68,\r\n        /*min_change_target=*/ 0,\r\n        /*effective_feerate=*/ CFeeRate(3000),\r\n        /*long_term_feerate=*/ CFeeRate(1000),\r\n        /*discard_feerate=*/ CFeeRate(1000),\r\n        /*tx_noinputs_size=*/ 0,\r\n        /*avoid_partial=*/ false,\r\n    };\r\n    params.m_subtract_fee_outputs = true;\r\n    params.m_change_fee = params.m_effective_feerate.GetFee(params.change_output_size);\r\n    params.m_cost_of_change = params.m_discard_feerate.GetFee(params.change_spend_size) + params.m_change_fee;\r\n\r\n    // Add spendable coin at the BnB selection upper bound\r\n    CoinsResult available_coins;\r\n    add_coin(available_coins, *wallet, COIN + params.m_cost_of_change, /*feerate=*/CFeeRate(0), /*nAge=*/6*24, /*fIsFromMe=*/true, /*nInput=*/0, /*spendable=*/true);\r\n\r\n    // Now verify coin selection does not produce BnB result\r\n    auto result = SelectCoins(*wallet, available_coins, {}, COIN, {}, params);\r\n    BOOST_CHECK(result.has_value());\r\n    BOOST_CHECK(result->GetAlgo() != SelectionAlgorithm::BNB);\r\n```",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T20:10:58Z",
      "diff_hunk" : "@@ -453,6 +456,37 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n     }\n }\n \n+BOOST_AUTO_TEST_CASE(tx_creation_bnb_sffo_restriction)\n+{\n+    // Verify the transaction creation process does not produce a BnB solution when SFFO is enabled.\n+    // This is currently problematic because it could require a change output. And BnB is specialized on changeless solutions.\n+    std::unique_ptr<CWallet> wallet = NewWallet(m_node);\n+    WITH_LOCK(wallet->cs_wallet, wallet->SetLastBlockProcessed(300, uint256{})); // set a high block so internal UTXOs are selectable\n+\n+    CTxDestination change_dest = *Assert(wallet->GetNewChangeDestination(OutputType::BECH32));\n+    CTxOut change_out(0, GetScriptForDestination(change_dest));\n+    size_t change_output_size = GetSerializeSize(change_out);\n+\n+    CFeeRate effective_feerate(10000);\n+    CFeeRate discard_feerate = GetDiscardRate(*wallet);\n+\n+    CAmount change_fee = effective_feerate.GetFee(change_output_size);\n+    size_t change_spend_size = CalculateMaximumSignedInputSize(change_out, wallet.get(), nullptr);\n+    CAmount cost_of_change = discard_feerate.GetFee(change_spend_size) + change_fee;\n+\n+    // Add spendable coin at the BnB selection upper bound\n+    CoinsResult available_coins;\n+    add_coin(available_coins, *wallet, COIN + cost_of_change, /*feerate=*/CFeeRate(0), /*nAge=*/6*24, /*fIsFromMe=*/true, /*nInput=*/0, /*spendable=*/true);\n+\n+    // Now verify coin selection does not produce BnB result\n+    ASSERT_DEBUG_LOG_NOT_FOUND(\"Coin Selection: Algorithm:bnb\");\n+    CCoinControl coin_control;\n+    coin_control.m_feerate = effective_feerate;\n+    coin_control.destChange = change_dest;\n+    CRecipient recipient{PubKeyDestination({}), /*target=*/COIN, /*subtract_fee=*/true};\n+    BOOST_CHECK(CreateTransaction(*wallet, {recipient}, /*change_pos=*/-1, coin_control));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414434210",
      "id" : 1414434210,
      "line" : 487,
      "node_id" : "PRRC_kwDOABII585UTo2i",
      "original_commit_id" : "d62d49c605f89a325b929e8fb48091b0b56399ee",
      "original_line" : 487,
      "original_position" : 55,
      "original_start_line" : 466,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 121,
      "pull_request_review_id" : 1763310634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414434210/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 466,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-12-04T20:13:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414434210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414460418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414460418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "For end users, it may not be particularly useful. However, I think that additional information at the RPC level could be beneficial for other utilities, like a coin selection metrics tool or for connected applications that uses core as their backend.\r\nThat said, there's no need to add it unless there's a need for it.\r\n\r\nOther than that, will return to the struct commit then.",
      "commit_id" : "233a07ade88d13154771417cf7700736ffce5211",
      "created_at" : "2023-12-04T20:35:48Z",
      "diff_hunk" : "@@ -453,6 +456,37 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n     }\n }\n \n+BOOST_AUTO_TEST_CASE(tx_creation_bnb_sffo_restriction)\n+{\n+    // Verify the transaction creation process does not produce a BnB solution when SFFO is enabled.\n+    // This is currently problematic because it could require a change output. And BnB is specialized on changeless solutions.\n+    std::unique_ptr<CWallet> wallet = NewWallet(m_node);\n+    WITH_LOCK(wallet->cs_wallet, wallet->SetLastBlockProcessed(300, uint256{})); // set a high block so internal UTXOs are selectable\n+\n+    CTxDestination change_dest = *Assert(wallet->GetNewChangeDestination(OutputType::BECH32));\n+    CTxOut change_out(0, GetScriptForDestination(change_dest));\n+    size_t change_output_size = GetSerializeSize(change_out);\n+\n+    CFeeRate effective_feerate(10000);\n+    CFeeRate discard_feerate = GetDiscardRate(*wallet);\n+\n+    CAmount change_fee = effective_feerate.GetFee(change_output_size);\n+    size_t change_spend_size = CalculateMaximumSignedInputSize(change_out, wallet.get(), nullptr);\n+    CAmount cost_of_change = discard_feerate.GetFee(change_spend_size) + change_fee;\n+\n+    // Add spendable coin at the BnB selection upper bound\n+    CoinsResult available_coins;\n+    add_coin(available_coins, *wallet, COIN + cost_of_change, /*feerate=*/CFeeRate(0), /*nAge=*/6*24, /*fIsFromMe=*/true, /*nInput=*/0, /*spendable=*/true);\n+\n+    // Now verify coin selection does not produce BnB result\n+    ASSERT_DEBUG_LOG_NOT_FOUND(\"Coin Selection: Algorithm:bnb\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414460418",
      "id" : 1414460418,
      "in_reply_to_id" : 1414086098,
      "line" : 482,
      "node_id" : "PRRC_kwDOABII585UTvQC",
      "original_commit_id" : "d62d49c605f89a325b929e8fb48091b0b56399ee",
      "original_line" : 482,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 116,
      "pull_request_review_id" : 1763355144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28994",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414460418/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T20:35:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1414460418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated per feedback. Thanks everyone.\r\n\r\nTest wise; replaced the logs debugger approach for a low level function call (per https://github.com/bitcoin/bitcoin/pull/28994#discussion_r1414434210). And applied\r\nthe test variables naming suggestions.",
      "created_at" : "2023-12-04T21:30:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28994#issuecomment-1839509876",
      "id" : 1839509876,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28994",
      "node_id" : "IC_kwDOABII585tpLF0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1839509876/reactions"
      },
      "updated_at" : "2023-12-04T21:30:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1839509876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
