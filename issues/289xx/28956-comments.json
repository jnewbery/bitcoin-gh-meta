[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/28956).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [ajtowns](https://github.com/bitcoin/bitcoin/pull/28956#pullrequestreview-1755018341), [RandyMcMillan](https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832151113), [fanquake](https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832376788), [Pttn](https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832799066) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28765](https://github.com/bitcoin/bitcoin/pull/28765) (p2p: Fill reconciliation sets (Erlay) by naumenkogs)\n* [#28690](https://github.com/bitcoin/bitcoin/pull/28690) (build: Introduce internal kernel library by TheCharlatan)\n* [#28170](https://github.com/bitcoin/bitcoin/pull/28170) (p2p: adaptive connections services flags by furszy)\n* [#28051](https://github.com/bitcoin/bitcoin/pull/28051) (Get rid of shutdown.cpp/shutdown.h, use SignalInterrupt directly by ryanofsky)\n* [#27052](https://github.com/bitcoin/bitcoin/pull/27052) (test: rpc: add last block announcement time to getpeerinfo result by LarryRuane)\n* [#26966](https://github.com/bitcoin/bitcoin/pull/26966) (index: blockfilter initial sync speedup, parallelize process by furszy)\n* [#15218](https://github.com/bitcoin/bitcoin/pull/15218) (validation: Flush state after initial sync by andrewtoth)\n* [#10102](https://github.com/bitcoin/bitcoin/pull/10102) (Multiprocess bitcoin by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-11-28T13:27:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1829843027",
      "id" : 1829843027,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585tETBT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1829843027/reactions"
      },
      "updated_at" : "2023-11-29T22:26:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1829843027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns  @darosior @fanquake @maflcko @naumenkogs You all were interested in the previous PR. Would appreciate your review.",
      "created_at" : "2023-11-29T10:58:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1831671138",
      "id" : 1831671138,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585tLRVi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1831671138/reactions"
      },
      "updated_at" : "2023-11-29T10:58:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1831671138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409131058"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409131058"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you're building a function that collects this info, maybe call it `GetInfo()` and combine it with `IgnoresIncomingTxs()` ?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:13:45Z",
      "diff_hunk" : "@@ -84,6 +88,9 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n     /** Get statistics from node state */\n     virtual bool GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats) const = 0;\n \n+    /** Get stats from peer manager. */\n+    virtual PeerManagerStats GetStats() const = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409131058",
      "id" : 1409131058,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T_aIy",
      "original_commit_id" : "cab1cf9c134b15e829ddcea676cc1b5a039ace08",
      "original_line" : 92,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409131058/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409131058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409132248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409132248"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should be conditional on `node.peerman` being valid, see the previous line.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:14:45Z",
      "diff_hunk" : "@@ -674,7 +673,7 @@ static RPCHelpMan getnetworkinfo()\n     if (node.peerman) {\n         obj.pushKV(\"localrelay\", !node.peerman->IgnoresIncomingTxs());\n     }\n-    obj.pushKV(\"timeoffset\",    GetTimeOffset());\n+    obj.pushKV(\"timeoffset\", node.peerman->GetStats().median_outbound_time_offset);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409132248",
      "id" : 1409132248,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T_abY",
      "original_commit_id" : "aec6b138ced9347c36b2e6e00411c6ee0f9aa8df",
      "original_line" : 676,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409132248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409132248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409140558"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409140558"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Having a rolling set of 10 time offsets from every outbound connection we make (full outbounds, block-relay-only, extra block-relay-only, feelers?) seems somewhat risky: at present, you'll get odd behaviour if a high-proportion of the first 100 outbound peers you connect to have a different time; with this change, you'll get a warning if the last 10 peers you randomly connect to have a dodgy view of the time?\r\n\r\nMaybe consider making this conditional on `IsManualOrFullOutboundConn()` instead; that way it only updates rarely for things we're really trying to connect to, and isn't mostly made up of random peers we're briefly sampling?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:22:50Z",
      "diff_hunk" : "@@ -3567,6 +3601,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // Don't use timedata samples from inbound peers to make it\n             // harder for others to tamper with our adjusted time.\n             AddTimeData(pfrom.addr, peer->m_time_offset);\n+\n+            m_outbound_time_offsets.Add(peer->m_time_offset);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409140558",
      "id" : 1409140558,
      "line" : 3612,
      "node_id" : "PRRC_kwDOABII585T_cdO",
      "original_commit_id" : "71d61076657557f7d7041624e0d959807fa6d786",
      "original_line" : 3612,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 135,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409140558/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409140558",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409146055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409146055"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`SetMiscWarning` seems a poor interface; if there's two warnings, the latest one overrides the first, and you can't remove warnings in the event that they resolve themselves. Might be better to do something like `SetfLargeWorkInvalidChainFound(bool)` ?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:27:50Z",
      "diff_hunk" : "@@ -3611,6 +3613,12 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             AddTimeData(pfrom.addr, peer->m_time_offset);\n \n             m_outbound_time_offsets.Add(peer->m_time_offset);\n+\n+            auto median = m_outbound_time_offsets.Median();\n+            if (median > TIME_OFFSET_WARN_THRESHOLD.count() ||\n+                median < -TIME_OFFSET_WARN_THRESHOLD.count()) {\n+                SetMiscWarning(Untranslated(\"Please check that your computer's date and time are correct\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409146055",
      "id" : 1409146055,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T_dzH",
      "original_commit_id" : "786c562b074324cc81e81a008d2a7e36f9deca7d",
      "original_line" : 3620,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409146055/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409146055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409150007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409150007"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is reduced from 70min to 30min, compared to `DEFAULT_MAX_TIME_ADJUSTMENT`. 70min avoids warning if you're buggy by an hour due to (you or your peers) getting daylight savings time wrong, which seems like a vaguely plausible thing to continue doing?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:31:46Z",
      "diff_hunk" : "@@ -175,6 +176,7 @@ static constexpr double MAX_ADDR_RATE_PER_SECOND{0.1};\n static constexpr size_t MAX_ADDR_PROCESSING_TOKEN_BUCKET{MAX_ADDR_TO_SEND};\n /** The compactblocks version we support. See BIP 152. */\n static constexpr uint64_t CMPCTBLOCKS_VERSION{2};\n+static constexpr std::chrono::seconds TIME_OFFSET_WARN_THRESHOLD{30min};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409150007",
      "id" : 1409150007,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T_ew3",
      "original_commit_id" : "786c562b074324cc81e81a008d2a7e36f9deca7d",
      "original_line" : 179,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409150007/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409150007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409151223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409151223"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps swap this option for one that controls how much of a time difference results in a warning? Not sure.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T11:32:59Z",
      "diff_hunk" : "@@ -497,7 +496,6 @@ void SetupServerArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-maxconnections=<n>\", strprintf(\"Maintain at most <n> automatic connections to peers (default: %u). This limit does not apply to connections manually added via -addnode or the addnode RPC, which have a separate limit of %u.\", DEFAULT_MAX_PEER_CONNECTIONS, MAX_ADDNODE_CONNECTIONS), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-maxreceivebuffer=<n>\", strprintf(\"Maximum per-connection receive buffer, <n>*1000 bytes (default: %u)\", DEFAULT_MAXRECEIVEBUFFER), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-maxsendbuffer=<n>\", strprintf(\"Maximum per-connection memory usage for the send buffer, <n>*1000 bytes (default: %u)\", DEFAULT_MAXSENDBUFFER), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n-    argsman.AddArg(\"-maxtimeadjustment\", strprintf(\"Maximum allowed median peer time offset adjustment. Local perspective of time may be influenced by outbound peers forward or backward by this amount (default: %u seconds).\", DEFAULT_MAX_TIME_ADJUSTMENT), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409151223",
      "id" : 1409151223,
      "line" : 500,
      "node_id" : "PRRC_kwDOABII585T_fD3",
      "original_commit_id" : "aec6b138ced9347c36b2e6e00411c6ee0f9aa8df",
      "original_line" : 500,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 12,
      "pull_request_review_id" : 1755018341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409151223/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409151223",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409284495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409284495"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea, done!",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T13:29:54Z",
      "diff_hunk" : "@@ -84,6 +88,9 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n     /** Get statistics from node state */\n     virtual bool GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats) const = 0;\n \n+    /** Get stats from peer manager. */\n+    virtual PeerManagerStats GetStats() const = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409284495",
      "id" : 1409284495,
      "in_reply_to_id" : 1409131058,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585T__mP",
      "original_commit_id" : "cab1cf9c134b15e829ddcea676cc1b5a039ace08",
      "original_line" : 92,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 1755270180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409284495/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T13:29:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409284495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409285449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409285449"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Maybe consider making this conditional on IsManualOrFullOutboundConn()\r\n\r\nDone",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T13:30:42Z",
      "diff_hunk" : "@@ -3567,6 +3601,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // Don't use timedata samples from inbound peers to make it\n             // harder for others to tamper with our adjusted time.\n             AddTimeData(pfrom.addr, peer->m_time_offset);\n+\n+            m_outbound_time_offsets.Add(peer->m_time_offset);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409285449",
      "id" : 1409285449,
      "in_reply_to_id" : 1409140558,
      "line" : 3612,
      "node_id" : "PRRC_kwDOABII585T__1J",
      "original_commit_id" : "71d61076657557f7d7041624e0d959807fa6d786",
      "original_line" : 3612,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 135,
      "pull_request_review_id" : 1755271738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409285449/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T13:30:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409285449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409290332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409290332"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No strong opinion on this, but it doesn't seem very useful to me to be able to set that threshold. Happy to add this if someone can name a good reason.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-29T13:34:19Z",
      "diff_hunk" : "@@ -497,7 +496,6 @@ void SetupServerArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-maxconnections=<n>\", strprintf(\"Maintain at most <n> automatic connections to peers (default: %u). This limit does not apply to connections manually added via -addnode or the addnode RPC, which have a separate limit of %u.\", DEFAULT_MAX_PEER_CONNECTIONS, MAX_ADDNODE_CONNECTIONS), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-maxreceivebuffer=<n>\", strprintf(\"Maximum per-connection receive buffer, <n>*1000 bytes (default: %u)\", DEFAULT_MAXRECEIVEBUFFER), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-maxsendbuffer=<n>\", strprintf(\"Maximum per-connection memory usage for the send buffer, <n>*1000 bytes (default: %u)\", DEFAULT_MAXSENDBUFFER), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n-    argsman.AddArg(\"-maxtimeadjustment\", strprintf(\"Maximum allowed median peer time offset adjustment. Local perspective of time may be influenced by outbound peers forward or backward by this amount (default: %u seconds).\", DEFAULT_MAX_TIME_ADJUSTMENT), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1409290332",
      "id" : 1409290332,
      "in_reply_to_id" : 1409151223,
      "line" : 500,
      "node_id" : "PRRC_kwDOABII585UABBc",
      "original_commit_id" : "aec6b138ced9347c36b2e6e00411c6ee0f9aa8df",
      "original_line" : 500,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 12,
      "pull_request_review_id" : 1755281286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409290332/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-29T13:34:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1409290332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-11-29T15:36:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832151113",
      "id" : 1832151113,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585tNGhJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832151113/reactions"
      },
      "updated_at" : "2023-11-29T15:36:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832151113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/152159?v=4",
         "events_url" : "https://api.github.com/users/RandyMcMillan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/RandyMcMillan/followers",
         "following_url" : "https://api.github.com/users/RandyMcMillan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/RandyMcMillan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/RandyMcMillan",
         "id" : 152159,
         "login" : "RandyMcMillan",
         "node_id" : "MDQ6VXNlcjE1MjE1OQ==",
         "organizations_url" : "https://api.github.com/users/RandyMcMillan/orgs",
         "received_events_url" : "https://api.github.com/users/RandyMcMillan/received_events",
         "repos_url" : "https://api.github.com/users/RandyMcMillan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/RandyMcMillan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/RandyMcMillan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/RandyMcMillan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2023-11-29T17:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832376788",
      "id" : 1832376788,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585tN9nU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832376788/reactions"
      },
      "updated_at" : "2023-11-29T17:21:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832376788",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-11-29T22:26:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#issuecomment-1832799066",
      "id" : 1832799066,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28956",
      "node_id" : "IC_kwDOABII585tPkta",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832799066/reactions"
      },
      "updated_at" : "2023-11-29T22:26:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1832799066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/28868425?v=4",
         "events_url" : "https://api.github.com/users/Pttn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Pttn/followers",
         "following_url" : "https://api.github.com/users/Pttn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Pttn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Pttn",
         "id" : 28868425,
         "login" : "Pttn",
         "node_id" : "MDQ6VXNlcjI4ODY4NDI1",
         "organizations_url" : "https://api.github.com/users/Pttn/orgs",
         "received_events_url" : "https://api.github.com/users/Pttn/received_events",
         "repos_url" : "https://api.github.com/users/Pttn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Pttn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Pttn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Pttn"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1411184510"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411184510"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't this use `min(N, m_index)` instead of `N`?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-11-30T19:44:45Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1411184510",
      "id" : 1411184510,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585UHPd-",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 1758318406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411184510/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-11-30T19:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411184510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1411821098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411821098"
         }
      },
      "author_association" : "MEMBER",
      "body" : "122658f95b36b7f940351bd34a89e13831931f18\r\n\r\nshould we make this addition overflow safe?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-12-01T09:17:58Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1411821098",
      "id" : 1411821098,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585UJq4q",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 1759350317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411821098/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-01T09:17:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1411821098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413301629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413301629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think one advance in term of robustness of this local time monitoring mechanism could be to add feeler âs time offset (`ConnectionType::FEELER`) to reserved slots in the index (e.g +3 on the 10 full-outbound connections). Those peers connections are already triggered at regular interval, which is not necessarily the case of outbound peer topology if the peers are stable and performant.\r\n\r\nI guess a NTP-attacker could silently time shift the local clock of a victim, without this warning logic ever triggering if no new outbound or manual connections are ever opened during the exploitation.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-12-04T02:23:07Z",
      "diff_hunk" : "@@ -3557,12 +3605,17 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                   peer->m_starting_height, addrMe.ToStringAddrPort(), fRelay, pfrom.GetId(),\n                   remoteAddr, (mapped_as ? strprintf(\", mapped_as=%d\", mapped_as) : \"\"));\n \n-        int64_t nTimeOffset = nTime - GetTime();\n-        pfrom.nTimeOffset = nTimeOffset;\n-        if (!pfrom.IsInboundConn()) {\n-            // Don't use timedata samples from inbound peers to make it\n-            // harder for others to tamper with our adjusted time.\n-            AddTimeData(pfrom.addr, nTimeOffset);\n+        peer->m_time_offset = nTime - GetTime();\n+\n+        if (pfrom.IsManualOrFullOutboundConn()) {\n+            // Only sample from outbound connections we are really trying to connect to.\n+            m_outbound_time_offsets.Add(peer->m_time_offset);\n+\n+            auto median = m_outbound_time_offsets.Median();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413301629",
      "id" : 1413301629,
      "line" : 3614,
      "node_id" : "PRRC_kwDOABII585UPUV9",
      "original_commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "original_line" : 3614,
      "original_position" : 137,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 137,
      "pull_request_review_id" : 1761497233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413301629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T02:27:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413301629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413770472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413770472"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The idea is that `m_index` is always set to the next index in `m_offsets` that gets written to (so a value out of `[0, N)`) and we just assume that the initial N samples were 0, which is why the median is immediately computed out of N.\r\n\r\nI could change it to always increase `m_index` instead and add new offsets by doing `m_offsets[m_index % N] = new_offset`, in which case your suggestion would allow us to compute the median more \"accurately\" while we haven't seen N samples yet. I'm not sure though if that is an improvement,. e.g. do we want to issue a warning if only the first outbound connection has a offset larger than our threshold?",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-12-04T11:56:44Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413770472",
      "id" : 1413770472,
      "in_reply_to_id" : 1411184510,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585URGzo",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 1762231767,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413770472/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T11:56:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413770472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413773031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413773031"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hm yea I guess... I could also just remove support for odd `N`s from this class.",
      "commit_id" : "d283c10c296163cf5492707030d7579ec38c7413",
      "created_at" : "2023-12-04T11:58:49Z",
      "diff_hunk" : "@@ -186,6 +186,38 @@ struct QueuedBlock {\n     std::unique_ptr<PartiallyDownloadedBlock> partialBlock;\n };\n \n+template <size_t N>\n+class TimeOffsets\n+{\n+private:\n+    static_assert(N > 0, \"TimeOffsets has to sample at least one element\");\n+\n+    mutable Mutex m_mutex;\n+    std::array<int64_t, N> m_offsets GUARDED_BY(m_mutex){};\n+    size_t m_index GUARDED_BY(m_mutex){0};\n+\n+public:\n+    void Add(int64_t offset) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        LOCK(m_mutex);\n+        m_offsets[m_index] = offset;\n+        m_index = (1 + m_index) % N;\n+    }\n+    int64_t Median() const EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        AssertLockNotHeld(m_mutex);\n+        std::array<int64_t, N> sorted_copy = WITH_LOCK(m_mutex, return m_offsets);\n+        std::sort(sorted_copy.begin(), sorted_copy.end());\n+\n+        if constexpr (N % 2 == 0) {\n+            return (sorted_copy[N / 2 - 1] + sorted_copy[N / 2]) / 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28956#discussion_r1413773031",
      "id" : 1413773031,
      "in_reply_to_id" : 1411821098,
      "line" : 215,
      "node_id" : "PRRC_kwDOABII585URHbn",
      "original_commit_id" : "122658f95b36b7f940351bd34a89e13831931f18",
      "original_line" : 214,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 1762238037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28956",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413773031/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-12-04T11:58:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1413773031",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   }
]
