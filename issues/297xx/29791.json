{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "Timeout issues where encountered when running functional tests with `--jobs=16 --extended`.\r\n\r\nNote that running `--extended` without `--jobs=16` does not trigger the issues.\r\n\r\nTested under NixOS on a Xeon CPU with 16 logical cores.\r\n\r\n(A few tests are skipped locally as I haven't enabled BPF and a few other things).\r\n\r\n## Measurements\r\n\r\nLine in `feature_index_prune.py` took 101.6s, 96.6s, 103.0s across 3 runs on my machine.\r\nDefault limit is 60, suggested to increase limit to 150 seconds.\r\n\r\nLine in the `wallet_importdescriptors.py --descriptors` took 5.4s, 5.7s, 6.0s across 3 runs.\r\nSuggested to increase from 5 to 10 seconds.\r\n\r\n\r\n## Logs\r\n\r\nOutput slightly modified by separate change that lets code run past given timeouts and the provides more information - \"Took 101.6 seconds to complete, 69.4% over the given limit.\".\r\n\r\n\r\n<details>\r\n<summary>\r\nClick to expand.\r\n</summary>\r\n\r\n\r\n```\r\n52/305 - feature_index_prune.py failed, Duration: 250 s\r\n\r\nstdout:\r\n2024-04-01T22:25:24.010000Z TestFramework (INFO): PRNG seed is: 990421162716295219\r\n2024-04-01T22:25:24.014000Z TestFramework (INFO): Initializing test directory /mnt/tmp/test_runner_â¿_ð_20240402_002516/feature_index_prune_302\r\n2024-04-01T22:25:24.913000Z TestFramework (INFO): check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\r\n2024-04-01T22:26:48.417000Z TestFramework (INFO): prune some blocks\r\n2024-04-01T22:26:48.460000Z TestFramework (INFO): check if we can access the tips blockfilter and coinstats when we have pruned some blocks\r\n2024-04-01T22:26:48.483000Z TestFramework (INFO): check if we can access the blockfilter and coinstats of a pruned block\r\n2024-04-01T22:26:59.175000Z TestFramework (INFO): make sure trying to access the indices throws errors\r\n2024-04-01T22:27:50.422000Z TestFramework (INFO): prune exactly up to the indices best blocks while the indices are disabled\r\n2024-04-01T22:27:52.596000Z TestFramework (INFO): make sure that we can continue with the partially synced indices after having pruned up to the index height\r\n2024-04-01T22:29:34.242000Z TestFramework.utils (ERROR): wait_until() failed. Predicate: '''\r\n        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)#, timeout=150)\r\n'''\r\n2024-04-01T22:29:34.244000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/home/chris/Documents/Code/bitcoin-core/test/functional/test_framework/test_framework.py\", line 132, in main\r\n    self.run_test()\r\n  File \"/home/chris/Documents/Code/bitcoin-core/test/functional/feature_index_prune.py\", line 117, in run_test\r\n    self.sync_index(height=1500)\r\n  File \"/home/chris/Documents/Code/bitcoin-core/test/functional/feature_index_prune.py\", line 34, in sync_index\r\n    self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)#, timeout=150)\r\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/home/chris/Documents/Code/bitcoin-core/test/functional/test_framework/test_framework.py\", line 780, in wait_until\r\n    return wait_until_helper_internal(test_function, timeout=timeout, timeout_factor=self.options.timeout_factor)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/home/chris/Documents/Code/bitcoin-core/test/functional/test_framework/util.py\", line 305, in wait_until_helper_internal\r\n    raise AssertionError(m)\r\nAssertionError: Predicate '''\r\n        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)#, timeout=150)\r\n''' not true after 60 seconds. Took 101.6 seconds to complete, 69.4% over the given limit.\r\n2024-04-01T22:29:34.298000Z TestFramework (INFO): Stopping nodes\r\n2024-04-01T22:29:34.511000Z TestFramework (WARNING): Not cleaning up dir /mnt/tmp/test_runner_â¿_ð_20240402_002516/feature_index_prune_302\r\n2024-04-01T22:29:34.511000Z TestFramework (ERROR): Test failed. Test logging available at /mnt/tmp/test_runner_â¿_ð_20240402_002516/feature_index_prune_302/test_framework.log\r\n2024-04-01T22:29:34.511000Z TestFramework (ERROR): \r\n2024-04-01T22:29:34.512000Z TestFramework (ERROR): Hint: Call /home/chris/Documents/Code/bitcoin-core/test/functional/combine_logs.py '/mnt/tmp/test_runner_â¿_ð_20240402_002516/feature_index_prune_302' to consolidate all logs\r\n2024-04-01T22:29:34.512000Z TestFramework (ERROR): \r\n2024-04-01T22:29:34.512000Z TestFramework (ERROR): If this failure happened unexpectedly or intermittently, please file a bug and provide a link or upload of the combined log.\r\n2024-04-01T22:29:34.512000Z TestFramework (ERROR): https://github.com/bitcoin/bitcoin/issues\r\n2024-04-01T22:29:34.512000Z TestFramework (ERROR): \r\n\r\n\r\nstderr:\r\n\r\n\r\n53/305 - p2p_blockfilters.py passed, Duration: 130 s\r\n```\r\n\r\n```\r\n297/305 - wallet_importdescriptors.py --descriptors failed, Duration: 76 s\r\n\r\nstdout:\r\n2024-04-01T22:48:27.663000Z TestFramework (INFO): PRNG seed is: 8528678505617325332\r\n2024-04-01T22:48:27.664000Z TestFramework (INFO): Initializing test directory /mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98\r\n2024-04-01T22:48:28.021000Z TestFramework (INFO): Setting up wallets\r\n2024-04-01T22:48:28.100000Z TestFramework (INFO): Mining coins\r\n2024-04-01T22:48:29.714000Z TestFramework (INFO): Import should fail if a descriptor is not provided\r\n2024-04-01T22:48:29.725000Z TestFramework (INFO): Should import a p2pkh descriptor\r\n2024-04-01T22:48:29.740000Z TestFramework (INFO): Test can import same descriptor with public key twice\r\n2024-04-01T22:48:29.760000Z TestFramework (INFO): Test can update descriptor label\r\n2024-04-01T22:48:29.785000Z TestFramework (INFO): Internal addresses cannot have labels\r\n2024-04-01T22:48:29.788000Z TestFramework (INFO): Internal addresses should be detected as such\r\n2024-04-01T22:48:29.854000Z TestFramework (INFO): Should not import a p2sh-p2wpkh descriptor without checksum\r\n2024-04-01T22:48:29.855000Z TestFramework (INFO): Should not import a p2sh-p2wpkh descriptor that has range specified\r\n2024-04-01T22:48:29.858000Z TestFramework (INFO): Should not import a p2sh-p2wpkh descriptor and have it set to active\r\n2024-04-01T22:48:29.860000Z TestFramework (INFO): Should import a (non-active) p2sh-p2wpkh descriptor\r\n2024-04-01T22:48:29.984000Z TestFramework (INFO): Should import a 1-of-2 bare multisig from descriptor\r\n2024-04-01T22:48:30.002000Z TestFramework (INFO): Should not treat individual keys from the imported bare multisig as watchonly\r\n2024-04-01T22:48:30.005000Z TestFramework (INFO): Ranged descriptors cannot have labels\r\n2024-04-01T22:48:30.014000Z TestFramework (INFO): Private keys required for private keys enabled wallet\r\n2024-04-01T22:48:30.027000Z TestFramework (INFO): Ranged descriptor import should warn without a specified range\r\n2024-04-01T22:48:30.065000Z TestFramework (INFO): Should not import a ranged descriptor that includes xpriv into a watch-only wallet\r\n2024-04-01T22:48:30.070000Z TestFramework (INFO): Should not import a descriptor with hardened derivations when private keys are disabled\r\n2024-04-01T22:48:30.108000Z TestFramework (INFO): Verify we can only extend descriptor's range\r\n2024-04-01T22:48:30.364000Z TestFramework (INFO): Check we can change descriptor internal flag\r\n2024-04-01T22:48:30.536000Z TestFramework (INFO): Key ranges should be imported in order\r\n2024-04-01T22:48:30.708000Z TestFramework (INFO): Check we can change next_index\r\n2024-04-01T22:48:30.838000Z TestFramework (INFO): Check imported descriptors are not active by default\r\n2024-04-01T22:48:30.870000Z TestFramework (INFO): Check can activate inactive descriptor\r\n2024-04-01T22:48:30.903000Z TestFramework (INFO): Check can deactivate active descriptor\r\n2024-04-01T22:48:30.924000Z TestFramework (INFO): Verify activation state is persistent\r\n2024-04-01T22:48:30.973000Z TestFramework (INFO): Should import a descriptor with a WIF private key as spendable\r\n2024-04-01T22:48:30.987000Z TestFramework (INFO): Test can import same descriptor with private key twice\r\n2024-04-01T22:48:32.173000Z TestFramework (INFO): Test that multisigs can be imported, signed for, and getnewaddress'd\r\n2024-04-01T22:48:43.803000Z TestFramework (INFO): Multisig with distributed keys\r\n2024-04-01T22:48:48.895000Z TestFramework (INFO): We can create and use a huge multisig under P2WSH\r\n2024-04-01T22:49:05.628000Z TestFramework (INFO): Under P2SH, multisig are standard with up to 15 compressed keys\r\n2024-04-01T22:49:20.258000Z TestFramework (INFO): Amending multisig with new private keys\r\n2024-04-01T22:49:23.306000Z TestFramework (INFO): Combo descriptors cannot be active\r\n2024-04-01T22:49:23.313000Z TestFramework (INFO): Descriptors with no type cannot be active\r\n2024-04-01T22:49:23.348000Z TestFramework (INFO): Test importing a descriptor to an encrypted wallet\r\n2024-04-01T22:49:43.957000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/home/chris/Documents/Code/bitcoin-core/test/functional/test_framework/test_framework.py\", line 132, in main\r\n    self.run_test()\r\n  File \"/home/chris/Documents/Code/bitcoin-core/test/functional/wallet_importdescriptors.py\", line 691, in run_test\r\n    with self.nodes[0].assert_debug_log(expected_msgs=[\"Rescan started from block 0f9188f13cb7b2c71f2a335e3a4fc328bf5beb436012afca590b1a11466e2206... (slow variant inspecting all blocks)\"], timeout=5):#10):\r\n  File \"/nix/store/rac8pxbi1vapwrlqzbrkycbyg521djzw-python3-3.11.6/lib/python3.11/contextlib.py\", line 144, in __exit__\r\n    next(self.gen)\r\n  File \"/home/chris/Documents/Code/bitcoin-core/test/functional/test_framework/test_node.py\", line 493, in assert_debug_log\r\n    self._raise_assertion_error(f'Expected messages \"{expected_msgs}\" found too late, took {now - start:.1f} seconds, {((now - start) / (time_end - start)) - 1:.1%} over the given limit. Log:\\n\\n{print_log}\\n\\n')\r\n  File \"/home/chris/Documents/Code/bitcoin-core/test/functional/test_framework/test_node.py\", line 188, in _raise_assertion_error\r\n    raise AssertionError(self._node_msg(msg))\r\nAssertionError: [node 0] Expected messages \"['Rescan started from block 0f9188f13cb7b2c71f2a335e3a4fc328bf5beb436012afca590b1a11466e2206... (slow variant inspecting all blocks)']\" found too late, took 5.4 seconds, 8.9% over the given limit. Log:\r\n\r\n - 2024-04-01T22:49:33.066512Z [http] [httpserver.cpp:306] [http_request_cb] [http] Received a POST request for /wallet/encrypted_wallet from 127.0.0.1:47658\r\n - 2024-04-01T22:49:33.066668Z [httpworker.0] [rpc/request.cpp:187] [parse] [rpc] ThreadRPCServer method=importdescriptors user=__cookie__\r\n - 2024-04-01T22:49:33.070999Z [httpworker.0] [wallet/sqlite.cpp:57] [TraceSqlCallback] [/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/node0/regtest/wallets/encrypted_wallet/wallet.dat] SQLite Statement: INSERT INTO main VALUES(?, ?)\r\n - 2024-04-01T22:49:33.071061Z [httpworker.0] [wallet/sqlite.cpp:57] [TraceSqlCallback] [/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/node0/regtest/wallets/encrypted_wallet/wallet.dat] SQLite Statement: DELETE FROM main WHERE key = ?\r\n - 2024-04-01T22:49:33.071137Z [httpworker.0] [wallet/sqlite.cpp:57] [TraceSqlCallback] [/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/node0/regtest/wallets/encrypted_wallet/wallet.dat] SQLite Statement: BEGIN TRANSACTION\r\n - 2024-04-01T22:49:33.074190Z [httpworker.0] [wallet/sqlite.cpp:57] [TraceSqlCallback] [/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/node0/regtest/wallets/encrypted_wallet/wallet.dat] SQLite Statement: INSERT or REPLACE into main values(?, ?)\r\n - 2024-04-01T22:49:33.075564Z [httpworker.0] [wallet/sqlite.cpp:57] [TraceSqlCallback] [/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/node0/regtest/wallets/encrypted_wallet/wallet.dat] SQLite Statement: INSERT or REPLACE into main values(?, ?)\r\n...<thousands of almost identical lines>...\r\n - 2024-04-01T22:49:38.416139Z [httpworker.0] [wallet/sqlite.cpp:57] [TraceSqlCallback] [/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/node0/regtest/wallets/encrypted_wallet/wallet.dat] SQLite Statement: INSERT or REPLACE into main values(?, ?)\r\n - 2024-04-01T22:49:38.416528Z [httpworker.0] [wallet/sqlite.cpp:57] [TraceSqlCallback] [/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/node0/regtest/wallets/encrypted_wallet/wallet.dat] SQLite Statement: INSERT or REPLACE into main values(?, ?)\r\n - 2024-04-01T22:49:38.427946Z [httpworker.0] [wallet/sqlite.cpp:57] [TraceSqlCallback] [/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/node0/regtest/wallets/encrypted_wallet/wallet.dat] SQLite Statement: COMMIT TRANSACTION\r\n - 2024-04-01T22:49:38.429778Z [httpworker.0] [wallet/sqlite.cpp:57] [TraceSqlCallback] [/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/node0/regtest/wallets/encrypted_wallet/wallet.dat] SQLite Statement: INSERT or REPLACE into main values(?, ?)\r\n - 2024-04-01T22:49:38.429916Z [httpworker.0] [wallet/sqlite.cpp:57] [TraceSqlCallback] [/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/node0/regtest/wallets/encrypted_wallet/wallet.dat] SQLite Statement: INSERT or REPLACE into main values(?, ?)\r\n - 2024-04-01T22:49:38.430001Z [httpworker.0] [wallet/wallet.h:933] [WalletLogPrintf] [encrypted_wallet] Setting spkMan to active: id = c6149b35399517457b0b1d8ccdd7efda25a2f20fc7f8167adda8e79b10e260b7, type = legacy, internal = false\r\n - 2024-04-01T22:49:38.430134Z [httpworker.0] [wallet/wallet.h:933] [WalletLogPrintf] [encrypted_wallet] RescanFromTime: Rescanning last 329 blocks\r\n - 2024-04-01T22:49:38.430170Z [httpworker.0] [wallet/wallet.h:933] [WalletLogPrintf] [encrypted_wallet] Rescan started from block 0f9188f13cb7b2c71f2a335e3a4fc328bf5beb436012afca590b1a11466e2206... (slow variant inspecting all blocks)\r\n - 2024-04-01T22:49:38.441914Z [httpworker.0] [wallet/scriptpubkeyman.h:258] [WalletLogPrintf] [encrypted_wallet] MarkUnusedAddresses: Detected a used keypool item at index 4000, mark all keypool items up to this item as used\r\n\r\n\r\n2024-04-01T22:49:44.029000Z TestFramework (INFO): Stopping nodes\r\n2024-04-01T22:49:44.132000Z TestFramework (WARNING): Not cleaning up dir /mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98\r\n2024-04-01T22:49:44.132000Z TestFramework (ERROR): Test failed. Test logging available at /mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98/test_framework.log\r\n2024-04-01T22:49:44.132000Z TestFramework (ERROR): \r\n2024-04-01T22:49:44.133000Z TestFramework (ERROR): Hint: Call /home/chris/Documents/Code/bitcoin-core/test/functional/combine_logs.py '/mnt/tmp/test_runner_â¿_ð_20240402_004231/wallet_importdescriptors_98' to consolidate all logs\r\n2024-04-01T22:49:44.133000Z TestFramework (ERROR): \r\n2024-04-01T22:49:44.133000Z TestFramework (ERROR): If this failure happened unexpectedly or intermittently, please file a bug and provide a link or upload of the combined log.\r\n2024-04-01T22:49:44.133000Z TestFramework (ERROR): https://github.com/bitcoin/bitcoin/issues\r\n2024-04-01T22:49:44.133000Z TestFramework (ERROR): \r\n\r\n\r\nstderr:\r\n\r\n\r\nRemaining jobs: [feature_pruning.py, feature_dbcrash.py, feature_assumeutxo.py, rpc_scantxoutset.py, feature_coinstatsindex.py, p2p_node_network_limited.py --v1transport, p2p_node_network_limited.py --v2transport, feature_config_args.py]\r\n298/305 - p2p_node_network_limited.py --v1transport passed, Duration: 24 s\r\n```\r\n\r\n</details>",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29791/comments",
   "created_at" : "2024-04-02T16:13:05Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29791/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/29791",
   "id" : 2220911878,
   "labels" : [
      {
         "color" : "d4c5f9",
         "default" : false,
         "description" : null,
         "id" : 62963516,
         "name" : "Tests",
         "node_id" : "MDU6TGFiZWw2Mjk2MzUxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29791/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII585rdXfv",
   "number" : 29791,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/29791.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/29791",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/29791.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/29791"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29791/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29791/timeline",
   "title" : "test: Bump timeouts in feature_index_prune and wallet_importdescriptors",
   "updated_at" : "2024-04-02T16:13:11Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/29791",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/581308?v=4",
      "events_url" : "https://api.github.com/users/cbergqvist/events{/privacy}",
      "followers_url" : "https://api.github.com/users/cbergqvist/followers",
      "following_url" : "https://api.github.com/users/cbergqvist/following{/other_user}",
      "gists_url" : "https://api.github.com/users/cbergqvist/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/cbergqvist",
      "id" : 581308,
      "login" : "cbergqvist",
      "node_id" : "MDQ6VXNlcjU4MTMwOA==",
      "organizations_url" : "https://api.github.com/users/cbergqvist/orgs",
      "received_events_url" : "https://api.github.com/users/cbergqvist/received_events",
      "repos_url" : "https://api.github.com/users/cbergqvist/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/cbergqvist/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/cbergqvist/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/cbergqvist"
   }
}
