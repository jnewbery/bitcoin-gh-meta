[
   {
      "author_association" : "NONE",
      "body" : "I restarted the controller proxy several times, onion-grater is consistent with its replies or ServiceID, but bitcoind is not, it says authentication not supported even when the reply contained the ServiceID. Each of the spaced lines are a time I restarted the tor controller's proxy:\r\n```\r\ntor: Got service ID OLDONION, advertising service OLDONION.onion:8333\r\nAddLocal(OLDONION.onion:8333,4)\r\n\r\nRemoveLocal(OLDONION.onion:8333)\r\ntor: No supported authentication method \r\n\r\ntor: No supported authentication method\r\n\r\ntor: No supported authentication method\r\n\r\ntor: Got service ID ANOTHERONION, advertising service ANOTHERONION.onion:8333\r\nAddLocal(ANOTHERONION.onion:8333,4)\r\n```\r\n\r\nAnd for some reason, on the last it did work.\r\nI was solely restarting onion-grater, sometimes bitcoind can't authenticate, sometimes it can, which is very strange.",
      "created_at" : "2022-10-03T11:52:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/26228#issuecomment-1265328913",
      "id" : 1265328913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26228",
      "node_id" : "IC_kwDOABII585La2MR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265328913/reactions"
      },
      "updated_at" : "2022-10-03T11:52:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265328913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69700936?v=4",
         "events_url" : "https://api.github.com/users/nyxnor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/nyxnor/followers",
         "following_url" : "https://api.github.com/users/nyxnor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/nyxnor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/nyxnor",
         "id" : 69700936,
         "login" : "nyxnor",
         "node_id" : "MDQ6VXNlcjY5NzAwOTM2",
         "organizations_url" : "https://api.github.com/users/nyxnor/orgs",
         "received_events_url" : "https://api.github.com/users/nyxnor/received_events",
         "repos_url" : "https://api.github.com/users/nyxnor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/nyxnor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/nyxnor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/nyxnor"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Enabled tor debugging for bitcoind:\r\n```\r\ntor: Connected to Tor version 0.4.7.10\r\ntor: Supported authentication method: NULL\r\ntor: Using NULL authentication\r\ntor: Authentication successful\r\ntor: ADD_ONION successful\r\ntor: Got service ID OLDONION, advertising service OLDONION.onion:8333\r\n```\r\nrestarting the controller proxy\r\n```\r\ntor: End of stream\r\nRemoveLocal(OLDONION.onion:8333)\r\ntor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\ntor: Successfully connected!\r\ntor: End of stream\r\ntor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\ntor: Successfully connected!\r\ntor: Connected to Tor version 0.4.7.10\r\ntor: Supported authentication method: NULL\r\ntor: Using NULL authentication\r\ntor: No supported authentication method\r\n```\r\nand controller logs:\r\n```\r\n-> PROTOCOLINFO 1\r\n<- 250-PROTOCOLINFO 1\r\n<- 250-AUTH METHODS=NULL\r\n<- 250-VERSION Tor=\"0.4.7.10\"\r\n<- 250 OK\r\n-> AUTHENTICATE\r\n<- 250 OK\r\n```\r\n`->` client commands to the controller\r\n`<-` controller replies to the client\r\n\r\nYou can see bitcoind tries to use the NULL method that doesn't require a pass or cookie, and the controller let's bitcoind authenticate, but bitcoind does not\r\n\r\nSometimes bitcoind understand it can authenticate (`Authentication successful`), but then logs `No supported authentication method`, not creating the onion.\r\n```\r\ntor: Error connecting to Tor control socket\r\ntor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\ntor: Successfully connected!\r\ntor: Error connecting to Tor control socket\r\ntor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\ntor: Successfully connected!\r\ntor: Authentication successful\r\ntor: No supported authentication method\r\n```\r\nand by some change (which appear to be random), sometimes bitcoind gets the onion and uses it:\r\n```\r\ntor: Connected to Tor version 0.4.7.10\r\ntor: Supported authentication method: NULL\r\ntor: Using NULL authentication\r\ntor: Authentication successful\r\ntor: ADD_ONION successful\r\ntor: Got service ID NEWONION, advertising service NEWONION.onion:8333\r\n```\r\n\r\nTLDR:\r\n\r\nBitcoind always can get the onion after it is restarted.\r\nIf the onion is no long available because the controller connection closes for a second, then when it is available again, bitcoind can't get the onion hostname (ServiceID) reliably, sometimes it can, sometimes it can't and the controller is always replying, bitcoind doesn't get it sometimes for some reason.",
      "created_at" : "2022-10-03T12:38:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/26228#issuecomment-1265379900",
      "id" : 1265379900,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26228",
      "node_id" : "IC_kwDOABII585LbCo8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265379900/reactions"
      },
      "updated_at" : "2022-10-03T12:38:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1265379900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69700936?v=4",
         "events_url" : "https://api.github.com/users/nyxnor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/nyxnor/followers",
         "following_url" : "https://api.github.com/users/nyxnor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/nyxnor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/nyxnor",
         "id" : 69700936,
         "login" : "nyxnor",
         "node_id" : "MDQ6VXNlcjY5NzAwOTM2",
         "organizations_url" : "https://api.github.com/users/nyxnor/orgs",
         "received_events_url" : "https://api.github.com/users/nyxnor/received_events",
         "repos_url" : "https://api.github.com/users/nyxnor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/nyxnor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/nyxnor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/nyxnor"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@nyxnor I may be misunderstanding something here but I suspect this is not a Bitcoin Core issue and seems likely related to your onion grater or whonix setup...\r\n\r\nUsing Ubuntu, I can trivially run Bitcoin Core and wait for it to connect to tor daemon, then stop Tor, wait for disconnection, then start Tor and Bitcoin Core will re-connect (and re-authenticate) to it (using SAFECOOKIE) very happily, time after time.\r\n\r\n```log\r\n2023-09-15T08:57:57Z [tor] Get SOCKS port command yielded 127.0.0.1:9050\r\n2023-09-15T08:57:57Z [tor] Configuring onion proxy for 127.0.0.1:9050\r\n2023-09-15T08:57:57Z [tor] ADD_ONION successful\r\n2023-09-15T08:57:57Z [tor] Got service ID bwralcqq7fzxatchm66rhtk5fmtd6gcrib2vhz3wmetzidmi2vzx2vid, advertising service bwralcqq7fzxatchm66rhtk5fmtd6gcrib2vhz3wmetzidmi2vzx2vid.onion:18444\r\n2023-09-15T08:57:57Z [tor] Cached service private key to /home/will/.bitcoin/regtest/onion_v3_private_key\r\n2023-09-15T08:57:57Z AddLocal(bwralcqq7fzxatchm66rhtk5fmtd6gcrib2vhz3wmetzidmi2vzx2vid.onion:18444,4)\r\n\r\n# stop tor service\r\n\r\n2023-09-15T08:58:17Z [tor] End of stream\r\n2023-09-15T08:58:17Z RemoveLocal(bwralcqq7fzxatchm66rhtk5fmtd6gcrib2vhz3wmetzidmi2vzx2vid.onion:18444)\r\n2023-09-15T08:58:17Z [tor] Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\n2023-09-15T08:58:18Z [tor] Error connecting to Tor control socket\r\n2023-09-15T08:58:18Z [tor] Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\n2023-09-15T08:58:19Z [tor] Error connecting to Tor control socket\r\n2023-09-15T08:58:19Z [tor] Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\n2023-09-15T08:58:22Z [tor] Error connecting to Tor control socket\r\n2023-09-15T08:58:22Z [tor] Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\n2023-09-15T08:58:25Z [tor] Error connecting to Tor control socket\r\n2023-09-15T08:58:25Z [tor] Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\n\r\n<snip>\r\n# start tor again\r\n\r\n2023-09-15T08:59:30Z [tor] Successfully connected!\r\n2023-09-15T08:59:30Z [tor] Connected to Tor version 0.4.8.5\r\n2023-09-15T08:59:30Z [tor] Supported authentication method: COOKIE\r\n2023-09-15T08:59:30Z [tor] Supported authentication method: SAFECOOKIE\r\n2023-09-15T08:59:30Z [tor] Using SAFECOOKIE authentication, reading cookie authentication from /run/tor/control.authcookie\r\n2023-09-15T08:59:30Z [tor] SAFECOOKIE authentication challenge successful\r\n2023-09-15T08:59:30Z [tor] AUTHCHALLENGE ServerHash de3ef6a0b59f44a31ff8e58f3380bc77f65c7a36fb6cc69767801b72067a6245 ServerNonce 297510897a4a8667adbcc83e08e9e06e988e37a7bef18f4f2b4f85ec90b78d50\r\n2023-09-15T08:59:30Z [tor] Authentication successful\r\n2023-09-15T08:59:30Z [tor] Get SOCKS port command yielded 127.0.0.1:9050\r\n2023-09-15T08:59:30Z [tor] Configuring onion proxy for 127.0.0.1:9050\r\n2023-09-15T08:59:30Z [tor] ADD_ONION successful\r\n2023-09-15T08:59:30Z [tor] Got service ID bwralcqq7fzxatchm66rhtk5fmtd6gcrib2vhz3wmetzidmi2vzx2vid, advertising service bwralcqq7fzxatchm66rhtk5fmtd6gcrib2vhz3wmetzidmi2vzx2vid.onion:18444\r\n2023-09-15T08:59:30Z [tor] Cached service private key to /home/will/.bitcoin/regtest/onion_v3_private_key\r\n2023-09-15T08:59:30Z AddLocal(bwralcqq7fzxatchm66rhtk5fmtd6gcrib2vhz3wmetzidmi2vzx2vid.onion:18444,4)\r\n```\r\n\r\nWhat version of Bitcoin Core were you using out of interest, ? I notice I have a slightly newer version or Tor than you, but I doubt that is the issue here. Also there have been a pretty minimal number of changes to torcontroller.cpp since you first posted this, so I don't think anything has changed on the Bitcoin Core side:\r\n\r\n```log\r\n$ git log --pretty=oneline --after=\"2022-10-02\" -- src/torcontrol.cpp\r\n9a84200cfc994eebf38c46919b20e0c0261799ae doc, refactor: Changing -torcontrol help to specify that a default port is used\r\nfa32af22b323e7c58b6b20af6517f4795a72cdc5 Replace LocaleIndependentAtoi with ToIntegral\r\nfaab76c1c01e6d3fff8ac1bc71baeecd8846dc32 iwyu on torcontrol\r\nfa0a60dd93e4485c1f62ffcc87fa9e6b195ce795 Remove unused boost signals2 from torcontrol\r\n32e2ffc39374f61bb2435da507f285459985df9e Remove the syscall sandbox\r\n34bcdfc6a65de906c65edccdd96fe15219081cd2 p2p, refactor: return vector/optional<CService> in `Lookup`\r\nbe55f545d53d44fdcf2d8ae802e9eae551d120c6 move-only: Extract common/args and common/config.cpp from util/system\r\n35fbc972082eca0fc848fba77360ff35f1ba69e1 Merge bitcoin/bitcoin#25619: net: avoid overriding non-virtual ToString() in CService and use better naming\r\n96ee992ac3535848e2dc717bf284339badd40dcb clang-tidy: Fix `modernize-use-default-member-init` in headers\r\n306ccd4927a2efe325c8d84be1bdb79edeb29b04 scripted-diff: Bump copyright headers\r\n96c791dd20fea54c17d224000dee677bc158f66a net: remove CService::ToString() use ToStringAddrPort() instead\r\n043b9de59aec88ae5e29daac7dc2a8b51a9414ce scripted-diff: rename ToStringIP[Port]() to ToStringAddr[Port]()\r\n```",
      "created_at" : "2023-09-15T09:11:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/26228#issuecomment-1720941866",
      "id" : 1720941866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26228",
      "node_id" : "IC_kwDOABII585mk30q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1720941866/reactions"
      },
      "updated_at" : "2023-09-15T09:11:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1720941866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The problem is not easily reproducible.\r\n\r\nPlease open a new issue (or leave a comment in here if you want this re-opened) if you experience the problem again.",
      "created_at" : "2023-09-21T16:01:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/26228#issuecomment-1729871499",
      "id" : 1729871499,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26228",
      "node_id" : "IC_kwDOABII585nG76L",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1729871499/reactions"
      },
      "updated_at" : "2023-09-21T16:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1729871499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   }
]
