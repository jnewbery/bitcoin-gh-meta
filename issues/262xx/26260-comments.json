[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26260#discussion_r988898205"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/988898205"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What happens if the `ActivateBestChain()` below fails? You set `m_best_header` but the `reconsiderblock` call failed.\r\n\r\n`pblockindex` is also not guaranteed to be the index for the tip of the reconsidered chain, so you end up with the same inconsistent output as described in #26245. You can test that invalidating and reconsidering an older block, e.g.:\r\n```\r\nbitcoin-cli getblockchaininfo\r\nbitcoin-cli invalidateblock <blockhash at height=tip-5>\r\nbitcoin-cli getblockchaininfo\r\nbitcoin-cli reconsiderblock <blockhash at height=tip-5>\r\nbitcoin-cli getblockchaininfo\r\n```",
      "commit_id" : "1882ca227abd6f2c9dd898292c56fb65f7129fef",
      "created_at" : "2022-10-06T11:08:11Z",
      "diff_hunk" : "@@ -1569,6 +1569,7 @@ static RPCHelpMan reconsiderblock()\n             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\n         }\n \n+        chainman.m_best_header = pblockindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#discussion_r988898205",
      "id" : 988898205,
      "line" : 1572,
      "node_id" : "PRRC_kwDOABII58468WOd",
      "original_commit_id" : "1882ca227abd6f2c9dd898292c56fb65f7129fef",
      "original_line" : 1572,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 4,
      "pull_request_review_id" : 1132786161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26260",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/988898205/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-06T11:25:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/988898205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'll try this patch on [ForkMonitor](https://forkmonitor.info/nodes/btc), at least for the v0.21.2 node (using `g_best_block`). We run two nodes that constantly roll back the chain in order to call `gettxoutsetinfo` on them (no longer needed for new nodes thanks to #24539) as well as to fetch stale blocks that we only have headers for. (and then it would call `reconsiderblock`).\r\n\r\nI've occasionally gotten error emails where the resulting tip was not what was expected (and I think these happen just after a rollback).\r\n\r\n\r\nThat said, I agree with @dergoegge that we probably shouldn't touch `m_best_header` directly from RPC code.",
      "created_at" : "2022-10-06T12:09:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1269919504",
      "id" : 1269919504,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26260",
      "node_id" : "IC_kwDOABII585LsW8Q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1269919504/reactions"
      },
      "updated_at" : "2022-10-06T12:11:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1269919504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @dergoegge and @Sjors. I think you are correct, I've moved the statement inside `ActivateBestChain` in `validation.cpp`. Is it better?\r\nI also added your test vector @dergoegge.",
      "created_at" : "2022-10-06T12:25:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1269947108",
      "id" : 1269947108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26260",
      "node_id" : "IC_kwDOABII585Lsdrk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1269947108/reactions"
      },
      "updated_at" : "2022-10-06T12:25:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1269947108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It seems like a better place. I'll have to think more about the change itself of course. Paging @ryanofsky and @jamesob who hang out in this part of the consensus code more often...",
      "created_at" : "2022-10-06T12:40:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1269969084",
      "id" : 1269969084,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26260",
      "node_id" : "IC_kwDOABII585LsjC8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1269969084/reactions"
      },
      "updated_at" : "2022-10-06T12:40:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1269969084",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26260#discussion_r989016124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/989016124"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Pretty sure that this isn't correct, the headers-only chain is synchronized first. So, during IBD, it will be ahead of the \"tip\" block that we are connecting, and you are going to overwrite it.",
      "commit_id" : "054660c3a9c458be57e1d51ca8bbab57e26521c7",
      "created_at" : "2022-10-06T12:57:19Z",
      "diff_hunk" : "@@ -3018,6 +3018,7 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n                     pindexMostWork = nullptr;\n                 }\n                 pindexNewTip = m_chain.Tip();\n+                m_chainman.m_best_header = pindexNewTip;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#discussion_r989016124",
      "id" : 989016124,
      "line" : 3021,
      "node_id" : "PRRC_kwDOABII58468zA8",
      "original_commit_id" : "092ca7f66753d69f26192f5087413370aa182392",
      "original_line" : 3021,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 4,
      "pull_request_review_id" : 1132953843,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26260",
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/989016124/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-06T12:57:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/989016124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26260#discussion_r989017353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/989017353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                if(pindexNewTip->nChainWork > m_chainman.m_best_header->nChainWork) {\r\n                    m_chainman.m_best_header = pindexNewTip;\r\n                }\r\n```",
      "commit_id" : "054660c3a9c458be57e1d51ca8bbab57e26521c7",
      "created_at" : "2022-10-06T12:58:30Z",
      "diff_hunk" : "@@ -3018,6 +3018,7 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n                     pindexMostWork = nullptr;\n                 }\n                 pindexNewTip = m_chain.Tip();\n+                m_chainman.m_best_header = pindexNewTip;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#discussion_r989017353",
      "id" : 989017353,
      "line" : 3021,
      "node_id" : "PRRC_kwDOABII58468zUJ",
      "original_commit_id" : "054660c3a9c458be57e1d51ca8bbab57e26521c7",
      "original_line" : 3021,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 4,
      "pull_request_review_id" : 1132955747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26260",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/989017353/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-06T12:58:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/989017353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Quick thing: in case of regular headers-sync, we only reorg if the chain has a higher diff, so `best_header` field is fine there.\r\n\r\nIn case of forced reorgs, like a block invalidation + reconsideration, we arenât reorganizing the chain due PoW, thus why the `best_header` isnât updated (we currently only update the `best_header` field after adding it to the block index, inside `AddToBlockIndex`).\r\n\r\nSo, for those cases, could either update `best_header` inside `ConnectTip` and `DisconnectTip`  like https://github.com/furszy/bitcoin-core/commit/52f5d62957ad0d9e2b2c8d00333a369fb4a369c7 or.. update it inside the reconsider block process only (the invalidate block process is fine because we are updating the best_header inside `InvalidChainFound`).",
      "created_at" : "2022-10-06T14:09:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1270121139",
      "id" : 1270121139,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26260",
      "node_id" : "IC_kwDOABII585LtIKz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1270121139/reactions"
      },
      "updated_at" : "2022-10-06T14:17:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1270121139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @furszy, I've cherry-picked your commit.",
      "created_at" : "2022-10-12T15:52:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1276399372",
      "id" : 1276399372,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26260",
      "node_id" : "IC_kwDOABII585MFE8M",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1276399372/reactions"
      },
      "updated_at" : "2022-10-12T15:52:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1276399372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26260#discussion_r1002536500"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1002536500"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why the pprev check? If we really need that, maybe an assert would be better?",
      "commit_id" : "160a8fe66cd7b039c7215f885bcc0c58106c6406",
      "created_at" : "2022-10-22T17:05:10Z",
      "diff_hunk" : "@@ -2632,6 +2632,12 @@ bool Chainstate::DisconnectTip(BlockValidationState& state, DisconnectedBlockTra\n \n     m_chain.SetTip(*pindexDelete->pprev);\n \n+    // if we are roll-backing the chain, rollback the best header as well\n+    if (m_chainman.m_best_header && m_chainman.m_best_header->GetBlockHash() == pindexDelete->GetBlockHash()\n+        && pindexDelete->pprev) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#discussion_r1002536500",
      "id" : 1002536500,
      "line" : 2637,
      "node_id" : "PRRC_kwDOABII5847wX40",
      "original_commit_id" : "160a8fe66cd7b039c7215f885bcc0c58106c6406",
      "original_line" : 2637,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 1152074666,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26260",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1002536500/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-22T17:08:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1002536500",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26260#discussion_r1002536707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1002536707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```c++\r\n    if (pindexNew->pprev == m_chainman.m_best_header) {\r\n```\r\n?",
      "commit_id" : "160a8fe66cd7b039c7215f885bcc0c58106c6406",
      "created_at" : "2022-10-22T17:07:05Z",
      "diff_hunk" : "@@ -2745,6 +2751,12 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n     }\n     // Update m_chain & related variables.\n     m_chain.SetTip(*pindexNew);\n+\n+    // If the best header is the prev block, update the best header\n+    if (pindexNew->pprev && m_chainman.m_best_header && m_chainman.m_best_header->GetBlockHash() == pindexNew->pprev->GetBlockHash()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#discussion_r1002536707",
      "id" : 1002536707,
      "line" : 2756,
      "node_id" : "PRRC_kwDOABII5847wX8D",
      "original_commit_id" : "160a8fe66cd7b039c7215f885bcc0c58106c6406",
      "original_line" : 2756,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 19,
      "pull_request_review_id" : 1152074666,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26260",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1002536707/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-22T17:08:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1002536707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @luke-jr for the review.\r\n> This feels like a special-cased hack. Is there a reason we can't adjust the current code that changes m_best_header when an invalid block is encountered?\r\n\r\nI believe it is more robust to place the fix in ConnectTip and DisconnectTip. cc @furszy",
      "created_at" : "2022-11-15T15:35:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1315486263",
      "id" : 1315486263,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26260",
      "node_id" : "IC_kwDOABII585OaLo3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1315486263/reactions"
      },
      "updated_at" : "2022-11-15T15:35:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1315486263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> This feels like a special-cased hack. Is there a reason we can't adjust the current code that changes m_best_header when an invalid block is encountered?\r\n\r\nI actually wrote two ways to fix this above https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1270121139.\r\n\r\nThe problem is on the block reconsideration flow, not inside the invalidation one.\r\n\r\nInside the `invalidateblock` process, we update the best_header by\r\nmanually calling `InvalidChainFound` after invalidating blocks. Which is fine.\r\n\r\nWe need to do the same for `reconsiderblock` and update the\r\nbest_header field after finishing the process.\r\n\r\nNote: the only difference between this two commands is that\r\nâreconsiderblockâ does not have its own separate function,\r\nit's a plain RPC command that resets the block index flag\r\nand calls ActivateBestChain.\r\n\r\nSo, @aureleoules, could drop the other commit and cherry-pick this change to fix the problem too:\r\nhttps://github.com/furszy/bitcoin-core/commit/4f3318c684af631d7f79b872cd7b8d4feae4b828\r\n\r\nBoth works. This last one is specific to the `reconsiderblock` flow (which is where we have the issue).",
      "created_at" : "2022-11-24T13:55:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1326486738",
      "id" : 1326486738,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26260",
      "node_id" : "IC_kwDOABII585PEJTS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326486738/reactions"
      },
      "updated_at" : "2022-11-26T19:53:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326486738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [pinheadmz](https://github.com/bitcoin/bitcoin/pull/26260#pullrequestreview-1423237913) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2022-11-24T13:56:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1326486790",
      "id" : 1326486790,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26260",
      "node_id" : "IC_kwDOABII585PEJUG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326486790/reactions"
      },
      "updated_at" : "2023-05-11T18:54:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1326486790",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I deployed this patch on the two ForkMonitor (mirror) nodes that frequently use `invalidateblock` and `reconsiderblock`. It's cherry-picked on top of the v25.0rc1 and v24.1rc2 tags. Typically we get about one error message per week where the block it rewinds to is not the one we expected. We'll see if that stops.",
      "created_at" : "2023-05-08T15:55:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1538638453",
      "id" : 1538638453,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26260",
      "node_id" : "IC_kwDOABII585btcJ1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1538638453/reactions"
      },
      "updated_at" : "2023-05-08T15:55:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1538638453",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--8ac04cdde196e94527acabf64b896448-->\r\nThere hasn't been much activity lately. What is the status here?\r\n\r\n[Finding reviewers](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#finding-reviewers) may take time. However, if the patch is no longer relevant, please close this pull request. If the author lost interest or time to work on this, please close it and mark it 'Up for grabs' with the label, so that it can be picked up in the future.\r\n",
      "created_at" : "2023-08-08T09:19:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26260#issuecomment-1669239991",
      "id" : 1669239991,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26260",
      "node_id" : "IC_kwDOABII585jfpS3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1669239991/reactions"
      },
      "updated_at" : "2023-08-08T09:19:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1669239991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
